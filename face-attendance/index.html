<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>ระบบเช็คอินพนักงาน • Face/Manual Attendance</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- OPTIONAL: face-api.js (ถ้าคุณมีโมเดลใน /models) -->
  <!-- ถ้ายังไม่ใช้ก็ปล่อยได้ ระบบยังทำงานแบบ "ถ่ายเฟรมส่ง GS ให้จำแนก" ได้อยู่ -->
  <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/dist/face-api.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --primary:#0ea5e9;
      --primary2:#0284c7;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;

      --shadow: 0 10px 30px rgba(2, 8, 23, .08);
      --shadow2: 0 6px 18px rgba(2, 8, 23, .10);

      --radius: 18px;
      --radius2: 14px;

      --pad: 14px;
      --pad2: 18px;

      --max: 1080px;

      --ring: 0 0 0 4px rgba(14,165,233,.16);

      --h: 56px;
      --safeTop: env(safe-area-inset-top);
      --safeBottom: env(safe-area-inset-bottom);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Prompt", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(180deg, #eff6ff 0%, var(--bg) 22%, var(--bg) 100%);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea { font-family:inherit; }

    /* Layout */
    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background: rgba(246,248,251,.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(229,231,235,.9);
      padding-top: var(--safeTop);
    }
    .topbar-inner{
      height: var(--h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px var(--pad);
      max-width: var(--max);
      margin: 0 auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,0) 55%),
        linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: var(--shadow2);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,.55);
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      min-width:0;
    }
    .brand-title b{
      font-size: 15.5px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-title span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .icon-btn{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 3px 10px rgba(2,8,23,.06);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .icon-btn:active{ transform: scale(.98); }
    .icon{
      width: 20px; height: 20px;
      opacity:.9;
    }

    .wrap{
      width:100%;
      max-width: var(--max);
      margin: 0 auto;
      padding: 14px var(--pad) calc(18px + var(--safeBottom)) var(--pad);
      flex:1;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media(min-width: 860px){
      .wrap{ padding: 18px 18px 26px 18px; }
      .grid{ grid-template-columns: 1.05fr .95fr; gap: 14px; }
      .span2{ grid-column: 1 / -1; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-h{
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(229,231,235,.7);
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92));
    }

    .card-h .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .card-h b{
      font-size: 14.5px;
      letter-spacing:.2px;
    }
    .card-h small{
      color: var(--muted);
      font-size: 12px;
    }

    .card-b{ padding: 14px; }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }

    .btn{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      font-weight: 600;
      font-size: 14px;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 4px 14px rgba(2,8,23,.06);
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      border-color: rgba(2,132,199,.35);
      color:#fff;
      box-shadow: 0 10px 22px rgba(2,132,199,.20);
    }
    .btn.ok{
      background: linear-gradient(135deg, var(--ok), #15803d);
      border-color: rgba(22,163,74,.35);
      color:#fff;
      box-shadow: 0 10px 22px rgba(22,163,74,.18);
    }
    .btn.bad{
      background: linear-gradient(135deg, var(--bad), #b91c1c);
      border-color: rgba(239,68,68,.35);
      color:#fff;
      box-shadow: 0 10px 22px rgba(239,68,68,.18);
    }
    .btn.ghost{
      background:#fff;
    }
    .btn.small{
      height: 38px;
      border-radius: 12px;
      font-size: 13px;
      padding: 0 12px;
    }
    .btn:focus{
      outline:none;
      box-shadow: var(--ring), 0 10px 24px rgba(2,8,23,.08);
    }
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      min-width: 0;
    }
    .label{
      font-size: 12px;
      color: var(--muted);
    }
    .input, .select, .textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background: #fff;
      padding: 11px 12px;
      font-size: 14px;
      outline:none;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .textarea{ min-height: 92px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus{
      border-color: rgba(14,165,233,.5);
      box-shadow: var(--ring);
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(14,165,233,.10);
      color: #075985;
      border: 1px solid rgba(14,165,233,.22);
      font-weight: 600;
      white-space: nowrap;
    }
    .pill.ok{
      background: rgba(22,163,74,.10);
      border-color: rgba(22,163,74,.22);
      color: #14532d;
    }
    .pill.bad{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.22);
      color: #7f1d1d;
    }
    .pill.warn{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.22);
      color: #7c2d12;
    }

    .divider{
      height:1px;
      background: rgba(229,231,235,.75);
      margin: 12px 0;
    }

    /* Toast */
    .toast-wrap{
      position: fixed;
      left: 0;
      right: 0;
      bottom: calc(14px + var(--safeBottom));
      display:flex;
      justify-content:center;
      z-index: 999;
      pointer-events:none;
      padding: 0 14px;
    }
    .toast{
      pointer-events:auto;
      max-width: 680px;
      width: 100%;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: var(--shadow);
      border-radius: 18px;
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      transform: translateY(18px);
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      transform: translateY(0);
      opacity:1;
    }
    .toast .t-left{ display:flex; gap:10px; align-items:flex-start; min-width:0; }
    .toast .dot{
      width: 12px; height: 12px; border-radius: 999px; margin-top: 4px;
      background: var(--primary);
      flex: 0 0 auto;
    }
    .toast .dot.ok{ background: var(--ok); }
    .toast .dot.bad{ background: var(--bad); }
    .toast .dot.warn{ background: var(--warn); }
    .toast .msg{
      font-size: 13px;
      line-height: 1.35;
      color: var(--text);
      min-width:0;
    }
    .toast .msg b{
      display:block;
      font-size: 14px;
      margin-bottom: 2px;
    }
    .toast .x{
      width: 36px;
      height: 36px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      flex:0 0 auto;
      opacity:.9;
    }

    /* Modal */
    .modal{
      position: fixed;
      inset:0;
      background: rgba(2,6,23,.52);
      display:none;
      z-index: 2000;
      padding: 14px;
      padding-top: calc(14px + var(--safeTop));
      padding-bottom: calc(14px + var(--safeBottom));
    }
    .modal.show{ display:flex; }
    .modal .sheet{
      width:100%;
      max-width: 740px;
      margin: auto;
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: 0 20px 60px rgba(2,8,23,.32);
      overflow:hidden;
    }
    .modal .sheet-h{
      padding: 14px 14px 10px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      border-bottom: 1px solid rgba(229,231,235,.7);
      gap: 10px;
    }
    .modal .sheet-h b{ font-size: 15px; }
    .modal .sheet-h small{ color: var(--muted); display:block; font-size: 12px; margin-top: 2px; }
    .modal .sheet-b{ padding: 14px; }
    .modal .sheet-f{
      padding: 12px 14px 14px 14px;
      border-top: 1px solid rgba(229,231,235,.7);
      display:flex;
      gap: 10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Drawer */
    .drawer{
      position: fixed;
      inset:0;
      z-index: 1500;
      display:none;
    }
    .drawer.show{ display:block; }
    .drawer .backdrop{
      position:absolute; inset:0;
      background: rgba(2,6,23,.52);
    }
    .drawer .panel{
      position:absolute;
      left: 10px;
      top: calc(10px + var(--safeTop));
      bottom: calc(10px + var(--safeBottom));
      width: min(86vw, 340px);
      background: rgba(255,255,255,.96);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: 0 20px 60px rgba(2,8,23,.32);
      overflow:hidden;
      transform: translateX(-14px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.show .panel{
      transform: translateX(0);
      opacity:1;
    }
    .drawer .p-h{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid rgba(229,231,235,.7);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .drawer .p-h b{ font-size: 15px; }
    .drawer .p-h small{ color: var(--muted); display:block; font-size: 12px; margin-top:2px; }
    .drawer .p-b{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      overflow:auto;
    }
    .navbtn{
      height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,.95);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 12px;
      box-shadow: 0 4px 14px rgba(2,8,23,.06);
    }
    .navbtn .l{
      display:flex; align-items:center; gap: 10px;
      font-weight: 700;
      font-size: 13.5px;
    }
    .navbtn .r{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }
    .navbtn.active{
      border-color: rgba(14,165,233,.45);
      box-shadow: var(--ring), 0 10px 24px rgba(2,8,23,.08);
    }

    /* Result Panel */
    .result{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .result .box{
      border-radius: 18px;
      border: 1px dashed rgba(148,163,184,.65);
      background: linear-gradient(180deg, rgba(241,245,249,.7), rgba(241,245,249,.4));
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .kv{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 13px;
    }
    .kv .k{ color: var(--muted); }
    .kv .v{ font-weight: 700; color: var(--text); text-align:right; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }

    /* Camera / Scan UI */
    .cam-wrap{
      position:relative;
      width:100%;
      aspect-ratio: 4/5;
      border-radius: 22px;
      overflow:hidden;
      background: #0b1220;
      border: 1px solid rgba(229,231,235,.95);
      box-shadow: 0 18px 50px rgba(2,8,23,.22);
    }
    @media(min-width: 860px){
      .cam-wrap{ aspect-ratio: 16/10; }
    }
    video#cam{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scaleX(1);
      background:#0b1220;
    }
    /* ถ้ากล้องหน้ามันกลับด้าน ให้ใช้ mirror */
    .mirror video#cam{ transform: scaleX(-1); }

    canvas#overlay{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    .cam-hud{
      position:absolute;
      inset: 10px 10px auto 10px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      z-index: 5;
      pointer-events:none;
    }
    .cam-hud .left, .cam-hud .right{
      display:flex; gap: 8px; align-items:center;
    }
    .cam-hud .badge{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 10px 24px rgba(2,8,23,.14);
      font-size: 12px;
      font-weight: 800;
    }
    .cam-hud .badge .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--warn);
    }
    .cam-hud .badge.ok .dot{ background: var(--ok); }
    .cam-hud .badge.bad .dot{ background: var(--bad); }
    .cam-hud .badge span{ font-weight:800; }

    .cam-hud .mini{
      pointer-events:auto;
      height: 38px;
      padding: 0 10px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.88);
      box-shadow: 0 10px 24px rgba(2,8,23,.14);
      cursor:pointer;
      font-size: 12px;
      font-weight: 800;
      display:flex; align-items:center; gap: 8px;
    }

    .scan-footer{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .progress{
      display:flex;
      align-items:center;
      gap: 10px;
      margin-top: 10px;
    }
    .bar{
      height: 10px;
      flex:1;
      background: rgba(148,163,184,.25);
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(229,231,235,.7);
    }
    .bar > i{
      display:block;
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary), var(--primary2));
      border-radius: 999px;
      transition: width .2s ease;
    }
    .step{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      white-space:nowrap;
    }

    /* Table */
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background:#fff;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(229,231,235,.65);
      vertical-align: top;
    }
    th{
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      background: rgba(241,245,249,.6);
    }
    tr:last-child td{ border-bottom:none; }
    td small{ color: var(--muted); display:block; margin-top:2px; }

    /* Skeleton */
    .skeleton{
      background: linear-gradient(90deg, rgba(148,163,184,.18), rgba(148,163,184,.08), rgba(148,163,184,.18));
      background-size: 200% 100%;
      animation: shimmer 1.1s infinite;
      border-radius: 12px;
      height: 14px;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    /* Views (simple router) */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Footer note removed intentionally (ตามที่คุณบอก: เอาคำอธิบายในเว็บออก) */
  </style>
</head>

<body>
  <div class="app">

    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brand-title">
            <b>ระบบเช็คอินพนักงาน</b>
            <span id="apiStatus">API: ยังไม่ได้ตั้งค่า</span>
          </div>
        </div>

        <div class="top-actions">
          <button class="icon-btn" id="btnOpenApi" title="ตั้งค่า API">
            <!-- gear -->
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 15a8.2 8.2 0 0 0 .1-6l2-1.2-2-3.5-2.3.7a8.5 8.5 0 0 0-4.7-2.7L12 0H8l-.5 2.3a8.5 8.5 0 0 0-4.7 2.7l-2.3-.7-2 3.5 2 1.2a8.2 8.2 0 0 0 .1 6L0.6 16.2l2 3.5 2.3-.7a8.5 8.5 0 0 0 4.7 2.7L8 24h4l.5-2.3a8.5 8.5 0 0 0 4.7-2.7l2.3.7 2-3.5-2.1-1.2Z" stroke="currentColor" stroke-width="2" opacity=".6"/>
            </svg>
          </button>

          <button class="icon-btn" id="btnMenu" title="เมนู">
            <!-- hamburger -->
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Drawer Menu -->
    <div class="drawer" id="drawer">
      <div class="backdrop" id="drawerBackdrop"></div>
      <div class="panel" role="dialog" aria-modal="true" aria-label="เมนู">
        <div class="p-h">
          <div>
            <b>เมนู</b>
            <small id="drawerApiText">API: -</small>
          </div>
          <button class="icon-btn" id="btnCloseDrawer" title="ปิด">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="p-b">
          <button class="navbtn active" data-go="home">
            <div class="l">
              <span>หน้าหลัก</span>
            </div>
            <div class="r">Home</div>
          </button>

          <button class="navbtn" data-go="scan">
            <div class="l"><span>สแกนใบหน้าเช็คอิน</span></div>
            <div class="r">Face Scan</div>
          </button>

          <button class="navbtn" data-go="manual">
            <div class="l"><span>บันทึกด้วยมือ</span></div>
            <div class="r">Manual</div>
          </button>

          <button class="navbtn" data-go="today">
            <div class="l"><span>ตรวจสอบวันนี้</span></div>
            <div class="r">Today</div>
          </button>

          <button class="navbtn" data-go="history">
            <div class="l"><span>เช็คประวัติ</span></div>
            <div class="r">Logs</div>
          </button>

          <div class="divider"></div>

          <button class="navbtn" data-go="admin">
            <div class="l"><span>แอดมิน</span></div>
            <div class="r" id="adminNavBadge">Login</div>
          </button>

          <button class="navbtn" id="btnMenuApi">
            <div class="l"><span>ตั้งค่า API</span></div>
            <div class="r">URL</div>
          </button>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="wrap">
      <!-- HOME VIEW -->
      <section class="view active" id="view-home">

        <div class="grid">

          <!-- Quick / Status -->
          <div class="card">
            <div class="card-h">
              <div class="left">
                <b>ทางลัด</b>
                <small>กดไปยังหน้าที่ต้องใช้</small>
              </div>
              <div class="pill" id="pillApi">API ยังไม่พร้อม</div>
            </div>
            <div class="card-b">
              <div class="row">
                <button class="btn primary" id="goScan">สแกนใบหน้า</button>
                <button class="btn" id="goManual">บันทึกด้วยมือ</button>
              </div>

              <div style="height:10px"></div>

              <div class="row">
                <button class="btn" id="goToday">ตรวจสอบวันนี้</button>
                <button class="btn" id="goHistory">เช็คประวัติ</button>
              </div>

              <div class="divider"></div>

              <div class="result">
                <div class="box">
                  <div class="kv">
                    <div class="k">เวลาปัจจุบัน</div>
                    <div class="v" id="nowText">-</div>
                  </div>
                  <div class="kv">
                    <div class="k">สถานะระบบ</div>
                    <div class="v" id="sysText">-</div>
                  </div>
                  <div class="kv">
                    <div class="k">ผลล่าสุด</div>
                    <div class="v" id="lastText">-</div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Today Summary -->
          <div class="card">
            <div class="card-h">
              <div class="left">
                <b>สรุปวันนี้</b>
                <small>กดโหลดสรุปล่าสุด</small>
              </div>
              <button class="btn small" id="btnRefreshToday">รีเฟรช</button>
            </div>
            <div class="card-b">
              <div id="todaySummaryWrap">
                <div class="skeleton" style="width:62%"></div>
                <div style="height:8px"></div>
                <div class="skeleton" style="width:78%"></div>
                <div style="height:8px"></div>
                <div class="skeleton" style="width:55%"></div>
              </div>
            </div>
          </div>

          <!-- Check Today by Code -->
          <div class="card span2">
            <div class="card-h">
              <div class="left">
                <b>ตรวจสอบวันนี้ (ใส่รหัสพนักงาน)</b>
                <small>ดูสถานะเข้า-ออกล่าสุดของวันนี้</small>
              </div>
              <div class="pill" id="gpsPill">GPS: -</div>
            </div>
            <div class="card-b">
              <div class="row">
                <div class="field" style="min-width:240px; flex: 2 1 240px;">
                  <div class="label">รหัสพนักงาน</div>
                  <input class="input" id="empCodeCheck" placeholder="เช่น 0001 / A123" inputmode="numeric" />
                </div>
                <button class="btn primary" id="btnCheckToday">ตรวจสอบ</button>
              </div>

              <div style="height:10px"></div>

              <div class="result" id="checkTodayResult" style="display:none;">
                <div class="box">
                  <div class="kv"><div class="k">ชื่อ</div><div class="v" id="ctName">-</div></div>
                  <div class="kv"><div class="k">รหัส</div><div class="v mono" id="ctCode">-</div></div>
                  <div class="kv"><div class="k">สถานะ</div><div class="v" id="ctStatus">-</div></div>
                  <div class="kv"><div class="k">เวลา</div><div class="v" id="ctTime">-</div></div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </section>

      <!-- SCAN VIEW -->
      <section class="view" id="view-scan">
        <div class="card">
          <div class="card-h">
            <div class="left">
              <b>สแกนใบหน้าเช็คอิน</b>
              <small>กดเริ่มสแกน → 1/3 2/3 3/3 → พบใบหน้า/ระบุชื่อ → ยืนยัน</small>
            </div>
            <div class="row" style="justify-content:flex-end; flex:0 0 auto;">
              <button class="btn small" id="btnBackFromScan">กลับ</button>
            </div>
          </div>

          <div class="card-b">

            <div id="scanSetupWarn" class="pill warn" style="display:none; margin-bottom:10px;">
              <span>ยังไม่ได้ตั้งค่า API</span>
            </div>

            <div id="camContainer" class="cam-wrap">
              <div class="cam-hud">
                <div class="left">
                  <div class="badge" id="scanBadge"><span id="scanBadgeText">พร้อมสแกน</span></div>
                </div>
                <div class="right">
                  <button class="mini" id="btnToggleMirror" title="สลับกระจก (แก้กล้องกลับด้าน)">Mirror</button>
                  <button class="mini" id="btnFlipCam" title="สลับกล้องหน้า/หลัง">Flip</button>
                </div>
              </div>

              <video id="cam" playsinline autoplay muted></video>
              <canvas id="overlay"></canvas>
            </div>

            <div class="progress">
              <div class="bar"><i id="scanBar"></i></div>
              <div class="step" id="scanStep">0/3</div>
            </div>

            <div style="height:10px"></div>

            <div class="result" id="scanResultWrap" style="display:none;">
              <div class="box">
                <div class="kv"><div class="k">พบ</div><div class="v" id="srFound">-</div></div>
                <div class="kv"><div class="k">ชื่อ</div><div class="v" id="srName">-</div></div>
                <div class="kv"><div class="k">รหัส</div><div class="v mono" id="srCode">-</div></div>
                <div class="kv"><div class="k">ความมั่นใจ</div><div class="v" id="srConf">-</div></div>
              </div>
            </div>

            <div class="scan-footer">
              <button class="btn primary" id="btnStartScan">เริ่มสแกน</button>
              <button class="btn" id="btnStopScan" disabled>หยุด</button>
              <button class="btn ok" id="btnConfirmScan" disabled>ยืนยันเช็คอิน</button>
              <button class="btn ghost" id="btnResetScan">รีเซ็ต</button>
            </div>

          </div>
        </div>
      </section>

      <!-- MANUAL VIEW -->
      <section class="view" id="view-manual">
        <div class="card">
          <div class="card-h">
            <div class="left">
              <b>บันทึกด้วยมือ</b>
              <small>เลือกโหมดบันทึก + เวลา (ถ้าต้องการ) + GPS + แนบรูปหลักฐาน</small>
            </div>
            <button class="btn small" id="btnBackFromManual">กลับ</button>
          </div>
          <div class="card-b">

            <div class="row">
              <div class="field" style="flex: 1 1 180px;">
                <div class="label">รหัสพนักงาน</div>
                <input class="input" id="empCodeManual" placeholder="เช่น 0001" />
              </div>

              <div class="field" style="flex: 1 1 180px;">
                <div class="label">โหมดบันทึก</div>
                <select class="select" id="manualMode">
                  <option value="auto">อัตโนมัติ (ระบบจัดให้)</option>
                  <option value="t1">บันทึกลง T1</option>
                  <option value="t2">บันทึกลง T2</option>
                  <option value="t3">บันทึกลง T3</option>
                  <option value="t4">บันทึกลง T4</option>
                  <option value="extra">Extra/อื่นๆ</option>
                </select>
              </div>

              <div class="field" style="flex: 1 1 180px;">
                <div class="label">เหตุผล / หมายเหตุ</div>
                <input class="input" id="manualNote" placeholder="เช่น ลืมสแกน / กล้องเสีย" />
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="row">
              <div class="field" style="flex: 1 1 240px;">
                <div class="label">แนบรูปหลักฐาน (ถ้ามี)</div>
                <input class="input" id="manualFile" type="file" accept="image/*" />
              </div>

              <div class="field" style="flex: 1 1 240px;">
                <div class="label">ตำแหน่ง GPS</div>
                <input class="input" id="gpsText" placeholder="กด “ดึง GPS”" readonly />
              </div>

              <button class="btn" id="btnGetGps">ดึง GPS</button>
            </div>

            <div style="height:10px"></div>

            <div class="row">
              <button class="btn primary" id="btnSaveManual">บันทึก</button>
              <button class="btn ghost" id="btnClearManual">ล้างฟอร์ม</button>
            </div>

          </div>
        </div>
      </section>

      <!-- TODAY VIEW -->
      <section class="view" id="view-today">
        <div class="card">
          <div class="card-h">
            <div class="left">
              <b>ตรวจสอบวันนี้</b>
              <small>สรุปรวม + ตรวจสอบรายคน</small>
            </div>
            <button class="btn small" id="btnBackFromToday">กลับ</button>
          </div>
          <div class="card-b">
            <div class="row">
              <button class="btn primary" id="btnRefreshToday2">รีเฟรชสรุปวันนี้</button>
              <button class="btn" id="btnFocusCheck">ไปช่องตรวจสอบรายคน</button>
            </div>
            <div style="height:12px"></div>
            <div class="card" style="box-shadow:none; border-radius:18px;">
              <div class="card-b" id="todaySummaryWrap2">
                <div class="skeleton" style="width:62%"></div>
                <div style="height:8px"></div>
                <div class="skeleton" style="width:78%"></div>
                <div style="height:8px"></div>
                <div class="skeleton" style="width:55%"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row" id="focusCheckRow">
              <div class="field" style="min-width:240px; flex:2 1 240px;">
                <div class="label">รหัสพนักงาน</div>
                <input class="input" id="empCodeCheck2" placeholder="ใส่รหัสแล้วกดตรวจสอบ" />
              </div>
              <button class="btn primary" id="btnCheckToday2">ตรวจสอบ</button>
            </div>

            <div style="height:10px"></div>

            <div class="result" id="checkTodayResult2" style="display:none;">
              <div class="box">
                <div class="kv"><div class="k">ชื่อ</div><div class="v" id="ctName2">-</div></div>
                <div class="kv"><div class="k">รหัส</div><div class="v mono" id="ctCode2">-</div></div>
                <div class="kv"><div class="k">สถานะ</div><div class="v" id="ctStatus2">-</div></div>
                <div class="kv"><div class="k">เวลา</div><div class="v" id="ctTime2">-</div></div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- HISTORY VIEW -->
      <section class="view" id="view-history">
        <div class="card">
          <div class="card-h">
            <div class="left">
              <b>เช็คประวัติ</b>
              <small>ดึงข้อมูลตามช่วงวันที่</small>
            </div>
            <button class="btn small" id="btnBackFromHistory">กลับ</button>
          </div>
          <div class="card-b">
            <div class="row">
              <div class="field" style="flex:1 1 200px;">
                <div class="label">วันที่เริ่ม (YYYY-MM-DD)</div>
                <input class="input" id="logFrom" placeholder="2025-12-01" />
              </div>
              <div class="field" style="flex:1 1 200px;">
                <div class="label">วันที่สิ้นสุด (YYYY-MM-DD)</div>
                <input class="input" id="logTo" placeholder="2025-12-16" />
              </div>
              <button class="btn primary" id="btnLoadLogs">ดึงประวัติ</button>
            </div>

            <div style="height:12px"></div>

            <div id="logsWrap">
              <div class="hint">ยังไม่มีข้อมูล</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ADMIN VIEW -->
      <section class="view" id="view-admin">
        <div class="card">
          <div class="card-h">
            <div class="left">
              <b>แอดมิน</b>
              <small>ล็อกอินเพื่อจัดการข้อมูล + บันทึกใบหน้า HR</small>
            </div>
            <button class="btn small" id="btnBackFromAdmin">กลับ</button>
          </div>

          <div class="card-b" id="adminNotLogged">
            <div class="row">
              <div class="field" style="flex: 2 1 260px;">
                <div class="label">รหัสผ่านแอดมิน</div>
                <input class="input" id="adminPass" type="password" placeholder="••••••••" />
              </div>
              <button class="btn primary" id="btnAdminLogin">เข้าสู่ระบบ</button>
            </div>
          </div>

          <div class="card-b" id="adminLogged" style="display:none;">
            <div class="row">
              <div class="pill ok">สถานะ: ล็อกอินแล้ว</div>
              <button class="btn bad small" id="btnAdminLogout">ออกจากระบบ</button>
            </div>

            <div class="divider"></div>

            <!-- Admin Tabs -->
            <div class="row">
              <button class="btn small" data-admintab="faces" id="tabFaces">บันทึกใบหน้า HR</button>
              <button class="btn small" data-admintab="employees" id="tabEmployees">พนักงาน</button>
              <button class="btn small" data-admintab="reports" id="tabReports">รายงาน</button>
            </div>

            <div style="height:12px"></div>

            <!-- Face Register -->
            <div id="adminTabFaces" class="card" style="box-shadow:none; border-radius:18px;">
              <div class="card-h" style="border-radius:18px 18px 0 0;">
                <div class="left">
                  <b>บันทึกใบหน้า (HR)</b>
                  <small>ใช้กล้องเดียวกับหน้า “สแกนใบหน้า” แต่โหมด “บันทึกใบหน้า”</small>
                </div>
                <div class="pill" id="hrCamPill">กล้อง: -</div>
              </div>
              <div class="card-b">
                <div class="row">
                  <div class="field" style="flex:1 1 200px;">
                    <div class="label">รหัสพนักงาน</div>
                    <input class="input" id="hrEmpCode" placeholder="เช่น 0001" />
                  </div>
                  <div class="field" style="flex:2 1 260px;">
                    <div class="label">ชื่อ-นามสกุล</div>
                    <input class="input" id="hrEmpName" placeholder="เช่น นายสมชาย ใจดี" />
                  </div>
                </div>

                <div style="height:10px"></div>

                <div class="cam-wrap" id="hrCamContainer">
                  <div class="cam-hud">
                    <div class="left">
                      <div class="badge" id="hrBadge"><span id="hrBadgeText">พร้อมบันทึกใบหน้า</span></div>
                    </div>
                    <div class="right">
                      <button class="mini" id="btnHrMirror">Mirror</button>
                      <button class="mini" id="btnHrFlip">Flip</button>
                    </div>
                  </div>
                  <video id="hrCam" playsinline autoplay muted></video>
                  <canvas id="hrOverlay"></canvas>
                </div>

                <div class="progress">
                  <div class="bar"><i id="hrBar"></i></div>
                  <div class="step" id="hrStep">0/3</div>
                </div>

                <div style="height:10px"></div>

                <div class="row">
                  <button class="btn primary" id="btnHrStart">เริ่ม</button>
                  <button class="btn" id="btnHrStop" disabled>หยุด</button>
                  <button class="btn ok" id="btnHrSave" disabled>บันทึกใบหน้า</button>
                  <button class="btn ghost" id="btnHrReset">รีเซ็ต</button>
                </div>
              </div>
            </div>

            <div style="height:12px"></div>

            <!-- Employees -->
            <div id="adminTabEmployees" class="card" style="display:none; box-shadow:none; border-radius:18px;">
              <div class="card-h" style="border-radius:18px 18px 0 0;">
                <div class="left">
                  <b>พนักงาน</b>
                  <small>ดึงจาก getInitialData และทำ CRUD (ถ้า action ฝั่ง GS ตรง)</small>
                </div>
                <button class="btn small" id="btnLoadEmployees">โหลด</button>
              </div>
              <div class="card-b">
                <div class="row">
                  <div class="field" style="flex:1 1 200px;">
                    <div class="label">ค้นหา</div>
                    <input class="input" id="empSearch" placeholder="ชื่อ/รหัส" />
                  </div>
                  <button class="btn" id="btnNewEmp">เพิ่มพนักงาน</button>
                </div>

                <div style="height:12px"></div>
                <div id="employeesWrap"><div class="hint">ยังไม่ได้โหลด</div></div>
              </div>
            </div>

            <div style="height:12px"></div>

            <!-- Reports -->
            <div id="adminTabReports" class="card" style="display:none; box-shadow:none; border-radius:18px;">
              <div class="card-h" style="border-radius:18px 18px 0 0;">
                <div class="left">
                  <b>รายงาน</b>
                  <small>Summary Range / Logs Range</small>
                </div>
              </div>
              <div class="card-b">
                <div class="row">
                  <div class="field" style="flex:1 1 200px;">
                    <div class="label">จากวันที่</div>
                    <input class="input" id="repFrom" placeholder="2025-12-01" />
                  </div>
                  <div class="field" style="flex:1 1 200px;">
                    <div class="label">ถึงวันที่</div>
                    <input class="input" id="repTo" placeholder="2025-12-16" />
                  </div>
                </div>

                <div style="height:10px"></div>

                <div class="row">
                  <button class="btn primary" id="btnRepSummary">ดึง Summary</button>
                  <button class="btn" id="btnRepLogs">ดึง Logs</button>
                </div>

                <div style="height:12px"></div>
                <div id="reportsWrap"><div class="hint">ยังไม่มีข้อมูล</div></div>

                <!-- NOTE: ตามที่คุณบอก "ลบปุ่ม export csv ออก" => ไม่มีปุ่ม export ในหน้านี้แล้ว -->
              </div>
            </div>

          </div>
        </div>
      </section>

    </main>

    <!-- Toast -->
    <div class="toast-wrap" aria-live="polite" aria-atomic="true">
      <div class="toast" id="toast">
        <div class="t-left">
          <div class="dot" id="toastDot"></div>
          <div class="msg" id="toastMsg"></div>
        </div>
        <button class="x" id="toastX" title="ปิด">
          <svg class="icon" viewBox="0 0 24 24" fill="none">
            <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- API Modal -->
    <div class="modal" id="apiModal" role="dialog" aria-modal="true" aria-label="ตั้งค่า API">
      <div class="sheet">
        <div class="sheet-h">
          <div>
            <b>ตั้งค่า API URL</b>
            <small>จะเก็บลง localStorage: <span class="mono">attendance_api_url_v2</span></small>
          </div>
          <button class="icon-btn" id="btnCloseApi" title="ปิด">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="sheet-b">
          <div class="field">
            <div class="label">API URL (Google Apps Script Web App)</div>
            <input class="input" id="apiInput" placeholder="https://script.google.com/macros/s/xxxxx/exec" />
            <div class="hint">แนะนำ: ต้องเป็นลิงก์ที่ลงท้ายด้วย <span class="mono">/exec</span></div>
          </div>
        </div>
        <div class="sheet-f">
          <button class="btn ghost" id="btnApiClear">ล้าง</button>
          <button class="btn primary" id="btnApiSave">บันทึก</button>
        </div>
      </div>
    </div>

    <!-- Employee Modal (Add/Edit) -->
    <div class="modal" id="empModal" role="dialog" aria-modal="true" aria-label="พนักงาน">
      <div class="sheet">
        <div class="sheet-h">
          <div>
            <b id="empModalTitle">พนักงาน</b>
            <small>เพิ่ม/แก้ไข (ถ้า action ฝั่ง GS รองรับ)</small>
          </div>
          <button class="icon-btn" id="btnEmpModalClose" title="ปิด">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="sheet-b">
          <input type="hidden" id="empId" />
          <div class="row">
            <div class="field">
              <div class="label">รหัสพนักงาน</div>
              <input class="input" id="empCode" placeholder="0001" />
            </div>
            <div class="field">
              <div class="label">ชื่อ-นามสกุล</div>
              <input class="input" id="empName" placeholder="ชื่อจริง" />
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div class="field">
              <div class="label">สาขา (Branch)</div>
              <input class="input" id="empBranch" placeholder="เช่น HQ" />
            </div>
            <div class="field">
              <div class="label">ระดับ (Level)</div>
              <input class="input" id="empLevel" placeholder="เช่น Staff" />
            </div>
          </div>
        </div>
        <div class="sheet-f">
          <button class="btn bad" id="btnEmpDelete" style="display:none;">ลบ</button>
          <button class="btn ghost" id="btnEmpCancel">ยกเลิก</button>
          <button class="btn primary" id="btnEmpSave">บันทึก</button>
        </div>
      </div>
    </div>

  </div>

  <script>
  (() => {
    'use strict';

    /**********************************************************************
     * CONFIG
     **********************************************************************/
    const LS_API_KEY = 'attendance_api_url_v2';
    const LS_ADMIN_KEY = 'attendance_admin_logged_v1';

    // Action names (ปรับได้ให้ตรง GS ของคุณ)
    const ACTIONS = {
      ping: 'ping',                    // optional
      getInitialData: 'getInitialData',// existing in your GS
      getTodaySummary: 'getTodaySummary',
      checkTodayByCode: 'checkTodayByCode', // or getTodayByCode
      saveManualLog: 'saveManualLog',
      getLogsRange: 'getLogsRange',
      getSummaryRange: 'getSummaryRange',
      loginAdmin: 'loginAdmin',

      // Face-related (ต้องมีใน GS หรือคุณตั้งชื่อใหม่ให้ตรง)
      recognizeFace: 'recognizeFace',      // รับภาพ -> ตอบว่าเป็นใคร
      confirmFaceCheckin: 'confirmFaceCheckin', // ยืนยันเช็คอิน -> บันทึกลงชีต
      uploadEmployeeFace: 'uploadEmployeeFace'   // HR บันทึกใบหน้า
    };

    // Face scan params
    const SCAN = {
      stepsTotal: 3,
      minConfidence: 0.65,     // เกณฑ์มั่นใจ
      frameIntervalMs: 650,    // ส่งภาพไป GS ถี่แค่ไหน
      requiredHits: 3,         // ต้องได้ผลซ้ำๆกี่ครั้งถึง "ล็อกชื่อ"
      maxSeconds: 18           // กันสแกนค้าง
    };

    // Camera constraints
    const CAM = {
      width: { ideal: 1280 },
      height: { ideal: 720 },
      facingMode: 'user' // default front
    };

    /**********************************************************************
     * STATE
     **********************************************************************/
    const state = {
      apiUrl: '',
      adminLogged: false,

      gps: { lat: null, lng: null, accuracy: null, ts: null },

      view: 'home',

      // scan attendance camera
      camStream: null,
      camFacing: 'user',
      camMirror: true,

      scan: {
        running: false,
        startedAt: 0,
        step: 0,
        timer: null,
        hits: 0,
        locked: false,
        person: null, // {code,name,confidence}
        lastResultText: '',
        canvas: null,
        ctx: null
      },

      // hr face register camera
      hrStream: null,
      hrFacing: 'user',
      hrMirror: true,
      hr: {
        running: false,
        startedAt: 0,
        step: 0,
        timer: null,
        hits: 0,
        locked: false,
        bestShot: null, // blob/base64
      },

      // data cache
      employees: [],
    };

    /**********************************************************************
     * DOM
     **********************************************************************/
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const dom = {
      // top
      apiStatus: $('#apiStatus'),
      pillApi: $('#pillApi'),
      sysText: $('#sysText'),
      lastText: $('#lastText'),
      nowText: $('#nowText'),

      // drawer
      drawer: $('#drawer'),
      drawerBackdrop: $('#drawerBackdrop'),
      btnMenu: $('#btnMenu'),
      btnCloseDrawer: $('#btnCloseDrawer'),
      drawerApiText: $('#drawerApiText'),
      btnMenuApi: $('#btnMenuApi'),
      adminNavBadge: $('#adminNavBadge'),

      // nav buttons
      navBtns: $$('.navbtn[data-go]'),

      // views
      viewHome: $('#view-home'),
      viewScan: $('#view-scan'),
      viewManual: $('#view-manual'),
      viewToday: $('#view-today'),
      viewHistory: $('#view-history'),
      viewAdmin: $('#view-admin'),

      // quick
      goScan: $('#goScan'),
      goManual: $('#goManual'),
      goToday: $('#goToday'),
      goHistory: $('#goHistory'),

      // today summary
      todaySummaryWrap: $('#todaySummaryWrap'),
      todaySummaryWrap2: $('#todaySummaryWrap2'),
      btnRefreshToday: $('#btnRefreshToday'),
      btnRefreshToday2: $('#btnRefreshToday2'),

      // check today
      empCodeCheck: $('#empCodeCheck'),
      btnCheckToday: $('#btnCheckToday'),
      checkTodayResult: $('#checkTodayResult'),
      ctName: $('#ctName'),
      ctCode: $('#ctCode'),
      ctStatus: $('#ctStatus'),
      ctTime: $('#ctTime'),

      empCodeCheck2: $('#empCodeCheck2'),
      btnCheckToday2: $('#btnCheckToday2'),
      checkTodayResult2: $('#checkTodayResult2'),
      ctName2: $('#ctName2'),
      ctCode2: $('#ctCode2'),
      ctStatus2: $('#ctStatus2'),
      ctTime2: $('#ctTime2'),

      gpsPill: $('#gpsPill'),

      // API modal
      apiModal: $('#apiModal'),
      btnOpenApi: $('#btnOpenApi'),
      btnCloseApi: $('#btnCloseApi'),
      apiInput: $('#apiInput'),
      btnApiSave: $('#btnApiSave'),
      btnApiClear: $('#btnApiClear'),

      // toast
      toast: $('#toast'),
      toastDot: $('#toastDot'),
      toastMsg: $('#toastMsg'),
      toastX: $('#toastX'),

      // scan
      btnBackFromScan: $('#btnBackFromScan'),
      scanSetupWarn: $('#scanSetupWarn'),
      camContainer: $('#camContainer'),
      cam: $('#cam'),
      overlay: $('#overlay'),
      btnStartScan: $('#btnStartScan'),
      btnStopScan: $('#btnStopScan'),
      btnConfirmScan: $('#btnConfirmScan'),
      btnResetScan: $('#btnResetScan'),
      btnFlipCam: $('#btnFlipCam'),
      btnToggleMirror: $('#btnToggleMirror'),
      scanBadge: $('#scanBadge'),
      scanBadgeText: $('#scanBadgeText'),
      scanBar: $('#scanBar'),
      scanStep: $('#scanStep'),
      scanResultWrap: $('#scanResultWrap'),
      srFound: $('#srFound'),
      srName: $('#srName'),
      srCode: $('#srCode'),
      srConf: $('#srConf'),

      // manual
      btnBackFromManual: $('#btnBackFromManual'),
      empCodeManual: $('#empCodeManual'),
      manualMode: $('#manualMode'),
      manualNote: $('#manualNote'),
      manualFile: $('#manualFile'),
      gpsText: $('#gpsText'),
      btnGetGps: $('#btnGetGps'),
      btnSaveManual: $('#btnSaveManual'),
      btnClearManual: $('#btnClearManual'),

      // today view
      btnBackFromToday: $('#btnBackFromToday'),
      btnFocusCheck: $('#btnFocusCheck'),
      focusCheckRow: $('#focusCheckRow'),

      // history
      btnBackFromHistory: $('#btnBackFromHistory'),
      logFrom: $('#logFrom'),
      logTo: $('#logTo'),
      btnLoadLogs: $('#btnLoadLogs'),
      logsWrap: $('#logsWrap'),

      // admin
      btnBackFromAdmin: $('#btnBackFromAdmin'),
      adminNotLogged: $('#adminNotLogged'),
      adminLogged: $('#adminLogged'),
      adminPass: $('#adminPass'),
      btnAdminLogin: $('#btnAdminLogin'),
      btnAdminLogout: $('#btnAdminLogout'),

      // admin tabs
      tabFaces: $('#tabFaces'),
      tabEmployees: $('#tabEmployees'),
      tabReports: $('#tabReports'),
      adminTabFaces: $('#adminTabFaces'),
      adminTabEmployees: $('#adminTabEmployees'),
      adminTabReports: $('#adminTabReports'),

      // HR cam
      hrCamPill: $('#hrCamPill'),
      hrCamContainer: $('#hrCamContainer'),
      hrCam: $('#hrCam'),
      hrOverlay: $('#hrOverlay'),
      hrBadge: $('#hrBadge'),
      hrBadgeText: $('#hrBadgeText'),
      hrBar: $('#hrBar'),
      hrStep: $('#hrStep'),
      btnHrStart: $('#btnHrStart'),
      btnHrStop: $('#btnHrStop'),
      btnHrSave: $('#btnHrSave'),
      btnHrReset: $('#btnHrReset'),
      btnHrFlip: $('#btnHrFlip'),
      btnHrMirror: $('#btnHrMirror'),
      hrEmpCode: $('#hrEmpCode'),
      hrEmpName: $('#hrEmpName'),

      // employees UI
      btnLoadEmployees: $('#btnLoadEmployees'),
      employeesWrap: $('#employeesWrap'),
      empSearch: $('#empSearch'),
      btnNewEmp: $('#btnNewEmp'),

      // reports UI
      repFrom: $('#repFrom'),
      repTo: $('#repTo'),
      btnRepSummary: $('#btnRepSummary'),
      btnRepLogs: $('#btnRepLogs'),
      reportsWrap: $('#reportsWrap'),

      // employee modal
      empModal: $('#empModal'),
      empModalTitle: $('#empModalTitle'),
      btnEmpModalClose: $('#btnEmpModalClose'),
      btnEmpCancel: $('#btnEmpCancel'),
      btnEmpSave: $('#btnEmpSave'),
      btnEmpDelete: $('#btnEmpDelete'),
      empId: $('#empId'),
      empCode: $('#empCode'),
      empName: $('#empName'),
      empBranch: $('#empBranch'),
      empLevel: $('#empLevel'),
    };

    /**********************************************************************
     * UTILS
     **********************************************************************/
    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtNow(){
      const d = new Date();
      return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    function showToast(type, title, text){
      dom.toastDot.className = 'dot' + (type ? ` ${type}` : '');
      dom.toastMsg.innerHTML = `<b>${escapeHtml(title || '')}</b>${escapeHtml(text || '')}`;
      dom.toast.classList.add('show');

      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => hideToast(), 2800);
    }
    function hideToast(){
      dom.toast.classList.remove('show');
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function setApiUrl(url){
      state.apiUrl = (url || '').trim();
      if(state.apiUrl){
        localStorage.setItem(LS_API_KEY, state.apiUrl);
      }else{
        localStorage.removeItem(LS_API_KEY);
      }
      refreshApiUI();
    }

    function refreshApiUI(){
      const ok = !!state.apiUrl;
      dom.apiStatus.textContent = ok ? `API: พร้อมใช้งาน` : `API: ยังไม่ได้ตั้งค่า`;
      dom.drawerApiText.textContent = `API: ${ok ? 'พร้อมใช้งาน' : '-'}`;
      dom.pillApi.className = 'pill' + (ok ? ' ok' : '');
      dom.pillApi.textContent = ok ? 'API พร้อม' : 'API ยังไม่พร้อม';

      dom.scanSetupWarn.style.display = ok ? 'none' : 'inline-flex';

      // status label
      dom.sysText.textContent = ok ? 'พร้อมใช้งาน' : 'กรุณาตั้งค่า API';
      dom.pillApi.title = ok ? state.apiUrl : '';
    }

    function setAdminLogged(flag){
      state.adminLogged = !!flag;
      if(state.adminLogged){
        localStorage.setItem(LS_ADMIN_KEY, '1');
      }else{
        localStorage.removeItem(LS_ADMIN_KEY);
      }
      dom.adminNavBadge.textContent = state.adminLogged ? 'Panel' : 'Login';
      dom.adminNotLogged.style.display = state.adminLogged ? 'none' : 'block';
      dom.adminLogged.style.display = state.adminLogged ? 'block' : 'none';
    }

    function setLast(text){
      state.scan.lastResultText = text || '-';
      dom.lastText.textContent = state.scan.lastResultText;
    }

    function setGpsPill(){
      if(state.gps.lat && state.gps.lng){
        dom.gpsPill.className = 'pill ok';
        dom.gpsPill.textContent = `GPS: พร้อม`;
      }else{
        dom.gpsPill.className = 'pill warn';
        dom.gpsPill.textContent = `GPS: -`;
      }
    }

    /**********************************************************************
     * ROUTER (simple)
     **********************************************************************/
    const views = {
      home: dom.viewHome,
      scan: dom.viewScan,
      manual: dom.viewManual,
      today: dom.viewToday,
      history: dom.viewHistory,
      admin: dom.viewAdmin,
    };

    function go(viewName){
      state.view = viewName;
      Object.entries(views).forEach(([k, el]) => {
        el.classList.toggle('active', k === viewName);
      });

      dom.navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.go === viewName));

      closeDrawer();

      // stop cameras when leaving certain views
      if(viewName !== 'scan'){ stopScanCamera(); resetScanUI(false); }
      if(viewName !== 'admin'){ stopHrCamera(); resetHrUI(false); }

      // on enter
      if(viewName === 'home'){
        // noop
      }
      if(viewName === 'today'){
        // copy input value
        dom.empCodeCheck2.value = dom.empCodeCheck.value.trim();
      }
      if(viewName === 'scan'){
        if(!state.apiUrl){
          showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อนใช้งานสแกนใบหน้า');
        }
      }
      if(viewName === 'admin'){
        if(state.adminLogged){
          selectAdminTab('faces');
        }
      }

      // sync hash (optional)
      try{ location.hash = `#${viewName}`; }catch(e){}
    }

    function openDrawer(){
      dom.drawer.classList.add('show');
    }
    function closeDrawer(){
      dom.drawer.classList.remove('show');
    }

    /**********************************************************************
     * MODALS
     **********************************************************************/
    function openApiModal(){
      dom.apiInput.value = state.apiUrl || '';
      dom.apiModal.classList.add('show');
      setTimeout(() => dom.apiInput.focus(), 60);
    }
    function closeApiModal(){
      dom.apiModal.classList.remove('show');
    }

    function openEmpModal(mode, emp){
      dom.empModal.classList.add('show');
      dom.empId.value = emp?.id || '';
      dom.empCode.value = emp?.code || '';
      dom.empName.value = emp?.name || '';
      dom.empBranch.value = emp?.branch || '';
      dom.empLevel.value = emp?.level || '';

      dom.empModalTitle.textContent = mode === 'edit' ? 'แก้ไขพนักงาน' : 'เพิ่มพนักงาน';
      dom.btnEmpDelete.style.display = mode === 'edit' ? 'inline-flex' : 'none';

      setTimeout(() => dom.empCode.focus(), 60);
    }
    function closeEmpModal(){
      dom.empModal.classList.remove('show');
    }

    /**********************************************************************
     * NETWORK
     **********************************************************************/
    function assertApi(){
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API URL ก่อน');
        throw new Error('API URL missing');
      }
    }

    async function apiCall(action, data={}, opts={}){
      assertApi();

      const url = state.apiUrl;
      const method = 'POST';

      // Some endpoints might prefer x-www-form-urlencoded or JSON.
      // We'll default to JSON. For file uploads use FormData via opts.formData = true
      let body;
      let headers = opts.headers || {};

      if(opts.formData){
        const fd = new FormData();
        fd.append('action', action);
        Object.entries(data || {}).forEach(([k,v]) => {
          if(v === undefined || v === null) return;
          if(v instanceof Blob || v instanceof File){
            fd.append(k, v);
          }else{
            fd.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
          }
        });
        body = fd;
        // DO NOT set Content-Type for formData
      }else{
        headers['Content-Type'] = 'application/json';
        body = JSON.stringify({ action, ...data });
      }

      const res = await fetch(url, { method, headers, body });
      const text = await res.text();

      let json;
      try{
        json = JSON.parse(text);
      }catch(e){
        // sometimes GAS returns plain text; wrap it
        json = { ok: false, raw: text };
      }

      if(!res.ok){
        const msg = json?.message || json?.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      if(json && json.ok === false){
        const msg = json?.message || json?.error || 'เกิดข้อผิดพลาด';
        throw new Error(msg);
      }
      return json;
    }

    /**********************************************************************
     * GPS
     **********************************************************************/
    async function getGps(){
      if(!('geolocation' in navigator)){
        showToast('bad','อุปกรณ์ไม่รองรับ','ไม่พบ geolocation');
        return null;
      }

      return new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            state.gps = { lat: latitude, lng: longitude, accuracy, ts: Date.now() };
            dom.gpsText.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)} (±${Math.round(accuracy)}m)`;
            setGpsPill();
            resolve(state.gps);
          },
          (err) => {
            showToast('bad','ดึง GPS ไม่สำเร็จ', err.message || '');
            resolve(null);
          },
          { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
        );
      });
    }

    /**********************************************************************
     * TODAY SUMMARY + CHECK
     **********************************************************************/
    function renderTodaySummary(targetEl, data){
      // data format flexible; just show friendly blocks
      const items = [];
      if(data?.date) items.push(['วันที่', data.date]);
      if(data?.total !== undefined) items.push(['รวม', data.total]);
      if(data?.checkedIn !== undefined) items.push(['เข้าแล้ว', data.checkedIn]);
      if(data?.late !== undefined) items.push(['สาย', data.late]);
      if(data?.absent !== undefined) items.push(['ขาด', data.absent]);

      // fallback: show json keys
      if(items.length === 0 && data && typeof data === 'object'){
        Object.keys(data).slice(0,8).forEach(k => items.push([k, JSON.stringify(data[k])]));
      }

      const html = `
        <div class="result">
          <div class="box">
            ${items.map(([k,v]) => `
              <div class="kv">
                <div class="k">${escapeHtml(k)}</div>
                <div class="v">${escapeHtml(v)}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      targetEl.innerHTML = html;
    }

    async function refreshTodaySummary(){
      if(!state.apiUrl){
        dom.todaySummaryWrap.innerHTML = `<div class="hint">กรุณาตั้งค่า API ก่อน</div>`;
        dom.todaySummaryWrap2.innerHTML = `<div class="hint">กรุณาตั้งค่า API ก่อน</div>`;
        return;
      }

      dom.todaySummaryWrap.innerHTML = `<div class="skeleton" style="width:62%"></div><div style="height:8px"></div><div class="skeleton" style="width:78%"></div><div style="height:8px"></div><div class="skeleton" style="width:55%"></div>`;
      dom.todaySummaryWrap2.innerHTML = dom.todaySummaryWrap.innerHTML;

      try{
        const json = await apiCall(ACTIONS.getTodaySummary, {});
        const payload = json?.data ?? json;
        renderTodaySummary(dom.todaySummaryWrap, payload);
        renderTodaySummary(dom.todaySummaryWrap2, payload);
        setLast('โหลดสรุปวันนี้สำเร็จ');
      }catch(e){
        dom.todaySummaryWrap.innerHTML = `<div class="hint">${escapeHtml(e.message || 'เกิดข้อผิดพลาด')}</div>`;
        dom.todaySummaryWrap2.innerHTML = dom.todaySummaryWrap.innerHTML;
        showToast('bad','สรุปวันนี้ไม่สำเร็จ', e.message || '');
        setLast('สรุปวันนี้ไม่สำเร็จ');
      }
    }

    function renderCheckToday(targetPrefix, row){
      // row expected: {name, code, status, time} (ปรับได้)
      const name = row?.name ?? row?.fullName ?? '-';
      const code = row?.code ?? row?.employeeCode ?? '-';
      const status = row?.status ?? row?.todayStatus ?? '-';
      const time = row?.time ?? row?.lastTime ?? '-';

      $(`#${targetPrefix}Name`).textContent = name;
      $(`#${targetPrefix}Code`).textContent = code;
      $(`#${targetPrefix}Status`).textContent = status;
      $(`#${targetPrefix}Time`).textContent = time;
    }

    async function checkTodayByCode(code, which=1){
      code = (code || '').trim();
      if(!code){
        showToast('warn','ใส่รหัสก่อน','กรุณาใส่รหัสพนักงาน');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      try{
        const json = await apiCall(ACTIONS.checkTodayByCode, { code });
        const data = json?.data ?? json;
        if(which === 1){
          dom.checkTodayResult.style.display = 'block';
          dom.ctName.textContent = data?.name ?? data?.fullName ?? '-';
          dom.ctCode.textContent = data?.code ?? data?.employeeCode ?? code;
          dom.ctStatus.textContent = data?.status ?? data?.todayStatus ?? '-';
          dom.ctTime.textContent = data?.time ?? data?.lastTime ?? '-';
        }else{
          dom.checkTodayResult2.style.display = 'block';
          dom.ctName2.textContent = data?.name ?? data?.fullName ?? '-';
          dom.ctCode2.textContent = data?.code ?? data?.employeeCode ?? code;
          dom.ctStatus2.textContent = data?.status ?? data?.todayStatus ?? '-';
          dom.ctTime2.textContent = data?.time ?? data?.lastTime ?? '-';
        }
        showToast('ok','ตรวจสอบสำเร็จ', `รหัส ${code}`);
        setLast(`ตรวจสอบวันนี้: ${code}`);
      }catch(e){
        showToast('bad','ตรวจสอบไม่สำเร็จ', e.message || '');
        setLast('ตรวจสอบวันนี้ไม่สำเร็จ');
      }
    }

    /**********************************************************************
     * HISTORY / LOGS RANGE
     **********************************************************************/
    function renderLogs(list){
      if(!Array.isArray(list) || list.length === 0){
        dom.logsWrap.innerHTML = `<div class="hint">ไม่พบข้อมูลในช่วงที่เลือก</div>`;
        return;
      }
      const rows = list.slice(0, 200).map((it) => {
        const d = it?.date ?? it?.d ?? '-';
        const t = it?.time ?? it?.t ?? '-';
        const code = it?.code ?? it?.employeeCode ?? '-';
        const name = it?.name ?? it?.fullName ?? '-';
        const type = it?.type ?? it?.slot ?? it?.mode ?? '-';
        return `<tr>
          <td><b>${escapeHtml(name)}</b><small class="mono">${escapeHtml(code)}</small></td>
          <td>${escapeHtml(d)}<small>${escapeHtml(t)}</small></td>
          <td>${escapeHtml(type)}</td>
        </tr>`;
      }).join('');

      dom.logsWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>พนักงาน</th>
              <th>วัน/เวลา</th>
              <th>ประเภท</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    async function loadLogsRange(){
      const from = dom.logFrom.value.trim();
      const to = dom.logTo.value.trim();
      if(!from || !to){
        showToast('warn','กรอกวันที่','กรุณากรอก from/to');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      dom.logsWrap.innerHTML = `<div class="skeleton" style="width:55%"></div><div style="height:8px"></div><div class="skeleton" style="width:82%"></div><div style="height:8px"></div><div class="skeleton" style="width:68%"></div>`;

      try{
        const json = await apiCall(ACTIONS.getLogsRange, { from, to });
        const list = json?.data ?? json?.rows ?? json?.logs ?? [];
        renderLogs(list);
        showToast('ok','โหลดสำเร็จ', `ช่วง ${from} ถึง ${to}`);
        setLast('โหลดประวัติสำเร็จ');
      }catch(e){
        dom.logsWrap.innerHTML = `<div class="hint">${escapeHtml(e.message || 'เกิดข้อผิดพลาด')}</div>`;
        showToast('bad','โหลดประวัติไม่สำเร็จ', e.message || '');
        setLast('โหลดประวัติไม่สำเร็จ');
      }
    }

    /**********************************************************************
     * MANUAL SAVE
     **********************************************************************/
    async function saveManual(){
      const code = dom.empCodeManual.value.trim();
      const mode = dom.manualMode.value;
      const note = dom.manualNote.value.trim();
      const file = dom.manualFile.files?.[0] || null;

      if(!code){
        showToast('warn','ใส่รหัสก่อน','กรุณาใส่รหัสพนักงาน');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      // ensure GPS (ไม่บังคับ แต่แนะนำ)
      if(!state.gps.lat || !state.gps.lng){
        await getGps();
      }

      dom.btnSaveManual.disabled = true;

      try{
        if(file){
          const json = await apiCall(ACTIONS.saveManualLog, {
            code,
            mode,
            note,
            lat: state.gps.lat,
            lng: state.gps.lng,
            accuracy: state.gps.accuracy,
            evidence: file
          }, { formData: true });

          showToast('ok','บันทึกสำเร็จ', `รหัส ${code}`);
          setLast(`Manual saved: ${code}`);
        }else{
          const json = await apiCall(ACTIONS.saveManualLog, {
            code,
            mode,
            note,
            lat: state.gps.lat,
            lng: state.gps.lng,
            accuracy: state.gps.accuracy
          });
          showToast('ok','บันทึกสำเร็จ', `รหัส ${code}`);
          setLast(`Manual saved: ${code}`);
        }

        dom.manualNote.value = '';
        dom.manualFile.value = '';
      }catch(e){
        showToast('bad','บันทึกไม่สำเร็จ', e.message || '');
        setLast('Manual save failed');
      }finally{
        dom.btnSaveManual.disabled = false;
      }
    }

    function clearManual(){
      dom.empCodeManual.value = '';
      dom.manualMode.value = 'auto';
      dom.manualNote.value = '';
      dom.manualFile.value = '';
      dom.gpsText.value = '';
      state.gps = { lat:null, lng:null, accuracy:null, ts:null };
      setGpsPill();
      showToast('ok','ล้างแล้ว','พร้อมกรอกใหม่');
    }

    /**********************************************************************
     * CAMERA HELPERS
     **********************************************************************/
    async function startCamera(videoEl, facingMode){
      const constraints = {
        audio: false,
        video: {
          width: CAM.width,
          height: CAM.height,
          facingMode: facingMode || 'user'
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      videoEl.srcObject = stream;
      await videoEl.play();
      return stream;
    }

    function stopStream(stream){
      try{
        stream?.getTracks?.().forEach(t => t.stop());
      }catch(e){}
    }

    function drawOverlayBox(canvas, text, type='warn'){
      // simple overlay: top-center text box
      const ctx = canvas.getContext('2d');
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // frame box
      ctx.globalAlpha = 1;
      ctx.lineWidth = 4;
      ctx.strokeStyle = type==='ok' ? 'rgba(34,197,94,.95)' : type==='bad' ? 'rgba(239,68,68,.95)' : 'rgba(245,158,11,.95)';
      const pad = Math.round(Math.min(w,h) * 0.10);
      const bw = w - pad*2;
      const bh = h - pad*2;
      const r = Math.round(Math.min(w,h) * 0.06);
      roundRect(ctx, pad, pad, bw, bh, r);
      ctx.stroke();

      // label
      if(text){
        ctx.font = '700 18px Prompt, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        const tx = w/2, ty = 14;
        const metrics = ctx.measureText(text);
        const boxW = metrics.width + 28;
        const boxH = 34;
        ctx.fillStyle = 'rgba(255,255,255,.88)';
        roundRect(ctx, tx - boxW/2, ty, boxW, boxH, 12);
        ctx.fill();

        ctx.fillStyle = 'rgba(15,23,42,.95)';
        ctx.fillText(text, tx, ty + 6);
      }
    }

    function roundRect(ctx, x, y, w, h, r){
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }

    function syncCanvasToVideo(canvas, video){
      const vw = video.videoWidth || 1280;
      const vh = video.videoHeight || 720;
      canvas.width = vw;
      canvas.height = vh;
    }

    function setBadge(badgeEl, textEl, type, text){
      badgeEl.classList.remove('ok','bad','warn');
      badgeEl.classList.add(type || '');
      textEl.textContent = text || '';
    }

    function setProgress(barEl, stepEl, step, total){
      const pct = total ? Math.max(0, Math.min(100, (step/total)*100)) : 0;
      barEl.style.width = pct.toFixed(0) + '%';
      stepEl.textContent = `${step}/${total}`;
    }

    async function captureFrameAsJpegBase64(videoEl, quality=0.8){
      // capture a single frame as base64 jpeg (small)
      const c = document.createElement('canvas');
      const w = Math.min(960, videoEl.videoWidth || 960);
      const h = Math.round(w * (videoEl.videoHeight || 720) / (videoEl.videoWidth || 960));
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');

      // draw frame
      ctx.drawImage(videoEl, 0, 0, w, h);
      const dataUrl = c.toDataURL('image/jpeg', quality);
      return dataUrl; // "data:image/jpeg;base64,..."
    }

    /**********************************************************************
     * FACE SCAN (Attendance)
     **********************************************************************/
    async function startScanCamera(){
      if(state.camStream) return;
      if(!navigator.mediaDevices?.getUserMedia){
        showToast('bad','อุปกรณ์ไม่รองรับ','ไม่พบ getUserMedia');
        return;
      }
      try{
        state.camStream = await startCamera(dom.cam, state.camFacing);
        syncCanvasToVideo(dom.overlay, dom.cam);
        state.scan.canvas = dom.overlay;
        state.scan.ctx = dom.overlay.getContext('2d');

        // mirror class
        dom.camContainer.classList.toggle('mirror', state.camMirror);

        setBadge(dom.scanBadge, dom.scanBadgeText, '', 'พร้อมสแกน');
        drawOverlayBox(dom.overlay, 'พร้อมสแกน', 'warn');
      }catch(e){
        showToast('bad','เปิดกล้องไม่สำเร็จ', e.message || '');
      }
    }

    function stopScanCamera(){
      stopStream(state.camStream);
      state.camStream = null;
      try{
        dom.cam.pause?.();
        dom.cam.srcObject = null;
      }catch(e){}
    }

    function resetScanUI(soft=true){
      state.scan.running = false;
      state.scan.step = 0;
      state.scan.hits = 0;
      state.scan.locked = false;
      state.scan.person = null;
      clearInterval(state.scan.timer);
      state.scan.timer = null;

      dom.btnStartScan.disabled = false;
      dom.btnStopScan.disabled = true;
      dom.btnConfirmScan.disabled = true;

      setProgress(dom.scanBar, dom.scanStep, 0, SCAN.stepsTotal);

      dom.scanResultWrap.style.display = 'none';
      dom.srFound.textContent = '-';
      dom.srName.textContent = '-';
      dom.srCode.textContent = '-';
      dom.srConf.textContent = '-';

      if(soft){
        setBadge(dom.scanBadge, dom.scanBadgeText, '', 'พร้อมสแกน');
        if(dom.overlay.width) drawOverlayBox(dom.overlay, 'พร้อมสแกน', 'warn');
      }
    }

    async function runScanLoop(){
      // loop steps: 1/3 2/3 3/3
      state.scan.running = true;
      state.scan.startedAt = Date.now();
      state.scan.step = 0;
      state.scan.hits = 0;
      state.scan.locked = false;
      state.scan.person = null;

      dom.btnStartScan.disabled = true;
      dom.btnStopScan.disabled = false;
      dom.btnConfirmScan.disabled = true;

      setBadge(dom.scanBadge, dom.scanBadgeText, 'warn', 'กำลังสแกน…');
      setProgress(dom.scanBar, dom.scanStep, 0, SCAN.stepsTotal);
      drawOverlayBox(dom.overlay, 'กำลังสแกน…', 'warn');

      state.scan.timer = setInterval(async () => {
        if(!state.scan.running) return;

        const elapsed = (Date.now() - state.scan.startedAt) / 1000;
        if(elapsed > SCAN.maxSeconds){
          stopScan('หมดเวลา');
          return;
        }

        // step animation
        if(state.scan.step < SCAN.stepsTotal){
          state.scan.step += 1;
          setProgress(dom.scanBar, dom.scanStep, state.scan.step, SCAN.stepsTotal);
        }

        // Capture frame and send to GS for recognition
        try{
          const base64 = await captureFrameAsJpegBase64(dom.cam, 0.78);

          // Use API recognizeFace
          // Expected response example:
          // { ok:true, found:true, name:"...", code:"...", confidence:0.82 }
          const json = await apiCall(ACTIONS.recognizeFace, { imageBase64: base64 });

          const found = !!(json?.found ?? json?.data?.found);
          const name = (json?.name ?? json?.data?.name) || '';
          const code = (json?.code ?? json?.data?.code) || '';
          const conf = Number(json?.confidence ?? json?.data?.confidence ?? 0);

          if(found && name && code && conf >= SCAN.minConfidence){
            state.scan.hits += 1;

            dom.scanResultWrap.style.display = 'block';
            dom.srFound.textContent = 'พบใบหน้า';
            dom.srName.textContent = name;
            dom.srCode.textContent = code;
            dom.srConf.textContent = `${Math.round(conf*100)}%`;

            drawOverlayBox(dom.overlay, `พบ: ${name}`, 'ok');

            if(state.scan.hits >= SCAN.requiredHits && !state.scan.locked){
              state.scan.locked = true;
              state.scan.person = { name, code, confidence: conf, imageBase64: base64 };

              setBadge(dom.scanBadge, dom.scanBadgeText, 'ok', 'ระบุสำเร็จ');
              dom.btnConfirmScan.disabled = false;

              // stop scanning loop (but keep camera on)
              clearInterval(state.scan.timer);
              state.scan.timer = null;
              state.scan.running = false;

              showToast('ok','ระบุสำเร็จ', `${name} (${code})`);
              setLast(`Face recognized: ${name} (${code})`);
            }
          }else{
            // not found
            if(!state.scan.locked){
              drawOverlayBox(dom.overlay, 'กำลังค้นหาใบหน้า…', 'warn');
              dom.scanResultWrap.style.display = 'block';
              dom.srFound.textContent = 'กำลังค้นหา…';
              dom.srName.textContent = '-';
              dom.srCode.textContent = '-';
              dom.srConf.textContent = '-';
            }
          }

        }catch(e){
          if(!state.scan.locked){
            drawOverlayBox(dom.overlay, 'เชื่อมต่อไม่สำเร็จ', 'bad');
            setBadge(dom.scanBadge, dom.scanBadgeText, 'bad', 'เชื่อมต่อไม่สำเร็จ');
          }
        }

      }, SCAN.frameIntervalMs);
    }

    function stopScan(reason='หยุดแล้ว'){
      state.scan.running = false;
      clearInterval(state.scan.timer);
      state.scan.timer = null;

      dom.btnStartScan.disabled = false;
      dom.btnStopScan.disabled = true;

      if(!state.scan.locked){
        dom.btnConfirmScan.disabled = true;
        setBadge(dom.scanBadge, dom.scanBadgeText, 'warn', reason);
        drawOverlayBox(dom.overlay, reason, 'warn');
        showToast('warn','หยุดสแกน', reason);
        setLast(`Scan stopped: ${reason}`);
      }
    }

    async function confirmScanCheckin(){
      if(!state.scan.person?.code){
        showToast('warn','ยังไม่พร้อม','ยังไม่ได้ระบุคน');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      dom.btnConfirmScan.disabled = true;

      // ensure GPS (ถ้าคุณอยากบังคับ ก็เปลี่ยนเป็น if(!gps) return)
      if(!state.gps.lat || !state.gps.lng){
        await getGps();
      }

      try{
        // Send confirm
        // Expected to create log record in GS.
        const payload = {
          code: state.scan.person.code,
          name: state.scan.person.name,
          confidence: state.scan.person.confidence,
          lat: state.gps.lat,
          lng: state.gps.lng,
          accuracy: state.gps.accuracy,
          imageBase64: state.scan.person.imageBase64
        };

        const json = await apiCall(ACTIONS.confirmFaceCheckin, payload);

        showToast('ok','เช็คอินสำเร็จ', `${state.scan.person.name}`);
        setLast(`Checkin OK: ${state.scan.person.code}`);

        // refresh today summary quickly
        refreshTodaySummary().catch(()=>{});

        // reset scan for next
        resetScanUI(true);
      }catch(e){
        showToast('bad','เช็คอินไม่สำเร็จ', e.message || '');
        dom.btnConfirmScan.disabled = false;
        setLast('Checkin failed');
      }
    }

    /**********************************************************************
     * HR FACE REGISTER
     **********************************************************************/
    async function startHrCamera(){
      if(state.hrStream) return;
      if(!navigator.mediaDevices?.getUserMedia){
        showToast('bad','อุปกรณ์ไม่รองรับ','ไม่พบ getUserMedia');
        return;
      }
      try{
        state.hrStream = await startCamera(dom.hrCam, state.hrFacing);
        syncCanvasToVideo(dom.hrOverlay, dom.hrCam);
        dom.hrCamContainer.classList.toggle('mirror', state.hrMirror);

        dom.hrCamPill.className = 'pill ok';
        dom.hrCamPill.textContent = 'กล้อง: พร้อม';

        setBadge(dom.hrBadge, dom.hrBadgeText, '', 'พร้อมบันทึกใบหน้า');
        drawOverlayBox(dom.hrOverlay, 'พร้อมบันทึกใบหน้า', 'warn');
      }catch(e){
        dom.hrCamPill.className = 'pill bad';
        dom.hrCamPill.textContent = 'กล้อง: ไม่พร้อม';
        showToast('bad','เปิดกล้องไม่สำเร็จ', e.message || '');
      }
    }

    function stopHrCamera(){
      stopStream(state.hrStream);
      state.hrStream = null;
      try{
        dom.hrCam.pause?.();
        dom.hrCam.srcObject = null;
      }catch(e){}
      dom.hrCamPill.className = 'pill warn';
      dom.hrCamPill.textContent = 'กล้อง: -';
    }

    function resetHrUI(soft=true){
      state.hr.running = false;
      state.hr.step = 0;
      state.hr.hits = 0;
      state.hr.locked = false;
      state.hr.bestShot = null;

      clearInterval(state.hr.timer);
      state.hr.timer = null;

      dom.btnHrStart.disabled = false;
      dom.btnHrStop.disabled = true;
      dom.btnHrSave.disabled = true;

      setProgress(dom.hrBar, dom.hrStep, 0, SCAN.stepsTotal);

      if(soft){
        setBadge(dom.hrBadge, dom.hrBadgeText, '', 'พร้อมบันทึกใบหน้า');
        if(dom.hrOverlay.width) drawOverlayBox(dom.hrOverlay, 'พร้อมบันทึกใบหน้า', 'warn');
      }
    }

    async function runHrLoop(){
      const code = dom.hrEmpCode.value.trim();
      const name = dom.hrEmpName.value.trim();
      if(!code || !name){
        showToast('warn','กรอกข้อมูลก่อน','กรุณากรอกรหัสและชื่อ');
        return;
      }

      await startHrCamera();
      if(!state.hrStream) return;

      state.hr.running = true;
      state.hr.startedAt = Date.now();
      state.hr.step = 0;
      state.hr.hits = 0;
      state.hr.locked = false;
      state.hr.bestShot = null;

      dom.btnHrStart.disabled = true;
      dom.btnHrStop.disabled = false;
      dom.btnHrSave.disabled = true;

      setBadge(dom.hrBadge, dom.hrBadgeText, 'warn', 'กำลังจับภาพ…');
      setProgress(dom.hrBar, dom.hrStep, 0, SCAN.stepsTotal);
      drawOverlayBox(dom.hrOverlay, 'กำลังจับภาพ…', 'warn');

      state.hr.timer = setInterval(async () => {
        if(!state.hr.running) return;

        const elapsed = (Date.now() - state.hr.startedAt) / 1000;
        if(elapsed > SCAN.maxSeconds){
          stopHr('หมดเวลา');
          return;
        }

        if(state.hr.step < SCAN.stepsTotal){
          state.hr.step += 1;
          setProgress(dom.hrBar, dom.hrStep, state.hr.step, SCAN.stepsTotal);
        }

        try{
          const base64 = await captureFrameAsJpegBase64(dom.hrCam, 0.82);

          // OPTIONAL: ถ้าอยากให้ HR ตรวจว่ามีหน้าในเฟรมด้วย face-api (ไม่บังคับ)
          // ถ้าโมเดลไม่พร้อมจะข้าม
          let hasFace = true;
          if(window.faceapi?.nets?.tinyFaceDetector?.params){
            // simple detect
            const tmp = document.createElement('canvas');
            tmp.width = dom.hrCam.videoWidth; tmp.height = dom.hrCam.videoHeight;
            tmp.getContext('2d').drawImage(dom.hrCam,0,0,tmp.width,tmp.height);
            const det = await faceapi.detectSingleFace(tmp, new faceapi.TinyFaceDetectorOptions({ inputSize: 256, scoreThreshold: 0.5 }));
            hasFace = !!det;
          }

          if(hasFace){
            state.hr.hits += 1;
            state.hr.bestShot = base64;
            drawOverlayBox(dom.hrOverlay, `จับภาพ: ${state.hr.hits}/${SCAN.requiredHits}`, 'ok');

            if(state.hr.hits >= SCAN.requiredHits && !state.hr.locked){
              state.hr.locked = true;
              setBadge(dom.hrBadge, dom.hrBadgeText, 'ok', 'พร้อมบันทึก');
              dom.btnHrSave.disabled = false;

              clearInterval(state.hr.timer);
              state.hr.timer = null;
              state.hr.running = false;

              showToast('ok','พร้อมบันทึกใบหน้า', `${name} (${code})`);
            }
          }else{
            drawOverlayBox(dom.hrOverlay, 'กรุณาหันหน้าเข้ากล้อง', 'warn');
          }
        }catch(e){
          drawOverlayBox(dom.hrOverlay, 'เชื่อมต่อไม่สำเร็จ', 'bad');
          setBadge(dom.hrBadge, dom.hrBadgeText, 'bad', 'เชื่อมต่อไม่สำเร็จ');
        }

      }, SCAN.frameIntervalMs);
    }

    function stopHr(reason='หยุดแล้ว'){
      state.hr.running = false;
      clearInterval(state.hr.timer);
      state.hr.timer = null;

      dom.btnHrStart.disabled = false;
      dom.btnHrStop.disabled = true;

      if(!state.hr.locked){
        dom.btnHrSave.disabled = true;
        setBadge(dom.hrBadge, dom.hrBadgeText, 'warn', reason);
        drawOverlayBox(dom.hrOverlay, reason, 'warn');
        showToast('warn','หยุด', reason);
      }
    }

    async function saveHrFace(){
      const code = dom.hrEmpCode.value.trim();
      const name = dom.hrEmpName.value.trim();
      if(!code || !name){
        showToast('warn','กรอกข้อมูลก่อน','กรุณากรอกรหัสและชื่อ');
        return;
      }
      if(!state.hr.bestShot){
        showToast('warn','ยังไม่พร้อม','ยังไม่มีภาพใบหน้า');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      dom.btnHrSave.disabled = true;

      try{
        const json = await apiCall(ACTIONS.uploadEmployeeFace, {
          code,
          name,
          imageBase64: state.hr.bestShot
        });

        showToast('ok','บันทึกใบหน้าสำเร็จ', `${name} (${code})`);
        setLast(`HR face saved: ${code}`);
        resetHrUI(true);
      }catch(e){
        showToast('bad','บันทึกใบหน้าไม่สำเร็จ', e.message || '');
        dom.btnHrSave.disabled = false;
      }
    }

    /**********************************************************************
     * ADMIN: login + tabs + employees CRUD (if supported)
     **********************************************************************/
    function selectAdminTab(tab){
      const map = {
        faces: dom.adminTabFaces,
        employees: dom.adminTabEmployees,
        reports: dom.adminTabReports
      };
      Object.values(map).forEach(el => el.style.display = 'none');
      map[tab].style.display = 'block';

      // ensure hr camera starts only when faces tab
      if(tab === 'faces'){
        startHrCamera().catch(()=>{});
      }else{
        stopHrCamera();
        resetHrUI(false);
      }
    }

    async function adminLogin(){
      const pass = dom.adminPass.value;
      if(!pass){
        showToast('warn','กรอกรหัสผ่าน','');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      dom.btnAdminLogin.disabled = true;
      try{
        const json = await apiCall(ACTIONS.loginAdmin, { password: pass });
        // if ok
        setAdminLogged(true);
        dom.adminPass.value = '';
        showToast('ok','เข้าสู่ระบบสำเร็จ','');
        selectAdminTab('faces');
      }catch(e){
        showToast('bad','เข้าสู่ระบบไม่สำเร็จ', e.message || '');
      }finally{
        dom.btnAdminLogin.disabled = false;
      }
    }

    function adminLogout(){
      setAdminLogged(false);
      showToast('ok','ออกจากระบบแล้ว','');
      stopHrCamera();
      resetHrUI(false);
    }

    function normalizeEmployee(it){
      return {
        id: it?.id ?? it?.rowId ?? it?.uuid ?? '',
        code: it?.code ?? it?.employeeCode ?? '',
        name: it?.name ?? it?.fullName ?? '',
        branch: it?.branch ?? it?.branchName ?? '',
        level: it?.level ?? it?.levelName ?? '',
        raw: it
      };
    }

    function renderEmployees(list){
      if(!Array.isArray(list) || list.length === 0){
        dom.employeesWrap.innerHTML = `<div class="hint">ไม่พบข้อมูล</div>`;
        return;
      }
      const rows = list.map(emp => `
        <tr>
          <td>
            <b>${escapeHtml(emp.name)}</b>
            <small class="mono">${escapeHtml(emp.code)}</small>
          </td>
          <td>
            ${escapeHtml(emp.branch || '-')}
            <small>${escapeHtml(emp.level || '-')}</small>
          </td>
          <td style="text-align:right;">
            <button class="btn small" data-edit="${escapeHtml(emp.code)}">แก้ไข</button>
          </td>
        </tr>
      `).join('');

      dom.employeesWrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>พนักงาน</th>
              <th>สาขา/ระดับ</th>
              <th style="text-align:right;">จัดการ</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      // bind edit
      $$('button[data-edit]', dom.employeesWrap).forEach(btn => {
        btn.addEventListener('click', () => {
          const code = btn.getAttribute('data-edit');
          const emp = state.employees.find(x => x.code === code);
          openEmpModal('edit', emp);
        });
      });
    }

    async function loadEmployees(){
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }
      dom.employeesWrap.innerHTML = `<div class="skeleton" style="width:55%"></div><div style="height:8px"></div><div class="skeleton" style="width:82%"></div><div style="height:8px"></div><div class="skeleton" style="width:68%"></div>`;

      try{
        const json = await apiCall(ACTIONS.getInitialData, {});
        // expect json.data.employees or json.employees
        const listRaw = json?.data?.employees ?? json?.employees ?? [];
        state.employees = listRaw.map(normalizeEmployee);

        renderEmployees(state.employees);
        showToast('ok','โหลดพนักงานสำเร็จ', `${state.employees.length} รายการ`);
      }catch(e){
        dom.employeesWrap.innerHTML = `<div class="hint">${escapeHtml(e.message || 'เกิดข้อผิดพลาด')}</div>`;
        showToast('bad','โหลดพนักงานไม่สำเร็จ', e.message || '');
      }
    }

    function filterEmployees(){
      const q = dom.empSearch.value.trim().toLowerCase();
      if(!q){
        renderEmployees(state.employees);
        return;
      }
      const list = state.employees.filter(e =>
        (e.code || '').toLowerCase().includes(q) ||
        (e.name || '').toLowerCase().includes(q) ||
        (e.branch || '').toLowerCase().includes(q) ||
        (e.level || '').toLowerCase().includes(q)
      );
      renderEmployees(list);
    }

    async function saveEmployeeFromModal(){
      // NOTE: action names might differ in your GS
      const id = dom.empId.value.trim();
      const code = dom.empCode.value.trim();
      const name = dom.empName.value.trim();
      const branch = dom.empBranch.value.trim();
      const level = dom.empLevel.value.trim();

      if(!code || !name){
        showToast('warn','กรอกไม่ครบ','ต้องมีรหัส + ชื่อ');
        return;
      }
      dom.btnEmpSave.disabled = true;

      try{
        const action = id ? 'updateEmployee' : 'createEmployee';
        const payload = { id, code, name, branch, level };

        const json = await apiCall(action, payload);
        showToast('ok', 'บันทึกสำเร็จ', code);
        closeEmpModal();
        await loadEmployees();
      }catch(e){
        showToast('bad','บันทึกไม่สำเร็จ', e.message || '');
      }finally{
        dom.btnEmpSave.disabled = false;
      }
    }

    async function deleteEmployeeFromModal(){
      const id = dom.empId.value.trim();
      const code = dom.empCode.value.trim();
      if(!id && !code){
        showToast('warn','ไม่พบตัวตน','');
        return;
      }

      dom.btnEmpDelete.disabled = true;
      try{
        const json = await apiCall('deleteEmployee', { id, code });
        showToast('ok','ลบสำเร็จ', code);
        closeEmpModal();
        await loadEmployees();
      }catch(e){
        showToast('bad','ลบไม่สำเร็จ', e.message || '');
      }finally{
        dom.btnEmpDelete.disabled = false;
      }
    }

    async function loadReports(type){
      const from = dom.repFrom.value.trim();
      const to = dom.repTo.value.trim();
      if(!from || !to){
        showToast('warn','กรอกวันที่','กรุณากรอก from/to');
        return;
      }
      if(!state.apiUrl){
        showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
        return;
      }

      dom.reportsWrap.innerHTML = `<div class="skeleton" style="width:62%"></div><div style="height:8px"></div><div class="skeleton" style="width:78%"></div><div style="height:8px"></div><div class="skeleton" style="width:55%"></div>`;

      try{
        const action = type === 'summary' ? ACTIONS.getSummaryRange : ACTIONS.getLogsRange;
        const json = await apiCall(action, { from, to });
        const data = json?.data ?? json;

        // if array -> show table, else show key-values
        if(Array.isArray(data)){
          const rows = data.slice(0,200).map((it) => {
            const a = it?.name ?? it?.fullName ?? '-';
            const b = it?.code ?? it?.employeeCode ?? '-';
            const c = it?.value ?? it?.count ?? it?.status ?? JSON.stringify(it).slice(0,80);
            return `<tr><td><b>${escapeHtml(a)}</b><small class="mono">${escapeHtml(b)}</small></td><td>${escapeHtml(c)}</td></tr>`;
          }).join('');
          dom.reportsWrap.innerHTML = `
            <table>
              <thead><tr><th>พนักงาน</th><th>ข้อมูล</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          `;
        }else{
          const items = Object.keys(data || {}).slice(0,14).map(k => [k, data[k]]);
          dom.reportsWrap.innerHTML = `
            <div class="result">
              <div class="box">
                ${items.map(([k,v]) => `
                  <div class="kv"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(typeof v==='string'? v : JSON.stringify(v))}</div></div>
                `).join('')}
              </div>
            </div>
          `;
        }

        showToast('ok','ดึงรายงานสำเร็จ', type === 'summary' ? 'Summary' : 'Logs');
      }catch(e){
        dom.reportsWrap.innerHTML = `<div class="hint">${escapeHtml(e.message || 'เกิดข้อผิดพลาด')}</div>`;
        showToast('bad','ดึงรายงานไม่สำเร็จ', e.message || '');
      }
    }

    /**********************************************************************
     * INIT
     **********************************************************************/
    async function init(){
      // load stored
      state.apiUrl = localStorage.getItem(LS_API_KEY) || '';
      state.adminLogged = localStorage.getItem(LS_ADMIN_KEY) === '1';

      refreshApiUI();
      setAdminLogged(state.adminLogged);

      // time ticker
      dom.nowText.textContent = fmtNow();
      setInterval(() => dom.nowText.textContent = fmtNow(), 1000);

      // if hash view
      const hv = (location.hash || '').replace('#','').trim();
      if(hv && views[hv]) go(hv);

      // load today summary once
      refreshTodaySummary().catch(()=>{});

      // pre-GPS pill
      setGpsPill();

      // Try load face-api models (optional)
      // If you have /models in GitHub Pages, put them there.
      // Otherwise it will fail silently.
      try{
        if(window.faceapi){
          // Load tiny detector only (light)
          await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
        }
      }catch(e){
        // ignore
      }

      // events
      bindEvents();
    }

    function bindEvents(){
      // toast
      dom.toastX.addEventListener('click', hideToast);

      // drawer
      dom.btnMenu.addEventListener('click', openDrawer);
      dom.btnCloseDrawer.addEventListener('click', closeDrawer);
      dom.drawerBackdrop.addEventListener('click', closeDrawer);

      dom.navBtns.forEach(btn => {
        btn.addEventListener('click', () => go(btn.dataset.go));
      });

      dom.btnMenuApi.addEventListener('click', () => openApiModal());

      // open api
      dom.btnOpenApi.addEventListener('click', openApiModal);
      dom.btnCloseApi.addEventListener('click', closeApiModal);
      dom.apiModal.addEventListener('click', (e) => {
        if(e.target === dom.apiModal) closeApiModal();
      });

      dom.btnApiClear.addEventListener('click', () => {
        dom.apiInput.value = '';
        dom.apiInput.focus();
      });
      dom.btnApiSave.addEventListener('click', () => {
        const url = dom.apiInput.value.trim();
        setApiUrl(url);
        closeApiModal();
        showToast('ok','บันทึกแล้ว', state.apiUrl ? 'API พร้อมใช้งาน' : 'API ถูกล้าง');
        refreshTodaySummary().catch(()=>{});
      });

      // quick nav
      dom.goScan.addEventListener('click', () => go('scan'));
      dom.goManual.addEventListener('click', () => go('manual'));
      dom.goToday.addEventListener('click', () => go('today'));
      dom.goHistory.addEventListener('click', () => go('history'));

      // today summary refresh
      dom.btnRefreshToday.addEventListener('click', () => refreshTodaySummary());
      dom.btnRefreshToday2.addEventListener('click', () => refreshTodaySummary());

      // check today
      dom.btnCheckToday.addEventListener('click', () => checkTodayByCode(dom.empCodeCheck.value, 1));
      dom.btnCheckToday2.addEventListener('click', () => checkTodayByCode(dom.empCodeCheck2.value, 2));

      dom.empCodeCheck.addEventListener('keydown', (e)=>{ if(e.key==='Enter') dom.btnCheckToday.click(); });
      dom.empCodeCheck2.addEventListener('keydown', (e)=>{ if(e.key==='Enter') dom.btnCheckToday2.click(); });

      // manual
      dom.btnBackFromManual.addEventListener('click', () => go('home'));
      dom.btnGetGps.addEventListener('click', getGps);
      dom.btnSaveManual.addEventListener('click', saveManual);
      dom.btnClearManual.addEventListener('click', clearManual);

      // today view
      dom.btnBackFromToday.addEventListener('click', () => go('home'));
      dom.btnFocusCheck.addEventListener('click', () => {
        dom.focusCheckRow.scrollIntoView({ behavior:'smooth', block:'center' });
        setTimeout(() => dom.empCodeCheck2.focus(), 300);
      });

      // history
      dom.btnBackFromHistory.addEventListener('click', () => go('home'));
      dom.btnLoadLogs.addEventListener('click', loadLogsRange);

      // scan view
      dom.btnBackFromScan.addEventListener('click', () => go('home'));

      dom.btnFlipCam.addEventListener('click', async () => {
        state.camFacing = (state.camFacing === 'user') ? 'environment' : 'user';
        stopScanCamera();
        await startScanCamera();
        showToast('ok','สลับกล้องแล้ว', state.camFacing === 'user' ? 'กล้องหน้า' : 'กล้องหลัง');
      });

      dom.btnToggleMirror.addEventListener('click', () => {
        state.camMirror = !state.camMirror;
        dom.camContainer.classList.toggle('mirror', state.camMirror);
        showToast('ok','โหมดกระจก', state.camMirror ? 'เปิด' : 'ปิด');
      });

      dom.btnStartScan.addEventListener('click', async () => {
        if(!state.apiUrl){
          showToast('warn','ยังไม่ได้ตั้งค่า','กรุณาตั้งค่า API ก่อน');
          return;
        }
        await startScanCamera();
        resetScanUI(false);
        await runScanLoop();
      });

      dom.btnStopScan.addEventListener('click', () => stopScan('หยุดโดยผู้ใช้'));
      dom.btnResetScan.addEventListener('click', () => resetScanUI(true));
      dom.btnConfirmScan.addEventListener('click', confirmScanCheckin);

      // admin view
      dom.btnBackFromAdmin.addEventListener('click', () => go('home'));
      dom.btnAdminLogin.addEventListener('click', adminLogin);
      dom.adminPass.addEventListener('keydown', (e)=>{ if(e.key==='Enter') dom.btnAdminLogin.click(); });
      dom.btnAdminLogout.addEventListener('click', adminLogout);

      // admin tabs
      dom.tabFaces.addEventListener('click', () => selectAdminTab('faces'));
      dom.tabEmployees.addEventListener('click', () => selectAdminTab('employees'));
      dom.tabReports.addEventListener('click', () => selectAdminTab('reports'));

      // HR cam
      dom.btnHrFlip.addEventListener('click', async () => {
        state.hrFacing = (state.hrFacing === 'user') ? 'environment' : 'user';
        stopHrCamera();
        await startHrCamera();
        showToast('ok','สลับกล้องแล้ว', state.hrFacing === 'user' ? 'กล้องหน้า' : 'กล้องหลัง');
      });

      dom.btnHrMirror.addEventListener('click', () => {
        state.hrMirror = !state.hrMirror;
        dom.hrCamContainer.classList.toggle('mirror', state.hrMirror);
        showToast('ok','โหมดกระจก', state.hrMirror ? 'เปิด' : 'ปิด');
      });

      dom.btnHrStart.addEventListener('click', runHrLoop);
      dom.btnHrStop.addEventListener('click', () => stopHr('หยุดโดยผู้ใช้'));
      dom.btnHrReset.addEventListener('click', () => resetHrUI(true));
      dom.btnHrSave.addEventListener('click', saveHrFace);

      // employees
      dom.btnLoadEmployees.addEventListener('click', loadEmployees);
      dom.empSearch.addEventListener('input', filterEmployees);
      dom.btnNewEmp.addEventListener('click', () => openEmpModal('new', null));

      // employee modal
      dom.btnEmpModalClose.addEventListener('click', closeEmpModal);
      dom.btnEmpCancel.addEventListener('click', closeEmpModal);
      dom.empModal.addEventListener('click', (e)=>{ if(e.target === dom.empModal) closeEmpModal(); });

      dom.btnEmpSave.addEventListener('click', saveEmployeeFromModal);
      dom.btnEmpDelete.addEventListener('click', deleteEmployeeFromModal);

      // reports
      dom.btnRepSummary.addEventListener('click', () => loadReports('summary'));
      dom.btnRepLogs.addEventListener('click', () => loadReports('logs'));

      // close modals by ESC
      window.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          closeDrawer();
          closeApiModal();
          closeEmpModal();
          hideToast();
        }
      });
    }

    // start
    init().catch(err => {
      console.error(err);
      showToast('bad','โหลดไม่สำเร็จ', err.message || '');
    });

  })();
  </script>
</body>
</html>
