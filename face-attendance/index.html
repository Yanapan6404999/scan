<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äì TEK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏ó‡∏¢ -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- face-api.js ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô browser -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #fbbf24;
      --bg: #f3f4f6;
      --text-main: #0f172a;
      --text-soft: #6b7280;
      --border: #e5e7eb;
      --card-bg: #ffffff;
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Prompt", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #0f172a;
      color: #e5e7eb;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(15, 23, 42, 0.5);
    }

    header .title {
      font-weight: 600;
      font-size: 20px;
    }

    header .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }

    header .right-info {
      text-align: right;
      font-size: 13px;
      color: #9ca3af;
    }

    main {
      flex: 1;
      padding: 18px;
      max-width: 1280px;
      margin: 0 auto;
      width: 100%;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 4fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      header .right-info {
        text-align: left;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--primary-soft);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--primary);
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-soft);
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      color: var(--text-soft);
      white-space: nowrap;
    }

    /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡∏õ‡∏∏‡πà‡∏° */
    .camera-wrapper {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 10px;
    }

    @media (max-width: 900px) {
      .camera-wrapper {
        grid-template-columns: 1fr;
      }
    }

    .video-container {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #020617;
      aspect-ratio: 4 / 3;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #overlayCanvas {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .status-banner {
      position: absolute;
      left: 12px;
      bottom: 12px;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--danger);
    }
    .status-dot.ok {
      background: var(--accent);
    }

    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-group {
      border-radius: 14px;
      border: 1px dashed var(--border);
      padding: 10px 12px;
      background: #f9fafb;
    }

    .control-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .control-desc {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .field-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    label {
      font-size: 12px;
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="password"],
    select {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 10px;
      font-size: 12px;
      font-family: inherit;
      outline: none;
      min-width: 0;
    }

    input:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    button {
      font-family: inherit;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: var(--primary);
      color: white;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.danger {
      background: var(--danger);
      color: #f9fafb;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .small-text {
      font-size: 11px;
      color: var(--text-soft);
    }

    .tag {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: #4b5563;
      align-items: center;
      gap: 4px;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    /* ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ */
    .highlight-box {
      border-radius: 14px;
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }

    .highlight-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 6px;
    }

    .highlight-main {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      color: #4b5563;
    }

    .highlight-text-main {
      font-weight: 600;
      font-size: 14px;
    }

    .highlight-text-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .status-chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .status-chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    .status-chip-dot.bad {
      background: var(--danger);
    }

    .log-message {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ */
    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: #4b5563;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .status-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-badge.normal {
      background: #dcfce7;
      color: #166534;
    }

    .status-badge.absent {
      background: #fee2e2;
      color: #b91c1c;
    }

    .status-badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .chip-small {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    footer {
      text-align: center;
      font-size: 11px;
      color: #9ca3af;
      padding: 8px;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div>
      <div class="title">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äì TEK</div>
      <div class="subtitle">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheet + Google Drive + ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</div>
    </div>
    <div class="right-info">
      <div id="clockText">--:--:--</div>
      <div id="metaText" class="small-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>
  </header>

  <main>
    <div class="layout-grid">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="icon">üì∑</span>
              ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤
            </div>
            <div class="card-subtitle">
              ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤ code ‡πÉ‡∏´‡πâ ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Logs ‡∏ä‡∏µ‡∏ï
            </div>
          </div>
          <div class="pill">
            <span id="modelStatusDot" class="status-dot"></span>
            <span id="modelStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...</span>
          </div>
        </div>

        <div class="camera-wrapper">
          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
          <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlayCanvas"></canvas>
            <div class="status-banner">
              <span id="cameraStatusDot" class="status-dot"></span>
              <span id="cameraStatusText">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
            </div>
          </div>

          <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
          <div class="control-panel">
            <div class="control-group">
              <div class="control-title">1. ‡∏Å‡∏•‡πâ‡∏≠‡∏á & ‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>
              <div class="control-desc">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
              </div>
              <div class="field-row">
                <button id="btnStartCamera">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button id="btnStopCamera" class="secondary">‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
              </div>
              <div class="small-text" id="geoStatusText">GPS: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</div>
            </div>

            <div class="control-group">
              <div class="control-title">2. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HR / Admin)</div>
              <div class="control-desc">
                ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Üí ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤"
              </div>
              <div class="field-row">
                <label for="enrollCode">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input type="text" id="enrollCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" />
              </div>
              <div class="field-row">
                <button id="btnEnrollFace">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                <span class="small-text">
                  ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Drive (EMP_FACE_FOLDER) ‡πÅ‡∏•‡∏∞
                  faceData ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Employees
                </span>
              </div>
              <div class="small-text" id="enrollStatusText"></div>
            </div>

            <div class="control-group">
              <div class="control-title">3. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</div>
              <div class="control-desc">
                ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö ‚Üí ‡∏Å‡∏î "‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤" ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤ code ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
              </div>
              <div class="field-row">
                <button id="btnFaceCheckin">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                <button id="btnRefreshFaceDB" class="secondary">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
              </div>
              <div class="small-text">
                * ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô (faceData ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Employees)
              </div>
              <div class="small-text" id="faceCheckinStatusText"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="icon">üìÖ</span>
              ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            </div>
            <div class="card-subtitle">
              ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Logs ‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (time zone Asia/Bangkok)
            </div>
          </div>
          <button id="btnReloadToday" class="secondary">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>

        <div class="highlight-box">
          <div class="highlight-header">
            <span>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
            <span class="tag">
              <span class="tag-dot"></span>
              Real-time
            </span>
          </div>
          <div class="highlight-main">
            <div class="avatar" id="lastAvatar">?</div>
            <div>
              <div class="highlight-text-main" id="lastName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
              <div class="highlight-text-sub" id="lastDetail">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
              <div style="margin-top: 4px;">
                <span id="lastStatusChip" class="status-chip" style="display:none;">
                  <span id="lastStatusDot" class="status-chip-dot"></span>
                  <span id="lastStatusText">‡∏õ‡∏Å‡∏ï‡∏¥</span>
                </span>
              </div>
              <div class="log-message" id="lastLogMessage"></div>
            </div>
          </div>
        </div>

        <div class="small-text" style="margin-bottom: 6px;">
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï <strong>Logs</strong> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                <th>‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</th>
                <th>‡∏û‡∏±‡∏Å</th>
                <th>‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</th>
                <th>‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody id="todayTableBody">
              <tr>
                <td colspan="9" style="text-align:center; color:#9ca3af;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- canvas ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö capture ‡∏£‡∏π‡∏õ (‡∏ã‡πà‡∏≠‡∏ô) -->
    <canvas id="snapshotCanvas" style="display:none;"></canvas>
  </main>

  <footer>
    HRM Face Attendance &middot; Powered by Google Apps Script + face-api.js
  </footer>
</div>

<script>
  // =========================
  // CONFIG ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
  // =========================

  // TODO: ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)
  const API_URL = "PUT_YOUR_WEB_APP_URL_HERE";

  // ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå models (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö face-api.js)
  // ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏∑‡πà‡∏≠ "models" ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏á index.html ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Ç‡∏≠‡∏á face-api.js ‡πÑ‡∏ß‡πâ
  const MODELS_URL = "./models";

  // threshold ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏¢‡∏¥‡πà‡∏á‡∏ï‡πà‡∏≥‡∏¢‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
  const FACE_MATCH_THRESHOLD = 0.45;

  // =========================
  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏Å
  // =========================

  let videoStream = null;
  let modelsLoaded = false;
  let employees = [];
  let todaySummary = [];
  let faceMatcher = null; // face-api.FaceMatcher
  let geoPosition = null; // { lat, lng }

  const videoEl = document.getElementById("video");
  const overlayCanvas = document.getElementById("overlayCanvas");
  const snapshotCanvas = document.getElementById("snapshotCanvas");

  const cameraStatusDot = document.getElementById("cameraStatusDot");
  const cameraStatusText = document.getElementById("cameraStatusText");
  const modelStatusDot = document.getElementById("modelStatusDot");
  const modelStatusText = document.getElementById("modelStatusText");
  const geoStatusText = document.getElementById("geoStatusText");

  const enrollCodeInput = document.getElementById("enrollCode");
  const enrollStatusText = document.getElementById("enrollStatusText");
  const faceCheckinStatusText = document.getElementById("faceCheckinStatusText");

  const lastAvatar = document.getElementById("lastAvatar");
  const lastName = document.getElementById("lastName");
  const lastDetail = document.getElementById("lastDetail");
  const lastStatusChip = document.getElementById("lastStatusChip");
  const lastStatusDot = document.getElementById("lastStatusDot");
  const lastStatusText = document.getElementById("lastStatusText");
  const lastLogMessage = document.getElementById("lastLogMessage");

  const metaText = document.getElementById("metaText");

  // =========================
  // Helper: ‡πÄ‡∏ß‡∏•‡∏≤ & Clock
  // =========================
  function startClock() {
    const clockText = document.getElementById("clockText");
    function update() {
      const now = new Date();
      clockText.textContent = now.toLocaleTimeString("th-TH", { hour12: false });
    }
    update();
    setInterval(update, 1000);
  }

  // =========================
  // Helper: Fetch API ‚Üí Apps Script
  // =========================
  async function callApi(action, params = {}) {
    const body = new URLSearchParams({ action, ...params });
    const res = await fetch(API_URL, {
      method: "POST",
      body
    });
    if (!res.ok) {
      throw new Error("Network error: " + res.status);
    }
    const json = await res.json();
    if (!json.ok) {
      throw new Error(json.error || "Unknown error from server");
    }
    return json.result;
  }

  // =========================
  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• face-api.js
  // =========================
  async function loadFaceModels() {
    try {
      modelStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (face-api.js)...";
      modelStatusDot.classList.remove("ok");

      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_URL),
        faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
        faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_URL)
      ]);

      modelsLoaded = true;
      modelStatusText.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
      modelStatusDot.classList.add("ok");
    } catch (err) {
      console.error(err);
      modelsLoaded = false;
      modelStatusText.textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
      modelStatusDot.classList.remove("ok");
    }
  }

  // =========================
  // ‡∏Å‡∏•‡πâ‡∏≠‡∏á
  // =========================
  async function startCamera() {
    try {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö getUserMedia");
      }
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
      videoEl.srcObject = videoStream;
      cameraStatusText.textContent = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô";
      cameraStatusDot.classList.add("ok");
    } catch (err) {
      console.error(err);
      cameraStatusText.textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
      cameraStatusDot.classList.remove("ok");
    }
  }

  function stopCamera() {
    if (videoStream) {
      videoStream.getTracks().forEach(t => t.stop());
      videoStream = null;
    }
    videoEl.srcObject = null;
    cameraStatusText.textContent = "‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î";
    cameraStatusDot.classList.remove("ok");
  }

  // capture frame ‚Üí dataURL + ImageData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö face-api
  function captureFrameToCanvas() {
    const width = videoEl.videoWidth || 640;
    const height = videoEl.videoHeight || 480;
    snapshotCanvas.width = width;
    snapshotCanvas.height = height;

    const ctx = snapshotCanvas.getContext("2d");
    ctx.drawImage(videoEl, 0, 0, width, height);

    const dataUrl = snapshotCanvas.toDataURL("image/jpeg", 0.9);
    return { dataUrl, width, height };
  }

  // =========================
  // GPS
  // =========================
  function requestGeoLocation() {
    if (!navigator.geolocation) {
      geoStatusText.textContent = "‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS";
      return;
    }
    geoStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå...";
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        geoPosition = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };
        geoStatusText.textContent = `GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (lat=${geoPosition.lat.toFixed(5)}, lng=${geoPosition.lng.toFixed(5)})`;
      },
      (err) => {
        console.error(err);
        geoStatusText.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ: " + err.message;
      },
      {
        enableHighAccuracy: true,
        timeout: 10000
      }
    );
  }

  async function ensureGeoPosition() {
    if (geoPosition) return geoPosition;
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"));
        return;
      }
      geoStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå...";
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          geoPosition = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          geoStatusText.textContent = `GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (lat=${geoPosition.lat.toFixed(5)}, lng=${geoPosition.lng.toFixed(5)})`;
          resolve(geoPosition);
        },
        (err) => {
          console.error(err);
          geoStatusText.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ: " + err.message;
          reject(err);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000
        }
      );
    });
  }

  // =========================
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Employees + ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
  // =========================
  async function loadInitialData() {
    try {
      metaText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet...";
      const data = await callApi("getInitialData", {});
      employees = data.employees || [];
      todaySummary = data.todaySummary || [];
      metaText.textContent = `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${employees.length} ‡∏Ñ‡∏ô | ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${todaySummary.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

      renderTodayTable();
      buildFaceMatcher();
    } catch (err) {
      console.error(err);
      metaText.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
    }
  }

  async function reloadTodaySummary() {
    try {
      const data = await callApi("getTodaySummary", {});
      todaySummary = data || [];
      renderTodayTable();
      metaText.textContent = `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${employees.length} ‡∏Ñ‡∏ô | ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${todaySummary.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    } catch (err) {
      console.error(err);
      alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
    }
  }

  // =========================
  // Face Matcher ‡∏à‡∏≤‡∏Å faceData
  // =========================
  function buildFaceMatcher() {
    if (!modelsLoaded) {
      console.warn("‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à");
      return;
    }
    const labeledDescriptors = [];

    for (const emp of employees) {
      if (!emp.faceData) continue;
      try {
        const arr = JSON.parse(emp.faceData);
        if (!Array.isArray(arr)) continue;
        const descriptor = new Float32Array(arr);
        const label = String(emp.code || "").trim() || String(emp.id || "");
        const lfd = new faceapi.LabeledFaceDescriptors(label, [descriptor]);
        labeledDescriptors.push(lfd);
      } catch (err) {
        console.warn("faceData parse error for code", emp.code, err);
      }
    }

    if (labeledDescriptors.length === 0) {
      faceMatcher = null;
      faceCheckinStatusText.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (faceData ‡∏ß‡πà‡∏≤‡∏á)";
    } else {
      faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, FACE_MATCH_THRESHOLD);
      faceCheckinStatusText.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${labeledDescriptors.length} ‡∏Ñ‡∏ô (threshold=${FACE_MATCH_THRESHOLD})`;
    }
  }

  // =========================
  // ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (Admin)
  // =========================
  async function handleEnrollFace() {
    try {
      enrollStatusText.textContent = "";
      const code = enrollCodeInput.value.trim();
      if (!code) {
        enrollStatusText.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô";
        return;
      }
      if (!videoStream) {
        enrollStatusText.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
        return;
      }
      if (!modelsLoaded) {
        enrollStatusText.textContent = "‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
        return;
      }

      const emp = employees.find(e => String(e.code) === code);
      if (!emp) {
        enrollStatusText.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ " + code + " ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Employees";
        return;
      }

      enrollStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û...";
      const { dataUrl, width, height } = captureFrameToCanvas();

      const detection = await faceapi
        .detectSingleFace(snapshotCanvas, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) {
        enrollStatusText.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏´‡πâ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠)";
        return;
      }

      // descriptor ‚Üí array (‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á GAS ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á cell)
      const descriptorArray = Array.from(detection.descriptor);
      const faceDataJson = JSON.stringify(descriptorArray);

      enrollStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞ faceData ‡πÑ‡∏õ Google Apps Script...";

      const result = await callApi("uploadEmployeeFace", {
        code,
        photoBase64: dataUrl,
        fileName: "face-" + code + "-" + Date.now() + ".jpg",
        faceData: faceDataJson
      });

      enrollStatusText.textContent = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + result.message;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï employee ‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á browser
      emp.faceData = faceDataJson;
      // rebuild matcher
      buildFaceMatcher();

    } catch (err) {
      console.error(err);
      enrollStatusText.textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
    }
  }

  // =========================
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
  // =========================
  async function handleFaceCheckin() {
    try {
      faceCheckinStatusText.textContent = "";
      lastLogMessage.textContent = "";
      if (!videoStream) {
        faceCheckinStatusText.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠";
        return;
      }
      if (!modelsLoaded) {
        faceCheckinStatusText.textContent = "‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
        return;
      }
      if (!faceMatcher) {
        faceCheckinStatusText.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (faceMatcher = null)";
        return;
      }

      // ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
      const pos = await ensureGeoPosition();

      faceCheckinStatusText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á...";
      const { dataUrl } = captureFrameToCanvas();

      const detection = await faceapi
        .detectSingleFace(snapshotCanvas, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) {
        faceCheckinStatusText.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
        return;
      }

      // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô
      const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
      console.log("face bestMatch:", bestMatch.toString());

      if (bestMatch.label === "unknown") {
        faceCheckinStatusText.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ (unknown)";
        updateLastResult(null, "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á", null, null);
        return;
      }

      const matchedCode = bestMatch.label;
      const emp = employees.find(e => String(e.code) === matchedCode);
      if (!emp) {
        faceCheckinStatusText.textContent = "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô Employees (code=" + matchedCode + ")";
        updateLastResult(null, "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡∏£‡∏´‡∏±‡∏™ " + matchedCode, null, null);
        return;
      }

      faceCheckinStatusText.textContent = "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á " + (emp.fullName || emp.fullname || matchedCode) + " ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤...";

      const result = await callApi("saveManualLog", {
        code: matchedCode,
        lat: pos.lat,
        lng: pos.lng,
        evidenceBase64: dataUrl,
        evidenceName: "log-" + matchedCode + "-" + Date.now() + ".jpg"
      });

      faceCheckinStatusText.textContent = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + result.message;
      updateLastResult(
        emp,
        "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
        `slot: ${result.slot}, ‡πÄ‡∏ß‡∏•‡∏≤: ${result.time}`,
        result.status,
        result.locationZone
      );

      // reload ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      await reloadTodaySummary();

    } catch (err) {
      console.error(err);
      faceCheckinStatusText.textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
      updateLastResult(null, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", err.message, null, null);
    }
  }

  function updateLastResult(emp, title, detail, status, locationZone) {
    if (!emp) {
      lastAvatar.textContent = "?";
      lastName.textContent = title || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
      lastDetail.textContent = detail || "";
      lastStatusChip.style.display = "none";
      lastLogMessage.textContent = "";
      return;
    }

    const name = emp.fullName || emp.fullname || emp.code;
    lastAvatar.textContent = (name && name[0]) ? name[0] : "?";
    lastName.textContent = name;
    lastDetail.textContent = detail || "";

    if (status) {
      lastStatusChip.style.display = "inline-flex";
      lastStatusText.textContent = status;

      const isNormal = status === "‡∏õ‡∏Å‡∏ï‡∏¥";
      lastStatusDot.classList.toggle("bad", !isNormal);
    } else {
      lastStatusChip.style.display = "none";
    }

    if (locationZone) {
      lastLogMessage.textContent = `LocationZone ‡∏à‡∏≤‡∏Å GAS: ${locationZone}`;
    } else {
      lastLogMessage.textContent = "";
    }
  }

  // =========================
  // Render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
  // =========================
  function renderTodayTable() {
    const tbody = document.getElementById("todayTableBody");
    tbody.innerHTML = "";

    if (!todaySummary || todaySummary.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 9;
      td.style.textAlign = "center";
      td.style.color = "#9ca3af";
      td.textContent = "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Logs";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    for (const row of todaySummary) {
      const tr = document.createElement("tr");

      const tdCode = document.createElement("td");
      tdCode.textContent = row.code || "";
      tr.appendChild(tdCode);

      const tdName = document.createElement("td");
      tdName.textContent = row.fullName || "";
      tr.appendChild(tdName);

      const tdBranch = document.createElement("td");
      tdBranch.textContent = row.branch || "";
      tr.appendChild(tdBranch);

      const tdLevel = document.createElement("td");
      tdLevel.textContent = row.level || "";
      tr.appendChild(tdLevel);

      const tdT1 = document.createElement("td");
      tdT1.textContent = row.t1 || "";
      tr.appendChild(tdT1);

      const tdT2 = document.createElement("td");
      tdT2.textContent = row.t2 || "";
      tr.appendChild(tdT2);

      const tdT3 = document.createElement("td");
      tdT3.textContent = row.t3 || "";
      tr.appendChild(tdT3);

      const tdT4 = document.createElement("td");
      tdT4.textContent = row.t4 || "";
      tr.appendChild(tdT4);

      const tdStatus = document.createElement("td");
      const status = row.status || "";
      const badge = document.createElement("span");
      badge.classList.add("status-badge");

      if (!status || status === "‡∏Ç‡∏≤‡∏î") {
        badge.classList.add("absent");
        badge.textContent = status || "‡∏Ç‡∏≤‡∏î";
      } else if (status === "‡∏õ‡∏Å‡∏ï‡∏¥") {
        badge.classList.add("normal");
        badge.textContent = status;
      } else {
        badge.classList.add("warning");
        badge.textContent = status;
      }

      tdStatus.appendChild(badge);
      tr.appendChild(tdStatus);

      tbody.appendChild(tr);
    }
  }

  // =========================
  // Event listeners
  // =========================
  function setupEventListeners() {
    document.getElementById("btnStartCamera").addEventListener("click", () => {
      startCamera();
      requestGeoLocation();
    });

    document.getElementById("btnStopCamera").addEventListener("click", () => {
      stopCamera();
    });

    document.getElementById("btnEnrollFace").addEventListener("click", () => {
      handleEnrollFace();
    });

    document.getElementById("btnFaceCheckin").addEventListener("click", () => {
      handleFaceCheckin();
    });

    document.getElementById("btnReloadToday").addEventListener("click", () => {
      reloadTodaySummary();
    });

    document.getElementById("btnRefreshFaceDB").addEventListener("click", () => {
      buildFaceMatcher();
    });

    // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î overlayCanvas ‡∏ï‡∏≤‡∏° video
    videoEl.addEventListener("loadedmetadata", () => {
      overlayCanvas.width = videoEl.videoWidth;
      overlayCanvas.height = videoEl.videoHeight;
    });
  }

  // =========================
  // Bootstrap
  // =========================
  window.addEventListener("DOMContentLoaded", async () => {
    startClock();
    setupEventListeners();
    await loadFaceModels();
    await loadInitialData();
    requestGeoLocation();
  });
</script>
</body>
</html>
