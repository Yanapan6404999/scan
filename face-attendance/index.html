<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#2563eb;
      --primary-soft:#dbeafe;
      --accent:#22c55e;
      --danger:#ef4444;
      --bg:#eef2ff;
      --bg-soft:#f3f4ff;
      --text-main:#0f172a;
      --text-soft:#6b7280;
      --border:#e5e7eb;
      --card-bg:#ffffff;
      --yellow:#fbbf24;

      /* mobile app sizing */
      --topbar-h: 78px;
      --bottomnav-h: 66px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    *{ box-sizing:border-box; font-family:"Prompt",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    html,body{
      margin:0;
      width:100%;
      max-width:100%;
      overflow-x:hidden;
      background:
        radial-gradient(circle at top left, #e0e7ff 0, transparent 55%),
        radial-gradient(circle at bottom right, #e5f5ff 0, transparent 50%),
        #f3f4f6;
      color:var(--text-main);
    }
    a{ color:var(--primary); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* ---------- APP SHELL (PC default) ---------- */
    .page-shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      padding:8px 0 16px;
      width:100%;
    }
    .app-container{
      width:100%;
      max-width:1120px;
      margin:0 auto;
      max-inline-size:100%;
      padding:0 12px 12px;
    }

    /* ---------- HEADER (PC) ---------- */
    header.app-header{ margin-bottom:12px; }
    .header-card{
      background:linear-gradient(135deg,#020617 0%, #020617 40%, #0b1120 100%);
      color:#e5e7eb;
      border-radius:20px;
      padding:14px 16px;
      box-shadow:0 18px 40px rgba(15,23,42,.4);
      position:relative;
      overflow:hidden;
      width:100%;
      max-width:100%;
    }
    .header-card::after{
      content:"";
      position:absolute;
      right:-80px; top:-80px;
      width:200px; height:200px;
      background:radial-gradient(circle, rgba(59,130,246,0.4), transparent 65%);
      opacity:.9; pointer-events:none;
    }
    .header-main{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      position:relative;
      z-index:1;
      flex-wrap:wrap;
      max-width:100%;
    }
    .header-left{ display:flex; flex-direction:column; gap:4px; max-width:100%; }
    .header-title{ font-size:20px; font-weight:600; }
    .header-sub{ font-size:12px; color:#9ca3af; max-width:100%; }
    .header-sub span.api{
      display:block;
      margin-top:2px;
      color:#e5e7eb;
      word-break:break-all;
      overflow-wrap:anywhere;
      max-width:100%;
    }
    .header-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      flex:0 0 auto;
      max-width:100%;
    }

    .badge-connection{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      background:rgba(15,118,110,.15);
      color:#a5f3fc;
      border:1px solid rgba(34,197,94,.5);
      max-width:100%;
    }
    .badge-connection.offline{
      background:rgba(127,29,29,.4);
      color:#fecaca;
      border-color:rgba(248,113,113,.8);
    }
    .dot{ width:8px;height:8px;border-radius:999px;background:#22c55e; box-shadow:0 0 8px rgba(34,197,94,.85); }
    .badge-connection.offline .dot{ background:#f97373; box-shadow:0 0 8px rgba(248,113,113,.8); }

    .header-actions{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }

    /* BUTTONS */
    button,.btn{
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      padding:10px 16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:transform .08s ease, box-shadow .08s ease, background .1s ease, opacity .1s ease;
      white-space:nowrap;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    button:disabled,.btn:disabled{ opacity:.7; cursor:default; box-shadow:none; transform:none; }
    button:active:not(:disabled),.btn:active:not(:disabled){ transform:translateY(1px) scale(.99); box-shadow:none; }

    .btn-primary{ background:#3b82f6;color:#fff; box-shadow:0 12px 30px rgba(37,99,235,.55); }
    .btn-outline{ background:transparent;color:#e5e7eb; border:1px solid rgba(148,163,184,.9); }
    .btn-danger-outline{ background:transparent;color:#fecaca; border:1px solid rgba(248,113,113,.8); }
    .btn-success{ background:#22c55e;color:#fff; box-shadow:0 12px 30px rgba(34,197,94,.45); }
    .btn-secondary{ background:#fff;color:#111827; border:1px solid var(--border); }
    .btn-warning{ background:#f59e0b;color:#111827; box-shadow:0 12px 30px rgba(245,158,11,.35); }

    .btn-icon{
      width:40px; height:40px;
      padding:0;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.35);
    }

    /* MAIN */
    main.main{ width:100%; margin-top:8px; }

    .layout{
      display:grid;
      grid-template-columns:minmax(0,7fr) minmax(260px,4fr);
      gap:16px;
      align-items:flex-start;
      max-width:100%;
    }
    @media (max-width:960px){ .layout{ grid-template-columns:1fr; } }

    /* CARD */
    .card{
      background:var(--card-bg);
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow:0 16px 40px rgba(15,23,42,.06), 0 0 0 1px rgba(15,23,42,.02);
      border:1px solid rgba(226,232,240,.9);
      width:100%;
      max-width:100%;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      gap:8px;
      flex-wrap:wrap;
    }
    .card-title{ font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px; }
    .card-title span.icon{
      width:24px;height:24px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      font-size:13px;background:var(--primary-soft);color:var(--primary);
    }
    .card-subtitle{ font-size:12px;color:var(--text-soft); }

    /* CAMERA */
    .camera-card{ margin-bottom:14px; }
    .camera-box{
      border-radius:16px;
      border:1px dashed #cbd5f5;
      background:radial-gradient(circle at top left, #eff6ff, #e5e7eb);
      height:320px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      width:100%;
      max-width:100%;
    }
    .camera-placeholder{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      color:#6b7280; text-align:center; padding:12px;
    }
    .camera-placeholder .icon{
      width:60px;height:60px;border-radius:999px;
      border:2px solid #9ca3af;
      display:flex;align-items:center;justify-content:center;
      font-size:26px;
      background:rgba(255,255,255,.7);
    }

    .cam-video{
      width:100%; height:100%;
      object-fit:cover;
      display:none;
      transform:scaleX(-1);
    }
    .cam-overlay{
      position:absolute; inset:0;
      pointer-events:none;
      display:none;
      transform:scaleX(-1);
    }

    .scan-hud{
      position:absolute;
      left:12px; top:12px; right:12px;
      display:none;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .scan-pill{
      pointer-events:none;
      background:rgba(255,255,255,.85);
      border:1px solid rgba(226,232,240,.9);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:#111827;
      box-shadow:0 10px 25px rgba(15,23,42,.08);
      max-width:100%;
    }
    .scan-pill strong{ color:#0f172a; }

    .camera-footer{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    select{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      outline:none;
      font-size:13px;
      background:white;
      min-width:220px;
      max-width:100%;
    }
    select:focus{ border-color:var(--primary); box-shadow:0 0 0 1px rgba(37,99,235,.3); }

    .pill{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      background:#f9fafb;
      color:#6b7280;
      border:1px solid rgba(226,232,240,.8);
    }
    .pill strong{ color:#111827; }

    /* TABLES */
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead{ background:#f3f4f6; }
    th,td{ padding:7px 8px; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap; }
    th{ font-weight:500; color:#374151; font-size:12px; }
    tbody tr:nth-child(even){ background:#f9fafb; }
    .text-right{text-align:right;}
    .text-center{text-align:center;}
    .scroll-x{ overflow-x:auto; max-width:100%; }
    .scroll-x::-webkit-scrollbar{ height:6px; }
    .scroll-x::-webkit-scrollbar-thumb{ background:#d1d5db; border-radius:999px; }

    /* STATUS */
    .badge-status{ font-size:11px; padding:3px 9px; border-radius:999px; display:inline-block; }
    .badge-normal{ background:#dcfce7; color:#166534; }
    .badge-late{ background:#fee2e2; color:#b91c1c; }
    .badge-absent{ background:#ffe4e6; color:#be123c; }
    .badge-other{ background:#fef3c7; color:#92400e; }

    /* LATEST */
    .latest-box{ font-size:13px; }
    .latest-label{ color:var(--text-soft); font-size:12px; margin-bottom:4px; }
    .latest-content{ padding:9px 10px; border-radius:12px; background:#f9fafb; border:1px dashed #e5e7eb; }
    .latest-row{ display:flex; gap:8px; font-size:13px; flex-wrap:wrap; }
    .latest-row span.label{ min-width:74px; color:#6b7280; }

    .text-muted{ color:#9ca3af; }
    .text-sm{ font-size:12px; }
    .mt-8{ margin-top:8px; }
    .mt-10{ margin-top:10px; }
    .mt-12{ margin-top:12px; }
    .flex{ display:flex; }
    .gap-6{ gap:6px; }
    ul.helper-list{ font-size:12px; color:#4b5563; margin-top:8px; padding-left:18px; }

    /* MODALS */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:10px;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      max-width:440px;
      width:100%;
      background:white;
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,.35);
      padding:18px 18px 16px;
      animation:pop .16s ease-out;
    }
    .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:8px; }
    .modal-title{ font-size:16px; font-weight:600; }
    .modal-close{
      background:transparent;
      border-radius:999px;
      width:34px; height:34px;
      border:none;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      font-size:22px;
      color:#4b5563;
      transition:background .1s ease, transform .08s ease;
    }
    .modal-close:hover{ background:#e5e7eb; transform:scale(1.02); }

    .form-group{ margin-bottom:10px; }
    .form-label{ font-size:13px; margin-bottom:3px; color:#374151; }
    .input, textarea{
      width:100%;
      border-radius:10px;
      border:1px solid #d1d5db;
      padding:9px 10px;
      font-size:13px;
      outline:none;
      resize:vertical;
      min-height:36px;
    }
    .input:focus, textarea:focus{ border-color:var(--primary); box-shadow:0 0 0 1px rgba(37,99,235,.3); }
    textarea{ min-height:70px; }
    .helper{ font-size:11px; color:#6b7280; }
    .modal-actions{ margin-top:12px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
    .error-text{ font-size:12px; color:var(--danger); margin-top:4px; }
    .success-text{ font-size:12px; color:#16a34a; margin-top:4px; }

    .mini-note{
      font-size:12px;
      color:#6b7280;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      padding:10px 12px;
      border-radius:12px;
    }

    @keyframes pop{
      from{ transform:translateY(8px) scale(.97); opacity:0; }
      to{ transform:translateY(0) scale(1); opacity:1; }
    }

    /* ---------- MOBILE APP MODE ---------- */
    .mobile-only{ display:none; }
    .desktop-only{ display:block; }

    .mobile-tabs, .bottom-nav, .action-sheet-backdrop{ display:none; }

    /* today cards (mobile) */
    .today-cards{ display:none; gap:10px; flex-direction:column; }
    .today-card{
      border:1px solid rgba(226,232,240,.9);
      border-radius:16px;
      padding:12px;
      background:#fff;
      box-shadow:0 10px 24px rgba(15,23,42,.05);
    }
    .today-card .top{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;
    }
    .today-card .name{ font-weight:600; }
    .today-card .meta{ font-size:12px; color:#6b7280; }
    .today-card .grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      font-size:12px;
      color:#111827;
    }
    .today-card .cell{
      background:#f9fafb;
      border:1px dashed #e5e7eb;
      border-radius:12px;
      padding:8px 10px;
    }
    .today-card .cell .k{ color:#6b7280; font-size:11px; }
    .today-card .cell .v{ font-weight:600; margin-top:2px; }

    /* Action Sheet (mobile) */
    .action-sheet-backdrop{
      position:fixed; inset:0;
      background:rgba(15,23,42,.35);
      display:none;
      z-index:60;
      align-items:flex-end;
      justify-content:center;
      padding:10px 10px calc(10px + var(--safe-bottom));
    }
    .action-sheet-backdrop.show{ display:flex; }
    .action-sheet{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow:0 22px 50px rgba(15,23,42,.35);
      overflow:hidden;
    }
    .action-sheet .sheet-head{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid #eef2f7;
    }
    .action-sheet .sheet-title{ font-weight:600; }
    .action-sheet .sheet-body{
      padding:12px 14px 14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .action-sheet .sheet-body .btn{
      width:100%;
      border-radius:14px;
      padding:12px 14px;
      justify-content:center;
    }

    /* Bottom nav + tabs (mobile) */
    .bottom-nav{
      position:fixed;
      left:0; right:0; bottom:0;
      height:calc(var(--bottomnav-h) + var(--safe-bottom));
      padding:10px 12px calc(10px + var(--safe-bottom));
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(226,232,240,.9);
      display:none;
      z-index:55;
    }
    .bottom-nav .nav{
      max-width:720px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    .nav-btn{
      border-radius:16px;
      padding:10px 8px;
      border:1px solid rgba(226,232,240,.9);
      background:#fff;
      font-size:12px;
      display:flex; flex-direction:column; align-items:center; gap:2px;
      color:#111827;
      box-shadow:0 10px 22px rgba(15,23,42,.06);
    }
    .nav-btn.active{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 14px 28px rgba(37,99,235,.18);
    }
    .nav-btn .ico{ font-size:16px; }

    /* Mobile layout overrides */
    @media (max-width: 640px){
      .desktop-only{ display:none; }
      .mobile-only{ display:block; }

      .page-shell{ padding:0; }
      .app-container{ padding:0 0 calc(var(--bottomnav-h) + var(--safe-bottom)); }

      header.app-header{
        position:sticky;
        top:0;
        z-index:54;
        margin-bottom:0;
      }
      .header-card{
        border-radius:0;
        padding:10px 12px;
        box-shadow:0 12px 30px rgba(15,23,42,.35);
      }
      .header-main{
        flex-direction:row;
        align-items:center;
        justify-content:space-between;
        gap:10px;
      }
      .header-title{ font-size:16px; }
      .header-sub{
        font-size:11px;
        line-height:1.2;
      }
      /* ‚úÖ URL ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏ï‡∏±‡∏î ... ‡πÑ‡∏°‡πà‡∏î‡∏±‡∏ô‡∏ö‡∏≤‡∏£‡πå‡∏™‡∏π‡∏á */
      .header-sub span.api{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        max-width:min(90vw, 420px);
        word-break:normal;
      }

      .header-right{ align-items:flex-end; gap:6px; }
      .header-actions{ display:none; } /* ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡∏¢‡∏≤‡∏ß ‡πÜ ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
      .badge-connection{ font-size:10px; padding:4px 8px; }

      /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å‚Äù */
      .card{
        border-radius:16px;
        margin:10px 10px 0;
      }
      .camera-card.card{
        padding:12px;
      }
      .camera-box{
        height:calc(100vh - 150px - var(--bottomnav-h) - var(--safe-bottom));
        min-height:360px;
        border-radius:18px;
      }

      /* ‡∏Ñ‡∏∏‡∏° footer ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ö‡∏±‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á */
      .camera-footer{
        margin-top:10px;
        display:flex;
        flex-direction:column;
        align-items:stretch;
        gap:10px;
      }
      .camera-footer .pill{
        border-radius:14px;
        width:100%;
        white-space:normal;
      }
      select{ width:100%; min-width:0; }

      /* ‡∏ó‡∏≥‡∏ä‡∏∏‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
      .camera-footer .flex{
        width:100%;
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:10px;
      }
      #btnStartScan{ grid-column:1 / 2; }
      #btnStopScan{ grid-column:2 / 3; }
      #btnScanSubmit{ grid-column:1 / 3; }

      /* ‚úÖ ‡πÅ‡∏ó‡πá‡∏ö: ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á */
      .tab-panel{ display:none; }
      .tab-panel.active{ display:block; }

      .bottom-nav{ display:block; }

      /* today: ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î */
      .today-table{ display:none; }
      .today-cards{ display:flex; }

      /* ‡∏•‡∏î mini-note ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
      .mini-note{ border-radius:16px; }
    }
  </style>
</head>

<body>
<div class="page-shell">
  <div class="app-container">

    <!-- HEADER -->
    <header class="app-header">
      <div class="header-card">
        <div class="header-main">
          <div class="header-left">
            <div class="header-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
            <div class="header-sub">
              ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ 4 ‡∏ä‡πà‡∏ß‡∏á + ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤)
              <span class="api" id="apiUrlDisplay">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</span>
            </div>
          </div>

          <div class="header-right">
            <div style="display:flex; align-items:center; gap:8px;">
              <div id="connectionBadge" class="badge-connection offline">
                <span class="dot"></span>
                <span id="connectionText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
              </div>

              <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ -->
              <button class="btn btn-icon mobile-only" id="btnOpenActionSheet" title="‡πÄ‡∏°‡∏ô‡∏π">‚ò∞</button>
            </div>

            <!-- PC toolbar ‡πÄ‡∏î‡∏¥‡∏° (‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ) -->
            <div class="header-actions desktop-only" id="actionDock">
              <button class="btn btn-outline" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
              <button class="btn btn-danger-outline" id="btnResetUrl">Reset URL</button>
              <button class="btn btn-warning" id="btnEnrollFace">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (HR)</button>
              <button class="btn btn-primary" id="btnGoAdmin">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà / HR</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="main">
      <!-- ‚úÖ ‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ó‡πá‡∏ö -->
      <section id="tabScan" class="tab-panel active">
        <div class="card camera-card">
          <div class="card-header">
            <div>
              <div class="card-title"><span class="icon">üì∑</span><span>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span></div>
              <div class="card-subtitle" id="faceStatusLine">
                ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL + ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡πÇ‡∏´‡∏•‡∏î models ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              </div>
            </div>

            <div class="flex gap-6" style="flex-wrap:wrap;">
              <button class="btn btn-success" id="btnOpenManualModal">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</button>
              <button class="btn btn-secondary" id="btnOpenCheckToday">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            </div>
          </div>

          <div class="camera-box">
            <video id="camVideo" class="cam-video" autoplay muted playsinline></video>
            <canvas id="camOverlay" class="cam-overlay"></canvas>

            <div id="scanHud" class="scan-hud">
              <div class="scan-pill" id="scanPillLeft"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
              <div class="scan-pill" id="scanPillRight"><strong>‡∏û‡∏ö:</strong> -</div>
            </div>

            <div id="cameraPlaceholder" class="camera-placeholder">
              <div class="icon">üì∏</div>
              <div>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div>
              <div class="text-muted text-sm">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
            </div>
          </div>

          <div class="camera-footer">
            <div class="flex gap-6" style="align-items:center; flex-wrap:wrap; width:100%;">
              <select id="cameraSelect">
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</option>
              </select>

              <button class="btn btn-primary" id="btnStartScan">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
              <button class="btn btn-secondary" id="btnStopScan" disabled>‡∏´‡∏¢‡∏∏‡∏î</button>
              <button class="btn btn-success" id="btnScanSubmit" disabled>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</button>
            </div>

            <div class="pill">
              ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ß‡∏•‡∏≤: <strong>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô 08:00</strong> | ‡∏û‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô <strong>1 ‡∏ä‡∏°.</strong> | ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á <strong>17:00</strong>
            </div>
          </div>

          <div class="mt-10 mini-note">
            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Å‡∏î <strong>‚Äú‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (HR)‚Äù</strong> ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å
          </div>
        </div>
      </section>

      <section id="tabToday" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title"><span class="icon">üìä</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="card-subtitle">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á 4 ‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
            <button class="btn btn-secondary" id="btnRefreshToday">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>

          <!-- PC: table -->
          <div class="scroll-x today-table">
            <table>
              <thead>
              <tr>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</th>
                <th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th>
                <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th>
                <th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
              </thead>
              <tbody id="todaySummaryBody">
              <tr>
                <td colspan="9" class="text-center text-muted" style="padding:12px 8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td>
              </tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile: cards -->
          <div id="todayCards" class="today-cards">
            <!-- render by JS -->
          </div>

          <div class="mt-8 text-sm text-muted">
            * ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï <strong>Logs</strong> ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏Å‡∏î "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
          </div>
        </div>
      </section>

      <section id="tabLatest" class="tab-panel">
        <div class="card">
          <div class="card-header">
            <div class="card-title"><span class="icon">‚è±</span>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          </div>

          <div id="latestBox" class="latest-box">
            <div class="latest-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</div>
            <div class="latest-content" id="latestContent">
              <div class="text-muted text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</div>
            </div>
          </div>
        </div>
      </section>

      <section id="tabHelp" class="tab-panel">
        <div class="card">
          <div class="card-title"><span class="icon">üí°</span>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ</div>
          <ul class="helper-list">
            <li>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</li>
            <li>‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‚Äù ‚Üí ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ‚Üí ‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‚Äù</li>
            <li>‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: HR ‡∏ï‡πâ‡∏≠‡∏á ‚Äú‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô</li>
            <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏°‡∏µ GPS + ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô)</li>
          </ul>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-title"><span class="icon">üß©</span>‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô</div>
          <ul class="helper-list">
            <li>‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô <strong>HTTPS</strong> (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</li>
            <li>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Location)</li>
            <li>‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <strong>models/</strong> ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ</li>
          </ul>
        </div>
      </section>

      <!-- PC layout ‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏¢‡∏±‡∏á OK) -->
      <div class="layout desktop-only" style="margin-top:12px;">
        <!-- ‡∏ã‡πâ‡∏≤‡∏¢ -->
        <div>
          <!-- ‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
          <div class="card camera-card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üì∑</span><span>‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span></div>
                <div class="card-subtitle" id="faceStatusLine_pc_copy" style="display:none;"></div>
              </div>

              <div class="flex gap-6" style="flex-wrap:wrap;">
                <button class="btn btn-success" id="btnOpenManualModal_pc_copy" style="display:none;"></button>
              </div>
            </div>

            <div class="camera-box">
              <!-- reuse same ids already, so on PC we actually use tabScan -->
              <div class="camera-placeholder">
                <div class="icon">‚úÖ</div>
                <div>‡πÇ‡∏´‡∏°‡∏î PC ‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡∏™‡πÅ‡∏Å‡∏ô‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
                <div class="text-muted text-sm">‡πÄ‡∏£‡∏≤‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏õ‡∏£‡∏±‡∏ö UX ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠ ‚úÖ</div>
              </div>
            </div>
          </div>

          <!-- today (PC ‡∏î‡∏π‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö today ‡πÑ‡∏î‡πâ) -->
          <div class="card">
            <div class="card-title"><span class="icon">‚ÑπÔ∏è</span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
            <div class="card-subtitle">‡∏ö‡∏ô PC ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á/‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏≠‡∏õ)</div>
          </div>
        </div>

        <!-- ‡∏Ç‡∏ß‡∏≤ -->
        <div>
          <div class="card">
            <div class="card-title"><span class="icon">üìå</span>Tips</div>
            <ul class="helper-list">
              <li>‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ PC ‡πÄ‡∏õ‡πá‡∏ô layout 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏ï‡πá‡∏° ‡πÜ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ú‡∏°‡∏à‡∏±‡∏î‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ</li>
              <li>‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå: ‡∏ó‡∏≥‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚Äú‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∞‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ö‡∏±‡∏á‚Äù ‡∏Å‡πà‡∏≠‡∏ô</li>
            </ul>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- datalist -->
<datalist id="empDatalist"></datalist>

<!-- ACTION SHEET (mobile menu) -->
<div class="action-sheet-backdrop" id="actionSheet">
  <div class="action-sheet">
    <div class="sheet-head">
      <div class="sheet-title">‡πÄ‡∏°‡∏ô‡∏π</div>
      <button class="btn btn-secondary" id="btnCloseActionSheet" style="border-radius:12px; padding:8px 12px;">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="sheet-body" id="actionSheetMount">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å ‚Äú‡∏¢‡πâ‡∏≤‡∏¢‚Äù ‡∏°‡∏≤‡∏à‡∏≤‡∏Å #actionDock ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î action sheet -->
    </div>
  </div>
</div>

<!-- MODAL: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL -->
<div class="modal-backdrop" id="modalUrl">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö</div>
      <button class="modal-close" data-close-modal="modalUrl">&times;</button>
    </div>
    <div class="form-group">
      <div class="form-label">URL ‡∏à‡∏≤‡∏Å Apps Script Web App</div>
      <input type="text" id="inputApiUrl" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/XXXXX/exec" />
      <div class="helper">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏à‡∏≤‡∏Å <strong>Deploy &gt; Web app</strong> ‡πÉ‡∏ô Apps Script ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏á‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
    </div>
    <div id="urlError" class="error-text" style="display:none;"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" data-close-modal="modalUrl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠ -->
<div class="modal-backdrop" id="modalManual">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</div>
      <button class="modal-close" data-close-modal="modalManual">&times;</button>
    </div>

    <div class="form-group">
      <div class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
      <input type="text" id="manualCode" class="input" list="empDatalist" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" />
      <div id="manualEmpInfo" class="helper">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• / ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>
    </div>

    <div class="form-group">
      <div class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</div>
      <select id="manualType" class="input">
        <option value="AUTO">‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</option>
        <option value="MORNING_IN">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</option>
        <option value="NOON_OUT">‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</option>
        <option value="NOON_IN">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</option>
        <option value="EVENING_OUT">‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</option>
        <option value="EXTRA">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ / ‡∏û‡∏¥‡πÄ‡∏®‡∏©</option>
      </select>
      <div class="helper">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ä‡πà‡∏≠‡∏á t1‚Äìt4, tExtra1‚ÄìtExtra2 ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏â‡∏¢ ‡πÜ</div>
    </div>

    <div class="form-group">
      <div class="form-label">‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠, ‡∏£‡∏π‡∏õ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ß‡∏á‡∏à‡∏£‡∏õ‡∏¥‡∏î ‡∏Ø‡∏•‡∏Ø)</div>
      <input type="file" id="manualFile" accept="image/*" />
      <div class="helper">‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ</div>
    </div>

    <div class="form-group">
      <div class="form-label">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <textarea id="manualResult" readonly placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
    </div>

    <div id="manualError" class="error-text" style="display:none;"></div>
    <div id="manualSuccess" class="success-text" style="display:none;"></div>

    <div class="modal-actions">
      <button class="btn btn-secondary" data-close-modal="modalManual">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" id="btnManualSubmit">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ -->
<div class="modal-backdrop" id="modalCheckToday">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
      <button class="modal-close" data-close-modal="modalCheckToday">&times;</button>
    </div>
    <div class="form-group">
      <div class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
      <input type="text" id="checkCode" class="input" list="empDatalist" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" />
    </div>
    <div class="form-group">
      <div class="form-label">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
      <textarea id="checkResult" readonly placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á 4 ‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"></textarea>
    </div>
    <div id="checkError" class="error-text" style="display:none;"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" data-close-modal="modalCheckToday">‡∏õ‡∏¥‡∏î</button>
      <button class="btn btn-primary" id="btnCheckTodaySubmit">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
    </div>
  </div>
</div>

<!-- MODAL: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (HR) -->
<div class="modal-backdrop" id="modalEnroll">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (HR)</div>
      <button class="modal-close" data-close-modal="modalEnroll">&times;</button>
    </div>

    <div id="enrollStepLogin">
      <div class="form-group">
        <div class="form-label">Username</div>
        <input type="text" id="enrollUser" class="input" placeholder="admin" />
      </div>
      <div class="form-group">
        <div class="form-label">Password</div>
        <input type="password" id="enrollPass" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div id="enrollLoginError" class="error-text" style="display:none;"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" data-close-modal="modalEnroll">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="btn btn-primary" id="btnEnrollLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <div class="mt-10 mini-note">
        * UI ‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö token ‡∏Å‡∏±‡∏ö action ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
      </div>
    </div>

    <div id="enrollStepDo" style="display:none;">
      <div class="form-group">
        <div class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (code)</div>
        <input type="text" id="enrollCode" class="input" list="empDatalist" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" />
        <div class="helper">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏ï‡∏£‡∏á ‡πÜ‚Äù ‡πÅ‡∏™‡∏á‡∏û‡∏≠‡∏î‡∏µ</div>
      </div>

      <div class="form-group">
        <div class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÇ‡∏°‡πÄ‡∏î‡∏•</div>
        <div class="mini-note" id="enrollInfo">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
      </div>

      <div id="enrollDoError" class="error-text" style="display:none;"></div>
      <div id="enrollDoSuccess" class="success-text" style="display:none;"></div>

      <div class="modal-actions">
        <button class="btn btn-secondary" data-close-modal="modalEnroll">‡∏õ‡∏¥‡∏î</button>
        <button class="btn btn-secondary" id="btnEnrollStartCam">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        <button class="btn btn-success" id="btnEnrollCapture">‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
  /**************************************************
   * CONFIG
   **************************************************/
  const STORAGE_KEY = 'attendance_api_url_v2';
  const MODEL_URL = './models';

  const FACE_MATCH_THRESHOLD = 0.55;
  const STABLE_MATCH_COUNT = 3;

  const SNAP_MAX_W = 640;
  const SNAP_JPEG_QUALITY = 0.72;
  const API_TIMEOUT_MS = 15000;

  /**************************************************
   * STORAGE
   **************************************************/
  function getApiUrl() { return localStorage.getItem(STORAGE_KEY) || ''; }
  function setApiUrl(url) { if (url) localStorage.setItem(STORAGE_KEY, url); else localStorage.removeItem(STORAGE_KEY); }

  /**************************************************
   * API HELPER
   **************************************************/
  const api = {
    async call(action, params = {}) {
      const apiUrl = getApiUrl();
      if (!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');

      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), API_TIMEOUT_MS);

      try {
        const body = new URLSearchParams({ action, ...params }).toString();
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body,
          signal: controller.signal
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); }
        catch (e) {
          console.error('API response is not JSON:', text);
          throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏ß exec ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)');
        }
        if (!data.ok) throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
        return data.result;
      } catch (e) {
        if (e.name === 'AbortError') throw new Error('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (timeout) ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
        throw e;
      } finally {
        clearTimeout(t);
      }
    }
  };

  /**************************************************
   * STATE
   **************************************************/
  let employeesCache = [];
  let faceReady = false;
  let modelsLoaded = false;

  let camStream = null;
  let scanning = false;

  let lastBest = { code: '', fullName: '', distance: 999 };
  let stableHit = 0;
  let lockedMatch = null;

  let enrollAuthed = false;

  /**************************************************
   * DOM UTILS
   **************************************************/
  function $(id) { return document.getElementById(id); }
  function showModal(id) { const el = $(id); if (el) el.classList.add('show'); }
  function hideModal(id) { const el = $(id); if (el) el.classList.remove('show'); }

  function setConnectionStatus(online, msg) {
    const badge = $('connectionBadge');
    const text  = $('connectionText');
    if (!badge || !text) return;
    if (online) { badge.classList.remove('offline'); text.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
    else { badge.classList.add('offline'); text.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'; }
  }

  function statusBadgeHtml(status) {
    if (!status) return '<span class="badge-status badge-absent">‡∏Ç‡∏≤‡∏î</span>';
    let cls = 'badge-other';
    if (status === '‡∏õ‡∏Å‡∏ï‡∏¥') cls = 'badge-normal';
    else if (String(status).includes('‡∏™‡∏≤‡∏¢')) cls = 'badge-late';
    else if (status === '‡∏Ç‡∏≤‡∏î') cls = 'badge-absent';
    return '<span class="badge-status ' + cls + '">' + status + '</span>';
  }

  /**************************************************
   * MOBILE TABS + ACTION SHEET
   **************************************************/
  function setActiveTab(tabId){
    ['tabScan','tabToday','tabLatest','tabHelp'].forEach(id=>{
      const el = $(id);
      if (!el) return;
      el.classList.toggle('active', id===tabId);
    });
    document.querySelectorAll('.nav-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.tab === tabId);
    });

    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏™‡πÅ‡∏Å‡∏ô -> ‡∏î‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡∏™‡πÅ‡∏Å‡∏ô ‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏Ñ ‚Äú‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‚Äù
    if (tabId !== 'tabScan') {
      try { stopScanLoop(); } catch(e){}
      try { stopCamera(); } catch(e){}
    }
  }

  let actionDockHome = null;
  function openActionSheet(){
    const dock = $('actionDock');
    const mount = $('actionSheetMount');
    if (!dock || !mount) return;

    if (!actionDockHome) actionDockHome = dock.parentElement;

    // ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ action sheet (IDs ‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)
    mount.appendChild(dock);
    $('actionSheet').classList.add('show');
  }
  function closeActionSheet(){
    const dock = $('actionDock');
    if (!dock || !actionDockHome) return;

    // ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ header
    actionDockHome.appendChild(dock);
    $('actionSheet').classList.remove('show');
  }

  /**************************************************
   * FILE ‚Üí BASE64
   **************************************************/
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(reader.error || new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      reader.readAsDataURL(file);
    });
  }

  /**************************************************
   * GPS
   **************************************************/
  function getCurrentPositionPromise(options = {}) {
    return new Promise((resolve, reject) => {
      if (!('geolocation' in navigator)) {
        reject(new Error('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (GPS) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ Chrome / Edge'));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => resolve(pos),
        err => {
          let msg = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡πÑ‡∏î‡πâ';
          if (err.code === err.PERMISSION_DENIED) msg = '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Location ‡πÅ‡∏•‡∏∞‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå';
          else if (err.code === err.POSITION_UNAVAILABLE) msg = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£';
          else if (err.code === err.TIMEOUT) msg = '‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
          reject(new Error(msg));
        },
        options
      );
    });
  }

  /**************************************************
   * FACE: LOAD MODELS
   **************************************************/
  async function ensureModelsLoaded() {
    if (modelsLoaded) return true;
    const line = $('faceStatusLine');
    if (line) line.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (models)...';

    try {
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
      modelsLoaded = true;
      faceReady = true;
      if (line) line.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ';
      return true;
    } catch (err) {
      console.error(err);
      if (line) line.textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå models/ ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https';
      faceReady = false;
      return false;
    }
  }

  /**************************************************
   * CAMERA
   **************************************************/
  async function listCameras() {
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === 'videoinput');
      const sel = $('cameraSelect');
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = cams.length ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤)' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á';
      sel.appendChild(opt0);

      cams.forEach((c, idx) => {
        const opt = document.createElement('option');
        opt.value = c.deviceId;
        opt.textContent = c.label || `Camera ${idx + 1}`;
        sel.appendChild(opt);
      });
    } catch (e) {
      console.warn('enumerateDevices error', e);
    }
  }

  async function startCamera(preferDeviceId = '') {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      throw new Error('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå/‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á');
    }

    stopCamera();

    const constraints = {
      audio: false,
      video: preferDeviceId
        ? { deviceId: { exact: preferDeviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }
        : { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
    };

    camStream = await navigator.mediaDevices.getUserMedia(constraints);
    const video = $('camVideo');
    video.srcObject = camStream;
    await video.play();

    $('cameraPlaceholder').style.display = 'none';
    video.style.display = 'block';
    $('camOverlay').style.display = 'block';
    $('scanHud').style.display = 'flex';

    await listCameras();
  }

  function stopCamera() {
    const video = $('camVideo');
    if (video) {
      try { video.pause(); } catch(e){}
      video.srcObject = null;
      video.style.display = 'none';
    }
    const overlay = $('camOverlay');
    if (overlay) overlay.style.display = 'none';

    const hud = $('scanHud');
    if (hud) hud.style.display = 'none';

    const ph = $('cameraPlaceholder');
    if (ph) ph.style.display = 'flex';

    if (camStream) {
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
  }

  /**************************************************
   * FACE: PARSE & MATCH
   **************************************************/
  function safeParseFaceData(faceDataRaw) {
    if (!faceDataRaw) return null;
    try {
      const parsed = typeof faceDataRaw === 'string' ? JSON.parse(faceDataRaw) : faceDataRaw;
      if (Array.isArray(parsed) && parsed.length >= 64) return new Float32Array(parsed);
      if (parsed && typeof parsed === 'object') {
        if (Array.isArray(parsed.descriptor)) return new Float32Array(parsed.descriptor);
        if (Array.isArray(parsed.data)) return new Float32Array(parsed.data);
      }
    } catch (e) {}
    return null;
  }

  function euclideanDistance(a, b) {
    if (!a || !b || a.length !== b.length) return 999;
    let sum = 0;
    for (let i = 0; i < a.length; i++) {
      const d = a[i] - b[i];
      sum += d * d;
    }
    return Math.sqrt(sum);
  }

  function findBestMatch(queryDescriptor) {
    let best = { code: '', fullName: '', distance: 999 };
    for (const emp of employeesCache) {
      const code = String(emp.code || '').trim();
      const fullName = String(emp.fullName || emp.fullname || '').trim();
      const desc = safeParseFaceData(emp.faceData);
      if (!code || !desc) continue;
      const dist = euclideanDistance(queryDescriptor, desc);
      if (dist < best.distance) best = { code, fullName, distance: dist };
    }
    return best;
  }

  function setScanPills(statusText, foundText) {
    $('scanPillLeft').innerHTML = `<strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${statusText}`;
    $('scanPillRight').innerHTML = `<strong>‡∏û‡∏ö:</strong> ${foundText}`;
  }

  function clearOverlay() {
    const canvas = $('camOverlay');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  function drawBox(box) {
    const canvas = $('camOverlay');
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 3;
    ctx.strokeStyle = 'rgba(34,197,94,0.95)';
    ctx.strokeRect(box.x, box.y, box.width, box.height);
  }

  async function scanTick() {
    if (!scanning) return;
    const video = $('camVideo');
    const canvas = $('camOverlay');
    if (!video || video.readyState < 2) return;

    const vw = video.videoWidth || 1280;
    const vh = video.videoHeight || 720;
    if (canvas.width !== vw || canvas.height !== vh) {
      canvas.width = vw;
      canvas.height = vh;
    }

    const opts = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });

    try {
      const result = await faceapi.detectSingleFace(video, opts).withFaceLandmarks().withFaceDescriptor();
      clearOverlay();

      if (!result) {
        stableHit = 0;
        lockedMatch = null;
        $('btnScanSubmit').disabled = true;
        setScanPills('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...', '-');
        return;
      }

      const resized = faceapi.resizeResults(result, { width: vw, height: vh });
      drawBox(resized.detection.box);

      const best = findBestMatch(result.descriptor);

      if (!best.code || best.distance > FACE_MATCH_THRESHOLD) {
        stableHit = 0;
        lockedMatch = null;
        $('btnScanSubmit').disabled = true;

        const msg = best.code
          ? `${best.code} ${best.fullName ? '- ' + best.fullName : ''} (‡πÑ‡∏Å‡∏•‡πÑ‡∏õ: ${best.distance.toFixed(2)})`
          : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (faceData)';

        setScanPills('‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', msg);
        return;
      }

      const sameAsLast = best.code === lastBest.code;
      lastBest = best;

      stableHit = sameAsLast ? (stableHit + 1) : 1;

      if (stableHit >= STABLE_MATCH_COUNT) {
        lockedMatch = best;
        $('btnScanSubmit').disabled = false;
        setScanPills('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úÖ', `${best.code} - ${best.fullName} (dist ${best.distance.toFixed(2)})`);
      } else {
        $('btnScanSubmit').disabled = true;
        setScanPills(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô... (${stableHit}/${STABLE_MATCH_COUNT})`, `${best.code} - ${best.fullName} (dist ${best.distance.toFixed(2)})`);
      }

    } catch (err) {
      console.error(err);
      setScanPills('‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏î‡∏π console)', '-');
    }
  }

  function startScanLoop() {
    if (scanning) return;
    scanning = true;
    stableHit = 0;
    lockedMatch = null;
    lastBest = { code:'', fullName:'', distance: 999 };

    $('btnStopScan').disabled = false;
    $('btnStartScan').disabled = true;
    $('btnScanSubmit').disabled = true;

    setScanPills('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß', '-');

    const loop = async () => {
      if (!scanning) return;
      await scanTick();
      setTimeout(loop, 250);
    };
    loop();
  }

  function stopScanLoop() {
    scanning = false;
    $('btnStopScan').disabled = true;
    $('btnStartScan').disabled = false;
    $('btnScanSubmit').disabled = true;
    lockedMatch = null;
    stableHit = 0;
    setScanPills('‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß', '-');
    clearOverlay();
  }

  function captureFrameBase64({ maxW = SNAP_MAX_W, quality = SNAP_JPEG_QUALITY } = {}) {
    const video = $('camVideo');
    const srcW = video.videoWidth || 1280;
    const srcH = video.videoHeight || 720;

    const scale = Math.min(1, maxW / srcW);
    const w = Math.round(srcW * scale);
    const h = Math.round(srcH * scale);

    const c = document.createElement('canvas');
    c.width = w;
    c.height = h;
    const ctx = c.getContext('2d');

    ctx.translate(w, 0);
    ctx.scale(-1, 1);
    ctx.drawImage(video, 0, 0, w, h);

    return c.toDataURL('image/jpeg', quality);
  }

  /**************************************************
   * INITIAL DATA
   **************************************************/
  async function init() {
    const apiUrl = getApiUrl();
    $('apiUrlDisplay').textContent = apiUrl ? 'API: ' + apiUrl : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';

    if (!apiUrl) {
      setConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
      return;
    }

    try {
      const result = await api.call('getInitialData');
      employeesCache = result.employees || [];
      setConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      loadTodaySummaryFromResult(result.todaySummary);
      rebuildDatalist();

      ensureModelsLoaded(); // preload
    } catch (err) {
      console.error(err);
      setConnectionStatus(false, err.message);
    }
  }

  function rebuildDatalist() {
    const dl = $('empDatalist');
    if (!dl) return;
    dl.innerHTML = '';
    for (const e of employeesCache) {
      const code = String(e.code || '').trim();
      if (!code) continue;
      const name = String(e.fullName || e.fullname || '').trim();
      const opt = document.createElement('option');
      opt.value = code;
      opt.label = name ? `${code} - ${name}` : code;
      dl.appendChild(opt);
    }
  }

  function renderTodayCards(rows){
    const wrap = $('todayCards');
    if (!wrap) return;

    if (!rows.length) {
      wrap.innerHTML = `
        <div class="today-card">
          <div class="meta">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
        </div>`;
      return;
    }

    wrap.innerHTML = rows.map(r=>{
      const st = statusBadgeHtml(r.status || '');
      return `
        <div class="today-card">
          <div class="top">
            <div>
              <div class="name">${r.code || ''} - ${r.fullName || ''}</div>
              <div class="meta">‡πÅ‡∏ú‡∏ô‡∏Å: ${r.branch || '-'} ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${r.level || '-'}</div>
            </div>
            <div>${st}</div>
          </div>

          <div class="grid">
            <div class="cell"><div class="k">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</div><div class="v">${r.t1 || '-'}</div></div>
            <div class="cell"><div class="k">‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</div><div class="v">${r.t2 || '-'}</div></div>
            <div class="cell"><div class="k">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</div><div class="v">${r.t3 || '-'}</div></div>
            <div class="cell"><div class="k">‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</div><div class="v">${r.t4 || '-'}</div></div>
          </div>
        </div>
      `;
    }).join('');
  }

  function loadTodaySummaryFromResult(summary) {
    const tbody = $('todaySummaryBody');
    const rows = Array.isArray(summary) ? summary : [];

    if (tbody) {
      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:12px 8px;" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
      } else {
        tbody.innerHTML = rows.map(row => `
          <tr>
            <td>${row.code || ''}</td>
            <td>${row.fullName || ''}</td>
            <td>${row.branch || ''}</td>
            <td>${row.level || ''}</td>
            <td>${row.t1 || ''}</td>
            <td>${row.t2 || ''}</td>
            <td>${row.t3 || ''}</td>
            <td>${row.t4 || ''}</td>
            <td>${statusBadgeHtml(row.status || '')}</td>
          </tr>
        `).join('');
      }
    }

    renderTodayCards(rows);
  }

  async function loadTodaySummary() {
    try {
      const result = await api.call('getTodaySummary');
      loadTodaySummaryFromResult(result);
    } catch (err) {
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  /**************************************************
   * MANUAL MODAL
   **************************************************/
  function findEmployeeByCode(code) {
    return employeesCache.find(e => String(e.code) === String(code));
  }

  function updateManualEmpInfo() {
    const code = $('manualCode').value.trim();
    const infoEl = $('manualEmpInfo');
    if (!code) {
      infoEl.textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• / ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏£‡∏∞‡∏î‡∏±‡∏ö';
      return;
    }
    const emp = findEmployeeByCode(code);
    if (!emp) infoEl.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï Employees';
    else infoEl.textContent = `${emp.fullName || ''} | ‡πÅ‡∏ú‡∏ô‡∏Å: ${emp.branch || '-'} | ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${emp.level || '-'}`;
  }

  async function submitManual() {
    const code   = $('manualCode').value.trim();
    const type   = $('manualType').value;
    const fileEl = $('manualFile');
    const resultEl = $('manualResult');
    const errEl = $('manualError');
    const sucEl = $('manualSuccess');
    const submitBtn = $('btnManualSubmit');

    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    resultEl.value = '';

    if (!code) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      errEl.style.display = 'block';
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    resultEl.value = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...';

    try {
      const position = await getCurrentPositionPromise({ enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
      const { latitude, longitude } = position.coords;

      const file = fileEl.files[0];
      const base64 = await fileToBase64(file);

      const payload = { code, lat: latitude, lng: longitude, manualType: type };
      if (base64) {
        payload.evidenceBase64 = base64;
        payload.evidenceName   = file ? file.name : ('evidence-' + code + '.png');
      }

      const res = await api.call('saveManualLog', payload);

      const lines = [];
      lines.push(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏ß‡∏•‡∏≤ ${res.time} (${res.slot})`);
      if (res.employee) {
        lines.push(`‡∏£‡∏´‡∏±‡∏™: ${res.employee.code}`);
        lines.push(`‡∏ä‡∏∑‡πà‡∏≠: ${res.employee.fullName || ''}`);
        lines.push(`‡πÅ‡∏ú‡∏ô‡∏Å: ${res.employee.branch || ''}`);
        lines.push(`‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${res.employee.level || ''}`);
      }
      lines.push(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${res.status || ''}`);

      if (res.location) {
        const loc = res.location;
        if (loc.locationText) lines.push(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${loc.locationText}`);
        if (loc.lat && loc.lng) {
          lines.push(`‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${loc.lat}, ${loc.lng}`);
          lines.push(`‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: https://www.google.com/maps?q=${loc.lat},${loc.lng}`);
        }
      }

      if (res.locationZone) {
        if (res.locationZone === 'IN') lines.push(`‡πÇ‡∏ã‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó`);
        else if (res.locationZone === 'OUT') lines.push(`‡πÇ‡∏ã‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)`);
      }

      if (res.evidenceUrl) lines.push(`‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô: ${res.evidenceUrl}`);
      resultEl.value = lines.join('\n');

      sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
      sucEl.style.display = 'block';

      updateLatestFromManual(res);
      loadTodaySummary();

      setTimeout(() => hideModal('modalManual'), 1200);

    } catch (err) {
      console.error(err);
      errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
      resultEl.value = '';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }
  }

  function updateLatestFromManual(res) {
    const box = $('latestContent');
    if (!box) return;
    const emp = res.employee || {};
    const statusHtml = statusBadgeHtml(res.status || '');
    const loc = res.location || {};
    let zoneText = '';
    if (res.locationZone === 'IN') zoneText = ' (‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)';
    else if (res.locationZone === 'OUT') zoneText = ' (‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)';

    let locationHtml = '';
    if (loc.lat && loc.lng) {
      const mapUrl = 'https://www.google.com/maps?q=' + encodeURIComponent(loc.lat + ',' + loc.lng);
      const locText = loc.locationText ? loc.locationText + '<br>' : '';
      locationHtml = `
        <div class="latest-row mt-8">
          <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span>
          <span>${locText}<a href="${mapUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>${zoneText}</span>
        </div>`;
    }

    box.innerHTML = `
      <div class="latest-row">
        <span class="label">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
        <span>${emp.code || ''} - ${emp.fullName || ''}</span>
      </div>
      <div class="latest-row mt-8">
        <span class="label">‡πÄ‡∏ß‡∏•‡∏≤</span>
        <span>${res.time || ''} (‡∏•‡∏á‡∏ä‡πà‡∏≠‡∏á ${res.slot || '-'})</span>
      </div>
      <div class="latest-row mt-8">
        <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
        <span>${statusHtml}</span>
      </div>
      ${locationHtml}
      ${res.evidenceUrl ? `
      <div class="latest-row mt-8">
        <span class="label">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</span>
        <span><a href="${res.evidenceUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</a></span>
      </div>` : ''}
    `;
  }

  /**************************************************
   * CHECK TODAY
   **************************************************/
  async function submitCheckToday() {
    const code = $('checkCode').value.trim();
    const resultEl = $('checkResult');
    const errEl = $('checkError');

    errEl.style.display = 'none';
    resultEl.value = '';

    if (!code) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      errEl.style.display = 'block';
      return;
    }

    try {
      const res = await api.call('checkTodayByCode', { code });
      if (!res.found) {
        resultEl.value = res.message || '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤';
        return;
      }

      const emp = res.employee || {};
      const log = res.log || {};
      const lines = [];
      lines.push(`‡∏£‡∏´‡∏±‡∏™: ${emp.code || ''}`);
      lines.push(`‡∏ä‡∏∑‡πà‡∏≠: ${emp.fullName || ''}`);
      lines.push(`‡πÅ‡∏ú‡∏ô‡∏Å: ${emp.branch || ''}`);
      lines.push(`‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${emp.level || ''}`);
      lines.push('-----------------------------');
      lines.push(`‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤ (t1): ${log.t1 || '-'}`);
      lines.push(`‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á (t2): ${log.t2 || '-'}`);
      lines.push(`‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á (t3): ${log.t3 || '-'}`);
      lines.push(`‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô (t4): ${log.t4 || '-'}`);
      lines.push(`Extra1: ${log.tExtra1 || '-'}`);
      lines.push(`Extra2: ${log.tExtra2 || '-'}`);
      lines.push('-----------------------------');
      lines.push(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${log.status || '-'}`);
      if (log.evidenceUrl) lines.push(`‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô: ${log.evidenceUrl}`);

      if (log.locationText || (log.lat && log.lng)) {
        lines.push('-----------------------------');
        if (log.locationText) lines.push(`‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${log.locationText}`);
        if (log.lat && log.lng) {
          lines.push(`‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${log.lat}, ${log.lng}`);
          lines.push(`‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: https://www.google.com/maps?q=${log.lat},${log.lng}`);
        }
      }

      resultEl.value = lines.join('\n');

    } catch (err) {
      console.error(err);
      errEl.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  /**************************************************
   * URL MODAL
   **************************************************/
  function openUrlModal() {
    $('inputApiUrl').value = getApiUrl();
    $('urlError').style.display = 'none';
    showModal('modalUrl');
  }

  function saveUrl() {
    const url = $('inputApiUrl').value.trim();
    const errEl = $('urlError');
    errEl.style.display = 'none';

    if (!url) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL';
      errEl.style.display = 'block';
      return;
    }

    if (!/^https:\/\/script\.google\.com\/macros\/s\//.test(url)) {
      if (!confirm('URL ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Web App ‡∏Ç‡∏≠‡∏á Apps Script ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ URL ‡∏ô‡∏µ‡πâ?')) return;
    }

    setApiUrl(url);
    $('apiUrlDisplay').textContent = 'API: ' + url;
    hideModal('modalUrl');
    init();
  }

  function resetUrl() {
    if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö URL ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
      setApiUrl('');
      $('apiUrlDisplay').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
      setConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');

      stopScanLoop();
      stopCamera();
    }
  }

  /**************************************************
   * FACE: CLOCK-IN FROM SCAN
   **************************************************/
  async function submitFromScan() {
    if (!lockedMatch || !lockedMatch.code) {
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô');
      return;
    }
    const code = lockedMatch.code;

    if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ: ${code} - ${lockedMatch.fullName} ?`)) return;

    try {
      const position = await getCurrentPositionPromise({ enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
      const { latitude, longitude } = position.coords;

      const evidenceBase64 = captureFrameBase64();

      const payload = {
        code,
        lat: latitude,
        lng: longitude,
        manualType: 'FACE_SCAN',
        evidenceBase64,
        evidenceName: `scan-${code}-${Date.now()}.jpg`
      };

      const res = await api.call('saveManualLog', payload);

      updateLatestFromManual(res);
      loadTodaySummary();

      alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${res.time} (${res.slot})\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${res.status || '-'}`);

      lockedMatch = null;
      stableHit = 0;
      $('btnScanSubmit').disabled = true;
      setScanPills('‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ', '-');

    } catch (err) {
      console.error(err);
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  /**************************************************
   * ENROLL FACE (HR)
   **************************************************/
  function openEnrollModal() {
    $('enrollLoginError').style.display = 'none';
    $('enrollDoError').style.display = 'none';
    $('enrollDoSuccess').style.display = 'none';

    $('enrollStepLogin').style.display = enrollAuthed ? 'none' : 'block';
    $('enrollStepDo').style.display = enrollAuthed ? 'block' : 'none';

    $('enrollInfo').textContent = '‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏Å‡∏î ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Äù';
    showModal('modalEnroll');
  }

  async function enrollLogin() {
    const u = $('enrollUser').value.trim();
    const p = $('enrollPass').value.trim();
    const err = $('enrollLoginError');

    err.style.display = 'none';

    try {
      const res = await api.call('loginAdmin', { username: u, password: p });
      if (!res || !res.success) throw new Error('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      enrollAuthed = true;

      $('enrollStepLogin').style.display = 'none';
      $('enrollStepDo').style.display = 'block';

    } catch (e) {
      err.textContent = e.message || String(e);
      err.style.display = 'block';
    }
  }

  async function enrollStartCamera() {
    const info = $('enrollInfo');
    try {
      const ok = await ensureModelsLoaded();
      if (!ok) throw new Error('‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');

      const deviceId = $('cameraSelect').value;
      await startCamera(deviceId || '');
      info.textContent = '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ñ‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù)';
    } catch (e) {
      console.error(e);
      info.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message;
    }
  }

  async function enrollCaptureAndUpload() {
    const code = $('enrollCode').value.trim();
    const err = $('enrollDoError');
    const suc = $('enrollDoSuccess');
    err.style.display = 'none';
    suc.style.display = 'none';

    if (!code) {
      err.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
      err.style.display = 'block';
      return;
    }

    if (!camStream) {
      err.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Äù';
      err.style.display = 'block';
      return;
    }

    const ok = await ensureModelsLoaded();
    if (!ok) {
      err.textContent = '‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå models/';
      err.style.display = 'block';
      return;
    }

    try {
      const video = $('camVideo');
      const opts = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });

      const result = await faceapi.detectSingleFace(video, opts).withFaceLandmarks().withFaceDescriptor();

      if (!result) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ/‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');

      const faceData = JSON.stringify(Array.from(result.descriptor));
      const photoBase64 = captureFrameBase64();

      const payload = {
        code,
        faceData,
        photoBase64,
        fileName: `face-${code}-${Date.now()}.jpg`
      };

      const res = await api.call('uploadEmployeeFace', payload);

      suc.textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (${res.code})`;
      suc.style.display = 'block';

      const fresh = await api.call('getEmployees');
      employeesCache = fresh || [];
      rebuildDatalist();

    } catch (e) {
      console.error(e);
      err.textContent = e.message || String(e);
      err.style.display = 'block';
    }
  }

  /**************************************************
   * EVENT BINDING + CLEANUP
   **************************************************/
  function closeAllCameraIfNeeded(modalId) {
    if (modalId === 'modalEnroll') {
      stopScanLoop();
      stopCamera();
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
      await listCameras();
    }

    // close modals
    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-close-modal');
        hideModal(id);
        closeAllCameraIfNeeded(id);
      });
    });

    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', e => {
        if (e.target === backdrop) {
          backdrop.classList.remove('show');
          closeAllCameraIfNeeded(backdrop.id);
        }
      });
    });

    // URL
    $('btnSetUrl').addEventListener('click', openUrlModal);
    $('btnSaveUrl').addEventListener('click', saveUrl);
    $('btnResetUrl').addEventListener('click', resetUrl);

    // Admin
    $('btnGoAdmin').addEventListener('click', () => { window.location.href = 'admin.html'; });

    // Manual
    $('btnOpenManualModal').addEventListener('click', () => {
      $('manualCode').value = '';
      $('manualFile').value = '';
      $('manualType').value = 'AUTO';
      $('manualResult').value = '';
      $('manualError').style.display = 'none';
      $('manualSuccess').style.display = 'none';
      $('manualEmpInfo').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• / ‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏£‡∏∞‡∏î‡∏±‡∏ö';
      showModal('modalManual');
    });
    $('manualCode').addEventListener('input', updateManualEmpInfo);
    $('btnManualSubmit').addEventListener('click', submitManual);

    // Check today
    $('btnOpenCheckToday').addEventListener('click', () => {
      $('checkCode').value = '';
      $('checkResult').value = '';
      $('checkError').style.display = 'none';
      showModal('modalCheckToday');
    });
    $('btnCheckTodaySubmit').addEventListener('click', submitCheckToday);

    $('btnRefreshToday').addEventListener('click', loadTodaySummary);

    // Enroll
    $('btnEnrollFace').addEventListener('click', openEnrollModal);
    $('btnEnrollLogin').addEventListener('click', enrollLogin);
    $('btnEnrollStartCam').addEventListener('click', enrollStartCamera);
    $('btnEnrollCapture').addEventListener('click', enrollCaptureAndUpload);

    // Camera select change
    $('cameraSelect').addEventListener('change', async () => {
      if (!camStream) return;
      try {
        const id = $('cameraSelect').value;
        await startCamera(id || '');
      } catch (e) {
        console.error(e);
      }
    });

    // Start scan
    $('btnStartScan').addEventListener('click', async () => {
      try {
        const apiUrl = getApiUrl();
        if (!apiUrl) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API ‡∏Å‡πà‡∏≠‡∏ô');

        const ok = await ensureModelsLoaded();
        if (!ok) return alert('‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå models/ ‡πÅ‡∏•‡∏∞ https');

        const deviceId = $('cameraSelect').value;
        await startCamera(deviceId || '');
        startScanLoop();
      } catch (e) {
        console.error(e);
        alert('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + (e.message || e));
      }
    });

    // Stop scan
    $('btnStopScan').addEventListener('click', () => {
      stopScanLoop();
      stopCamera();
    });

    // Submit from scan
    $('btnScanSubmit').addEventListener('click', submitFromScan);

    // Mobile nav
    document.querySelectorAll('.nav-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveTab(btn.dataset.tab));
    });

    // Action sheet
    const btnOpenAS = $('btnOpenActionSheet');
    if (btnOpenAS) btnOpenAS.addEventListener('click', openActionSheet);
    $('btnCloseActionSheet').addEventListener('click', closeActionSheet);
    $('actionSheet').addEventListener('click', (e)=>{
      if (e.target === $('actionSheet')) closeActionSheet();
    });

    // Init
    init();
  });

  window.addEventListener('beforeunload', () => {
    try { stopScanLoop(); } catch(e){}
    try { stopCamera(); } catch(e){}
  });
</script>

<!-- Bottom Nav (mobile) -->
<div class="bottom-nav">
  <div class="nav">
    <button class="nav-btn active" data-tab="tabScan"><div class="ico">üì∑</div><div>‡∏™‡πÅ‡∏Å‡∏ô</div></button>
    <button class="nav-btn" data-tab="tabToday"><div class="ico">üìä</div><div>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></button>
    <button class="nav-btn" data-tab="tabLatest"><div class="ico">‚è±</div><div>‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div></button>
    <button class="nav-btn" data-tab="tabHelp"><div class="ico">üí°</div><div>‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div></button>
  </div>
</div>

</body>
</html>
