<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบลงเวลาพนักงาน (สแกนใบหน้า)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .backdrop {
      background: rgba(0, 0, 0, 0.45);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <!-- Navbar -->
  <header class="bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-lg font-semibold text-indigo-700">
          ระบบลงเวลาพนักงาน
        </span>
        <span class="text-sm text-gray-500">เวอร์ชันสแกนใบหน้า</span>
      </div>
      <div class="flex gap-2">
        <button
          id="btn-open-config"
          class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
        >
          ตั้งค่า URL
        </button>
        <button
          id="btn-reset-url"
          class="px-3 py-1.5 text-xs rounded-md border border-red-300 text-red-600 hover:bg-red-50"
        >
          Reset URL
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pt-6 pb-12 space-y-6">
    <!-- ปุ่มเมนูด้านบน -->
    <section class="flex flex-wrap gap-3">
      <button
        id="btn-open-manual-log"
        class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-sm shadow-sm"
      >
        บันทึกมือ
      </button>
      <button
        id="btn-open-dashboard"
        class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm shadow-sm"
      >
        ตรวจสอบเวลา
      </button>
      <button
        id="btn-open-admin"
        class="px-4 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-sm shadow-sm"
      >
        เจ้าหน้าที่
      </button>
    </section>

    <!-- ส่วนสแกนใบหน้า -->
    <section class="grid md:grid-cols-3 gap-6">
      <!-- กล้อง -->
      <div class="md:col-span-2 bg-white rounded-xl shadow-sm p-4 space-y-4">
        <div>
          <h2 class="font-semibold text-lg">สแกนใบหน้าเพื่อ ลงเวลา</h2>
          <p class="text-sm text-gray-500">
            กรุณายืนหน้าตรง ไม่สวมหน้ากากอนามัย
          </p>
        </div>

        <div
          class="relative w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden"
        >
          <video
            id="video"
            autoplay
            muted
            playsinline
            class="w-full h-full object-cover"
          ></video>
          <div
            id="camera-overlay"
            class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 gap-2"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-12 w-12"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M3 8l3-3h4l3 3h4a2 2 0 012 2v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8z"
              />
              <circle cx="12" cy="13" r="3.5"></circle>
            </svg>
            <span class="text-sm">กล้องปิดอยู่</span>
          </div>
        </div>

        <!-- เลือกกล้อง + ปุ่ม -->
        <div class="flex flex-col md:flex-row gap-3 items-center">
          <div class="flex-1 w-full">
            <label class="text-xs text-gray-500">เลือกกล้อง:</label>
            <select
              id="camera-select"
              class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
            >
              <option value="">กำลังค้นหากล้อง...</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button
              id="btn-start-scan"
              class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm shadow-sm"
            >
              เริ่มสแกน
            </button>
            <button
              id="btn-stop-scan"
              class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg text-sm"
            >
              หยุดสแกน
            </button>
          </div>
        </div>

        <!-- สถานะ -->
        <div
          id="scan-status"
          class="mt-2 px-3 py-2 rounded-lg text-sm bg-sky-50 text-sky-700"
        >
          สถานะ: ยังไม่เริ่มสแกน
        </div>
      </div>

      <!-- แผงผลลัพธ์ล่าสุด -->
      <div class="bg-white rounded-xl shadow-sm p-4 space-y-4">
        <h2 class="font-semibold text-lg">ผลการสแกนล่าสุด</h2>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-500">พนักงาน:</span>
            <span id="last-emp" class="font-medium">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">เวลา:</span>
            <span id="last-time" class="font-medium">-</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-500">สถานะ:</span>
            <span id="last-status" class="font-medium">-</span>
          </div>
        </div>

        <hr />

        <!-- ปุ่มลงเวลาแบบเลือกพนักงาน (โหมดทดลอง) -->
        <div class="space-y-2">
          <label class="text-xs text-gray-500"
            >ลงเวลาจากรายชื่อพนักงาน (โหมดทดลอง):</label
          >
          <select
            id="quick-employee-select"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
          >
            <option value="">-- เลือกพนักงาน --</option>
          </select>
          <div class="flex gap-2">
            <button
              id="btn-quick-checkin"
              class="flex-1 px-3 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-sm"
            >
              ลงเวลาเข้า
            </button>
            <button
              id="btn-quick-checkout"
              class="flex-1 px-3 py-2 bg-rose-500 hover:bg-rose-600 text-white rounded-lg text-sm"
            >
              ลงเวลาออก
            </button>
          </div>
          <p class="text-[11px] text-gray-500">
            โหมดนี้ยังไม่ใช้ใบหน้าจริง แค่ช่วยเทสระบบบันทึกเวลากับ Google
            Sheet ให้เรียบร้อยก่อน
          </p>
        </div>
      </div>
    </section>

    <!-- Dashboard สรุปวันนี้แบบง่าย ๆ -->
    <section class="bg-white rounded-xl shadow-sm p-4 space-y-3">
      <div class="flex justify-between items-center">
        <h2 class="font-semibold text-lg">ภาพรวมระบบ (Dashboard)</h2>
        <button
          id="btn-refresh-dashboard"
          class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
        >
          รีเฟรชข้อมูล
        </button>
      </div>

      <div id="dashboard-summary" class="text-sm text-gray-600">
        กำลังโหลดข้อมูล...
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-xs border mt-2">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-2 py-1">วันที่</th>
              <th class="border px-2 py-1">รหัส</th>
              <th class="border px-2 py-1">ชื่อ</th>
              <th class="border px-2 py-1">แผนก</th>
              <th class="border px-2 py-1">ระดับ</th>
              <th class="border px-2 py-1">เข้า</th>
              <th class="border px-2 py-1">ออก</th>
              <th class="border px-2 py-1">สถานะ</th>
            </tr>
          </thead>
          <tbody id="today-logs-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODALS ------------------------------------------------------------>

  <!-- Modal ตั้งค่า Web App URL -->
  <div
    id="config-modal"
    class="fixed inset-0 hidden items-center justify-center backdrop z-30"
  >
    <div class="backdrop absolute inset-0"></div>
    <div
      class="relative bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-5 space-y-4 z-10"
    >
      <h2 class="font-semibold text-lg">เชื่อมต่อ Google Apps Script</h2>
      <p class="text-sm text-gray-600">
        วาง
        <span class="font-mono text-xs bg-gray-100 px-1 py-0.5 rounded"
          >Web App URL</span
        >
        ที่ได้จากการ Deploy Apps Script (ต้องลงท้ายด้วย
        <code class="text-xs bg-gray-100 px-1 rounded">/exec</code> และตั้งค่าเป็น
        <strong>Anyone</strong>
      </p>

      <div class="space-y-1">
        <label class="text-xs text-gray-500">Web App URL</label>
        <input
          id="webapp-url-input"
          type="text"
          class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm"
          placeholder="https://script.google.com/macros/s/XXXXX/exec"
        />
        <p id="webapp-url-error" class="text-xs text-red-500"></p>
        <p id="webapp-url-success" class="text-xs text-emerald-600"></p>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button
          id="btn-config-cancel"
          class="px-3 py-1.5 text-xs rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
        >
          ยกเลิก
        </button>
        <button
          id="btn-config-save"
          class="px-3 py-1.5 text-xs rounded-md bg-indigo-600 text-white hover:bg-indigo-700"
        >
          บันทึกและทดสอบ
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Login Admin -->
  <div
    id="admin-login-modal"
    class="fixed inset-0 hidden items-center justify-center backdrop z-30"
  >
    <div class="backdrop absolute inset-0"></div>
    <div
      class="relative bg-white rounded-xl shadow-xl max-w-sm w-full mx-4 p-5 space-y-4 z-10"
    >
      <h2 class="font-semibold text-lg text-center">เข้าสู่ระบบ Admin</h2>
      <div class="space-y-3 text-sm">
        <div>
          <label class="block text-xs text-gray-500">ชื่อผู้ใช้</label>
          <input
            id="admin-username"
            type="text"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            placeholder="admin"
          />
        </div>
        <div>
          <label class="block text-xs text-gray-500">รหัสผ่าน</label>
          <input
            id="admin-password"
            type="password"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            placeholder="••••"
          />
        </div>
        <p id="admin-login-status" class="text-xs text-red-500"></p>
      </div>
      <div class="flex justify-end gap-2 pt-2 text-xs">
        <button
          id="btn-admin-cancel"
          class="px-3 py-1.5 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
        >
          ยกเลิก
        </button>
        <button
          id="btn-admin-login"
          class="px-3 py-1.5 rounded-md bg-slate-800 text-white hover:bg-slate-900"
        >
          เข้าสู่ระบบ
        </button>
      </div>
    </div>
  </div>

  <!-- Modal เพิ่มพนักงาน (Admin) -->
  <div
    id="employee-modal"
    class="fixed inset-0 hidden items-center justify-center backdrop z-30"
  >
    <div class="backdrop absolute inset-0"></div>
    <div
      class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 p-5 space-y-4 z-10"
    >
      <div class="flex justify-between items-center">
        <h2 class="font-semibold text-lg">เพิ่ม/แก้ไข พนักงาน</h2>
        <button
          id="btn-employee-close"
          class="text-sm text-gray-500 hover:text-gray-800"
        >
          ✕ ปิด
        </button>
      </div>

      <form id="employee-form" class="grid md:grid-cols-2 gap-4 text-sm">
        <input type="hidden" id="emp-id" />

        <div>
          <label class="block text-xs text-gray-500">รหัสพนักงาน</label>
          <input
            id="emp-code"
            type="text"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            required
          />
        </div>

        <div>
          <label class="block text-xs text-gray-500">ชื่อ-สกุล</label>
          <input
            id="emp-name"
            type="text"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            required
          />
        </div>

        <div>
          <label class="block text-xs text-gray-500">แผนก</label>
          <select
            id="emp-branch"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            required
          >
            <option value="">-- เลือกแผนก --</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-500">ระดับ</label>
          <select
            id="emp-level"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            required
          >
            <option value="">-- เลือกระดับ --</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-500">อีเมล</label>
          <input
            id="emp-email"
            type="email"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
          />
        </div>

        <div>
          <label class="block text-xs text-gray-500">รูปถ่าย (หน้าตรง)</label>
          <input
            id="emp-photo"
            type="file"
            accept="image/*"
            class="mt-1 block w-full text-xs"
          />
          <p class="text-[11px] text-gray-500 mt-1">
            ตอนนี้ยังไม่อัปโหลดขึ้น Drive แค่เตรียมไว้ใช้ทำระบบรู้จำใบหน้าในขั้นถัดไป
          </p>
        </div>
      </form>

      <div class="flex justify-between items-center pt-2 text-xs">
        <div id="employee-form-status" class="text-gray-500"></div>
        <div class="flex gap-2">
          <button
            id="btn-employee-cancel"
            class="px-3 py-1.5 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
          >
            ยกเลิก
          </button>
          <button
            id="btn-employee-save"
            class="px-3 py-1.5 rounded-md bg-emerald-500 text-white hover:bg-emerald-600"
          >
            บันทึกพนักงาน
          </button>
        </div>
      </div>

      <hr class="my-3" />

      <div class="overflow-auto max-h-64 text-xs">
        <table class="min-w-full border">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-2 py-1">รหัส</th>
              <th class="border px-2 py-1">ชื่อ</th>
              <th class="border px-2 py-1">แผนก</th>
              <th class="border px-2 py-1">ระดับ</th>
              <th class="border px-2 py-1">อีเมล</th>
            </tr>
          </thead>
          <tbody id="employee-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal บันทึกเวลามือ -->
  <div
    id="manual-log-modal"
    class="fixed inset-0 hidden items-center justify-center backdrop z-30"
  >
    <div class="backdrop absolute inset-0"></div>
    <div
      class="relative bg-white rounded-xl shadow-xl max-w-md w-full mx-4 p-5 space-y-4 z-10"
    >
      <div class="flex justify-between items-center">
        <h2 class="font-semibold text-lg">บันทึกเวลาด้วยตัวเอง</h2>
        <button
          id="btn-manual-close"
          class="text-sm text-gray-500 hover:text-gray-800"
        >
          ✕ ปิด
        </button>
      </div>

      <div class="space-y-3 text-sm">
        <div>
          <label class="block text-xs text-gray-500">รหัสพนักงาน</label>
          <input
            id="manual-code"
            type="text"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
            placeholder="กรอกรหัสพนักงาน"
          />
        </div>

        <div>
          <label class="block text-xs text-gray-500">ประเภทการบันทึก</label>
          <select
            id="manual-type"
            class="mt-1 w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="IN">เข้างาน / ฝึกงาน (ปกติ)</option>
            <option value="OUT">ออกงาน</option>
          </select>
        </div>

        <div>
          <label class="block text-xs text-gray-500">
            รูปถ่ายยืนยัน / หลักฐานการลา (ไม่บังคับ)
          </label>
          <input
            id="manual-proof"
            type="file"
            accept="image/*"
            class="mt-1 block w-full text-xs"
          />
          <p class="text-[11px] text-gray-500 mt-1">
            ตอนนี้ระบบยังไม่อัปโหลดไฟล์ขึ้นไป ถ้าจะทำจริงค่อยต่อยอดในเวอร์ชันถัดไป
          </p>
        </div>

        <p id="manual-status" class="text-xs text-gray-500"></p>
      </div>

      <div class="flex justify-end gap-2 pt-2 text-xs">
        <button
          id="btn-manual-cancel"
          class="px-3 py-1.5 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50"
        >
          ยกเลิก
        </button>
        <button
          id="btn-manual-save"
          class="px-3 py-1.5 rounded-md bg-emerald-500 text-white hover:bg-emerald-600"
        >
          ยืนยันบันทึก
        </button>
      </div>
    </div>
  </div>

  <!-- สคริปต์หลัก ----------------------------------------------------->
  <script>
    /**********************
     * STATE กลาง
     **********************/
    const LS_KEY_URL = "faceAttendance:webAppUrl";

    let webAppUrl = "";
    let state = {
      employees: [],
      branches: [],
      levels: [],
      todayLogs: [],
    };
    let isAdminLoggedIn = false;

    /**********************
     * ฟังก์ชันเรียก API
     * ใช้ form-urlencoded เพื่อเลี่ยง CORS preflight
     **********************/
    async function callApi(action, payload = {}) {
      if (!webAppUrl) {
        throw new Error("NOT_CONFIGURED");
      }

      const params = new URLSearchParams();
      params.append("action", action);
      Object.entries(payload).forEach(([k, v]) => {
        params.append(k, typeof v === "object" ? JSON.stringify(v) : v);
      });

      const res = await fetch(webAppUrl, {
        method: "POST",
        body: params,
      });

      if (!res.ok) {
        throw new Error("HTTP " + res.status);
      }

      const data = await res.json();
      if (!data.ok) {
        throw new Error(data.error || "API error");
      }
      return data.result;
    }

    /**********************
     * จัดการ MODAL
     **********************/
    function openModal(el) {
      el.classList.remove("hidden");
      el.classList.add("flex");
    }
    function closeModal(el) {
      el.classList.add("hidden");
      el.classList.remove("flex");
    }

    /**********************
     * ตั้งค่า / ทดสอบ URL
     **********************/
    async function onSaveWebAppUrl() {
      const input = document.getElementById("webapp-url-input");
      const url = input.value.trim();
      const errorEl = document.getElementById("webapp-url-error");
      const successEl = document.getElementById("webapp-url-success");
      errorEl.textContent = "";
      successEl.textContent = "";

      if (!url || !url.startsWith("https://script.google.com/macros/s/")) {
        errorEl.textContent =
          "กรุณาวาง URL ที่ถูกต้องจาก Apps Script (ต้องขึ้นต้นด้วย https://script.google.com/macros/s/ และลงท้าย /exec)";
        return;
      }
      if (!url.endsWith("/exec")) {
        errorEl.textContent = "URL ต้องลงท้ายด้วย /exec";
        return;
      }

      webAppUrl = url;

      try {
        await callApi("ping");
        localStorage.setItem(LS_KEY_URL, url);
        successEl.textContent = "เชื่อมต่อสำเร็จ! กำลังโหลดข้อมูลเริ่มต้น...";
        await loadInitialData();
        setTimeout(() => {
          closeModal(document.getElementById("config-modal"));
        }, 600);
      } catch (err) {
        console.error(err);
        errorEl.textContent = "เชื่อมต่อไม่สำเร็จ: " + err.message;
      }
    }

    function resetUrl() {
      localStorage.removeItem(LS_KEY_URL);
      webAppUrl = "";
      document.getElementById("webapp-url-input").value = "";
      document.getElementById("webapp-url-error").textContent = "";
      document.getElementById("webapp-url-success").textContent = "";
      openModal(document.getElementById("config-modal"));
    }

    /**********************
     * โหลดข้อมูลเริ่มต้นจาก API
     **********************/
    async function loadInitialData() {
      if (!webAppUrl) return;
      try {
        const result = await callApi("getInitialData");
        state.employees = result.employees || [];
        state.branches = result.branches || [];
        state.levels = result.levels || [];
        state.todayLogs = result.todayLogs || [];

        renderEmployees();
        renderBranchesLevelsToForm();
        renderDashboard();
        renderQuickEmployeeSelect();
      } catch (err) {
        console.error(err);
        document.getElementById("dashboard-summary").textContent =
          "โหลดข้อมูลไม่สำเร็จ: " + err.message;
      }
    }

    function renderEmployees() {
      const tbody = document.getElementById("employee-table-body");
      tbody.innerHTML = "";
      state.employees.forEach((emp) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${emp.code || ""}</td>
          <td class="border px-2 py-1">${emp.fullName || ""}</td>
          <td class="border px-2 py-1">${emp.branch || ""}</td>
          <td class="border px-2 py-1">${emp.level || ""}</td>
          <td class="border px-2 py-1">${emp.email || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderBranchesLevelsToForm() {
      const branchSelect = document.getElementById("emp-branch");
      const levelSelect = document.getElementById("emp-level");
      const quickEmpSelect = document.getElementById("quick-employee-select");

      // Branches
      branchSelect.innerHTML = `<option value="">-- เลือกแผนก --</option>`;
      state.branches.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.name || b.id || "";
        opt.textContent = b.name || "";
        branchSelect.appendChild(opt);
      });

      // Levels
      levelSelect.innerHTML = `<option value="">-- เลือกระดับ --</option>`;
      state.levels.forEach((l) => {
        const opt = document.createElement("option");
        opt.value = l.name || l.id || "";
        opt.textContent = l.name || "";
        levelSelect.appendChild(opt);
      });

      // Quick select จะ render ใน renderQuickEmployeeSelect อีกที
      quickEmpSelect.innerHTML = `<option value="">-- เลือกพนักงาน --</option>`;
    }

    function renderQuickEmployeeSelect() {
      const sel = document.getElementById("quick-employee-select");
      sel.innerHTML = `<option value="">-- เลือกพนักงาน --</option>`;
      state.employees.forEach((emp) => {
        const opt = document.createElement("option");
        opt.value = emp.code || "";
        opt.textContent = `${emp.code || ""} - ${emp.fullName || ""}`;
        sel.appendChild(opt);
      });
    }

    function renderDashboard() {
      const summaryEl = document.getElementById("dashboard-summary");
      const body = document.getElementById("today-logs-body");
      body.innerHTML = "";

      const count = state.todayLogs.length;
      if (count === 0) {
        summaryEl.textContent = "วันนี้ยังไม่มีการลงเวลา";
      } else {
        summaryEl.textContent = `วันนี้มีการลงเวลา ${count} รายการ`;
      }

      state.todayLogs.forEach((log) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${log.date || ""}</td>
          <td class="border px-2 py-1">${log.code || ""}</td>
          <td class="border px-2 py-1">${log.fullName || ""}</td>
          <td class="border px-2 py-1">${log.branch || ""}</td>
          <td class="border px-2 py-1">${log.level || ""}</td>
          <td class="border px-2 py-1">${log.timeIn || ""}</td>
          <td class="border px-2 py-1">${log.timeOut || ""}</td>
          <td class="border px-2 py-1">${log.status || ""}</td>
        `;
        body.appendChild(tr);
      });
    }

    /**********************
     * บันทึกพนักงาน (Admin)
     **********************/
    async function onSaveEmployee() {
      const formStatus = document.getElementById("employee-form-status");
      formStatus.textContent = "";

      const id = document.getElementById("emp-id").value.trim();
      const code = document.getElementById("emp-code").value.trim();
      const name = document.getElementById("emp-name").value.trim();
      const branch = document.getElementById("emp-branch").value.trim();
      const level = document.getElementById("emp-level").value.trim();
      const email = document.getElementById("emp-email").value.trim();
      const photoUrl = "";
      const faceData = "";

      if (!code || !name || !branch || !level) {
        formStatus.textContent = "กรุณากรอกข้อมูลให้ครบ";
        formStatus.classList.remove("text-emerald-600");
        formStatus.classList.add("text-red-500");
        return;
      }

      try {
        const result = await callApi("saveEmployee", {
          id,
          code,
          fullName: name,
          branch,
          level,
          email,
          photoUrl,
          faceData,
        });
        formStatus.textContent = "บันทึกสำเร็จ (id: " + result.id + ")";
        formStatus.classList.remove("text-red-500");
        formStatus.classList.add("text-emerald-600");

        document.getElementById("emp-id").value = "";
        document.getElementById("emp-code").value = "";
        document.getElementById("emp-name").value = "";
        document.getElementById("emp-email").value = "";
        document.getElementById("emp-branch").value = "";
        document.getElementById("emp-level").value = "";

        await loadInitialData();
      } catch (err) {
        console.error(err);
        formStatus.textContent = "บันทึกไม่สำเร็จ: " + err.message;
        formStatus.classList.remove("text-emerald-600");
        formStatus.classList.add("text-red-500");
      }
    }

    /**********************
     * ลงเวลาแบบ Quick Select (แทนสแกนจริงก่อน)
     **********************/
    async function quickLog(type) {
      const select = document.getElementById("quick-employee-select");
      const code = select.value;
      if (!code) return;

      const emp = state.employees.find((e) => String(e.code) === String(code));
      if (!emp) return;

      try {
        const result = await callApi("logScan", {
          code: emp.code || "",
          fullName: emp.fullName || "",
          branch: emp.branch || "",
          level: emp.level || "",
          logType: type,
        });

        document.getElementById("last-emp").textContent =
          emp.fullName || emp.code || "";
        document.getElementById("last-time").textContent = result.time || "-";
        document.getElementById("last-status").textContent =
          result.type || type;

        await loadInitialData();
      } catch (err) {
        console.error(err);
        alert("ลงเวลาไม่สำเร็จ: " + err.message);
      }
    }

    /**********************
     * กล้อง (เวอร์ชันเบา ๆ)
     **********************/
    let currentStream = null;

    async function listCameras() {
      const select = document.getElementById("camera-select");
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoInputs = devices.filter((d) => d.kind === "videoinput");
        select.innerHTML = "";
        if (videoInputs.length === 0) {
          select.innerHTML = '<option value="">ไม่พบกล้อง</option>';
          return;
        }
        videoInputs.forEach((dev, idx) => {
          const opt = document.createElement("option");
          opt.value = dev.deviceId;
          opt.textContent =
            dev.label || `camera ${idx + 1} (${dev.deviceId})`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        select.innerHTML =
          '<option value="">ไม่สามารถเข้าถึงกล้อง</option>';
      }
    }

    async function startCamera() {
      const statusEl = document.getElementById("scan-status");
      const overlay = document.getElementById("camera-overlay");
      const select = document.getElementById("camera-select");
      const deviceId = select.value;

      try {
        if (currentStream) {
          currentStream.getTracks().forEach((t) => t.stop());
        }

        const constraints = deviceId
          ? { video: { deviceId: { exact: deviceId } } }
          : { video: true };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        const video = document.getElementById("video");
        video.srcObject = stream;
        overlay.classList.add("hidden");
        statusEl.textContent =
          "สถานะ: กำลังสแกน (ยังไม่ผูกกับใบหน้าจริง)";
      } catch (err) {
        console.error(err);
        statusEl.textContent =
          "สถานะ: เปิดกล้องไม่สำเร็จ - " + err.message;
      }
    }

    function stopCamera() {
      const statusEl = document.getElementById("scan-status");
      const overlay = document.getElementById("camera-overlay");
      if (currentStream) {
        currentStream.getTracks().forEach((t) => t.stop());
        currentStream = null;
      }
      document.getElementById("video").srcObject = null;
      overlay.classList.remove("hidden");
      statusEl.textContent = "สถานะ: หยุดสแกนแล้ว";
    }

    /**********************
     * ตรวจสอบเวลาตามรหัส (เหมือน popup ในรูป)
     **********************/
    async function openCheckTimeDialog() {
      if (!webAppUrl) {
        openModal(document.getElementById("config-modal"));
        return;
      }

      const code = window.prompt("กรอกรหัสพนักงาน");
      if (!code) return;

      try {
        // ต้องมีฟังก์ชัน getHistory ใน Apps Script (จะไปเพิ่มทีหลัง)
        const history = await callApi("getHistory", { code: code.trim() });

        const totalHours = history.totalHours ?? 0;
        const normal = history.normalCount ?? 0;
        const late = history.lateCount ?? 0;

        alert(
          "ประวัติ: " +
            code +
            "\nชั่วโมงรวม: " +
            totalHours +
            " ชม.\nเข้างานปกติ: " +
            normal +
            " ครั้ง\nสาย: " +
            late +
            " ครั้ง"
        );
      } catch (err) {
        console.error(err);
        alert("ดึงประวัติไม่สำเร็จ: " + err.message);
      }
    }

    /**********************
     * บันทึกเวลาจากฟอร์ม "บันทึกมือ"
     **********************/
    async function onManualLogSave() {
      const codeInput = document.getElementById("manual-code");
      const typeSelect = document.getElementById("manual-type");
      const statusEl = document.getElementById("manual-status");

      const code = codeInput.value.trim();
      const logType = typeSelect.value;

      statusEl.classList.remove("text-red-500", "text-emerald-600");
      statusEl.textContent = "";

      if (!code) {
        statusEl.textContent = "กรุณากรอกรหัสพนักงาน";
        statusEl.classList.add("text-red-500");
        return;
      }

      const emp = state.employees.find(
        (e) => String(e.code) === String(code)
      );
      if (!emp) {
        statusEl.textContent = "ไม่พบพนักงานรหัสนี้ในระบบ";
        statusEl.classList.add("text-red-500");
        return;
      }

      try {
        const result = await callApi("logScan", {
          code: emp.code || "",
          fullName: emp.fullName || "",
          branch: emp.branch || "",
          level: emp.level || "",
          logType,
        });

        statusEl.textContent =
          "บันทึกสำเร็จ เวลา " +
          (result.time || "-") +
          " (" +
          (result.type || logType) +
          ")";
        statusEl.classList.add("text-emerald-600");

        document.getElementById("last-emp").textContent =
          emp.fullName || emp.code || "";
        document.getElementById("last-time").textContent = result.time || "-";
        document.getElementById("last-status").textContent =
          result.type || logType;

        await loadInitialData();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "บันทึกไม่สำเร็จ: " + err.message;
        statusEl.classList.add("text-red-500");
      }
    }

    /**********************
     * Login Admin แบบง่าย ๆ
     **********************/
    function openAdminLogin() {
      document.getElementById("admin-username").value = "";
      document.getElementById("admin-password").value = "";
      document.getElementById("admin-login-status").textContent = "";
      openModal(document.getElementById("admin-login-modal"));
    }

    function handleAdminLogin() {
      const user = document.getElementById("admin-username").value.trim();
      const pass = document.getElementById("admin-password").value.trim();
      const statusEl = document.getElementById("admin-login-status");
      statusEl.textContent = "";

      // ตั้งค่า default ง่าย ๆ ก่อน: admin / 1234
      if (user === "admin" && pass === "1234") {
        isAdminLoggedIn = true;
        closeModal(document.getElementById("admin-login-modal"));
        renderEmployees();
        renderBranchesLevelsToForm();
        openModal(document.getElementById("employee-modal"));
      } else {
        statusEl.textContent = "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง (ลอง admin / 1234)";
      }
    }

    /**********************
     * INIT
     **********************/
    document.addEventListener("DOMContentLoaded", async () => {
      const saved = localStorage.getItem(LS_KEY_URL);
      if (saved) {
        webAppUrl = saved;
        document.getElementById("webapp-url-input").value = saved;
        loadInitialData();
      } else {
        openModal(document.getElementById("config-modal"));
      }

      if (navigator.mediaDevices?.enumerateDevices) {
        listCameras();
      } else {
        document.getElementById("camera-select").innerHTML =
          '<option value="">เบราว์เซอร์ไม่รองรับ mediaDevices</option>';
      }

      /***** ผูก event ต่าง ๆ *****/
      document
        .getElementById("btn-open-config")
        .addEventListener("click", () =>
          openModal(document.getElementById("config-modal"))
        );

      document
        .getElementById("btn-config-save")
        .addEventListener("click", onSaveWebAppUrl);

      document
        .getElementById("btn-config-cancel")
        .addEventListener("click", () =>
          closeModal(document.getElementById("config-modal"))
        );

      document
        .getElementById("btn-reset-url")
        .addEventListener("click", resetUrl);

      // เจ้าหน้าที่ -> ต้อง login ก่อน
      document
        .getElementById("btn-open-admin")
        .addEventListener("click", () => {
          if (isAdminLoggedIn) {
            renderEmployees();
            renderBranchesLevelsToForm();
            openModal(document.getElementById("employee-modal"));
          } else {
            openAdminLogin();
          }
        });

      document
        .getElementById("btn-admin-login")
        .addEventListener("click", handleAdminLogin);

      document
        .getElementById("btn-admin-cancel")
        .addEventListener("click", () =>
          closeModal(document.getElementById("admin-login-modal"))
        );

      document
        .getElementById("btn-employee-close")
        .addEventListener("click", () =>
          closeModal(document.getElementById("employee-modal"))
        );
      document
        .getElementById("btn-employee-cancel")
        .addEventListener("click", () =>
          closeModal(document.getElementById("employee-modal"))
        );

      document
        .getElementById("btn-employee-save")
        .addEventListener("click", (e) => {
          e.preventDefault();
          onSaveEmployee();
        });

      document
        .getElementById("btn-refresh-dashboard")
        .addEventListener("click", loadInitialData);

      document
        .getElementById("btn-start-scan")
        .addEventListener("click", startCamera);
      document
        .getElementById("btn-stop-scan")
        .addEventListener("click", stopCamera);

      document
        .getElementById("btn-quick-checkin")
        .addEventListener("click", () => quickLog("IN"));
      document
        .getElementById("btn-quick-checkout")
        .addEventListener("click", () => quickLog("OUT"));

      // ปุ่มบันทึกมือ
      document
        .getElementById("btn-open-manual-log")
        .addEventListener("click", () =>
          openModal(document.getElementById("manual-log-modal"))
        );

      document
        .getElementById("btn-manual-close")
        .addEventListener("click", () =>
          closeModal(document.getElementById("manual-log-modal"))
        );
      document
        .getElementById("btn-manual-cancel")
        .addEventListener("click", () =>
          closeModal(document.getElementById("manual-log-modal"))
        );

      document
        .getElementById("btn-manual-save")
        .addEventListener("click", (e) => {
          e.preventDefault();
          onManualLogSave();
        });

      // ปุ่มตรวจสอบเวลา (popup กรอกรหัส)
      document
        .getElementById("btn-open-dashboard")
        .addEventListener("click", openCheckTimeDialog);
    });
  </script>
</body>
</html>
