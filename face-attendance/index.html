<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>ระบบลงเวลาพนักงาน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN (พอใช้บน GitHub Pages ได้) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- face-api.js (สำหรับสแกนใบหน้า – ไว้ต่อทีหลังได้) -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <!-- Navbar -->
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold text-indigo-700">
        ระบบลงเวลาพนักงาน
      </h1>
      <div class="flex gap-2">
        <button id="btnManual" class="px-3 py-1 rounded bg-amber-400 hover:bg-amber-500 text-white text-sm md:text-base">
          บันทึกมือ
        </button>
        <button id="btnDashboard" class="px-3 py-1 rounded bg-emerald-500 hover:bg-emerald-600 text-white text-sm md:text-base">
          ตรวจสอบเวลา
        </button>
        <button id="btnAdmin" class="px-3 py-1 rounded bg-slate-700 hover:bg-slate-800 text-white text-sm md:text-base">
          เจ้าหน้าที่
        </button>
        <button id="btnResetUrl" class="px-3 py-1 rounded border border-slate-300 text-xs md:text-sm">
          Reset URL
        </button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="flex-1">
    <div class="max-w-6xl mx-auto px-4 py-4 space-y-6">

      <!-- กล่องสแกนใบหน้า -->
      <section class="bg-white shadow rounded-lg p-4 md:p-6">
        <h2 class="text-lg md:text-xl font-semibold mb-1">
          สแกนใบหน้าเพื่อลงเวลา
        </h2>
        <p class="text-sm text-gray-500 mb-4">
          กรุณายืนหน้าตรง ไม่สวมหน้ากากอนามัย
        </p>

        <div class="flex flex-col lg:flex-row gap-4">
          <!-- วิดีโอ -->
          <div class="flex-1">
            <div class="bg-black rounded-lg overflow-hidden flex items-center justify-center h-64 md:h-72">
              <video id="video" autoplay muted playsinline class="w-full h-full object-cover hidden"></video>
              <div id="videoPlaceholder" class="flex flex-col items-center text-gray-300 gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" viewBox="0 0 24 24" stroke="currentColor" fill="none">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 7h4l2-3h6l2 3h4v13H3V7z" />
                  <circle cx="12" cy="14" r="4" />
                </svg>
                <span id="cameraStatusText" class="text-sm">กล้องปิดอยู่</span>
              </div>
              <canvas id="overlay" class="absolute inset-0 w-full h-full hidden"></canvas>
            </div>

            <!-- เลือกกล้อง + ปุ่มเริ่ม/หยุด -->
            <div class="mt-3 flex flex-col md:flex-row gap-3 items-center">
              <div class="flex-1 w-full">
                <label class="text-sm text-gray-600 block mb-1">เลือกกล้อง:</label>
                <select id="cameraSelect" class="w-full border rounded px-2 py-1 text-sm">
                  <option value="">กำลังค้นหากล้อง...</option>
                </select>
              </div>
              <div class="flex gap-2">
                <button id="btnStartScan"
                        class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm">
                  เริ่มสแกน
                </button>
                <button id="btnStopScan"
                        class="px-4 py-2 rounded bg-rose-500 hover:bg-rose-600 text-white text-sm"
                        disabled>
                  หยุดสแกน
                </button>
              </div>
            </div>

            <div class="mt-2 text-sm text-gray-600">
              <span>สถานะ: </span>
              <span id="scanStatus" class="font-medium text-slate-700">
                ยังไม่เริ่มสแกน
              </span>
            </div>
          </div>

          <!-- สรุปการสแกน (อนาคต: แสดงชื่อ/เวลา) -->
          <div class="w-full lg:w-80 bg-slate-50 rounded-lg p-3 md:p-4 border border-slate-200">
            <h3 class="font-semibold mb-2 text-slate-700">ผลการสแกนล่าสุด</h3>
            <dl class="text-sm space-y-1">
              <div class="flex justify-between">
                <dt class="text-gray-500">พนักงาน:</dt>
                <dd id="lastEmpName" class="font-medium text-slate-800">-</dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-500">เวลา:</dt>
                <dd id="lastEmpTime" class="font-medium text-slate-800">-</dd>
              </div>
              <div class="flex justify-between">
                <dt class="text-gray-500">สถานะ:</dt>
                <dd id="lastEmpStatus" class="font-medium text-slate-800">-</dd>
              </div>
            </dl>
          </div>
        </div>
      </section>

      <!-- Dashboard (ตาราง logs – simple mock ตอนนี้) -->
      <section class="bg-white shadow rounded-lg p-4 md:p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg md:text-xl font-semibold">ภาพรวมระบบ (Dashboard)</h2>
          <button id="btnReloadDashboard"
                  class="px-3 py-1 rounded border border-slate-300 text-xs md:text-sm">
            รีโหลดข้อมูล
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left font-medium text-gray-600">วันที่</th>
              <th class="px-3 py-2 text-left font-medium text-gray-600">รหัสพนักงาน</th>
              <th class="px-3 py-2 text-left font-medium text-gray-600">ชื่อ-สกุล</th>
              <th class="px-3 py-2 text-left font-medium text-gray-600">สาขา/แผนก</th>
              <th class="px-3 py-2 text-left font-medium text-gray-600">เข้า</th>
              <th class="px-3 py-2 text-left font-medium text-gray-600">ออก</th>
              <th class="px-3 py-2 text-left font-medium text-gray-600">สถานะ</th>
            </tr>
            </thead>
            <tbody id="logsTableBody" class="divide-y divide-gray-100">
            <!-- เติมข้อมูลใน JS -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal: ตั้งค่า Web App URL -->
  <div id="webAppModal"
       class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-md w-full p-4 md:p-5">
      <h3 class="text-lg font-semibold mb-3">เชื่อมต่อ Google Apps Script</h3>
      <p class="text-sm text-gray-500 mb-3">
        วาง <span class="font-mono text-xs bg-slate-100 px-1 py-0.5 rounded">Web App URL</span>
        จาก Apps Script (ลิงก์ที่ลงท้ายด้วย <code>/exec</code>)
      </p>
      <label class="block text-sm text-gray-600 mb-1">Web App URL</label>
      <input id="webAppUrlInput" type="text"
             class="w-full border rounded px-2 py-1 text-sm mb-3"
             placeholder="https://script.google.com/macros/s/XXXXX/exec">

      <div id="webAppTestStatus" class="text-xs text-gray-500 mb-3"></div>

      <div class="flex justify-end gap-2">
        <button id="btnCloseWebAppModal"
                class="px-3 py-1 rounded border border-gray-300 text-sm">
          ยกเลิก
        </button>
        <button id="btnSaveWebAppUrl"
                class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm">
          บันทึก
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: เพิ่ม/แก้ไขพนักงาน -->
  <div id="employeeModal"
       class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden">
    <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full p-4 md:p-6 relative">
      <button id="btnCloseEmployeeModal"
              class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
        ✕
      </button>
      <h3 class="text-lg font-semibold mb-4">เพิ่ม/แก้ไข พนักงาน</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">รหัสพนักงาน</label>
          <input id="empCode" type="text"
                 class="w-full border rounded px-2 py-1 text-sm mb-2"
                 placeholder="เช่น 1001">

          <label class="block text-sm text-gray-600 mb-1">ชื่อ-สกุล</label>
          <input id="empFullName" type="text"
                 class="w-full border rounded px-2 py-1 text-sm mb-2"
                 placeholder="ชื่อจริง นามสกุล">

          <label class="block text-sm text-gray-600 mb-1">แผนก</label>
          <select id="empBranch"
                  class="w-full border rounded px-2 py-1 text-sm mb-2">
            <option value="">-- เลือกแผนก --</option>
          </select>

          <label class="block text-sm text-gray-600 mb-1">ระดับ</label>
          <select id="empLevel"
                  class="w-full border rounded px-2 py-1 text-sm mb-2">
            <option value="">-- เลือกระดับ --</option>
          </select>

          <label class="block text-sm text-gray-600 mb-1">อีเมล</label>
          <input id="empEmail" type="email"
                 class="w-full border rounded px-2 py-1 text-sm mb-2"
                 placeholder="name@example.com">
        </div>

        <div class="flex flex-col">
          <label class="block text-sm text-gray-600 mb-1">รูปถ่าย (หน้าตรง)</label>
          <input id="empPhotoFile" type="file" accept="image/*"
                 class="mb-2 text-sm" />

          <p class="text-xs text-gray-500 mb-2">
            เลือกรูปจากมือถือ/คอมของพนักงาน ระบบจะเก็บเป็นข้อมูลใช้เทียบใบหน้า
          </p>

          <div
            class="border rounded-lg bg-slate-50 flex items-center justify-center overflow-hidden flex-1">
            <img id="empPhotoPreview" alt="preview"
                 class="max-h-56 object-cover hidden" />
            <span id="empPhotoPlaceholder"
                  class="text-gray-400 text-sm">ยังไม่มีรูป</span>
          </div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelEmployee"
                class="px-3 py-1 rounded border border-gray-300 text-sm">
          ยกเลิก
        </button>
        <button id="btnSaveEmployee"
                class="px-3 py-1 rounded bg-emerald-600 hover:bg-emerald-700 text-white text-sm">
          บันทึก
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    /************************************
     * Global state
     ************************************/
    const STORAGE_KEY_URL = 'faceAttendanceWebAppUrl';

    let webAppUrl = localStorage.getItem(STORAGE_KEY_URL) || '';
    let branches = [];
    let levels = [];
    let employees = [];
    let currentPhotoDataUrl = '';

    // เผื่ออนาคตจะใช้ face-api matcher
    let faceMatcher = null;
    let videoStream = null;

    /************************************
     * Utility: call API
     ************************************/
    async function callApi(action, payload = {}) {
      if (!webAppUrl) {
        throw new Error('ยังไม่ได้ตั้งค่า Web App URL');
      }

      const body = JSON.stringify({
        action,
        ...payload
      });

      const res = await fetch(webAppUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body
      });

      const text = await res.text();
      let json;
      try {
        json = JSON.parse(text);
      } catch (err) {
        console.error('ไม่สามารถ parse JSON:', text);
        throw new Error('API response ไม่ใช่ JSON');
      }

      if (!json.ok) {
        throw new Error(json.error || 'API error');
      }
      return json.data;
    }

    /************************************
     * Web App URL modal
     ************************************/
    const webAppModal = document.getElementById('webAppModal');
    const webAppUrlInput = document.getElementById('webAppUrlInput');
    const webAppTestStatus = document.getElementById('webAppTestStatus');

    document.getElementById('btnResetUrl').addEventListener('click', () => {
      webAppUrlInput.value = webAppUrl || '';
      webAppTestStatus.textContent = '';
      webAppModal.classList.remove('hidden');
    });

    document.getElementById('btnCloseWebAppModal').addEventListener('click', () => {
      webAppModal.classList.add('hidden');
    });

    document.getElementById('btnSaveWebAppUrl').addEventListener('click', async () => {
      const url = webAppUrlInput.value.trim();
      if (!url) {
        alert('กรุณาวาง Web App URL');
        return;
      }
      webAppTestStatus.textContent = 'กำลังทดสอบการเชื่อมต่อ...';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'ping' })
        });
        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (e) {
          throw new Error('response ไม่ใช่ JSON: ' + text);
        }
        if (!json.ok) {
          throw new Error(json.error || 'ไม่สามารถ ping API ได้');
        }

        webAppUrl = url;
        localStorage.setItem(STORAGE_KEY_URL, webAppUrl);
        webAppTestStatus.textContent = 'เชื่อมต่อสำเร็จ ✔';
        webAppTestStatus.className = 'text-xs text-emerald-600 mb-3';

        webAppModal.classList.add('hidden');
        await initialLoad();
      } catch (err) {
        console.error(err);
        webAppTestStatus.textContent = 'เชื่อมต่อไม่สำเร็จ: ' + err.message;
        webAppTestStatus.className = 'text-xs text-rose-600 mb-3';
      }
    });

    /************************************
     * Employee modal
     ************************************/
    const employeeModal = document.getElementById('employeeModal');
    const empCodeEl = document.getElementById('empCode');
    const empFullNameEl = document.getElementById('empFullName');
    const empBranchEl = document.getElementById('empBranch');
    const empLevelEl = document.getElementById('empLevel');
    const empEmailEl = document.getElementById('empEmail');
    const empPhotoFileEl = document.getElementById('empPhotoFile');
    const empPhotoPreview = document.getElementById('empPhotoPreview');
    const empPhotoPlaceholder = document.getElementById('empPhotoPlaceholder');

    function openEmployeeModal() {
      // reset form
      empCodeEl.value = '';
      empFullNameEl.value = '';
      empBranchEl.value = '';
      empLevelEl.value = '';
      empEmailEl.value = '';
      empPhotoFileEl.value = '';
      currentPhotoDataUrl = '';
      empPhotoPreview.classList.add('hidden');
      empPhotoPlaceholder.classList.remove('hidden');

      // เติม dropdown แผนก/ระดับ
      fillBranchAndLevelOptions();

      employeeModal.classList.remove('hidden');
    }

    document.getElementById('btnAdmin').addEventListener('click', openEmployeeModal);
    document.getElementById('btnCloseEmployeeModal').addEventListener('click', () => {
      employeeModal.classList.add('hidden');
    });
    document.getElementById('btnCancelEmployee').addEventListener('click', () => {
      employeeModal.classList.add('hidden');
    });

    empPhotoFileEl.addEventListener('change', () => {
      const file = empPhotoFileEl.files[0];
      if (!file) {
        currentPhotoDataUrl = '';
        empPhotoPreview.classList.add('hidden');
        empPhotoPlaceholder.classList.remove('hidden');
        return;
      }

      const reader = new FileReader();
      reader.onload = e => {
        currentPhotoDataUrl = e.target.result; // data URL
        empPhotoPreview.src = currentPhotoDataUrl;
        empPhotoPreview.classList.remove('hidden');
        empPhotoPlaceholder.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('btnSaveEmployee').addEventListener('click', async () => {
      const code = empCodeEl.value.trim();
      const fullName = empFullNameEl.value.trim();
      const branch = empBranchEl.value.trim();
      const level = empLevelEl.value.trim();
      const email = empEmailEl.value.trim();

      if (!code || !fullName) {
        alert('กรุณากรอกรหัสพนักงานและชื่อ-สกุล');
        return;
      }
      if (!branch || !level) {
        alert('กรุณาเลือกแผนกและระดับ');
        return;
      }
      if (!currentPhotoDataUrl) {
        if (!confirm('ยังไม่ได้เลือกรูปหน้า ต้องการบันทึกเลยหรือไม่?')) {
          return;
        }
      }

      try {
        const result = await callApi('saveEmployee', {
          employee: {
            code,
            fullName,
            branch,
            level,
            email,
            photoDataUrl: currentPhotoDataUrl
          }
        });
        console.log('saveEmployee result', result);
        alert('บันทึกพนักงานสำเร็จ');
        employeeModal.classList.add('hidden');
        await loadEmployees(); // reload employees
      } catch (err) {
        console.error(err);
        alert('บันทึกพนักงานไม่สำเร็จ: ' + err.message);
      }
    });

    /************************************
     * โหลด config (Branches / Levels / Employees / Logs)
     ************************************/
    async function loadConfig() {
      try {
        const data = await callApi('getConfig');
        branches = data.branches || [];
        levels = data.levels || [];
        console.log('Config loaded', branches, levels);
        fillBranchAndLevelOptions();
      } catch (err) {
        console.error(err);
        alert('โหลดข้อมูลตั้งต้นไม่สำเร็จ: ' + err.message);
      }
    }

    function fillBranchAndLevelOptions() {
      // Branches
      empBranchEl.innerHTML =
        '<option value="">-- เลือกแผนก --</option>' +
        branches.map(b => `<option value="${b.name}">${b.name}</option>`).join('');

      // Levels
      empLevelEl.innerHTML =
        '<option value="">-- เลือกระดับ --</option>' +
        levels.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
    }

    async function loadEmployees() {
      try {
        employees = await callApi('getEmployees');
        console.log('Employees', employees);
        // อนาคต: ใช้สร้าง faceMatcher ได้
      } catch (err) {
        console.error(err);
        alert('โหลดรายชื่อพนักงานไม่สำเร็จ: ' + err.message);
      }
    }

    async function loadLogs() {
      try {
        const logs = await callApi('getLogs');
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = '';

        if (!logs || logs.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML =
            '<td colspan="7" class="px-3 py-3 text-center text-gray-400 text-sm">ยังไม่มีข้อมูลการลงเวลา</td>';
          tbody.appendChild(row);
          return;
        }

        logs.forEach(log => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-slate-50';
          tr.innerHTML = `
            <td class="px-3 py-2">${log.date || ''}</td>
            <td class="px-3 py-2">${log.code || ''}</td>
            <td class="px-3 py-2">${log.fullName || ''}</td>
            <td class="px-3 py-2">${log.branch || ''}</td>
            <td class="px-3 py-2">${log.timeIn || ''}</td>
            <td class="px-3 py-2">${log.timeOut || ''}</td>
            <td class="px-3 py-2">${log.status || ''}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        alert('โหลดข้อมูลลงเวลาไม่สำเร็จ: ' + err.message);
      }
    }

    document.getElementById('btnReloadDashboard')
      .addEventListener('click', loadLogs);

    /************************************
     * กล้อง + สแกน (ตอนนี้ยังไม่ผูก face-api)
     ************************************/
    const videoEl = document.getElementById('video');
    const overlayEl = document.getElementById('overlay');
    const videoPlaceholder = document.getElementById('videoPlaceholder');
    const cameraSelect = document.getElementById('cameraSelect');
    const cameraStatusText = document.getElementById('cameraStatusText');
    const scanStatus = document.getElementById('scanStatus');
    const btnStartScan = document.getElementById('btnStartScan');
    const btnStopScan = document.getElementById('btnStopScan');

    async function enumerateCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');

        if (videoDevices.length === 0) {
          cameraSelect.innerHTML =
            '<option value="">ไม่พบกล้อง</option>';
          cameraStatusText.textContent = 'ไม่พบกล้อง';
          return;
        }

        cameraSelect.innerHTML = videoDevices
          .map((d, idx) =>
            `<option value="${d.deviceId}">${d.label || 'กล้อง ' + (idx + 1)}</option>`
          )
          .join('');

        cameraStatusText.textContent = 'กล้องพร้อมใช้งาน';
      } catch (err) {
        console.error('enumerateDevices error', err);
        cameraSelect.innerHTML =
          '<option value="">ไม่สามารถเข้าถึงกล้อง</option>';
        cameraStatusText.textContent = 'ไม่สามารถเข้าถึงกล้อง';
      }
    }

    async function startScan() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('เบราว์เซอร์ไม่รองรับการใช้กล้อง');
        return;
      }

      const deviceId = cameraSelect.value;
      const constraints = {
        video: deviceId ? { deviceId: { exact: deviceId } } : true
      };

      try {
        if (videoStream) {
          videoStream.getTracks().forEach(t => t.stop());
        }

        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = videoStream;

        videoEl.classList.remove('hidden');
        videoPlaceholder.classList.add('hidden');

        btnStartScan.disabled = true;
        btnStopScan.disabled = false;
        scanStatus.textContent = 'กำลังสแกน...';

      } catch (err) {
        console.error('getUserMedia error', err);
        alert('ไม่สามารถเปิดกล้องได้: ' + err.message);
      }
    }

    function stopScan() {
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      videoEl.classList.add('hidden');
      videoPlaceholder.classList.remove('hidden');
      btnStartScan.disabled = false;
      btnStopScan.disabled = true;
      scanStatus.textContent = 'หยุดสแกนแล้ว';
    }

    btnStartScan.addEventListener('click', startScan);
    btnStopScan.addEventListener('click', stopScan);

    /************************************
     * initial load
     ************************************/
    async function initialLoad() {
      if (!webAppUrl) {
        // บังคับให้ตั้งค่า URL ก่อน
        webAppModal.classList.remove('hidden');
        return;
      }
      try {
        await loadConfig();
        await loadEmployees();
        await loadLogs();
      } catch (err) {
        console.error(err);
      }
    }

    window.addEventListener('load', async () => {
      await enumerateCameras();
      await initialLoad();
    });
  </script>
</body>
</html>
