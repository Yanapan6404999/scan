<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบลงเวลาพนักงาน</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <style>
    body { background:#f8fafc; }
    .card { margin-bottom:1rem; }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">ระบบลงเวลาพนักงาน</h3>
      <small class="text-muted">เวอร์ชันทดลองใช้ (บันทึกได้ 4 ช่วง)</small>
    </div>
    <div>
      <a href="admin.html" class="btn btn-dark">เจ้าหน้าที่ / HR</a>
    </div>
  </div>

  <!-- ปุ่มหลัก -->
  <div class="mb-3 d-flex gap-2">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#manualModal">
      บันทึกด้วยมือ (กรณีสแกนไม่ได้)
    </button>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#checkModal">
      ตรวจสอบเวลาวันนี้
    </button>
  </div>

  <!-- ผลการบันทึกล่าสุด -->
  <div class="card">
    <div class="card-header">ผลการบันทึกล่าสุด</div>
    <div class="card-body" id="lastLogBox">
      ยังไม่มีการบันทึกในหน้านี้
    </div>
  </div>

  <!-- ภาพรวมวันนี้ (ย่อ) -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>ภาพรวมวันนี้ (ย่อ)</span>
      <button class="btn btn-outline-secondary btn-sm" id="btnRefreshToday">รีเฟรชข้อมูล</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
          <tr>
            <th>รหัส</th>
            <th>ชื่อ</th>
            <th>เข้าเช้า</th>
            <th>ออกเที่ยง</th>
            <th>เข้าเที่ยง</th>
            <th>ออกเย็น</th>
          </tr>
          </thead>
          <tbody id="todayTableBody">
          <tr><td colspan="6" class="text-center text-muted">กำลังโหลด...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: บันทึกด้วยมือ -->
<div class="modal fade" id="manualModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">บันทึกเวลาด้วยตนเอง</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="manualForm">
          <div class="mb-3">
            <label class="form-label">รหัสพนักงาน</label>
            <input type="text" name="code" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">อัปโหลดรูปหลักฐาน (ใบลงเวลา / รูป Selfie ฯลฯ)</label>
            <input type="file" id="evidenceFile" accept="image/*" class="form-control">
            <div class="form-text">
              ไม่บังคับ แต่แนะนำให้มีรูปเพื่อให้ HR ตรวจสอบง่าย
            </div>
          </div>
          <div class="alert alert-secondary small">
            ระบบจะใช้เวลา ณ ตอนนี้เป็นเวลาเช็คชื่อ:  
            ครั้งที่ 1 = เข้าเช้า,  
            ครั้งที่ 2 = ออกเที่ยง,  
            ครั้งที่ 3 = เข้าเที่ยง,  
            ครั้งที่ 4 = ออกเย็น (ต่อวันต่อคน)
          </div>
        </form>
        <div id="manualResult" class="mt-2 small text-muted"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
        <button class="btn btn-primary" id="btnManualSubmit">ยืนยันบันทึก</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: ตรวจสอบเวลาวันนี้ -->
<div class="modal fade" id="checkModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ตรวจสอบเวลาวันนี้</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">รหัสพนักงาน</label>
          <input type="text" id="checkCode" class="form-control">
        </div>
        <button class="btn btn-primary mb-3" id="btnCheckToday">ตรวจสอบ</button>
        <div id="checkResult" class="small"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = 'PUT_YOUR_WEB_APP_URL_HERE';

/************* API HELPER *************/
async function callApi(action, data = {}) {
  const body = new URLSearchParams({ action, ...data });
  const res = await fetch(API_URL, { method: 'POST', body });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'Unknown error');
  return json.result;
}

/************* MANUAL LOG *************/
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    if (!file) return resolve('');
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

document.getElementById('btnManualSubmit').addEventListener('click', async () => {
  const form = document.getElementById('manualForm');
  const code = form.code.value.trim();
  if (!code) {
    alert('กรุณากรอกรหัสพนักงาน');
    return;
  }

  const file = document.getElementById('evidenceFile').files[0];
  const base64 = await fileToBase64(file);

  try {
    const result = await callApi('logScan', {
      code,
      evidenceBase64: base64,
      rawType: 'MANUAL'
    });
    document.getElementById('manualResult').innerText =
      `${result.message || ''} เวลา ${result.time || ''}`;
    document.getElementById('lastLogBox').innerText =
      `รหัส ${code} : ${result.message || ''} เวลา ${result.time || ''}`;
    loadTodayOverview();
  } catch (err) {
    alert('บันทึกไม่สำเร็จ: ' + err.message);
  }
});

/************* CHECK TODAY BY CODE *************/
document.getElementById('btnCheckToday').addEventListener('click', async () => {
  const code = document.getElementById('checkCode').value.trim();
  if (!code) {
    alert('กรุณากรอกรหัสพนักงาน');
    return;
  }
  const box = document.getElementById('checkResult');
  box.innerHTML = 'กำลังโหลด...';

  try {
    const r = await callApi('checkTodayByCode', { code });
    if (!r.hasData) {
      box.innerHTML = `<div class="alert alert-warning">${r.message}</div>`;
      return;
    }
    box.innerHTML = `
      <div class="mb-2"><strong>วันที่:</strong> ${r.date}</div>
      <table class="table table-sm">
        <tr><th>เข้าเช้า</th><td>${r.inMorning || '-'}</td><td>${r.statusMorning || '-'}</td></tr>
        <tr><th>ออกเที่ยง</th><td>${r.outLunch || '-'}</td><td>${r.statusLunch || '-'}</td></tr>
        <tr><th>เข้าเที่ยง</th><td>${r.inAfternoon || '-'}</td><td>-</td></tr>
        <tr><th>ออกเย็น</th><td>${r.outEvening || '-'}</td><td>${r.statusEvening || '-'}</td></tr>
      </table>
    `;
  } catch (err) {
    box.innerHTML = `<div class="alert alert-danger">ตรวจสอบไม่สำเร็จ: ${err.message}</div>`;
  }
});

/************* TODAY OVERVIEW (TABLE) *************/
async function loadTodayOverview() {
  const tbody = document.getElementById('todayTableBody');
  tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">กำลังโหลด...</td></tr>';

  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const tzOffset = now.getTimezoneOffset() * 60000;
  const todayStr = new Date(Date.now() - tzOffset).toISOString().slice(0,10); // yyyy-MM-dd

  try {
    const r = await callApi('getLogsRange', { year, month, branch: 'ALL', search: '' });
    const logs = (r.logs || []).filter(log => log.date === todayStr);

    // group by code + fullName
    const map = {};
    logs.forEach(log => {
      const key = log.code + '|' + (log.fullName || '');
      if (!map[key]) map[key] = [];
      map[key].push(log);
    });

    const rows = [];
    Object.keys(map).forEach(key => {
      const [code, name] = key.split('|');
      const arr = map[key];

      arr.sort((a,b) => String(a.timeIn || '').localeCompare(String(b.timeIn || '')));

      const first  = arr[0] || {};
      const second = arr[1] || {};

      const inMorning   = first.timeIn  || '';
      const outLunch    = first.timeOut || '';
      const inAfternoon = second.timeIn || '';
      const outEvening  = second.timeOut|| '';

      rows.push({ code, name, inMorning, outLunch, inAfternoon, outEvening });
    });

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">วันนี้ยังไม่มีการบันทึกเวลา</td></tr>';
      return;
    }

    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${r.code}</td>
        <td>${r.name || '-'}</td>
        <td>${r.inMorning || '-'}</td>
        <td>${r.outLunch || '-'}</td>
        <td>${r.inAfternoon || '-'}</td>
        <td>${r.outEvening || '-'}</td>
      </tr>
    `).join('');
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">โหลดไม่สำเร็จ: ${err.message}</td></tr>`;
  }
}

document.getElementById('btnRefreshToday').addEventListener('click', loadTodayOverview);
window.addEventListener('load', loadTodayOverview);
</script>
</body>
</html>
