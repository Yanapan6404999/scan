<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Face Attendance ‚Äì Check-in</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --radius: 18px;
      --radius2: 14px;
      --pad: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Prompt", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1000px 600px at 20% 0%, #eef2ff 0%, transparent 70%) , var(--bg);
    }
    a{color:var(--primary); text-decoration:none}
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 14px 14px calc(84px + env(safe-area-inset-bottom));
    }

    /* ‚úÖ emoji: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô */
    .m-emoji{display:inline}
    @media (min-width: 980px){
      .m-emoji{display:none}
    }

    /* Header */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 10px 0;
      background: linear-gradient(to bottom, rgba(246,247,251,.92), rgba(246,247,251,.70), rgba(246,247,251,0));
      backdrop-filter: blur(10px);
    }
    .topbar-row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 6px 2px;
      position: relative; /* ‚úÖ ‡πÉ‡∏ä‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏ö‡∏ô PC */
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
    }
    .brand .t1{font-weight:700; font-size:16px; letter-spacing:.2px}
    .brand .t2{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px; flex-wrap:wrap;}

    .iconbtn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:.15s ease;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
    }
    .iconbtn:hover{transform: translateY(-1px)}
    .dot{
      width:10px; height:10px; border-radius:999px; background: var(--bad);
      box-shadow: 0 0 0 4px rgba(239,68,68,.15);
    }
    .dot.ok{background:var(--good); box-shadow: 0 0 0 4px rgba(22,163,74,.15)}
    .dot.warn{background:var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.18)}

    /* ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PC) */
    .apiStatus{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.85);
      border-radius: 999px;
      padding: 8px 10px;
      box-shadow: 0 6px 18px rgba(15,23,42,.06);
      white-space: nowrap;
    }
    @media (min-width: 980px){
      .apiStatus{
        position:absolute;
        right: 0;
        bottom: -6px; /* ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô/‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß */
      }
    }

    /* ‚úÖ ‡∏õ‡∏∏‡πà‡∏° 3 ‡∏Ç‡∏µ‡∏î: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ / PC ‡∏ã‡πà‡∏≠‡∏ô */
    .hambico{font-size:16px; line-height:1}
    @media (min-width: 980px){
      .hambico{display:none;}
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (min-width: 980px){
      .wrap{padding-bottom: 20px}
      .grid{
        grid-template-columns: 1.2fr .8fr;
        align-items:start;
      }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(229,231,235,.75);
      background: linear-gradient(to bottom, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .card-h .title{
      font-weight: 700;
      font-size: 15px;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size: 11px;
      color: var(--muted);
      border: 1px solid var(--border);
      background: #fff;
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .card-b{padding: 14px}

    /* Tabs */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.08);
      color: var(--primary2);
      font-weight: 600;
    }

    /* Form */
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1; min-width: 140px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 11px 12px;
      background:#fff;
      outline:none;
      font-family: inherit;
      font-size: 14px;
    }
    textarea{min-height: 88px; resize: vertical}

    .btnbar{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding: 11px 12px;
      cursor:pointer;
      font-weight:600;
      font-size: 14px;
      transition:.15s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(37,99,235,.98), rgba(29,78,216,.98));
      border-color: rgba(29,78,216,.55);
      color:#fff;
      box-shadow: 0 10px 22px rgba(37,99,235,.22);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(22,163,74,.98), rgba(21,128,61,.98));
      border-color: rgba(21,128,61,.55);
      color:#fff;
      box-shadow: 0 10px 22px rgba(22,163,74,.20);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.98), rgba(220,38,38,.98));
      border-color: rgba(220,38,38,.55);
      color:#fff;
      box-shadow: 0 10px 22px rgba(239,68,68,.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,.85);
    }
    .help{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
      margin-top: 10px;
    }

    /* Camera */
    .cam{
      border:1px dashed rgba(148,163,184,.65);
      border-radius: 16px;
      background: linear-gradient(180deg, #f8fafc, #ffffff);
      padding: 12px;
    }
    .cambox{
      position: relative;
      aspect-ratio: 16/9;
      width: 100%;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(226,232,240,.9);
      background: #0b1220;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    video{
      width:100%;
      height:100%;
      object-fit: cover;
      display:none;
    }
    .camhint{
      color: rgba(255,255,255,.78);
      text-align:center;
      padding: 18px;
      font-size: 13px;
      line-height: 1.5;
    }
    .preview{
      margin-top: 10px;
      display:none;
      gap:10px;
      align-items:center;
    }
    .thumb{
      width: 96px;
      height: 72px;
      border-radius: 12px;
      border:1px solid var(--border);
      object-fit: cover;
      background:#fff;
    }
    .smallmuted{font-size:12px; color:var(--muted)}

    /* Toast */
    .toast{
      position: fixed;
      left: 14px; right: 14px;
      bottom: calc(14px + 70px + env(safe-area-inset-bottom));
      z-index: 50;
      display:none;
    }
    @media (min-width: 980px){
      .toast{
        left: 50%;
        transform: translateX(-50%);
        width: 520px;
        bottom: 18px;
      }
    }
    .toast-in{
      background: rgba(15,23,42,.92);
      color:#fff;
      padding: 12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(15,23,42,.25);
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .toast .tmsg{font-size:13px; line-height:1.45}
    .toast .tclose{
      background: transparent;
      border: none;
      color: rgba(255,255,255,.8);
      cursor:pointer;
      font-size: 16px;
      padding: 2px 6px;
    }

    /* Bottom nav (Mobile) */
    .bottomnav{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 25;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(246,247,251,.85);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.85);
      display:flex;
      gap:10px;
      justify-content:space-between;
    }
    .bn-btn{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:3px;
      padding: 10px 8px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.85);
      font-size: 11px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .bn-btn.active{
      color: var(--primary2);
      border-color: rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      font-weight: 600;
    }
    .bn-ico{font-size: 16px; line-height:1}
    @media (min-width: 980px){
      .bottomnav{display:none}
    }

    /* Drawer */
    .drawer-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.35);
      z-index: 40;
      display:none;
    }
    .drawer{
      position: fixed;
      top: 0; right: 0;
      width: min(420px, 92vw);
      height: 100%;
      background: #fff;
      border-left: 1px solid var(--border);
      box-shadow: -20px 0 60px rgba(15,23,42,.20);
      z-index: 41;
      transform: translateX(110%);
      transition: .18s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .drawer-h{
      padding: 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawer-h .dtitle{font-weight: 800}
    .drawer-b{padding: 14px; overflow:auto}
    .divider{height:1px; background: rgba(229,231,235,.9); margin: 14px 0}
    .mini{
      font-size:12px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* Sections show/hide */
    .section{display:none}
    .section.active{display:block}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="topbar-row">
        <div class="brand">
          <div class="t1"><span class="m-emoji">üïí </span>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>

          <!-- ‚úÖ ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏° / PC ‡∏à‡∏∞‡∏•‡∏≠‡∏¢‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ .apiStatus -->
          <div class="t2">
            <span><span class="m-emoji">üîå </span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API:</span>

            <!-- ‚úÖ ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ ‚Äú‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‚Äù (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÅ‡∏î‡∏á) -->
            <span class="apiStatus" id="apiStatus">
              <span id="apiDot" class="dot warn"></span>
              <span id="apiText" style="font-weight:700;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
            </span>
          </div>
        </div>

        <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (‡∏°‡∏µ 3 ‡∏Ç‡∏µ‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ / PC ‡∏ã‡πà‡∏≠‡∏ô 3 ‡∏Ç‡∏µ‡∏î) -->
        <button class="iconbtn" id="btnOpenDrawer" type="button" title="‡πÄ‡∏°‡∏ô‡∏π/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">
          <span class="hambico">‚ò∞</span>
          <span style="font-size:16px">‚öôÔ∏è</span>
          <span style="font-weight:700"><span class="m-emoji">üß© </span>‡πÄ‡∏°‡∏ô‡∏π</span>
        </button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Main -->
      <div class="card">
        <div class="card-h">
          <div>
            <p class="title"><span class="m-emoji">üì∑ </span>‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)</p>
            <div class="smallmuted"><span class="m-emoji">üßæ </span>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô + (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) GPS + ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Apps Script</div>
          </div>
          <div class="badge" id="nowBadge">‚Äî</div>
        </div>

        <div class="card-b">
          <!-- Tabs (Desktop) -->
          <div class="tabs" style="display:none" id="desktopTabs">
            <div class="tab active" data-target="secScan">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å</div>
            <div class="tab" data-target="secManual">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</div>
            <div class="tab" data-target="secCheck">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <div class="tab" data-target="secHR">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà/HR</div>
          </div>

          <!-- SECTION: Scan -->
          <div class="section active" id="secScan">
            <div class="cam">
              <div class="cambox">
                <video id="video" playsinline muted></video>
                <div class="camhint" id="camHint">
                  ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà<br>
                  ‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </div>
              </div>

              <div style="margin-top:12px" class="row">
                <div class="col">
                  <label><span class="m-emoji">üé• </span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
                  <select id="cameraSelect">
                    <option value="">‚Äî</option>
                  </select>
                </div>
                <div class="col" style="min-width: 160px;">
                  <label><span class="m-emoji">üß≠ </span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                  <select id="scanType">
                    <option value="IN">‡πÄ‡∏Ç‡πâ‡∏≤</option>
                    <option value="OUT">‡∏≠‡∏≠‡∏Å</option>
                  </select>
                </div>
              </div>

              <div class="btnbar" style="margin-top:10px">
                <button class="btn primary" id="btnStartCam" type="button"><span class="m-emoji">‚ñ∂Ô∏è </span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button class="btn danger" id="btnStopCam" type="button"><span class="m-emoji">‚èπÔ∏è </span>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                <button class="btn" id="btnCapture" type="button"><span class="m-emoji">üì∏ </span>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
              </div>

              <div class="preview" id="previewRow">
                <img id="thumb" class="thumb" alt="preview">
                <div>
                  <div style="font-weight:800"><span class="m-emoji">‚úÖ </span>‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
                  <div class="smallmuted" id="previewInfo">‚Äî</div>
                </div>
              </div>

              <div class="help">
                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‚Äú‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‚Äù ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
              </div>
            </div>

            <div style="margin-top:14px" class="row">
              <div class="col">
                <label><span class="m-emoji">üÜî </span>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input id="scanCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" />
              </div>
              <div class="col">
                <label><span class="m-emoji">üìù </span>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input id="scanNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ï‡∏£ / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤" />
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <div class="col">
                <label><span class="m-emoji">üìç </span>‡πÉ‡∏ä‡πâ GPS (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)</label>
                <select id="useGps">
                  <option value="1" selected>‡πÄ‡∏õ‡∏¥‡∏î</option>
                  <option value="0">‡∏õ‡∏¥‡∏î</option>
                </select>
              </div>
              <div class="col">
                <label><span class="m-emoji">üìé </span>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input id="scanEvidence" type="file" accept="image/*" />
              </div>
            </div>

            <div class="btnbar" style="margin-top:14px">
              <button class="btn good" id="btnSubmitScan" type="button"><span class="m-emoji">‚úÖ </span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</button>
              <button class="btn ghost" id="btnQuickCheck" type="button"><span class="m-emoji">üîé </span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            </div>

            <div class="help">
              ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á): ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 08:00 / ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô 1 ‡∏ä‡∏°. / ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á 17:00 (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ô GS ‡πÑ‡∏î‡πâ)
            </div>
          </div>

          <!-- SECTION: Manual -->
          <div class="section" id="secManual">
            <div class="row">
              <div class="col">
                <label><span class="m-emoji">üÜî </span>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input id="mCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" />
              </div>
              <div class="col">
                <label><span class="m-emoji">üß≠ </span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                <select id="mType">
                  <option value="IN">‡πÄ‡∏Ç‡πâ‡∏≤</option>
                  <option value="OUT">‡∏≠‡∏≠‡∏Å</option>
                </select>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <div class="col">
                <label><span class="m-emoji">üìù </span>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="mReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∑‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ / ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏° / ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß"></textarea>
              </div>
            </div>

            <div class="row" style="margin-top:12px">
              <div class="col">
                <label><span class="m-emoji">üìç </span>‡πÉ‡∏ä‡πâ GPS</label>
                <select id="mUseGps">
                  <option value="1" selected>‡πÄ‡∏õ‡∏¥‡∏î</option>
                  <option value="0">‡∏õ‡∏¥‡∏î</option>
                </select>
              </div>
              <div class="col">
                <label><span class="m-emoji">üìé </span>‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input id="mEvidence" type="file" accept="image/*" />
              </div>
            </div>

            <div class="btnbar" style="margin-top:14px">
              <button class="btn good" id="btnSubmitManual" type="button"><span class="m-emoji">‚úÖ </span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</button>
            </div>

            <div class="help">
              ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ HR ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡∏≠‡∏ô ‚Äú‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏ï‡∏¥‡∏° log‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
            </div>
          </div>

          <!-- SECTION: Check -->
          <div class="section" id="secCheck">
            <div class="row">
              <div class="col">
                <label><span class="m-emoji">üÜî </span>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input id="cCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" />
              </div>
              <div class="col">
                <label><span class="m-emoji">üìÖ </span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input id="cDate" type="date" />
              </div>
            </div>

            <div class="btnbar" style="margin-top:14px">
              <button class="btn primary" id="btnCheckByCode" type="button"><span class="m-emoji">üîé </span>‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
              <button class="btn" id="btnTodaySummary" type="button"><span class="m-emoji">üìä </span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            </div>

            <div class="card" style="margin-top:14px; box-shadow:none">
              <div class="card-h">
                <p class="title"><span class="m-emoji">üßæ </span>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>
                <div class="badge" id="resultBadge">‚Äî</div>
              </div>
              <div class="card-b" id="resultBox" style="min-height: 120px;">
                <div class="smallmuted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏î ‚Äú‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù</div>
              </div>
            </div>
          </div>

          <!-- SECTION: HR -->
          <div class="section" id="secHR">
            <div class="row">
              <div class="col">
                <label>Username</label>
                <input id="hrUser" placeholder="admin" />
              </div>
              <div class="col">
                <label>Password</label>
                <input id="hrPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
              </div>
            </div>

            <div class="btnbar" style="margin-top:14px">
              <button class="btn primary" id="btnLogin" type="button"><span class="m-emoji">üîê </span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
              <a class="btn" id="btnGoAdmin" href="./admin.html" target="_blank" rel="noopener" style="pointer-events:none; opacity:.55">
                <span class="m-emoji">üß∞ </span>‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ admin.html
              </a>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="col">
                <label><span class="m-emoji">üßë‚Äçüíº </span>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (HR) ‚Äì ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input id="regCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1001" />
              </div>
              <div class="col">
                <label><span class="m-emoji">üñºÔ∏è </span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏ñ‡πà‡∏≤‡∏¢/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå)</label>
                <input id="regFace" type="file" accept="image/*" />
              </div>
            </div>

            <div class="btnbar" style="margin-top:14px">
              <button class="btn good" id="btnUploadFace" type="button"><span class="m-emoji">‚¨ÜÔ∏è </span>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
            </div>

            <div class="help">
              * ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action: <b>uploadEmployeeFace</b> (‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Compact status only (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß) -->
      <div class="card">
        <div class="card-h">
          <p class="title"><span class="m-emoji">üìå </span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
          <div class="badge" id="deviceBadge">‚Äî</div>
        </div>
        <div class="card-b">
          <div style="display:flex; flex-direction:column; gap:10px">
            <div class="card" style="box-shadow:none">
              <div class="card-h">
                <p class="title"><span class="m-emoji">‚úÖ </span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                <div class="badge" id="lastBadge">‚Äî</div>
              </div>
              <div class="card-b" id="lastBox">
                <div class="smallmuted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none">
              <div class="card-h">
                <p class="title"><span class="m-emoji">‚ö° </span>‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î</p>
                <div class="badge">‡πÑ‡∏°‡πà‡∏£‡∏Å</div>
              </div>
              <div class="card-b">
                <div class="btnbar">
                  <button class="btn" type="button" id="btnOpenUrl"><span class="m-emoji">üîó </span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
                  <button class="btn" type="button" id="btnPing"><span class="m-emoji">üì° </span>‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
                  <button class="btn" type="button" id="btnClearLocal"><span class="m-emoji">üßπ </span>‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
                </div>
                <div class="help">
                  ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡πÄ‡∏•‡∏¢‡∏ï‡∏±‡∏î ‚Äú‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‚Äù ‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bottom nav (mobile) -->
  <div class="bottomnav" id="bottomNav">
    <div class="bn-btn active" data-target="secScan"><div class="bn-ico">üì∑</div>‡∏™‡πÅ‡∏Å‡∏ô</div>
    <div class="bn-btn" data-target="secManual"><div class="bn-ico">üìù</div>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
    <div class="bn-btn" data-target="secCheck"><div class="bn-ico">üîé</div>‡πÄ‡∏ä‡πá‡∏Ñ</div>
    <div class="bn-btn" data-target="secHR"><div class="bn-ico">üß∞</div>HR</div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <div class="drawer" id="drawer">
    <div class="drawer-h">
      <div class="dtitle">‡πÄ‡∏°‡∏ô‡∏π / ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
      <button class="btn" type="button" id="btnCloseDrawer">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="drawer-b">
      <label>URL Web App (Apps Script)</label>
      <input id="apiUrlInput" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå .../exec" />
      <div class="btnbar" style="margin-top:12px">
        <button class="btn primary" id="btnSaveUrl" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL</button>
        <button class="btn" id="btnResetUrl" type="button">‚ôªÔ∏è Reset URL</button>
      </div>

      <div class="divider"></div>

      <div class="mini">
        <b>‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á Action ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (‡∏õ‡∏£‡∏±‡∏ö‡∏ù‡∏±‡πà‡∏á GS ‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)</b><br>
        - loginAdmin<br>
        - saveManualLog (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏™‡πÅ‡∏Å‡∏ô + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠)<br>
        - getTodayByCode<br>
        - getTodaySummary<br>
        - uploadEmployeeFace
      </div>

      <div class="divider"></div>

      <div class="btnbar">
        <a class="btn" href="./admin.html" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î admin.html</a>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <div class="toast-in">
      <div class="tmsg" id="toastMsg">‚Äî</div>
      <button class="tclose" id="toastClose" aria-label="close">‚úï</button>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG / STATE
    // =========================
    const LS_API = "attendance_api_url_v2";
    const LS_ADMIN_TOKEN = "attendance_admin_token_v1";
    const LS_LAST_RESULT = "attendance_last_result_v1";

    let stream = null;
    let lastCapturedBlob = null;
    let lastCapturedInfo = null;

    // =========================
    // UTIL
    // =========================
    const $ = (id) => document.getElementById(id);
    const fmtDT = (d=new Date()) => {
      const pad = (n) => String(n).padStart(2,"0");
      return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()+543} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };
    const isMobile = () => window.matchMedia("(max-width: 979px)").matches;

    function toast(msg){
      $("toastMsg").textContent = msg;
      $("toast").style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{$("toast").style.display="none"}, 3500);
    }
    $("toastClose").addEventListener("click", ()=> $("toast").style.display="none");

    // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ / ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß‚Äù
    function setApiStatus(state){
      const dot = $("apiDot");
      const text = $("apiText");

      if(state === "ok"){
        dot.className = "dot ok";
        text.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
        return;
      }
      if(state === "bad"){
        dot.className = "dot";
        text.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
        return;
      }
      // warn = ‡∏°‡∏µ URL ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö
      dot.className = "dot warn";
      text.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö";
    }

    function getApiUrl(){
      return (localStorage.getItem(LS_API) || "").trim();
    }
    function setApiUrl(url){
      localStorage.setItem(LS_API, (url||"").trim());
      // ‡∏°‡∏µ URL ‡πÅ‡∏•‡πâ‡∏ß -> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö
      setApiStatus(getApiUrl() ? "warn" : "bad");
    }

    function setNowBadges(){
      $("nowBadge").textContent = fmtDT();
      $("deviceBadge").textContent = isMobile() ? "Mobile" : "Desktop";
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      $("cDate").value = `${yyyy}-${mm}-${dd}`;
    }

    function saveLastResult(obj){
      localStorage.setItem(LS_LAST_RESULT, JSON.stringify(obj));
      renderLastResult();
    }
    function renderLastResult(){
      const raw = localStorage.getItem(LS_LAST_RESULT);
      if(!raw){ return; }
      try{
        const obj = JSON.parse(raw);
        $("lastBadge").textContent = obj.time || "‚Äî";
        $("lastBox").innerHTML = `
          <div style="font-weight:800">${escapeHtml(obj.title || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")}</div>
          <div class="smallmuted" style="margin-top:6px">${escapeHtml(obj.detail || "")}</div>
        `;
      }catch(e){}
    }
    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // API
    // =========================
    async function apiPost(action, payload={}, fileMap=null){
      const apiUrl = getApiUrl();
      if(!apiUrl) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL (Apps Script)");

      let body;
      let headers = {};

      if(fileMap){
        body = new FormData();
        body.append("action", action);
        Object.entries(payload||{}).forEach(([k,v])=>{
          if(v === undefined || v === null) return;
          body.append(k, typeof v === "object" ? JSON.stringify(v) : String(v));
        });
        Object.entries(fileMap).forEach(([k,file])=>{
          if(file) body.append(k, file);
        });
      }else{
        headers["Content-Type"] = "application/json";
        body = JSON.stringify({ action, ...payload });
      }

      const res = await fetch(apiUrl, { method:"POST", headers, body });
      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); }catch(e){ data = { ok: res.ok, raw: text }; }
      if(!res.ok) throw new Error((data && (data.message || data.error)) || `HTTP ${res.status}`);
      return data;
    }

    // =========================
    // GPS
    // =========================
    function getGPS(){
      return new Promise((resolve)=>{
        if(!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(
          (pos)=> resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy }),
          ()=> resolve(null),
          { enableHighAccuracy:true, timeout:8000, maximumAge: 0 }
        );
      });
    }

    // =========================
    // CAMERA
    // =========================
    async function loadCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d=>d.kind==="videoinput");
        $("cameraSelect").innerHTML = cams.map((c,i)=>`<option value="${c.deviceId}">${c.label || ("Camera " + (i+1))}</option>`).join("");
        if(cams.length && !$("cameraSelect").value) $("cameraSelect").value = cams[0].deviceId;
      }catch(e){}
    }

    async function startCamera(){
      stopCamera();
      const deviceId = $("cameraSelect").value || undefined;
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "user" },
          audio: false
        });
        const v = $("video");
        v.srcObject = stream;
        await v.play();
        v.style.display = "block";
        $("camHint").style.display = "none";
        toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
      }catch(err){
        stopCamera();
        toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    }

    function stopCamera(){
      const v = $("video");
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      v.pause();
      v.srcObject = null;
      v.style.display = "none";
      $("camHint").style.display = "block";
    }

    function capture(){
      const v = $("video");
      if(!stream || v.readyState < 2){
        toast("‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
        return;
      }
      const canvas = document.createElement("canvas");
      const w = v.videoWidth || 1280;
      const h = v.videoHeight || 720;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(v, 0, 0, w, h);

      canvas.toBlob((blob)=>{
        if(!blob){ toast("‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
        lastCapturedBlob = blob;
        lastCapturedInfo = { w, h, size: blob.size, time: new Date().toISOString() };
        $("thumb").src = URL.createObjectURL(blob);
        $("previewInfo").textContent = `‡∏Ç‡∏ô‡∏≤‡∏î ${w}√ó${h} | ${(blob.size/1024).toFixed(0)} KB`;
        $("previewRow").style.display = "flex";
        toast("‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      }, "image/jpeg", 0.85);
    }

    // =========================
    // UI NAV
    // =========================
    function showSection(id){
      ["secScan","secManual","secCheck","secHR"].forEach(s=>{
        $(s).classList.toggle("active", s===id);
      });

      document.querySelectorAll("#desktopTabs .tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.target === id);
      });
      document.querySelectorAll("#bottomNav .bn-btn").forEach(b=>{
        b.classList.toggle("active", b.dataset.target === id);
      });
    }

    function syncNavMode(){
      $("desktopTabs").style.display = isMobile() ? "none" : "flex";
    }
    window.addEventListener("resize", syncNavMode);

    document.querySelectorAll("#desktopTabs .tab").forEach(t=>{
      t.addEventListener("click", ()=> showSection(t.dataset.target));
    });
    document.querySelectorAll("#bottomNav .bn-btn").forEach(b=>{
      b.addEventListener("click", ()=> showSection(b.dataset.target));
    });

    // =========================
    // DRAWER
    // =========================
    function openDrawer(){
      $("drawerBackdrop").style.display = "block";
      $("drawer").classList.add("open");
      $("apiUrlInput").value = getApiUrl();
    }
    function closeDrawer(){
      $("drawerBackdrop").style.display = "none";
      $("drawer").classList.remove("open");
    }
    $("btnOpenDrawer").addEventListener("click", openDrawer);
    $("btnCloseDrawer").addEventListener("click", closeDrawer);
    $("drawerBackdrop").addEventListener("click", closeDrawer);

    $("btnSaveUrl").addEventListener("click", ()=>{
      const url = $("apiUrlInput").value.trim();
      if(!url){ toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á URL /exec"); return; }
      setApiUrl(url);
      toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß");
      closeDrawer();
    });
    $("btnResetUrl").addEventListener("click", ()=>{
      localStorage.removeItem(LS_API);
      setApiStatus("bad");
      toast("Reset URL ‡πÅ‡∏•‡πâ‡∏ß");
    });

    // Quick buttons
    $("btnOpenUrl").addEventListener("click", openDrawer);
    $("btnClearLocal").addEventListener("click", ()=>{
      localStorage.removeItem(LS_ADMIN_TOKEN);
      localStorage.removeItem(LS_LAST_RESULT);
      toast("‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
      renderLastResult();
      $("btnGoAdmin").style.pointerEvents = "none";
      $("btnGoAdmin").style.opacity = ".55";
    });

    // ‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡πÅ‡∏î‡∏á
    $("btnPing").addEventListener("click", async ()=>{
      try{
        await apiPost("getTodaySummary", { ts: Date.now() });
        setApiStatus("ok");
        toast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      }catch(e){
        setApiStatus(getApiUrl() ? "bad" : "bad");
        toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + e.message);
      }
    });

    // =========================
    // ACTIONS
    // =========================
    $("btnStartCam").addEventListener("click", startCamera);
    $("btnStopCam").addEventListener("click", ()=>{ stopCamera(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); });
    $("btnCapture").addEventListener("click", capture);

    $("btnSubmitScan").addEventListener("click", async ()=>{
      try{
        const code = $("scanCode").value.trim();
        const type = $("scanType").value;
        const note = $("scanNote").value.trim();

        if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        const gps = ($("useGps").value === "1") ? await getGPS() : null;

        const payload = {
          employeeCode: code,
          type,
          note,
          gps,
          source: "scan",
          device: isMobile() ? "mobile" : "desktop",
          captured: lastCapturedInfo || null,
          clientTime: new Date().toISOString()
        };

        const evidenceFile = $("scanEvidence").files && $("scanEvidence").files[0] ? $("scanEvidence").files[0] : null;
        const photoFile = lastCapturedBlob ? new File([lastCapturedBlob], `capture_${Date.now()}.jpg`, { type: "image/jpeg" }) : null;

        const res = await apiPost("saveManualLog", payload, { photo: photoFile, evidence: evidenceFile });

        $("resultBadge").textContent = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        $("resultBox").innerHTML = `<div style="font-weight:800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ</div><div class="smallmuted" style="margin-top:6px">${escapeHtml(JSON.stringify(res))}</div>`;
        saveLastResult({
          time: fmtDT(),
          title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${type==="IN"?"‡πÄ‡∏Ç‡πâ‡∏≤":"‡∏≠‡∏≠‡∏Å"} ‚Äì ‡∏£‡∏´‡∏±‡∏™ ${code}`,
          detail: note ? ("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: " + note) : "‚Äî"
        });
        toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        setApiStatus("ok");

      }catch(e){
        $("resultBadge").textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        $("resultBox").innerHTML = `<div style="font-weight:800; color: var(--bad)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div><div class="smallmuted" style="margin-top:6px">${escapeHtml(e.message)}</div>`;
        toast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        setApiStatus(getApiUrl() ? "bad" : "bad");
      }
    });

    $("btnQuickCheck").addEventListener("click", ()=>{
      showSection("secCheck");
      $("cCode").value = $("scanCode").value.trim();
      setTimeout(()=> $("btnCheckByCode").click(), 80);
    });

    $("btnSubmitManual").addEventListener("click", async ()=>{
      try{
        const code = $("mCode").value.trim();
        const type = $("mType").value;
        const reason = $("mReason").value.trim();
        if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        if(!reason) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏");

        const gps = ($("mUseGps").value === "1") ? await getGPS() : null;
        const evidenceFile = $("mEvidence").files && $("mEvidence").files[0] ? $("mEvidence").files[0] : null;

        const payload = {
          employeeCode: code,
          type,
          note: reason,
          gps,
          source: "manual",
          device: isMobile() ? "mobile" : "desktop",
          clientTime: new Date().toISOString()
        };

        const res = await apiPost("saveManualLog", payload, { evidence: evidenceFile });

        $("resultBadge").textContent = "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        $("resultBox").innerHTML = `<div style="font-weight:800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ</div><div class="smallmuted" style="margin-top:6px">${escapeHtml(JSON.stringify(res))}</div>`;
        saveLastResult({
          time: fmtDT(),
          title: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠${type==="IN"?"‡πÄ‡∏Ç‡πâ‡∏≤":"‡∏≠‡∏≠‡∏Å"} ‚Äì ‡∏£‡∏´‡∏±‡∏™ ${code}`,
          detail: reason
        });
        toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        setApiStatus("ok");

      }catch(e){
        toast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        setApiStatus(getApiUrl() ? "bad" : "bad");
      }
    });

    $("btnCheckByCode").addEventListener("click", async ()=>{
      try{
        const code = $("cCode").value.trim();
        const date = $("cDate").value;
        if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");

        const res = await apiPost("getTodayByCode", { employeeCode: code, date });
        $("resultBadge").textContent = "‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß";
        $("resultBox").innerHTML = `
          <div style="font-weight:800">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ: ‡∏£‡∏´‡∏±‡∏™ ${escapeHtml(code)}</div>
          <pre style="margin-top:10px; background:#0b1220; color:#e5e7eb; padding:12px; border-radius:14px; overflow:auto; border:1px solid rgba(255,255,255,.08)">${escapeHtml(JSON.stringify(res, null, 2))}</pre>
        `;
        toast("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        setApiStatus("ok");
      }catch(e){
        $("resultBadge").textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        $("resultBox").innerHTML = `<div style="font-weight:800; color: var(--bad)">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div><div class="smallmuted" style="margin-top:6px">${escapeHtml(e.message)}</div>`;
        toast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        setApiStatus(getApiUrl() ? "bad" : "bad");
      }
    });

    $("btnTodaySummary").addEventListener("click", async ()=>{
      try{
        const res = await apiPost("getTodaySummary", { date: $("cDate").value });
        $("resultBadge").textContent = "‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
        $("resultBox").innerHTML = `
          <div style="font-weight:800">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          <pre style="margin-top:10px; background:#0b1220; color:#e5e7eb; padding:12px; border-radius:14px; overflow:auto; border:1px solid rgba(255,255,255,.08)">${escapeHtml(JSON.stringify(res, null, 2))}</pre>
        `;
        toast("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        setApiStatus("ok");
      }catch(e){
        toast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        setApiStatus(getApiUrl() ? "bad" : "bad");
      }
    });

    $("btnLogin").addEventListener("click", async ()=>{
      try{
        const username = $("hrUser").value.trim();
        const password = $("hrPass").value;
        if(!username || !password) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username/Password");

        const res = await apiPost("loginAdmin", { username, password });
        const token = res.token || res.data?.token || "ok";
        localStorage.setItem(LS_ADMIN_TOKEN, token);

        $("btnGoAdmin").style.pointerEvents = "auto";
        $("btnGoAdmin").style.opacity = "1";
        toast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        setApiStatus("ok");
      }catch(e){
        toast("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        setApiStatus(getApiUrl() ? "bad" : "bad");
      }
    });

    $("btnUploadFace").addEventListener("click", async ()=>{
      try{
        const code = $("regCode").value.trim();
        const file = $("regFace").files && $("regFace").files[0] ? $("regFace").files[0] : null;
        if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        if(!file) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");

        const res = await apiPost("uploadEmployeeFace", { employeeCode: code }, { face: file });
        toast("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        saveLastResult({
          time: fmtDT(),
          title: `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äì ‡∏£‡∏´‡∏±‡∏™ ${code}`,
          detail: file.name
        });
        setApiStatus("ok");
      }catch(e){
        toast("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        setApiStatus(getApiUrl() ? "bad" : "bad");
      }
    });

    // =========================
    // INIT
    // =========================
    (async function init(){
      const url = getApiUrl();
      setApiStatus(url ? "warn" : "bad");
      setNowBadges();
      syncNavMode();
      renderLastResult();

      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        try{
          const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          tmp.getTracks().forEach(t=>t.stop());
        }catch(e){}
        await loadCameras();
      }else{
        toast("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á");
      }

      if(localStorage.getItem(LS_ADMIN_TOKEN)){
        $("btnGoAdmin").style.pointerEvents = "auto";
        $("btnGoAdmin").style.opacity = "1";
      }
    })();
  </script>
</body>
</html>
