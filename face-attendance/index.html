<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Ä¢ Face/Manual Attendance</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- ‚úÖ ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö: ‡πÉ‡∏ä‡πâ 300-600 -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- ‚úÖ face-api.js (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#16a34a;
      --warn:#f59e0b;
      --red:#ef4444;

      --shadow: 0 18px 50px rgba(15,23,42,.10);
      --shadow2: 0 12px 30px rgba(15,23,42,.08);
      --radius: 20px;
      --radius2: 16px;

      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Prompt",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      font-weight: 400;
      color:var(--text);
      background:
        radial-gradient(1000px 520px at 15% 0%, rgba(37,99,235,.14) 0%, transparent 60%),
        radial-gradient(900px 520px at 90% 10%, rgba(22,163,74,.12) 0%, transparent 62%),
        var(--bg);
    }
    a{color:var(--blue);text-decoration:none}
    button,input,select,textarea{font-family:inherit}

    .wrap{max-width:1180px;margin:0 auto;padding:16px 14px 20px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .tiny{font-size:11px}
    .mt8{margin-top:8px}
    .mt10{margin-top:10px}
    .mt12{margin-top:12px}
    .mt14{margin-top:14px}
    .mt16{margin-top:16px}
    .mt18{margin-top:18px}
    .mt20{margin-top:20px}
    .hide{display:none!important}
    .hr{height:1px;background:rgba(229,231,235,.95);margin:14px 0}

    .mOnly{display:block}
    .dOnly{display:none}
    @media(min-width: 980px){
      .mOnly{display:none}
      .dOnly{display:block}
    }

    /* ===== Mobile Header ===== */
    .mHeader{
      position: sticky; top: 0; z-index: 60;
      padding-top: var(--safeT);
      padding-bottom: 10px;
      background: linear-gradient(to bottom, rgba(246,248,251,.96), rgba(246,248,251,.86), rgba(246,248,251,0));
      backdrop-filter: blur(10px);
    }
    .mHeaderCard{
      margin: 12px 14px 0;
      padding: 12px 12px;
      border-radius: 20px;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(229,231,235,.85);
      box-shadow: var(--shadow);
      display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .mLeft{display:flex;gap:10px;align-items:flex-start}
    .mLogo{
      width:44px;height:44px;border-radius:18px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.18);
      box-shadow: var(--shadow2);
      font-size:18px;
    }
    .mTitle{font-weight:600;font-size:16px;margin:0}
    .mSub{font-size:12px;color:var(--muted);margin-top:2px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mMenuBtn{
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 10px 12px;
      display:flex;align-items:center;gap:8px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      font-weight:600;
    }
    .mHamb{font-size:18px;line-height:1}
    .mMenuTxt{font-size:14px}

    /* ===== PC Topbar ===== */
    .topbar{
      position:sticky;top:0;z-index:50;
      background: rgba(246,248,251,.84);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.85);
    }
    .topbarIn{
      max-width:1180px;margin:0 auto;
      padding: 10px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(22,163,74,.10);
      border: 1px solid rgba(22,163,74,.20);
      box-shadow: var(--shadow2);
      font-size:18px;
    }
    .brandTitle{
      font-weight:600;
      font-size:16px;
      letter-spacing:.2px;
      margin:0;
    }
    .brandSub{margin:2px 0 0;font-size:12px;color:var(--muted);}
    .topActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}

    /* ===== Layout ===== */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items:start;
    }
    @media(min-width: 980px){
      .grid{grid-template-columns: 1.25fr .75fr; gap: 14px}
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
    }
    .cardH{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(229,231,235,.85);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      background: linear-gradient(to bottom, rgba(255,255,255,.98), rgba(255,255,255,.86));
    }
    .cardTitle{margin:0;font-weight:600;font-size:15px;letter-spacing:.2px;display:flex;align-items:center;gap:8px;}
    .cardB{padding:14px}

    /* ===== chips / dots ===== */
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.88);
      box-shadow: var(--shadow2);
      font-size:12px;
      color: var(--muted);
      font-weight:500;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--red);
      box-shadow: 0 0 0 4px rgba(239,68,68,.15);
      display:inline-block;
    }
    .dot.ok{background:var(--green); box-shadow: 0 0 0 4px rgba(22,163,74,.15)}
    .dot.warn{background:var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.18)}
    .dot.bad{background:var(--red); box-shadow: 0 0 0 4px rgba(239,68,68,.15)}

    /* ===== form ===== */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:180px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:500}
    input,select,textarea{
      width:100%;
      border:1px solid rgba(229,231,235,.98);
      background:#fff;
      padding: 11px 12px;
      border-radius: 14px;
      outline:none;
      font-size: 14px;
      font-weight: 400;
    }
    textarea{min-height:92px;resize:vertical}

    /* ===== buttons ===== */
    .btnbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      cursor:pointer;
      border:1px solid rgba(229,231,235,.98);
      background: rgba(255,255,255,.96);
      padding: 11px 12px;
      border-radius: 14px;
      font-weight:600;
      font-size: 14px;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      box-shadow: var(--shadow2);
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(37,99,235,.98), rgba(29,78,216,.98));
      border-color: rgba(29,78,216,.45);
      color:#fff;
      box-shadow: 0 16px 34px rgba(37,99,235,.22);
    }
    .btn.good{
      background: linear-gradient(180deg, rgba(22,163,74,.98), rgba(21,128,61,.98));
      border-color: rgba(21,128,61,.45);
      color:#fff;
      box-shadow: 0 16px 34px rgba(22,163,74,.18);
    }
    .btn.warn{
      background: linear-gradient(180deg, rgba(245,158,11,.98), rgba(217,119,6,.98));
      border-color: rgba(217,119,6,.45);
      color:#fff;
      box-shadow: 0 16px 34px rgba(245,158,11,.16);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(239,68,68,.98), rgba(220,38,38,.98));
      border-color: rgba(220,38,38,.45);
      color:#fff;
      box-shadow: 0 16px 34px rgba(239,68,68,.14);
    }
    .btn.ghost{background: rgba(255,255,255,.88)}
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none}

    /* ===== tabs ===== */
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      padding: 10px 0 2px;
      margin-bottom: 10px;
    }
    .tab{
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.96);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
      font-size: 12px;
      color: var(--muted);
      box-shadow: var(--shadow2);
      transition:.15s ease;
    }
    .tab.active{
      border-color: rgba(37,99,235,.30);
      background: rgba(37,99,235,.10);
      color: var(--blue2);
    }

    .section{display:none}
    .section.active{display:block}

    /* ===== camera ===== */
    .cam{
      border: 1px dashed rgba(148,163,184,.60);
      border-radius: 18px;
      background: linear-gradient(180deg, #f8fafc, #ffffff);
      padding: 12px;
    }
    .camBox{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border-radius: 16px;
      overflow:hidden;
      background:#0b1220;
      border:1px solid rgba(226,232,240,.95);
      display:flex;align-items:center;justify-content:center;
    }
    video{width:100%;height:100%;object-fit:cover;display:none}
    .camHint{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      text-align:center;
      padding:18px;
      color: rgba(255,255,255,.82);
      font-size: 13px;
      line-height: 1.55;
      font-weight: 400;
    }
    .camOverlay{
      position:absolute; inset:0;
      pointer-events:none;
    }

    .info{
      border:1px solid rgba(229,231,235,.90);
      border-radius: 18px;
      padding: 12px;
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow2);
    }

    .statusChip{
      display:inline-flex;align-items:center;gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      font-weight:600;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .statusChip.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.08); color: #166534}
    .statusChip.bad{border-color: rgba(239,68,68,.22); background: rgba(239,68,68,.08); color: #b91c1c}
    .statusChip.warn{border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.10); color: #a16207}

    .tableWrap{
      border:1px solid rgba(229,231,235,.95);
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow2);
    }
    table{width:100%;border-collapse:collapse}
    th,td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(229,231,235,.70);
      font-size: 13px;
      text-align:left;
      vertical-align:top;
      font-weight: 400;
    }
    th{
      background: linear-gradient(to bottom, rgba(255,255,255,.98), rgba(255,255,255,.86));
      font-weight:600;
      color: #0f172a;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover td{background: rgba(37,99,235,.04)}

    /* ===== bottom nav mobile ===== */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index: 70;
      padding: 10px 12px calc(10px + var(--safeB));
      background: rgba(246,248,251,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(229,231,235,.90);
      display:flex;gap:10px;justify-content:space-between;
    }
    .bnBtn{
      flex:1;
      border-radius: 18px;
      border:1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      padding: 10px 8px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      display:flex;flex-direction:column;align-items:center;gap:3px;
      font-weight:600;
      color: var(--muted);
    }
    .bnBtn.active{
      color: var(--blue2);
      border-color: rgba(37,99,235,.28);
      background: rgba(37,99,235,.10);
    }
    .bnIcon{font-size:16px;line-height:1}
    .bnText{font-size:11px}

    @media(max-width: 979px){
      .wrap{padding-bottom: calc(96px + var(--safeB))}
    }

    /* ===== drawer ===== */
    .backdrop{
      position: fixed; inset:0;
      background: rgba(15,23,42,.38);
      z-index: 80;
      display:none;
    }
    .drawer{
      position: fixed;
      top:0; right:0;
      width: min(420px, 92vw);
      height:100%;
      background:#fff;
      border-left: 1px solid rgba(229,231,235,.95);
      box-shadow: -22px 0 60px rgba(15,23,42,.22);
      z-index: 81;
      transform: translateX(110%);
      transition: .18s ease;
      display:flex;flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .drawerH{
      padding: 14px;
      border-bottom: 1px solid rgba(229,231,235,.95);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .drawerTitle{font-weight:600}
    .drawerB{padding:14px;overflow:auto}
    .block{
      border:1px solid rgba(229,231,235,.95);
      border-radius: 18px;
      background:#fff;
      box-shadow: var(--shadow2);
      padding: 12px;
    }
    .blockTitle{font-weight:600;margin-bottom:10px}

    /* ===== toast ===== */
    .toast{
      position: fixed;
      left: 14px; right: 14px;
      bottom: calc(14px + 74px + var(--safeB));
      z-index: 90;
      display:none;
    }
    @media(min-width:980px){
      .toast{
        left:50%;
        transform: translateX(-50%);
        width: 560px;
        bottom: 18px;
      }
    }
    .toastIn{
      background: rgba(15,23,42,.94);
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 18px 44px rgba(15,23,42,.26);
      padding: 12px 14px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
    }
    .toastMsg{font-size:13px;line-height:1.45}
    .toastClose{
      background:transparent;border:none;color:rgba(255,255,255,.85);
      cursor:pointer;font-size:16px;padding:2px 6px;
    }

    .footer{
      margin-top: 14px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      padding: 8px 0 2px;
    }

    /* small face result card */
    .faceCard{
      border:1px solid rgba(229,231,235,.95);
      border-radius: 18px;
      padding: 12px;
      background:#fff;
      box-shadow: var(--shadow2);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .faceWho{font-weight:600}
    .faceMeta{font-size:12px;color:var(--muted);line-height:1.6;margin-top:4px}
    .faceScore{font-size:12px;color:var(--muted)}
    .faceScore b{font-weight:600;color:var(--text)}
    .faceOk{color:#166534;font-weight:600}
    .faceBad{color:#b91c1c;font-weight:600}
  </style>
</head>

<body>

  <!-- ===== Mobile Header ===== -->
  <div class="mHeader mOnly">
    <div class="mHeaderCard">
      <div class="mLeft">
        <div class="mLogo">üïí</div>
        <div>
          <div class="mTitle">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <div class="mSub">
            <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API:</span>
            <span class="statusChip" id="mApiChip">
              <span class="dot warn" id="mDot"></span>
              <span id="mApiText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</span>
            </span>
          </div>
        </div>
      </div>

      <button class="mMenuBtn" id="btnOpenDrawerMobile" type="button">
        <span class="mHamb">‚â°</span>
        <span>‚öôÔ∏è</span>
        <span class="mMenuTxt">‡πÄ‡∏°‡∏ô‡∏π</span>
      </button>
    </div>
  </div>

  <!-- ===== PC Topbar ===== -->
  <div class="topbar dOnly">
    <div class="topbarIn">
      <div class="brand">
        <div class="logo">üïí</div>
        <div>
          <div class="brandTitle">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <div class="brandSub">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Ä¢ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠ ‚Ä¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Ä¢ ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Ä¢ HR</div>
        </div>
      </div>

      <div class="topActions">
        <button class="btn ghost" id="btnOpenDrawerPC" type="button">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
        <button class="btn" id="btnPing" type="button">üì° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
        <button class="btn" id="btnLoadInit" type="button">üì• ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid mt12">

      <!-- ===== MAIN ===== -->
      <div class="card">
        <div class="cardH">
          <div>
            <div class="cardTitle" id="mainTitle">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)</div>
            <div class="small muted" id="mainHint">
              ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL /exec ‚Üí ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API ‚Üí ‡∏Ç‡∏≠ GPS (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ GS ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö lat/lng ‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
            </div>
          </div>

          <div class="chip">
            ‚è±Ô∏è <span id="nowBadge">‚Äî</span>
          </div>
        </div>

        <div class="cardB">

          <!-- Tabs (PC) -->
          <div class="tabs dOnly" id="tabs">
            <button class="tab active" data-sec="secFace" type="button">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
            <button class="tab" data-sec="secManual" type="button">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠</button>
            <button class="tab" data-sec="secCheck" type="button">üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button class="tab" data-sec="secSummary" type="button">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            <button class="tab" data-sec="secHR" type="button">üß© HR</button>
            <button class="tab" data-sec="secHelp" type="button">üìò ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</button>
          </div>

          <!-- ===== SECTION: FACE SCAN ===== -->
          <section class="section active" id="secFace">
            <div class="cam">
              <div class="camBox">
                <video id="videoFace" playsinline muted></video>
                <canvas class="camOverlay" id="overlayFace"></canvas>
                <div class="camHint" id="camHintFace">
                  ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î<br>
                  ‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚úÖ
                </div>
              </div>

              <!-- ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1/3 2/3 3/3 -->
              <div class="mt14 faceCard" id="faceResultCard">
                <div>
                  <div class="small muted" id="faceStepLine">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1/3: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</div>
                  <div class="faceWho" id="faceWho">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                  <div class="faceMeta" id="faceMeta">‡∏¢‡∏∑‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
                </div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
                  <div class="faceScore" id="faceScore">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ‚Äî</div>
                  <button class="btn good" id="btnConfirmFace" type="button" disabled>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</button>
                </div>
              </div>

              <div class="row mt12">
                <div class="col">
                  <label>üé• ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á</label>
                  <select id="cameraSelectFace"><option value="">‚Äî</option></select>
                </div>
                <div class="col">
                  <label>üîÅ ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏´‡∏•‡∏±‡∏á</label>
                  <select id="facingModeFace">
                    <option value="user">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤</option>
                    <option value="environment">‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á</option>
                  </select>
                </div>
              </div>

              <!-- ‚úÖ ‡∏•‡∏î ‚Äú‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏∏‡πà‡∏°‚Äù: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠ GPS + ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ) -->
              <div class="btnbar mt12">
                <button class="btn primary" id="btnStartFace" type="button">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                <button class="btn" id="btnAskGpsFace" type="button">üìç ‡∏Ç‡∏≠ GPS</button>
                <button class="btn" id="btnLoadInitFace" type="button">üì• ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
                <button class="btn danger" id="btnStopFace" type="button">‚èπÔ∏è ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
              </div>

              <div class="info mt12">
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between">
                  <div>
                    <div style="font-weight:600">üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GPS</div>
                    <div class="small muted" id="gpsLine">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Location</div>
                  </div>
                  <span class="statusChip" id="modelChip"><span class="dot warn" id="modelDot"></span><span id="modelText">Face Model: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</span></span>
                </div>
                <div class="small muted mt8">
                  ‡∏ñ‡πâ‡∏≤ GPS ‡πÑ‡∏°‡πà‡∏°‡∏≤ ‚Üí GS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ï‡∏≤‡∏°‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ)
                </div>
              </div>

              <div class="hr"></div>

              <div class="row">
                <div class="col">
                  <label>üß† ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)</label>
                  <select id="slotMode">
                    <option value="AUTO" selected>AUTO (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à)</option>
                    <option value="T1">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t1</option>
                    <option value="T2">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t2</option>
                    <option value="T3">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t3</option>
                    <option value="T4">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t4</option>
                    <option value="EXTRA1">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á tExtra1</option>
                    <option value="EXTRA2">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á tExtra2</option>
                  </select>
                </div>
                <div class="col">
                  <label>üÜî ‡∏™‡∏≥‡∏£‡∏≠‡∏á: ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î/Unknown)</label>
                  <input id="fallbackCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" list="dlCodes">
                  <div class="tiny muted mt8">‡∏ó‡∏£‡∏¥‡∏Ñ: ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô Unknown ‡πÅ‡∏ï‡πà‡∏£‡∏π‡πâ‡∏£‡∏´‡∏±‡∏™ ‚Üí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‚Äù ‡∏à‡∏∞‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
                </div>
              </div>

              <div class="small muted mt10">
                ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà (threshold) ‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏ñ‡πâ‡∏≤ ‚Äú‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏û‡∏≠‚Äù ‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ß‡πà‡∏≤ Unknown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Ñ‡∏ô
              </div>
            </div>
          </section>

          <!-- ===== SECTION: MANUAL ===== -->
          <section class="section" id="secManual">
            <div class="info">
              <div style="font-weight:600">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</div>
              <div class="small muted mt8">
                ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡∏•‡∏∑‡∏°‡∏™‡πÅ‡∏Å‡∏ô‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‚Äù (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö GPS ‡∏ï‡∏≤‡∏° GS)
              </div>
            </div>

            <div class="row mt14">
              <div class="col">
                <label>üÜî ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input id="mCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" list="dlCodes">
              </div>
              <div class="col">
                <label>üß† ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
                <select id="mSlotMode">
                  <option value="AUTO" selected>AUTO (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à)</option>
                  <option value="T1">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t1</option>
                  <option value="T2">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t2</option>
                  <option value="T3">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t3</option>
                  <option value="T4">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t4</option>
                  <option value="EXTRA1">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á tExtra1</option>
                  <option value="EXTRA2">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á tExtra2</option>
                </select>
              </div>
            </div>

            <div class="row mt12">
              <div class="col">
                <label>üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GPS</label>
                <input id="mGpsView" readonly placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Location">
              </div>
              <div class="col">
                <label>üßæ ‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                <input id="mEvidenceFile" type="file" accept="image/*">
              </div>
            </div>

            <div class="row mt12">
              <div class="col">
                <label>üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                <textarea id="mReason" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏∑‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤ / ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏° / ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß"></textarea>
                <div class="small muted mt8">
                  (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ô‡∏ö‡πÑ‡∏õ‡∏Å‡∏±‡∏ö manualType ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)
                </div>
              </div>
            </div>

            <div class="btnbar mt14">
              <button class="btn" id="btnAskGpsManual" type="button">üìç ‡∏Ç‡∏≠ GPS</button>
              <button class="btn good" id="btnSubmitManual" type="button">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</button>
              <button class="btn" id="btnGoCheckFromManual" type="button">üîé ‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            </div>
          </section>

          <!-- ===== SECTION: CHECK ===== -->
          <section class="section" id="secCheck">
            <div class="info">
              <div style="font-weight:600">üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="small muted mt8">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ ‚Üí ‡∏Å‡∏î‡πÄ‡∏ä‡πá‡∏Ñ ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢</div>
            </div>

            <div class="row mt14">
              <div class="col">
                <label>üÜî ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                <input id="cCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" list="dlCodes">
              </div>
              <div class="col">
                <label>üìå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input id="cDate" readonly>
              </div>
            </div>

            <div class="btnbar mt14">
              <button class="btn primary" id="btnCheck" type="button">üîé ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
              <button class="btn" id="btnToSummary" type="button">üìä ‡πÑ‡∏õ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
            </div>

            <div class="hr"></div>

            <div class="info" id="checkCard">
              <div style="font-weight:600">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</div>
              <div class="small muted mt8" id="checkMsg">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡πá‡∏Ñ</div>
              <div class="mt12" id="checkUi"></div>
            </div>

            <div class="small muted mt12">
              (‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° debug ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏î‡∏π JSON)
              <button class="btn" id="btnToggleDebug" type="button">üß™ ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô Debug</button>
              <pre id="checkDebug" class="hide" style="margin-top:10px;padding:12px;border-radius:16px;background:#0b1220;color:#e5e7eb;overflow:auto;max-height:280px"></pre>
            </div>
          </section>

          <!-- ===== SECTION: SUMMARY ===== -->
          <section class="section" id="secSummary">
            <div class="info">
              <div style="font-weight:600">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="small muted mt8">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ ‚Üí ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏î‡πâ ‚Üí Export CSV ‡πÑ‡∏î‡πâ</div>
            </div>

            <div class="row mt14">
              <div class="col">
                <label>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠/‡πÅ‡∏ú‡∏ô‡∏Å)</label>
                <input id="sumSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏ú‡∏ô‡∏Å">
              </div>
              <div class="col">
                <label>‚ö° ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</label>
                <div class="btnbar">
                  <button class="btn primary" id="btnLoadSummary" type="button">üìä ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                  <button class="btn" id="btnExportCsv" type="button">‚¨áÔ∏è Export CSV</button>
                </div>
              </div>
            </div>

            <div class="tableWrap mt14" style="max-height: 560px; overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th style="width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th style="width:160px">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                    <th style="width:140px">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                    <th style="width:170px">‡πÄ‡∏ß‡∏•‡∏≤ (t1-t4)</th>
                    <th style="width:210px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  </tr>
                </thead>
                <tbody id="sumBody">
                  <tr><td colspan="6" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î ‚Äî ‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‚Äù</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- ===== SECTION: HR ===== -->
          <section class="section" id="secHR">
            <div class="info">
              <div style="font-weight:600">üß© HR</div>
              <div class="small muted mt8">
                1) ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‚Üí 2) ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ ‚Üí 3) ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô)
              </div>
            </div>

            <div class="row mt14">
              <div class="col">
                <label>üë§ Username</label>
                <input id="hrUser" placeholder="admin">
              </div>
              <div class="col">
                <label>üîí Password</label>
                <input id="hrPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>
            </div>

            <div class="btnbar mt12">
              <button class="btn primary" id="btnLogin" type="button">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
              <span class="statusChip" id="hrState"><span class="dot warn" id="hrDot"></span><span id="hrText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</span></span>
              <button class="btn" id="btnGoAdmin" type="button" disabled>üßë‚Äçüíº ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin</button>
              <button class="btn" id="btnLogout" type="button" disabled>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>

            <div class="hr"></div>

            <div class="info">
              <div style="font-weight:600">üôÇ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (HR)</div>
              <div class="small muted mt8" id="regStepLine">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1/3: ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
              <div class="small muted mt8">
                ‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö ‚Üí ‡∏Å‡∏î ‚Äú‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û+‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù
                (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì faceData ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÑ‡∏õ GS: uploadEmployeeFace)
              </div>

              <div class="row mt12">
                <div class="col">
                  <label>üÜî ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                  <input id="regCode" inputmode="numeric" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" list="dlCodes">
                </div>
                <div class="col">
                  <label>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                  <input id="regNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô / ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤">
                </div>
              </div>

              <div class="cam mt12">
                <div class="camBox">
                  <video id="videoReg" playsinline muted></video>
                  <canvas class="camOverlay" id="overlayReg"></canvas>
                  <div class="camHint" id="camHintReg">‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á HR‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                </div>

                <div class="btnbar mt12">
                  <button class="btn primary" id="btnStartReg" type="button">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á HR</button>
                  <button class="btn danger" id="btnStopReg" type="button">‚èπÔ∏è ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                  <button class="btn good" id="btnCaptureReg" type="button" disabled>‚¨ÜÔ∏è ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û+‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                </div>

                <div class="small muted mt10" id="regHint">‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ß‡πà‡∏≤ ‚Äú‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div>
              </div>

              <div class="mt12" id="hrDebugWrap" style="display:none">
                <div class="small muted">‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö:</div>
                <pre id="hrDebug" style="margin-top:8px;padding:12px;border-radius:16px;background:#0b1220;color:#e5e7eb;overflow:auto;max-height:280px"></pre>
              </div>

            </div>
          </section>

          <!-- ===== SECTION: HELP ===== -->
          <section class="section" id="secHelp">
            <div class="info">
              <div style="font-weight:600">üìò ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏ö‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏Ñ‡∏ô)</div>
              <div class="small muted mt8">‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
            </div>

            <div class="info mt14">
              <div style="font-weight:600">A) ‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>
              <ol class="mt10 small muted" style="line-height:1.8;margin:0;padding-left:18px">
                <li>‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π ‚öôÔ∏è ‚Üí ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Apps Script ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <b>/exec</b> ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>
                <li>‡∏Å‡∏î ‚Äú‡∏ó‡∏î‡∏™‡∏≠‡∏ö API‚Äù ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô pong = ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
                <li>‡∏Å‡∏î ‚Äú‡∏Ç‡∏≠ GPS‚Äù ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)</li>
                <li>‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÅ‡∏•‡∏∞ faceData)</li>
              </ol>
            </div>

            <div class="info mt14">
              <div style="font-weight:600">B) ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏¥‡∏ò‡∏µ‡∏´‡∏•‡∏±‡∏Å)</div>
              <ol class="mt10 small muted" style="line-height:1.8;margin:0;padding-left:18px">
                <li>‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‚Üí ‡∏Å‡∏î ‚Äú‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù</li>
                <li>‡∏¢‡∏∑‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á</li>
                <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (AUTO ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡∏á t1-t4)</li>
                <li>‡∏Å‡∏î ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‚Äù ‚Üí ‡πÄ‡∏™‡∏£‡πá‡∏à ‚úÖ</li>
              </ol>
            </div>

            <div class="info mt14">
              <div style="font-weight:600">C) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠ (‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô)</div>
              <ol class="mt10 small muted" style="line-height:1.8;margin:0;padding-left:18px">
                <li>‡πÑ‡∏õ‡πÅ‡∏ó‡πá‡∏ö ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠‚Äù</li>
                <li>‡∏Å‡∏î ‚Äú‡∏Ç‡∏≠ GPS‚Äù ‡πÉ‡∏´‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
                <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ + ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• + ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î ‚Üí ‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</li>
              </ol>
            </div>

            <div class="info mt14">
              <div style="font-weight:600">D) HR / Admin</div>
              <ol class="mt10 small muted" style="line-height:1.8;margin:0;padding-left:18px">
                <li>HR ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ admin.html ‡πÑ‡∏î‡πâ</li>
                <li>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‚Üí ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î ‚Üí ‡∏Å‡∏î ‚Äú‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û+‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù</li>
              </ol>
            </div>
          </section>

        </div>
      </div>

      <!-- ===== SIDE (PC only) ===== -->
      <aside class="dOnly">
        <div class="card">
          <div class="cardH">
            <div>
              <div class="cardTitle">‚ö° ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (PC)</div>
              <div class="small muted">‡∏£‡∏ß‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÑ‡∏°‡πà‡∏£‡∏Å</div>
            </div>
            <span class="chip">üñ•Ô∏è Desktop</span>
          </div>

          <div class="cardB">

            <div class="info">
              <div style="font-weight:600">üîó ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</div>
              <div class="small muted mt8" id="sideApi">API: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
              <div class="small muted mt8" id="sideGps">GPS: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>
              <div class="btnbar mt12">
                <button class="btn" id="btnOpenDrawerSide" type="button">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
                <button class="btn" id="btnAskGpsSide" type="button">üìç ‡∏Ç‡∏≠ GPS</button>
                <button class="btn" id="btnPingSide" type="button">üì° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
              </div>
            </div>

            <div class="info mt14">
              <div style="font-weight:600">üì• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
              <div class="small muted mt8">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å code ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ faceData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
              <div class="btnbar mt12">
                <button class="btn primary" id="btnLoadInitSide" type="button">üì• ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
                <button class="btn" id="btnClearLocal" type="button">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
              </div>
            </div>

            <div class="info mt14">
              <div style="font-weight:600">üßæ ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
              <div class="small muted mt8" id="lastLine">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</div>
            </div>

          </div>
        </div>
      </aside>

    </div>

    <div class="footer">
      ¬© ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Ä¢ Face/Manual/HR ‚úÖ
    </div>
  </div>

  <!-- ===== Mobile Bottom Nav ===== -->
  <nav class="bottomNav mOnly">
    <button class="bnBtn active" data-sec="secFace" type="button"><div class="bnIcon">üì∑</div><div class="bnText">‡∏™‡πÅ‡∏Å‡∏ô</div></button>
    <button class="bnBtn" data-sec="secManual" type="button"><div class="bnIcon">üìù</div><div class="bnText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</div></button>
    <button class="bnBtn" data-sec="secCheck" type="button"><div class="bnIcon">üîé</div><div class="bnText">‡πÄ‡∏ä‡πá‡∏Ñ</div></button>
    <button class="bnBtn" data-sec="secSummary" type="button"><div class="bnIcon">üìä</div><div class="bnText">‡∏™‡∏£‡∏∏‡∏õ</div></button>
    <button class="bnBtn" data-sec="secHR" type="button"><div class="bnIcon">üß©</div><div class="bnText">HR</div></button>
  </nav>

  <!-- ===== Drawer ===== -->
  <div class="backdrop" id="backdrop"></div>
  <aside class="drawer" id="drawer">
    <div class="drawerH">
      <div class="drawerTitle">‚öôÔ∏è ‡πÄ‡∏°‡∏ô‡∏π / ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
      <button class="btn" id="btnCloseDrawer" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>

    <div class="drawerB">

      <div class="block">
        <div class="blockTitle">üîó ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL (Apps Script Web App)</div>
        <label>URL /exec</label>
        <input id="apiUrlInput" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå .../exec">
        <div class="btnbar mt12">
          <button class="btn primary" id="btnSaveUrl" type="button">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL</button>
          <button class="btn" id="btnResetUrl" type="button">‚ôªÔ∏è Reset URL</button>
        </div>
        <div class="small muted mt10">
          ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏ú‡πà‡∏≤‡∏ô HTTPS ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á/GPS ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
        </div>
      </div>

      <div class="hr"></div>

      <div class="block">
        <div class="blockTitle">üß∞ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>
        <div class="btnbar">
          <button class="btn" id="btnPingDrawer" type="button">üì° ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
          <button class="btn" id="btnAskGpsDrawer" type="button">üìç ‡∏Ç‡∏≠ GPS</button>
          <button class="btn" id="btnLoadInitDrawer" type="button">üì• ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="block">
        <div class="blockTitle">üìå ‡∏ó‡∏£‡∏¥‡∏Ñ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î</div>
        <ol class="small muted" style="line-height:1.8;margin:0;padding-left:18px">
          <li>‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ‡πÉ‡∏´‡πâ GPS ‡∏Ç‡∏∂‡πâ‡∏ô ‚Äú‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù</li>
          <li>‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î/‡πÅ‡∏™‡∏á‡∏û‡∏≠‡∏î‡∏µ/‡πÑ‡∏°‡πà‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô</li>
          <li>Unknown ‡∏ö‡πà‡∏≠‡∏¢: HR ‡∏Ñ‡∏ß‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô</li>
        </ol>
      </div>

    </div>
  </aside>

  <!-- ===== Toast ===== -->
  <div class="toast" id="toast">
    <div class="toastIn">
      <div class="toastMsg" id="toastMsg">‚Äî</div>
      <button class="toastClose" id="toastClose" type="button">‚úï</button>
    </div>
  </div>

  <datalist id="dlCodes"></datalist>

  <script>
    ;(() => {
      "use strict";

      // =========================
      // Storage Keys
      // =========================
      const LS_API = "attendance_api_url_v2";
      const LS_LAST = "attendance_last_ui_log_v1";
      const LS_HR = "attendance_hr_token_v1";      // token ‡∏à‡∏≤‡∏Å GS
      const LS_HR_OK = "attendance_hr_logged_v1";  // flag ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ admin

      // =========================
      // DOM helpers
      // =========================
      const $ = (id) => document.getElementById(id);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));

      // =========================
      // State
      // =========================
      let busy = false;

      // GPS
      let lastGps = null; // {lat,lng,acc}

      // Employees & Face
      let employeesCache = [];
      let faceMatcher = null;
      let modelsReady = false;
      let scanLoopTimer = null;
      let lastFaceMatch = null; // { employee, label, distance, ok }
      let faceStep = 1;          // 1/3,2/3,3/3
      let faceStableLabel = "";
      let faceStableCount = 0;
      const FACE_STABLE_NEED = 3;

      // Streams
      let streamFace = null;
      let streamReg = null;

      // Summary cache
      let lastSummary = [];

      // HR reg detect
      let regDetLoopId = 0;

      // =========================
      // Time
      // =========================
      const pad2 = (n) => String(n).padStart(2, "0");
      function nowTH() {
        const d = new Date();
        const y = d.getFullYear() + 543;
        return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${y} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      }
      function todayISO() {
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }

      // =========================
      // Toast
      // =========================
      function toast(msg) {
        const el = $("toast");
        const msgEl = $("toastMsg");
        if (!el || !msgEl) return alert(msg);
        msgEl.textContent = msg;
        el.style.display = "block";
        clearTimeout(window.__t);
        window.__t = setTimeout(() => el.style.display = "none", 3200);
      }
      $("toastClose")?.addEventListener("click", () => ($("toast").style.display = "none"));

      // =========================
      // Busy lock
      // =========================
      function setBusy(v) {
        busy = v;
        const ids = [
          "btnStartFace","btnStopFace","btnAskGpsFace","btnLoadInitFace","btnConfirmFace",
          "btnAskGpsManual","btnSubmitManual",
          "btnCheck","btnLoadSummary","btnExportCsv",
          "btnPing","btnPingDrawer","btnPingSide",
          "btnSaveUrl","btnResetUrl",
          "btnLoadInit","btnLoadInitDrawer","btnLoadInitSide",
          "btnLogin","btnGoAdmin","btnLogout",
          "btnStartReg","btnStopReg","btnCaptureReg",
        ];
        ids.forEach(id => {
          const b = $(id);
          if (b && b.tagName === "BUTTON") b.disabled = !!v;
        });
      }

      // =========================
      // API URL
      // =========================
      function getApiUrl() { return (localStorage.getItem(LS_API) || "").trim(); }
      function setApiUrl(url) { localStorage.setItem(LS_API, (url || "").trim()); refreshApiUI(); }
      function resetApiUrl() { localStorage.removeItem(LS_API); refreshApiUI(); }
      function setApiState(state, text) {
        const mDot = $("mDot"), mTxt = $("mApiText");
        const sideApi = $("sideApi");
        function apply(dot, txt) {
          if (!dot || !txt) return;
          dot.classList.remove("ok","warn","bad");
          dot.classList.add(state === "ok" ? "ok" : state === "bad" ? "bad" : "warn");
          txt.textContent = text;
        }
        apply(mDot, mTxt);
        if (sideApi) sideApi.textContent = "API: " + text;
      }
      function refreshApiUI() {
        const url = getApiUrl();
        if ($("apiUrlInput")) $("apiUrlInput").value = url;

        if (!url) return setApiState("warn", "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL");
        setApiState("ok", "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö)");
      }

      // =========================
      // Drawer
      // =========================
      function openDrawer() {
        $("backdrop").style.display = "block";
        $("drawer").classList.add("open");
        $("apiUrlInput").value = getApiUrl();
      }
      function closeDrawer() {
        $("backdrop").style.display = "none";
        $("drawer").classList.remove("open");
      }
      $("btnOpenDrawerMobile")?.addEventListener("click", openDrawer);
      $("btnOpenDrawerPC")?.addEventListener("click", openDrawer);
      $("btnOpenDrawerSide")?.addEventListener("click", openDrawer);
      $("backdrop")?.addEventListener("click", closeDrawer);
      $("btnCloseDrawer")?.addEventListener("click", closeDrawer);

      $("btnSaveUrl")?.addEventListener("click", () => {
        const url = ($("apiUrlInput").value || "").trim();
        if (!url || !url.includes("/exec")) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec");
        setApiUrl(url);
        toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        closeDrawer();
      });
      $("btnResetUrl")?.addEventListener("click", () => {
        resetApiUrl();
        toast("Reset URL ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      });

      // =========================
      // Navigation
      // =========================
      const titleMap = {
        secFace: "üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)",
        secManual: "üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å AUTO ‡∏´‡∏£‡∏∑‡∏≠ t1-t4 ‡πÑ‡∏î‡πâ)",
        secCheck: "üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢)",
        secSummary: "üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
        secHR: "üß© HR (‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô + ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ + ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin)",
        secHelp: "üìò ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ"
      };

      function showSection(id) {
        ["secFace","secManual","secCheck","secSummary","secHR","secHelp"].forEach(s => {
          $(s)?.classList.toggle("active", s === id);
        });
        $$("#tabs .tab").forEach(t => t.classList.toggle("active", t.dataset.sec === id));
        $$(".bottomNav .bnBtn").forEach(b => b.classList.toggle("active", b.dataset.sec === id));
        $("mainTitle").textContent = titleMap[id] || "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô";
      }

      $$("#tabs .tab").forEach(t => t.addEventListener("click", () => showSection(t.dataset.sec)));
      $$(".bottomNav .bnBtn").forEach(b => b.addEventListener("click", () => showSection(b.dataset.sec)));

      $("btnGoCheckFromManual")?.addEventListener("click", () => showSection("secCheck"));
      $("btnToSummary")?.addEventListener("click", () => showSection("secSummary"));

      // =========================
      // API Calls (POST x-www-form-urlencoded)
      // =========================
      async function postAction(action, params = {}) {
        const url = getApiUrl();
        if (!url) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL /exec");

        const body = new URLSearchParams();
        body.set("action", action);
        Object.entries(params).forEach(([k,v]) => {
          if (v === undefined || v === null) return;
          body.set(k, String(v));
        });

        const res = await fetch(url, { method: "POST", body });
        const text = await res.text();

        let json;
        try { json = JSON.parse(text); } catch { json = { ok:false, raw:text }; }

        if (!res.ok) throw new Error("HTTP " + res.status);
        if (!json || json.ok !== true) throw new Error(json?.error || "‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return json.result;
      }

      function buildGetPingUrl() {
        const base = getApiUrl();
        if (!base) return "";
        return base.includes("?") ? (base + "&action=ping") : (base + "?action=ping");
      }

      async function pingApi() {
        const url = buildGetPingUrl();
        if (!url) return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL");
        try {
          setBusy(true);
          const res = await fetch(url, { method:"GET" });
          const text = await res.text();
          let json;
          try { json = JSON.parse(text); } catch { json = null; }

          if (res.ok && json && json.ok) {
            setApiState("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (pong)");
            toast("API ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‚úÖ");
          } else {
            setApiState("bad","‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚ùå");
            toast("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + (json?.error || text || "unknown"));
          }
        } catch (e) {
          setApiState("bad","‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚ùå");
          toast("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + e.message);
        } finally {
          setBusy(false);
        }
      }

      $("btnPing")?.addEventListener("click", pingApi);
      $("btnPingSide")?.addEventListener("click", pingApi);
      $("btnPingDrawer")?.addEventListener("click", pingApi);

      // =========================
      // GPS
      // =========================
      function setGpsUI(gps) {
        if (!gps) {
          $("gpsLine").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Location";
          $("mGpsView").value = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Location";
          $("sideGps") && ($("sideGps").textContent = "GPS: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå");
          return;
        }
        const s = `lat=${gps.lat.toFixed(6)}, lng=${gps.lng.toFixed(6)} (¬±${Math.round(gps.acc)}m)`;
        $("gpsLine").textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ " + s;
        $("mGpsView").value = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ " + s;
        $("sideGps") && ($("sideGps").textContent = "GPS: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ");
      }

      function getGPS() {
        return new Promise((resolve) => {
          if (!navigator.geolocation) return resolve(null);
          navigator.geolocation.getCurrentPosition(
            (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy }),
            () => resolve(null),
            { enableHighAccuracy:true, timeout: 9000, maximumAge: 0 }
          );
        });
      }

      async function askGps({silent=false}={}) {
        try {
          setBusy(true);
          const gps = await getGPS();
          if (!gps) {
            lastGps = null;
            setGpsUI(null);
            if (!silent) toast("‡∏Ç‡∏≠ GPS ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Location");
            return null;
          }
          lastGps = gps;
          setGpsUI(gps);
          if (!silent) toast("‡πÑ‡∏î‡πâ GPS ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
          return gps;
        } finally {
          setBusy(false);
        }
      }

      $("btnAskGpsFace")?.addEventListener("click", () => askGps());
      $("btnAskGpsManual")?.addEventListener("click", () => askGps());
      $("btnAskGpsSide")?.addEventListener("click", () => askGps());
      $("btnAskGpsDrawer")?.addEventListener("click", () => askGps());

      // =========================
      // Load Cameras helpers
      // =========================
      async function loadCameras(selectEl) {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d => d.kind === "videoinput");
          if (!selectEl) return;
          selectEl.innerHTML = cams.map((c,i) =>
            `<option value="${c.deviceId}">${escapeHtml(c.label || ("Camera " + (i+1)))}</option>`
          ).join("");
          if (cams.length && !selectEl.value) selectEl.value = cams[0].deviceId;
        } catch {}
      }

      // =========================
      // File/Base64 + Capture frame
      // =========================
      function fileToDataURL(file) {
        return new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = () => reject(new Error("‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
          fr.readAsDataURL(file);
        });
      }

      function captureFrameToJpegDataUrl(video, quality=0.82) {
        const canvas = document.createElement("canvas");
        const w = video.videoWidth || 1280;
        const h = video.videoHeight || 720;
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);
        return canvas.toDataURL("image/jpeg", quality);
      }

      // =========================
      // Face Models
      // =========================
      function setModelState(ok, msg){
        const dot = $("modelDot");
        const txt = $("modelText");
        dot.classList.remove("ok","warn","bad");
        dot.classList.add(ok ? "ok" : "warn");
        txt.textContent = msg;
      }

      async function loadFaceModels() {
        if (modelsReady) return true;
        if (!window.faceapi) {
          setModelState(false, "Face Model: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î (face-api.js)");
          return false;
        }
        try{
          setModelState(false, "Face Model: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
          // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ./models/
          const MODEL_URL = "./models";
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
          await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
          await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
          modelsReady = true;
          setModelState(true, "Face Model: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚úÖ");
          return true;
        } catch(e){
          setModelState(false, "Face Model: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          toast("‡πÇ‡∏´‡∏•‡∏î face model ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ./models/");
          return false;
        }
      }

      // =========================
      // Employees -> FaceMatcher
      // =========================
      function parseFaceData(faceDataRaw){
        if (!faceDataRaw) return [];
        let obj = faceDataRaw;
        if (typeof obj === "string") {
          const s = obj.trim();
          if (!s) return [];
          try { obj = JSON.parse(s); } catch { return []; }
        }

        if (Array.isArray(obj) && obj.length && typeof obj[0] === "number") {
          return [ new Float32Array(obj) ];
        }
        if (Array.isArray(obj) && obj.length && Array.isArray(obj[0])) {
          return obj.map(a => new Float32Array(a));
        }
        if (obj && Array.isArray(obj.descriptors)) {
          return obj.descriptors.map(a => new Float32Array(a));
        }
        return [];
      }

      function rebuildFaceMatcher(){
        if (!employeesCache.length) {
          faceMatcher = null;
          return;
        }
        const labeled = [];
        for (const e of employeesCache) {
          const code = String(e.code ?? "").trim();
          if (!code) continue;
          const label = code;
          const descs = parseFaceData(e.faceData);
          if (!descs.length) continue;
          labeled.push(new faceapi.LabeledFaceDescriptors(label, descs));
        }
        if (!labeled.length) {
          faceMatcher = null;
          return;
        }
        faceMatcher = new faceapi.FaceMatcher(labeled, 0.55);
      }

      // =========================
      // getInitialData -> cache employees
      // =========================
      function fillCodes(emps){
        const dl = $("dlCodes");
        if (!dl) return;
        const list = (emps || [])
          .map(e => ({ code: String(e.code || "").trim(), name: String(e.fullName || e.fullname || "").trim() }))
          .filter(x => x.code);
        dl.innerHTML = list.map(x => `<option value="${escapeHtml(x.code)}">${escapeHtml(x.name)}</option>`).join("");
      }

      async function loadInitial(){
        try{
          setBusy(true);
          const res = await postAction("getInitialData", {});
          employeesCache = res?.employees || [];
          fillCodes(employeesCache);

          if (await loadFaceModels()) {
            rebuildFaceMatcher();
          }

          toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        }catch(e){
          toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      $("btnLoadInit")?.addEventListener("click", loadInitial);
      $("btnLoadInitSide")?.addEventListener("click", loadInitial);
      $("btnLoadInitDrawer")?.addEventListener("click", loadInitial);
      $("btnLoadInitFace")?.addEventListener("click", loadInitial);

      // =========================
      // Step UI (Face 1/3 2/3 3/3)
      // =========================
      function setFaceStep(step, msg){
        faceStep = step;
        const el = $("faceStepLine");
        if (el) el.textContent = `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ${step}/3: ${msg}`;
      }

      function resetFaceStability(){
        faceStableLabel = "";
        faceStableCount = 0;
      }

      // =========================
      // Face Scan Camera
      // =========================
      function stopStream(stream){
        if (!stream) return;
        try { stream.getTracks().forEach(t => t.stop()); } catch {}
      }

      function stopFace(){
        stopStream(streamFace);
        streamFace = null;
        const v = $("videoFace");
        if (v) { v.pause(); v.srcObject = null; v.style.display = "none"; }
        $("camHintFace").style.display = "flex";
        clearInterval(scanLoopTimer);
        scanLoopTimer = null;
        resetFaceStability();
        setFaceResult(null);
        clearOverlay($("overlayFace"));
        setFaceStep(1, "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô");
      }

      async function startFace(){
        stopFace();

        const okModels = await loadFaceModels();
        if (!okModels) return;

        // ‚úÖ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° ‚Äú‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‚Äù:
        // - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ GPS ‚Üí ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ (silent)
        // - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ (‡∏ñ‡πâ‡∏≤ URL ‡∏û‡∏£‡πâ‡∏≠‡∏°)
        try{
          setBusy(true);

          // ‡∏Ç‡∏≠ GPS ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏≠‡∏á)
          if (!lastGps) {
            try { await askGps({silent:true}); } catch {}
          }

          // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
          if (!employeesCache.length && getApiUrl()) {
            try { await loadInitial(); } catch {}
          }

          const sel = $("cameraSelectFace");
          const deviceId = sel?.value || null;
          const facing = $("facingModeFace")?.value || "user";

          streamFace = await navigator.mediaDevices.getUserMedia({
            video: deviceId ? { deviceId:{ exact: deviceId } } : { facingMode: facing },
            audio:false
          });

          const v = $("videoFace");
          v.srcObject = streamFace;
          await v.play();
          v.style.display = "block";
          $("camHintFace").style.display = "none";

          resizeOverlayToVideo($("overlayFace"), v);

          resetFaceStability();
          setFaceResult(null);
          setFaceStep(1, "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Ä¶");

          scanLoopTimer = setInterval(() => scanFaceFrame(), 550);

          toast("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        }catch(e){
          stopFace();
          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e.message || "unknown"));
        }finally{
          setBusy(false);
        }
      }

      $("btnStartFace")?.addEventListener("click", startFace);
      $("btnStopFace")?.addEventListener("click", () => { stopFace(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); });

      // =========================
      // Overlay draw helpers
      // =========================
      function resizeOverlayToVideo(canvas, video){
        if (!canvas || !video) return;
        canvas.width = video.videoWidth || 1280;
        canvas.height = video.videoHeight || 720;
      }
      function clearOverlay(canvas){
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      function drawBox(canvas, box, ok=true){
        if (!canvas || !box) return;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.lineWidth = 4;
        ctx.strokeStyle = ok ? "rgba(34,197,94,.95)" : "rgba(239,68,68,.95)";
        ctx.fillStyle = ok ? "rgba(34,197,94,.12)" : "rgba(239,68,68,.12)";
        ctx.beginPath();
        ctx.rect(box.x, box.y, box.width, box.height);
        ctx.fill();
        ctx.stroke();
      }

      // =========================
      // Face scan logic
      // =========================
      function findEmployeeByCode(code){
        const c = String(code||"").trim();
        return employeesCache.find(e => String(e.code||"").trim() === c) || null;
      }

      function setFaceResult(match){
        lastFaceMatch = match;
        const who = $("faceWho");
        const meta = $("faceMeta");
        const score = $("faceScore");
        const btn = $("btnConfirmFace");

        if (!match) {
          who.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
          meta.textContent = "‡∏¢‡∏∑‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà";
          score.innerHTML = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: ‚Äî";
          btn.disabled = true;
          return;
        }

        const e = match.employee;
        if (match.ok && e) {
          who.innerHTML = `<span class="faceOk">‡∏û‡∏ö: ${escapeHtml(e.fullName || "")}</span> (‡∏£‡∏´‡∏±‡∏™ ${escapeHtml(e.code)})`;
          meta.innerHTML = `‡πÅ‡∏ú‡∏ô‡∏Å: ${escapeHtml(e.branch||"-")} ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escapeHtml(e.level||"-")}`;
          score.innerHTML = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <b>${Math.max(0, (1 - match.distance)).toFixed(2)}</b> ‚Ä¢ ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: <b>${match.distance.toFixed(3)}</b>`;
          btn.disabled = false;
        } else {
          who.innerHTML = `<span class="faceBad">Unknown</span> (‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)`;
          meta.textContent = "‡∏•‡∏≠‡∏á‡∏Ç‡∏¢‡∏±‡∏ö‡πÉ‡∏Å‡∏•‡πâ‡∏Ç‡∏∂‡πâ‡∏ô / ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô / ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ HR ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà";
          score.innerHTML = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à: <b>${match.distance != null ? (Math.max(0, (1 - match.distance)).toFixed(2)) : "-"}</b>`;
          // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞ ‚Äú‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏î‚Äù ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏™‡πà fallbackCode
          btn.disabled = !($("fallbackCode").value || "").trim();
        }
      }

      function updateConfirmByFallback(){
        const fb = ($("fallbackCode").value || "").trim();
        const btn = $("btnConfirmFace");
        if (!btn) return;

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î
        if (!lastFaceMatch) { btn.disabled = true; return; }

        // ‡∏ñ‡πâ‡∏≤ match ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Å‡∏î‡πÑ‡∏î‡πâ
        if (lastFaceMatch.ok) { btn.disabled = false; return; }

        // ‡∏ñ‡πâ‡∏≤ Unknown ‚Üí ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏£‡∏≠‡∏á
        btn.disabled = !fb;

        if (fb && lastFaceMatch) {
          setFaceStep(3, `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ ${fb}`);
        }
      }
      $("fallbackCode")?.addEventListener("input", updateConfirmByFallback);

      async function scanFaceFrame(){
        try{
          const v = $("videoFace");
          if (!streamFace || !v || v.readyState < 2) return;

          resizeOverlayToVideo($("overlayFace"), v);

          const detection = await faceapi
            .detectSingleFace(v, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
            .withFaceLandmarks()
            .withFaceDescriptor();

          if (!detection) {
            clearOverlay($("overlayFace"));
            resetFaceStability();
            setFaceResult(null);
            setFaceStep(1, "‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‚Ä¶");
            return;
          }

          drawBox($("overlayFace"), detection.detection.box, true);
          setFaceStep(2, "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‚Ä¶");

          if (!faceMatcher) {
            // ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡πÑ‡∏°‡πà‡∏°‡∏µ faceData)
            setFaceResult({ ok:false, distance:null, employee:null });
            resetFaceStability();
            return;
          }

          const best = faceMatcher.findBestMatch(detection.descriptor);
          const label = best.label; // code or "unknown"
          const distance = best.distance;

          if (label && label !== "unknown") {
            const emp = findEmployeeByCode(label);
            setFaceResult({ ok:true, employee: emp, label, distance });

            // ‚úÖ ‡∏ó‡∏≥ ‚Äú1/3 2/3 3/3‚Äù ‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡πà‡∏á ‡πÜ: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≠ label ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏ü‡∏£‡∏°
            if (label === faceStableLabel) faceStableCount += 1;
            else { faceStableLabel = label; faceStableCount = 1; }

            if (faceStableCount >= FACE_STABLE_NEED) {
              setFaceStep(3, `‡∏û‡∏ö ${emp?.fullName || label} ‚Ä¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`);
            } else {
              setFaceStep(2, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‚Ä¶ ${faceStableCount}/${FACE_STABLE_NEED}`);
            }
          } else {
            setFaceResult({ ok:false, employee:null, label:"unknown", distance });
            resetFaceStability();
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ fallback ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡∏±‡πâ‡∏ô 3/3 ‡πÑ‡∏î‡πâ
            const fb = ($("fallbackCode").value || "").trim();
            if (fb) setFaceStep(3, `Unknown ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏£‡∏≠‡∏á (${fb}) ‚Ä¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô`);
            else setFaceStep(2, "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á Unknown (‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏£‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ HR ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤)");
          }

          updateConfirmByFallback();
        } catch {
          // ignore scan loop errors
        }
      }

      // =========================
      // Confirm Face -> saveManualLog
      // =========================
      async function confirmFaceAndSave(){
        if (busy) return;

        // require GPS
        if (!lastGps) {
          toast("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ GPS ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Äî ‡∏Å‡∏î ‚Äú‡∏Ç‡∏≠ GPS‚Äù");
          return;
        }

        const slot = ($("slotMode").value || "AUTO").trim();

        // determine code
        let code = "";
        if (lastFaceMatch?.ok && lastFaceMatch.employee?.code) {
          code = String(lastFaceMatch.employee.code).trim();
        } else {
          code = ($("fallbackCode").value || "").trim();
          if (!code) {
            toast("‡∏¢‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á");
            return;
          }
        }

        // require a live frame
        const v = $("videoFace");
        if (!v || v.readyState < 2) {
          toast("‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
          return;
        }

        setFaceStep(3, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‚Ä¶");

        const evidenceBase64 = captureFrameToJpegDataUrl(v, 0.82);
        const evidenceName = `face-${code}-${Date.now()}.jpg`;
        const manualType = `FACE:${slot}`;

        try{
          setBusy(true);

          const result = await postAction("saveManualLog", {
            code,
            lat: lastGps.lat,
            lng: lastGps.lng,
            evidenceBase64,
            evidenceName,
            manualType
          });

          localStorage.setItem(LS_LAST, JSON.stringify({
            at: nowTH(),
            title: `‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (FACE:${slot}) ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™ ${code}`,
            detail: result?.status ? ("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " + result.status) : "-"
          }));
          renderLast();

          setFaceStep(3, "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
          toast("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");

          // ‚úÖ ‡∏à‡∏ö‡∏á‡∏≤‡∏ô: ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢ (‡∏ï‡∏≤‡∏°‡∏ü‡∏µ‡∏• ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‚Äù)
          stopFace();

          showSection("secCheck");
          $("cCode").value = code;
          await checkToday();
        }catch(e){
          setFaceStep(2, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)");
          toast("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      $("btnConfirmFace")?.addEventListener("click", confirmFaceAndSave);

      // =========================
      // Manual save -> saveManualLog
      // =========================
      async function submitManual(){
        if (busy) return;

        const code = ($("mCode").value || "").trim();
        const reason = ($("mReason").value || "").trim();
        const slot = ($("mSlotMode").value || "AUTO").trim();

        if (!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        if (!reason) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•");
        if (!lastGps) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ GPS ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Äî ‡∏Å‡∏î ‚Äú‡∏Ç‡∏≠ GPS‚Äù");

        let evidenceBase64 = "";
        let evidenceName = "";
        const file = $("mEvidenceFile").files?.[0] || null;
        if (file) {
          evidenceBase64 = await fileToDataURL(file);
          evidenceName = file.name || `manual-${code}-${Date.now()}.jpg`;
        }

        const safeReason = reason.replace(/\s+/g," ").slice(0, 80);
        const manualType = `MANUAL:${slot}:${safeReason}`;

        try{
          setBusy(true);
          const result = await postAction("saveManualLog", {
            code,
            lat: lastGps.lat,
            lng: lastGps.lng,
            evidenceBase64,
            evidenceName,
            manualType
          });

          localStorage.setItem(LS_LAST, JSON.stringify({
            at: nowTH(),
            title: `üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (MANUAL:${slot}) ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™ ${code}`,
            detail: safeReason
          }));
          renderLast();

          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
          showSection("secCheck");
          $("cCode").value = code;
          await checkToday();
        }catch(e){
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }
      $("btnSubmitManual")?.addEventListener("click", submitManual);

      // =========================
      // Check today -> UI card
      // =========================
      function classifyStatus(st) {
        const s = String(st || "");
        if (s === "‡∏Ç‡∏≤‡∏î") return "bad";
        if (!s || s === "‡∏õ‡∏Å‡∏ï‡∏¥") return "ok";
        return "warn";
      }

      function buildTimesRow(log){
        if (!log) return "-";
        const t = [];
        if (log.t1) t.push(`t1: ${log.t1}`);
        if (log.t2) t.push(`t2: ${log.t2}`);
        if (log.t3) t.push(`t3: ${log.t3}`);
        if (log.t4) t.push(`t4: ${log.t4}`);
        if (log.tExtra1) t.push(`extra1: ${log.tExtra1}`);
        if (log.tExtra2) t.push(`extra2: ${log.tExtra2}`);
        return t.length ? t.join(" ‚Ä¢ ") : "-";
      }

      function renderCheckUI(result){
        const wrap = $("checkUi");
        const msg = $("checkMsg");
        const dbg = $("checkDebug");

        wrap.innerHTML = "";
        if (!result) {
          msg.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
          return;
        }

        const found = !!result.found;
        msg.textContent = found ? "‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚úÖ" : (result.message || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

        if (!found) return;

        const emp = result.employee || {};
        const log = result.log || {};
        const cls = classifyStatus(log.status);
        const chipClass = cls==="ok" ? "ok" : cls==="bad" ? "bad" : "warn";

        const evidence = log.evidenceUrl ? `<a href="${escapeHtml(log.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</a>` : "-";

        wrap.innerHTML = `
          <div class="info mt12">
            <div style="font-weight:600">${escapeHtml(emp.fullName || "-")} (‡∏£‡∏´‡∏±‡∏™ ${escapeHtml(emp.code || "-")})</div>
            <div class="small muted mt8">‡πÅ‡∏ú‡∏ô‡∏Å: ${escapeHtml(emp.branch || "-")} ‚Ä¢ ‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escapeHtml(emp.level || "-")}</div>
            <div class="mt10">
              <span class="statusChip ${chipClass}">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${escapeHtml(log.status || "-")}</span>
            </div>
            <div class="small muted mt10">‡πÄ‡∏ß‡∏•‡∏≤: ${escapeHtml(buildTimesRow(log))}</div>
            <div class="small muted mt10">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô: ${evidence}</div>
          </div>
        `;

        if (dbg) dbg.textContent = JSON.stringify(result, null, 2);
      }

      async function checkToday(){
        const code = ($("cCode").value || "").trim();
        if (!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");

        try{
          setBusy(true);
          const result = await postAction("getTodayByCode", { code });
          renderCheckUI(result);
          toast("‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        }catch(e){
          $("checkMsg").textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
          $("checkUi").innerHTML = `<div class="small muted mt8">‚ùå ${escapeHtml(e.message)}</div>`;
          $("checkDebug").textContent = e.message;
          toast("‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      $("btnCheck")?.addEventListener("click", checkToday);

      let debugOn = false;
      $("btnToggleDebug")?.addEventListener("click", () => {
        debugOn = !debugOn;
        $("checkDebug").classList.toggle("hide", !debugOn);
      });

      // =========================
      // Summary today
      // =========================
      function renderSummary(rows, filterText="") {
        const q = String(filterText || "").trim().toLowerCase();
        const body = $("sumBody");

        const filtered = rows.filter(r => {
          if (!q) return true;
          const t = `${r.code} ${r.fullName} ${r.branch} ${r.level} ${r.status}`.toLowerCase();
          return t.includes(q);
        });

        if (!filtered.length) {
          body.innerHTML = `<tr><td colspan="6" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
          return;
        }

        body.innerHTML = filtered.map(r => {
          const t = [r.t1,r.t2,r.t3,r.t4].filter(Boolean).join(" ‚Ä¢ ") || "-";
          const cls = classifyStatus(r.status);
          const chipClass = cls==="ok" ? "ok" : cls==="bad" ? "bad" : "warn";
          return `
            <tr>
              <td style="font-weight:600">${escapeHtml(r.code)}</td>
              <td>${escapeHtml(r.fullName || "")}</td>
              <td>${escapeHtml(r.branch || "")}</td>
              <td>${escapeHtml(r.level || "")}</td>
              <td>${escapeHtml(t)}</td>
              <td><span class="statusChip ${chipClass}">${escapeHtml(r.status || "-")}</span></td>
            </tr>
          `;
        }).join("");
      }

      async function loadSummary(){
        try{
          setBusy(true);
          const rows = await postAction("getTodaySummary", {});
          lastSummary = Array.isArray(rows) ? rows : (rows.rows || []);
          renderSummary(lastSummary, $("sumSearch").value);
          toast("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        }catch(e){
          toast("‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      $("btnLoadSummary")?.addEventListener("click", loadSummary);
      $("sumSearch")?.addEventListener("input", () => renderSummary(lastSummary, $("sumSearch").value));

      function toCSV(rows){
        const headers = ["date","code","fullName","branch","level","t1","t2","t3","t4","tExtra1","tExtra2","status","evidenceUrl","locationText","lat","lng","rawType","method","note","updatedAt"];
        const esc = (v) => {
          const s = String(v ?? "");
          const needs = /[",\n]/.test(s);
          const q = s.replaceAll('"','""');
          return needs ? `"${q}"` : q;
        };
        const lines = [];
        lines.push(headers.join(","));
        rows.forEach(r => lines.push(headers.map(h => esc(r[h])).join(",")));
        return lines.join("\n");
      }
      function download(name, text){
        const blob = new Blob([text], { type:"text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      $("btnExportCsv")?.addEventListener("click", () => {
        if (!lastSummary.length) return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô");
        download(`today_summary_${todayISO()}.csv`, toCSV(lastSummary));
      });

      // =========================
      // HR: login + gate admin.html
      // =========================
      function setHrState(ok, msg){
        const dot = $("hrDot");
        const txt = $("hrText");
        dot.classList.remove("ok","warn","bad");
        dot.classList.add(ok ? "ok" : "warn");
        txt.textContent = msg;
        $("btnGoAdmin").disabled = !ok;
        $("btnLogout").disabled = !ok;
        // capture ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° step ‡πÉ‡∏ô loop ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ ‡πÅ‡∏ï‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        if (!ok) $("btnCaptureReg").disabled = true;
      }

      function isHrLoggedIn(){
        return localStorage.getItem(LS_HR_OK) === "1";
      }

      function applyHrUI(){
        if (isHrLoggedIn()) setHrState(true, "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        else setHrState(false, "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      }

      async function loginHR(){
        const username = ($("hrUser").value || "").trim();
        const password = ($("hrPass").value || "").trim();
        if (!username || !password) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username/Password");

        try{
          setBusy(true);
          const res = await postAction("loginAdmin", { username, password });
          const token = res?.token || "";
          localStorage.setItem(LS_HR, token);
          localStorage.setItem(LS_HR_OK, "1");
          applyHrUI();
          toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        }catch(e){
          localStorage.removeItem(LS_HR);
          localStorage.removeItem(LS_HR_OK);
          applyHrUI();
          toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      function logoutHR(){
        localStorage.removeItem(LS_HR);
        localStorage.removeItem(LS_HR_OK);
        applyHrUI();
        toast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß");
      }

      $("btnLogin")?.addEventListener("click", loginHR);
      $("btnLogout")?.addEventListener("click", logoutHR);

      $("btnGoAdmin")?.addEventListener("click", () => {
        if (!isHrLoggedIn()) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‡∏Å‡πà‡∏≠‡∏ô");
        location.href = "./admin.html";
      });

      // =========================
      // HR Registration: camera + compute descriptor + uploadEmployeeFace
      // =========================
      function setRegStep(step, msg){
        const el = $("regStepLine");
        if (el) el.textContent = `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ${step}/3: ${msg}`;
      }

      function stopReg(){
        regDetLoopId += 1; // cancel loop
        stopStream(streamReg);
        streamReg = null;
        const v = $("videoReg");
        if (v) { v.pause(); v.srcObject = null; v.style.display = "none"; }
        $("camHintReg").style.display = "flex";
        clearOverlay($("overlayReg"));
        $("btnCaptureReg").disabled = true;
        $("regHint").textContent = "‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ß‡πà‡∏≤ ‚Äú‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
        setRegStep(1, "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");
      }

      async function startReg(){
        if (!isHrLoggedIn()) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‡∏Å‡πà‡∏≠‡∏ô");
        stopReg();
        const okModels = await loadFaceModels();
        if (!okModels) return;

        try{
          setBusy(true);
          streamReg = await navigator.mediaDevices.getUserMedia({ video: { facingMode:"user" }, audio:false });
          const v = $("videoReg");
          v.srcObject = streamReg;
          await v.play();
          v.style.display = "block";
          $("camHintReg").style.display = "none";
          resizeOverlayToVideo($("overlayReg"), v);

          setRegStep(1, "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Ä¶");
          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");

          const myLoopId = ++regDetLoopId;

          const loop = async () => {
            if (!streamReg) return;
            if (myLoopId !== regDetLoopId) return;

            try{
              const det = await faceapi
                .detectSingleFace(v, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptor();

              if (!det) {
                clearOverlay($("overlayReg"));
                $("regHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äî ‡∏Ç‡∏¢‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î/‡πÅ‡∏™‡∏á‡∏û‡∏≠‡∏î‡∏µ";
                $("btnCaptureReg").disabled = true;
                setRegStep(1, "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡∏Ç‡∏¢‡∏±‡∏ö/‡πÅ‡∏™‡∏á/‡∏£‡∏∞‡∏¢‡∏∞)");
              } else {
                drawBox($("overlayReg"), det.detection.box, true);
                $("regHint").textContent = "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚úÖ ‡∏Å‡∏î ‚Äú‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û+‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
                $("btnCaptureReg").disabled = false;
                setRegStep(2, "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                window.__lastRegDet = det;
              }
            }catch{}

            requestAnimationFrame(loop);
          };

          requestAnimationFrame(loop);

        }catch(e){
          stopReg();
          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      $("btnStartReg")?.addEventListener("click", startReg);
      $("btnStopReg")?.addEventListener("click", () => { stopReg(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß"); });

      async function captureAndUploadReg(){
        if (busy) return;
        if (!isHrLoggedIn()) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‡∏Å‡πà‡∏≠‡∏ô");
        const code = ($("regCode").value || "").trim();
        const note = ($("regNote").value || "").trim();
        if (!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");

        const det = window.__lastRegDet;
        if (!det || !det.descriptor) return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äî ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô");

        setRegStep(3, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Ä¶");

        const descriptorArr = Array.from(det.descriptor);
        const faceData = JSON.stringify({ descriptors: [descriptorArr] });

        const token = localStorage.getItem(LS_HR) || "";

        const v = $("videoReg");
        const evidenceBase64 = (v && v.readyState >= 2) ? captureFrameToJpegDataUrl(v, 0.82) : "";
        const evidenceName = `hr-face-${code}-${Date.now()}.jpg`;

        try{
          setBusy(true);

          const result = await postAction("uploadEmployeeFace", {
            code,
            faceData,
            note,
            token,
            evidenceBase64,
            evidenceName
          });

          await loadInitial();

          $("hrDebugWrap").style.display = "block";
          $("hrDebug").textContent = JSON.stringify({ ok:true, result }, null, 2);

          setRegStep(3, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        }catch(e){
          $("hrDebugWrap").style.display = "block";
          $("hrDebug").textContent = JSON.stringify({ ok:false, error: e.message }, null, 2);
          setRegStep(2, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)");
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      $("btnCaptureReg")?.addEventListener("click", captureAndUploadReg);

      // =========================
      // Last UI log
      // =========================
      function renderLast(){
        const el = $("lastLine");
        if (!el) return;
        const raw = localStorage.getItem(LS_LAST);
        if (!raw) { el.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ"; return; }
        try{
          const o = JSON.parse(raw);
          el.textContent = `${o.at || "-"} ‚Ä¢ ${o.title || "-"} ${o.detail ? "‚Ä¢ " + o.detail : ""}`;
        }catch{
          el.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ";
        }
      }

      // =========================
      // Clear Local
      // =========================
      $("btnClearLocal")?.addEventListener("click", () => {
        localStorage.removeItem(LS_LAST);
        toast("‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        renderLast();
      });

      // =========================
      // Utilities
      // =========================
      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      // =========================
      // Init
      // =========================
      function tickNow(){
        const el = $("nowBadge");
        if (el) el.textContent = nowTH();
        requestAnimationFrame(() => {});
      }
      setInterval(tickNow, 1000 * 20);
      tickNow();

      $("cDate") && ($("cDate").value = todayISO());

      refreshApiUI();
      applyHrUI();
      setGpsUI(lastGps);
      renderLast();

      setFaceStep(1, "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô");
      setRegStep(1, "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");

      if (navigator.mediaDevices?.enumerateDevices) {
        loadCameras($("cameraSelectFace"));
      }

      window.addEventListener("beforeunload", () => {
        try { stopFace(); } catch {}
        try { stopReg(); } catch {}
      });

    })();
  </script>

</body>
</html>
