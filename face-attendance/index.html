<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Ä¢ Face/Manual Attendance</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#16a34a;
      --red:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 12px 30px rgba(2,6,23,.08);
      --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Prompt",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(246,248,251,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .topbar .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
    }
    .badge{
      font-size:12px;
      padding:4px 8px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background:#fff;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary{ background:var(--blue); border-color:var(--blue); color:#fff; }
    .btn.primary:hover{ background:var(--blue2); border-color:var(--blue2); }
    .btn.danger{ background:var(--red); border-color:var(--red); color:#fff; }
    .btn.ghost{ background:transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .iconbtn{
      width:44px; height:44px;
      display:grid; place-items:center;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
    }
    .hamburger{
      width:18px; height:12px; position:relative;
    }
    .hamburger span{
      position:absolute; left:0; right:0;
      height:2px; background:#0f172a; border-radius:999px;
    }
    .hamburger span:nth-child(1){ top:0; }
    .hamburger span:nth-child(2){ top:5px; }
    .hamburger span:nth-child(3){ top:10px; }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media(min-width:980px){
      .container{ grid-template-columns: 1.2fr .8fr; }
      .full{ grid-column: 1 / -1; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .card .hd h3{
      margin:0;
      font-size:16px;
      line-height:1.2;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }
    .card .bd{ padding:14px; }

    .grid2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:680px){ .grid2{ grid-template-columns:1fr 1fr; } }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      width:100%;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    .input{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      outline:none;
      background:#fff;
      font-size:14px;
    }

    /* camera */
    .camWrap{
      position:relative;
      width:100%;
      aspect-ratio: 4/3;
      background:#0b1020;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    canvas.overlay{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }
    .camHint{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      color:#cbd5e1;
      text-align:center;
      padding:18px;
      gap:8px;
    }
    .camHint b{ color:#fff; font-size:16px; }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color:#e2e8f0;
      font-size:12px;
    }
    .camTop{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .camTop .pill{ pointer-events:auto; }
    .camBottom{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      pointer-events:none;
    }
    .camBottom .stack{
      display:flex;
      flex-direction:column;
      gap:6px;
      pointer-events:auto;
    }

    /* drawer */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      z-index:80;
    }
    .drawer{
      position:fixed;
      top:0; right:-360px;
      width:340px; max-width:92vw;
      height:100%;
      background:#fff;
      border-left:1px solid var(--border);
      box-shadow: -18px 0 40px rgba(2,6,23,.18);
      z-index:90;
      transition:right .22s ease;
      display:flex;
      flex-direction:column;
    }
    .drawer.open{ right:0; }
    .backdrop.open{ display:block; }
    .drawer .dhd{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .drawer .dhd b{ font-size:15px; }
    .drawer .dbd{ padding:14px; display:flex; flex-direction:column; gap:10px; overflow:auto; }
    .divider{ height:1px; background:var(--border); margin:6px 0; }
    .small{ font-size:12px; color:var(--muted); }

    /* modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.6);
      display:none;
      z-index:120;
      padding:14px;
    }
    .modalBackdrop.open{ display:grid; place-items:center; }
    .modal{
      width:560px;
      max-width:100%;
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 24px 70px rgba(2,6,23,.28);
      overflow:hidden;
    }
    .modal .mhd{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal .mhd b{ font-size:15px; }
    .modal .mbd{ padding:14px; }
    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      background:#0b1226;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 16px 50px rgba(2,6,23,.35);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:200;
      max-width:92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      text-align:left;
      vertical-align:top;
    }
    th{ background:#f8fafc; font-size:12px; color:var(--muted); }
    tr:last-child td{ border-bottom:none; }
    .statusOk{ color:var(--green); font-weight:700; }
    .statusBad{ color:var(--red); font-weight:700; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; color:var(--muted); }

  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <span style="display:inline-grid;place-items:center;width:36px;height:36px;border-radius:12px;background:#fff;border:1px solid var(--border);">‚è±Ô∏è</span>
        <div>
          ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          <div class="sub">Face Scan + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</div>
        </div>
      </div>

      <div class="row">
        <span class="badge" id="nowBadge">--:--</span>
        <button class="iconbtn" id="btnMenu" aria-label="menu">
          <div class="hamburger" aria-hidden="true">
            <span></span><span></span><span></span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div class="backdrop" id="backdrop"></div>
  <aside class="drawer" id="drawer">
    <div class="dhd">
      <b>‡πÄ‡∏°‡∏ô‡∏π</b>
      <button class="btn" id="btnCloseDrawer">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="dbd">
      <div class="small">API URL</div>
      <input class="input" id="apiUrlInput" placeholder="‡∏ß‡∏≤‡∏á URL /exec ‡∏Ç‡∏≠‡∏á Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" />
      <div class="row">
        <button class="btn primary" id="btnSaveApi">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL</button>
        <button class="btn" id="btnPing">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Ping</button>
      </div>

      <div class="divider"></div>

      <button class="btn" id="btnGoAdmin">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</button>
      <div class="small">* ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>

      <div class="divider"></div>
      <button class="btn danger" id="btnResetUrl">Reset URL</button>

      <div class="divider"></div>
      <div class="small">
        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ https ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Camera/Location ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="container">

    <!-- FACE CHECK-IN -->
    <section class="card">
      <div class="hd">
        <div>
          <h3>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</h3>
          <div class="sub" id="faceSub">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏î‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö ‚Üí ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>
        </div>
        <div class="row">
          <button class="btn primary" id="btnStartFace">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
          <button class="btn" id="btnStopFace" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
        </div>
      </div>

      <div class="bd">
        <div class="camWrap">
          <div class="camTop">
            <span class="pill" id="pillFaces">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</span>
            <span class="pill" id="pillGps">GPS: --</span>
          </div>

          <video id="videoFace" playsinline muted></video>
          <canvas class="overlay" id="overlayFace"></canvas>

          <div class="camHint" id="camHintFace">
            <div>
              <b>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</b>
              <div style="opacity:.9;margin-top:6px;">
                ‡∏Å‡∏î ‚Äú‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á<br/>
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏ô‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
              </div>
            </div>
          </div>

          <div class="camBottom">
            <div class="stack">
              <span class="pill" id="pillDetected">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
              <span class="pill" id="pillMatch">‡∏û‡∏ö: -</span>
            </div>

            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á) -->
            <div class="stack">
              <button class="btn primary" id="btnConfirmFace" disabled>‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;" class="small">
          * ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î)
        </div>
      </div>
    </section>

    <!-- LAST RESULT + MANUAL -->
    <section class="card">
      <div class="hd">
        <div>
          <h3>üßæ ‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
          <div class="sub" id="lastLine">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</div>
        </div>
        <button class="btn" id="btnClearLast">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
      <div class="bd">
        <div class="row">
          <button class="btn primary" id="btnOpenManual">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</button>
          <button class="btn" id="btnRefreshSummary">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>

        <div class="divider"></div>

        <!-- HR register -->
        <div class="row" style="justify-content:space-between;">
          <div>
            <div style="font-weight:800;">üßë‚Äçüíº HR: ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
            <div class="small" id="hrState">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ HR: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</div>
          </div>
          <div class="row">
            <button class="btn" id="btnHrLogin">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR</button>
            <button class="btn danger" id="btnHrLogout" disabled>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>

        <div style="margin-top:12px;" class="camWrap">
          <div class="camTop">
            <span class="pill" id="pillHr">HR Camera: ‡∏õ‡∏¥‡∏î</span>
            <span class="pill" id="pillHrHint">‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á</span>
          </div>

          <video id="videoReg" playsinline muted></video>
          <canvas class="overlay" id="overlayReg"></canvas>

          <div class="camHint" id="camHintReg">
            <div>
              <b>‡πÇ‡∏´‡∏°‡∏î HR</b>
              <div style="opacity:.9;margin-top:6px;">
                ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‚Üí ‡πÉ‡∏™‡πà ‚Äú‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‚Äù ‚Üí ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û+‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </div>
            </div>
          </div>

          <div class="camBottom">
            <div class="stack">
              <span class="pill" id="regHint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</span>
            </div>
            <div class="stack row" style="gap:8px;">
              <button class="btn primary" id="btnStartReg" disabled>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR</button>
              <button class="btn" id="btnStopReg" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px;">
          <div class="field">
            <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤)</label>
            <input class="input" id="regCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0001" />
          </div>
          <div class="field" style="justify-content:flex-end;">
            <label>&nbsp;</label>
            <button class="btn primary" id="btnCaptureReg" disabled>üì∏ ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û+‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
          </div>
        </div>

        <div class="small" style="margin-top:8px;">
          ‚úÖ ‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß: ‡∏™‡πà‡∏á photoBase64/fileName/faceData ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö GS + faceData ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array JSON ‡πÉ‡∏ä‡πâ faceCheckIn ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
        </div>

        <pre class="mono" id="hrDebug" style="margin-top:10px; display:none; white-space:pre-wrap;"></pre>
      </div>
    </section>

    <!-- TODAY SUMMARY -->
    <section class="card full">
      <div class="hd">
        <div>
          <h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <div class="sub">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Export CSV ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)</div>
        </div>
      </div>
      <div class="bd" style="overflow:auto;">
        <div id="summaryWrap" class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</div>
      </div>
    </section>

  </main>

  <!-- MODALS -->
  <!-- Admin Login (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin" ‡πÅ‡∏•‡∏∞ "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR") -->
  <div class="modalBackdrop" id="modalAdminLogin">
    <div class="modal">
      <div class="mhd">
        <b id="adminModalTitle">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</b>
        <button class="btn" id="btnCloseAdminModal">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="mbd">
        <div class="grid2">
          <div class="field">
            <label>Username</label>
            <input class="input" id="adminUser" value="admin" />
          </div>
          <div class="field">
            <label>Password</label>
            <input class="input" id="adminPass" type="password" value="1234567890" />
          </div>
        </div>

        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button class="btn primary" id="btnDoAdminLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div class="small" id="adminLoginNote" style="margin-top:10px;"> </div>
      </div>
    </div>
  </div>

  <!-- Manual Log Modal -->
  <div class="modalBackdrop" id="modalManual">
    <div class="modal">
      <div class="mhd">
        <b>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠</b>
        <button class="btn" id="btnCloseManual">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="mbd">
        <div class="field">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input class="input" id="mCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0001" />
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div class="field">
            <label>GPS</label>
            <input class="input" id="mGps" disabled value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î..." />
          </div>
          <div class="field">
            <label>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input class="input" id="mEvidence" type="file" accept="image/*" />
          </div>
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between;">
          <button class="btn" id="btnGetGps">üìç ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
          <button class="btn primary" id="btnSaveManual">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
        <div class="small" style="margin-top:10px;">
          * ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏ó‡∏ô ‚Äú‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‚Äù (‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">-</div>

  <!-- face-api -->
  <script src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    (() => {
      // ========= CONFIG =========
      const LS_API = "attendance_api_url_v2";
      const LS_LAST = "attendance_last_result_v2";
      const LS_HR = "attendance_hr_token_v2";
      const LS_ADMIN_NAV = "attendance_admin_nav_token_v2";

      // ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö GS
      const FACE_THRESHOLD = 0.55;
      const MODELS_PATH = "./models";

      // ========= DOM helpers =========
      const $ = (id) => document.getElementById(id);

      let busy = false;
      let apiUrl = localStorage.getItem(LS_API) || "";
      let lastGps = { lat:null, lng:null, at:0 };

      // Face scan state
      let streamFace = null;
      let faceModelsLoaded = false;
      let faceList = []; // [{code, fullName, vec:Float32Array}]
      let faceListLoadedAt = 0;
      let lastFaceDescriptor = null; // Float32Array
      let bestMatch = null; // {code, fullName, dist}
      let rafFace = 0;

      // HR reg state
      let streamReg = null;
      let rafReg = 0;
      let lastRegDet = null;

      // ========= UI =========
      function toast(msg){
        const el = $("toast");
        el.textContent = msg;
        el.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => el.classList.remove("show"), 2200);
      }

      function setBusy(v){
        busy = v;
        // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ö‡∏≤‡∏á‡∏à‡∏∏‡∏î
        $("btnStartFace").disabled = v || !!streamFace;
        $("btnStopFace").disabled = v || !streamFace;
        $("btnConfirmFace").disabled = v || !bestMatch || bestMatch.dist > FACE_THRESHOLD;

        $("btnSaveApi").disabled = v;
        $("btnPing").disabled = v;
        $("btnResetUrl").disabled = v;

        $("btnDoAdminLogin").disabled = v;
        $("btnSaveManual").disabled = v;

        // HR
        $("btnCaptureReg").disabled = v || !lastRegDet || !isHrLoggedIn();
      }

      function nowTH(){
        const d = new Date();
        return d.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"});
      }
      function tickNow(){
        $("nowBadge").textContent = nowTH();
      }
      setInterval(tickNow, 1000 * 20);
      tickNow();

      function setPill(el, text){
        el.textContent = text;
      }

      function applyApiUI(){
        $("apiUrlInput").value = apiUrl;
      }

      function openDrawer(){
        $("drawer").classList.add("open");
        $("backdrop").classList.add("open");
      }
      function closeDrawer(){
        $("drawer").classList.remove("open");
        $("backdrop").classList.remove("open");
      }

      function openModal(id){
        $(id).classList.add("open");
      }
      function closeModal(id){
        $(id).classList.remove("open");
      }

      // ========= Network =========
      function mustApi(){
        if(!apiUrl) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL");
      }

      async function postAction(action, payload={}){
        mustApi();
        const body = { action, ...payload };
        const res = await fetch(apiUrl, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        return json.result;
      }

      // ========= GPS =========
      function setGpsUI(g){
        if(g && g.lat != null && g.lng != null){
          setPill($("pillGps"), `GPS: ‚úÖ ${Number(g.lat).toFixed(5)}, ${Number(g.lng).toFixed(5)}`);
          $("mGps").value = `${Number(g.lat).toFixed(6)}, ${Number(g.lng).toFixed(6)}`;
        }else{
          setPill($("pillGps"), "GPS: --");
          $("mGps").value = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î";
        }
      }

      function getGps(){
        return new Promise((resolve) => {
          if(!navigator.geolocation){
            toast("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
            return resolve(null);
          }
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              lastGps = { lat: pos.coords.latitude, lng: pos.coords.longitude, at: Date.now() };
              setGpsUI(lastGps);
              resolve(lastGps);
            },
            (err) => {
              toast("‡∏≠‡πà‡∏≤‡∏ô GPS ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message);
              setGpsUI(lastGps);
              resolve(null);
            },
            { enableHighAccuracy:true, timeout: 9000, maximumAge: 20000 }
          );
        });
      }

      // ========= Face models =========
      async function loadFaceModels(){
        if(faceModelsLoaded) return true;
        try{
          setBusy(true);
          await faceapi.nets.tinyFaceDetector.loadFromUri(MODELS_PATH);
          await faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_PATH);
          await faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_PATH);
          faceModelsLoaded = true;
          return true;
        }catch(e){
          toast("‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå models): " + e.message);
          return false;
        }finally{
          setBusy(false);
        }
      }

      // ========= Face list (AUTO) =========
      function parseFaceDataToVec(str){
        if(!str) return null;
        try{
          const a = JSON.parse(str);
          if(!Array.isArray(a) || a.length < 16) return null;
          const f = new Float32Array(a.length);
          for(let i=0;i<a.length;i++) f[i] = Number(a[i]) || 0;
          return f;
        }catch{
          return null;
        }
      }

      function euclid(a, b){
        let s = 0;
        const n = Math.min(a.length, b.length);
        for(let i=0;i<n;i++){
          const x = a[i] - b[i];
          s += x*x;
        }
        return Math.sqrt(s);
      }

      async function ensureFaceList(force=false){
        const stale = (Date.now() - faceListLoadedAt) > (1000 * 60 * 5); // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
        if(!force && faceList.length && !stale) return;

        try{
          setPill($("pillFaces"), "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...");
          const list = await postAction("getFaceDescriptors", {});
          const out = [];
          (list || []).forEach(it => {
            const vec = parseFaceDataToVec(String(it.faceData || ""));
            if(vec){
              out.push({
                code: String(it.code || "").trim(),
                fullName: String(it.fullName || ""),
                vec
              });
            }
          });
          faceList = out;
          faceListLoadedAt = Date.now();
          setPill($("pillFaces"), `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‚úÖ ${faceList.length} ‡∏Ñ‡∏ô (${new Date(faceListLoadedAt).toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit"})})`);
        }catch(e){
          faceList = [];
          setPill($("pillFaces"), "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          toast("‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }
      }

      // ========= Canvas overlay =========
      function resizeOverlayToVideo(canvas, video){
        const rect = video.getBoundingClientRect();
        canvas.width = Math.floor(rect.width);
        canvas.height = Math.floor(rect.height);
      }
      function clearOverlay(canvas){
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
      function drawBox(canvas, box, ok){
        const ctx = canvas.getContext("2d");
        clearOverlay(canvas);
        const w = canvas.width, h = canvas.height;

        // box ‡∏à‡∏≤‡∏Å faceapi ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î video ‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ matchDimensions
        // ‡πÄ‡∏£‡∏≤‡∏ß‡∏≤‡∏î‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ faceapi.draw
        try{
          const dims = { width: w, height: h };
          const resized = faceapi.resizeResults({ detection:{ box } }, dims);
          const b = resized.detection.box;
          ctx.lineWidth = 3;
          ctx.strokeStyle = ok ? "#22c55e" : "#f59e0b";
          ctx.strokeRect(b.x, b.y, b.width, b.height);
        }catch{}
      }

      // ========= Face camera =========
      function stopStream(stream){
        if(!stream) return;
        try{
          stream.getTracks().forEach(t => t.stop());
        }catch{}
      }

      async function startFace(){
        const okModels = await loadFaceModels();
        if(!okModels) return;

        try{
          setBusy(true);

          await ensureFaceList(true); // ‚úÖ auto load list
          if(!faceList.length){
            toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ (‡πÉ‡∏´‡πâ HR ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô)");
          }

          streamFace = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });

          const v = $("videoFace");
          v.srcObject = streamFace;
          await v.play();
          v.style.display = "block";
          $("camHintFace").style.display = "none";

          resizeOverlayToVideo($("overlayFace"), v);

          // try gps (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
          getGps();

          // loop detect
          const loop = async () => {
            if(!streamFace) return;
            try{
              const det = await faceapi
                .detectSingleFace(v, new faceapi.TinyFaceDetectorOptions({ inputSize:224, scoreThreshold:0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptor();

              if(!det){
                lastFaceDescriptor = null;
                bestMatch = null;
                setPill($("pillDetected"), "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");
                setPill($("pillMatch"), "‡∏û‡∏ö: -");
                clearOverlay($("overlayFace"));
                $("btnConfirmFace").disabled = true;
              }else{
                lastFaceDescriptor = det.descriptor; // Float32Array(128)
                // match client-side
                let best = { code:null, fullName:"", dist: 999 };
                for(const e of faceList){
                  const d = euclid(lastFaceDescriptor, e.vec);
                  if(d < best.dist){
                    best = { code:e.code, fullName:e.fullName, dist:d };
                  }
                }
                bestMatch = best;

                const ok = best.code && best.dist <= FACE_THRESHOLD;
                drawBox($("overlayFace"), det.detection.box, ok);
                setPill($("pillDetected"), ok ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚úÖ" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠");
                if(best.code){
                  setPill($("pillMatch"), `‡∏û‡∏ö: ${best.fullName} (${best.code}) ‚Ä¢ dist=${best.dist.toFixed(3)}`);
                }else{
                  setPill($("pillMatch"), "‡∏û‡∏ö: -");
                }
                $("btnConfirmFace").disabled = !ok || busy;
              }
            }catch{}
            rafFace = requestAnimationFrame(loop);
          };
          rafFace = requestAnimationFrame(loop);

          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        }catch(e){
          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
          stopFace();
        }finally{
          setBusy(false);
          $("btnStartFace").disabled = !!streamFace;
          $("btnStopFace").disabled = !streamFace;
        }
      }

      function stopFace(){
        if(rafFace) cancelAnimationFrame(rafFace);
        rafFace = 0;

        stopStream(streamFace);
        streamFace = null;

        const v = $("videoFace");
        v.pause?.();
        v.srcObject = null;
        v.style.display = "none";
        $("camHintFace").style.display = "grid";
        clearOverlay($("overlayFace"));

        lastFaceDescriptor = null;
        bestMatch = null;
        setPill($("pillDetected"), "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");
        setPill($("pillMatch"), "‡∏û‡∏ö: -");
        $("btnConfirmFace").disabled = true;

        $("btnStartFace").disabled = false;
        $("btnStopFace").disabled = true;
      }

      // ========= Confirm face check-in =========
      function setLastResult(title, detail){
        const o = { at: new Date().toLocaleString("th-TH"), title, detail };
        localStorage.setItem(LS_LAST, JSON.stringify(o));
        $("lastLine").textContent = `${o.at} ‚Ä¢ ${o.title}${o.detail ? " ‚Ä¢ " + o.detail : ""}`;
      }

      async function confirmFace(){
        if(busy) return;
        if(!bestMatch || bestMatch.dist > FACE_THRESHOLD || !lastFaceDescriptor){
          return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠");
        }
        try{
          setBusy(true);

          // ‡πÉ‡∏ä‡πâ GPS ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          const g = (lastGps && lastGps.lat != null) ? lastGps : null;

          const result = await postAction("faceCheckIn", {
            faceDescriptor: JSON.stringify(Array.from(lastFaceDescriptor)),
            lat: g ? g.lat : "",
            lng: g ? g.lng : ""
          });

          const who = result.employee ? `${result.employee.fullName} (${result.employee.code})` : (bestMatch.fullName + " (" + bestMatch.code + ")");
          setLastResult("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ", `${who} ‚Ä¢ ${result.slot || ""} ‚Ä¢ ${result.time || ""} ‚Ä¢ ${result.status || ""}`);
          toast("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");

          await loadTodaySummary();
        }catch(e){
          setLastResult("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå", e.message);
          toast("‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      // ========= Summary =========
      function renderSummary(rows){
        if(!rows || !rows.length){
          $("summaryWrap").innerHTML = `<div class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>`;
          return;
        }
        const html = `
          <table>
            <thead>
              <tr>
                <th>‡∏£‡∏´‡∏±‡∏™</th>
                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => {
                const st = String(r.status||"");
                const ok = (st === "‡∏õ‡∏Å‡∏ï‡∏¥");
                const times = [r.t1,r.t2,r.t3,r.t4].filter(Boolean).join(" ‚Ä¢ ");
                return `
                  <tr>
                    <td class="mono">${escapeHtml(r.code||"")}</td>
                    <td>${escapeHtml(r.fullName||"")}</td>
                    <td>${escapeHtml(r.branch||"")}</td>
                    <td>${escapeHtml(r.level||"")}</td>
                    <td class="mono">${escapeHtml(times || "-")}</td>
                    <td class="${ok ? "statusOk":"statusBad"}">${escapeHtml(st||"-")}</td>
                  </tr>
                `;
              }).join("")}
            </tbody>
          </table>
        `;
        $("summaryWrap").innerHTML = html;
      }

      async function loadTodaySummary(){
        try{
          $("summaryWrap").textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
          const rows = await postAction("getTodaySummary", {});
          renderSummary(rows || []);
        }catch(e){
          $("summaryWrap").innerHTML = `<div class="small">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${escapeHtml(e.message)}</div>`;
        }
      }

      // ========= Manual Log =========
      async function fileToBase64(file){
        return new Promise((resolve) => {
          if(!file) return resolve("");
          const fr = new FileReader();
          fr.onload = () => resolve(String(fr.result || ""));
          fr.onerror = () => resolve("");
          fr.readAsDataURL(file);
        });
      }

      async function saveManual(){
        if(busy) return;
        const code = ($("mCode").value || "").trim();
        if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");

        const g = await getGps();
        if(!g || g.lat == null) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");

        const file = $("mEvidence").files && $("mEvidence").files[0] ? $("mEvidence").files[0] : null;
        const b64 = await fileToBase64(file);
        const evidenceName = file ? file.name : (`evidence-${code}-${Date.now()}.jpg`);

        try{
          setBusy(true);
          const result = await postAction("saveManualLog", {
            code,
            lat: g.lat,
            lng: g.lng,
            evidenceBase64: b64,
            evidenceName,
            manualType: "MANUAL"
          });

          setLastResult("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ", `${result.employee?.fullName||""} (${result.employee?.code||code}) ‚Ä¢ ${result.slot||""} ‚Ä¢ ${result.time||""} ‚Ä¢ ${result.status||""}`);
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
          closeModal("modalManual");
          await loadTodaySummary();
        }catch(e){
          setLastResult("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå", e.message);
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      // ========= Admin login flow =========
      let adminLoginMode = "NAV"; // "NAV" or "HR"
      function isHrLoggedIn(){
        return !!localStorage.getItem(LS_HR);
      }
      function applyHrUI(){
        const ok = isHrLoggedIn();
        $("hrState").textContent = ok ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ HR: ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ HR: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô";
        $("btnHrLogout").disabled = !ok;
        $("btnStartReg").disabled = !ok || !!streamReg;
        $("btnStopReg").disabled = !ok || !streamReg;
        $("btnCaptureReg").disabled = !ok || !lastRegDet || busy;
        setPill($("pillHr"), ok ? (streamReg ? "HR Camera: ‡πÄ‡∏õ‡∏¥‡∏î" : "HR Camera: ‡∏õ‡∏¥‡∏î") : "HR Camera: ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      }

      function openAdminLogin(mode){
        adminLoginMode = mode;
        $("adminModalTitle").textContent = (mode === "NAV") ? "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin" : "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR";
        $("adminLoginNote").textContent = (mode === "NAV")
          ? "‡∏Å‡∏î‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
          : "‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î HR ‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤";
        openModal("modalAdminLogin");
      }

      async function doAdminLogin(){
        if(busy) return;
        const username = ($("adminUser").value || "").trim();
        const password = ($("adminPass").value || "").trim();
        if(!username || !password) return toast("‡∏Å‡∏£‡∏≠‡∏Å user/pass ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        try{
          setBusy(true);
          const r = await postAction("loginAdmin", { username, password });
          const token = r.token || "";

          if(adminLoginMode === "NAV"){
            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ token ‡πÄ‡∏Å‡πà‡∏≤
            localStorage.setItem(LS_ADMIN_NAV, token);
            closeModal("modalAdminLogin");
            closeDrawer();
            toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin");
            // ‡∏™‡πà‡∏á token ‡∏ú‡πà‡∏≤‡∏ô localStorage ‡∏Å‡πá‡∏û‡∏≠ (admin.html ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
            window.location.href = "admin.html";
          }else{
            localStorage.setItem(LS_HR, token);
            closeModal("modalAdminLogin");
            toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
            applyHrUI();
          }
        }catch(e){
          toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
        }finally{
          setBusy(false);
        }
      }

      function hrLogout(){
        localStorage.removeItem(LS_HR);
        toast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö HR ‡πÅ‡∏•‡πâ‡∏ß");
        stopReg();
        applyHrUI();
      }

      // ========= HR Register camera =========
      function captureFrameToDataUrl(video, quality=0.82){
        const c = document.createElement("canvas");
        c.width = video.videoWidth || 640;
        c.height = video.videoHeight || 480;
        const ctx = c.getContext("2d");
        ctx.drawImage(video, 0, 0, c.width, c.height);
        return c.toDataURL("image/jpeg", quality);
      }

      async function startReg(){
        if(!isHrLoggedIn()) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‡∏Å‡πà‡∏≠‡∏ô");
        const okModels = await loadFaceModels();
        if(!okModels) return;

        try{
          setBusy(true);
          streamReg = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }, audio:false });
          const v = $("videoReg");
          v.srcObject = streamReg;
          await v.play();
          v.style.display = "block";
          $("camHintReg").style.display = "none";
          resizeOverlayToVideo($("overlayReg"), v);
          setPill($("pillHr"), "HR Camera: ‡πÄ‡∏õ‡∏¥‡∏î");
          setPill($("pillHrHint"), "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤...");

          const loop = async () => {
            if(!streamReg) return;
            try{
              const det = await faceapi
                .detectSingleFace(v, new faceapi.TinyFaceDetectorOptions({ inputSize:224, scoreThreshold:0.5 }))
                .withFaceLandmarks()
                .withFaceDescriptor();
              if(!det){
                lastRegDet = null;
                clearOverlay($("overlayReg"));
                $("regHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚Äî ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠/‡πÅ‡∏™‡∏á‡∏û‡∏≠‡∏î‡∏µ";
                $("btnCaptureReg").disabled = true;
              }else{
                lastRegDet = det;
                drawBox($("overlayReg"), det.detection.box, true);
                $("regHint").textContent = "‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‚úÖ ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ";
                $("btnCaptureReg").disabled = busy || !isHrLoggedIn();
              }
            }catch{}
            rafReg = requestAnimationFrame(loop);
          };
          rafReg = requestAnimationFrame(loop);

          applyHrUI();
          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
        }catch(e){
          toast("‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
          stopReg();
        }finally{
          setBusy(false);
        }
      }

      function stopReg(){
        if(rafReg) cancelAnimationFrame(rafReg);
        rafReg = 0;

        stopStream(streamReg);
        streamReg = null;

        const v = $("videoReg");
        v.pause?.();
        v.srcObject = null;
        v.style.display = "none";
        $("camHintReg").style.display = "grid";
        clearOverlay($("overlayReg"));

        lastRegDet = null;
        $("regHint").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°";
        setPill($("pillHr"), isHrLoggedIn() ? "HR Camera: ‡∏õ‡∏¥‡∏î" : "HR Camera: ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
        setPill($("pillHrHint"), "‡∏£‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á");

        applyHrUI();
      }

      async function captureAndUploadReg(){
        if(busy) return;
        if(!isHrLoggedIn()) return toast("‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô HR ‡∏Å‡πà‡∏≠‡∏ô");
        const code = ($("regCode").value || "").trim();
        if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        if(!lastRegDet || !lastRegDet.descriptor) return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤");

        try{
          setBusy(true);
          $("hrDebug").style.display = "none";
          setPill($("pillHrHint"), "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");

          // ‚úÖ ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö GS: uploadEmployeeFace expects photoBase64 + fileName + faceData
          const v = $("videoReg");
          const photoBase64 = captureFrameToDataUrl(v, 0.82);
          const fileName = `face-${code}-${Date.now()}.jpg`;

          // ‚úÖ faceData ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô Array JSON (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà {descriptors:[]}) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ faceCheckIn ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
          const faceData = JSON.stringify(Array.from(lastRegDet.descriptor));

          const r = await postAction("uploadEmployeeFace", {
            code,
            photoBase64,
            fileName,
            faceData
          });

          // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î list ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
          await ensureFaceList(true);

          $("hrDebug").style.display = "block";
          $("hrDebug").textContent = JSON.stringify(r, null, 2);

          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
          setPill($("pillHrHint"), "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        }catch(e){
          $("hrDebug").style.display = "block";
          $("hrDebug").textContent = JSON.stringify({ ok:false, error: e.message }, null, 2);
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message);
          setPill($("pillHrHint"), "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚ùå");
        }finally{
          setBusy(false);
          applyHrUI();
        }
      }

      // ========= Escape =========
      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      // ========= Last result init =========
      function renderLast(){
        const raw = localStorage.getItem(LS_LAST);
        if(!raw){ $("lastLine").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ"; return; }
        try{
          const o = JSON.parse(raw);
          $("lastLine").textContent = `${o.at || "-"} ‚Ä¢ ${o.title || "-"}${o.detail ? " ‚Ä¢ " + o.detail : ""}`;
        }catch{
          $("lastLine").textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ";
        }
      }

      // ========= Events =========
      $("btnMenu").addEventListener("click", openDrawer);
      $("backdrop").addEventListener("click", closeDrawer);
      $("btnCloseDrawer").addEventListener("click", closeDrawer);

      $("btnSaveApi").addEventListener("click", () => {
        apiUrl = ($("apiUrlInput").value || "").trim();
        localStorage.setItem(LS_API, apiUrl);
        toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
      });
      $("btnPing").addEventListener("click", async () => {
        try{
          setBusy(true);
          const r = await postAction("ping", {});
          toast("Ping: " + (r.message || "pong"));
        }catch(e){
          toast("Ping ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: " + e.message);
        }finally{
          setBusy(false);
        }
      });
      $("btnResetUrl").addEventListener("click", () => {
        localStorage.removeItem(LS_API);
        apiUrl = "";
        applyApiUI();
        toast("Reset URL ‡πÅ‡∏•‡πâ‡∏ß");
      });

      // ‚úÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Admin ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      $("btnGoAdmin").addEventListener("click", () => {
        // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NAV ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        localStorage.removeItem(LS_ADMIN_NAV);
        openAdminLogin("NAV");
      });

      $("btnCloseAdminModal").addEventListener("click", () => closeModal("modalAdminLogin"));
      $("btnDoAdminLogin").addEventListener("click", doAdminLogin);

      $("btnStartFace").addEventListener("click", startFace);
      $("btnStopFace").addEventListener("click", () => { stopFace(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß"); });
      $("btnConfirmFace").addEventListener("click", confirmFace);

      $("btnClearLast").addEventListener("click", () => {
        localStorage.removeItem(LS_LAST);
        renderLast();
        toast("‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß");
      });

      $("btnRefreshSummary").addEventListener("click", loadTodaySummary);

      // manual modal
      $("btnOpenManual").addEventListener("click", async () => {
        openModal("modalManual");
        await getGps();
      });
      $("btnCloseManual").addEventListener("click", () => closeModal("modalManual"));
      $("btnGetGps").addEventListener("click", getGps);
      $("btnSaveManual").addEventListener("click", saveManual);

      // HR
      $("btnHrLogin").addEventListener("click", () => openAdminLogin("HR"));
      $("btnHrLogout").addEventListener("click", hrLogout);
      $("btnStartReg").addEventListener("click", startReg);
      $("btnStopReg").addEventListener("click", () => { stopReg(); toast("‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á HR ‡πÅ‡∏•‡πâ‡∏ß"); });
      $("btnCaptureReg").addEventListener("click", captureAndUploadReg);

      // ========= Init =========
      applyApiUI();
      renderLast();
      applyHrUI();
      setGpsUI(lastGps);
      loadTodaySummary();

      // try gps quietly
      getGps();

      // cleanup
      window.addEventListener("beforeunload", () => {
        try{ stopFace(); }catch{}
        try{ stopReg(); }catch{}
      });
    })();
  </script>
</body>
</html>
