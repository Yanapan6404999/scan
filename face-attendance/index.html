<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- face-api.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl sm:text-2xl font-bold text-blue-700">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      </h1>

      <div class="flex gap-2 text-sm">
        <button
          id="btnManual"
          class="px-3 sm:px-4 py-2 rounded bg-yellow-500 text-white font-semibold shadow hover:bg-yellow-600">
          ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏∑‡∏≠
        </button>
        <button
          id="btnCheck"
          class="px-3 sm:px-4 py-2 rounded bg-emerald-500 text-white font-semibold shadow hover:bg-emerald-600">
          ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
        </button>
        <button
          id="btnAdmin"
          class="px-3 sm:px-4 py-2 rounded bg-slate-800 text-white font-semibold shadow hover:bg-slate-900">
          ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
        </button>
        <button
          id="btnResetUrl"
          class="ml-2 text-xs underline text-gray-500 hover:text-gray-700">
          Reset URL
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto px-4 py-6 space-y-6">

      <!-- Camera panel -->
      <section class="bg-white rounded-xl shadow p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold mb-2">
          ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤
        </h2>
        <p class="text-sm text-gray-500 mb-4">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏ß‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢
        </p>

        <div class="w-full flex justify-center mb-4">
          <div class="relative bg-black rounded-lg overflow-hidden w-full max-w-xl aspect-video flex items-center justify-center">
            <video id="video" autoplay muted playsinline class="hidden w-full h-full object-cover"></video>
            <canvas id="overlay" class="absolute inset-0"></canvas>
            <div id="cameraPlaceholder" class="text-white text-center text-sm">
              <div class="text-5xl mb-2">üì∑</div>
              ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            </div>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 items-center mb-4">
          <div class="flex-1">
            <label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á:</label>
            <select id="cameraSelect" class="w-full border rounded px-3 py-2 text-sm">
              <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á...</option>
            </select>
          </div>

          <div class="flex gap-2">
            <button
              id="btnStartScan"
              class="px-4 py-2 rounded bg-blue-600 text-white font-semibold shadow hover:bg-blue-700">
              ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
            </button>
            <button
              id="btnStopScan"
              class="px-4 py-2 rounded bg-red-500 text-white font-semibold shadow hover:bg-red-600">
              ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô
            </button>
          </div>
        </div>

        <div id="scanStatus" class="text-sm text-gray-700 bg-sky-50 border border-sky-200 rounded px-3 py-2">
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô
        </div>
      </section>

      <!-- Dashboard -->
      <section class="bg-white rounded-xl shadow p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold mb-4">
          ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Dashboard)
        </h2>
        <div id="dashSummary" class="text-sm text-gray-700">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </div>
      </section>

    </div>
  </main>

  <!-- Admin modal: Login -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-40">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold mb-4 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h3>

      <div class="space-y-3 mb-4">
        <div>
          <label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
          <input id="adminUser" class="w-full border rounded px-3 py-2 text-sm" value="admin" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input id="adminPass" type="password" class="w-full border rounded px-3 py-2 text-sm" value="1234" />
        </div>
      </div>

      <div class="flex justify-end gap-2">
        <button
          class="px-3 py-2 text-sm rounded border"
          onclick="hideLoginModal()">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button
          class="px-3 py-2 text-sm rounded bg-slate-800 text-white font-semibold"
          onclick="handleAdminLogin()">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    </div>
  </div>

  <!-- Admin modal: Manage employees -->
  <div id="adminModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <h3 class="text-lg font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
        <button
          class="text-sm text-gray-500 hover:text-gray-700"
          onclick="hideAdminModal()">
          ‚úï ‡∏õ‡∏¥‡∏î
        </button>
      </div>

      <div class="flex-1 overflow-auto p-4 space-y-4">
        <div class="flex justify-between items-center mb-2">
          <div class="text-sm text-gray-600">
            ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="empCount">0</span> ‡∏Ñ‡∏ô
          </div>
          <button
            class="px-3 py-2 text-sm rounded bg-blue-600 text-white font-semibold"
            onclick="openEmployeeForm()">
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          </button>
        </div>

        <table class="w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="border px-2 py-1">‡∏£‡∏´‡∏±‡∏™</th>
              <th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
              <th class="border px-2 py-1">‡πÅ‡∏ú‡∏ô‡∏Å</th>
              <th class="border px-2 py-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
              <th class="border px-2 py-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
            </tr>
          </thead>
          <tbody id="empTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal: Add/Edit employee -->
  <div id="employeeModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-auto">
      <div class="flex items-center justify-between px-6 py-4 border-b">
        <h3 class="text-lg font-semibold" id="employeeModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
        <button
          class="text-sm text-gray-500 hover:text-gray-700"
          onclick="hideEmployeeModal()">
          ‚úï ‡∏õ‡∏¥‡∏î
        </button>
      </div>

      <div class="p-6 space-y-4">
        <input type="hidden" id="employeeId" />

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <input id="employeeCode" class="w-full border rounded px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
            <input id="employeeFullName" class="w-full border rounded px-3 py-2 text-sm" />
          </div>
          <div>
            <label class="block text-sm mb-1">‡πÅ‡∏ú‡∏ô‡∏Å</label>
            <select id="employeeBranch" class="w-full border rounded px-3 py-2 text-sm">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
            <select id="employeeLevel" class="w-full border rounded px-3 py-2 text-sm">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="employeeEmail" type="email" class="w-full border rounded px-3 py-2 text-sm" />
          </div>
        </div>

        <div class="mt-4 grid md:grid-cols-2 gap-4 items-start">
          <div>
            <label class="block text-sm mb-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏á)</label>
            <input id="employeePhoto" type="file" accept="image/*" class="w-full text-sm" />
            <p class="text-xs text-gray-500 mt-1">
              ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡∏Ñ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            </p>
          </div>
          <div class="flex justify-center">
            <div class="w-40 h-40 bg-gray-100 rounded overflow-hidden flex items-center justify-center">
              <img id="employeePhotoPreview" class="max-w-full max-h-full object-cover hidden" />
              <span id="employeePhotoPlaceholder" class="text-xs text-gray-400">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
              </span>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button
            class="px-3 py-2 text-sm rounded border"
            onclick="hideEmployeeModal()">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button
            id="btnSaveEmployee"
            class="px-4 py-2 text-sm rounded bg-emerald-600 text-white font-semibold">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Check time -->
  <div id="checkModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold mb-4 text-center">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h3>
      <div class="mb-3">
        <label class="block text-sm mb-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <input id="checkCode" class="w-full border rounded px-3 py-2 text-sm" />
      </div>
      <div class="flex justify-end gap-2 mb-3">
        <button class="px-3 py-2 text-sm rounded border" onclick="hideCheckModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="px-3 py-2 text-sm rounded bg-blue-600 text-white" onclick="handleCheckSummary()">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
      <div id="checkResult" class="text-sm text-gray-700"></div>
    </div>
  </div>

  <script>
    /***********************
     * GLOBAL STATE
     ***********************/
    const WEB_APP_URL = localStorage.getItem('webAppUrl') || '';

    let EMPLOYEES = [];
    let BRANCHES = [];
    let LEVELS = [];

    let videoStream = null;
    let isScanning = false;
    let faceMatcher = null;
    let faceModelsLoaded = false;
    const lastRecognized = {}; // code -> timestamp ms

    /***********************
     * UTIL
     ***********************/
    function promptSetWebAppUrl() {
      const current = localStorage.getItem('webAppUrl') || '';
      const url = prompt('‡πÉ‡∏™‡πà Google Web App URL (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec)', current);
      if (url) {
        localStorage.setItem('webAppUrl', url.trim());
        location.reload();
      }
    }

    async function callApi(action, payload = {}) {
      if (!WEB_APP_URL) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App URL');

      const body = new URLSearchParams({ action, ...payload });

      const res = await fetch(WEB_APP_URL, {
        method: 'POST',
        body
        // ‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á Content-Type ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á preflight
      });

      if (!res.ok) {
        throw new Error('HTTP ' + res.status);
      }

      const text = await res.text();
      let json;
      try {
        json = JSON.parse(text);
      } catch (e) {
        console.error('Response ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô JSON:', text);
        throw new Error('Response ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô JSON');
      }

      if (!json.ok) {
        throw new Error(json.error || 'API error');
      }

      return json.data;
    }

    function setScanStatus(msg) {
      document.getElementById('scanStatus').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + msg;
    }

    /***********************
     * LOAD MODELS & DATA
     ***********************/
    async function loadFaceModels() {
      await faceapi.nets.ssdMobilenetv1.loadFromUri('models');
      await faceapi.nets.faceLandmark68Net.loadFromUri('models');
      await faceapi.nets.faceRecognitionNet.loadFromUri('models');
      faceModelsLoaded = true;
      console.log('Face models loaded');
    }

    async function loadMasters() {
      const data = await callApi('GET_MASTERS');
      BRANCHES = data.branches || [];
      LEVELS   = data.levels || [];
      renderMasterSelects();
    }

    async function loadEmployees() {
      const data = await callApi('GET_EMPLOYEES');
      EMPLOYEES = data || [];
      renderEmployeeTable();
      await buildFaceMatcher();
    }

    function renderMasterSelects() {
      const branchSel = document.getElementById('employeeBranch');
      const levelSel  = document.getElementById('employeeLevel');
      if (!branchSel || !levelSel) return;

      branchSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å --</option>';
      BRANCHES.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id;
        opt.textContent = b.name;
        branchSel.appendChild(opt);
      });

      levelSel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö --</option>';
      LEVELS.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.name;
        levelSel.appendChild(opt);
      });
    }

    function renderEmployeeTable() {
      const tbody = document.getElementById('empTableBody');
      const countEl = document.getElementById('empCount');
      if (!tbody) return;

      tbody.innerHTML = '';
      EMPLOYEES.forEach(emp => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50 cursor-pointer';
        tr.onclick = () => openEmployeeForm(emp);

        tr.innerHTML = `
          <td class="border px-2 py-1">${emp.code}</td>
          <td class="border px-2 py-1">${emp.fullName}</td>
          <td class="border px-2 py-1">${displayMasterName(BRANCHES, emp.branch)}</td>
          <td class="border px-2 py-1">${displayMasterName(LEVELS, emp.level)}</td>
          <td class="border px-2 py-1">${emp.email || ''}</td>
        `;
        tbody.appendChild(tr);
      });

      if (countEl) countEl.textContent = EMPLOYEES.length;
    }

    function displayMasterName(list, id) {
      const item = list.find(x => String(x.id) === String(id));
      return item ? item.name : '';
    }

    async function buildFaceMatcher() {
      if (!faceModelsLoaded) return;

      const labeledDescriptors = [];

      for (const emp of EMPLOYEES) {
        if (!emp.photoUrl) continue;
        try {
          const img = await faceapi.fetchImage(emp.photoUrl);
          const det = await faceapi
            .detectSingleFace(img)
            .withFaceLandmarks()
            .withFaceDescriptor();

          if (!det) {
            console.warn('‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á', emp.fullName);
            continue;
          }

          const desc = new faceapi.LabeledFaceDescriptors(
            `${emp.code}|${emp.fullName}`,
            [det.descriptor]
          );
          labeledDescriptors.push(desc);
        } catch (err) {
          console.error('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', emp.fullName, err);
        }
      }

      if (labeledDescriptors.length === 0) {
        faceMatcher = null;
        console.warn('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö');
      } else {
        faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
        console.log('faceMatcher ready with', labeledDescriptors.length, 'employees');
      }
    }

    /***********************
     * CAMERA & SCAN
     ***********************/
    async function listCameras() {
      const select = document.getElementById('cameraSelect');
      select.innerHTML = '';

      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videos = devices.filter(d => d.kind === 'videoinput');

        if (videos.length === 0) {
          select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á</option>';
          return;
        }

        videos.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.textContent = d.label || `camera ${i + 1}`;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error(err);
        select.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á</option>';
      }
    }

    async function startScan() {
      if (!faceModelsLoaded) {
        alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏£‡∏π‡πâ‡∏à‡∏≥‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        return;
      }
      if (!faceMatcher) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ');
        return;
      }

      const select = document.getElementById('cameraSelect');
      const deviceId = select.value;
      if (!deviceId) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á');
        return;
      }

      const constraints = {
        video: { deviceId: { exact: deviceId } }
      };

      const video = document.getElementById('video');
      const overlay = document.getElementById('overlay');
      const placeholder = document.getElementById('cameraPlaceholder');

      try {
        if (videoStream) {
          videoStream.getTracks().forEach(t => t.stop());
        }

        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = videoStream;
        video.classList.remove('hidden');
        placeholder.classList.add('hidden');

        isScanning = true;
        setScanStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...');

        video.addEventListener('loadedmetadata', () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          scanLoop();
        }, { once: true });

      } catch (err) {
        console.error(err);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err.message);
      }
    }

    function stopScan() {
      isScanning = false;
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }

      const video = document.getElementById('video');
      const placeholder = document.getElementById('cameraPlaceholder');
      const overlay = document.getElementById('overlay');
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      video.classList.add('hidden');
      placeholder.classList.remove('hidden');

      setScanStatus('‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function scanLoop() {
      if (!isScanning) return;

      const video = document.getElementById('video');
      const overlay = document.getElementById('overlay');
      const ctx = overlay.getContext('2d');

      const detections = await faceapi
        .detectAllFaces(video)
        .withFaceLandmarks()
        .withFaceDescriptors();

      ctx.clearRect(0, 0, overlay.width, overlay.height);

      if (detections.length > 0 && faceMatcher) {
        const resized = faceapi.resizeResults(detections, {
          width: overlay.width,
          height: overlay.height
        });

        resized.forEach(async det => {
          const best = faceMatcher.findBestMatch(det.descriptor);

          const box = det.detection.box;
          ctx.strokeStyle = '#22c55e';
          ctx.lineWidth = 2;
          ctx.strokeRect(box.x, box.y, box.width, box.height);

          const label =
            best.label === 'unknown'
              ? '‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å'
              : `${best.label} (${best.distance.toFixed(2)})`;

          ctx.fillStyle = 'rgba(34,197,94,0.9)';
          ctx.font = '14px sans-serif';
          ctx.fillText(label, box.x, box.y - 4);

          if (best.label !== 'unknown') {
            const [code, fullName] = best.label.split('|');
            await handleRecognized(code, fullName);
          }
        });
      }

      setTimeout(scanLoop, 800);
    }

    async function handleRecognized(code, fullName) {
      const now = Date.now();
      const last = lastRecognized[code] || 0;
      if (now - last < 60 * 1000) {
        // ‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏ô 1 ‡∏ô‡∏≤‡∏ó‡∏µ
        return;
      }
      lastRecognized[code] = now;

      try {
        const data = await callApi('LOG_SCAN', { code });
        setScanStatus(`‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ ${data.fullName} ‡πÄ‡∏ß‡∏•‡∏≤ ${data.time} (${data.status})`);
      } catch (err) {
        console.error(err);
        setScanStatus('‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    }

    /***********************
     * ADMIN & EMPLOYEE FORM
     ***********************/
    function showLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('loginModal').classList.add('flex');
    }

    function hideLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginModal').classList.remove('flex');
    }

    function showAdminModal() {
      document.getElementById('adminModal').classList.remove('hidden');
      document.getElementById('adminModal').classList.add('flex');
    }

    function hideAdminModal() {
      document.getElementById('adminModal').classList.add('hidden');
      document.getElementById('adminModal').classList.remove('flex');
    }

    function handleAdminLogin() {
      const u = document.getElementById('adminUser').value.trim();
      const p = document.getElementById('adminPass').value.trim();

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      if (u === 'admin' && p === '1234') {
        hideLoginModal();
        showAdminModal();
      } else {
        alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    }

    function openEmployeeForm(emp) {
      document.getElementById('employeeModal').classList.remove('hidden');
      document.getElementById('employeeModal').classList.add('flex');

      const idInput = document.getElementById('employeeId');
      const codeInput = document.getElementById('employeeCode');
      const nameInput = document.getElementById('employeeFullName');
      const branchSel = document.getElementById('employeeBranch');
      const levelSel  = document.getElementById('employeeLevel');
      const emailInput= document.getElementById('employeeEmail');
      const photoPreview = document.getElementById('employeePhotoPreview');
      const photoPlaceholder = document.getElementById('employeePhotoPlaceholder');

      if (emp) {
        document.getElementById('employeeModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        idInput.value      = emp.id;
        codeInput.value    = emp.code;
        nameInput.value    = emp.fullName;
        branchSel.value    = emp.branch;
        levelSel.value     = emp.level;
        emailInput.value   = emp.email || '';

        if (emp.photoUrl) {
          photoPreview.src = emp.photoUrl;
          photoPreview.dataset.url = emp.photoUrl;
          photoPreview.classList.remove('hidden');
          photoPlaceholder.classList.add('hidden');
        } else {
          photoPreview.src = '';
          photoPreview.dataset.url = '';
          photoPreview.classList.add('hidden');
          photoPlaceholder.classList.remove('hidden');
        }

      } else {
        document.getElementById('employeeModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
        idInput.value      = '';
        codeInput.value    = '';
        nameInput.value    = '';
        branchSel.value    = '';
        levelSel.value     = '';
        emailInput.value   = '';
        photoPreview.src   = '';
        photoPreview.dataset.url = '';
        photoPreview.classList.add('hidden');
        photoPlaceholder.classList.remove('hidden');
      }
    }

    function hideEmployeeModal() {
      document.getElementById('employeeModal').classList.add('hidden');
      document.getElementById('employeeModal').classList.remove('flex');
    }

    function handlePhotoChange(ev) {
      const file = ev.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        const url = e.target.result; // data URL
        const img = document.getElementById('employeePhotoPreview');
        const ph  = document.getElementById('employeePhotoPlaceholder');
        img.src = url;
        img.dataset.url = url;
        img.classList.remove('hidden');
        ph.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }

    async function onSaveEmployee() {
      const idInput       = document.getElementById('employeeId');
      const codeInput     = document.getElementById('employeeCode');
      const nameInput     = document.getElementById('employeeFullName');
      const branchSel     = document.getElementById('employeeBranch');
      const levelSel      = document.getElementById('employeeLevel');
      const emailInput    = document.getElementById('employeeEmail');
      const photoPreview  = document.getElementById('employeePhotoPreview');

      const id       = idInput.value.trim();
      const code     = codeInput.value.trim();
      const fullName = nameInput.value.trim();
      const branch   = branchSel.value;
      const level    = levelSel.value;
      const email    = emailInput.value.trim();
      const photoUrl = photoPreview.dataset.url || '';

      if (!code || !fullName || !branch || !level) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠, ‡πÅ‡∏ú‡∏ô‡∏Å, ‡∏£‡∏∞‡∏î‡∏±‡∏ö)');
        return;
      }

      try {
        await callApi('SAVE_EMPLOYEE', {
          id,
          code,
          fullName,
          branch,
          level,
          email,
          photoUrl
        });

        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        hideEmployeeModal();
        await loadEmployees(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä list + face matcher ‡πÉ‡∏´‡∏°‡πà
      } catch (err) {
        console.error(err);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    }

    /***********************
     * CHECK SUMMARY
     ***********************/
    function showCheckModal() {
      document.getElementById('checkModal').classList.remove('hidden');
      document.getElementById('checkModal').classList.add('flex');
      document.getElementById('checkResult').textContent = '';
    }

    function hideCheckModal() {
      document.getElementById('checkModal').classList.add('hidden');
      document.getElementById('checkModal').classList.remove('flex');
    }

    async function handleCheckSummary() {
      const code = document.getElementById('checkCode').value.trim();
      if (!code) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        return;
      }

      try {
        const data = await callApi('GET_PERSON_SUMMARY', { code });
        const el = document.getElementById('checkResult');
        if (!data.fullName) {
          el.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ';
        } else {
          el.innerHTML = `
            <div>‡∏£‡∏´‡∏±‡∏™: <b>${data.code}</b></div>
            <div>‡∏ä‡∏∑‡πà‡∏≠: <b>${data.fullName}</b></div>
            <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤: <b>${data.count}</b></div>
            <div>‡∏°‡∏≤‡∏™‡∏≤‡∏¢: <b>${data.late}</b> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
          `;
        }
      } catch (err) {
        console.error(err);
        alert('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    }

    /***********************
     * INIT
     ***********************/
    window.addEventListener('load', async () => {
      document.getElementById('btnResetUrl').addEventListener('click', promptSetWebAppUrl);
      document.getElementById('btnAdmin').addEventListener('click', showLoginModal);
      document.getElementById('btnStartScan').addEventListener('click', startScan);
      document.getElementById('btnStopScan').addEventListener('click', stopScan);
      document.getElementById('employeePhoto').addEventListener('change', handlePhotoChange);
      document.getElementById('btnSaveEmployee').addEventListener('click', onSaveEmployee);
      document.getElementById('btnCheck').addEventListener('click', showCheckModal);

      if (!WEB_APP_URL) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Web App URL');
        promptSetWebAppUrl();
        return;
      }

      try {
        await loadFaceModels();
        await listCameras();
        await loadMasters();
        await loadEmployees();
        setScanStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô (‡∏Å‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)');
      } catch (err) {
        console.error(err);
        alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });
  </script>
</body>
</html>
