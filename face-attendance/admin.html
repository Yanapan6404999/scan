<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>HR Attendance Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <style>
    body { background:#f1f5f9; }
    .sidebar {
      min-height: 100vh;
      background:#111827;
      color:#e5e7eb;
    }
    .sidebar a {
      color:#e5e7eb;
      text-decoration:none;
      display:block;
      padding:.6rem 1rem;
      border-radius:.4rem;
      margin-bottom:.2rem;
    }
    .sidebar a.active,
    .sidebar a:hover {
      background:#1f2937;
    }
    .page-section { display:none; }
    .page-section.active { display:block; }
    .badge-pill {
      border-radius: 999px;
      padding:.25rem .7rem;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- SIDEBAR -->
    <div class="col-12 col-md-3 col-lg-2 sidebar py-3">
      <div class="px-3 mb-4">
        <h5 class="mb-0">Admin Panel</h5>
        <small class="text-muted">HR Attendance</small>
      </div>

      <nav class="px-2">
        <a href="#" class="nav-link-admin active" data-page="employees">
          จัดการพนักงาน
        </a>
        <a href="#" class="nav-link-admin" data-page="logs">
          ประวัติเวลา
        </a>
        <a href="#" class="nav-link-admin" data-page="settings">
          ตั้งค่า (แผนก/ระดับ)
        </a>
        <a href="#" class="nav-link-admin" data-page="summary">
          สรุปเวลาทำงาน
        </a>
      </nav>

      <div class="mt-4 px-3">
        <a href="index.html" class="btn btn-outline-light w-100 mb-2">กลับหน้าหลัก</a>
        <button class="btn btn-danger w-100" onclick="logoutAdmin()">
          ออกจากระบบ
        </button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="col-12 col-md-9 col-lg-10 py-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4 id="pageTitle">จัดการพนักงาน</h4>
          <small class="text-muted">จัดการข้อมูลพนักงานและแผนกต่าง ๆ</small>
        </div>
      </div>

      <!-- ALERT -->
      <div id="alertBox" style="display:none;"></div>

      <!-- PAGE: EMPLOYEES -->
      <section id="page-employees" class="page-section active">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>รายการพนักงาน</span>
            <div>
              <button class="btn btn-outline-secondary btn-sm me-2" onclick="reloadEmployees()">
                รีเฟรช
              </button>
              <button class="btn btn-primary btn-sm" onclick="openEmployeeModal()">
                + เพิ่มพนักงาน
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-2 mb-2">
              <div class="col-md-4">
                <input type="text" id="employeeSearch" class="form-control form-control-sm"
                       placeholder="ค้นหา (รหัส / ชื่อ)" oninput="renderEmployeesTable()">
              </div>
              <div class="col-md-4">
                <select id="employeeBranchFilter" class="form-select form-select-sm" onchange="renderEmployeesTable()">
                  <option value="ALL">ทุกแผนก</option>
                </select>
              </div>
              <div class="col-md-4">
                <select id="employeeLevelFilter" class="form-select form-select-sm" onchange="renderEmployeesTable()">
                  <option value="ALL">ทุกระดับ</option>
                </select>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th>#</th>
                  <th>รหัส</th>
                  <th>ชื่อ-สกุล</th>
                  <th>แผนก</th>
                  <th>ระดับ</th>
                  <th>อีเมล</th>
                  <th>สถานะ</th>
                  <th style="width:120px;">จัดการ</th>
                </tr>
                </thead>
                <tbody id="employeesTableBody">
                <tr><td colspan="8" class="text-center text-muted">กำลังโหลด...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: LOGS -->
      <section id="page-logs" class="page-section">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ประวัติการลงเวลา</span>
            <button class="btn btn-outline-secondary btn-sm" onclick="loadLogs()">
              รีเฟรช
            </button>
          </div>
          <div class="card-body">
            <div class="row g-2 mb-3">
              <div class="col-md-3">
                <input type="text" id="logsSearch" class="form-control form-control-sm"
                       placeholder="ค้นหา (รหัส / ชื่อ)">
              </div>
              <div class="col-md-3">
                <select id="logsBranchFilter" class="form-select form-select-sm"></select>
              </div>
              <div class="col-md-3">
                <select id="logsYear" class="form-select form-select-sm"></select>
              </div>
              <div class="col-md-3">
                <select id="logsMonth" class="form-select form-select-sm"></select>
              </div>
            </div>
            <button class="btn btn-primary btn-sm mb-3" onclick="loadLogs()">ค้นหา</button>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th>วันที่</th>
                  <th>รหัส</th>
                  <th>ชื่อ</th>
                  <th>แผนก</th>
                  <th>ระดับ</th>
                  <th>เข้า</th>
                  <th>ออก</th>
                  <th>สถานะ</th>
                  <th>หลักฐาน</th>
                </tr>
                </thead>
                <tbody id="logsTableBody">
                <tr><td colspan="9" class="text-center text-muted">ยังไม่มีข้อมูล</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: SETTINGS -->
      <section id="page-settings" class="page-section">
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">ตั้งค่าแผนก</div>
              <div class="card-body">
                <div class="input-group input-group-sm mb-2">
                  <input type="text" id="branchNewName" class="form-control" placeholder="ชื่อแผนกใหม่">
                  <button class="btn btn-primary" onclick="addBranch()">เพิ่ม</button>
                </div>
                <ul class="list-group list-group-sm" id="branchList">
                  <li class="list-group-item text-muted small">กำลังโหลด...</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">ตั้งค่าระดับ</div>
              <div class="card-body">
                <div class="input-group input-group-sm mb-2">
                  <input type="text" id="levelNewName" class="form-control" placeholder="ชื่อระดับใหม่">
                  <button class="btn btn-primary" onclick="addLevel()">เพิ่ม</button>
                </div>
                <ul class="list-group list-group-sm" id="levelList">
                  <li class="list-group-item text-muted small">กำลังโหลด...</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PAGE: SUMMARY -->
      <section id="page-summary" class="page-section">
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>สรุปเวลาทำงานรายบุคคล</span>
            <button class="btn btn-outline-secondary btn-sm" onclick="loadSummary()">รีเฟรช</button>
          </div>
          <div class="card-body">
            <div class="row g-2 mb-3">
              <div class="col-md-4">
                <select id="summaryBranch" class="form-select form-select-sm"></select>
              </div>
              <div class="col-md-4">
                <select id="summaryYear" class="form-select form-select-sm"></select>
              </div>
              <div class="col-md-4">
                <select id="summaryMonth" class="form-select form-select-sm"></select>
              </div>
            </div>
            <button class="btn btn-primary btn-sm mb-3" onclick="loadSummary()">ดูสรุป</button>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                <tr>
                  <th>รหัส</th>
                  <th>ชื่อ</th>
                  <th>แผนก</th>
                  <th>ระดับ</th>
                  <th>จำนวนวัน</th>
                  <th>สาย (ครั้ง)</th>
                  <th>ลา (ครั้ง)</th>
                  <th>ขาด (ครั้ง)</th>
                  <th>ชั่วโมงรวม</th>
                </tr>
                </thead>
                <tbody id="summaryTableBody">
                <tr><td colspan="9" class="text-center text-muted">ยังไม่มีข้อมูล</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

    </div>
  </div>
</div>

<!-- MODAL: EMPLOYEE -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="employeeModalTitle">เพิ่มพนักงาน</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="employeeForm">
          <input type="hidden" name="id" id="empId">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">รหัสพนักงาน</label>
              <input type="text" class="form-control" name="code" id="empCode" required>
            </div>
            <div class="col-md-8">
              <label class="form-label">ชื่อ-สกุล</label>
              <input type="text" class="form-control" name="fullName" id="empFullName" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">แผนก</label>
              <select class="form-select" name="branch" id="empBranch"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">ระดับ</label>
              <select class="form-select" name="level" id="empLevel"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">อีเมล</label>
              <input type="email" class="form-control" name="email" id="empEmail">
            </div>
            <div class="col-md-6">
              <label class="form-label">เบอร์โทร</label>
              <input type="text" class="form-control" name="phone" id="empPhone">
            </div>
            <div class="col-12 mt-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="empActive" checked>
                <label class="form-check-label" for="empActive">
                  ใช้งานอยู่ (Active)
                </label>
              </div>
            </div>
          </div>
        </form>
        <div id="employeeModalInfo" class="small text-muted mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <button class="btn btn-primary" id="btnSaveEmployee">บันทึก</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_URL = 'PUT_YOUR_WEB_APP_URL_HERE';

/************** GLOBAL STATE **************/
let branches = [];
let levels = [];
let employees = [];
let bsEmployeeModal = null;

/************** API HELPER **************/
async function callApi(action, data = {}) {
  const body = new URLSearchParams({ action, ...data });
  const res = await fetch(API_URL, { method: 'POST', body });
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'Unknown error');
  return json.result;
}

/************** ALERT **************/
function showAlert(message, type='success') {
  const box = document.getElementById('alertBox');
  box.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
  box.style.display = 'block';
}

/************** NAV PAGE SWITCH **************/
function showPage(page) {
  document.querySelectorAll('.page-section').forEach(sec => {
    sec.classList.remove('active');
  });
  const sec = document.getElementById('page-' + page);
  if (sec) sec.classList.add('active');

  document.querySelectorAll('.nav-link-admin').forEach(a => {
    a.classList.remove('active');
    if (a.dataset.page === page) a.classList.add('active');
  });

  const titleMap = {
    employees: 'จัดการพนักงาน',
    logs: 'ประวัติเวลา',
    settings: 'ตั้งค่า (แผนก/ระดับ)',
    summary: 'สรุปเวลาทำงาน'
  };
  document.getElementById('pageTitle').innerText = titleMap[page] || '';
}

/************** EMPLOYEES **************/
async function loadInitialData() {
  try {
    const r = await callApi('getInitialData');
    branches = r.branches || [];
    levels   = r.levels || [];
    employees = r.employees || [];

    // fill selects (filters)
    const branchSelects = [
      document.getElementById('employeeBranchFilter'),
      document.getElementById('logsBranchFilter'),
      document.getElementById('summaryBranch'),
      document.getElementById('empBranch')
    ].filter(Boolean);

    branchSelects.forEach(sel => {
      const keepAll = sel.id !== 'empBranch';
      sel.innerHTML = '';
      if (keepAll) {
        const optAll = document.createElement('option');
        optAll.value = 'ALL';
        optAll.textContent = 'ทุกแผนก';
        sel.appendChild(optAll);
      }
      branches.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.name;
        opt.textContent = b.name;
        sel.appendChild(opt);
      });
    });

    const levelSelects = [
      document.getElementById('employeeLevelFilter'),
      document.getElementById('summaryLevelFilter'), // เผื่อจะใช้ต่อ
      document.getElementById('empLevel')
    ].filter(Boolean);

    levelSelects.forEach(sel => {
      sel.innerHTML = '';
      if (sel.id !== 'empLevel') {
        const optAll = document.createElement('option');
        optAll.value = 'ALL';
        optAll.textContent = 'ทุกระดับ';
        sel.appendChild(optAll);
      }
      levels.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.name;
        opt.textContent = l.name;
        sel.appendChild(opt);
      });
    });

    renderEmployeesTable();
    fillYearMonthSelects();
    renderBranchesLevelsLists();
  } catch (err) {
    showAlert('โหลดข้อมูลเริ่มต้นไม่สำเร็จ: ' + err.message, 'danger');
  }
}

function renderEmployeesTable() {
  const tbody = document.getElementById('employeesTableBody');
  if (!employees.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">ยังไม่มีข้อมูลพนักงาน</td></tr>';
    return;
  }

  const search = (document.getElementById('employeeSearch').value || '').toLowerCase();
  const branchFilter = document.getElementById('employeeBranchFilter').value;
  const levelFilter  = document.getElementById('employeeLevelFilter').value;

  const filtered = employees.filter(emp => {
    let ok = true;
    if (search) {
      const key = (String(emp.code || '') + ' ' + String(emp.fullName || '')).toLowerCase();
      if (!key.includes(search)) ok = false;
    }
    if (branchFilter && branchFilter !== 'ALL' && emp.branch !== branchFilter) ok = false;
    if (levelFilter && levelFilter !== 'ALL' && emp.level !== levelFilter) ok = false;
    return ok;
  });

  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">ไม่พบข้อมูลตามเงื่อนไข</td></tr>';
    return;
  }

  let idx = 1;
  tbody.innerHTML = filtered.map(emp => `
    <tr>
      <td>${idx++}</td>
      <td>${emp.code || ''}</td>
      <td>${emp.fullName || ''}</td>
      <td>${emp.branch || '-'}</td>
      <td>${emp.level || '-'}</td>
      <td>${emp.email || '-'}</td>
      <td>
        ${emp.isActive === false
          ? '<span class="badge bg-secondary badge-pill">Inactive</span>'
          : '<span class="badge bg-success badge-pill">Active</span>'}
      </td>
      <td>
        <button class="btn btn-sm btn-outline-primary me-1" onclick="editEmployee('${emp.id}')">แก้ไข</button>
        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteEmployee('${emp.id}','${emp.code}')">ลบ</button>
      </td>
    </tr>
  `).join('');
}

async function reloadEmployees() {
  try {
    const r = await callApi('getEmployees');
    employees = r.employees || [];
    renderEmployeesTable();
    showAlert('รีเฟรชข้อมูลพนักงานแล้ว');
  } catch (err) {
    showAlert('โหลดข้อมูลพนักงานไม่สำเร็จ: ' + err.message, 'danger');
  }
}

function openEmployeeModal(emp = null) {
  document.getElementById('employeeForm').reset();
  document.getElementById('employeeModalInfo').innerHTML = '';
  document.getElementById('empId').value = emp ? emp.id || '' : '';
  document.getElementById('empCode').value = emp ? emp.code || '' : '';
  document.getElementById('empFullName').value = emp ? emp.fullName || '' : '';
  document.getElementById('empEmail').value = emp ? emp.email || '' : '';
  document.getElementById('empPhone').value = emp ? emp.phone || '' : '';
  document.getElementById('empActive').checked = emp ? (emp.isActive !== false) : true;

  const empBranchSel = document.getElementById('empBranch');
  const empLevelSel  = document.getElementById('empLevel');
  if (branches.length && empBranchSel) {
    empBranchSel.value = emp && emp.branch ? emp.branch : branches[0].name;
  }
  if (levels.length && empLevelSel) {
    empLevelSel.value = emp && emp.level ? emp.level : levels[0].name;
  }

  document.getElementById('employeeModalTitle').innerText = emp ? 'แก้ไขพนักงาน' : 'เพิ่มพนักงาน';

  if (!bsEmployeeModal) {
    bsEmployeeModal = new bootstrap.Modal(document.getElementById('employeeModal'));
  }
  bsEmployeeModal.show();
}

function editEmployee(id) {
  const emp = employees.find(e => String(e.id) === String(id));
  if (!emp) {
    showAlert('ไม่พบพนักงานที่ต้องการแก้ไข', 'danger');
    return;
  }
  openEmployeeModal(emp);
}

async function saveEmployee() {
  const form = document.getElementById('employeeForm');
  const id = document.getElementById('empId').value;
  const code = document.getElementById('empCode').value.trim();
  const fullName = document.getElementById('empFullName').value.trim();
  const branch = document.getElementById('empBranch').value;
  const level  = document.getElementById('empLevel').value;
  const email  = document.getElementById('empEmail').value.trim();
  const phone  = document.getElementById('empPhone').value.trim();
  const isActive = document.getElementById('empActive').checked;

  if (!code || !fullName) {
    alert('กรุณากรอกรหัสและชื่อพนักงาน');
    return;
  }

  try {
    const r = await callApi('saveEmployee', {
      id, code, fullName, branch, level, email, phone,
      isActive: isActive ? 'true' : 'false'
    });
    showAlert(r.mode === 'create' ? 'เพิ่มพนักงานสำเร็จ' : 'แก้ไขข้อมูลสำเร็จ');
    if (bsEmployeeModal) bsEmployeeModal.hide();
    await reloadEmployees();
  } catch (err) {
    showAlert('บันทึกไม่สำเร็จ: ' + err.message, 'danger');
  }
}

async function confirmDeleteEmployee(id, code) {
  if (!confirm('ต้องการลบพนักงานรหัส ' + code + ' จริงหรือไม่ ?')) return;
  try {
    await callApi('deleteEmployee', { id });
    showAlert('ลบพนักงานเรียบร้อยแล้ว');
    await reloadEmployees();
  } catch (err) {
    showAlert('ลบไม่สำเร็จ: ' + err.message, 'danger');
  }
}

/************** LOGS (HISTORY) **************/
function fillYearMonthSelects() {
  const now = new Date();
  const thisYear = now.getFullYear();

  const years = [];
  for (let y = thisYear - 2; y <= thisYear + 1; y++) years.push(y);

  const logsYear = document.getElementById('logsYear');
  const summaryYear = document.getElementById('summaryYear');

  [logsYear, summaryYear].forEach(sel => {
    if (!sel) return;
    sel.innerHTML = '';
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      if (y === thisYear) opt.selected = true;
      sel.appendChild(opt);
    });
  });

  const monthNames = ['ทุกเดือน','ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];

  const logsMonth = document.getElementById('logsMonth');
  const summaryMonth = document.getElementById('summaryMonth');

  [logsMonth, summaryMonth].forEach(sel => {
    if (!sel) return;
    sel.innerHTML = '';
    monthNames.forEach((name, idx) => {
      const opt = document.createElement('option');
      opt.value = idx;
      opt.textContent = name;
      if (idx === (now.getMonth() + 1)) opt.selected = true;
      sel.appendChild(opt);
    });
  });
}

async function loadLogs() {
  const tbody = document.getElementById('logsTableBody');
  tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">กำลังโหลด...</td></tr>';

  const search = document.getElementById('logsSearch').value.trim();
  const branch = document.getElementById('logsBranchFilter').value || 'ALL';
  const year   = document.getElementById('logsYear').value;
  const month  = document.getElementById('logsMonth').value;

  try {
    const r = await callApi('getLogsRange', { year, month, branch, search });
    const logs = r.logs || [];
    if (!logs.length) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ยังไม่มีข้อมูล</td></tr>';
      return;
    }

    tbody.innerHTML = logs.map(log => `
      <tr>
        <td>${log.date || ''}</td>
        <td>${log.code || ''}</td>
        <td>${log.fullName || ''}</td>
        <td>${log.branch || ''}</td>
        <td>${log.level || ''}</td>
        <td>${log.timeIn || ''}</td>
        <td>${log.timeOut || ''}</td>
        <td>${log.status || ''}</td>
        <td>
          ${log.evidenceUrl
            ? `<a href="${log.evidenceUrl}" target="_blank">ดูรูป</a>`
            : '-'}
        </td>
      </tr>
    `).join('');
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">โหลดไม่สำเร็จ: ${err.message}</td></tr>`;
  }
}

/************** SETTINGS (BRANCH & LEVEL) **************/
async function refreshBranchesLevels() {
  try {
    const r = await callApi('getBranchesLevels');
    branches = r.branches || [];
    levels   = r.levels || [];

    // อัปเดต dropdown ต่าง ๆ
    loadInitialData(); // reuse logic (safe)
  } catch (err) {
    showAlert('โหลดข้อมูลแผนก/ระดับไม่สำเร็จ: ' + err.message, 'danger');
  }
}

function renderBranchesLevelsLists() {
  const branchList = document.getElementById('branchList');
  const levelList  = document.getElementById('levelList');

  if (!branches.length) {
    branchList.innerHTML = '<li class="list-group-item text-muted small">ยังไม่มีแผนก</li>';
  } else {
    branchList.innerHTML = branches.map(b => `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>${b.name}</span>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteBranch('${b.name}')">ลบ</button>
      </li>
    `).join('');
  }

  if (!levels.length) {
    levelList.innerHTML = '<li class="list-group-item text-muted small">ยังไม่มีระดับ</li>';
  } else {
    levelList.innerHTML = levels.map(l => `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>${l.name}</span>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteLevel('${l.name}')">ลบ</button>
      </li>
    `).join('');
  }
}

async function addBranch() {
  const name = document.getElementById('branchNewName').value.trim();
  if (!name) {
    alert('กรุณากรอกชื่อแผนก');
    return;
  }
  try {
    await callApi('addBranch', { name });
    document.getElementById('branchNewName').value = '';
    showAlert('เพิ่มแผนกสำเร็จ');
    const r = await callApi('getBranchesLevels');
    branches = r.branches || [];
    levels   = r.levels || [];
    renderBranchesLevelsLists();
    loadInitialData();
  } catch (err) {
    showAlert('เพิ่มแผนกไม่สำเร็จ: ' + err.message, 'danger');
  }
}

async function deleteBranch(name) {
  if (!confirm('ต้องการลบแผนก "' + name + '" จริงหรือไม่ ?')) return;
  try {
    await callApi('deleteBranch', { name });
    showAlert('ลบแผนกสำเร็จ');
    const r = await callApi('getBranchesLevels');
    branches = r.branches || [];
    levels   = r.levels || [];
    renderBranchesLevelsLists();
    loadInitialData();
  } catch (err) {
    showAlert('ลบแผนกไม่สำเร็จ: ' + err.message, 'danger');
  }
}

async function addLevel() {
  const name = document.getElementById('levelNewName').value.trim();
  if (!name) {
    alert('กรุณากรอกชื่อระดับ');
    return;
  }
  try {
    await callApi('addLevel', { name });
    document.getElementById('levelNewName').value = '';
    showAlert('เพิ่มระดับสำเร็จ');
    const r = await callApi('getBranchesLevels');
    branches = r.branches || [];
    levels   = r.levels || [];
    renderBranchesLevelsLists();
    loadInitialData();
  } catch (err) {
    showAlert('เพิ่มระดับไม่สำเร็จ: ' + err.message, 'danger');
  }
}

async function deleteLevel(name) {
  if (!confirm('ต้องการลบระดับ "' + name + '" จริงหรือไม่ ?')) return;
  try {
    await callApi('deleteLevel', { name });
    showAlert('ลบระดับสำเร็จ');
    const r = await callApi('getBranchesLevels');
    branches = r.branches || [];
    levels   = r.levels || [];
    renderBranchesLevelsLists();
    loadInitialData();
  } catch (err) {
    showAlert('ลบระดับไม่สำเร็จ: ' + err.message, 'danger');
  }
}

/************** SUMMARY **************/
async function loadSummary() {
  const tbody = document.getElementById('summaryTableBody');
  tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">กำลังโหลด...</td></tr>';

  const branch = document.getElementById('summaryBranch').value || 'ALL';
  const year   = document.getElementById('summaryYear').value;
  const month  = document.getElementById('summaryMonth').value;

  try {
    const r = await callApi('getWorkSummary', { branch, year, month });
    const summary = r.summary || [];
    if (!summary.length) {
      tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ยังไม่มีข้อมูล</td></tr>';
      return;
    }

    tbody.innerHTML = summary.map(row => `
      <tr>
        <td>${row.code || ''}</td>
        <td>${row.fullName || ''}</td>
        <td>${row.branch || ''}</td>
        <td>${row.level || ''}</td>
        <td>${row.days || 0}</td>
        <td>${row.lateCount || 0}</td>
        <td>${row.leaveCount || 0}</td>
        <td>${row.absentCount || 0}</td>
        <td>${row.totalHours || ''}</td>
      </tr>
    `).join('');
  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">โหลดไม่สำเร็จ: ${err.message}</td></tr>`;
  }
}

/************** OTHER **************/
function logoutAdmin() {
  // ฝั่งนี้ยังไม่มีระบบล็อกอินจริง แค่เด้งกลับหน้า index
  window.location.href = 'index.html';
}

/************** EVENT BINDING **************/
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.nav-link-admin').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const page = a.dataset.page;
      showPage(page);
      if (page === 'logs') loadLogs();
      if (page === 'summary') loadSummary();
    });
  });

  document.getElementById('btnSaveEmployee').addEventListener('click', saveEmployee);

  loadInitialData();
});
</script>
</body>
</html>
