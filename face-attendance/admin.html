<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #fbbf24;
      --bg: #f3f4f6;
      --text-main: #0f172a;
      --text-soft: #6b7280;
      --border: #e5e7eb;
      --card-bg: #ffffff;
      --sidebar-bg: #020617;
      --sidebar-active: #020617;
    }

    * {
      box-sizing: border-box;
      font-family: "Prompt", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      color: var(--text-main);
      background:
        radial-gradient(circle at top left, #e0e7ff 0, transparent 55%),
        radial-gradient(circle at bottom right, #e5f5ff 0, transparent 50%),
        #f3f4f6;
    }

    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }

    button, .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease, opacity 0.1s ease;
      white-space: nowrap;
    }

    button:active, .btn:active { transform: translateY(1px) scale(0.99); box-shadow: none; }
    button:disabled, .btn:disabled { opacity: 0.6; cursor: default; transform: none; box-shadow: none; }

    .btn-primary { background: var(--primary); color: white; box-shadow: 0 10px 24px rgba(37, 99, 235, 0.35); }
    .btn-secondary { background: white; color: #111827; border: 1px solid var(--border); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-small { padding: 4px 10px; font-size: 12px; border-radius: 999px; }
    .btn-ghost { border-radius: 999px; background: transparent; border: 1px solid var(--border); color: var(--text-soft); }

    /* PAGE LAYOUT --------------------------------------------------- */
    .page {
      display: flex;
      min-height: 100vh;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: radial-gradient(circle at top, #111827, #020617);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px 14px;
      flex-shrink: 0;
      box-shadow:
        8px 0 30px rgba(15, 23, 42, 0.5),
        0 0 0 1px rgba(15,23,42,0.5);
      position: relative;
      z-index: 30;
    }

    .sidebar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at bottom, rgba(37,99,235,0.2), transparent 60%);
      pointer-events: none;
    }

    .sidebar-header {
      padding: 6px 6px 16px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .sidebar-title { font-weight: 600; font-size: 18px; margin-bottom: 2px; }
    .sidebar-sub { font-size: 11px; color: #9ca3af; }

    .nav {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-height: 0;
      position: relative;
      z-index: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 11px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      color: #e5e7eb;
      border: 1px solid transparent;
    }

    .nav-item span.icon { width: 22px; display: inline-flex; justify-content: center; }
    .nav-item.active {
      background: rgba(15,23,42,0.95);
      border-color: rgba(59,130,246,0.8);
      box-shadow: 0 8px 16px rgba(15,23,42,0.8);
    }
    .nav-item:hover { background: rgba(31,41,55,0.9); }

    .sidebar-footer {
      padding-top: 10px;
      border-top: 1px solid rgba(55,65,81,0.9);
      font-size: 11px;
      color: #9ca3af;
      position: relative;
      z-index: 1;
    }
    .sidebar-footer button { margin-top: 8px; width: 100%; }

    /* CONTENT AREA */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      max-width: 100%;
      overflow-x: hidden;
    }

    header.topbar {
      padding: 10px 18px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(15,23,42,0.5);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(14px);
      max-width: 100%;
      overflow-x: hidden;
    }

    .topbar-title { font-size: 18px; font-weight: 600; max-width: 100%; }
    .topbar-sub { font-size: 12px; color: #9ca3af; display: flex; flex-wrap: wrap; gap: 4px; max-width: 100%; }

    #apiUrlDisplay {
      word-break: break-all;
      overflow-wrap: anywhere;
      max-width: 100%;
      display: inline-block;
      cursor: pointer;
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      max-width: 100%;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      min-width: 0;
      max-width: 100%;
    }

    main.main { padding: 18px 18px 22px; max-width: 100%; overflow-x: hidden; }
    .main-inner { max-width: 1260px; margin: 0 auto; width: 100%; max-width: 100%; }

    /* MOBILE NAV ---------------------------------------------------- */
    .mobile-nav {
      display: none;
      background: #020617;
      padding: 7px 10px;
      border-bottom: 1px solid #1f2937;
      max-width: 100%;
      overflow-x: hidden;
    }

    .mobile-nav-inner {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }

    .mobile-nav-item {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.8);
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .mobile-nav-item.active {
      background: var(--primary);
      border-color: rgba(37,99,235,0.8);
      box-shadow: 0 8px 18px rgba(37,99,235,0.4);
    }

    /* CONNECTION BADGE ---------------------------------------------- */
    .badge-connection {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 118, 110, 0.15);
      color: #a5f3fc;
      border: 1px solid rgba(34,197,94,0.8);
      max-width: 100%;
    }

    .badge-connection.offline {
      background: rgba(127, 29, 29, 0.35);
      color: #fecaca;
      border-color: rgba(248,113,113,0.9);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.85);
    }

    .badge-connection.offline .dot {
      background: #f97373;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.8);
    }

    /* CARDS & TABLES ----------------------------------------------- */
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.08),
        0 0 0 1px rgba(226,232,240,0.9);
      border: 1px solid rgba(226,232,240,0.9);
      margin-bottom: 14px;
      backdrop-filter: blur(10px);
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 100%;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .card-subtitle { font-size: 12px; color: var(--text-soft); max-width: 100%; }

    .grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 12px; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; }

    .stat-card {
      padding: 10px 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .stat-label { font-size: 12px; color: var(--text-soft); }
    .stat-value { font-size: 20px; font-weight: 600; }
    .stat-extra { font-size: 11px; color: var(--text-soft); }
    .stat-accent { color: #16a34a; }
    .stat-danger { color: #b91c1c; }

    .badge-status { font-size: 11px; padding: 3px 9px; border-radius: 999px; display: inline-block; }
    .badge-normal { background: #dcfce7; color: #166534; }
    .badge-late { background: #fee2e2; color: #b91c1c; }
    .badge-absent { background: #ffe4e6; color: #be123c; }
    .badge-other { background: #fef3c7; color: #92400e; }

    .badge-pill { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #e5e7eb; color: #374151; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; max-width: 100%; }
    thead { background: #f3f4f6; }
    th, td { padding: 7px 8px; border-bottom: 1px solid #e5e7eb; text-align: left; white-space: nowrap; }
    th { font-weight: 500; color: #374151; font-size: 12px; }
    tbody tr:nth-child(even) { background: #f9fafb; }

    .text-right { text-align: right; }
    .text-center { text-align: center; }

    .scroll-x {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .table-wide {
      width: max-content;
      min-width: 720px;
    }

    .scroll-x::-webkit-scrollbar { height: 6px; }
    .scroll-x::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 999px; }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      max-width: 100%;
    }

    .filters .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      color: var(--text-soft);
      min-width: 0;
    }

    select,
    input[type="text"],
    input[type="number"] {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
      min-width: 120px;
      background: white;
      max-width: 100%;
    }

    input[type="text"]:focus,
    select:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    .input-block {
      width: 100%;
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 9px;
      font-size: 13px;
      outline: none;
      background: white;
    }

    .input-block:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    .helper { font-size: 11px; color: var(--text-soft); }

    .mt-8 { margin-top: 8px; }
    .mt-10 { margin-top: 10px; }
    .mt-12 { margin-top: 12px; }

    .tag { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: #e5e7eb; color: #374151; }
    .section { display: none; }
    .section.active { display: block; }

    .error-text { font-size: 12px; color: var(--danger); margin-top: 4px; }
    .success-text { font-size: 12px; color: #16a34a; margin-top: 4px; }
    .flex { display: flex; gap: 8px; align-items: center; min-width: 0; }

    .flex-stack-mobile {}
    @media (max-width: 640px) {
      .flex-stack-mobile { flex-direction: column; align-items: stretch; }
      .flex-stack-mobile .btn { width: 100%; justify-content: center; }
    }

    .table-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .pill-small { font-size: 10px; padding: 2px 6px; border-radius: 999px; background: #e5e7eb; color: #4b5563; }

    .header-search-box { min-width: 0; max-width: 280px; width: 100%; }
    @media (max-width: 640px) {
      .header-search-box { min-width: 100%; max-width: 100%; }
      #empSearch { width: 100%; }
      .table-actions .btn { flex: 1; }
    }

    /* ‚úÖ Mobile Segmented Control */
    .mobile-segment {
      display: none;
      gap: 8px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 16px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(226,232,240,0.9);
      box-shadow: 0 12px 28px rgba(15,23,42,0.06);
      backdrop-filter: blur(10px);
      max-width: 100%;
    }
    .seg-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: #111827;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform .08s ease, box-shadow .08s ease, background .1s ease;
      max-width: 100%;
    }
    .seg-btn.active {
      background: var(--primary);
      color: white;
      border-color: rgba(37,99,235,0.7);
      box-shadow: 0 10px 18px rgba(37,99,235,0.25);
    }
    .emp-hidden { display: none !important; }

    .emp-table-scroll {
      max-height: 420px;
      overflow-y: auto;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }
    .emp-table-scroll table { min-width: 560px; }

    .emp-desktop-only { display: block; }
    .emp-mobile-only { display: none; }

    /* ‚úÖ Mobile List (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ) */
    .emp-mobile-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 6px 2px 2px;
    }
    .emp-item {
      border: 1px solid rgba(226,232,240,0.95);
      border-radius: 16px;
      padding: 12px 12px 10px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(15,23,42,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .emp-item-top {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: flex-start;
    }
    .emp-name { font-weight: 600; font-size: 14px; line-height: 1.25; }
    .emp-meta {
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .emp-code-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.12);
      color: var(--primary);
      border: 1px solid rgba(37,99,235,0.25);
      white-space: nowrap;
      height: fit-content;
    }

    .emp-face-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(16,185,129,0.25);
      background: rgba(16,185,129,0.10);
      color: #047857;
      white-space: nowrap;
    }
    .emp-face-badge.off {
      border-color: rgba(239,68,68,0.25);
      background: rgba(239,68,68,0.10);
      color: #b91c1c;
    }

    .emp-item-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .emp-item-actions .btn {
      width: 100%;
      justify-content: center;
      padding: 10px 12px;
      font-size: 13px;
    }
    .btn-span-2 { grid-column: 1 / -1; }

    /* RESPONSIVE ---------------------------------------------------- */
    @media (max-width: 1000px) {
      .sidebar { display: none; }
      .page { flex-direction: column; }
      main.main { padding: 14px 12px 18px; }
      .mobile-nav { display: block; position: sticky; top: 48px; z-index: 15; }
    }

    @media (max-width: 800px) {
      .grid-3 { grid-template-columns: 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
      #section-employees .mobile-segment { display: flex; }

      .emp-desktop-only { display: none; }
      .emp-mobile-only { display: block; }
    }

    @media (max-width: 640px) {
      header.topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .topbar-right {
        width: 100%;
        justify-content: space-between;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 8px;
        align-items: center;
      }
      #connectionBadge { justify-self: start; }
      #btnSetUrl { justify-self: end; }
      .filters .field { min-width: 46%; }
    }

    /* URL Card ‡∏•‡∏≠‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ---------------------------------------- */
    #urlCard {
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 420px;
      width: calc(100% - 32px);
      z-index: 40;
    }
    @media (max-width: 640px) {
      #urlCard { left: 12px; right: 12px; bottom: 12px; width: auto; }
    }

    /* MODALS -------------------------------------------------------- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      z-index: 60;
      backdrop-filter: blur(6px);
    }
    .modal {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(226,232,240,0.9);
      box-shadow: 0 30px 80px rgba(15,23,42,0.35);
      overflow: hidden;
    }
    .modal-header {
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      background: #f8fafc;
    }
    .modal-title { font-weight: 600; font-size: 14px; }
    .modal-sub { font-size: 12px; color: var(--text-soft); margin-top: 2px; }
    .modal-body { padding: 12px 14px 14px; }
    .modal-footer {
      padding: 12px 14px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
      background: #fafafa;
    }

    .preview-box {
      border: 1px dashed #e5e7eb;
      border-radius: 14px;
      padding: 10px;
      background: #f9fafb;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .preview-box img {
      width: 110px;
      height: 110px;
      border-radius: 12px;
      object-fit: cover;
      border: 1px solid rgba(226,232,240,0.9);
      background: #fff;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
  </style>
</head>

<body>
<div class="page">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <div class="sidebar-sub">HR Attendance Panel</div>
    </div>

    <nav class="nav">
      <div class="nav-item active" data-section="dashboard">
        <span class="icon">üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span>
      </div>
      <div class="nav-item" data-section="employees">
        <span class="icon">üë•</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
      </div>
      <div class="nav-item" data-section="logs">
        <span class="icon">‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</span>
      </div>
      <div class="nav-item" data-section="summary">
        <span class="icon">üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
      </div>
      <div class="nav-item" data-section="settings">
        <span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏±‡πâ‡∏ô)</span>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div>TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
      <button class="btn btn-ghost" id="btnBackToFront">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn btn-danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="content">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="topbar-sub">
          <span>Admin Panel |</span>
          <span id="apiUrlDisplay" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL"></span>
        </div>
      </div>
      <div class="topbar-right">
        <div id="connectionBadge" class="badge-connection offline">
          <span class="dot"></span>
          <span id="connectionText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        <button class="btn btn-secondary" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
      </div>
    </header>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
      <div class="mobile-nav-inner">
        <button class="mobile-nav-item active" data-section="dashboard">
          <span>üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
        </button>
        <button class="mobile-nav-item" data-section="employees">
          <span>üë•</span><span>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        </button>
        <button class="mobile-nav-item" data-section="logs">
          <span>‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        </button>
        <button class="mobile-nav-item" data-section="summary">
          <span>üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ</span>
        </button>
        <button class="mobile-nav-item" data-section="settings">
          <span>‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </button>
      </div>
    </nav>

    <main class="main">
      <div class="main-inner">

        <!-- DASHBOARD ---------------------------------------------->
        <section class="section active" id="section-dashboard">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">üìä</span>
                  ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </div>
                <div class="card-subtitle">
                  ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á HR
                </div>
              </div>
            </div>

            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="stat-value" id="statTotalEmployees">‚Äì</div>
                <div class="stat-extra">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Employees</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value stat-accent" id="statTodayCount">‚Äì</div>
                <div class="stat-extra">
                  ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span class="stat-danger" id="statTodayLate">‡∏™‡∏≤‡∏¢ 0 ‡∏Ñ‡∏ô</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏™‡∏≤‡∏¢ / ‡∏Ç‡∏≤‡∏î)</div>
                <div class="stat-value" id="statMonthOverview">‚Äì</div>
                <div class="stat-extra">‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getSummaryRange</div>
              </div>
            </div>

            <div class="mt-12">
              <div class="card-subtitle">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="scroll-x mt-8">
                <table class="table-wide">
                  <thead>
                  <tr>
                    <th>‡∏£‡∏´‡∏±‡∏™</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</th>
                    <th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th>
                    <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th>
                    <th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  </tr>
                  </thead>
                  <tbody id="dashboardTodayBody">
                  <tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-8">
                <div class="card-subtitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
                <div id="dashboardLocationSummary" class="mt-8" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- EMPLOYEES ---------------------------------------------->
        <section class="section" id="section-employees">

          <div class="mobile-segment" id="empSegment">
            <button class="seg-btn active" id="btnEmpTabForm" type="button">üë§ ‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            <button class="seg-btn" id="btnEmpTabList" type="button">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
          </div>

          <div class="grid-2">
            <div class="card" id="empFormCard">
              <div class="card-header">
                <div>
                  <div class="card-title">
                    <span class="icon">üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                  </div>
                  <div class="card-subtitle">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‚Äì‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Employees ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                  </div>
                </div>
              </div>

              <div class="card-subtitle" id="empFormTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>

              <div class="mt-8">
                <div class="mt-8">
                  <div class="helper">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                  <input id="empCode" class="input-block" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" />
                </div>
                <div class="mt-8">
                  <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
                  <input id="empFullName" class="input-block" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
                </div>
                <div class="mt-8">
                  <div class="helper">‡πÅ‡∏ú‡∏ô‡∏Å</div>
                  <select id="empBranch" class="input-block"></select>
                </div>
                <div class="mt-8">
                  <div class="helper">‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <select id="empLevel" class="input-block"></select>
                </div>
                <div class="mt-8">
                  <div class="helper">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
                  <input id="empEmail" class="input-block" placeholder="optional" />
                </div>

                <div class="mt-8">
                  <div class="helper">‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ä‡πà‡∏ß‡∏¢ HR / ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
                  <input type="file" id="empPhoto" accept="image/*" class="input-block" />
                  <img id="empPhotoPreview" style="width:100px;margin-top:8px;border-radius:8px;display:none;" />
                </div>

                <div class="mt-10 flex">
                  <button class="btn btn-primary" id="btnSaveEmployee">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                  <button class="btn btn-secondary" id="btnResetEmpForm">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                </div>
                <div id="empFormError" class="error-text" style="display:none;"></div>
                <div id="empFormSuccess" class="success-text" style="display:none;"></div>

                <div class="mt-12">
                  <div class="helper">
                    ‚úÖ ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°: ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏õ‡∏∏‡πà‡∏° üì∏)
                  </div>
                </div>
              </div>
            </div>

            <div class="card" id="empListCard">
              <div class="card-header">
                <div>
                  <div class="card-title">
                    <span class="icon">üìã</span> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                  </div>
                  <div class="card-subtitle">
                    PC = ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° | Mobile = ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ö‡∏ö‡πÅ‡∏≠‡∏õ ‚úÖ + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù
                  </div>
                </div>
                <div class="header-search-box">
                  <input type="text" id="empSearch" class="input-block" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠" />
                </div>
              </div>

              <!-- ‚úÖ PC TABLE -->
              <div class="emp-desktop-only">
                <div class="emp-table-scroll">
                  <table>
                    <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                      <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                      <th>‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                    </thead>
                    <tbody id="empTableBody">
                    <tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- ‚úÖ MOBILE LIST -->
              <div class="emp-mobile-only">
                <div id="empMobileList" class="emp-mobile-list">
                  <div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- LOGS --------------------------------------------------->
        <section class="section" id="section-logs">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">‚è±</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤
                </div>
                <div class="card-subtitle">
                  ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ
                </div>
              </div>
            </div>

            <div class="filters mt-8">
              <div class="field" style="flex:1; min-width:160px;">
                <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™</span>
                <input type="text" id="logSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011, ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
              </div>
              <div class="field">
                <span>‡∏™‡∏≤‡∏Ç‡∏≤</span>
                <select id="logBranchFilter"></select>
              </div>
              <div class="field">
                <span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                <select id="logMonthFilter"></select>
              </div>
              <div class="field">
                <span>‡∏õ‡∏µ (‡∏û.‡∏®.)</span>
                <select id="logYearFilter"></select>
              </div>
              <div class="field">
                <span>&nbsp;</span>
                <button class="btn btn-primary btn-small" id="btnReloadLogs">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
              </div>
            </div>

            <div class="scroll-x mt-10" style="max-height:480px; overflow-y:auto;">
              <table class="table-wide">
                <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏£‡∏´‡∏±‡∏™</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th>‡πÄ‡∏Ç‡πâ‡∏≤</th>
                  <th>‡∏≠‡∏≠‡∏Å</th>
                  <th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
                  <th>‡∏î‡∏π</th>
                </tr>
                </thead>
                <tbody id="logsTableBody">
                <tr><td colspan="10" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>
            <div class="helper mt-8">
              * ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å t1 ‡∏ñ‡∏∂‡∏á t4 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö) | ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏î‡∏π‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß ‚úÖ
            </div>
          </div>
        </section>

        <!-- SUMMARY ----------------------------------------------->
        <section class="section" id="section-summary">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">üìà</span> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
                </div>
                <div class="card-subtitle">
                  ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ç‡∏≤‡∏î‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô ‡∏Ø‡∏•‡∏Ø
                </div>
              </div>
            </div>

            <div class="filters mt-8">
              <div class="field">
                <span>‡∏™‡∏≤‡∏Ç‡∏≤</span>
                <select id="sumBranchFilter"></select>
              </div>
              <div class="field">
                <span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
                <select id="sumMonthFilter"></select>
              </div>
              <div class="field">
                <span>‡∏õ‡∏µ (‡∏û.‡∏®.)</span>
                <select id="sumYearFilter"></select>
              </div>
              <div class="field">
                <span>&nbsp;</span>
                <button class="btn btn-primary btn-small" id="btnReloadSummary">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
              </div>
            </div>

            <div class="scroll-x mt-10" style="max-height:480px; overflow-y:auto;">
              <table class="table-wide">
                <thead>
                <tr>
                  <th>‡∏£‡∏´‡∏±‡∏™</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                  <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
                  <th>‡∏õ‡∏Å‡∏ï‡∏¥</th>
                  <th>‡∏™‡∏≤‡∏¢</th>
                  <th>‡∏Ç‡∏≤‡∏î</th>
                </tr>
                </thead>
                <tbody id="summaryTableBody">
                <tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- SETTINGS ---------------------------------------------->
        <section class="section" id="section-settings">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏ä‡∏±‡πâ‡∏ô
                </div>
                <div class="card-subtitle">
                  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πà‡∏≤‡∏á ‡πÜ
                </div>
              </div>
            </div>

            <div class="card-subtitle">‡πÅ‡∏ú‡∏ô‡∏Å</div>
            <div class="mt-8 flex flex-stack-mobile">
              <input id="branchName" class="input-block" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏´‡∏°‡πà" />
              <button class="btn btn-primary btn-small" id="btnAddBranch">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>

            <div class="scroll-x mt-8" style="max-height:320px; overflow-y:auto;">
              <table>
                <thead>
                  <tr><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                </thead>
                <tbody id="branchTableBody">
                  <tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">üìå</span> ‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                </div>
                <div class="card-subtitle">
                  ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Ø‡∏•‡∏Ø
                </div>
              </div>
            </div>

            <div class="card-subtitle">‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
            <div class="mt-8 flex flex-stack-mobile">
              <input id="levelName" class="input-block" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà" />
              <button class="btn btn-primary btn-small" id="btnAddLevel">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>

            <div class="scroll-x mt-8" style="max-height:320px; overflow-y:auto;">
              <table>
                <thead>
                  <tr><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                </thead>
                <tbody id="levelTableBody">
                  <tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>
                </tbody>
              </table>
            </div>

            <div id="settingsError" class="error-text" style="display:none;"></div>
            <div id="settingsSuccess" class="success-text" style="display:none;"></div>
          </div>
        </section>

        <!-- URL CARD ---------------------------------------------->
        <div class="card" id="urlCard" style="display:none;">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üîó</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API
            </div>
          </div>
          <div>
            <div class="helper">URL ‡∏à‡∏≤‡∏Å Apps Script Web App (‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <code>/exec</code>)</div>
            <input id="inputApiUrl" class="input-block mt-8" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/XXXXX/exec" />
            <div class="mt-8 flex flex-stack-mobile">
              <button class="btn btn-primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button class="btn btn-secondary" id="btnCancelUrl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            <div id="urlError" class="error-text" style="display:none;"></div>
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<!-- MODAL: FACE ENROLL -------------------------------------------->
<div class="modal-backdrop" id="faceModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faceModalTitle">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="faceModalTitle">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
        <div class="modal-sub" id="faceModalSub">‚Äì</div>
      </div>
      <button class="btn btn-ghost btn-small" id="btnCloseFaceModal" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="helper">
        ‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î ‡πÜ 1 ‡∏£‡∏π‡∏õ (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù
      </div>

      <div class="mt-10">
        <div class="helper">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤)</div>
        <input type="file" id="facePhotoInput" accept="image/*" capture="user" class="input-block" />
      </div>

      <div class="mt-10 preview-box">
        <img id="facePreviewImg" alt="preview" />
        <div style="min-width:0;flex:1;">
          <div class="helper">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="mono" id="faceStatusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</div>
          <div class="helper mt-8">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <div class="mono" id="faceHintText">
            - ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ UNKNOWN ‡πÉ‡∏ô Logs ‚Äú‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‚Äù (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà error)<br/>
            - ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢ ‚Äú‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          </div>
        </div>
      </div>

      <div id="faceError" class="error-text" style="display:none;"></div>
      <div id="faceSuccess" class="success-text" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnFaceClear" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ</button>
      <button class="btn btn-primary" id="btnFaceUpload" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    </div>
  </div>
</div>

<!-- MODAL: LOG DETAIL -------------------------------------------->
<div class="modal-backdrop" id="logModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logModalTitle">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="logModalTitle">üßæ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="modal-sub" id="logModalSub">‚Äì</div>
      </div>
      <button class="btn btn-ghost btn-small" id="btnCloseLogModal" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="helper">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß Logs (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>

      <div class="mt-10 preview-box">
        <img id="logEvidenceImg" alt="evidence" style="display:none;" />
        <div style="min-width:0;flex:1;">
          <div class="helper">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
          <div class="mono" id="logKeyText">‚Äì</div>
          <div class="helper mt-8">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö</div>
          <div class="mono" id="logRawText" style="white-space:pre-wrap;">‚Äì</div>
        </div>
      </div>

      <div id="logModalHint" class="helper mt-10"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnOpenEvidence" type="button" disabled>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>
      <button class="btn btn-primary" id="btnCopyLogJson" type="button">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'attendance_api_url_v2';

  // ====== HARD-CODED (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏∂‡πà‡∏á Sheet ‡πÄ‡∏û‡∏¥‡πà‡∏°) ===========
  // ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏°‡πÉ‡∏à
  const HARD = {
    FACE_MAX_BYTES: 900 * 1024, // 900KB (‡∏Å‡∏±‡∏ô Apps Script ‡∏ä‡∏≠‡∏ö‡∏û‡∏±‡∏á)
    FACE_IMAGE_QUALITY: 0.86,
    FACE_IMAGE_MAX_EDGE: 960,   // ‡∏¢‡πà‡∏≠‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
  };

  function getApiUrl() {
    return localStorage.getItem(STORAGE_KEY) || '';
  }

  function setApiUrl(url) {
    if (!url) localStorage.removeItem(STORAGE_KEY);
    else localStorage.setItem(STORAGE_KEY, url);
  }

  const api = {
    async call(action, params = {}) {
      const apiUrl = getApiUrl();
      if (!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');

      const body = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error('API response is not JSON:', text);
        throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)');
      }
      if (!data.ok) throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      return data.result;
    }
  };

  let employees = [];
  let branches = [];
  let levels = [];
  let editingEmpId = null;

  // ‚úÖ ‡∏à‡∏≥‡πÅ‡∏ó‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ employees (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
  let empTabState = 'form';

  // ‚úÖ modal states
  let faceTargetEmp = null;  // {id, code, fullName}
  let faceBase64 = '';
  let lastLogsRows = [];     // cache latest logs
  let logModalRow = null;    // selected row

  function $(id) { return document.getElementById(id); }

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = err => reject(err);
      reader.readAsDataURL(file);
    });
  }

  // ‚úÖ ‡∏Å‡∏±‡∏ô XSS/‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô HTML
  function escHtml(s) {
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function setConnectionStatus(online, msg) {
    const bdg = $('connectionBadge');
    const txt = $('connectionText');
    if (!bdg || !txt) return;
    if (online) {
      bdg.classList.remove('offline');
      txt.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    } else {
      bdg.classList.add('offline');
      txt.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
    }
  }

  function statusBadgeHtml(status) {
    if (!status) return '<span class="badge-status badge-absent">‡∏Ç‡∏≤‡∏î</span>';
    let cls = 'badge-other';
    if (status === '‡∏õ‡∏Å‡∏ï‡∏¥') cls = 'badge-normal';
    else if (String(status).includes('‡∏™‡∏≤‡∏¢')) cls = 'badge-late';
    else if (status === '‡∏Ç‡∏≤‡∏î') cls = 'badge-absent';
    return '<span class="badge-status ' + cls + '">' + escHtml(status) + '</span>';
  }

  function timeToMinutes(t) {
    if (!t) return null;
    const parts = String(t).split(':');
    if (parts.length < 2) return null;
    const h = Number(parts[0]), m = Number(parts[1]);
    if (isNaN(h) || isNaN(m)) return null;
    return h * 60 + m;
  }

  function calcTotalHours(t1, t4) {
    const m1 = timeToMinutes(t1);
    const m4 = timeToMinutes(t4);
    if (m1 == null || m4 == null || m4 <= m1) return '-';
    const diff = m4 - m1;
    const hours = Math.floor(diff / 60);
    const mins  = diff % 60;
    return `${hours} ‡∏ä‡∏°. ${mins.toString().padStart(2,'0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }

  function formatDateThai(dateStr) {
    let d;
    if (dateStr instanceof Date) d = dateStr;
    else {
      const parts = String(dateStr).split('-');
      if (parts.length === 3) d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
      else return String(dateStr || '');
    }
    const dd = d.getDate().toString().padStart(2,'0');
    const mm = (d.getMonth()+1).toString().padStart(2,'0');
    const yy = d.getFullYear() + 543;
    return `${dd}/${mm}/${yy}`;
  }

  function fillYearMonthSelect(yearSel, monthSel) {
    const now = new Date();
    const curYear = now.getFullYear();
    const years = [curYear-1, curYear, curYear+1];

    yearSel.innerHTML = years.map(y => {
      const be = y + 543;
      const sel = (y === curYear) ? 'selected' : '';
      return `<option value="${y}" ${sel}>${be}</option>`;
    }).join('');

    const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    monthSel.innerHTML = monthNames.map((m,i) => {
      const sel = (i === now.getMonth()) ? 'selected' : '';
      return `<option value="${i+1}" ${sel}>${m}</option>`;
    }).join('');
  }

  function isRealTime(v) {
    if (v == null) return false;
    const s = String(v).trim();
    if (!s) return false;
    if (s === '-' || s === '‚Äì') return false;
    return true;
  }

  function hasAnyLogRow(r) {
    return isRealTime(r.t1) || isRealTime(r.t2) || isRealTime(r.t3) || isRealTime(r.t4);
  }

  function renderDashboard(todaySummary, monthSummary) {
    $('statTotalEmployees').textContent = employees.length.toString();

    const todayRows = todaySummary || [];
    const loggedRows = todayRows.filter(hasAnyLogRow);
    $('statTodayCount').textContent = loggedRows.length.toString();

    let lateCount = 0;
    loggedRows.forEach(r => {
      const st = String(r.status || '');
      if (st.includes('‡∏™‡∏≤‡∏¢')) lateCount++;
    });
    $('statTodayLate').textContent = `‡∏™‡∏≤‡∏¢ ${lateCount} ‡∏Ñ‡∏ô`;

    const rows = (monthSummary && monthSummary.rows) || [];
    let normal = 0, late = 0, absent = 0;
    rows.forEach(r => {
      normal += Number(r.normalCount || 0);
      late   += Number(r.lateCount || 0);
      absent += Number(r.absentCount || 0);
    });
    $('statMonthOverview').textContent = `${normal} ‡∏õ‡∏Å‡∏ï‡∏¥ / ${late} ‡∏™‡∏≤‡∏¢ / ${absent} ‡∏Ç‡∏≤‡∏î`;

    const tbody = $('dashboardTodayBody');
    if (!todayRows.length) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
    } else {
      tbody.innerHTML = todayRows.map(r => `
        <tr>
          <td>${escHtml(r.code || '')}</td>
          <td>${escHtml(r.fullName || '')}</td>
          <td>${escHtml((isRealTime(r.t1) ? r.t1 : '-') || '-')}</td>
          <td>${escHtml((isRealTime(r.t2) ? r.t2 : '-') || '-')}</td>
          <td>${escHtml((isRealTime(r.t3) ? r.t3 : '-') || '-')}</td>
          <td>${escHtml((isRealTime(r.t4) ? r.t4 : '-') || '-')}</td>
          <td>${escHtml(r.locationText || r.location || '-')}</td>
          <td>${statusBadgeHtml(r.status || '')}</td>
        </tr>
      `).join('');
    }

    const locBox = $('dashboardLocationSummary');
    if (locBox) {
      const locMap = {};
      loggedRows.forEach(r => {
        const loc = r.locationText || r.location || '';
        if (!loc) return;
        locMap[loc] = (locMap[loc] || 0) + 1;
      });
      const entries = Object.entries(locMap);
      if (!entries.length) {
        locBox.innerHTML = '<span class="helper">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
      } else {
        locBox.innerHTML = entries.map(([name,count]) =>
          `<span class="tag">${escHtml(name)} ‚Äì ${escHtml(count)} ‡∏Ñ‡∏ô</span>`
        ).join(' ');
      }
    }
  }

  function renderBranchLevelSelects() {
    const branchSel = $('empBranch');
    const levelSel  = $('empLevel');
    branchSel.innerHTML = branches.length
      ? branches.map(b => `<option value="${escHtml(b.name)}">${escHtml(b.name)}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å -</option>';
    levelSel.innerHTML = levels.length
      ? levels.map(l => `<option value="${escHtml(l.name)}">${escHtml(l.name)}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö -</option>';

    const branchFilter = $('logBranchFilter');
    const branchFilter2 = $('sumBranchFilter');
    const opts = ['<option value="ALL">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>']
      .concat(branches.map(b => `<option value="${escHtml(b.name)}">${escHtml(b.name)}</option>`));
    branchFilter.innerHTML = opts.join('');
    branchFilter2.innerHTML = opts.join('');
  }

  function hasFace(e) {
    const fd = e && e.faceData;
    if (!fd) return false;
    const s = String(fd).trim();
    if (!s) return false;
    if (s === '-' || s === '‚Äì') return false;
    return true;
  }

  // ‚úÖ ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Äú‡∏ó‡∏±‡πâ‡∏á PC table‚Äù ‡πÅ‡∏•‡∏∞ ‚ÄúMobile card list‚Äù
  function renderEmployeesTable() {
    const tb = $('empTableBody');
    const mobileList = $('empMobileList');
    const q = $('empSearch').value.trim().toLowerCase();

    let list = employees;
    if (q) {
      list = list.filter(e => {
        const text = (String(e.code) + ' ' + String(e.fullName)).toLowerCase();
        return text.includes(q);
      });
    }

    // PC table
    if (!list.length) {
      if (tb) tb.innerHTML = '<tr><td colspan="6" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    } else {
      if (tb) tb.innerHTML = list.map(e => {
        const faceOk = hasFace(e);
        const faceBadge = faceOk
          ? `<span class="emp-face-badge">‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`
          : `<span class="emp-face-badge off">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`;
        return `
          <tr>
            <td>${escHtml(e.code || '')}</td>
            <td>${escHtml(e.fullName || '')}</td>
            <td>${escHtml(e.branch || '')}</td>
            <td>${escHtml(e.level || '')}</td>
            <td>${faceBadge}</td>
            <td>
              <div class="table-actions">
                <button class="btn btn-primary btn-small" onclick="openFaceEnroll('${escHtml(e.id || '')}')">üì∏ ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
                <button class="btn btn-secondary btn-small" onclick="editEmployee('${escHtml(e.id || '')}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-danger btn-small" onclick="deleteEmployeeConfirm('${escHtml(e.id || '')}')">‡∏•‡∏ö</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Mobile cards
    if (mobileList) {
      if (!list.length) {
        mobileList.innerHTML = '<div class="helper">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      } else {
        mobileList.innerHTML = list.map(e => {
          const faceOk = hasFace(e);
          const faceBadge = faceOk
            ? `<span class="emp-face-badge">‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`
            : `<span class="emp-face-badge off">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`;
          return `
            <div class="emp-item">
              <div class="emp-item-top">
                <div style="min-width:0;">
                  <div class="emp-name">${escHtml(e.fullName || '-')}</div>
                  <div class="emp-meta">
                    <span class="pill-small">‡πÅ‡∏ú‡∏ô‡∏Å: ${escHtml(e.branch || '-')}</span>
                    <span class="pill-small">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escHtml(e.level || '-')}</span>
                    ${faceBadge}
                  </div>
                </div>
                <div class="emp-code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(e.code || '-')}</div>
              </div>

              <div class="emp-item-actions">
                <button class="btn btn-secondary" onclick="editEmployee('${escHtml(e.id || '')}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-danger" onclick="deleteEmployeeConfirm('${escHtml(e.id || '')}')">üóëÔ∏è ‡∏•‡∏ö</button>
                <button class="btn btn-primary btn-span-2" onclick="openFaceEnroll('${escHtml(e.id || '')}')">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
              </div>
            </div>
          `;
        }).join('');
      }
    }
  }

  window.editEmployee = function(id) {
    const emp = employees.find(e => String(e.id) === String(id));
    if (!emp) return;
    editingEmpId = emp.id;
    $('empFormTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    $('empCode').value = emp.code || '';
    $('empFullName').value = emp.fullName || '';
    $('empBranch').value = emp.branch || '';
    $('empLevel').value = emp.level || '';
    $('empEmail').value = emp.email || '';

    const preview = $('empPhotoPreview');
    const inputPhoto = $('empPhoto');
    if (emp.photo) {
      preview.src = emp.photo;
      preview.style.display = 'block';
    } else {
      preview.src = '';
      preview.style.display = 'none';
    }
    if (inputPhoto) inputPhoto.value = '';

    $('empFormError').style.display = 'none';
    $('empFormSuccess').style.display = 'none';

    setEmpTab('form');
  };

  window.deleteEmployeeConfirm = async function(id) {
    const emp = employees.find(e => String(e.id) === String(id));
    if (!emp) return;
    const code = emp.code || '';
    const name = emp.fullName || '';
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ ${code} (${name}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    try {
      await api.call('deleteEmployee', { id });
      employees = await api.call('getEmployees');
      renderEmployeesTable();
      alert('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } catch (err) {
      alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  };

  async function saveEmployee() {
    const code = $('empCode').value.trim();
    const fullName = $('empFullName').value.trim();
    const branch = $('empBranch').value.trim();
    const level  = $('empLevel').value.trim();
    const email  = $('empEmail').value.trim();

    const errEl = $('empFormError');
    const sucEl = $('empFormSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';

    if (!code || !fullName) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
      errEl.style.display = 'block';
      return;
    }

    let photoBase64 = '';
    const photoInput = $('empPhoto');
    if (photoInput && photoInput.files && photoInput.files[0]) {
      try {
        photoBase64 = await fileToBase64(photoInput.files[0]);
      } catch (e) {
        console.error('‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', e);
      }
    }

    try {
      await api.call('saveEmployee', {
        id: editingEmpId || '',
        code,
        fullName,
        branch,
        level,
        email,
        photoBase64
      });
      employees = await api.call('getEmployees');
      renderEmployeesTable();
      editingEmpId = null;
      resetEmpForm(true);
      sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
      setEmpTab('list');
    } catch (err) {
      errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  function resetEmpForm(keepMsg) {
    editingEmpId = null;
    $('empFormTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
    $('empCode').value = '';
    $('empFullName').value = '';
    if ($('empBranch').options.length) $('empBranch').selectedIndex = 0;
    if ($('empLevel').options.length) $('empLevel').selectedIndex = 0;
    $('empEmail').value = '';
    const photoInput = $('empPhoto');
    const preview = $('empPhotoPreview');
    if (photoInput) photoInput.value = '';
    if (preview) {
      preview.src = '';
      preview.style.display = 'none';
    }
    $('empFormError').style.display = 'none';
    if (!keepMsg) $('empFormSuccess').style.display = 'none';
  }

  // ====== Logs ======
  function renderLogsTable(res) {
    const rows = (res && res.rows) || [];
    lastLogsRows = rows;

    const tb = $('logsTableBody');
    if (!rows.length) {
      tb.innerHTML = '<tr><td colspan="10" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = rows.map((r, idx) => {
      const total = calcTotalHours(r.t1, r.t4);
      const locText = r.locationText || '';
      const locCell = locText ? `<span class="pill-small">${escHtml(locText)}</span>` : '-';
      const evidence = r.evidenceUrl
        ? `<a href="${escHtml(r.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>`
        : '-';
      return `
        <tr>
          <td>${escHtml(formatDateThai(r.date))}</td>
          <td>${escHtml(r.code || '')}</td>
          <td>${escHtml(r.fullName || '')}</td>
          <td>${escHtml(r.t1 || '-')}</td>
          <td>${escHtml(r.t4 || '-')}</td>
          <td>${escHtml(total)}</td>
          <td>${statusBadgeHtml(r.status || '')}</td>
          <td>${locCell}</td>
          <td>${evidence}</td>
          <td>
            <button class="btn btn-secondary btn-small" onclick="openLogDetail(${idx})">‡∏î‡∏π</button>
          </td>
        </tr>
      `;
    }).join('');
  }

  async function reloadLogs() {
    const year  = $('logYearFilter').value;
    const month = $('logMonthFilter').value;
    const branch = $('logBranchFilter').value || 'ALL';
    const search = $('logSearch').value.trim();

    try {
      const res = await api.call('getLogsRange', { year, month, branch, search });
      renderLogsTable(res);
    } catch (err) {
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  // ====== Summary ======
  function renderSummaryTable(res) {
    const rows = (res && res.rows) || [];
    const tb = $('summaryTableBody');
    if (!rows.length) {
      tb.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${escHtml(r.code || '')}</td>
        <td>${escHtml(r.fullName || '')}</td>
        <td>${escHtml(r.branch || '')}</td>
        <td>${escHtml(r.level || '')}</td>
        <td>${escHtml(r.days || 0)}</td>
        <td>${escHtml(r.normalCount || 0)}</td>
        <td>${escHtml(r.lateCount || 0)}</td>
        <td>${escHtml(r.absentCount || 0)}</td>
      </tr>
    `).join('');
  }

  async function reloadSummary() {
    const year  = $('sumYearFilter').value;
    const month = $('sumMonthFilter').value;
    const branch = $('sumBranchFilter').value || 'ALL';
    try {
      const res = await api.call('getSummaryRange', { year, month, branch });
      renderSummaryTable(res);
    } catch (err) {
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  // ====== Settings (branches/levels) ======
  function renderBranchesLevelsTables() {
    const bt = $('branchTableBody');
    const lt = $('levelTableBody');

    if (!branches.length) {
      bt.innerHTML = '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å</td></tr>';
    } else {
      bt.innerHTML = branches.map(b => `
        <tr>
          <td>${escHtml(b.name)}</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteBranch('${escHtml(b.name)}')">‡∏•‡∏ö</button></td>
        </tr>
      `).join('');
    }

    if (!levels.length) {
      lt.innerHTML = '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>';
    } else {
      lt.innerHTML = levels.map(l => `
        <tr>
          <td>${escHtml(l.name)}</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteLevel('${escHtml(l.name)}')">‡∏•‡∏ö</button></td>
        </tr>
      `).join('');
    }
  }

  window.deleteBranch = async function(name) {
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try {
      await api.call('deleteBranch', { name });
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      $('settingsSuccess').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('settingsSuccess').style.display = 'block';
      $('settingsError').style.display = 'none';
    } catch (err) {
      $('settingsError').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('settingsError').style.display = 'block';
      $('settingsSuccess').style.display = 'none';
    }
  };

  window.deleteLevel = async function(name) {
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try {
      await api.call('deleteLevel', { name });
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      $('settingsSuccess').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('settingsSuccess').style.display = 'block';
      $('settingsError').style.display = 'none';
    } catch (err) {
      $('settingsError').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('settingsError').style.display = 'block';
      $('settingsSuccess').style.display = 'none';
    }
  };

  async function addBranch() {
    const name = $('branchName').value.trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if (!name) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å';
      errEl.style.display = 'block';
      return;
    }
    try {
      await api.call('saveBranch', { name });
      $('branchName').value = '';
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    } catch (err) {
      errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  async function addLevel() {
    const name = $('levelName').value.trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if (!name) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö';
      errEl.style.display = 'block';
      return;
    }
    try {
      await api.call('saveLevel', { name });
      $('levelName').value = '';
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    } catch (err) {
      errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  // ====== URL Card ======
  function openUrlCard() {
    $('inputApiUrl').value = getApiUrl();
    $('urlCard').style.display = 'block';
    $('urlError').style.display = 'none';
  }
  function closeUrlCard() { $('urlCard').style.display = 'none'; }

  function saveUrl() {
    const url = $('inputApiUrl').value.trim();
    const errEl = $('urlError');
    errEl.style.display = 'none';
    if (!url) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL';
      errEl.style.display = 'block';
      return;
    }
    setApiUrl(url);
    setApiText(url);
    closeUrlCard();
    initAdmin();
  }

  // ====== Navigation ======
  function switchSection(section) {
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.section === section));
    document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.toggle('active', el.dataset.section === section));
    document.querySelectorAll('.section').forEach(el => el.classList.toggle('active', el.id === 'section-' + section));

    if (section === 'employees') applyEmpMobileLayout();
  }

  function ellipsizeUrl(url) {
    if (!url) return '';
    if (url.length <= 48) return url;
    return url.slice(0, 28) + '...' + url.slice(-12);
  }

  function setApiText(url) {
    const el = $('apiUrlDisplay');
    if (!el) return;
    el.textContent = url ? ('API: ' + ellipsizeUrl(url)) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
    el.title = url ? ('‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å: ' + url) : '';
    el.dataset.full = url || '';
  }

  // ====== Employees mobile tab ======
  function isMobileEmployeesMode() {
    return window.matchMedia('(max-width: 800px)').matches;
  }

  function setEmpTab(tab) {
    empTabState = tab;

    const formCard = $('empFormCard');
    const listCard = $('empListCard');
    const bForm = $('btnEmpTabForm');
    const bList = $('btnEmpTabList');

    if (!isMobileEmployeesMode()) {
      if (formCard) formCard.classList.remove('emp-hidden');
      if (listCard) listCard.classList.remove('emp-hidden');
      if (bForm) bForm.classList.add('active');
      if (bList) bList.classList.remove('active');
      return;
    }

    if (tab === 'list') {
      formCard.classList.add('emp-hidden');
      listCard.classList.remove('emp-hidden');
      bForm.classList.remove('active');
      bList.classList.add('active');
    } else {
      listCard.classList.add('emp-hidden');
      formCard.classList.remove('emp-hidden');
      bList.classList.remove('active');
      bForm.classList.add('active');
    }
  }

  function applyEmpMobileLayout() {
    if (isMobileEmployeesMode()) setEmpTab(empTabState || 'form');
    else setEmpTab('form');
  }

  // ====== Feature: FACE ENROLL (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action: uploadEmployeeFace) ======
  window.openFaceEnroll = function(empId) {
    const emp = employees.find(e => String(e.id) === String(empId));
    if (!emp) return;

    faceTargetEmp = { id: emp.id, code: emp.code, fullName: emp.fullName };
    faceBase64 = '';

    $('faceModalSub').innerHTML = `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <b>${escHtml(emp.fullName || '-')}</b> ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™ <b>${escHtml(emp.code || '-')}</b>`;
    $('faceError').style.display = 'none';
    $('faceSuccess').style.display = 'none';
    $('faceStatusText').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
    $('facePreviewImg').src = '';
    $('facePreviewImg').style.display = 'none';

    $('facePhotoInput').value = '';
    $('btnFaceUpload').disabled = false;

    openModal('faceModalBackdrop');
  };

  function openModal(id) {
    const el = $(id);
    if (!el) return;
    el.style.display = 'flex';
    el.setAttribute('aria-hidden', 'false');
  }

  function closeModal(id) {
    const el = $(id);
    if (!el) return;
    el.style.display = 'none';
    el.setAttribute('aria-hidden', 'true');
  }

  async function compressImageToJpegBase64(file) {
    // ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå -> ‡∏¢‡πà‡∏≠ -> jpeg base64
    const dataUrl = await fileToBase64(file);

    const img = new Image();
    img.src = dataUrl;

    await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
    });

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;

    const maxEdge = HARD.FACE_IMAGE_MAX_EDGE;
    let nw = w, nh = h;
    if (Math.max(w, h) > maxEdge) {
      const scale = maxEdge / Math.max(w, h);
      nw = Math.round(w * scale);
      nh = Math.round(h * scale);
    }

    const canvas = document.createElement('canvas');
    canvas.width = nw;
    canvas.height = nh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, nw, nh);

    let out = canvas.toDataURL('image/jpeg', HARD.FACE_IMAGE_QUALITY);

    // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î
    if (out.length > HARD.FACE_MAX_BYTES * 1.37) {
      out = canvas.toDataURL('image/jpeg', 0.78);
    }
    if (out.length > HARD.FACE_MAX_BYTES * 1.37) {
      out = canvas.toDataURL('image/jpeg', 0.68);
    }
    return out;
  }

  async function handleFaceFileSelected() {
    const file = $('facePhotoInput').files && $('facePhotoInput').files[0];
    $('faceError').style.display = 'none';
    $('faceSuccess').style.display = 'none';

    if (!file) {
      faceBase64 = '';
      $('faceStatusText').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
      $('facePreviewImg').src = '';
      $('facePreviewImg').style.display = 'none';
      return;
    }

    try {
      $('faceStatusText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ...';
      const b64 = await compressImageToJpegBase64(file);
      faceBase64 = b64;

      $('facePreviewImg').src = b64;
      $('facePreviewImg').style.display = 'block';
      const kb = Math.round((b64.length * 3) / 4 / 1024);
      $('faceStatusText').textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${kb} KB)`;
    } catch (err) {
      console.error(err);
      faceBase64 = '';
      $('faceStatusText').textContent = '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('faceError').textContent = '‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('faceError').style.display = 'block';
    }
  }

  async function uploadEmployeeFace() {
    const errEl = $('faceError');
    const sucEl = $('faceSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';

    if (!faceTargetEmp) return;

    if (!faceBase64) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô';
      errEl.style.display = 'block';
      return;
    }

    $('btnFaceUpload').disabled = true;
    $('faceStatusText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

    try {
      // ‚úÖ ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ù‡∏±‡πà‡∏á GS ‡∏£‡∏±‡∏ö action = uploadEmployeeFace
      // ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á id ‡πÅ‡∏•‡∏∞ code ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î
      await api.call('uploadEmployeeFace', {
        id: faceTargetEmp.id || '',
        code: faceTargetEmp.code || '',
        photoBase64: faceBase64
      });

      sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ';
      sucEl.style.display = 'block';
      $('faceStatusText').textContent = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

      // refresh employees ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ badge ‚Äú‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡∏Ç‡∏∂‡πâ‡∏ô
      employees = await api.call('getEmployees');
      renderEmployeesTable();

    } catch (err) {
      errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
      $('faceStatusText').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    } finally {
      $('btnFaceUpload').disabled = false;
    }
  }

  function clearFaceModal() {
    faceBase64 = '';
    $('facePhotoInput').value = '';
    $('facePreviewImg').src = '';
    $('facePreviewImg').style.display = 'none';
    $('faceStatusText').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
    $('faceError').style.display = 'none';
    $('faceSuccess').style.display = 'none';
  }

  // ====== Feature: LOG DETAIL MODAL ======
  window.openLogDetail = function(index) {
    const r = lastLogsRows && lastLogsRows[index];
    if (!r) return;
    logModalRow = r;

    const d = formatDateThai(r.date);
    $('logModalSub').innerHTML = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <b>${escHtml(d)}</b> ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™ <b>${escHtml(r.code || '-')}</b> ‚Ä¢ <b>${escHtml(r.fullName || '-')}</b>`;

    const keyLines = [
      `t1=${r.t1 || '-'}`,
      `t2=${r.t2 || '-'}`,
      `t3=${r.t3 || '-'}`,
      `t4=${r.t4 || '-'}`,
      `status=${r.status || '-'}`,
      `method=${r.method || '-'}`,
      `rawType=${r.rawType || '-'}`,
      `note=${r.note || '-'}`,
      `locationText=${r.locationText || '-'}`,
      `zone=${r.locationZone || r.zone || '-'}`,
    ];

    $('logKeyText').textContent = keyLines.join(' | ');

    const raw = JSON.stringify(r, null, 2);
    $('logRawText').textContent = raw;

    const evidenceUrl = r.evidenceUrl || '';
    const img = $('logEvidenceImg');
    const btnOpen = $('btnOpenEvidence');

    if (evidenceUrl) {
      img.src = evidenceUrl;
      img.style.display = 'block';
      btnOpen.disabled = false;
      btnOpen.onclick = () => window.open(evidenceUrl, '_blank', 'noopener');
    } else {
      img.src = '';
      img.style.display = 'none';
      btnOpen.disabled = true;
      btnOpen.onclick = null;
    }

    // hint ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á UNKNOWN
    const note = String(r.note || '');
    const hint = [];
    if (note === 'UNKNOWN') hint.push('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: UNKNOWN ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡∏õ‡∏Å‡∏ï‡∏¥‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà error)');
    if (String(r.method || '').includes('MANUAL')) hint.push('‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö MANUAL');
    $('logModalHint').textContent = hint.join(' ‚Ä¢ ');

    openModal('logModalBackdrop');
  };

  function copyTextToClipboard(text) {
    return navigator.clipboard.writeText(text).catch(() => {
      prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ:', text);
    });
  }

  // ====== INIT ======
  async function initAdmin() {
    const apiUrl = getApiUrl();
    setApiText(apiUrl);

    if (!apiUrl) {
      setConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
      return;
    }

    try {
      const [empRes, blRes, todaySummary, monthSummary] = await Promise.all([
        api.call('getEmployees'),
        api.call('getBranchesLevels'),
        api.call('getTodaySummary'),
        (async () => {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1;
          return api.call('getSummaryRange', { year, month, branch: 'ALL' });
        })()
      ]);

      employees = empRes || [];
      branches  = blRes.branches || [];
      levels    = blRes.levels || [];

      setConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      renderBranchLevelSelects();
      renderEmployeesTable();
      renderBranchesLevelsTables();
      renderDashboard(todaySummary, monthSummary);

      fillYearMonthSelect($('logYearFilter'), $('logMonthFilter'));
      fillYearMonthSelect($('sumYearFilter'), $('sumMonthFilter'));

      await reloadLogs();
      await reloadSummary();

      applyEmpMobileLayout();

    } catch (err) {
      console.error(err);
      setConnectionStatus(false, err.message);
      alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.nav-item').forEach(el => el.addEventListener('click', () => switchSection(el.getAttribute('data-section'))));
    document.querySelectorAll('.mobile-nav-item').forEach(el => el.addEventListener('click', () => switchSection(el.getAttribute('data-section'))));

    $('btnBackToFront').addEventListener('click', () => { window.location.href = 'index.html'; });

    $('btnLogout').addEventListener('click', () => {
      if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡∏ö URL API ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        setApiUrl('');
        window.location.href = 'index.html';
      }
    });

    $('btnSetUrl').addEventListener('click', openUrlCard);
    $('btnSaveUrl').addEventListener('click', saveUrl);
    $('btnCancelUrl').addEventListener('click', closeUrlCard);

    $('apiUrlDisplay').addEventListener('click', async () => {
      const full = $('apiUrlDisplay').dataset.full || '';
      if (!full) return;
      try {
        await navigator.clipboard.writeText(full);
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ô‡∏µ‡πâ:', full);
      }
    });

    $('empSearch').addEventListener('input', renderEmployeesTable);
    $('btnSaveEmployee').addEventListener('click', saveEmployee);
    $('btnResetEmpForm').addEventListener('click', () => resetEmpForm(false));

    const photoInput = $('empPhoto');
    const preview = $('empPhotoPreview');
    if (photoInput && preview) {
      photoInput.addEventListener('change', () => {
        const file = photoInput.files && photoInput.files[0];
        if (!file) {
          preview.src = '';
          preview.style.display = 'none';
          return;
        }
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.style.display = 'block';
      });
    }

    $('btnReloadLogs').addEventListener('click', reloadLogs);
    $('logSearch').addEventListener('keydown', e => { if (e.key === 'Enter') reloadLogs(); });

    $('logBranchFilter').addEventListener('change', reloadLogs);
    $('logMonthFilter').addEventListener('change', reloadLogs);
    $('logYearFilter').addEventListener('change', reloadLogs);

    $('btnReloadSummary').addEventListener('click', reloadSummary);
    $('sumBranchFilter').addEventListener('change', reloadSummary);
    $('sumMonthFilter').addEventListener('change', reloadSummary);
    $('sumYearFilter').addEventListener('change', reloadSummary);

    $('btnAddBranch').addEventListener('click', addBranch);
    $('btnAddLevel').addEventListener('click', addLevel);

    $('btnEmpTabForm').addEventListener('click', () => setEmpTab('form'));
    $('btnEmpTabList').addEventListener('click', () => setEmpTab('list'));

    window.addEventListener('resize', () => {
      if (document.getElementById('section-employees').classList.contains('active')) {
        applyEmpMobileLayout();
      }
    });

    // === Face modal events
    $('btnCloseFaceModal').addEventListener('click', () => closeModal('faceModalBackdrop'));
    $('faceModalBackdrop').addEventListener('click', (e) => {
      if (e.target === $('faceModalBackdrop')) closeModal('faceModalBackdrop');
    });
    $('facePhotoInput').addEventListener('change', handleFaceFileSelected);
    $('btnFaceUpload').addEventListener('click', uploadEmployeeFace);
    $('btnFaceClear').addEventListener('click', clearFaceModal);

    // === Log modal events
    $('btnCloseLogModal').addEventListener('click', () => closeModal('logModalBackdrop'));
    $('logModalBackdrop').addEventListener('click', (e) => {
      if (e.target === $('logModalBackdrop')) closeModal('logModalBackdrop');
    });
    $('btnCopyLogJson').addEventListener('click', async () => {
      const txt = logModalRow ? JSON.stringify(logModalRow, null, 2) : '';
      await copyTextToClipboard(txt);
      alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß');
    });

    initAdmin();
  });
</script>
</body>
</html>
