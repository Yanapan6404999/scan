<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#2563eb;
      --primary-soft:#dbeafe;

      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --success:#16a34a;
      --danger:#ef4444;
      --warning:#f59e0b;

      --sidebar:#020617;
      --sidebar2:#111827;
    }

    *{ box-sizing:border-box; font-family:"Prompt",system-ui,-apple-system,"Segoe UI",sans-serif; }
    html,body{ margin:0; padding:0; width:100%; overflow-x:hidden; }
    body{
      color:var(--text);
      background:
        radial-gradient(circle at top left, #e0e7ff 0, transparent 55%),
        radial-gradient(circle at bottom right, #e5f5ff 0, transparent 50%),
        var(--bg);
    }

    a{ color:var(--primary); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Buttons */
    .btn{
      border:none; cursor:pointer; border-radius:999px;
      padding:9px 14px; font-size:13px; font-weight:500;
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      transition:transform .08s ease, box-shadow .08s ease, background .1s ease, opacity .1s ease;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px) scale(.99); }
    .btn:disabled{ opacity:.6; cursor:default; transform:none; }
    .btn-primary{ background:var(--primary); color:#fff; box-shadow:0 10px 24px rgba(37,99,235,.28); }
    .btn-secondary{ background:#fff; border:1px solid var(--border); color:#111827; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-ghost{ background:transparent; border:1px solid var(--border); color:var(--muted); }
    .btn-small{ padding:6px 10px; font-size:12px; }

    /* Layout */
    .page{ display:flex; min-height:100vh; width:100%; overflow-x:hidden; }
    .sidebar{
      width:240px; flex-shrink:0;
      background:radial-gradient(circle at top, var(--sidebar2), var(--sidebar));
      color:#e5e7eb;
      padding:16px 14px;
      display:flex; flex-direction:column;
      box-shadow:8px 0 30px rgba(15,23,42,.5), 0 0 0 1px rgba(15,23,42,.55);
      position:relative; z-index:30;
    }
    .sidebar::after{
      content:""; position:absolute; inset:0;
      background:radial-gradient(circle at bottom, rgba(37,99,235,.20), transparent 60%);
      pointer-events:none;
    }
    .sidebar-header{ padding:6px 6px 16px; border-bottom:1px solid rgba(55,65,81,.9); margin-bottom:10px; position:relative; z-index:1;}
    .sidebar-title{ font-weight:700; font-size:18px; margin-bottom:2px;}
    .sidebar-sub{ font-size:11px; color:#9ca3af; }
    .nav{ margin-top:12px; display:flex; flex-direction:column; gap:6px; flex:1; min-height:0; position:relative; z-index:1;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      cursor:pointer; border:1px solid transparent;
      color:#e5e7eb; font-size:14px;
    }
    .nav-item .icon{ width:22px; display:inline-flex; justify-content:center; }
    .nav-item:hover{ background:rgba(31,41,55,.85); }
    .nav-item.active{
      background:rgba(15,23,42,.95);
      border-color:rgba(59,130,246,.75);
      box-shadow:0 10px 20px rgba(15,23,42,.75);
    }
    .sidebar-footer{
      padding-top:10px; border-top:1px solid rgba(55,65,81,.9);
      font-size:11px; color:#9ca3af;
      position:relative; z-index:1;
    }
    .sidebar-footer .btn{ width:100%; margin-top:8px; }

    .content{ flex:1; display:flex; flex-direction:column; min-width:0; max-width:100%; overflow-x:hidden; }

    header.topbar{
      padding:10px 18px;
      background:rgba(15,23,42,.92);
      color:#e5e7eb;
      border-bottom:1px solid rgba(15,23,42,.55);
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:20;
      backdrop-filter:blur(14px);
      gap:10px;
    }
    .topbar-left{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .topbar-title{ font-size:18px; font-weight:700; }
    .topbar-sub{ font-size:12px; color:#9ca3af; display:flex; flex-wrap:wrap; gap:6px; }
    #apiUrlDisplay{ cursor:pointer; word-break:break-all; overflow-wrap:anywhere; }
    .topbar-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    main.main{ padding:18px 18px 22px; }
    .main-inner{ max-width:1260px; margin:0 auto; width:100%; }

    /* Cards */
    .card{
      background:var(--card);
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,.08), 0 0 0 1px rgba(226,232,240,.9);
      border:1px solid rgba(226,232,240,.9);
      margin-bottom:14px;
      width:100%;
      overflow:hidden;
    }
    .card-header{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap; margin-bottom:10px;
    }
    .card-title{
      font-size:15px; font-weight:700;
      display:flex; align-items:center; gap:8px;
    }
    .card-title .icon{
      width:22px; height:22px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:13px;
      background:var(--primary-soft);
      color:var(--primary);
    }
    .card-subtitle{ font-size:12px; color:var(--muted); }

    /* Inputs */
    .input{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .input:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(37,99,235,.18);
    }
    select.input{ appearance:none; }

    .helper{ font-size:12px; color:var(--muted); }
    .mt-8{ margin-top:8px; }
    .mt-10{ margin-top:10px; }
    .mt-12{ margin-top:12px; }

    /* Status badges */
    .badge-status{ font-size:11px; padding:3px 9px; border-radius:999px; display:inline-block; }
    .badge-normal{ background:#dcfce7; color:#166534; }
    .badge-late{ background:#fee2e2; color:#b91c1c; }
    .badge-absent{ background:#ffe4e6; color:#be123c; }
    .badge-other{ background:#fef3c7; color:#92400e; }
    .badge-unknown{ background:#111827; color:#e5e7eb; }
    .badge-pill{ font-size:11px; padding:3px 8px; border-radius:999px; background:#e5e7eb; color:#374151; }
    .tag{ font-size:11px; padding:3px 8px; border-radius:999px; background:#e5e7eb; color:#374151; }

    .emp-face-badge{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(16,185,129,.25);
      background:rgba(16,185,129,.10);
      color:#047857;
      white-space:nowrap;
    }
    .emp-face-badge.off{
      border-color:rgba(239,68,68,.25);
      background:rgba(239,68,68,.10);
      color:#b91c1c;
    }

    /* Tables */
    table{ width:100%; border-collapse:collapse; font-size:13px; }
    thead{ background:#f3f4f6; }
    th,td{ padding:8px 8px; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap; vertical-align:top; }
    th{ font-weight:600; color:#374151; font-size:12px; }
    tbody tr:nth-child(even){ background:#f9fafb; }
    .scroll-x{ width:100%; overflow:auto; -webkit-overflow-scrolling:touch; }
    .table-wide{ width:max-content; min-width:760px; }
    .text-center{ text-align:center; }
    .text-right{ text-align:right; }

    /* Connection badge */
    .badge-connection{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      font-size:11px;
      background:rgba(15,118,110,.15);
      color:#a5f3fc;
      border:1px solid rgba(34,197,94,.8);
    }
    .badge-connection.offline{
      background:rgba(127,29,29,.35);
      color:#fecaca;
      border-color:rgba(248,113,113,.9);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,.85);
    }
    .badge-connection.offline .dot{
      background:#f97373;
      box-shadow:0 0 8px rgba(248,113,113,.8);
    }

    /* Sections */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Employee list (mobile cards) */
    .emp-mobile-list, .logs-mobile-list, .summary-mobile-list{
      display:flex; flex-direction:column; gap:10px;
      padding:6px 2px 2px;
    }
    .item{
      border:1px solid rgba(226,232,240,.95);
      border-radius:16px;
      padding:12px 12px 10px;
      background:#fff;
      box-shadow:0 10px 22px rgba(15,23,42,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item-top{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .item-title{ font-weight:700; font-size:14px; line-height:1.25; }
    .item-meta{
      font-size:12px; color:var(--muted);
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .code-badge{
      font-size:11px; padding:3px 8px; border-radius:999px;
      background:rgba(37,99,235,.12);
      color:var(--primary);
      border:1px solid rgba(37,99,235,.25);
      white-space:nowrap;
      height:fit-content;
    }
    .pill-small{
      font-size:10px; padding:2px 6px; border-radius:999px;
      background:#e5e7eb; color:#4b5563;
    }

    .item-actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .item-actions .btn{ width:100%; padding:10px 12px; }
    .btn-span-2{ grid-column:1 / -1; }

    /* Desktop vs Mobile toggles */
    .desktop-only{ display:block; }
    .mobile-only{ display:none; }
    @media (max-width:900px){
      .desktop-only{ display:none; }
      .mobile-only{ display:block; }
    }

    /* Bottom nav (mobile) */
    .bottom-nav{
      display:none;
      position:fixed;
      left:10px; right:10px; bottom:10px;
      z-index:40;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(31,41,55,.85);
      border-radius:18px;
      padding:8px;
      backdrop-filter:blur(12px);
      box-shadow:0 16px 44px rgba(15,23,42,.35);
    }
    .bottom-nav-inner{
      display:grid;
      grid-template-columns:repeat(5, minmax(0,1fr));
      gap:6px;
    }
    .bottom-item{
      border:none;
      background:transparent;
      color:#cbd5e1;
      border-radius:14px;
      padding:8px 6px;
      cursor:pointer;
      display:flex; flex-direction:column; align-items:center; gap:2px;
      font-size:10px;
    }
    .bottom-item .bicon{ font-size:16px; }
    .bottom-item.active{
      background:rgba(37,99,235,.18);
      color:#fff;
      border:1px solid rgba(59,130,246,.45);
      box-shadow:0 10px 18px rgba(37,99,235,.22);
    }

    @media (max-width:1000px){
      .sidebar{ display:none; }
      .page{ flex-direction:column; }
      main.main{ padding:14px 12px 90px; } /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ bottom nav */
      .bottom-nav{ display:block; }
      header.topbar{ padding:10px 12px; }
    }
    @media (max-width:640px){
      header.topbar{ flex-direction:column; align-items:flex-start; }
      .topbar-right{ width:100%; display:flex; justify-content:space-between; }
    }

    /* URL card (floating) */
    #urlCard{
      position:fixed;
      right:16px;
      bottom:92px; /* ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô bottom nav */
      max-width:420px;
      width:calc(100% - 32px);
      z-index:45;
      display:none;
    }
    @media (min-width:1001px){
      #urlCard{ bottom:16px; }
    }
    @media (max-width:640px){
      #urlCard{ left:12px; right:12px; width:auto; }
    }

    /* Modals */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal{
      width:100%;
      max-width:560px;
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(226,232,240,.9);
      box-shadow:0 30px 80px rgba(15,23,42,.35);
      overflow:hidden;
    }
    .modal-header{
      padding:12px 14px;
      border-bottom:1px solid #e5e7eb;
      display:flex; justify-content:space-between; gap:10px;
      background:#f8fafc;
    }
    .modal-title{ font-weight:700; font-size:14px; }
    .modal-sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .modal-body{ padding:12px 14px 14px; }
    .modal-footer{
      padding:12px 14px;
      border-top:1px solid #e5e7eb;
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      background:#fafafa;
    }

    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    .grid-3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; }
    @media (max-width:800px){
      .grid-2,.grid-3{ grid-template-columns:1fr; }
    }

    .stat-card{
      padding:10px 12px; border-radius:14px;
      background:#f9fafb; border:1px dashed #e5e7eb;
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .stat-label{ font-size:12px; color:var(--muted); }
    .stat-value{ font-size:20px; font-weight:800; }
    .stat-extra{ font-size:11px; color:var(--muted); }
    .stat-accent{ color:#16a34a; }
    .stat-danger{ color:#b91c1c; }

    .skeleton{
      background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%);
      background-size:400% 100%;
      animation:sk 1.2s ease infinite;
      border-radius:12px;
      height:14px;
      width:100%;
    }
    @keyframes sk{ 0%{background-position:100% 0} 100%{background-position:0 0} }

    .error-text{ font-size:12px; color:var(--danger); margin-top:6px; }
    .success-text{ font-size:12px; color:var(--success); margin-top:6px; }

    /* preview box (face/log modal) */
    .preview-box{
      border:1px dashed #e5e7eb;
      border-radius:14px;
      padding:10px;
      background:#f9fafb;
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .preview-box img{
      width:110px; height:110px; border-radius:12px;
      object-fit:cover;
      border:1px solid rgba(226,232,240,.9);
      background:#fff;
    }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace; font-size:12px; }

    .kv{
      display:grid;
      grid-template-columns:90px 1fr;
      gap:6px 10px;
      font-size:12px;
      color:#111827;
    }
    .kv .k{ color:var(--muted); }
    .kv .v{ font-weight:600; }
  </style>
</head>

<body>
<div class="page">
  <!-- SIDEBAR (Desktop) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <div class="sidebar-sub">HR Attendance Panel</div>
    </div>

    <nav class="nav">
      <div class="nav-item active" data-section="dashboard"><span class="icon">üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span></div>
      <div class="nav-item" data-section="employees"><span class="icon">üë•</span><span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span></div>
      <div class="nav-item" data-section="logs"><span class="icon">‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</span></div>
      <div class="nav-item" data-section="summary"><span class="icon">üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span></div>
      <div class="nav-item" data-section="settings"><span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏ú‡∏ô‡∏Å/‡∏£‡∏∞‡∏î‡∏±‡∏ö)</span></div>
    </nav>

    <div class="sidebar-footer">
      <div>TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
      <button class="btn btn-ghost" id="btnBackToFront">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn btn-danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </aside>

  <div class="content">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="topbar-sub">
          <span>Admin Panel |</span>
          <span id="apiUrlDisplay" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL"></span>
        </div>
      </div>
      <div class="topbar-right">
        <div id="connectionBadge" class="badge-connection offline">
          <span class="dot"></span>
          <span id="connectionText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        <button class="btn btn-secondary" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
      </div>
    </header>

    <main class="main">
      <div class="main-inner">

        <!-- DASHBOARD -->
        <section class="section active" id="section-dashboard">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìä</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="card-subtitle">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á HR</div>
              </div>
            </div>

            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="stat-value" id="statTotalEmployees"><div class="skeleton"></div></div>
                <div class="stat-extra">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Employees</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value stat-accent" id="statTodayCount"><div class="skeleton"></div></div>
                <div class="stat-extra"><span class="stat-danger" id="statTodayLate">‡∏™‡∏≤‡∏¢ 0 ‡∏Ñ‡∏ô</span></div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏™‡∏≤‡∏¢ / ‡∏Ç‡∏≤‡∏î)</div>
                <div class="stat-value" id="statMonthOverview"><div class="skeleton"></div></div>
                <div class="stat-extra">‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getSummaryRange</div>
              </div>
            </div>

            <div class="mt-12">
              <div class="card-subtitle">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="scroll-x mt-8">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th><th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</th>
                      <th>‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                  </thead>
                  <tbody id="dashboardTodayBody">
                    <tr><td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-10">
                <div class="card-subtitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
                <div id="dashboardLocationSummary" class="mt-8" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- EMPLOYEES (Clean: list first + modal form) -->
        <section class="section" id="section-employees">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üë•</span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                <div class="card-subtitle">
                  ‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ô‡πâ‡∏ô ‚Äú‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‚Äù ‡πÉ‡∏´‡πâ‡πÇ‡∏•‡πà‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ ‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‚Ä¢ ‡∏Ñ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‚úÖ
                </div>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; min-width:260px; max-width:420px; width:100%;">
                <input id="empSearch" class="input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠" />
                <button class="btn btn-primary" id="btnOpenAddEmp">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
              </div>
            </div>

            <!-- Desktop table -->
            <div class="desktop-only">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                      <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                      <th>‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody id="empTableBody">
                    <tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Mobile cards -->
            <div class="mobile-only">
              <div id="empMobileList" class="emp-mobile-list">
                <div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
              </div>
            </div>

            <div class="helper mt-10">
              * ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏° üì∏ ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß) ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚úÖ
            </div>
          </div>
        </section>

        <!-- LOGS -->
        <section class="section" id="section-logs">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">‚è±</span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div class="card-subtitle">‡∏ï‡∏≤‡∏£‡∏≤‡∏á PC / ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‚Ä¢ ‚Äú‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‚Äù ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°</div>
              </div>
            </div>

            <div class="mt-8" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end;">
              <div style="flex:1; min-width:200px;">
                <div class="helper">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™</div>
                <input id="logSearch" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011, ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <select id="logBranchFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <select id="logMonthFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏õ‡∏µ (‡∏û.‡∏®.)</div>
                <select id="logYearFilter" class="input"></select>
              </div>
              <button class="btn btn-primary" id="btnReloadLogs">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>

            <div class="desktop-only mt-10">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏≠‡∏≠‡∏Å</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</th>
                      <th>‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th><th>‡∏î‡∏π</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr><td colspan="11" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mobile-only mt-10">
              <div id="logsMobileList" class="logs-mobile-list">
                <div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              </div>
            </div>

            <div class="helper mt-10">
              * ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å t1 ‡∏ñ‡∏∂‡∏á t4 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö) | ‚Äú‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‚Äù ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ GS)
            </div>
          </div>
        </section>

        <!-- SUMMARY -->
        <section class="section" id="section-summary">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìà</span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                <div class="card-subtitle">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ç‡∏≤‡∏î‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô ‡∏Ø‡∏•‡∏Ø</div>
              </div>
            </div>

            <div class="mt-8" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end;">
              <div style="min-width:160px;">
                <div class="helper">‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <select id="sumBranchFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <select id="sumMonthFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏õ‡∏µ (‡∏û.‡∏®.)</div>
                <select id="sumYearFilter" class="input"></select>
              </div>
              <button class="btn btn-primary" id="btnReloadSummary">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>

            <div class="desktop-only mt-10">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏≤‡∏¢</th><th>‡∏Ç‡∏≤‡∏î</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTableBody">
                    <tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mobile-only mt-10">
              <div id="summaryMobileList" class="summary-mobile-list">
                <div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              </div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="section" id="section-settings">
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title"><span class="icon">üè∑Ô∏è</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å</div>
                  <div class="card-subtitle">‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á ‡πÜ</div>
                </div>
              </div>

              <div class="mt-8">
                <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input id="branchName" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ / ‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" />
                  <button class="btn btn-primary" id="btnAddBranch">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
              </div>

              <div class="scroll-x mt-10" style="max-height:360px; overflow:auto;">
                <table>
                  <thead><tr><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                  <tbody id="branchTableBody"><tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title"><span class="icon">üìå</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <div class="card-subtitle">‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô / ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Ø‡∏•‡∏Ø</div>
                </div>
              </div>

              <div class="mt-8">
                <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input id="levelName" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô" />
                  <button class="btn btn-primary" id="btnAddLevel">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
              </div>

              <div class="scroll-x mt-10" style="max-height:360px; overflow:auto;">
                <table>
                  <thead><tr><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                  <tbody id="levelTableBody"><tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
                </table>
              </div>

              <div id="settingsError" class="error-text" style="display:none;"></div>
              <div id="settingsSuccess" class="success-text" style="display:none;"></div>
            </div>
          </div>
        </section>

        <!-- URL CARD -->
        <div class="card" id="urlCard">
          <div class="card-header">
            <div class="card-title"><span class="icon">üîó</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API</div>
          </div>
          <div class="helper">URL ‡∏à‡∏≤‡∏Å Apps Script Web App (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <code>/exec</code>)</div>
          <input id="inputApiUrl" class="input mt-8" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/XXXXX/exec" />
          <div class="mt-10" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn btn-secondary" id="btnCancelUrl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
          <div id="urlError" class="error-text" style="display:none;"></div>
        </div>

      </div>
    </main>
  </div>
</div>

<!-- Bottom Nav (Mobile) -->
<div class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="bottom-item active" data-section="dashboard"><div class="bicon">üìä</div><div>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div></button>
    <button class="bottom-item" data-section="employees"><div class="bicon">üë•</div><div>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></button>
    <button class="bottom-item" data-section="logs"><div class="bicon">‚è±</div><div>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></button>
    <button class="bottom-item" data-section="summary"><div class="bicon">üìà</div><div>‡∏™‡∏£‡∏∏‡∏õ</div></button>
    <button class="bottom-item" data-section="settings"><div class="bicon">‚öôÔ∏è</div><div>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div></button>
  </div>
</div>

<!-- MODAL: EMPLOYEE FORM -->
<div class="modal-backdrop" id="empModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="empModalTitle">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="empModalTitle">üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
        <div class="modal-sub" id="empModalSub">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ)</div>
      </div>
      <button class="btn btn-ghost btn-small" id="btnCloseEmpModal" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <div>
          <div class="helper">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <input id="empCode" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" />
        </div>
        <div>
          <div class="helper">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
          <input id="empEmail" class="input" placeholder="optional" />
        </div>
      </div>

      <div class="mt-10">
        <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
        <input id="empFullName" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
      </div>

      <div class="grid-2 mt-10">
        <div>
          <div class="helper">‡πÅ‡∏ú‡∏ô‡∏Å</div>
          <select id="empBranch" class="input"></select>
        </div>
        <div>
          <div class="helper">‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
          <select id="empLevel" class="input"></select>
        </div>
      </div>

      <div id="empFormError" class="error-text" style="display:none;"></div>
      <div id="empFormSuccess" class="success-text" style="display:none;"></div>

      <div class="helper mt-10">
        ‚úÖ ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚Äú‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡∏ó‡∏≥‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏° üì∏ ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ UI ‡πÑ‡∏°‡πà‡∏£‡∏Å)
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnResetEmpForm" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      <button class="btn btn-primary" id="btnSaveEmployee" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: FACE ENROLL -->
<div class="modal-backdrop" id="faceModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faceModalTitle">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="faceModalTitle">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
        <div class="modal-sub" id="faceModalSub">‚Äì</div>
      </div>
      <button class="btn btn-ghost btn-small" id="btnCloseFaceModal" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="helper">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î ‡πÜ 1 ‡∏£‡∏π‡∏õ (‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù</div>

      <div class="mt-10">
        <div class="helper">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤)</div>
        <input type="file" id="facePhotoInput" accept="image/*" capture="user" class="input" />
      </div>

      <div class="mt-10 preview-box">
        <img id="facePreviewImg" alt="preview" style="display:none;" />
        <div style="min-width:0; flex:1;">
          <div class="helper">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          <div class="mono" id="faceStatusText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ</div>
          <div class="helper mt-8">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
          <div class="mono" id="faceHintText" style="white-space:pre-wrap;">
- ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ UNKNOWN ‡πÉ‡∏ô Logs ‚Äú‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‚Äù (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà error)
- ‡∏ñ‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡πâ‡∏≤‡∏¢ ‚Äú‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
          </div>
        </div>
      </div>

      <div id="faceError" class="error-text" style="display:none;"></div>
      <div id="faceSuccess" class="success-text" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnFaceClear" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ</button>
      <button class="btn btn-primary" id="btnFaceUpload" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
    </div>
  </div>
</div>

<!-- MODAL: LOG DETAIL -->
<div class="modal-backdrop" id="logModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="logModalTitle">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="logModalTitle">üßæ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="modal-sub" id="logModalSub">‚Äì</div>
      </div>
      <button class="btn btn-ghost btn-small" id="btnCloseLogModal" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="helper">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß Logs (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</div>

      <div class="mt-10 preview-box">
        <img id="logEvidenceImg" alt="evidence" style="display:none;" />
        <div style="min-width:0;flex:1;">
          <div class="helper">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
          <div class="mono" id="logKeyText">‚Äì</div>
          <div class="helper mt-8">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö</div>
          <div class="mono" id="logRawText" style="white-space:pre-wrap;">‚Äì</div>
        </div>
      </div>

      <div id="logModalHint" class="helper mt-10"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnOpenEvidence" type="button" disabled>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</button>
      <button class="btn btn-primary" id="btnCopyLogJson" type="button">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'attendance_api_url_v2';

  // ====== HARD (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤) =========================
  const HARD = {
    FACE_MAX_BYTES: 900 * 1024,
    FACE_IMAGE_QUALITY: 0.86,
    FACE_IMAGE_MAX_EDGE: 960,
    CACHE_TTL_MS: 60 * 1000
  };

  function $(id){ return document.getElementById(id); }

  function getApiUrl(){ return localStorage.getItem(STORAGE_KEY) || ''; }
  function setApiUrl(url){
    if(!url) localStorage.removeItem(STORAGE_KEY);
    else localStorage.setItem(STORAGE_KEY, url);
  }

  const api = {
    async call(action, params = {}){
      const apiUrl = getApiUrl();
      if(!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');

      const body = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch(e){
        console.error('API response is not JSON:', text);
        throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)');
      }
      if(!data.ok) throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      return data.result;
    }
  };

  // data
  let employees = [];
  let branches = [];
  let levels = [];
  let editingEmpId = null;

  // face modal
  let faceTargetEmp = null;
  let faceBase64 = '';

  // logs
  let lastLogsRows = [];
  let logModalRow = null;

  // lazy loading
  const loaded = { core:false, logs:false, summary:false };

  function escHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function setConnectionStatus(online, msg){
    const bdg = $('connectionBadge');
    const txt = $('connectionText');
    if(!bdg || !txt) return;
    if(online){
      bdg.classList.remove('offline');
      txt.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }else{
      bdg.classList.add('offline');
      txt.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
    }
  }

  function ellipsizeUrl(url){
    if(!url) return '';
    if(url.length <= 48) return url;
    return url.slice(0, 28) + '...' + url.slice(-12);
  }
  function setApiText(url){
    const el = $('apiUrlDisplay');
    if(!el) return;
    el.textContent = url ? ('API: ' + ellipsizeUrl(url)) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
    el.title = url ? ('‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å: ' + url) : '';
    el.dataset.full = url || '';
  }

  function openUrlCard(){
    $('inputApiUrl').value = getApiUrl();
    $('urlCard').style.display = 'block';
    $('urlError').style.display = 'none';
  }
  function closeUrlCard(){ $('urlCard').style.display = 'none'; }
  function saveUrl(){
    const url = $('inputApiUrl').value.trim();
    const errEl = $('urlError');
    errEl.style.display = 'none';
    if(!url){
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL';
      errEl.style.display = 'block';
      return;
    }
    setApiUrl(url);
    setApiText(url);
    closeUrlCard();
    initAdmin();
  }

  // ====== sections nav ======
  function switchSection(section){
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.section === section));
    document.querySelectorAll('.bottom-item').forEach(el => el.classList.toggle('active', el.dataset.section === section));
    document.querySelectorAll('.section').forEach(el => el.classList.toggle('active', el.id === 'section-' + section));

    if(section === 'logs' && !loaded.logs){
      $('logsTableBody').innerHTML = '<tr><td colspan="11" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
      $('logsMobileList').innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      reloadLogs();
    }
    if(section === 'summary' && !loaded.summary){
      $('summaryTableBody').innerHTML = '<tr><td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
      $('summaryMobileList').innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      reloadSummary();
    }
  }

  // ====== badges/status ======
  function statusBadgeHtml(status){
    const s = String(status || '').trim();
    if(!s) return '<span class="badge-status badge-absent">‡∏Ç‡∏≤‡∏î</span>';
    const up = s.toUpperCase();
    if(up.includes('UNKNOWN') || up.includes('UNKNOW')) return '<span class="badge-status badge-unknown">UNKNOWN</span>';

    let cls = 'badge-other';
    if(s === '‡∏õ‡∏Å‡∏ï‡∏¥') cls = 'badge-normal';
    else if(s.includes('‡∏™‡∏≤‡∏¢') || s.includes('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏ß') || s.includes('‡∏≠‡∏≠‡∏Å‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏ß')) cls = 'badge-late';
    else if(s === '‡∏Ç‡∏≤‡∏î') cls = 'badge-absent';
    return '<span class="badge-status '+cls+'">'+escHtml(s)+'</span>';
  }

  function timeToMinutes(t){
    if(!t) return null;
    const parts = String(t).split(':');
    if(parts.length < 2) return null;
    const h = Number(parts[0]), m = Number(parts[1]);
    if(isNaN(h) || isNaN(m)) return null;
    return h * 60 + m;
  }
  function minutesToThai(min){
    if(min == null) return '-';
    if(min <= 0) return '0 ‡∏ô‡∏≤‡∏ó‡∏µ';
    const h = Math.floor(min / 60);
    const m = min % 60;
    if(h <= 0) return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    return `${h} ‡∏ä‡∏° ${m.toString().padStart(2,'0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }
  function calcTotalHours(t1, t4){
    const m1 = timeToMinutes(t1);
    const m4 = timeToMinutes(t4);
    if(m1 == null || m4 == null || m4 <= m1) return '-';
    return minutesToThai(m4 - m1);
  }

  function formatDateThai(dateStr){
    let d;
    if(dateStr instanceof Date) d = dateStr;
    else{
      const parts = String(dateStr).split('-');
      if(parts.length === 3) d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
      else return String(dateStr || '');
    }
    const dd = d.getDate().toString().padStart(2,'0');
    const mm = (d.getMonth()+1).toString().padStart(2,'0');
    const yy = d.getFullYear() + 543;
    return `${dd}/${mm}/${yy}`;
  }

  function isRealTime(v){
    if(v == null) return false;
    const s = String(v).trim();
    if(!s) return false;
    if(s === '-' || s === '‚Äì') return false;
    return true;
  }
  function hasAnyLogRow(r){
    return isRealTime(r.t1) || isRealTime(r.t2) || isRealTime(r.t3) || isRealTime(r.t4);
  }

  // calc penalty from status
  function calcPenaltyFromStatus(status){
    const s = String(status || '').trim();
    if(!s) return { kind:'none', minutes:0 };
    const up = s.toUpperCase();
    if(up.includes('UNKNOWN') || up.includes('UNKNOW')) return { kind:'unknown' };
    if(s.includes('HR') || s.includes('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö')) return { kind:'unknown' };

    let total = 0;
    const re = /(\d+)\s*(?:‡∏ä‡∏°\.?|‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)\s*(\d+)\s*‡∏ô‡∏≤‡∏ó‡∏µ|(\d+)\s*‡∏ô‡∏≤‡∏ó‡∏µ/g;
    let m;
    while((m = re.exec(s)) !== null){
      if(m[1] && m[2]) total += (Number(m[1]) * 60) + Number(m[2]);
      else if(m[3]) total += Number(m[3]);
    }
    return { kind:'ok', minutes:total };
  }
  function penaltyHtmlFromRow(r){
    const res = calcPenaltyFromStatus(r.status || '');
    if(res.kind === 'unknown') return '<span class="badge-status badge-unknown">UNKNOWN</span>';
    if(res.kind === 'none') return '-';
    return `<span class="badge-pill">${escHtml(minutesToThai(res.minutes))}</span>`;
  }

  // ====== branches/levels selects ======
  function renderBranchLevelSelects(){
    const branchSel = $('empBranch');
    const levelSel  = $('empLevel');

    branchSel.innerHTML = branches.length
      ? branches.map(b => `<option value="${escHtml(b.name)}">${escHtml(b.name)}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å -</option>';

    levelSel.innerHTML = levels.length
      ? levels.map(l => `<option value="${escHtml(l.name)}">${escHtml(l.name)}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö -</option>';

    const logBranch = $('logBranchFilter');
    const sumBranch = $('sumBranchFilter');
    const opts = ['<option value="ALL">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>'].concat(
      branches.map(b => `<option value="${escHtml(b.name)}">${escHtml(b.name)}</option>`)
    );
    logBranch.innerHTML = opts.join('');
    sumBranch.innerHTML = opts.join('');
  }

  function hasFace(e){
    const fd = e && e.faceData;
    if(!fd) return false;
    const s = String(fd).trim();
    if(!s) return false;
    if(s === '-' || s === '‚Äì') return false;
    return true;
  }

  // ====== employees render ======
  function renderEmployeesTable(){
    const tb = $('empTableBody');
    const mobileList = $('empMobileList');
    const q = ($('empSearch').value || '').trim().toLowerCase();

    let list = employees;
    if(q){
      list = list.filter(e => (String(e.code)+' '+String(e.fullName)).toLowerCase().includes(q));
    }

    if(!list.length){
      tb.innerHTML = '<tr><td colspan="6" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      return;
    }

    // desktop table
    tb.innerHTML = list.map(e => {
      const faceOk = hasFace(e);
      const faceBadge = faceOk
        ? `<span class="emp-face-badge">‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`
        : `<span class="emp-face-badge off">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`;

      return `
        <tr>
          <td>${escHtml(e.code || '')}</td>
          <td>${escHtml(e.fullName || '')}</td>
          <td>${escHtml(e.branch || '')}</td>
          <td>${escHtml(e.level || '')}</td>
          <td>${faceBadge}</td>
          <td>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button class="btn btn-primary btn-small" onclick="openFaceEnroll('${escHtml(e.id || '')}')">üì∏ ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
              <button class="btn btn-secondary btn-small" onclick="editEmployee('${escHtml(e.id || '')}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger btn-small" onclick="deleteEmployeeConfirm('${escHtml(e.id || '')}')">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');

    // mobile cards
    if(mobileList){
      mobileList.innerHTML = list.map(e => {
        const faceOk = hasFace(e);
        const faceBadge = faceOk
          ? `<span class="emp-face-badge">‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`
          : `<span class="emp-face-badge off">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`;

        return `
          <div class="item">
            <div class="item-top">
              <div style="min-width:0;">
                <div class="item-title">${escHtml(e.fullName || '-')}</div>
                <div class="item-meta">
                  <span class="pill-small">‡πÅ‡∏ú‡∏ô‡∏Å: ${escHtml(e.branch || '-')}</span>
                  <span class="pill-small">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escHtml(e.level || '-')}</span>
                  ${faceBadge}
                </div>
              </div>
              <div class="code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(e.code || '-')}</div>
            </div>

            <div class="item-actions">
              <button class="btn btn-secondary" onclick="editEmployee('${escHtml(e.id || '')}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger" onclick="deleteEmployeeConfirm('${escHtml(e.id || '')}')">üóëÔ∏è ‡∏•‡∏ö</button>
              <button class="btn btn-primary btn-span-2" onclick="openFaceEnroll('${escHtml(e.id || '')}')">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</button>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  // ====== employee modal ======
  function openModal(id){
    const el = $(id);
    if(!el) return;
    el.style.display = 'flex';
    el.setAttribute('aria-hidden','false');
  }
  function closeModal(id){
    const el = $(id);
    if(!el) return;
    el.style.display = 'none';
    el.setAttribute('aria-hidden','true');
  }

  function resetEmpForm(keepMsg){
    editingEmpId = null;
    $('empModalTitle').textContent = 'üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    $('empModalSub').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ)';
    $('empCode').value = '';
    $('empFullName').value = '';
    $('empEmail').value = '';
    if($('empBranch').options.length) $('empBranch').selectedIndex = 0;
    if($('empLevel').options.length) $('empLevel').selectedIndex = 0;

    $('empFormError').style.display = 'none';
    if(!keepMsg) $('empFormSuccess').style.display = 'none';
  }

  function openEmpAdd(){
    resetEmpForm(false);
    openModal('empModalBackdrop');
  }

  window.editEmployee = function(id){
    const emp = employees.find(e => String(e.id) === String(id));
    if(!emp) return;

    editingEmpId = emp.id;
    $('empModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    $('empModalSub').textContent = `‡∏£‡∏´‡∏±‡∏™ ${emp.code || '-'} ‚Ä¢ ${emp.fullName || '-'}`;

    $('empCode').value = emp.code || '';
    $('empFullName').value = emp.fullName || '';
    $('empEmail').value = emp.email || '';
    $('empBranch').value = emp.branch || '';
    $('empLevel').value = emp.level || '';

    $('empFormError').style.display = 'none';
    $('empFormSuccess').style.display = 'none';
    openModal('empModalBackdrop');
  };

  async function saveEmployee(){
    const code = ($('empCode').value || '').trim();
    const fullName = ($('empFullName').value || '').trim();
    const branch = ($('empBranch').value || '').trim();
    const level  = ($('empLevel').value || '').trim();
    const email  = ($('empEmail').value || '').trim();

    const errEl = $('empFormError');
    const sucEl = $('empFormSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';

    if(!code || !fullName){
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
      errEl.style.display = 'block';
      return;
    }

    try{
      // ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ photoBase64 ‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏´‡πâ UI ‡πÇ‡∏•‡πà‡∏á) ‚Äî ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö GS ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ
      await api.call('saveEmployee', {
        id: editingEmpId || '',
        code, fullName, branch, level, email,
        photoBase64: '' // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ GS ‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏£‡∏±‡∏ö param ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà
      });

      employees = await api.call('getEmployees');
      renderEmployeesTable();

      sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';

      // close modal ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ user ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πá‡πÑ‡∏î‡πâ)
      setTimeout(() => {
        closeModal('empModalBackdrop');
        resetEmpForm(false);
      }, 250);
    }catch(err){
      errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  window.deleteEmployeeConfirm = async function(id){
    const emp = employees.find(e => String(e.id) === String(id));
    if(!emp) return;
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ ${emp.code || ''} (${emp.fullName || ''}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    try{
      await api.call('deleteEmployee', { id });
      employees = await api.call('getEmployees');
      renderEmployeesTable();
      alert('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(err){
      alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  };

  // ====== Dashboard render ======
  function renderDashboard(todaySummary, monthSummary){
    $('statTotalEmployees').textContent = employees.length.toString();

    const todayRows = todaySummary || [];
    const loggedRows = todayRows.filter(hasAnyLogRow);
    $('statTodayCount').textContent = loggedRows.length.toString();

    let lateCount = 0;
    loggedRows.forEach(r => {
      const st = String(r.status || '');
      if(st.includes('‡∏™‡∏≤‡∏¢') || st.includes('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏ß') || st.includes('‡∏≠‡∏≠‡∏Å‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏ß')) lateCount++;
    });
    $('statTodayLate').textContent = `‡∏™‡∏≤‡∏¢ ${lateCount} ‡∏Ñ‡∏ô`;

    const rows = (monthSummary && monthSummary.rows) || [];
    let normal=0, late=0, absent=0;
    rows.forEach(r => {
      normal += Number(r.normalCount || 0);
      late   += Number(r.lateCount || 0);
      absent += Number(r.absentCount || 0);
    });
    $('statMonthOverview').textContent = `${normal} ‡∏õ‡∏Å‡∏ï‡∏¥ / ${late} ‡∏™‡∏≤‡∏¢ / ${absent} ‡∏Ç‡∏≤‡∏î`;

    const tbody = $('dashboardTodayBody');
    if(!todayRows.length){
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
    }else{
      tbody.innerHTML = todayRows.map(r => {
        const p = calcPenaltyFromStatus(r.status || '');
        const pHtml = (p.kind === 'unknown')
          ? '<span class="badge-status badge-unknown">UNKNOWN</span>'
          : `<span class="badge-pill">${escHtml(minutesToThai(p.minutes || 0))}</span>`;

        return `
          <tr>
            <td>${escHtml(r.code || '')}</td>
            <td>${escHtml(r.fullName || '')}</td>
            <td>${escHtml((isRealTime(r.t1) ? r.t1 : '-') || '-')}</td>
            <td>${escHtml((isRealTime(r.t2) ? r.t2 : '-') || '-')}</td>
            <td>${escHtml((isRealTime(r.t3) ? r.t3 : '-') || '-')}</td>
            <td>${escHtml((isRealTime(r.t4) ? r.t4 : '-') || '-')}</td>
            <td>${pHtml}</td>
            <td>${statusBadgeHtml(r.status || '')}</td>
          </tr>
        `;
      }).join('');
    }

    const locBox = $('dashboardLocationSummary');
    if(locBox){
      const locMap = {};
      loggedRows.forEach(r => {
        const loc = r.locationText || r.location || '';
        if(!loc) return;
        locMap[loc] = (locMap[loc] || 0) + 1;
      });
      const entries = Object.entries(locMap);
      locBox.innerHTML = entries.length
        ? entries.map(([name,count]) => `<span class="tag">${escHtml(name)} ‚Äì ${escHtml(count)} ‡∏Ñ‡∏ô</span>`).join(' ')
        : '<span class="helper">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
    }
  }

  // ====== Logs/Summary select ======
  function fillYearMonthSelect(yearSel, monthSel){
    const now = new Date();
    const curYear = now.getFullYear();
    const years = [curYear-1, curYear, curYear+1];

    yearSel.innerHTML = years.map(y => {
      const be = y + 543;
      const sel = (y === curYear) ? 'selected' : '';
      return `<option value="${y}" ${sel}>${be}</option>`;
    }).join('');

    const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    monthSel.innerHTML = monthNames.map((m,i) => {
      const sel = (i === now.getMonth()) ? 'selected' : '';
      return `<option value="${i+1}" ${sel}>${m}</option>`;
    }).join('');
  }

  // ====== Logs render ======
  function renderLogsTable(res){
    const rows = (res && res.rows) || [];
    lastLogsRows = rows;

    const tb = $('logsTableBody');
    const mobileList = $('logsMobileList');

    if(!rows.length){
      tb.innerHTML = '<tr><td colspan="11" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      return;
    }

    tb.innerHTML = rows.map((r, idx) => {
      const total = calcTotalHours(r.t1, r.t4);
      const locText = r.locationText || r.location || '';
      const locCell = locText ? `<span class="pill-small">${escHtml(locText)}</span>` : '-';
      const evidence = r.evidenceUrl ? `<a href="${escHtml(r.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-';

      return `
        <tr>
          <td>${escHtml(formatDateThai(r.date))}</td>
          <td>${escHtml(r.code || '')}</td>
          <td>${escHtml(r.fullName || '')}</td>
          <td>${escHtml(r.t1 || '-')}</td>
          <td>${escHtml(r.t4 || '-')}</td>
          <td>${escHtml(total)}</td>
          <td>${penaltyHtmlFromRow(r)}</td>
          <td>${statusBadgeHtml(r.status || '')}</td>
          <td>${locCell}</td>
          <td>${evidence}</td>
          <td><button class="btn btn-secondary btn-small" onclick="openLogDetail(${idx})">‡∏î‡∏π</button></td>
        </tr>
      `;
    }).join('');

    if(mobileList){
      mobileList.innerHTML = rows.map((r, idx) => {
        const d = formatDateThai(r.date);
        const total = calcTotalHours(r.t1, r.t4);
        const loc = r.locationText || r.location || '-';
        const evidence = r.evidenceUrl ? `<a href="${escHtml(r.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</a>` : '-';

        const p = calcPenaltyFromStatus(r.status || '');
        const pText = (p.kind === 'unknown') ? 'UNKNOWN' : minutesToThai(p.minutes || 0);

        return `
          <div class="item">
            <div class="item-top">
              <div style="min-width:0;">
                <div class="item-title">${escHtml(r.fullName || '-')}</div>
                <div class="item-meta">
                  <span class="pill-small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${escHtml(d)}</span>
                  <span class="pill-small">${escHtml(loc)}</span>
                </div>
              </div>
              <div class="code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(r.code || '-')}</div>
            </div>

            <div class="kv">
              <div class="k">‡πÄ‡∏Ç‡πâ‡∏≤</div><div class="v">${escHtml(r.t1 || '-')}</div>
              <div class="k">‡∏≠‡∏≠‡∏Å</div><div class="v">${escHtml(r.t4 || '-')}</div>
              <div class="k">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</div><div class="v">${escHtml(total)}</div>
              <div class="k">‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="v">${escHtml(pText)}</div>
              <div class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="v">${escHtml(r.status || '-')}</div>
              <div class="k">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</div><div class="v">${evidence}</div>
            </div>

            <div class="item-actions">
              <button class="btn btn-secondary" onclick="openLogDetail(${idx})">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              <button class="btn btn-primary" onclick="copyLogQuick(${idx})">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ</button>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  async function reloadLogs(){
    const year  = $('logYearFilter').value;
    const month = $('logMonthFilter').value;
    const branch = $('logBranchFilter').value || 'ALL';
    const search = ($('logSearch').value || '').trim();

    try{
      const res = await api.call('getLogsRange', { year, month, branch, search });
      renderLogsTable(res);
      loaded.logs = true;
    }catch(err){
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  // ====== Summary render ======
  function renderSummaryTable(res){
    const rows = (res && res.rows) || [];
    const tb = $('summaryTableBody');
    const mobileList = $('summaryMobileList');

    if(!rows.length){
      tb.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      return;
    }

    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${escHtml(r.code || '')}</td>
        <td>${escHtml(r.fullName || '')}</td>
        <td>${escHtml(r.branch || '')}</td>
        <td>${escHtml(r.level || '')}</td>
        <td>${escHtml(r.days || 0)}</td>
        <td>${escHtml(r.normalCount || 0)}</td>
        <td>${escHtml(r.lateCount || 0)}</td>
        <td>${escHtml(r.absentCount || 0)}</td>
      </tr>
    `).join('');

    if(mobileList){
      mobileList.innerHTML = rows.map(r => `
        <div class="item">
          <div class="item-top">
            <div style="min-width:0;">
              <div class="item-title">${escHtml(r.fullName || '-')}</div>
              <div class="item-meta">
                <span class="pill-small">‡πÅ‡∏ú‡∏ô‡∏Å: ${escHtml(r.branch || '-')}</span>
                <span class="pill-small">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escHtml(r.level || '-')}</span>
              </div>
            </div>
            <div class="code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(r.code || '-')}</div>
          </div>

          <div class="kv">
            <div class="k">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</div><div class="v">${escHtml(r.days || 0)}</div>
            <div class="k">‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="v">${escHtml(r.normalCount || 0)}</div>
            <div class="k">‡∏™‡∏≤‡∏¢</div><div class="v">${escHtml(r.lateCount || 0)}</div>
            <div class="k">‡∏Ç‡∏≤‡∏î</div><div class="v">${escHtml(r.absentCount || 0)}</div>
          </div>
        </div>
      `).join('');
    }
  }

  async function reloadSummary(){
    const year  = $('sumYearFilter').value;
    const month = $('sumMonthFilter').value;
    const branch = $('sumBranchFilter').value || 'ALL';
    try{
      const res = await api.call('getSummaryRange', { year, month, branch });
      renderSummaryTable(res);
      loaded.summary = true;
    }catch(err){
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  // ====== Settings render/add/delete ======
  function renderBranchesLevelsTables(){
    const bt = $('branchTableBody');
    const lt = $('levelTableBody');

    bt.innerHTML = branches.length
      ? branches.map(b => `
          <tr>
            <td>${escHtml(b.name)}</td>
            <td class="text-right"><button class="btn btn-danger btn-small" onclick="deleteBranch('${escHtml(b.name)}')">‡∏•‡∏ö</button></td>
          </tr>
        `).join('')
      : '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å</td></tr>';

    lt.innerHTML = levels.length
      ? levels.map(l => `
          <tr>
            <td>${escHtml(l.name)}</td>
            <td class="text-right"><button class="btn btn-danger btn-small" onclick="deleteLevel('${escHtml(l.name)}')">‡∏•‡∏ö</button></td>
          </tr>
        `).join('')
      : '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>';
  }

  window.deleteBranch = async function(name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteBranch', { name });
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      $('settingsSuccess').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('settingsSuccess').style.display = 'block';
      $('settingsError').style.display = 'none';
    }catch(err){
      $('settingsError').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('settingsError').style.display = 'block';
      $('settingsSuccess').style.display = 'none';
    }
  };

  window.deleteLevel = async function(name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteLevel', { name });
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      $('settingsSuccess').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('settingsSuccess').style.display = 'block';
      $('settingsError').style.display = 'none';
    }catch(err){
      $('settingsError').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('settingsError').style.display = 'block';
      $('settingsSuccess').style.display = 'none';
    }
  };

  async function addBranch(){
    const name = ($('branchName').value || '').trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if(!name){
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å';
      errEl.style.display = 'block';
      return;
    }
    try{
      await api.call('saveBranch', { name });
      $('branchName').value = '';
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    }catch(err){
      errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  async function addLevel(){
    const name = ($('levelName').value || '').trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if(!name){
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö';
      errEl.style.display = 'block';
      return;
    }
    try{
      await api.call('saveLevel', { name });
      $('levelName').value = '';
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    }catch(err){
      errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  // ====== cache helpers ======
  function cacheSet(key, obj){
    try{ sessionStorage.setItem(key, JSON.stringify({ t:Date.now(), v:obj })); }catch{}
  }
  function cacheGet(key){
    try{
      const raw = sessionStorage.getItem(key);
      if(!raw) return null;
      const o = JSON.parse(raw);
      if(!o || !o.t) return null;
      if(Date.now() - o.t > HARD.CACHE_TTL_MS) return null;
      return o.v;
    }catch{ return null; }
  }

  // ====== Face enroll ======
  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function compressImageToJpegBase64(file, maxEdge, quality, maxBytes){
    const dataUrl = await fileToBase64(file);
    const img = new Image();
    img.src = dataUrl;
    await new Promise((resolve,reject)=>{ img.onload=resolve; img.onerror=reject; });

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;

    let nw=w, nh=h;
    if(Math.max(w,h) > maxEdge){
      const scale = maxEdge / Math.max(w,h);
      nw = Math.round(w*scale);
      nh = Math.round(h*scale);
    }

    const canvas = document.createElement('canvas');
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, nw, nh);

    let out = canvas.toDataURL('image/jpeg', quality);
    if(out.length > maxBytes * 1.37) out = canvas.toDataURL('image/jpeg', Math.max(0.70, quality - 0.08));
    if(out.length > maxBytes * 1.37) out = canvas.toDataURL('image/jpeg', Math.max(0.62, quality - 0.18));
    return out;
  }

  window.openFaceEnroll = function(empId){
    const emp = employees.find(e => String(e.id) === String(empId));
    if(!emp) return;

    faceTargetEmp = { id: emp.id, code: emp.code, fullName: emp.fullName };
    faceBase64 = '';

    $('faceModalSub').innerHTML = `‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <b>${escHtml(emp.fullName || '-')}</b> ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™ <b>${escHtml(emp.code || '-')}</b>`;
    $('faceError').style.display = 'none';
    $('faceSuccess').style.display = 'none';
    $('faceStatusText').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
    $('facePreviewImg').src = '';
    $('facePreviewImg').style.display = 'none';
    $('facePhotoInput').value = '';
    $('btnFaceUpload').disabled = false;

    openModal('faceModalBackdrop');
  };

  async function handleFaceFileSelected(){
    const file = $('facePhotoInput').files && $('facePhotoInput').files[0];
    $('faceError').style.display = 'none';
    $('faceSuccess').style.display = 'none';

    if(!file){
      faceBase64 = '';
      $('faceStatusText').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
      $('facePreviewImg').src = '';
      $('facePreviewImg').style.display = 'none';
      return;
    }

    try{
      $('faceStatusText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ...';
      const b64 = await compressImageToJpegBase64(file, HARD.FACE_IMAGE_MAX_EDGE, HARD.FACE_IMAGE_QUALITY, HARD.FACE_MAX_BYTES);
      faceBase64 = b64;

      $('facePreviewImg').src = b64;
      $('facePreviewImg').style.display = 'block';
      const kb = Math.round((b64.length * 3) / 4 / 1024);
      $('faceStatusText').textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${kb} KB)`;
    }catch(err){
      console.error(err);
      faceBase64 = '';
      $('faceStatusText').textContent = '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('faceError').textContent = '‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('faceError').style.display = 'block';
    }
  }

  async function uploadEmployeeFace(){
    const errEl = $('faceError');
    const sucEl = $('faceSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';

    if(!faceTargetEmp) return;
    if(!faceBase64){
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô';
      errEl.style.display = 'block';
      return;
    }

    $('btnFaceUpload').disabled = true;
    $('faceStatusText').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

    try{
      await api.call('uploadEmployeeFace', {
        id: faceTargetEmp.id || '',
        code: faceTargetEmp.code || '',
        photoBase64: faceBase64
      });

      sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ';
      sucEl.style.display = 'block';
      $('faceStatusText').textContent = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';

      employees = await api.call('getEmployees');
      renderEmployeesTable();
    }catch(err){
      errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
      $('faceStatusText').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }finally{
      $('btnFaceUpload').disabled = false;
    }
  }

  function clearFaceModal(){
    faceBase64 = '';
    $('facePhotoInput').value = '';
    $('facePreviewImg').src = '';
    $('facePreviewImg').style.display = 'none';
    $('faceStatusText').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ';
    $('faceError').style.display = 'none';
    $('faceSuccess').style.display = 'none';
  }

  // ====== Log detail modal ======
  window.openLogDetail = function(index){
    const r = lastLogsRows && lastLogsRows[index];
    if(!r) return;
    logModalRow = r;

    const d = formatDateThai(r.date);
    $('logModalSub').innerHTML = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <b>${escHtml(d)}</b> ‚Ä¢ ‡∏£‡∏´‡∏±‡∏™ <b>${escHtml(r.code || '-')}</b> ‚Ä¢ <b>${escHtml(r.fullName || '-')}</b>`;

    const penalty = calcPenaltyFromStatus(r.status || '');
    const penaltyText = (penalty.kind === 'unknown') ? 'UNKNOWN' : minutesToThai(penalty.minutes || 0);

    const keyLines = [
      `t1=${r.t1 || '-'}`,
      `t2=${r.t2 || '-'}`,
      `t3=${r.t3 || '-'}`,
      `t4=${r.t4 || '-'}`,
      `‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥=${penaltyText}`,
      `status=${r.status || '-'}`,
      `method=${r.method || '-'}`,
      `rawType=${r.rawType || '-'}`,
      `note=${r.note || '-'}`,
      `locationText=${r.locationText || '-'}`,
      `zone=${r.locationZone || r.zone || '-'}`,
    ];
    $('logKeyText').textContent = keyLines.join(' | ');
    $('logRawText').textContent = JSON.stringify(r, null, 2);

    const evidenceUrl = r.evidenceUrl || '';
    const img = $('logEvidenceImg');
    const btnOpen = $('btnOpenEvidence');

    if(evidenceUrl){
      img.src = evidenceUrl;
      img.style.display = 'block';
      btnOpen.disabled = false;
      btnOpen.onclick = () => window.open(evidenceUrl, '_blank', 'noopener');
    }else{
      img.src = '';
      img.style.display = 'none';
      btnOpen.disabled = true;
      btnOpen.onclick = null;
    }

    const note = String(r.note || '');
    const hint = [];
    if(note.toUpperCase() === 'UNKNOWN' || note.toUpperCase() === 'UNKNOW') hint.push('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: UNKNOWN ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ ‚Äú‡∏õ‡∏Å‡∏ï‡∏¥‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà error)');
    if(String(r.method || '').includes('MANUAL')) hint.push('‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö MANUAL');
    $('logModalHint').textContent = hint.join(' ‚Ä¢ ');

    openModal('logModalBackdrop');
  };

  async function copyTextToClipboard(text){
    return navigator.clipboard.writeText(text).catch(()=>{ prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ:', text); });
  }

  window.copyLogQuick = async function(index){
    const r = lastLogsRows && lastLogsRows[index];
    if(!r) return;
    const d = formatDateThai(r.date);
    const p = calcPenaltyFromStatus(r.status || '');
    const pText = (p.kind === 'unknown') ? 'UNKNOWN' : minutesToThai(p.minutes || 0);

    const txt = [
      `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${d}`,
      `‡∏£‡∏´‡∏±‡∏™: ${r.code || '-'}`,
      `‡∏ä‡∏∑‡πà‡∏≠: ${r.fullName || '-'}`,
      `‡πÄ‡∏Ç‡πâ‡∏≤: ${r.t1 || '-'}`,
      `‡∏≠‡∏≠‡∏Å: ${r.t4 || '-'}`,
      `‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥: ${pText}`,
      `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${r.status || '-'}`,
    ].join('\n');

    await copyTextToClipboard(txt);
    alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
  };

  // ====== init ======
  async function initAdmin(){
    const apiUrl = getApiUrl();
    setApiText(apiUrl);

    if(!apiUrl){
      setConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
      return;
    }

    // cache fast paint
    const cEmp = cacheGet('adm_employees');
    const cBL  = cacheGet('adm_branchesLevels');
    const cToday = cacheGet('adm_today');
    const cMonth = cacheGet('adm_month');

    if(cEmp) employees = cEmp;
    if(cBL){ branches=(cBL.branches||[]); levels=(cBL.levels||[]); }

    if(employees.length){
      renderEmployeesTable();
      $('statTotalEmployees').textContent = employees.length.toString();
    }
    if(branches.length){
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
    }
    if(cToday || cMonth){
      renderDashboard(cToday || [], cMonth || { rows:[] });
    }

    try{
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      const [empRes, blRes, todaySummary, monthSummary] = await Promise.all([
        api.call('getEmployees'),
        api.call('getBranchesLevels'),
        api.call('getTodaySummary'),
        api.call('getSummaryRange', { year, month, branch:'ALL' }),
      ]);

      employees = empRes || [];
      branches  = blRes.branches || [];
      levels    = blRes.levels || [];

      cacheSet('adm_employees', employees);
      cacheSet('adm_branchesLevels', { branches, levels });
      cacheSet('adm_today', todaySummary || []);
      cacheSet('adm_month', monthSummary || { rows:[] });

      setConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      renderBranchLevelSelects();
      renderEmployeesTable();
      renderBranchesLevelsTables();
      renderDashboard(todaySummary, monthSummary);

      fillYearMonthSelect($('logYearFilter'), $('logMonthFilter'));
      fillYearMonthSelect($('sumYearFilter'), $('sumMonthFilter'));

      loaded.core = true;
    }catch(err){
      console.error(err);
      setConnectionStatus(false, err.message);
      alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // sidebar click
    document.querySelectorAll('.nav-item').forEach(el => el.addEventListener('click', () => switchSection(el.dataset.section)));
    // bottom nav click
    document.querySelectorAll('.bottom-item').forEach(el => el.addEventListener('click', () => switchSection(el.dataset.section)));

    $('btnBackToFront').addEventListener('click', () => window.location.href = 'index.html');
    $('btnLogout').addEventListener('click', () => {
      if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡∏ö URL API ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        setApiUrl('');
        window.location.href = 'index.html';
      }
    });

    $('btnSetUrl').addEventListener('click', openUrlCard);
    $('btnSaveUrl').addEventListener('click', saveUrl);
    $('btnCancelUrl').addEventListener('click', closeUrlCard);

    $('apiUrlDisplay').addEventListener('click', async () => {
      const full = $('apiUrlDisplay').dataset.full || '';
      if(!full) return;
      try{
        await navigator.clipboard.writeText(full);
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß');
      }catch(e){
        prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ô‡∏µ‡πâ:', full);
      }
    });

    // employees
    $('empSearch').addEventListener('input', renderEmployeesTable);
    $('btnOpenAddEmp').addEventListener('click', openEmpAdd);

    $('btnCloseEmpModal').addEventListener('click', () => closeModal('empModalBackdrop'));
    $('empModalBackdrop').addEventListener('click', (e) => { if(e.target === $('empModalBackdrop')) closeModal('empModalBackdrop'); });
    $('btnResetEmpForm').addEventListener('click', () => resetEmpForm(false));
    $('btnSaveEmployee').addEventListener('click', saveEmployee);

    // logs
    $('btnReloadLogs').addEventListener('click', reloadLogs);
    $('logSearch').addEventListener('keydown', e => { if(e.key === 'Enter') reloadLogs(); });
    $('logBranchFilter').addEventListener('change', reloadLogs);
    $('logMonthFilter').addEventListener('change', reloadLogs);
    $('logYearFilter').addEventListener('change', reloadLogs);

    // summary
    $('btnReloadSummary').addEventListener('click', reloadSummary);
    $('sumBranchFilter').addEventListener('change', reloadSummary);
    $('sumMonthFilter').addEventListener('change', reloadSummary);
    $('sumYearFilter').addEventListener('change', reloadSummary);

    // settings
    $('btnAddBranch').addEventListener('click', addBranch);
    $('btnAddLevel').addEventListener('click', addLevel);

    // face modal
    $('btnCloseFaceModal').addEventListener('click', () => closeModal('faceModalBackdrop'));
    $('faceModalBackdrop').addEventListener('click', (e) => { if(e.target === $('faceModalBackdrop')) closeModal('faceModalBackdrop'); });
    $('facePhotoInput').addEventListener('change', handleFaceFileSelected);
    $('btnFaceUpload').addEventListener('click', uploadEmployeeFace);
    $('btnFaceClear').addEventListener('click', clearFaceModal);

    // log modal
    $('btnCloseLogModal').addEventListener('click', () => closeModal('logModalBackdrop'));
    $('logModalBackdrop').addEventListener('click', (e) => { if(e.target === $('logModalBackdrop')) closeModal('logModalBackdrop'); });
    $('btnCopyLogJson').addEventListener('click', async () => {
      const txt = logModalRow ? JSON.stringify(logModalRow, null, 2) : '';
      await copyTextToClipboard(txt);
      alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÅ‡∏•‡πâ‡∏ß');
    });

    initAdmin();
  });
</script>
</body>
</html>
