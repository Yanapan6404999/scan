<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HR Attendance ‚Ä¢ Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --card:#0b1220;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2a44;
      --white:#ffffff;
      --accent:#22c55e;
      --accent2:#16a34a;
      --blue:#3b82f6;
      --blue2:#2563eb;
      --amber:#f59e0b;
      --red:#ef4444;

      --radius:18px;
      --shadow: 0 20px 50px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Prompt", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -20%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 700px at 120% 10%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 600px at 40% 120%, rgba(245,158,11,.14), transparent 55%),
        linear-gradient(180deg, #071022 0%, #050914 100%);
      color:var(--text);
    }

    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 290px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:18px 14px;
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(8,12,26,.92));
      border-right: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px 14px 10px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(59,130,246,.95), rgba(34,197,94,.8));
      box-shadow: 0 10px 25px rgba(59,130,246,.25);
    }
    .brand h1{margin:0; font-size:16px; font-weight:800; letter-spacing:.2px}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .nav{
      margin-top:8px;
      display:flex; flex-direction:column; gap:6px;
    }
    .nav button{
      width:100%;
      border:1px solid transparent;
      background: transparent;
      color:var(--text);
      text-align:left;
      padding:11px 12px;
      border-radius:14px;
      font-size:14px;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
    }
    .nav button:hover{background: rgba(148,163,184,.08); border-color: rgba(148,163,184,.14)}
    .nav button.active{background: rgba(59,130,246,.16); border-color: rgba(59,130,246,.32)}
    .nav .icon{width:20px; opacity:.9}

    .sidebar .bottom{
      position:absolute;
      left:14px; right:14px; bottom:18px;
      display:flex; flex-direction:column; gap:10px;
    }
    .pill{
      padding:10px 12px;
      border-radius: 16px;
      background: rgba(2,6,23,.45);
      border:1px solid rgba(148,163,184,.14);
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .pill b{color:var(--text); font-weight:700}
    .dangerBtn{
      border:none;
      border-radius: 16px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      background: rgba(239,68,68,.92);
      color:#fff;
      box-shadow: 0 18px 40px rgba(239,68,68,.25);
    }
    .dangerBtn:hover{filter:brightness(1.03)}

    /* Main */
    .main{
      padding:18px 18px 34px 18px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px;
      border-radius: var(--radius);
      background: rgba(15,23,42,.55);
      border:1px solid rgba(148,163,184,.14);
      backdrop-filter: blur(10px);
    }
    .topbar .left{
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .titleRow{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .titleRow h2{
      margin:0;
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:72vw;
    }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.35);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-weight:700;
      cursor:pointer;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      user-select:none;
    }
    .btn:hover{border-color: rgba(148,163,184,.34); background: rgba(2,6,23,.50)}
    .btn.primary{background: rgba(59,130,246,.92); border-color: rgba(59,130,246,.92); color:#fff}
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.good{background: rgba(34,197,94,.90); border-color: rgba(34,197,94,.90); color:#fff}
    .btn.warn{background: rgba(245,158,11,.92); border-color: rgba(245,158,11,.92); color:#111827}
    .btn.bad{background: rgba(239,68,68,.92); border-color: rgba(239,68,68,.92); color:#fff}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: rgba(15,23,42,.48);
      border: 1px solid rgba(148,163,184,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(148,163,184,.12);
    }
    .cardHeader h3{margin:0; font-size:15px; font-weight:800}
    .cardHeader .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .cardBody{padding:14px}
    .row{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap:10px;
      align-items:end;
    }
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .field input, .field select{
      width:100%;
      background: rgba(2,6,23,.35);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
      font-family:inherit;
      font-size:13px;
    }
    .field input:focus, .field select:focus{border-color: rgba(59,130,246,.55); box-shadow: 0 0 0 4px rgba(59,130,246,.12)}
    .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.45}

    /* Table */
    .tableWrap{
      overflow:auto;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.26);
    }
    table{width:100%; border-collapse:separate; border-spacing:0; min-width: 980px}
    thead th{
      position:sticky; top:0;
      background: rgba(8,12,26,.95);
      color: var(--muted);
      font-size:12px;
      text-align:left;
      padding:12px 12px;
      border-bottom: 1px solid rgba(148,163,184,.14);
      z-index:2;
      white-space:nowrap;
    }
    tbody td{
      padding:12px 12px;
      border-bottom: 1px solid rgba(148,163,184,.10);
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover td{background: rgba(148,163,184,.06)}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .bWait{background: rgba(245,158,11,.18); color: #fbbf24; border:1px solid rgba(245,158,11,.28)}
    .bOk{background: rgba(34,197,94,.16); color: #4ade80; border:1px solid rgba(34,197,94,.26)}
    .bNo{background: rgba(239,68,68,.14); color: #fca5a5; border:1px solid rgba(239,68,68,.22)}
    .bInfo{background: rgba(59,130,246,.14); color: #93c5fd; border:1px solid rgba(59,130,246,.22)}
    .miniBtns{display:flex; gap:8px; flex-wrap:wrap}
    .miniBtns .btn{padding:8px 10px; font-size:12px}
    .link{
      color:#93c5fd;
      text-decoration:underline;
      text-underline-offset: 2px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%; transform: translateX(-50%);
      bottom:20px;
      background: rgba(2,6,23,.90);
      border:1px solid rgba(148,163,184,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius: 999px;
      font-size:13px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: 92vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-6px)}
    .toast.good{border-color: rgba(34,197,94,.35)}
    .toast.bad{border-color: rgba(239,68,68,.35)}

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .backdrop.show{display:flex}
    .modal{
      width:min(560px, 100%);
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.16);
      border-radius: 22px;
      box-shadow: 0 28px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(148,163,184,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalHeader h4{margin:0; font-size:15px; font-weight:900}
    .modalBody{padding:14px}
    .modalBody p{margin:0 0 10px 0; color:var(--muted); font-size:13px; line-height:1.5}
    .modalFooter{
      padding:14px;
      border-top:1px solid rgba(148,163,184,.12);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{
        position:fixed; inset:auto 0 0 0; height:auto;
        z-index:40;
        border-right:none; border-top:1px solid rgba(148,163,184,.14);
        padding:10px 10px 14px 10px;
      }
      .brand{display:none}
      .nav{
        flex-direction:row;
        justify-content:space-between;
        gap:8px;
        margin:0;
      }
      .nav button{
        flex:1;
        justify-content:center;
        text-align:center;
        padding:10px 10px;
        border-radius: 16px;
      }
      .sidebar .bottom{display:none}
      .main{padding:16px 12px 120px 12px}
      .meta{max-width: 90vw}
      .row{grid-template-columns: 1fr 1fr; align-items:stretch}
      .row .field:nth-child(5){grid-column: 1 / -1}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h1>
          <p>HR Attendance Panel</p>
        </div>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="dash">
          <span class="icon">üìä</span> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
        </button>
        <button data-view="leave">
          <span class="icon">üìù</span> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤
        </button>
        <button data-view="settings">
          <span class="icon">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </button>
      </div>

      <div class="bottom">
        <div class="pill">
          <div><b>API</b>: <span id="apiMini">-</span></div>
          <div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</b>: <span id="miniStatus">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></div>
          <div><b>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</b>: <span id="miniUpdated">-</span></div>
        </div>
        <button class="dangerBtn" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="left">
          <div class="titleRow">
            <h2 id="pageTitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
            <span class="badge bInfo" id="liveBadge">Live</span>
          </div>
          <div class="meta" id="metaLine">Admin Panel ‚Ä¢ API: <span id="apiText">-</span></div>
        </div>
        <div class="actions">
          <button class="btn" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
          <button class="btn good" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <a class="btn primary" id="btnOpenLeave" href="leave.html" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î leave.html</a>
        </div>
      </div>

      <div class="grid">
        <!-- Dashboard -->
        <section class="card" id="view-dash">
          <div class="cardHeader">
            <div>
              <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏ö‡∏ö</h3>
              <div class="sub">‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÑ‡∏°‡πà‡∏ß‡∏ô‡∏¢‡∏¥‡∏á‡∏ñ‡∏µ‡πà)</div>
            </div>
            <div class="miniBtns">
              <button class="btn" id="btnPing">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="row" style="grid-template-columns: 1fr 1fr 1fr;">
              <div class="card" style="box-shadow:none; background: rgba(2,6,23,.22); border-color: rgba(148,163,184,.12);">
                <div class="cardBody">
                  <div style="font-size:12px; color:var(--muted)">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ API</div>
                  <div style="font-size:20px; font-weight:900; margin-top:6px" id="dashApiStatus">-</div>
                </div>
              </div>
              <div class="card" style="box-shadow:none; background: rgba(2,6,23,.22); border-color: rgba(148,163,184,.12);">
                <div class="cardBody">
                  <div style="font-size:12px; color:var(--muted)">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                  <div style="font-size:20px; font-weight:900; margin-top:6px" id="dashPending">-</div>
                </div>
              </div>
              <div class="card" style="box-shadow:none; background: rgba(2,6,23,.22); border-color: rgba(148,163,184,.12);">
                <div class="cardBody">
                  <div style="font-size:12px; color:var(--muted)">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
                  <div style="font-size:20px; font-weight:900; margin-top:6px" id="dashUpdated">-</div>
                </div>
              </div>
            </div>

            <div class="hint" id="dashHint">
              ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‚Äú‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤ action‚Äù ‚Äî ‡πÉ‡∏ä‡πâ action ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡πà‡∏á GS ‡∏ô‡∏¥‡∏¢‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏° Leave:
              <b>leave_getInitialData</b>, <b>leave_getAdminQueue</b>, <b>leave_approveRequest</b>, <b>leave_rejectRequest</b>, <b>leave_getHistoryRange</b>.
              <br>‡∏ñ‡πâ‡∏≤ API URL ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏î‡∏π ‚Äú‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‚Äù ‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚Üí ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö
            </div>
          </div>
        </section>

        <!-- Leave -->
        <section class="card" id="view-leave" style="display:none;">
          <div class="cardHeader">
            <div>
              <h3>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
              <div class="sub">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
            </div>
            <div class="miniBtns">
              <button class="btn good" id="btnLoadQueue">‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="btn" id="btnLoadHistory">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
          </div>

          <div class="cardBody">
            <div class="row" style="grid-template-columns: 2fr 1fr 1fr 1fr auto;">
              <div class="field">
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)</label>
                <input id="qSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011, ‡∏™‡∏°‡∏ä‡∏≤‡∏¢, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" />
              </div>
              <div class="field">
                <label>‡∏™‡∏≤‡∏Ç‡∏≤</label>
                <select id="qBranch">
                  <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                </select>
              </div>
              <div class="field">
                <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                <select id="qMonth"></select>
              </div>
              <div class="field">
                <label>‡∏õ‡∏µ (‡∏û.‡∏®.)</label>
                <input id="qYear" inputmode="numeric" placeholder="2568" />
              </div>
              <div class="field" style="display:flex; gap:10px; justify-content:flex-end; align-items:end;">
                <button class="btn primary" id="btnApplyFilter">‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              </div>
            </div>

            <div class="hint">
              ‚Ä¢ ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å <b>leave_getAdminQueue</b> (‡πÑ‡∏°‡πà‡πÄ‡∏î‡∏≤ action)<br>
              ‚Ä¢ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‚Äù (‡πÉ‡∏ä‡πâ <b>leave_getHistoryRange</b>)
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 12px 0 10px;">
              <button class="btn" data-status="pending" id="tabPending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
              <button class="btn" data-status="approved" id="tabApproved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="btn" data-status="rejected" id="tabRejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="btn" data-status="all" id="tabAll">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              <span class="badge bInfo" id="leaveCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô</th>
                    <th>‡∏£‡∏´‡∏±‡∏™</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</th>
                    <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                    <th>‡πÑ‡∏ü‡∏•‡πå</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="leaveTbody">
                  <tr><td colspan="9" style="color:var(--muted);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>

            <details style="margin-top:12px;">
              <summary style="cursor:pointer; color:var(--muted); font-weight:800">Advanced: ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</summary>
              <div style="margin-top:10px" class="row">
                <div class="field">
                  <label>‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà (YYYY-MM-DD)</label>
                  <input id="hFrom" placeholder="2025-12-01" />
                </div>
                <div class="field">
                  <label>‡∏ñ‡∏∂‡∏á (YYYY-MM-DD)</label>
                  <input id="hTo" placeholder="2025-12-31" />
                </div>
                <div class="field" style="grid-column: 1 / -1;">
                  <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏ö‡πÑ‡∏õ‡∏Å‡∏±‡∏ö approve/reject)</label>
                  <input id="adminNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ / ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏Ø‡∏•‡∏Ø" />
                </div>
              </div>
            </details>
          </div>
        </section>

        <!-- Settings -->
        <section class="card" id="view-settings" style="display:none;">
          <div class="cardHeader">
            <div>
              <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ & ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö</h3>
              <div class="sub">‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ / ‡∏î‡∏π error ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å API</div>
            </div>
            <div class="miniBtns">
              <button class="btn" id="btnClearCache">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="row" style="grid-template-columns: 2fr 1fr;">
              <div class="field">
                <label>API URL (script.google.com/macros/.../exec)</label>
                <input id="apiInput" placeholder="‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏•‡πâ‡∏ß" />
              </div>
              <div class="field" style="display:flex; gap:10px; align-items:end; justify-content:flex-end;">
                <button class="btn primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
            </div>

            <div class="hint">
              Key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: <b>attendance_api_url_v2</b> (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ index/leave)
            </div>

            <div class="card" style="margin-top:12px; box-shadow:none; background: rgba(2,6,23,.22); border-color: rgba(148,163,184,.12);">
              <div class="cardBody">
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                  <span class="badge bInfo">Actions ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                  <code style="color:#93c5fd; font-size:12px; white-space:nowrap; overflow:auto; max-width:100%">
                    leave_getInitialData ‚Ä¢ leave_getAdminQueue ‚Ä¢ leave_approveRequest ‚Ä¢ leave_rejectRequest ‚Ä¢ leave_getHistoryRange
                  </code>
                </div>
                <div style="margin-top:10px; font-size:12px; color:var(--muted); line-height:1.55" id="sysLog">
                  ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Modal: API URL -->
  <div class="backdrop" id="modalUrl">
    <div class="modal">
      <div class="modalHeader">
        <h4>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL</h4>
        <button class="btn" id="btnCloseUrl">‡∏õ‡∏¥‡∏î</button>
      </div>
      <div class="modalBody">
        <p>‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà ‚ÄúDeploy > Web app‚Äù ‡πÅ‡∏•‡πâ‡∏ß</p>
        <div class="field">
          <label>API URL</label>
          <input id="modalApiInput" placeholder="https://script.google.com/macros/s/XXXX/exec" />
        </div>
        <div class="hint">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
      </div>
      <div class="modalFooter">
        <button class="btn primary" id="btnModalSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">-</div>

  <script>
    // =========================
    // Storage & Utils
    // =========================
    const LS_API_KEY = "attendance_api_url_v2";
    const LS_USER_KEY = "attendance_admin_user"; // optional
    const cache = {
      initial: null,
      queueRaw: [],
      filtered: [],
      status: "pending",
      lastUpdated: null,
      branches: [],
    };

    const el = (id) => document.getElementById(id);
    const fmtTime = (d=new Date()) => d.toLocaleString("th-TH", { hour12:false });
    const pad2 = (n) => String(n).padStart(2,"0");

    function toast(msg, type=""){
      const t = el("toast");
      t.textContent = msg;
      t.className = "toast" + (type ? (" " + type) : "");
      requestAnimationFrame(()=> t.classList.add("show"));
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.classList.remove("show"), 2400);
    }

    function setSysLog(html){
      el("sysLog").innerHTML = html;
    }

    function getApiUrl(){
      return (localStorage.getItem(LS_API_KEY) || "").trim();
    }
    function setApiUrl(url){
      localStorage.setItem(LS_API_KEY, (url||"").trim());
      syncApiUI();
    }
    function syncApiUI(){
      const api = getApiUrl();
      el("apiText").textContent = api || "-";
      el("apiMini").textContent = api ? (api.slice(0, 30) + (api.length>30 ? "‚Ä¶" : "")) : "-";
      el("apiInput").value = api || "";
      el("modalApiInput").value = api || "";
    }

    function toBEYear(thYear){
      // ‡∏£‡∏±‡∏ö ‡∏û.‡∏®. -> ‡∏Ñ.‡∏®.
      const y = Number(thYear);
      if(!Number.isFinite(y)) return null;
      return (y > 2400) ? (y - 543) : y;
    }

    function statusBadge(status){
      const s = String(status||"").toLowerCase();
      if(s.includes("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") || s==="approved") return `<span class="badge bOk">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
      if(s.includes("‡πÑ‡∏°‡πà") || s==="rejected") return `<span class="badge bNo">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
      if(s.includes("‡∏£‡∏≠") || s==="pending") return `<span class="badge bWait">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
      return `<span class="badge bInfo">${escapeHtml(status||"-")}</span>`;
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // API Call (NO guessing)
    // =========================
    async function apiCall(action, payload={}){
      const url = getApiUrl();
      if(!url) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL");
      const body = JSON.stringify({ action, ...payload });
      const t0 = performance.now();
      let res, json;

      // Primary: JSON POST
      try{
        res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body,
          mode: "cors",
          credentials: "omit",
          redirect: "follow",
        });
      }catch(e){
        // Fallback: form POST (‡∏ö‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÉ‡∏ä‡πâ doPost(e) parse parameter)
        const form = new URLSearchParams();
        form.set("action", action);
        Object.entries(payload||{}).forEach(([k,v])=>{
          if(v===undefined) return;
          form.set(k, typeof v === "object" ? JSON.stringify(v) : String(v));
        });
        res = await fetch(url, { method:"POST", body: form, mode:"cors", credentials:"omit" });
      }

      const text = await res.text();
      try{ json = JSON.parse(text); }catch(e){
        throw new Error(`API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (${res.status}) :: ${text.slice(0,200)}`);
      }

      const ms = Math.round(performance.now()-t0);
      cache.lastUpdated = new Date();
      el("miniUpdated").textContent = fmtTime(cache.lastUpdated);
      el("dashUpdated").textContent = fmtTime(cache.lastUpdated);

      if(!res.ok){
        throw new Error(json?.error || json?.message || `HTTP ${res.status}`);
      }
      if(json?.ok === false){
        throw new Error(json?.error || json?.message || "‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }

      setSysLog(`‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å <b>${action}</b> ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Ä¢ ${ms}ms ‚Ä¢ ${fmtTime(cache.lastUpdated)}<br><span style="color:var(--muted)">Keys: ${Object.keys(json||{}).join(", ")}</span>`);
      return json;
    }

    // =========================
    // Views
    // =========================
    function setView(view){
      ["dash","leave","settings"].forEach(v=>{
        el("view-"+v).style.display = (v===view) ? "" : "none";
      });
      const titles = { dash:"‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", leave:"‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤", settings:"‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" };
      el("pageTitle").textContent = titles[view] || "Admin";
      document.querySelectorAll("#nav button").forEach(b=>{
        b.classList.toggle("active", b.dataset.view===view);
      });
    }

    // =========================
    // Leave rendering & filtering
    // =========================
    function normalizeReq(r){
      // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà
      const get = (...keys) => {
        for(const k of keys){
          if(r && (k in r) && r[k]!=="" && r[k]!==null && r[k]!==undefined) return r[k];
        }
        return "";
      };
      return {
        requestId: get("requestId","id","reqId"),
        submitAt: get("submitAt","submittedAt","createdAt","timestamp"),
        code: get("code","empCode"),
        fullName: get("fullName","empName","name"),
        branch: get("branch"),
        level: get("level"),
        leaveType: get("leaveTypeId","leaveType","type"),
        startDate: get("startDate","dateFrom"),
        endDate: get("endDate","dateTo"),
        startHalf: get("startHalf","halfFrom","startPart"),
        endHalf: get("endHalf","halfTo","endPart"),
        totalDays: get("totalDays","days","qty"),
        reason: get("reason","note","remark"),
        contact: get("contact"),
        attachmentUrl: get("attachmentUrl","evidenceUrl","fileUrl"),
        status: get("status"),
        adminNote: get("adminNote"),
      };
    }

    function statusToBucket(status){
      const s = String(status||"").toLowerCase();
      if(s.includes("approved") || s.includes("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥") || s==="ok") return "approved";
      if(s.includes("rejected") || s.includes("‡πÑ‡∏°‡πà") || s.includes("deny")) return "rejected";
      if(s.includes("pending") || s.includes("‡∏£‡∏≠") || s==="wait") return "pending";
      return "pending";
    }

    function applyFilter(){
      const q = el("qSearch").value.trim().toLowerCase();
      const b = el("qBranch").value;
      const month = el("qMonth").value; // unused for local filter
      const year = el("qYear").value.trim();
      const st = cache.status;

      let arr = cache.queueRaw.map(normalizeReq);

      if(b){
        arr = arr.filter(x => String(x.branch||"") === b);
      }
      if(q){
        arr = arr.filter(x =>
          String(x.code||"").toLowerCase().includes(q) ||
          String(x.fullName||"").toLowerCase().includes(q) ||
          String(x.reason||"").toLowerCase().includes(q) ||
          String(x.leaveType||"").toLowerCase().includes(q)
        );
      }
      if(st !== "all"){
        arr = arr.filter(x => statusToBucket(x.status) === st);
      }

      cache.filtered = arr;
      renderLeaveTable();
    }

    function renderLeaveTable(){
      const tbody = el("leaveTbody");
      const rows = cache.filtered;

      el("leaveCount").textContent = `${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      el("dashPending").textContent = `${cache.queueRaw.filter(r=>statusToBucket(normalizeReq(r).status)==="pending").length}`;

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="9" style="color:var(--muted);">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r=>{
        const period = [r.startDate, r.endDate].filter(Boolean).join(" ‚Üí ");
        const type = r.leaveType || "-";
        const reason = escapeHtml(r.reason || "-");
        const fileCell = r.attachmentUrl ? `<a class="link" href="${escapeHtml(r.attachmentUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå</a>` : `<span style="color:var(--muted)">-</span>`;
        const st = statusToBucket(r.status);
        const canAct = (st==="pending");
        const btns = canAct ? `
          <div class="miniBtns">
            <button class="btn good" data-act="approve" data-id="${escapeHtml(r.requestId)}">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            <button class="btn bad" data-act="reject" data-id="${escapeHtml(r.requestId)}">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          </div>` : `<span style="color:var(--muted)">-</span>`;
        return `
          <tr>
            <td>${escapeHtml(r.submitAt || "-")}</td>
            <td><b>${escapeHtml(r.code || "-")}</b></td>
            <td>${escapeHtml(r.fullName || "-")}<div style="color:var(--muted); font-size:12px; margin-top:2px">${escapeHtml(r.branch||"")}${r.level?(" ‚Ä¢ "+escapeHtml(r.level)):""}</div></td>
            <td>${escapeHtml(type)}</td>
            <td>${escapeHtml(period)}${r.totalDays?(`<div style="color:var(--muted); font-size:12px; margin-top:2px">‡∏£‡∏ß‡∏° ${escapeHtml(r.totalDays)} ‡∏ß‡∏±‡∏ô</div>`):""}</td>
            <td style="min-width:220px">${reason}</td>
            <td>${fileCell}</td>
            <td>${statusBadge(r.status)}</td>
            <td>${btns}</td>
          </tr>
        `;
      }).join("");
    }

    // =========================
    // Data loaders (NO guessing)
    // =========================
    async function loadInitial(){
      syncApiUI();
      const api = getApiUrl();
      el("dashApiStatus").textContent = api ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠..." : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤";

      if(!api){
        showUrlModal(true);
        return;
      }

      try{
        const json = await apiCall("leave_getInitialData", {});
        cache.initial = json?.data || json;

        // branch list (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
        const branches = (cache.initial?.branches || cache.initial?.data?.branches || cache.initial?.Branchs || cache.initial?.branchList || []);
        cache.branches = Array.isArray(branches) ? branches : [];
        fillBranchOptions(cache.branches);

        el("dashApiStatus").textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
        el("miniStatus").textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß";
        toast("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "good");
      }catch(err){
        el("dashApiStatus").textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        el("miniStatus").textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        setSysLog(`‚ùå <b>leave_getInitialData</b> ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${escapeHtml(err.message)}<br><span style="color:var(--muted)">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ URL ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß /exec ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>`);
        toast(err.message, "bad");
      }
    }

    function fillBranchOptions(branches){
      const sel = el("qBranch");
      const current = sel.value;
      const opts = ['<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>'].concat(
        (branches||[]).map(b=>{
          const name = (typeof b==="string") ? b : (b?.name || b?.branch || "");
          return name ? `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>` : "";
        }).filter(Boolean)
      ).join("");
      sel.innerHTML = opts;
      if(current) sel.value = current;
    }

    async function loadAdminQueue(){
      // ‡πÉ‡∏ä‡πâ month/year ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ù‡∏±‡πà‡∏á GS ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ‡∏Å‡πá‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£)
      const m = Number(el("qMonth").value);
      const thYear = el("qYear").value.trim();
      const yearBE = toBEYear(thYear);
      const payload = {};
      if(Number.isFinite(m)) payload.month = m;
      if(Number.isFinite(yearBE)) payload.year = yearBE;

      try{
        const json = await apiCall("leave_getAdminQueue", payload);
        const arr = json?.data?.requests || json?.requests || json?.data || [];
        cache.queueRaw = Array.isArray(arr) ? arr : [];
        cache.status = "pending";
        setStatusTabs();
        applyFilter();
        toast("‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "good");
      }catch(err){
        setSysLog(`‚ùå <b>leave_getAdminQueue</b> ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${escapeHtml(err.message)}<br><span style="color:var(--muted)">‡∏ñ‡πâ‡∏≤ leave.html ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡πà‡∏≤ URL ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞ action ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô leave_getAdminQueue ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>`);
        toast(err.message, "bad");
      }
    }

    async function loadHistoryRange(){
      const from = el("hFrom").value.trim();
      const to = el("hTo").value.trim();
      if(!from || !to){
        toast("‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà from/to ‡∏Å‡πà‡∏≠‡∏ô", "bad");
        return;
      }
      try{
        const json = await apiCall("leave_getHistoryRange", { from, to });
        const arr = json?.data?.requests || json?.requests || json?.data || [];
        cache.queueRaw = Array.isArray(arr) ? arr : [];
        cache.status = "all";
        setStatusTabs();
        applyFilter();
        toast("‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "good");
      }catch(err){
        setSysLog(`‚ùå <b>leave_getHistoryRange</b> ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${escapeHtml(err.message)}`);
        toast(err.message, "bad");
      }
    }

    async function approveOrReject(act, requestId){
      const note = el("adminNote").value.trim();
      const action = (act==="approve") ? "leave_approveRequest" : "leave_rejectRequest";
      try{
        await apiCall(action, { requestId, adminNote: note });
        // update local
        const idx = cache.queueRaw.findIndex(r => String(normalizeReq(r).requestId) === String(requestId));
        if(idx>-1){
          if(typeof cache.queueRaw[idx] === "object" && cache.queueRaw[idx]){
            cache.queueRaw[idx].status = (act==="approve") ? "APPROVED" : "REJECTED";
            cache.queueRaw[idx].adminNote = note;
          }
        }
        applyFilter();
        toast(act==="approve" ? "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß" : "‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß", "good");
      }catch(err){
        setSysLog(`‚ùå <b>${action}</b> ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ${escapeHtml(err.message)}`);
        toast(err.message, "bad");
      }
    }

    function setStatusTabs(){
      const map = {
        pending: el("tabPending"),
        approved: el("tabApproved"),
        rejected: el("tabRejected"),
        all: el("tabAll")
      };
      Object.entries(map).forEach(([k,btn])=>{
        btn.classList.toggle("primary", cache.status===k);
      });
    }

    // =========================
    // Events
    // =========================
    function showUrlModal(force=false){
      syncApiUI();
      el("modalUrl").classList.add("show");
      if(force){
        // prevent closing by clicking outside? (simple)
      }
      setView("settings");
    }
    function hideUrlModal(){
      el("modalUrl").classList.remove("show");
    }

    function initMonthYear(){
      const mSel = el("qMonth");
      const monthsTH = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
      mSel.innerHTML = monthsTH.map((name,i)=>`<option value="${i+1}">${name}</option>`).join("");
      const now = new Date();
      mSel.value = String(now.getMonth()+1);
      el("qYear").value = String(now.getFullYear()+543);

      // default history range: this month
      const y = now.getFullYear();
      const mm = pad2(now.getMonth()+1);
      el("hFrom").value = `${y}-${mm}-01`;
      el("hTo").value = `${y}-${mm}-${pad2(new Date(y, now.getMonth()+1, 0).getDate())}`;
    }

    function wireNav(){
      el("nav").addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-view]");
        if(!btn) return;
        setView(btn.dataset.view);
      });
    }

    function wireButtons(){
      el("btnSetUrl").addEventListener("click", ()=> showUrlModal(false));
      el("btnCloseUrl").addEventListener("click", hideUrlModal);

      el("btnSaveUrl").addEventListener("click", ()=>{
        const v = el("apiInput").value.trim();
        if(!v){ toast("‡∏Å‡∏£‡∏≠‡∏Å API URL ‡∏Å‡πà‡∏≠‡∏ô", "bad"); return; }
        setApiUrl(v);
        hideUrlModal();
        toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "good");
        loadInitial().then(()=> loadAdminQueue());
      });

      el("btnModalSaveUrl").addEventListener("click", ()=>{
        const v = el("modalApiInput").value.trim();
        if(!v){ toast("‡∏Å‡∏£‡∏≠‡∏Å API URL ‡∏Å‡πà‡∏≠‡∏ô", "bad"); return; }
        setApiUrl(v);
        hideUrlModal();
        toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "good");
        loadInitial().then(()=> loadAdminQueue());
      });

      el("btnRefresh").addEventListener("click", ()=>{
        loadInitial().then(()=> loadAdminQueue());
      });

      el("btnPing").addEventListener("click", async ()=>{
        try{
          await apiCall("leave_getInitialData", {});
          toast("API ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "good");
        }catch(err){
          toast(err.message, "bad");
        }
      });

      el("btnLoadQueue").addEventListener("click", loadAdminQueue);
      el("btnLoadHistory").addEventListener("click", loadHistoryRange);

      el("btnApplyFilter").addEventListener("click", applyFilter);
      el("qSearch").addEventListener("keydown", (e)=>{ if(e.key==="Enter") applyFilter(); });

      // status tabs
      ["tabPending","tabApproved","tabRejected","tabAll"].forEach(id=>{
        el(id).addEventListener("click", ()=>{
          cache.status = el(id).dataset.status;
          setStatusTabs();
          applyFilter();
        });
      });

      // table actions
      el("leaveTbody").addEventListener("click", (e)=>{
        const b = e.target.closest("button[data-act]");
        if(!b) return;
        const act = b.dataset.act;
        const id = b.dataset.id;
        if(!id){ toast("‡πÑ‡∏°‡πà‡∏û‡∏ö requestId", "bad"); return; }
        approveOrReject(act, id);
      });

      el("btnClearCache").addEventListener("click", ()=>{
        cache.initial = null;
        cache.queueRaw = [];
        cache.filtered = [];
        toast("‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏•‡πâ‡∏ß", "good");
        setSysLog("‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà");
      });

      el("btnLogout").addEventListener("click", ()=>{
        // ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏Ñ‡∏∏‡∏ì logout ‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á ‚Äî ‡∏à‡∏∂‡∏á‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏•‡πâ‡∏≤‡∏á user key (‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á API)
        localStorage.removeItem(LS_USER_KEY);
        toast("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)", "good");
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ index:
        try{ window.location.href = "index.html"; }catch(_){}
      });
    }

    // =========================
    // Boot
    // =========================
    (function boot(){
      syncApiUI();
      initMonthYear();
      wireNav();
      wireButtons();
      setView("dash");
      setStatusTabs();

      // Auto-load once (no interval)
      loadInitial().then(()=> loadAdminQueue());

      // small UI info
      el("miniUpdated").textContent = "-";
      el("dashUpdated").textContent = "-";
    })();
  </script>
</body>
</html>
