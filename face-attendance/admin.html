<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />

  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #dbeafe;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #fbbf24;
      --bg: #f3f4f6;
      --text-main: #0f172a;
      --text-soft: #6b7280;
      --border: #e5e7eb;
      --card-bg: #ffffff;
      --sidebar-bg: #020617;
      --sidebar-active: #020617;
    }

    * {
      box-sizing: border-box;
      font-family: "Prompt", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      max-width: 100%;
      /* ‡πÄ‡∏≠‡∏≤ overflow-x:hidden ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏ß‡∏•‡∏≤ table ‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
    }

    body {
      color: var(--text-main);
      background:
        radial-gradient(circle at top left, #e0e7ff 0, transparent 55%),
        radial-gradient(circle at bottom right, #e5f5ff 0, transparent 50%),
        #f3f4f6;
    }

    a {
      color: var(--primary);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    button,
    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease, opacity 0.1s ease;
      white-space: nowrap;
    }

    button:active,
    .btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    button:disabled,
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: white;
      color: #111827;
      border: 1px solid var(--border);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    .btn-ghost {
      border-radius: 999px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-soft);
    }

    /* PAGE LAYOUT --------------------------------------------------- */
    .page {
      display: flex;
      min-height: 100vh;
      width: 100%;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: radial-gradient(circle at top, #111827, #020617);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 16px 14px;
      flex-shrink: 0;
      box-shadow:
        8px 0 30px rgba(15, 23, 42, 0.5),
        0 0 0 1px rgba(15,23,42,0.5);
      position: relative;
      z-index: 30;
    }

    .sidebar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at bottom, rgba(37,99,235,0.2), transparent 60%);
      pointer-events: none;
    }

    .sidebar-header {
      padding: 6px 6px 16px;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .sidebar-title {
      font-weight: 600;
      font-size: 18px;
      margin-bottom: 2px;
    }

    .sidebar-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .nav {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-height: 0;
      position: relative;
      z-index: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 11px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      color: #e5e7eb;
      border: 1px solid transparent;
    }

    .nav-item span.icon {
      width: 22px;
      display: inline-flex;
      justify-content: center;
    }

    .nav-item.active {
      background: rgba(15,23,42,0.95);
      border-color: rgba(59,130,246,0.8);
      box-shadow: 0 8px 16px rgba(15,23,42,0.8);
    }

    .nav-item:hover {
      background: rgba(31,41,55,0.9);
    }

    .sidebar-footer {
      padding-top: 10px;
      border-top: 1px solid rgba(55,65,81,0.9);
      font-size: 11px;
      color: #9ca3af;
      position: relative;
      z-index: 1;
    }

    .sidebar-footer button {
      margin-top: 8px;
      width: 100%;
    }

    /* CONTENT AREA */
    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    header.topbar {
      padding: 10px 18px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(15,23,42,0.5);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(14px);
    }

    .topbar-title {
      font-size: 18px;
      font-weight: 600;
      max-width: 100%;
    }

    .topbar-sub {
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 100%;
    }

    #apiUrlDisplay {
      word-break: break-all;
      overflow-wrap: anywhere;
      max-width: 100%;
      display: inline-block;
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      max-width: 100%;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    main.main {
      padding: 18px 18px 22px;
    }

    .main-inner {
      max-width: 1260px;
      margin: 0 auto;
      width: 100%;
    }

    /* MOBILE NAV ---------------------------------------------------- */
    .mobile-nav {
      display: none;
      background: #020617;
      padding: 7px 10px;
      border-bottom: 1px solid #1f2937;
    }

    .mobile-nav-inner {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .mobile-nav-item {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.8);
      background: #111827;
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .mobile-nav-item.active {
      background: var(--primary);
      border-color: rgba(37,99,235,0.8);
      box-shadow: 0 8px 18px rgba(37,99,235,0.4);
    }

    /* CONNECTION BADGE ---------------------------------------------- */
    .badge-connection {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 118, 110, 0.15);
      color: #a5f3fc;
      border: 1px solid rgba(34,197,94,0.8);
    }

    .badge-connection.offline {
      background: rgba(127, 29, 29, 0.35);
      color: #fecaca;
      border-color: rgba(248,113,113,0.9);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.85);
    }

    .badge-connection.offline .dot {
      background: #f97373;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.8);
    }

    /* CARDS & TABLES ----------------------------------------------- */
    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.08),
        0 0 0 1px rgba(226,232,240,0.9);
      border: 1px solid rgba(226,232,240,0.9);
      margin-bottom: 14px;
      backdrop-filter: blur(10px);
      width: 100%;
      max-width: 100%;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-soft);
      max-width: 100%;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .stat-card {
      padding: 10px 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-soft);
    }

    .stat-value {
      font-size: 20px;
      font-weight: 600;
    }

    .stat-extra {
      font-size: 11px;
      color: var(--text-soft);
    }

    .stat-accent {
      color: #16a34a;
    }

    .stat-danger {
      color: #b91c1c;
    }

    .badge-status {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      display: inline-block;
    }

    .badge-normal {
      background: #dcfce7;
      color: #166534;
    }

    .badge-late {
      background: #fee2e2;
      color: #b91c1c;
    }

    .badge-absent {
      background: #ffe4e6;
      color: #be123c;
    }

    .badge-other {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 7px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: #374151;
      font-size: 12px;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .text-right { text-align: right; }
    .text-center { text-align: center; }

    .scroll-x {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }

    /* KEY: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏™‡∏°‡∏≠ -> ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏ß‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô */
    .scroll-x > table {
      width: 120%;
    }

    .scroll-x::-webkit-scrollbar {
      height: 6px;
    }
    .scroll-x::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filters .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      color: var(--text-soft);
    }

    select,
    input[type="text"],
    input[type="number"] {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
      min-width: 120px;
      background: white;
    }

    input[type="text"]:focus,
    select:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    .input-block {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 9px;
      font-size: 13px;
      outline: none;
      background: white;
    }

    .input-block:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }

    .helper {
      font-size: 11px;
      color: var(--text-soft);
    }

    .mt-8 { margin-top: 8px; }
    .mt-10 { margin-top: 10px; }
    .mt-12 { margin-top: 12px; }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #374151;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .error-text {
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    .success-text {
      font-size: 12px;
      color: #16a34a;
      margin-top: 4px;
    }

    .flex {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .table-actions {
      display: flex;
      gap: 4px;
    }

    .pill-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #4b5563;
    }

    .header-search-box {
      min-width: 220px;
      max-width: 280px;
      width: 100%;
    }

    /* ‡πÉ‡∏´‡πâ‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡∏ß‡πâ‡∏≤‡∏á 100% ‡∏Å‡πá‡∏û‡∏≠ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô */
    @media (min-width: 1024px) {
      .scroll-x > table {
        width: 100%;
      }
    }

    @media (max-width: 640px) {
      .header-search-box {
        min-width: 100%;
        max-width: 100%;
      }
      #empSearch {
        width: 100%;
      }
    }

    /* RESPONSIVE ---------------------------------------------------- */
    @media (max-width: 1000px) {
      .sidebar {
        display: none;
      }
      .page {
        flex-direction: column;
      }
      main.main {
        padding: 14px 12px 18px;
      }
      .mobile-nav {
        display: block;
        position: sticky;
        top: 48px;
        z-index: 15;
      }
    }

    @media (max-width: 800px) {
      .grid-3 {
        grid-template-columns: 1fr;
      }
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      header.topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .topbar-right {
        width: 100%;
        justify-content: space-between;
      }
      .filters .field {
        min-width: 46%;
      }
    }

    /* URL Card ‡∏•‡∏≠‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ---------------------------------------- */
    #urlCard {
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 420px;
      width: calc(100% - 32px);
      z-index: 40;
    }

    @media (max-width: 640px) {
      #urlCard {
        left: 12px;
        right: 12px;
        bottom: 12px;
      }
    }
  </style>
</head>
<body>
<div class="page">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <div class="sidebar-sub">HR Attendance Panel</div>
    </div>

    <nav class="nav">
      <div class="nav-item active" data-section="dashboard">
        <span class="icon">üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span>
      </div>
      <div class="nav-item" data-section="employees">
        <span class="icon">üë•</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
      </div>
      <div class="nav-item" data-section="logs">
        <span class="icon">‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</span>
      </div>
      <div class="nav-item" data-section="summary">
        <span class="icon">üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
      </div>
      <div class="nav-item" data-section="settings">
        <span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏±‡πâ‡∏ô)</span>
      </div>
    </nav>

    <div class="sidebar-footer">
      <div>TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
      <button class="btn btn-ghost" id="btnBackToFront">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn btn-danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="content">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="topbar-sub">
          <span>Admin Panel |</span> <span id="apiUrlDisplay"></span>
        </div>
      </div>
      <div class="topbar-right">
        <div id="connectionBadge" class="badge-connection offline">
          <span class="dot"></span>
          <span id="connectionText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        <button class="btn btn-secondary" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
      </div>
    </header>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
      <div class="mobile-nav-inner">
        <button class="mobile-nav-item active" data-section="dashboard">
          <span>üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span>
        </button>
        <button class="mobile-nav-item" data-section="employees">
          <span>üë•</span><span>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        </button>
        <button class="mobile-nav-item" data-section="logs">
          <span>‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span>
        </button>
        <button class="mobile-nav-item" data-section="summary">
          <span>üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ</span>
        </button>
        <button class="mobile-nav-item" data-section="settings">
          <span>‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
        </button>
      </div>
    </nav>

    <main class="main">
      <div class="main-inner">
        <!-- DASHBOARD (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
        <!-- ... (‡∏™‡πà‡∏ß‡∏ô Dashboard, Logs, Summary, Settings, URL Card, Script ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ... -->
      </div>
    </main>
  </div>
</div>

<!-- *** ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CSS ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ JS ‡πÄ‡∏û‡∏¥‡πà‡∏° *** -->
<script>
  const STORAGE_KEY = 'attendance_api_url_v2';

  function getApiUrl() {
    return localStorage.getItem(STORAGE_KEY) || '';
  }

  function setApiUrl(url) {
    if (!url) localStorage.removeItem(STORAGE_KEY);
    else localStorage.setItem(STORAGE_KEY, url);
  }

  const api = {
    async call(action, params = {}) {
      const apiUrl = getApiUrl();
      if (!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');

      const body = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        console.error('API response is not JSON:', text);
        throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)');
      }
      if (!data.ok) throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      return data.result;
    }
  };

  let employees = [];
  let branches = [];
  let levels = [];

  let editingEmpId = null;

  function $(id) {
    return document.getElementById(id);
  }

  function setConnectionStatus(online, msg) {
    const bdg = $('connectionBadge');
    const txt = $('connectionText');
    if (!bdg || !txt) return;
    if (online) {
      bdg.classList.remove('offline');
      txt.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    } else {
      bdg.classList.add('offline');
      txt.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
    }
  }

  function statusBadgeHtml(status) {
    if (!status) return '<span class="badge-status badge-absent">‡∏Ç‡∏≤‡∏î</span>';
    let cls = 'badge-other';
    if (status === '‡∏õ‡∏Å‡∏ï‡∏¥') cls = 'badge-normal';
    else if (status.includes('‡∏™‡∏≤‡∏¢')) cls = 'badge-late';
    else if (status === '‡∏Ç‡∏≤‡∏î') cls = 'badge-absent';
    return '<span class="badge-status ' + cls + '">' + status + '</span>';
  }

  function timeToMinutes(t) {
    if (!t) return null;
    const parts = String(t).split(':');
    if (parts.length < 2) return null;
    const h = Number(parts[0]), m = Number(parts[1]);
    if (isNaN(h) || isNaN(m)) return null;
    return h * 60 + m;
  }

  function calcTotalHours(t1, t4) {
    const m1 = timeToMinutes(t1);
    const m4 = timeToMinutes(t4);
    if (m1 == null || m4 == null || m4 <= m1) return '-';
    const diff = m4 - m1;
    const hours = Math.floor(diff / 60);
    const mins  = diff % 60;
    return `${hours} ‡∏ä‡∏°. ${mins.toString().padStart(2,'0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }

  function formatDateThai(dateStr) {
    let d;
    if (dateStr instanceof Date) {
      d = dateStr;
    } else {
      const parts = String(dateStr).split('-');
      if (parts.length === 3) {
        d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
      } else {
        return String(dateStr || '');
      }
    }
    const dd = d.getDate().toString().padStart(2,'0');
    const mm = (d.getMonth()+1).toString().padStart(2,'0');
    const yy = d.getFullYear() + 543;
    return `${dd}/${mm}/${yy}`;
  }

  function fillYearMonthSelect(yearSel, monthSel) {
    const now = new Date();
    const curYear = now.getFullYear();
    const years = [curYear-1, curYear, curYear+1];

    yearSel.innerHTML = years.map(y => {
      const be = y + 543;
      const sel = (y === curYear) ? 'selected' : '';
      return `<option value="${y}" ${sel}>${be}</option>`;
    }).join('');

    const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    monthSel.innerHTML = monthNames.map((m,i) => {
      const sel = (i === now.getMonth()) ? 'selected' : '';
      return `<option value="${i+1}" ${sel}>${m}</option>`;
    }).join('');
  }

  function renderDashboard(todaySummary, monthSummary) {
    $('statTotalEmployees').textContent = employees.length.toString();

    const todayRows = todaySummary || [];
    $('statTodayCount').textContent = todayRows.length.toString();

    let lateCount = 0;
    todayRows.forEach(r => {
      const st = String(r.status || '');
      if (st.includes('‡∏™‡∏≤‡∏¢')) lateCount++;
    });
    $('statTodayLate').textContent = `‡∏™‡∏≤‡∏¢ ${lateCount} ‡∏Ñ‡∏ô`;

    const rows = (monthSummary && monthSummary.rows) || [];
    let normal = 0, late = 0, absent = 0;
    rows.forEach(r => {
      normal += Number(r.normalCount || 0);
      late   += Number(r.lateCount || 0);
      absent += Number(r.absentCount || 0);
    });
    $('statMonthOverview').textContent = `${normal} ‡∏õ‡∏Å‡∏ï‡∏¥ / ${late} ‡∏™‡∏≤‡∏¢ / ${absent} ‡∏Ç‡∏≤‡∏î`;

    const tbody = $('dashboardTodayBody');
    if (!todayRows.length) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
    } else {
      tbody.innerHTML = todayRows.map(r => `
        <tr>
          <td>${r.code || ''}</td>
          <td>${r.fullName || ''}</td>
          <td>${r.t1 || ''}</td>
          <td>${r.t2 || ''}</td>
          <td>${r.t3 || ''}</td>
          <td>${r.t4 || ''}</td>
          <td>${r.locationText || r.location || '-'}</td>
          <td>${statusBadgeHtml(r.status || '')}</td>
        </tr>
      `).join('');
    }

    const locBox = $('dashboardLocationSummary');
    if (locBox) {
      const locMap = {};
      todayRows.forEach(r => {
        const loc = r.locationText || r.location || '';
        if (!loc) return;
        locMap[loc] = (locMap[loc] || 0) + 1;
      });
      const entries = Object.entries(locMap);
      if (!entries.length) {
        locBox.innerHTML = '<span class="helper">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
      } else {
        locBox.innerHTML = entries.map(([name,count]) =>
          `<span class="tag">${name} ‚Äì ${count} ‡∏Ñ‡∏ô</span>`
        ).join('');
      }
    }
  }

  function renderBranchLevelSelects() {
    const branchSel = $('empBranch');
    const levelSel  = $('empLevel');
    branchSel.innerHTML = branches.length
      ? branches.map(b => `<option value="${b.name}">${b.name}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å -</option>';
    levelSel.innerHTML = levels.length
      ? levels.map(l => `<option value="${l.name}">${l.name}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö -</option>';

    const branchFilter = $('logBranchFilter');
    const branchFilter2 = $('sumBranchFilter');
    const opts = ['<option value="ALL">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>']
      .concat(branches.map(b => `<option value="${b.name}">${b.name}</option>`));
    branchFilter.innerHTML = opts.join('');
    branchFilter2.innerHTML = opts.join('');
  }

  function renderEmployeesTable() {
    const tb = $('empTableBody');
    const q = $('empSearch').value.trim().toLowerCase();

    let list = employees;
    if (q) {
      list = list.filter(e => {
        const text = (String(e.code) + ' ' + String(e.fullName)).toLowerCase();
        return text.includes(q);
      });
    }
    if (!list.length) {
      tb.innerHTML = '<tr><td colspan="5" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = list.map(e => `
      <tr>
        <td>${e.code || ''}</td>
        <td>${e.fullName || ''}</td>
        <td>${e.branch || ''}</td>
        <td>${e.level || ''}</td>
        <td>
          <div class="table-actions">
            <button class="btn btn-secondary btn-small" onclick="editEmployee('${e.id || ''}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger btn-small" onclick="deleteEmployeeConfirm('${e.id || ''}','${e.code || ''}','${(e.fullName || '').replace(/'/g,'')}')">‡∏•‡∏ö</button>
          </div>
        </td>
      </tr>
    `).join('');
  }

  window.editEmployee = function(id) {
    const emp = employees.find(e => String(e.id) === String(id));
    if (!emp) return;
    editingEmpId = emp.id;
    $('empFormTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    $('empCode').value = emp.code || '';
    $('empFullName').value = emp.fullName || '';
    $('empBranch').value = emp.branch || '';
    $('empLevel').value = emp.level || '';
    $('empEmail').value = emp.email || '';
    $('empFormError').style.display = 'none';
    $('empFormSuccess').style.display = 'none';
  };

  window.deleteEmployeeConfirm = async function(id, code, name) {
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ ${code} (${name}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try {
      await api.call('deleteEmployee', { id });
      employees = await api.call('getEmployees');
      renderEmployeesTable();
      alert('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } catch (err) {
      alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  };

  async function saveEmployee() {
    const code = $('empCode').value.trim();
    const fullName = $('empFullName').value.trim();
    const branch = $('empBranch').value.trim();
    const level  = $('empLevel').value.trim();
    const email  = $('empEmail').value.trim();

    const errEl = $('empFormError');
    const sucEl = $('empFormSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';

    if (!code || !fullName) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
      errEl.style.display = 'block';
      return;
    }

    try {
      await api.call('saveEmployee', {
        id: editingEmpId || '',
        code,
        fullName,
        branch,
        level,
        email
      });
      employees = await api.call('getEmployees');
      renderEmployeesTable();
      editingEmpId = null;
      $('empFormTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
      sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    } catch (err) {
      errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  function resetEmpForm() {
    editingEmpId = null;
    $('empFormTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
    $('empCode').value = '';
    $('empFullName').value = '';
    if ($('empBranch').options.length) $('empBranch').selectedIndex = 0;
    if ($('empLevel').options.length) $('empLevel').selectedIndex = 0;
    $('empEmail').value = '';
    $('empFormError').style.display = 'none';
    $('empFormSuccess').style.display = 'none';
  }

  function renderLogsTable(res) {
    const rows = (res && res.rows) || [];
    const tb = $('logsTableBody');
    if (!rows.length) {
      tb.innerHTML = '<tr><td colspan="9" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(r => {
      const total = calcTotalHours(r.t1, r.t4);
      const locText = r.locationText || '';
      const locCell = locText ? `<span class="pill-small">${locText}</span>` : '-';
      const evidence = r.evidenceUrl
        ? `<a href="${r.evidenceUrl}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>`
        : '-';
      return `
        <tr>
          <td>${formatDateThai(r.date)}</td>
          <td>${r.code || ''}</td>
          <td>${r.fullName || ''}</td>
          <td>${r.t1 || '-'}</td>
          <td>${r.t4 || '-'}</td>
          <td>${total}</td>
          <td>${statusBadgeHtml(r.status || '')}</td>
          <td>${locCell}</td>
          <td>${evidence}</td>
        </tr>
      `;
    }).join('');
  }

  async function reloadLogs() {
    const year  = $('logYearFilter').value;
    const month = $('logMonthFilter').value;
    const branch = $('logBranchFilter').value || 'ALL';
    const search = $('logSearch').value.trim();

    try {
      const res = await api.call('getLogsRange', { year, month, branch, search });
      renderLogsTable(res);
    } catch (err) {
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  function renderSummaryTable(res) {
    const rows = (res && res.rows) || [];
    const tb = $('summaryTableBody');
    if (!rows.length) {
      tb.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${r.code || ''}</td>
        <td>${r.fullName || ''}</td>
        <td>${r.branch || ''}</td>
        <td>${r.level || ''}</td>
        <td>${r.days || 0}</td>
        <td>${r.normalCount || 0}</td>
        <td>${r.lateCount || 0}</td>
        <td>${r.absentCount || 0}</td>
      </tr>
    `).join('');
  }

  async function reloadSummary() {
    const year  = $('sumYearFilter').value;
    const month = $('sumMonthFilter').value;
    const branch = $('sumBranchFilter').value || 'ALL';
    try {
      const res = await api.call('getSummaryRange', { year, month, branch });
      renderSummaryTable(res);
    } catch (err) {
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  function renderBranchesLevelsTables() {
    const bt = $('branchTableBody');
    const lt = $('levelTableBody');

    if (!branches.length) {
      bt.innerHTML = '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å</td></tr>';
    } else {
      bt.innerHTML = branches.map(b => `
        <tr>
          <td>${b.name}</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteBranch('${b.name.replace(/'/g,'')}')">‡∏•‡∏ö</button></td>
        </tr>
      `).join('');
    }

    if (!levels.length) {
      lt.innerHTML = '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>';
    } else {
      lt.innerHTML = levels.map(l => `
        <tr>
          <td>${l.name}</td>
          <td><button class="btn btn-danger btn-small" onclick="deleteLevel('${l.name.replace(/'/g,'')}')">‡∏•‡∏ö</button></td>
        </tr>
      `).join('');
    }
  }

  window.deleteBranch = async function(name) {
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try {
      await api.call('deleteBranch', { name });
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      $('settingsSuccess').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('settingsSuccess').style.display = 'block';
      $('settingsError').style.display = 'none';
    } catch (err) {
      $('settingsError').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('settingsError').style.display = 'block';
      $('settingsSuccess').style.display = 'none';
    }
  };

  window.deleteLevel = async function(name) {
    if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try {
      await api.call('deleteLevel', { name });
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      $('settingsSuccess').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      $('settingsSuccess').style.display = 'block';
      $('settingsError').style.display = 'none';
    } catch (err) {
      $('settingsError').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      $('settingsError').style.display = 'block';
      $('settingsSuccess').style.display = 'none';
    }
  };

  async function addBranch() {
    const name = $('branchName').value.trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if (!name) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å';
      errEl.style.display = 'block';
      return;
    }
    try {
      await api.call('saveBranch', { name });
      $('branchName').value = '';
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    } catch (err) {
      errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  async function addLevel() {
    const name = $('levelName').value.trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    errEl.style.display = 'none';
    sucEl.style.display = 'none';
    if (!name) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö';
      errEl.style.display = 'block';
      return;
    }
    try {
      await api.call('saveLevel', { name });
      $('levelName').value = '';
      const bl = await api.call('getBranchesLevels');
      branches = bl.branches || [];
      levels   = bl.levels || [];
      renderBranchLevelSelects();
      renderBranchesLevelsTables();
      sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      sucEl.style.display = 'block';
    } catch (err) {
      errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
      errEl.style.display = 'block';
    }
  }

  function openUrlCard() {
    $('inputApiUrl').value = getApiUrl();
    $('urlCard').style.display = 'block';
    $('urlError').style.display = 'none';
  }

  function closeUrlCard() {
    $('urlCard').style.display = 'none';
  }

  function saveUrl() {
    const url = $('inputApiUrl').value.trim();
    const errEl = $('urlError');
    errEl.style.display = 'none';
    if (!url) {
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL';
      errEl.style.display = 'block';
      return;
    }
    setApiUrl(url);
    $('apiUrlDisplay').textContent = 'API: ' + url;
    closeUrlCard();
    initAdmin();
  }

  function switchSection(section) {
    document.querySelectorAll('.nav-item').forEach(el => {
      el.classList.toggle('active', el.dataset.section === section);
    });
    document.querySelectorAll('.mobile-nav-item').forEach(el => {
      el.classList.toggle('active', el.dataset.section === section);
    });
    document.querySelectorAll('.section').forEach(el => {
      el.classList.toggle('active', el.id === 'section-' + section);
    });
  }

  async function initAdmin() {
    const apiUrl = getApiUrl();
    $('apiUrlDisplay').textContent = apiUrl ? 'API: ' + apiUrl : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
    if (!apiUrl) {
      setConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
      return;
    }

    try {
      const [empRes, blRes, todaySummary, monthSummary] = await Promise.all([
        api.call('getEmployees'),
        api.call('getBranchesLevels'),
        api.call('getTodaySummary'),
        (async () => {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1;
          return api.call('getSummaryRange', { year, month, branch: 'ALL' });
        })()
      ]);

      employees = empRes || [];
      branches  = blRes.branches || [];
      levels    = blRes.levels || [];

      setConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      renderBranchLevelSelects();
      renderEmployeesTable();
      renderBranchesLevelsTables();
      renderDashboard(todaySummary, monthSummary);

      fillYearMonthSelect($('logYearFilter'), $('logMonthFilter'));
      fillYearMonthSelect($('sumYearFilter'), $('sumMonthFilter'));

      reloadLogs();
      reloadSummary();

    } catch (err) {
      console.error(err);
      setConnectionStatus(false, err.message);
      alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.nav-item').forEach(el => {
      el.addEventListener('click', () => {
        const sec = el.getAttribute('data-section');
        switchSection(sec);
      });
    });

    document.querySelectorAll('.mobile-nav-item').forEach(el => {
      el.addEventListener('click', () => {
        const sec = el.getAttribute('data-section');
        switchSection(sec);
      });
    });

    $('btnBackToFront').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    $('btnLogout').addEventListener('click', () => {
      if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡∏ö URL API ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        setApiUrl('');
        window.location.href = 'index.html';
      }
    });

    $('btnSetUrl').addEventListener('click', openUrlCard);
    $('btnSaveUrl').addEventListener('click', saveUrl);
    $('btnCancelUrl').addEventListener('click', closeUrlCard);

    $('empSearch').addEventListener('input', renderEmployeesTable);
    $('btnSaveEmployee').addEventListener('click', saveEmployee);
    $('btnResetEmpForm').addEventListener('click', resetEmpForm);

    $('btnReloadLogs').addEventListener('click', reloadLogs);
    $('logSearch').addEventListener('keydown', e => { if (e.key === 'Enter') reloadLogs(); });

    $('btnReloadSummary').addEventListener('click', reloadSummary);

    $('btnAddBranch').addEventListener('click', addBranch);
    $('btnAddLevel').addEventListener('click', addLevel);

    initAdmin();
  });
</script>
</body>
</html>
