<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- ‚úÖ Face API (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ./models) -->
  <!-- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏•‡πá‡∏≠‡∏Å CDN ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå face-api.min.js ‡∏°‡∏≤‡πÑ‡∏ß‡πâ local ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô src -->
  <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.13/dist/face-api.min.js"></script>

  <style>
    :root{
      --primary:#2563eb;--primary-soft:#dbeafe;--accent:#22c55e;--danger:#ef4444;--warning:#fbbf24;
      --bg:#f3f4f6;--text-main:#0f172a;--text-soft:#6b7280;--border:#e5e7eb;--card-bg:#ffffff;
      --sidebar-bg:#020617;--sidebar-active:#020617;
    }
    *{box-sizing:border-box;font-family:"Prompt",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    html,body{margin:0;padding:0;width:100%;max-width:100%}
    body{
      color:var(--text-main);
      background:radial-gradient(circle at top left,#e0e7ff 0,transparent 55%),
                radial-gradient(circle at bottom right,#e5f5ff 0,transparent 50%),#f3f4f6;
    }
    a{color:var(--primary);text-decoration:none} a:hover{text-decoration:underline}

    button,.btn{
      border-radius:999px;border:none;cursor:pointer;font-size:13px;padding:7px 14px;
      display:inline-flex;align-items:center;justify-content:center;gap:6px;
      transition:transform .08s ease,box-shadow .08s ease,background .1s ease,opacity .1s ease;
      white-space:nowrap;user-select:none
    }
    button:active,.btn:active{transform:translateY(1px) scale(.99);box-shadow:none}
    button:disabled,.btn:disabled{opacity:.6;cursor:default;transform:none;box-shadow:none}
    .btn-primary{background:var(--primary);color:#fff;box-shadow:0 10px 24px rgba(37,99,235,.35)}
    .btn-secondary{background:#fff;color:#111827;border:1px solid var(--border)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-small{padding:4px 10px;font-size:12px}
    .btn-ghost{border-radius:999px;background:transparent;border:1px solid var(--border);color:var(--text-soft)}

    /* PAGE */
    .page{display:flex;min-height:100vh;width:100%}

    /* SIDEBAR */
    .sidebar{
      width:240px;background:radial-gradient(circle at top,#111827,#020617);color:#e5e7eb;
      display:flex;flex-direction:column;padding:16px 14px;flex-shrink:0;
      box-shadow:8px 0 30px rgba(15,23,42,.5),0 0 0 1px rgba(15,23,42,.5);
      position:relative;z-index:30
    }
    .sidebar::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at bottom,rgba(37,99,235,.2),transparent 60%);pointer-events:none}
    .sidebar-header{padding:6px 6px 16px;border-bottom:1px solid rgba(55,65,81,.9);margin-bottom:10px;position:relative;z-index:1}
    .sidebar-title{font-weight:600;font-size:18px;margin-bottom:2px}
    .sidebar-sub{font-size:11px;color:#9ca3af}
    .nav{margin-top:14px;display:flex;flex-direction:column;gap:4px;flex:1;min-height:0;position:relative;z-index:1}
    .nav-item{
      display:flex;align-items:center;gap:8px;padding:8px 11px;border-radius:12px;cursor:pointer;
      font-size:14px;color:#e5e7eb;border:1px solid transparent
    }
    .nav-item span.icon{width:22px;display:inline-flex;justify-content:center}
    .nav-item.active{background:rgba(15,23,42,.95);border-color:rgba(59,130,246,.8);box-shadow:0 8px 16px rgba(15,23,42,.8)}
    .nav-item:hover{background:rgba(31,41,55,.9)}
    .sidebar-footer{padding-top:10px;border-top:1px solid rgba(55,65,81,.9);font-size:11px;color:#9ca3af;position:relative;z-index:1}
    .sidebar-footer button{margin-top:8px;width:100%}

    /* CONTENT */
    .content{flex:1;display:flex;flex-direction:column;min-width:0}

    header.topbar{
      padding:10px 18px;background:rgba(15,23,42,.9);color:#e5e7eb;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(15,23,42,.5);
      position:sticky;top:0;z-index:20;backdrop-filter:blur(14px);gap:10px
    }
    .topbar-left{display:flex;flex-direction:column;gap:2px;min-width:0;max-width:100%}
    .topbar-title{font-size:18px;font-weight:600}
    .topbar-sub{font-size:12px;color:#9ca3af;display:flex;flex-wrap:wrap;gap:4px;max-width:100%}
    #apiUrlDisplay{word-break:break-all;overflow-wrap:anywhere;max-width:100%;display:inline-block}
    .topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .hamburger{
      display:none;background:transparent;border:1px solid rgba(148,163,184,.35);color:#e5e7eb;
      padding:8px 12px;border-radius:14px
    }

    main.main{padding:18px 18px 22px}
    .main-inner{max-width:1260px;margin:0 auto;width:100%}

    /* MOBILE NAV */
    .mobile-nav{display:none;background:#020617;padding:7px 10px;border-bottom:1px solid #1f2937}
    .mobile-nav-inner{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
    .mobile-nav-item{
      flex:0 0 auto;border-radius:999px;border:1px solid rgba(75,85,99,.8);
      background:#111827;color:#e5e7eb;font-size:12px;padding:6px 12px;
      display:inline-flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap
    }
    .mobile-nav-item.active{background:var(--primary);border-color:rgba(37,99,235,.8);box-shadow:0 8px 18px rgba(37,99,235,.4)}

    /* CONNECTION BADGE */
    .badge-connection{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;
      background:rgba(15,118,110,.15);color:#a5f3fc;border:1px solid rgba(34,197,94,.8)
    }
    .badge-connection.offline{background:rgba(127,29,29,.35);color:#fecaca;border-color:rgba(248,113,113,.9)}
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.85)}
    .badge-connection.offline .dot{background:#f97373;box-shadow:0 0 8px rgba(248,113,113,.8)}

    /* CARDS */
    .card{
      background:var(--card-bg);border-radius:18px;padding:14px 14px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,.08),0 0 0 1px rgba(226,232,240,.9);
      border:1px solid rgba(226,232,240,.9);margin-bottom:14px;backdrop-filter:blur(10px);
      width:100%;max-width:100%
    }
    .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:10px;flex-wrap:wrap}
    .card-title{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
    .card-title span.icon{
      width:22px;height:22px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;
      font-size:13px;background:var(--primary-soft);color:var(--primary)
    }
    .card-subtitle{font-size:12px;color:var(--text-soft);max-width:100%}

    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .stat-card{padding:10px 12px;border-radius:14px;background:#f9fafb;border:1px dashed #e5e7eb;display:flex;flex-direction:column;gap:4px}
    .stat-label{font-size:12px;color:var(--text-soft)}
    .stat-value{font-size:20px;font-weight:600}
    .stat-extra{font-size:11px;color:var(--text-soft)}
    .stat-accent{color:#16a34a}
    .stat-danger{color:#b91c1c}

    .badge-status{font-size:11px;padding:3px 9px;border-radius:999px;display:inline-block}
    .badge-normal{background:#dcfce7;color:#166534}
    .badge-late{background:#fee2e2;color:#b91c1c}
    .badge-absent{background:#ffe4e6;color:#be123c}
    .badge-other{background:#fef3c7;color:#92400e}

    table{width:100%;border-collapse:collapse;font-size:13px}
    thead{background:#f3f4f6}
    th,td{padding:7px 8px;border-bottom:1px solid #e5e7eb;text-align:left;white-space:nowrap}
    th{font-weight:500;color:#374151;font-size:12px}
    tbody tr:nth-child(even){background:#f9fafb}
    .text-right{text-align:right}.text-center{text-align:center}

    .scroll-x{overflow-x:auto;-webkit-overflow-scrolling:touch;max-width:100%}
    .scroll-x>table{min-width:720px}
    .scroll-x::-webkit-scrollbar{height:6px}
    .scroll-x::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:999px}

    .filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .filters .field{display:flex;flex-direction:column;gap:2px;font-size:11px;color:var(--text-soft)}
    select,input[type="text"],input[type="number"]{
      border-radius:999px;border:1px solid var(--border);padding:6px 10px;font-size:13px;outline:none;min-width:120px;background:#fff
    }
    input[type="text"]:focus,select:focus,input[type="number"]:focus{border-color:var(--primary);box-shadow:0 0 0 1px rgba(37,99,235,.3)}
    .input-block{width:100%;border-radius:10px;border:1px solid var(--border);padding:6px 9px;font-size:13px;outline:none;background:#fff}
    .input-block:focus{border-color:var(--primary);box-shadow:0 0 0 1px rgba(37,99,235,.3)}
    .helper{font-size:11px;color:var(--text-soft)}

    .mt-8{margin-top:8px}.mt-10{margin-top:10px}.mt-12{margin-top:12px}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:#e5e7eb;color:#374151}
    .section{display:none}.section.active{display:block}
    .error-text{font-size:12px;color:var(--danger);margin-top:4px}
    .success-text{font-size:12px;color:#16a34a;margin-top:4px}
    .flex{display:flex;gap:8px;align-items:center}
    .flex-stack-mobile{}
    @media (max-width:640px){
      .flex-stack-mobile{flex-direction:column;align-items:stretch}
      .flex-stack-mobile .btn{width:100%;justify-content:center}
      .scroll-x>table{min-width:640px}
    }

    .table-actions{display:flex;gap:4px}
    .pill-small{font-size:10px;padding:2px 6px;border-radius:999px;background:#e5e7eb;color:#4b5563}
    .header-search-box{min-width:220px;max-width:280px;width:100%}
    @media (max-width:640px){
      .header-search-box{min-width:100%;max-width:100%}
      #empSearch{width:100%}
      .scroll-x>table{min-width:640px}
    }

    /* ‚úÖ FACE ENROLL BOX */
    .face-box{
      margin-top:10px;border-radius:14px;border:1px dashed #e5e7eb;background:#f9fafb;padding:10px
    }
    .face-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .face-video-wrap{margin-top:10px;display:none}
    video#faceVideo{
      width:100%;max-width:320px;border-radius:12px;border:1px solid #e5e7eb;background:#111827
    }
    canvas#faceCanvas{display:none}
    .face-preview{
      margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start
    }
    img#empPhotoPreview{
      width:110px;height:110px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb;display:none
    }
    .badge-mini{
      display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:4px 10px;border-radius:999px;
      border:1px solid #e5e7eb;background:#fff;color:#111827
    }
    .badge-mini.ok{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08)}
    .badge-mini.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08)}
    .badge-mini.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.10)}

    /* RESPONSIVE: hide sidebar + show mobile nav */
    @media (max-width:1000px){
      .sidebar{display:none}
      .page{flex-direction:column}
      main.main{padding:14px 12px 18px}
      .mobile-nav{display:block;position:sticky;top:54px;z-index:15}
      .hamburger{display:inline-flex}
    }
    @media (max-width:800px){.grid-3{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}
    @media (max-width:640px){
      header.topbar{flex-direction:column;align-items:flex-start;gap:8px}
      .topbar-right{width:100%;justify-content:space-between}
      .filters .field{min-width:46%}
    }

    /* URL CARD (floating) */
    #urlCard{
      position:fixed;right:16px;bottom:16px;max-width:460px;width:calc(100% - 32px);z-index:40;display:none
    }
    @media (max-width:640px){#urlCard{left:12px;right:12px;bottom:12px}}

    /* Mobile Drawer (optional) */
    .drawer-backdrop{
      display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);z-index:60
    }
    .drawer{
      position:fixed;left:-290px;top:0;bottom:0;width:270px;background:radial-gradient(circle at top,#111827,#020617);
      color:#e5e7eb;z-index:61;transition:left .18s ease;box-shadow:10px 0 30px rgba(15,23,42,.6);
      padding:16px 14px;display:flex;flex-direction:column
    }
    .drawer.show{left:0}
    .drawer-backdrop.show{display:block}
    .drawer .nav{margin-top:10px}
    .drawer .sidebar-footer{margin-top:auto}
  </style>
</head>

<body>
<div class="page">

  <!-- SIDEBAR (desktop) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <div class="sidebar-sub">HR Attendance Panel</div>
    </div>

    <nav class="nav">
      <div class="nav-item active" data-section="dashboard"><span class="icon">üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span></div>
      <div class="nav-item" data-section="employees"><span class="icon">üë•</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></div>
      <div class="nav-item" data-section="logs"><span class="icon">‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</span></div>
      <div class="nav-item" data-section="summary"><span class="icon">üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span></div>
      <div class="nav-item" data-section="settings"><span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏±‡πâ‡∏ô)</span></div>
    </nav>

    <div class="sidebar-footer">
      <div>TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
      <button class="btn btn-ghost" id="btnBackToFront">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn btn-danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </aside>

  <!-- MOBILE DRAWER -->
  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <aside class="drawer" id="drawer">
    <div class="sidebar-header">
      <div class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <div class="sidebar-sub">HR Attendance Panel</div>
    </div>
    <nav class="nav">
      <div class="nav-item active" data-section="dashboard"><span class="icon">üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span></div>
      <div class="nav-item" data-section="employees"><span class="icon">üë•</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></div>
      <div class="nav-item" data-section="logs"><span class="icon">‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</span></div>
      <div class="nav-item" data-section="summary"><span class="icon">üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span></div>
      <div class="nav-item" data-section="settings"><span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡∏™‡∏≤‡∏Ç‡∏≤/‡∏ä‡∏±‡πâ‡∏ô)</span></div>
    </nav>
    <div class="sidebar-footer">
      <div>TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
      <button class="btn btn-ghost" id="btnBackToFront2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn btn-danger" id="btnLogout2">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="content">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="topbar-sub"><span>Admin Panel |</span> <span id="apiUrlDisplay"></span></div>
      </div>

      <div class="topbar-right">
        <button class="hamburger" id="btnOpenDrawer">‚ò∞ ‡πÄ‡∏°‡∏ô‡∏π</button>
        <div id="connectionBadge" class="badge-connection offline">
          <span class="dot"></span><span id="connectionText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        <button class="btn btn-secondary" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
      </div>
    </header>

    <!-- MOBILE NAV -->
    <nav class="mobile-nav">
      <div class="mobile-nav-inner">
        <button class="mobile-nav-item active" data-section="dashboard"><span>üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></button>
        <button class="mobile-nav-item" data-section="employees"><span>üë•</span><span>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></button>
        <button class="mobile-nav-item" data-section="logs"><span>‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</span></button>
        <button class="mobile-nav-item" data-section="summary"><span>üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ</span></button>
        <button class="mobile-nav-item" data-section="settings"><span>‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></button>
      </div>
    </nav>

    <main class="main">
      <div class="main-inner">

        <!-- DASHBOARD -->
        <section class="section active" id="section-dashboard">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìä</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="card-subtitle">‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á HR</div>
              </div>
              <div class="flex flex-stack-mobile">
                <button class="btn btn-secondary btn-small" id="btnRefreshDashboard">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                <button class="btn btn-primary btn-small" id="btnQuickGoLogs">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‚Äù</button>
              </div>
            </div>

            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="stat-value" id="statTotalEmployees">‚Äì</div>
                <div class="stat-extra">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Employees</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value stat-accent" id="statTodayCount">‚Äì</div>
                <div class="stat-extra">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span class="stat-danger" id="statTodayLate">‡∏™‡∏≤‡∏¢ 0 ‡∏Ñ‡∏ô</span></div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏™‡∏≤‡∏¢ / ‡∏Ç‡∏≤‡∏î)</div>
                <div class="stat-value" id="statMonthOverview">‚Äì</div>
                <div class="stat-extra">‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô getSummaryRange</div>
              </div>
            </div>

            <div class="mt-12">
              <div class="card-subtitle">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="scroll-x mt-8">
                <table>
                  <thead>
                  <tr>
                    <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th><th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  </tr>
                  </thead>
                  <tbody id="dashboardTodayBody">
                    <tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-8">
                <div class="card-subtitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
                <div id="dashboardLocationSummary" class="mt-8" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- EMPLOYEES -->
        <section class="section" id="section-employees">
          <div class="grid-2">
            <!-- FORM -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title"><span class="icon">üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å / ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                  <div class="card-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‚Äì‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Employees ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</div>
                </div>
              </div>

              <div class="card-subtitle" id="empFormTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>

              <div class="mt-8">
                <div class="mt-8">
                  <div class="helper">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                  <input id="empCode" class="input-block" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" inputmode="numeric" />
                </div>
                <div class="mt-8">
                  <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
                  <input id="empFullName" class="input-block" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
                </div>
                <div class="mt-8">
                  <div class="helper">‡πÅ‡∏ú‡∏ô‡∏Å</div>
                  <select id="empBranch" class="input-block"></select>
                </div>
                <div class="mt-8">
                  <div class="helper">‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <select id="empLevel" class="input-block"></select>
                </div>
                <div class="mt-8">
                  <div class="helper">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
                  <input id="empEmail" class="input-block" placeholder="optional" inputmode="email" />
                </div>

                <!-- ‚úÖ FACE ENROLL -->
                <div class="face-box">
                  <div class="helper"><b>‡∏£‡∏π‡∏õ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô / ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</b> ‚Äî ‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</div>

                  <div class="mt-8 face-row">
                    <input type="file" id="empPhoto" accept="image/*" class="input-block" />
                    <button class="btn btn-secondary btn-small" id="btnOpenCam">‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button class="btn btn-secondary btn-small" id="btnCapture" disabled>‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</button>
                    <button class="btn btn-ghost btn-small" id="btnCloseCam" disabled>‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                  </div>

                  <div class="face-video-wrap" id="faceVideoWrap">
                    <div class="mt-10">
                      <video id="faceVideo" autoplay playsinline muted></video>
                      <canvas id="faceCanvas"></canvas>
                    </div>
                  </div>

                  <div class="face-preview">
                    <img id="empPhotoPreview" alt="preview" />
                    <div style="min-width:220px;flex:1;">
                      <div class="face-row">
                        <span class="badge-mini warn" id="faceLibStatus">Face API: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span>
                        <span class="badge-mini warn" id="faceModelStatus">Models: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î</span>
                        <span class="badge-mini warn" id="faceDescStatus">Descriptor: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</span>
                      </div>
                      <div class="mt-8 helper">
                        ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ ‚Äú‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î ‡πÜ 1 ‡∏£‡∏π‡∏õ‡∏ï‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô<br>
                        ‚Ä¢ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå <b>models</b> ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ: <code>./models</code>
                      </div>
                      <div class="mt-10 face-row">
                        <button class="btn btn-primary btn-small" id="btnDetectFace" disabled>‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡∏™‡∏£‡πâ‡∏≤‡∏á Descriptor</button>
                        <button class="btn btn-ghost btn-small" id="btnClearFace">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ/Descriptor</button>
                      </div>
                      <div class="helper mt-8" id="faceHint"></div>
                    </div>
                  </div>
                </div>

                <div class="mt-10 flex flex-stack-mobile">
                  <button class="btn btn-primary" id="btnSaveEmployee">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                  <button class="btn btn-secondary" id="btnResetEmpForm">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                </div>
                <div id="empFormError" class="error-text" style="display:none;"></div>
                <div id="empFormSuccess" class="success-text" style="display:none;"></div>
              </div>
            </div>

            <!-- TABLE -->
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title"><span class="icon">üìã</span> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                  <div class="card-subtitle">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ ‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</div>
                </div>
                <div class="header-search-box">
                  <input type="text" id="empSearch" class="input-block" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠" />
                </div>
              </div>

              <div class="scroll-x" style="max-height:420px; overflow-y:auto;">
                <table>
                  <thead>
                  <tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                  </thead>
                  <tbody id="empTableBody">
                    <tr><td colspan="5" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="helper mt-8">* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î ‡πÜ (‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢)</div>
            </div>
          </div>
        </section>

        <!-- LOGS -->
        <section class="section" id="section-logs">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">‚è±</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div class="card-subtitle">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ</div>
              </div>
            </div>

            <div class="filters mt-8">
              <div class="field" style="flex:1; min-width:160px;">
                <span>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™</span>
                <input type="text" id="logSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011, ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
              </div>
              <div class="field"><span>‡∏™‡∏≤‡∏Ç‡∏≤</span><select id="logBranchFilter"></select></div>
              <div class="field"><span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span><select id="logMonthFilter"></select></div>
              <div class="field"><span>‡∏õ‡∏µ (‡∏û.‡∏®.)</span><select id="logYearFilter"></select></div>
              <div class="field"><span>&nbsp;</span><button class="btn btn-primary btn-small" id="btnReloadLogs">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>
            </div>

            <div class="scroll-x mt-10" style="max-height:480px; overflow-y:auto;">
              <table>
                <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
                </tr>
                </thead>
                <tbody id="logsTableBody"><tr><td colspan="9" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
              </table>
            </div>

            <div class="helper mt-8">
              * ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å t1 ‡∏ñ‡∏∂‡∏á t4 (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö) ‚Ä¢ ‡∏Å‡∏î Enter ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ
            </div>
          </div>
        </section>

        <!-- SUMMARY -->
        <section class="section" id="section-summary">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìà</span> ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                <div class="card-subtitle">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏Ñ‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏Ç‡∏≤‡∏î‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô ‡∏Ø‡∏•‡∏Ø</div>
              </div>
            </div>

            <div class="filters mt-8">
              <div class="field"><span>‡∏™‡∏≤‡∏Ç‡∏≤</span><select id="sumBranchFilter"></select></div>
              <div class="field"><span>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span><select id="sumMonthFilter"></select></div>
              <div class="field"><span>‡∏õ‡∏µ (‡∏û.‡∏®.)</span><select id="sumYearFilter"></select></div>
              <div class="field"><span>&nbsp;</span><button class="btn btn-primary btn-small" id="btnReloadSummary">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>
            </div>

            <div class="scroll-x mt-10" style="max-height:480px; overflow-y:auto;">
              <table>
                <thead>
                <tr><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏≤‡∏¢</th><th>‡∏Ç‡∏≤‡∏î</th></tr>
                </thead>
                <tbody id="summaryTableBody"><tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="section" id="section-settings">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å / ‡∏ä‡∏±‡πâ‡∏ô</div>
                <div class="card-subtitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πà‡∏≤‡∏á ‡πÜ</div>
              </div>
            </div>

            <div class="card-subtitle">‡πÅ‡∏ú‡∏ô‡∏Å</div>
            <div class="mt-8 flex flex-stack-mobile">
              <input id="branchName" class="input-block" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏´‡∏°‡πà" />
              <button class="btn btn-primary btn-small" id="btnAddBranch">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>

            <div class="scroll-x mt-8" style="max-height:320px; overflow-y:auto;">
              <table>
                <thead><tr><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="branchTableBody"><tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
              </table>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìå</span> ‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                <div class="card-subtitle">‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Ø‡∏•‡∏Ø</div>
              </div>
            </div>

            <div class="card-subtitle">‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
            <div class="mt-8 flex flex-stack-mobile">
              <input id="levelName" class="input-block" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà" />
              <button class="btn btn-primary btn-small" id="btnAddLevel">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>

            <div class="scroll-x mt-8" style="max-height:320px; overflow-y:auto;">
              <table>
                <thead><tr><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                <tbody id="levelTableBody"><tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr></tbody>
              </table>
            </div>

            <div id="settingsError" class="error-text" style="display:none;"></div>
            <div id="settingsSuccess" class="success-text" style="display:none;"></div>
          </div>
        </section>

      </div>
    </main>
  </div>
</div>

<!-- URL CARD -->
<div class="card" id="urlCard">
  <div class="card-header">
    <div class="card-title"><span class="icon">üîó</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API</div>
  </div>
  <div>
    <div class="helper">URL ‡∏à‡∏≤‡∏Å Apps Script Web App (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <code>/exec</code>)</div>
    <input id="inputApiUrl" class="input-block mt-8" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/XXXXX/exec" />
    <div class="mt-8 flex flex-stack-mobile">
      <button class="btn btn-primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-secondary" id="btnCancelUrl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div id="urlError" class="error-text" style="display:none;"></div>
  </div>
</div>

<script>
  /************************************************************
   * STORAGE + API
   ************************************************************/
  const STORAGE_KEY = 'attendance_api_url_v2';
  function getApiUrl(){ return localStorage.getItem(STORAGE_KEY) || ''; }
  function setApiUrl(url){ if(!url) localStorage.removeItem(STORAGE_KEY); else localStorage.setItem(STORAGE_KEY,url); }

  const api = {
    async call(action, params = {}){
      const apiUrl = getApiUrl();
      if(!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');
      const body = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(apiUrl, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body
      });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch(e){
        console.error('API response not JSON:', text);
        throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ URL ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)');
      }
      if(!data.ok) throw new Error(data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      return data.result;
    }
  };

  /************************************************************
   * STATE
   ************************************************************/
  let employees = [];
  let branches = [];
  let levels = [];
  let editingEmpId = null;

  // Face enrollment state
  let faceModelsLoaded = false;
  let faceDescriptor = null;      // Float32Array
  let facePhotoBase64 = '';       // dataURL string
  let camStream = null;

  /************************************************************
   * UTIL
   ************************************************************/
  function $(id){ return document.getElementById(id); }

  function setConnectionStatus(online, msg){
    const bdg = $('connectionBadge'), txt = $('connectionText');
    if(!bdg || !txt) return;
    if(online){ bdg.classList.remove('offline'); txt.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; }
    else{ bdg.classList.add('offline'); txt.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠'; }
  }

  function statusBadgeHtml(status){
    if(!status) return '<span class="badge-status badge-absent">‡∏Ç‡∏≤‡∏î</span>';
    let cls='badge-other';
    if(status==='‡∏õ‡∏Å‡∏ï‡∏¥') cls='badge-normal';
    else if(String(status).includes('‡∏™‡∏≤‡∏¢')) cls='badge-late';
    else if(status==='‡∏Ç‡∏≤‡∏î') cls='badge-absent';
    return '<span class="badge-status '+cls+'">'+escapeHtml(status)+'</span>';
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  function fileToBase64(file){
    return new Promise((resolve,reject)=>{
      if(!file) return resolve('');
      const reader=new FileReader();
      reader.onload=()=>resolve(reader.result);
      reader.onerror=()=>reject(reader.error || new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      reader.readAsDataURL(file);
    });
  }

  function timeToMinutes(t){
    if(!t) return null;
    const p=String(t).split(':'); if(p.length<2) return null;
    const h=Number(p[0]), m=Number(p[1]);
    if(isNaN(h)||isNaN(m)) return null;
    return h*60+m;
  }
  function calcTotalHours(t1,t4){
    const m1=timeToMinutes(t1), m4=timeToMinutes(t4);
    if(m1==null||m4==null||m4<=m1) return '-';
    const diff=m4-m1; const hours=Math.floor(diff/60); const mins=diff%60;
    return `${hours} ‡∏ä‡∏°. ${String(mins).padStart(2,'0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }
  function formatDateThai(dateStr){
    let d;
    if(dateStr instanceof Date) d=dateStr;
    else{
      const parts=String(dateStr).split('-');
      if(parts.length===3) d=new Date(Number(parts[0]),Number(parts[1])-1,Number(parts[2]));
      else return String(dateStr||'');
    }
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yy=d.getFullYear()+543;
    return `${dd}/${mm}/${yy}`;
  }

  function fillYearMonthSelect(yearSel, monthSel){
    const now=new Date(); const curYear=now.getFullYear(); const years=[curYear-1,curYear,curYear+1];
    yearSel.innerHTML = years.map(y=>{
      const be=y+543; const sel=(y===curYear)?'selected':'';
      return `<option value="${y}" ${sel}>${be}</option>`;
    }).join('');
    const monthNames=['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    monthSel.innerHTML = monthNames.map((m,i)=>{
      const sel=(i===now.getMonth())?'selected':'';
      return `<option value="${i+1}" ${sel}>${m}</option>`;
    }).join('');
  }

  function switchSection(section){
    document.querySelectorAll('.nav-item').forEach(el=>{
      el.classList.toggle('active', el.dataset.section===section);
    });
    document.querySelectorAll('.mobile-nav-item').forEach(el=>{
      el.classList.toggle('active', el.dataset.section===section);
    });
    document.querySelectorAll('.section').forEach(el=>{
      el.classList.toggle('active', el.id==='section-'+section);
    });
  }

  /************************************************************
   * URL CARD
   ************************************************************/
  function openUrlCard(){
    $('inputApiUrl').value = getApiUrl();
    $('urlCard').style.display='block';
    $('urlError').style.display='none';
  }
  function closeUrlCard(){ $('urlCard').style.display='none'; }
  function saveUrl(){
    const url=$('inputApiUrl').value.trim();
    const errEl=$('urlError'); errEl.style.display='none';
    if(!url){ errEl.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL'; errEl.style.display='block'; return; }
    setApiUrl(url);
    $('apiUrlDisplay').textContent = url ? ('API: '+url) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
    closeUrlCard();
    initAdmin();
  }

  /************************************************************
   * RENDER: Branch/Level selects + tables
   ************************************************************/
  function renderBranchLevelSelects(){
    const branchSel=$('empBranch'), levelSel=$('empLevel');
    branchSel.innerHTML = branches.length ? branches.map(b=>`<option value="${escapeHtml(b.name)}">${escapeHtml(b.name)}</option>`).join('')
                                         : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å -</option>';
    levelSel.innerHTML  = levels.length ? levels.map(l=>`<option value="${escapeHtml(l.name)}">${escapeHtml(l.name)}</option>`).join('')
                                        : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö -</option>';

    const opts = ['<option value="ALL">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>']
      .concat(branches.map(b=>`<option value="${escapeHtml(b.name)}">${escapeHtml(b.name)}</option>`));

    $('logBranchFilter').innerHTML = opts.join('');
    $('sumBranchFilter').innerHTML = opts.join('');
  }

  function renderBranchesLevelsTables(){
    const bt=$('branchTableBody'), lt=$('levelTableBody');

    bt.innerHTML = branches.length ? branches.map(b=>`
      <tr>
        <td>${escapeHtml(b.name)}</td>
        <td><button class="btn btn-danger btn-small" onclick="deleteBranch('${escapeHtml(b.name).replaceAll("&#039;","\\'")}')">‡∏•‡∏ö</button></td>
      </tr>`).join('')
      : '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å</td></tr>';

    lt.innerHTML = levels.length ? levels.map(l=>`
      <tr>
        <td>${escapeHtml(l.name)}</td>
        <td><button class="btn btn-danger btn-small" onclick="deleteLevel('${escapeHtml(l.name).replaceAll("&#039;","\\'")}')">‡∏•‡∏ö</button></td>
      </tr>`).join('')
      : '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>';
  }

  /************************************************************
   * DASHBOARD
   ************************************************************/
  function renderDashboard(todaySummary, monthSummary){
    $('statTotalEmployees').textContent = String(employees.length);

    const todayRows = Array.isArray(todaySummary) ? todaySummary : [];
    $('statTodayCount').textContent = String(todayRows.length);

    let lateCount=0;
    todayRows.forEach(r=>{ if(String(r.status||'').includes('‡∏™‡∏≤‡∏¢')) lateCount++; });
    $('statTodayLate').textContent = `‡∏™‡∏≤‡∏¢ ${lateCount} ‡∏Ñ‡∏ô`;

    const rows=(monthSummary && monthSummary.rows) || [];
    let normal=0, late=0, absent=0;
    rows.forEach(r=>{
      normal += Number(r.normalCount||0);
      late   += Number(r.lateCount||0);
      absent += Number(r.absentCount||0);
    });
    $('statMonthOverview').textContent = `${normal} ‡∏õ‡∏Å‡∏ï‡∏¥ / ${late} ‡∏™‡∏≤‡∏¢ / ${absent} ‡∏Ç‡∏≤‡∏î`;

    const tbody=$('dashboardTodayBody');
    if(!todayRows.length){
      tbody.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
    }else{
      tbody.innerHTML = todayRows.map(r=>`
        <tr>
          <td>${escapeHtml(r.code||'')}</td>
          <td>${escapeHtml(r.fullName||'')}</td>
          <td>${escapeHtml(r.t1||'')}</td>
          <td>${escapeHtml(r.t2||'')}</td>
          <td>${escapeHtml(r.t3||'')}</td>
          <td>${escapeHtml(r.t4||'')}</td>
          <td>${escapeHtml(r.locationText||r.location||'-')}</td>
          <td>${statusBadgeHtml(r.status||'')}</td>
        </tr>`).join('');
    }

    const locBox=$('dashboardLocationSummary');
    if(locBox){
      const locMap={};
      todayRows.forEach(r=>{
        const loc=(r.locationText||r.location||'').trim();
        if(!loc) return;
        locMap[loc]=(locMap[loc]||0)+1;
      });
      const entries=Object.entries(locMap);
      locBox.innerHTML = entries.length
        ? entries.map(([name,count])=>`<span class="tag">${escapeHtml(name)} ‚Äì ${count} ‡∏Ñ‡∏ô</span>`).join(' ')
        : '<span class="helper">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
    }
  }

  /************************************************************
   * EMPLOYEES
   ************************************************************/
  function renderEmployeesTable(){
    const tb=$('empTableBody');
    const q=$('empSearch').value.trim().toLowerCase();
    let list=employees;

    if(q){
      list=list.filter(e=>{
        const text=(String(e.code||'')+' '+String(e.fullName||'')+' '+String(e.branch||'')+' '+String(e.level||'')).toLowerCase();
        return text.includes(q);
      });
    }

    if(!list.length){
      tb.innerHTML='<tr><td colspan="5" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }

    tb.innerHTML = list.map(e=>`
      <tr>
        <td>${escapeHtml(e.code||'')}</td>
        <td>${escapeHtml(e.fullName||'')}</td>
        <td>${escapeHtml(e.branch||'')}</td>
        <td>${escapeHtml(e.level||'')}</td>
        <td>
          <div class="table-actions">
            <button class="btn btn-secondary btn-small" onclick="editEmployee('${escapeHtml(e.id||'')}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="btn btn-danger btn-small" onclick="deleteEmployeeConfirm('${escapeHtml(e.id||'')}','${escapeHtml(e.code||'')}','${escapeHtml(e.fullName||'')}')">‡∏•‡∏ö</button>
          </div>
        </td>
      </tr>`).join('');
  }

  window.editEmployee = function(id){
    const emp=employees.find(e=>String(e.id)===String(id));
    if(!emp) return;

    editingEmpId = emp.id;
    $('empFormTitle').textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    $('empCode').value = emp.code||'';
    $('empFullName').value = emp.fullName||'';
    $('empBranch').value = emp.branch||'';
    $('empLevel').value = emp.level||'';
    $('empEmail').value = emp.email||'';

    // reset face state
    clearFaceState(true);

    const preview=$('empPhotoPreview');
    if(emp.photo){
      preview.src = emp.photo;
      preview.style.display='block';
      facePhotoBase64 = emp.photo; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ
    }else{
      preview.src=''; preview.style.display='none';
    }

    $('empPhoto').value='';
    showEmpMessage('',true);
  };

  window.deleteEmployeeConfirm = async function(id, code, name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ ${code} (${name}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteEmployee', { id });
      employees = await api.call('getEmployees');
      renderEmployeesTable();
      alert('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      if(editingEmpId===id) resetEmpForm();
    }catch(err){
      alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  };

  function showEmpMessage(msg, isClear=false){
    const errEl=$('empFormError'), sucEl=$('empFormSuccess');
    if(isClear){ errEl.style.display='none'; sucEl.style.display='none'; errEl.textContent=''; sucEl.textContent=''; return; }
    if(msg && msg.type==='error'){
      errEl.textContent=msg.text; errEl.style.display='block';
      sucEl.style.display='none'; sucEl.textContent='';
    }else if(msg && msg.type==='success'){
      sucEl.textContent=msg.text; sucEl.style.display='block';
      errEl.style.display='none'; errEl.textContent='';
    }
  }

  async function saveEmployee(){
    const code=$('empCode').value.trim();
    const fullName=$('empFullName').value.trim();
    const branch=$('empBranch').value.trim();
    const level=$('empLevel').value.trim();
    const email=$('empEmail').value.trim();

    showEmpMessage('',true);

    if(!code || !fullName){
      showEmpMessage({type:'error', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'});
      return;
    }

    // photo from file input if user selected
    let photoBase64 = '';
    const photoInput=$('empPhoto');
    if(photoInput && photoInput.files && photoInput.files[0]){
      try{ photoBase64 = await fileToBase64(photoInput.files[0]); }
      catch(e){ console.error('photo to base64 fail', e); }
    }else if(facePhotoBase64){
      // from camera capture
      photoBase64 = facePhotoBase64;
    }

    try{
      // 1) save employee basic info
      await api.call('saveEmployee', {
        id: editingEmpId || '',
        code, fullName, branch, level, email,
        photoBase64: photoBase64 || '' // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
      });

      // 2) upload face (optional) ‚Äî ‡∏¢‡∏¥‡∏á‡πÅ‡∏¢‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö action uploadEmployeeFace
      //    ‡∏™‡πà‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Code.gs ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
      if(photoBase64 || faceDescriptor){
        try{
          const payload = {
            code,
            photoBase64: photoBase64 || '',
            evidenceBase64: photoBase64 || '',
            faceDescriptor: faceDescriptor ? JSON.stringify(Array.from(faceDescriptor)) : '',
            descriptorJson: faceDescriptor ? JSON.stringify(Array.from(faceDescriptor)) : ''
          };
          await api.call('uploadEmployeeFace', payload);
        }catch(e){
          // ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏° ‡∏ñ‡πâ‡∏≤ endpoint ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
          console.warn('uploadEmployeeFace skipped/failed:', e.message);
        }
      }

      // 3) reload list
      employees = await api.call('getEmployees');
      renderEmployeesTable();

      editingEmpId=null;
      $('empFormTitle').textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
      showEmpMessage({type:'success', text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'});

      // clear face state (keep preview if you want)
      clearFaceState(false);
      $('empPhoto').value='';

    }catch(err){
      showEmpMessage({type:'error', text:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message});
    }
  }

  function resetEmpForm(){
    editingEmpId=null;
    $('empFormTitle').textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
    $('empCode').value=''; $('empFullName').value=''; $('empEmail').value='';
    if($('empBranch').options.length) $('empBranch').selectedIndex=0;
    if($('empLevel').options.length) $('empLevel').selectedIndex=0;

    $('empPhoto').value='';
    $('empPhotoPreview').src=''; $('empPhotoPreview').style.display='none';

    clearFaceState(true);
    showEmpMessage('',true);
  }

  /************************************************************
   * LOGS + SUMMARY
   ************************************************************/
  function renderLogsTable(res){
    const rows=(res && res.rows) || [];
    const tb=$('logsTableBody');
    if(!rows.length){
      tb.innerHTML='<tr><td colspan="9" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(r=>{
      const total=calcTotalHours(r.t1, r.t4);
      const locText=r.locationText || '';
      const locCell = locText ? `<span class="pill-small">${escapeHtml(locText)}</span>` : '-';
      const evidence = r.evidenceUrl ? `<a href="${escapeHtml(r.evidenceUrl)}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-';
      return `
        <tr>
          <td>${escapeHtml(formatDateThai(r.date))}</td>
          <td>${escapeHtml(r.code||'')}</td>
          <td>${escapeHtml(r.fullName||'')}</td>
          <td>${escapeHtml(r.t1||'-')}</td>
          <td>${escapeHtml(r.t4||'-')}</td>
          <td>${escapeHtml(total)}</td>
          <td>${statusBadgeHtml(r.status||'')}</td>
          <td>${locCell}</td>
          <td>${evidence}</td>
        </tr>
      `;
    }).join('');
  }

  async function reloadLogs(){
    const year=$('logYearFilter').value;
    const month=$('logMonthFilter').value;
    const branch=$('logBranchFilter').value || 'ALL';
    const search=$('logSearch').value.trim();

    try{
      const res=await api.call('getLogsRange', { year, month, branch, search });
      renderLogsTable(res);
    }catch(err){
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  }

  function renderSummaryTable(res){
    const rows=(res && res.rows) || [];
    const tb=$('summaryTableBody');
    if(!rows.length){
      tb.innerHTML='<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      return;
    }
    tb.innerHTML = rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.code||'')}</td>
        <td>${escapeHtml(r.fullName||'')}</td>
        <td>${escapeHtml(r.branch||'')}</td>
        <td>${escapeHtml(r.level||'')}</td>
        <td>${escapeHtml(r.days||0)}</td>
        <td>${escapeHtml(r.normalCount||0)}</td>
        <td>${escapeHtml(r.lateCount||0)}</td>
        <td>${escapeHtml(r.absentCount||0)}</td>
      </tr>`).join('');
  }

  async function reloadSummary(){
    const year=$('sumYearFilter').value;
    const month=$('sumMonthFilter').value;
    const branch=$('sumBranchFilter').value || 'ALL';
    try{
      const res=await api.call('getSummaryRange', { year, month, branch });
      renderSummaryTable(res);
    }catch(err){
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  }

  /************************************************************
   * SETTINGS: branch/level CRUD
   ************************************************************/
  window.deleteBranch = async function(name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteBranch', { name });
      const bl=await api.call('getBranchesLevels');
      branches=bl.branches||[]; levels=bl.levels||[];
      renderBranchLevelSelects(); renderBranchesLevelsTables();
      $('settingsSuccess').textContent='‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; $('settingsSuccess').style.display='block';
      $('settingsError').style.display='none';
    }catch(err){
      $('settingsError').textContent='‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message; $('settingsError').style.display='block';
      $('settingsSuccess').style.display='none';
    }
  };

  window.deleteLevel = async function(name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteLevel', { name });
      const bl=await api.call('getBranchesLevels');
      branches=bl.branches||[]; levels=bl.levels||[];
      renderBranchLevelSelects(); renderBranchesLevelsTables();
      $('settingsSuccess').textContent='‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; $('settingsSuccess').style.display='block';
      $('settingsError').style.display='none';
    }catch(err){
      $('settingsError').textContent='‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message; $('settingsError').style.display='block';
      $('settingsSuccess').style.display='none';
    }
  };

  async function addBranch(){
    const name=$('branchName').value.trim();
    const errEl=$('settingsError'), sucEl=$('settingsSuccess');
    errEl.style.display='none'; sucEl.style.display='none';
    if(!name){ errEl.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å'; errEl.style.display='block'; return; }
    try{
      await api.call('saveBranch',{ name });
      $('branchName').value='';
      const bl=await api.call('getBranchesLevels');
      branches=bl.branches||[]; levels=bl.levels||[];
      renderBranchLevelSelects(); renderBranchesLevelsTables();
      sucEl.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; sucEl.style.display='block';
    }catch(err){
      errEl.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message; errEl.style.display='block';
    }
  }

  async function addLevel(){
    const name=$('levelName').value.trim();
    const errEl=$('settingsError'), sucEl=$('settingsSuccess');
    errEl.style.display='none'; sucEl.style.display='none';
    if(!name){ errEl.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö'; errEl.style.display='block'; return; }
    try{
      await api.call('saveLevel',{ name });
      $('levelName').value='';
      const bl=await api.call('getBranchesLevels');
      branches=bl.branches||[]; levels=bl.levels||[];
      renderBranchLevelSelects(); renderBranchesLevelsTables();
      sucEl.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; sucEl.style.display='block';
    }catch(err){
      errEl.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message; errEl.style.display='block';
    }
  }

  /************************************************************
   * FACE: models + detection + camera capture
   ************************************************************/
  function setBadge(el, type, text){
    if(!el) return;
    el.classList.remove('ok','bad','warn');
    el.classList.add(type);
    el.textContent = text;
  }

  async function loadFaceModels(){
    const libBadge=$('faceLibStatus'), modelBadge=$('faceModelStatus'), hint=$('faceHint');
    if(!window.faceapi){
      setBadge(libBadge,'bad','Face API: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ');
      setBadge(modelBadge,'bad','Models: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
      hint.textContent='‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö Offline ‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î face-api.min.js ‡∏°‡∏≤‡πÑ‡∏ß‡πâ local ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ src ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';
      return;
    }
    setBadge(libBadge,'ok','Face API: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    setBadge(modelBadge,'warn','Models: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶');
    hint.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≤‡∏Å ./models';

    try{
      // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô ./models (‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö admin.html)
      await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
      await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
      await faceapi.nets.faceRecognitionNet.loadFromUri('./models');
      faceModelsLoaded = true;
      setBadge(modelBadge,'ok','Models: ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');
      $('btnDetectFace').disabled = false;
      hint.textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Descriptor ‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏ñ‡πà‡∏≤‡∏¢)';
    }catch(err){
      console.error(err);
      faceModelsLoaded=false;
      setBadge(modelBadge,'bad','Models: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      hint.textContent='‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå ./models ‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Ñ‡∏£‡∏ö';
    }
  }

  function clearFaceState(clearPreview){
    faceDescriptor = null;
    const descBadge=$('faceDescStatus');
    setBadge(descBadge,'warn','Descriptor: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ');
    if(clearPreview){
      facePhotoBase64='';
      const preview=$('empPhotoPreview');
      preview.src=''; preview.style.display='none';
      $('empPhoto').value='';
    }
  }

  function updatePreviewFromBase64(b64){
    const preview=$('empPhotoPreview');
    if(!b64){
      preview.src=''; preview.style.display='none';
      return;
    }
    preview.src=b64; preview.style.display='block';
  }

  async function createDescriptorFromImage(base64){
    if(!faceModelsLoaded || !window.faceapi) throw new Error('Face Models ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
    const img = await faceapi.fetchImage(base64);
    const det = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.4 }))
      .withFaceLandmarks()
      .withFaceDescriptor();

    if(!det) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ (‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô/‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô)');
    return det.descriptor; // Float32Array(128)
  }

  async function onDetectFace(){
    const hint=$('faceHint');
    try{
      if(!facePhotoBase64){
        // if file input selected, read it
        const fi=$('empPhoto');
        if(fi && fi.files && fi.files[0]){
          facePhotoBase64 = await fileToBase64(fi.files[0]);
          updatePreviewFromBase64(facePhotoBase64);
        }
      }
      if(!facePhotoBase64) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô');

      setBadge($('faceDescStatus'),'warn','Descriptor: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‚Ä¶');
      hint.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Ä¶';

      faceDescriptor = await createDescriptorFromImage(facePhotoBase64);
      setBadge($('faceDescStatus'),'ok','Descriptor: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      hint.textContent='‡∏™‡∏£‡πâ‡∏≤‡∏á Descriptor ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)';
    }catch(err){
      console.error(err);
      faceDescriptor=null;
      setBadge($('faceDescStatus'),'bad','Descriptor: ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      hint.textContent = err.message;
    }
  }

  async function openCamera(){
    const wrap=$('faceVideoWrap'), video=$('faceVideo');
    try{
      // back camera on mobile if possible
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'user' }, width: { ideal: 1280 }, height: { ideal: 720 } },
        audio: false
      });
      video.srcObject = camStream;
      wrap.style.display='block';
      $('btnCapture').disabled=false;
      $('btnCloseCam').disabled=false;
      $('btnOpenCam').disabled=true;
    }catch(err){
      alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  function closeCamera(){
    const wrap=$('faceVideoWrap'), video=$('faceVideo');
    if(camStream){
      camStream.getTracks().forEach(t=>t.stop());
      camStream=null;
    }
    video.srcObject=null;
    wrap.style.display='none';
    $('btnCapture').disabled=true;
    $('btnCloseCam').disabled=true;
    $('btnOpenCam').disabled=false;
  }

  function captureFromCamera(){
    const video=$('faceVideo'), canvas=$('faceCanvas');
    if(!video || !canvas) return;

    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    // compress a bit
    facePhotoBase64 = canvas.toDataURL('image/jpeg', 0.88);
    updatePreviewFromBase64(facePhotoBase64);

    // reset descriptor (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà)
    faceDescriptor=null;
    setBadge($('faceDescStatus'),'warn','Descriptor: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ');
    $('faceHint').textContent='‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏Å‡∏î ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡∏™‡∏£‡πâ‡∏≤‡∏á Descriptor‚Äù ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
  }

  /************************************************************
   * INIT ADMIN
   ************************************************************/
  async function initAdmin(){
    const apiUrl=getApiUrl();
    $('apiUrlDisplay').textContent = apiUrl ? ('API: '+apiUrl) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
    if(!apiUrl){ setConnectionStatus(false,'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL'); openUrlCard(); return; }

    try{
      // load initial data
      const now=new Date();
      const y=now.getFullYear(); const m=now.getMonth()+1;

      const [empRes, blRes, todaySummary, monthSummary] = await Promise.all([
        api.call('getEmployees'),
        api.call('getBranchesLevels'),
        api.call('getTodaySummary'),
        api.call('getSummaryRange', { year: y, month: m, branch: 'ALL' })
      ]);

      employees = empRes || [];
      branches  = (blRes && blRes.branches) || [];
      levels    = (blRes && blRes.levels) || [];

      setConnectionStatus(true,'‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

      renderBranchLevelSelects();
      renderEmployeesTable();
      renderBranchesLevelsTables();
      renderDashboard(todaySummary, monthSummary);

      fillYearMonthSelect($('logYearFilter'), $('logMonthFilter'));
      fillYearMonthSelect($('sumYearFilter'), $('sumMonthFilter'));

      await reloadLogs();
      await reloadSummary();

    }catch(err){
      console.error(err);
      setConnectionStatus(false, err.message);
      alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
    }
  }

  /************************************************************
   * DRAWER (mobile)
   ************************************************************/
  function openDrawer(){
    $('drawer').classList.add('show');
    $('drawerBackdrop').classList.add('show');
  }
  function closeDrawer(){
    $('drawer').classList.remove('show');
    $('drawerBackdrop').classList.remove('show');
  }

  /************************************************************
   * EVENTS
   ************************************************************/
  document.addEventListener('DOMContentLoaded', async () => {
    // nav (desktop + drawer)
    document.querySelectorAll('.nav-item').forEach(el=>{
      el.addEventListener('click', ()=>{
        const sec=el.getAttribute('data-section');
        switchSection(sec);
        closeDrawer();
      });
    });
    // mobile nav
    document.querySelectorAll('.mobile-nav-item').forEach(el=>{
      el.addEventListener('click', ()=>{
        const sec=el.getAttribute('data-section');
        switchSection(sec);
      });
    });

    // drawer
    $('btnOpenDrawer').addEventListener('click', openDrawer);
    $('drawerBackdrop').addEventListener('click', closeDrawer);

    // URL
    $('btnSetUrl').addEventListener('click', openUrlCard);
    $('btnSaveUrl').addEventListener('click', saveUrl);
    $('btnCancelUrl').addEventListener('click', closeUrlCard);

    // back + logout (desktop + drawer)
    const goFront = () => window.location.href='index.html';
    $('btnBackToFront').addEventListener('click', goFront);
    $('btnBackToFront2').addEventListener('click', goFront);

    const doLogout = () => {
      if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡∏ö URL API ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        setApiUrl('');
        window.location.href='index.html';
      }
    };
    $('btnLogout').addEventListener('click', doLogout);
    $('btnLogout2').addEventListener('click', doLogout);

    // employees
    $('empSearch').addEventListener('input', renderEmployeesTable);
    $('btnSaveEmployee').addEventListener('click', saveEmployee);
    $('btnResetEmpForm').addEventListener('click', resetEmpForm);

    // photo input -> preview + reset descriptor
    $('empPhoto').addEventListener('change', async ()=>{
      const f = $('empPhoto').files && $('empPhoto').files[0];
      if(!f){
        updatePreviewFromBase64('');
        facePhotoBase64='';
        faceDescriptor=null;
        setBadge($('faceDescStatus'),'warn','Descriptor: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ');
        return;
      }
      facePhotoBase64 = await fileToBase64(f);
      updatePreviewFromBase64(facePhotoBase64);
      faceDescriptor=null;
      setBadge($('faceDescStatus'),'warn','Descriptor: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ');
      $('faceHint').textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏Å‡∏î ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡∏™‡∏£‡πâ‡∏≤‡∏á Descriptor‚Äù ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
    });

    // face actions
    $('btnOpenCam').addEventListener('click', openCamera);
    $('btnCloseCam').addEventListener('click', closeCamera);
    $('btnCapture').addEventListener('click', captureFromCamera);
    $('btnDetectFace').addEventListener('click', onDetectFace);
    $('btnClearFace').addEventListener('click', ()=>clearFaceState(true));

    // logs + summary
    $('btnReloadLogs').addEventListener('click', reloadLogs);
    $('logSearch').addEventListener('keydown', e=>{ if(e.key==='Enter') reloadLogs(); });
    $('btnReloadSummary').addEventListener('click', reloadSummary);

    // dashboard quick
    $('btnRefreshDashboard').addEventListener('click', initAdmin);
    $('btnQuickGoLogs').addEventListener('click', ()=>switchSection('logs'));

    // settings
    $('btnAddBranch').addEventListener('click', addBranch);
    $('btnAddLevel').addEventListener('click', addLevel);

    // init
    initAdmin();

    // load face models after UI ready
    // (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ feature face ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏£‡∏∞‡∏ö‡∏ö)
    setTimeout(loadFaceModels, 250);
  });

  // Safety: stop camera when leaving page
  window.addEventListener('beforeunload', ()=>{ try{ closeCamera(); }catch(e){} });
</script>
</body>
</html>

