<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HRM Admin ‚Ä¢ Attendance + Leave</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#16a34a;
      --amber:#f59e0b;
      --red:#ef4444;

      --shadow: 0 10px 24px rgba(15,23,42,.08);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Prompt", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", sans-serif;
      background: linear-gradient(180deg,#f8fafc 0%, #f6f8fb 55%, #f6f8fb 100%);
      color:var(--text);
    }
    a{ color:inherit; text-decoration:none; }
    button, input, select, textarea{ font:inherit; }
    .app{
      min-height:100%;
      display:grid;
      grid-template-columns: 280px 1fr;
    }

    /* Sidebar */
    .sidebar{
      position:sticky; top:0; height:100vh;
      background: rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-right:1px solid var(--border);
      padding:18px 14px;
      display:flex; flex-direction:column; gap:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(2,6,23,.05);
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg,var(--blue),var(--blue2));
      display:grid; place-items:center; color:#fff; font-weight:800;
      letter-spacing:.5px;
    }
    .brand h1{
      margin:0; font-size:14px; line-height:1.15;
    }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .side-meta{
      padding:10px 12px;
      border:1px dashed var(--border);
      border-radius:14px;
      background: #fff;
    }
    .meta-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .meta-row + .meta-row{ margin-top:8px; }
    .meta-k{ font-size:12px; color:var(--muted); }
    .meta-v{
      font-size:12px;
      color:var(--text);
      max-width:160px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      cursor:pointer;
    }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      user-select:none;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: #cbd5e1;
    }
    .badge.ok{ color:var(--green); border-color:rgba(22,163,74,.25); background: rgba(22,163,74,.06); }
    .badge.ok .dot{ background: var(--green); }
    .badge.bad{ color:var(--red); border-color:rgba(239,68,68,.25); background: rgba(239,68,68,.06); }
    .badge.bad .dot{ background: var(--red); }
    .badge.warn{ color:var(--amber); border-color:rgba(245,158,11,.25); background: rgba(245,158,11,.07); }
    .badge.warn .dot{ background: var(--amber); }

    .nav{
      display:flex; flex-direction:column; gap:6px;
    }
    .nav button{
      width:100%;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      text-align:left;
    }
    .nav button:hover{ background: rgba(37,99,235,.06); }
    .nav button.active{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.20);
    }
    .ico{
      width:18px; height:18px; flex:0 0 18px;
      display:inline-block;
    }
    .nav small{ color:var(--muted); font-size:12px; margin-left:auto; }

    .side-actions{
      margin-top:auto;
      display:flex; flex-direction:column; gap:10px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{ background:#f8fafc; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(135deg,var(--blue),var(--blue2)); color:#fff; border-color: transparent; }
    .btn.primary:hover{ filter: brightness(1.03); }
    .btn.danger{ background: rgba(239,68,68,.08); color:#b91c1c; border-color: rgba(239,68,68,.25); }
    .btn.ghost{ background: transparent; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    /* Main */
    .main{
      padding:18px;
    }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      margin-bottom:14px;
    }
    .title h2{ margin:0; font-size:18px; }
    .title p{ margin:6px 0 0; color:var(--muted); font-size:13px; }
    .top-actions{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .panel{
      background: #fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .panel-head h3{
      margin:0;
      font-size:14px;
    }
    .panel-head .right{
      display:flex; align-items:center; gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .panel-body{ padding:14px; }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .grid.two{ grid-template-columns: 1fr 1fr; }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:fixed; left:0; top:0; z-index:40; transform: translateX(-110%); transition: transform .2s ease; width: 86vw; max-width:320px; }
      .sidebar.open{ transform: translateX(0); }
      .main{ padding:14px; padding-bottom:80px; }
      .mobilebar{
        position:fixed; left:12px; right:12px; bottom:12px;
        z-index:30;
        background: rgba(255,255,255,.92);
        border:1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding:10px;
        display:flex; align-items:center; justify-content:space-between; gap:8px;
        backdrop-filter: blur(10px);
      }
      .mobilebar .mini{
        display:flex; align-items:center; gap:8px;
      }
      .mobilebar .mini .pill{
        border:1px solid var(--border);
        border-radius:999px;
        padding:7px 10px;
        font-size:12px;
        background:#fff;
      }
      .mobilebar button{ border-radius:14px; }
    }
    @media (min-width: 981px){
      .mobilebar{ display:none; }
    }

    /* Controls */
    .controls{
      display:flex; gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .controls .field{
      display:flex; flex-direction:column; gap:6px;
      min-width:160px;
    }
    .controls label{
      font-size:12px; color:var(--muted);
    }
    .controls input, .controls select{
      height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      padding:0 12px;
      background:#fff;
      outline:none;
    }
    .controls input:focus, .controls select:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    /* Tables */
    .table-wrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 14px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 760px;
      background:#fff;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      font-size:13px;
      vertical-align:top;
    }
    th{
      font-size:12px;
      color: var(--muted);
      text-align:left;
      background: #f8fafc;
      position:sticky; top:0;
      z-index:1;
    }
    tr:hover td{ background: rgba(2,6,23,.02); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      white-space:nowrap;
    }
    .chip.blue{ color: var(--blue2); border-color: rgba(37,99,235,.25); background: rgba(37,99,235,.06); }
    .chip.green{ color: var(--green); border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.06); }
    .chip.red{ color: #b91c1c; border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.07); }
    .chip.amber{ color: #b45309; border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.07); }

    .row-actions{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn.sm{
      padding:7px 10px;
      border-radius:12px;
      font-size:12px;
    }
    .btn.icon{
      gap:8px;
    }

    /* Segmented */
    .seg{
      display:flex; gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg button{
      border:1px solid var(--border);
      background:#fff;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
    }
    .seg button.active{
      color: var(--blue2);
      border-color: rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
      font-weight:600;
    }

    /* Sections */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 90px;
      z-index:50;
      background: rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      max-width: 92vw;
      display:none;
      font-size:13px;
    }

    /* Modal */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(2,6,23,.55);
      display:none;
      z-index:60;
      padding: 16px;
      align-items:center; justify-content:center;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff;
      border-radius: 18px;
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding:14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal-head h4{ margin:0; font-size:14px; }
    .modal-body{ padding:14px; }
    .modal-body p{ margin:0 0 10px; color:var(--muted); font-size:13px; }
    .modal-foot{
      padding:14px;
      border-top:1px solid var(--border);
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    textarea{
      width:100%;
      min-height: 90px;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      outline:none;
      resize: vertical;
    }
    textarea:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    /* Small helpers */
    .muted{ color:var(--muted); }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kpi .card{
      flex:1 1 220px;
      border:1px solid var(--border);
      border-radius: 16px;
      background:#fff;
      padding:12px;
      box-shadow: 0 10px 18px rgba(2,6,23,.05);
    }
    .kpi .card b{ font-size:18px; }
    .kpi .card span{ display:block; color:var(--muted); font-size:12px; margin-top:4px; }
  </style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">HR</div>
      <div>
        <h1>HRM Admin Panel</h1>
        <p>Attendance + Leave (GS Router)</p>
      </div>
    </div>

    <div class="side-meta">
      <div class="meta-row">
        <div class="meta-k">API</div>
        <div class="meta-v" id="apiText" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
      </div>
      <div class="meta-row">
        <div class="meta-k">HR Token</div>
        <div class="meta-v" id="tokenText" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</div>
      </div>
      <div class="meta-row">
        <div class="meta-k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
        <div class="badge warn" id="connBadge"><span class="dot"></span><span id="connText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span></div>
      </div>
      <div class="meta-row">
        <div class="meta-k">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</div>
        <div class="meta-v" id="lastUpdated">‚Äî</div>
      </div>
    </div>

    <nav class="nav">
      <button class="navbtn active" data-section="dashboard" title="‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°">
        <span class="ico">üìä</span> Dashboard <small>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
      </button>
      <button class="navbtn" data-section="leave" title="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤">
        <span class="ico">üßæ</span> Leave Approvals <small>Approve</small>
      </button>
      <button class="navbtn" data-section="employees" title="‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô">
        <span class="ico">üë•</span> Employees <small>CRUD</small>
      </button>
      
      <button class="navbtn" data-section="off" title="‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏£">
        <span class="ico">üóìÔ∏è</span> Off & Holidays
        <small>‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏¢‡∏∏‡∏î</small>
      </button>

<button class="navbtn" data-section="logs" title="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô">
        <span class="ico">üóìÔ∏è</span> Logs <small>‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</small>
      </button>
      <button class="navbtn" data-section="summary" title="‡∏™‡∏£‡∏∏‡∏õ">
        <span class="ico">üìà</span> Summary <small>‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</small>
      </button>
      <button class="navbtn" data-section="settings" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">
        <span class="ico">‚öôÔ∏è</span> Settings <small>‡∏™‡∏≤‡∏Ç‡∏≤/‡∏£‡∏∞‡∏î‡∏±‡∏ö</small>
      </button>
    </nav>

    <div class="side-actions">
      <button class="btn primary" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn" id="btnSetApi">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL</button>
      <button class="btn danger" id="btnLogout">‡∏•‡πâ‡∏≤‡∏á Token/‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button class="btn ghost" id="btnGoIndex">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div class="title">
        <h2 id="pageTitle">Dashboard</h2>
        <p id="pageHint">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Ä¢ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action</p>
      </div>
      <div class="top-actions">
        <div class="badge" id="miniBadge"><span class="dot"></span><span id="miniText">‡∏û‡∏£‡πâ‡∏≠‡∏°</span></div>
        <button class="btn" id="btnOpenSidebar" style="display:none">‡πÄ‡∏°‡∏ô‡∏π</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <section class="section active" id="section-dashboard">
      <div class="grid">
        <div class="panel">
          <div class="panel-head">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today Summary)</h3>
            <div class="right">
              <button class="btn sm" id="btnLoadToday">‡πÇ‡∏´‡∏•‡∏î/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="kpi" id="kpiWrap"></div>
            <div style="height:12px"></div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th style="min-width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th style="min-width:150px">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                    <th style="min-width:140px">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                    <th style="min-width:170px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th style="min-width:220px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏•‡∏≤</th>
                  </tr>
                </thead>
                <tbody id="todayTbody">
                  <tr><td colspan="7" class="muted">‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:10px;font-size:12px">
              *‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">getTodaySummary</span> (public)
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- LEAVE -->
    <section class="section" id="section-leave">
      <div class="panel">
        <div class="panel-head">
          <h3>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏•‡∏≤ (Admin)</h3>
          <div class="right">
            <button class="btn sm" id="btnOpenLeavePage">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Leave (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="controls" style="margin-bottom:10px">
            <div class="field">
              <label>‡∏õ‡∏µ</label>
              <select id="leaveYear"></select>
            </div>
            <div class="field">
              <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <select id="leaveMonth"></select>
            </div>
            <div class="field" style="min-width:260px">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó/‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)</label>
              <input id="leaveSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001 / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ / ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ / 2025-12-27" />
            </div>
            <div class="field" style="min-width:220px">
              <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <div class="seg" id="leaveStatusSeg">
                <button data-st="PENDING" class="active">PENDING</button>
                <button data-st="APPROVED">APPROVED</button>
                <button data-st="REJECTED">REJECTED</button>
                <button data-st="CANCELED">CANCELED</button>
                <button data-st="ALL">ALL</button>
              </div>
            </div>
            <div class="field" style="min-width:140px">
              <label>&nbsp;</label>
              <button class="btn" id="btnReloadLeave">‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏•‡∏≤</button>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:160px">‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                  <th style="min-width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                  <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th style="min-width:150px">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th style="min-width:220px">‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏≤</th>
                  <th style="min-width:110px">‡∏£‡∏ß‡∏°</th>
                  <th style="min-width:140px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th style="min-width:240px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                </tr>
              </thead>
              <tbody id="leaveTbody">
                <tr><td colspan="8" class="muted">‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏•‡∏≤‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
              </tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px">
            *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">adminListLeaveRequests</span> / <span class="mono">adminApproveLeave</span> / <span class="mono">adminRejectLeave</span> / <span class="mono">adminCancelLeave</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token) 
          </div>
        </div>
      </div>
    </section>

    <!-- EMPLOYEES -->
    <section class="section" id="section-employees">
      <div class="panel">
        <div class="panel-head">
          <h3>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Employees)</h3>
          <div class="right">
            <button class="btn sm" id="btnAddEmp">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
            <button class="btn sm" id="btnReloadEmp">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="controls" style="margin-bottom:10px">
            <div class="field" style="min-width:280px">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠/‡∏™‡∏≤‡∏Ç‡∏≤/‡∏£‡∏∞‡∏î‡∏±‡∏ö/‡πÅ‡∏ú‡∏ô‡∏Å)</label>
              <input id="empSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001 / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ / ‡∏™‡∏≤‡∏Ç‡∏≤..." />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:90px">ID</th>
                  <th style="min-width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                  <th style="min-width:230px">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th style="min-width:160px">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                  <th style="min-width:140px">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                  <th style="min-width:160px">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                  <th style="min-width:220px">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                  <th style="min-width:230px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                </tr>
              </thead>
              <tbody id="empTbody">
                <tr><td colspan="8" class="muted">‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
              </tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px">
            *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">getEmployees</span> / <span class="mono">saveEmployee</span> / <span class="mono">deleteEmployee</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token) 
          </div>
        </div>
      </div>
    </section>


    <!-- OFF & HOLIDAYS -->
    <section class="section" id="section-off">
      <div class="grid two">
        <!-- Departments -->
        <div class="panel">
          <div class="panel-head">
            <h3>‡πÅ‡∏ú‡∏ô‡∏Å (Departments)</h3>
            <div class="right">
              <button class="btn sm" id="btnAddDept">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</button>
              <button class="btn sm" id="btnReloadDept">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:130px">deptId</th>
                    <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å</th>
                    <th style="min-width:90px">sort</th>
                    <th style="min-width:220px">note</th>
                    <th style="min-width:190px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                  </tr>
                </thead>
                <tbody id="deptTbody">
                  <tr><td colspan="5" class="muted">‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>

            <div class="muted" style="margin-top:10px;font-size:12px">
              *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">getDepartments</span> / <span class="mono">saveDepartment</span> / <span class="mono">deleteDepartment</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token)
            </div>
          </div>
        </div>

        <!-- WeeklyOff -->
        <div class="panel">
          <div class="panel-head">
            <h3>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (WeeklyOff)</h3>
            <div class="right">
              <button class="btn sm" id="btnLoadWeeklyOff">‡πÇ‡∏´‡∏•‡∏î</button>
              <button class="btn sm primary" id="btnSaveWeeklyOff">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="controls" style="margin-bottom:10px">
              <div class="field" style="min-width:180px">
                <label>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)</label>
                <input type="date" id="offWeekStart" />
              </div>
              <div class="field" style="min-width:220px">
                <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
                <select id="offDeptFilter"></select>
              </div>
              <div class="field" style="min-width:260px">
                <label>‡∏ó‡∏¥‡∏õ</label>
                <div class="muted" style="font-size:12px;line-height:1.35">
                  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‚Äù ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô (1‚Äì7 = ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </div>
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="min-width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                    <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th style="min-width:160px">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                    <th style="min-width:140px">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                    <th style="min-width:160px">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (DOW)</th>
                  </tr>
                </thead>
                <tbody id="weeklyOffTbody">
                  <tr><td colspan="5" class="muted">‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                </tbody>
              </table>
            </div>

            <div class="muted" style="margin-top:10px;font-size:12px">
              *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">adminGetWeeklyOff</span> / <span class="mono">adminSaveWeeklyOffBulk</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token)
            </div>
          </div>
        </div>
      </div>

      <!-- EmployeeOffDates -->
      <div class="panel" style="margin-top:14px">
        <div class="panel-head">
          <h3>‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (EmployeeOffDates)</h3>
          <div class="right">
            <button class="btn sm" id="btnReloadEmpOff">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="controls" style="margin-bottom:10px">
            <div class="field" style="min-width:170px">
              <label>‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="empOffFrom" />
            </div>
            <div class="field" style="min-width:170px">
              <label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="empOffTo" />
            </div>
            <div class="field" style="min-width:220px">
              <label>‡πÅ‡∏ú‡∏ô‡∏Å</label>
              <select id="empOffDeptFilter"></select>
            </div>
            <div class="field" style="min-width:220px">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)</label>
              <input id="empOffSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011 / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
            </div>
          </div>

          <div class="controls" style="margin-bottom:10px">
            <div class="field" style="min-width:170px">
              <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</label>
              <input type="date" id="empOffDate" />
            </div>
            <div class="field" style="min-width:260px">
              <label>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <select id="empOffEmpSel"></select>
            </div>
            <div class="field" style="min-width:200px">
              <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <select id="empOffKind">
                <option value="OFF">OFF (‡∏´‡∏¢‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥/‡∏´‡∏¢‡∏∏‡∏î)</option>
                <option value="PERSONAL_HOLIDAY">PERSONAL_HOLIDAY (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©)</option>
                <option value="COMP_OFF">COMP_OFF (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏î‡πÄ‡∏ä‡∏¢)</option>
                <option value="SICK_OFF">SICK_OFF (‡∏õ‡πà‡∏ß‡∏¢/‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≤‡∏î)</option>
              </select>
            </div>
            <div class="field" style="min-width:320px">
              <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input id="empOffNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡∏ò‡∏∏‡∏£‡∏∞/‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏î‡πÄ‡∏ä‡∏¢/..." />
            </div>
            <div class="field" style="min-width:140px">
              <label>&nbsp;</label>
              <button class="btn sm primary" id="btnSaveEmpOff">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©</button>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:120px">date</th>
                  <th style="min-width:110px">code</th>
                  <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th style="min-width:150px">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                  <th style="min-width:190px">kind</th>
                  <th style="min-width:260px">note</th>
                  <th style="min-width:150px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
                </tr>
              </thead>
              <tbody id="empOffTbody">
                <tr><td colspan="8" class="muted">‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
              </tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px">
            *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">adminListEmployeeOffDates</span> / <span class="mono">adminSaveEmployeeOffDate</span> / <span class="mono">adminDeleteEmployeeOffDate</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token)
          </div>
        </div>
      </div>
    </section>

    <!-- LOGS -->
    <section class="section" id="section-logs">
      <div class="panel">
        <div class="panel-head">
          <h3>Logs ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
          <div class="right">
            <button class="btn sm" id="btnReloadLogs">‡πÇ‡∏´‡∏•‡∏î Logs</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="controls" style="margin-bottom:10px">
            <div class="field">
              <label>‡∏õ‡∏µ</label>
              <select id="logsYear"></select>
            </div>
            <div class="field">
              <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <select id="logsMonth"></select>
            </div>
            <div class="field" style="min-width:200px">
              <label>‡∏™‡∏≤‡∏Ç‡∏≤</label>
              <select id="logsBranch"></select>
            </div>
            <div class="field" style="min-width:260px">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)</label>
              <input id="logsSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001 / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
            </div>
            <div class="field" style="min-width:180px">
              <label>‡∏£‡∏ß‡∏°‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏î</label>
              <select id="logsIncludeAbsents">
                <option value="1">‡∏£‡∏ß‡∏°</option>
                <option value="0">‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</option>
              </select>
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:110px">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th style="min-width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                  <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th style="min-width:160px">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                  <th style="min-width:140px">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                  <th style="min-width:90px">t1</th>
                  <th style="min-width:90px">t2</th>
                  <th style="min-width:90px">t3</th>
                  <th style="min-width:90px">t4</th>
                  <th style="min-width:180px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                </tr>
              </thead>
              <tbody id="logsTbody">
                <tr><td colspan="10" class="muted">‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î Logs‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
              </tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px">
            *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">getLogsRange</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token) 
          </div>
        </div>
      </div>
    </section>

    <!-- SUMMARY -->
    <section class="section" id="section-summary">
      <div class="panel">
        <div class="panel-head">
          <h3>Summary ‡∏™‡∏£‡∏∏‡∏õ (‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h3>
          <div class="right">
            <button class="btn sm" id="btnReloadSummary">‡πÇ‡∏´‡∏•‡∏î Summary</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="controls" style="margin-bottom:10px">
            <div class="field">
              <label>‡∏õ‡∏µ</label>
              <select id="sumYear"></select>
            </div>
            <div class="field">
              <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
              <select id="sumMonth"></select>
            </div>
            <div class="field" style="min-width:260px">
              <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠)</label>
              <input id="sumSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001 / ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:110px">‡∏£‡∏´‡∏±‡∏™</th>
                  <th style="min-width:220px">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th style="min-width:160px">‡∏™‡∏≤‡∏Ç‡∏≤</th>
                  <th style="min-width:140px">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                  <th style="min-width:110px">‡∏õ‡∏Å‡∏ï‡∏¥</th>
                  <th style="min-width:110px">‡∏™‡∏≤‡∏¢</th>
                  <th style="min-width:110px">‡∏Ç‡∏≤‡∏î</th>
                  <th style="min-width:150px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                </tr>
              </thead>
              <tbody id="sumTbody">
                <tr><td colspan="8" class="muted">‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î Summary‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
              </tbody>
            </table>
          </div>

          <div class="muted" style="margin-top:10px;font-size:12px">
            *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">getSummaryRange</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token) 
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section class="section" id="section-settings">
      <div class="grid two">
        <div class="panel">
          <div class="panel-head">
            <h3>‡∏™‡∏≤‡∏Ç‡∏≤ (Branches)</h3>
            <div class="right">
              <button class="btn sm" id="btnAddBranch">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤</button>
              <button class="btn sm" id="btnReloadBL">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-wrap">
              <table style="min-width:520px">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</th><th style="min-width:160px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th></tr></thead>
                <tbody id="branchTbody">
                  <tr><td colspan="2" class="muted">‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h3>‡∏£‡∏∞‡∏î‡∏±‡∏ö (Levels)</h3>
            <div class="right">
              <button class="btn sm" id="btnAddLevel">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="table-wrap">
              <table style="min-width:520px">
                <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th style="min-width:160px">‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th></tr></thead>
                <tbody id="levelTbody">
                  <tr><td colspan="2" class="muted">‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù</td></tr>
                </tbody>
              </table>
            </div>
            <div class="muted" style="margin-top:10px;font-size:12px">
              *‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action <span class="mono">getBranchesLevels</span> / <span class="mono">saveBranch</span> / <span class="mono">deleteBranch</span> / <span class="mono">saveLevel</span> / <span class="mono">deleteLevel</span> (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ token) 
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- MOBILE BAR -->
<div class="mobilebar" id="mobilebar">
  <div class="mini">
    <button class="btn sm" id="btnMobileMenu">‡πÄ‡∏°‡∏ô‡∏π</button>
    <div class="pill" id="mobileSection">Dashboard</div>
  </div>
  <button class="btn sm primary" id="btnMobileRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- MODAL: API URL -->
<div class="backdrop" id="apiModal">
  <div class="modal">
    <div class="modal-head">
      <h4>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL (Google Apps Script Web App)</h4>
      <button class="btn sm" data-close="apiModal">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <p>‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Web App ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <span class="mono">/exec</span> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>
      <div class="controls">
        <div class="field" style="min-width:100%">
          <label>API URL</label>
          <input id="apiInput" placeholder="https://script.google.com/macros/s/...../exec" />
        </div>
      </div>
      <div class="muted" style="margin-top:10px;font-size:12px">
        *‡∏´‡∏ô‡πâ‡∏≤ index.html / leave.html ‡πÉ‡∏ä‡πâ key ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô: <span class="mono">attendance_api_url_v2</span>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" data-close="apiModal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn primary" id="btnSaveApi">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: LOGIN -->
<div class="backdrop" id="loginModal">
  <div class="modal">
    <div class="modal-head">
      <h4>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö HR/Admin</h4>
      <button class="btn sm" data-close="loginModal">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <p>‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ token ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action ‡∏ù‡∏±‡πà‡∏á Admin (‡πÄ‡∏ä‡πà‡∏ô approve/reject ‡πÉ‡∏ö‡∏•‡∏≤)</p>
      <div class="controls">
        <div class="field" style="min-width:220px">
          <label>Username</label>
          <input id="loginUser" placeholder="‡πÄ‡∏ä‡πà‡∏ô admin" />
        </div>
        <div class="field" style="min-width:220px">
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>
      </div>
      <div id="loginErr" class="muted" style="margin-top:10px;color:#b91c1c;display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="btnClearToken2">‡∏•‡πâ‡∏≤‡∏á Token</button>
      <button class="btn primary" id="btnDoLogin">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
    </div>
  </div>
</div>

<!-- MODAL: EMP FORM -->
<div class="backdrop" id="empModal">
  <div class="modal">
    <div class="modal-head">
      <h4 id="empModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
      <button class="btn sm" data-close="empModal">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <p>Required: code, fullName (id ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà)</p>
      <div class="controls">
        <div class="field" style="min-width:160px">
          <label>ID</label>
          <input id="empId" placeholder="(auto)" />
        </div>
        <div class="field" style="min-width:160px">
          <label>Code</label>
          <input id="empCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 001" />
        </div>
        <div class="field" style="min-width:260px">
          <label>Full Name</label>
          <input id="empFullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" />
        </div>
        <div class="field" style="min-width:220px">
          <label>Branch</label>
          <select id="empBranch"></select>
        </div>
        <div class="field" style="min-width:220px">
          <label>Level</label>
          <select id="empLevel"></select>
        </div>
        
        <div class="field" style="min-width:220px">
          <label>Department</label>
          <select id="empDepartment"></select>
        </div>
<div class="field" style="min-width:260px">
          <label>Email</label>
          <input id="empEmail" placeholder="example@company.com" />
        </div>
      </div>
      <div id="empErr" class="muted" style="margin-top:10px;color:#b91c1c;display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" data-close="empModal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn primary" id="btnSaveEmp">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: LEAVE DETAIL & NOTE -->
<div class="backdrop" id="leaveModal">
  <div class="modal">
    <div class="modal-head">
      <h4 id="leaveModalTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏•‡∏≤</h4>
      <button class="btn sm" data-close="leaveModal">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <p id="leaveModalSub" class="muted"></p>
      <div id="leaveDetail" style="font-size:13px;line-height:1.55"></div>
      <div style="height:12px"></div>
      <label class="muted" style="font-size:12px">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• (adminNote / cancelReason)</label>
      <textarea id="leaveAdminNote" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea>
      <div id="leaveErr" class="muted" style="margin-top:10px;color:#b91c1c;display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" data-close="leaveModal">‡∏õ‡∏¥‡∏î</button>
      <button class="btn sm" id="btnLeaveApprove">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
      <button class="btn sm danger" id="btnLeaveReject">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
      <button class="btn sm danger" id="btnLeaveCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤</button>
    </div>
  </div>
</div>

<script>
/** =========================================
 *  Storage keys (‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö index.html)
 *  ========================================= */
const LS_API    = "attendance_api_url_v2";
const LS_HR     = "attendance_hr_token_v1";
const LS_HR_OK  = "attendance_hr_logged_v1";

/** =========================================
 *  State
 *  ========================================= */
let ACTIVE = "dashboard";
let refreshAbort = null;

let cache = {
  branchesLevels: { t:0, branches:[], levels:[] },
  leaveTypes: { t:0, map:{} },
  employees: { t:0, rows:[] },
  departments: { t:0, rows:[] },
};

let leaveState = { status: "PENDING", rows: [], selected: null };
let empState = { rows: [] };
let logsState = { rows: [] };
let sumState = { rows: [] };

/** =========================================
 *  DOM helpers
 *  ========================================= */
const $ = (id) => document.getElementById(id);

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => (el.style.display = "none"), 2600);
}

function setConn(kind, msg){
  const badge = $("connBadge");
  const text = $("connText");
  badge.classList.remove("ok","bad","warn");
  badge.classList.add(kind);
  text.textContent = msg || (kind==="ok" ? "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : kind==="bad" ? "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î" : "‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
  $("miniBadge").classList.remove("ok","bad","warn");
  $("miniBadge").classList.add(kind);
  $("miniText").textContent = msg || "‚Äî";
}

function setLastUpdated(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  const ss = String(d.getSeconds()).padStart(2,"0");
  $("lastUpdated").textContent = `${hh}:${mm}:${ss}`;
}

function getApiUrl(){ return (localStorage.getItem(LS_API) || "").trim(); }
function setApiUrl(url){ localStorage.setItem(LS_API, (url||"").trim()); }

function getToken(){ return (localStorage.getItem(LS_HR) || "").trim(); }
function setToken(t){ localStorage.setItem(LS_HR, (t||"").trim()); }
function isLogged(){ return localStorage.getItem(LS_HR_OK) === "1" && !!getToken(); }
function setLogged(ok){ localStorage.setItem(LS_HR_OK, ok ? "1" : "0"); }

function ellipsize(s, n=42){
  s = String(s||"");
  if(s.length <= n) return s;
  return s.slice(0, Math.max(10, n-12)) + "‚Ä¶" + s.slice(-10);
}

function updateMetaUI(){
  const api = getApiUrl();
  $("apiText").textContent = api ? ellipsize(api, 46) : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤";
  $("apiText").dataset.full = api || "";
  const tk = getToken();
  $("tokenText").textContent = tk ? ("‡∏°‡∏µ Token ‚úì (" + ellipsize(tk, 30) + ")") : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô";
  $("tokenText").dataset.full = tk || "";
}

/** =========================================
 *  API layer (NO random/fallback actions)
 *  - ‡∏ó‡∏∏‡∏Å call ‡∏à‡∏∞‡∏™‡πà‡∏á token ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
 *  - ‡∏°‡∏µ Abort + timeout
 *  ========================================= */
function shouldAskLoginByMessage(msg){
  const s = String(msg||"").toLowerCase();
  return s.includes("unauthor") || s.includes("permission") || s.includes("login") || s.includes("token") ||
         s.includes("‡∏™‡∏¥‡∏ó‡∏ò‡∏¥") || s.includes("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö") || s.includes("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥");
}

async function apiCall(action, params={}, opts={}){
  const apiUrl = getApiUrl();
  if(!apiUrl) throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API");
  const token = getToken();
  const payload = { action, ...params };
  if(token) payload.token = token;

  const controller = opts.signal ? null : new AbortController();
  const signal = opts.signal || controller.signal;

  const timeoutMs = opts.timeoutMs || 20000;
  let timer = null;
  if(!opts.signal){
    timer = setTimeout(() => controller.abort(new DOMException("Timeout","AbortError")), timeoutMs);
  }

  try{
    const body = new URLSearchParams(payload).toString();
    const res = await fetch(apiUrl, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body,
      signal
    });
    const text = await res.text();
    let data;
    try{ data = JSON.parse(text); }
    catch(e){
      console.error("NON-JSON:", text);
      throw new Error("API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ URL /exec ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£ Deploy)");
    }
    if(!data.ok) throw new Error(data.error || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
    return data.result;
  }finally{
    if(timer) clearTimeout(timer);
  }
}

function abortRefresh(){
  if(refreshAbort) refreshAbort.abort();
  refreshAbort = new AbortController();
  return refreshAbort.signal;
}

/** =========================================
 *  Init selects (‡∏õ‡∏µ/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
 *  ========================================= */
function fillYearMonth(yearSel, monthSel){
  const now = new Date();
  const yNow = now.getFullYear();
  const mNow = now.getMonth() + 1;

  const years = [];
  for(let y = yNow - 2; y <= yNow + 1; y++) years.push(y);

  yearSel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join("");
  monthSel.innerHTML = Array.from({length:12}, (_,i)=>i+1).map(m => `<option value="${m}">${String(m).padStart(2,'0')}</option>`).join("");

  yearSel.value = String(yNow);
  monthSel.value = String(mNow);
}

/** =========================================
 *  Load meta (branches/levels, leaveTypes) with cache
 *  ========================================= */
async function ensureBranchesLevels(signal){
  const age = Date.now() - cache.branchesLevels.t;
  if(age < 120000 && cache.branchesLevels.branches.length) return cache.branchesLevels; // 2 min
  const r = await apiCall("getBranchesLevels", {}, { signal });
  cache.branchesLevels = { t: Date.now(), branches: r.branches || [], levels: r.levels || [] };
  return cache.branchesLevels;
}

async function ensureDepartments(signal){
  const age = Date.now() - (cache.departments?.t || 0);
  if(cache.departments?.rows?.length && age < 5 * 60 * 1000) return cache.departments.rows;

  const res = await apiCall("getDepartments", {}, { signal });
  const rows = Array.isArray(res) ? res : (res?.rows || []);
  cache.departments = { t: Date.now(), rows };
  return rows;
}



async function ensureLeaveTypes(signal){
  const age = Date.now() - cache.leaveTypes.t;
  if(age < 300000 && Object.keys(cache.leaveTypes.map||{}).length) return cache.leaveTypes.map;
  const rows = await apiCall("getLeaveTypes", {}, { signal });
  const map = {};
  (rows || []).forEach(x => {
    const id = String(x.leaveTypeId || x.id || x.code || "").trim();
    if(id) map[id] = x;
  });
  cache.leaveTypes = { t: Date.now(), map };
  return map;
}

/** =========================================
 *  Section switching
 *  ========================================= */
function setSection(section){
  ACTIVE = section;
  document.querySelectorAll(".navbtn").forEach(b => b.classList.toggle("active", b.dataset.section === section));
  document.querySelectorAll(".section").forEach(s => s.classList.toggle("active", s.id === "section-" + section));
  $("mobileSection").textContent = section.charAt(0).toUpperCase() + section.slice(1);

  const titleMap = {
    dashboard: ["Dashboard", "‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‚Ä¢ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action"],
    leave: ["Leave Approvals", "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ Admin"],
    employees: ["Employees", "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (CRUD)"],
    logs: ["Logs", "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)"],
    summary: ["Summary", "‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô)"],
    off: ["Off & Holidays", "‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå + ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•"],
    settings: ["Settings", "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö"],
  };
  $("pageTitle").textContent = titleMap[section][0];
  $("pageHint").textContent = titleMap[section][1];

  // load section (lazy) ‚Äî no polling
  refreshCurrentSection(true);
}

async function refreshCurrentSection(silent=false){
  const signal = abortRefresh();

  try{
    if(ACTIVE === "dashboard") await loadToday(signal);
    if(ACTIVE === "leave") await loadLeave(signal);
    if(ACTIVE === "employees") await loadEmployees(signal);
    if(ACTIVE === "off") await loadOff(signal);
    if(ACTIVE === "logs") await loadLogs(signal);
    if(ACTIVE === "summary") await loadSummary(signal);
    if(ACTIVE === "settings") await loadSettings(signal);

    setConn("ok", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    setLastUpdated();
  }catch(err){
    if(err.name === "AbortError") return;
    console.error(err);

    if(shouldAskLoginByMessage(err.message)){
      openModal("loginModal");
      $("loginErr").style.display = "block";
      $("loginErr").textContent = "‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (token ‡∏´‡∏≤‡∏¢/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏)";
      setConn("warn", "‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
      if(!silent) toast("‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
      return;
    }

    setConn("bad", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
    if(!silent) alert("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
}

/** =========================================
 *  Dashboard (today summary)
 *  ========================================= */
function statusChip(status){
  const s = String(status||"").trim();
  const up = s.toUpperCase();
  if(!s) return `<span class="chip">‚Äî</span>`;
  if(up.includes("APPROV")) return `<span class="chip green">APPROVED</span>`;
  if(up.includes("REJECT")) return `<span class="chip red">REJECTED</span>`;
  if(up.includes("CANCEL")) return `<span class="chip red">CANCELED</span>`;
  if(up.includes("PENDING")) return `<span class="chip amber">PENDING</span>`;
  if(s === "‡∏õ‡∏Å‡∏ï‡∏¥") return `<span class="chip green">‡∏õ‡∏Å‡∏ï‡∏¥</span>`;
  if(s.includes("‡∏™‡∏≤‡∏¢")) return `<span class="chip amber">${escapeHtml(s)}</span>`;
  if(s.includes("‡∏Ç‡∏≤‡∏î")) return `<span class="chip red">${escapeHtml(s)}</span>`;
  return `<span class="chip blue">${escapeHtml(s)}</span>`;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function buildKpi(rows){
  const total = rows.length;
  let normal=0, late=0, absent=0, leave=0, other=0;
  rows.forEach(r=>{
    const st = String(r.status||"").trim();
    if(st === "‡∏õ‡∏Å‡∏ï‡∏¥") normal++;
    else if(st.includes("‡∏™‡∏≤‡∏¢")) late++;
    else if(st === "‡∏Ç‡∏≤‡∏î") absent++;
    else if(st.toUpperCase().includes("LEAVE") || st.includes("‡∏•‡∏≤")) leave++;
    else other++;
  });
  $("kpiWrap").innerHTML = [
    `<div class="card"><b>${total}</b><span>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></div>`,
    `<div class="card"><b>${normal}</b><span>‡∏õ‡∏Å‡∏ï‡∏¥</span></div>`,
    `<div class="card"><b>${late}</b><span>‡∏™‡∏≤‡∏¢/‡∏ú‡∏¥‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</span></div>`,
    `<div class="card"><b>${absent}</b><span>‡∏Ç‡∏≤‡∏î</span></div>`,
    `<div class="card"><b>${leave}</b><span>‡∏•‡∏≤/‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span></div>`
  ].join("");
}

async function loadToday(signal){
  const rows = await apiCall("getTodaySummary", {}, { signal });
  const tbody = $("todayTbody");
  const list = Array.isArray(rows) ? rows : (rows?.rows || []);
  buildKpi(list);

  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="7" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>`;
    return;
  }
  tbody.innerHTML = list.map(r=>{
    const date = escapeHtml(r.date || r.day || "");
    const code = escapeHtml(r.code || r.empCode || "");
    const name = escapeHtml(r.fullName || r.empName || "");
    const br = escapeHtml(r.branch || "");
    const lv = escapeHtml(r.level || "");
    const st = r.status || "";
    const note = escapeHtml(r.note || r.leaveText || r.leaveReason || r.rawType || "");
    return `<tr>
      <td>${date}</td>
      <td class="mono">${code}</td>
      <td>${name}</td>
      <td>${br}</td>
      <td>${lv}</td>
      <td>${statusChip(st)}</td>
      <td class="muted">${note || "-"}</td>
    </tr>`;
  }).join("");
}

/** =========================================
 *  Leave approvals
 *  ========================================= */
function leaveStatusToChip(st){
  const s = String(st||"").toUpperCase();
  if(s === "APPROVED") return `<span class="chip green">APPROVED</span>`;
  if(s === "REJECTED") return `<span class="chip red">REJECTED</span>`;
  if(s === "CANCELED") return `<span class="chip red">CANCELED</span>`;
  return `<span class="chip amber">PENDING</span>`;
}

function openLeaveModal(row){
  leaveState.selected = row;
  $("leaveModalTitle").textContent = `‡πÉ‡∏ö‡∏•‡∏≤ #${row.id || row.requestId || ""}`;
  $("leaveModalSub").textContent = `${row.empCode || ""} ‚Ä¢ ${row.empName || ""} ‚Ä¢ ${row.leaveTypeName || row.leaveTypeId || ""} ‚Ä¢ ${row.rangeText || ""}`;
  $("leaveAdminNote").value = "";
  $("leaveErr").style.display = "none";

  const lines = [];
  const keys = [
    ["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", row.status],
    ["‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠", row.submitAt || row.createdAt],
    ["‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó", row.leaveTypeName || row.leaveTypeId],
    ["‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏≤", row.rangeText],
    ["‡∏£‡∏ß‡∏°", row.totalDays || row.total || row.hours || ""],
    ["‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•", row.reason || row.note || ""],
    ["‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", row.contact || ""],
    ["‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö", row.attachmentUrl || row.evidenceUrl || ""],
    ["‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", row.actionBy || row.approverUser || ""],
    ["‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", row.actionAt || ""],
    ["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô", row.adminNote || ""],
  ];
  keys.forEach(([k,v])=>{
    if(v === undefined || v === null || v === "") return;
    if(String(k).includes("‡πÑ‡∏ü‡∏•‡πå") && v){
      lines.push(`<div><b>${escapeHtml(k)}</b>: <a href="${escapeHtml(v)}" target="_blank" rel="noopener">${escapeHtml(v)}</a></div>`);
    }else{
      lines.push(`<div><b>${escapeHtml(k)}</b>: ${escapeHtml(v)}</div>`);
    }
  });
  $("leaveDetail").innerHTML = lines.join("") || `<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>`;

  // enable/disable actions by status
  const st = String(row.status||"PENDING").toUpperCase();
  $("btnLeaveApprove").disabled = (st === "APPROVED" || st === "CANCELED");
  $("btnLeaveReject").disabled  = (st === "REJECTED" || st === "CANCELED");
  $("btnLeaveCancel").disabled  = (st === "CANCELED");
  openModal("leaveModal");
}

async function loadLeave(signal){
  const year = Number($("leaveYear").value);
  const month = Number($("leaveMonth").value);
  const search = ($("leaveSearch").value || "").trim();
  const status = leaveState.status;

  // leave types map (optional for display)
  const leaveTypes = await ensureLeaveTypes(signal);

  const res = await apiCall("adminListLeaveRequests", { year, month, status, search }, { signal });
  const rows = (res && res.rows) ? res.rows : [];
  leaveState.rows = rows;

  const tbody = $("leaveTbody");
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏•‡∏≤</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(row=>{
    const id = row.id || row.requestId || "";
    const typeId = String(row.leaveTypeId || "").trim();
    const typeName = row.leaveTypeName || leaveTypes[typeId]?.name || leaveTypes[typeId]?.leaveTypeName || typeId || "-";
    row.leaveTypeName = typeName;

    const total = row.totalDays || row.total || row.hours || row.totalHours || "-";
    const canAct = String(row.status||"PENDING").toUpperCase() !== "CANCELED";

    return `<tr>
      <td class="mono">${escapeHtml(row.createdAt || row.submitAt || "")}</td>
      <td class="mono">${escapeHtml(row.empCode || row.code || "")}</td>
      <td>${escapeHtml(row.empName || row.fullName || "")}</td>
      <td>${escapeHtml(typeName)}</td>
      <td>${escapeHtml(row.rangeText || "")}</td>
      <td class="mono">${escapeHtml(total)}</td>
      <td>${leaveStatusToChip(row.status)}</td>
      <td>
        <div class="row-actions">
          <button class="btn sm" data-leave-view="${escapeHtml(id)}">‡∏î‡∏π</button>
          <button class="btn sm" data-leave-approve="${escapeHtml(id)}" ${canAct ? "" : "disabled"}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
          <button class="btn sm danger" data-leave-reject="${escapeHtml(id)}" ${canAct ? "" : "disabled"}>‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
        </div>
      </td>
    </tr>`;
  }).join("");

  // bind buttons
  tbody.querySelectorAll("[data-leave-view]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-leave-view");
      const row = leaveState.rows.find(r => String(r.id||r.requestId||"") === String(id));
      if(row) openLeaveModal(row);
    });
  });
  tbody.querySelectorAll("[data-leave-approve]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-leave-approve");
      const row = leaveState.rows.find(r => String(r.id||r.requestId||"") === String(id));
      if(!row) return;
      openLeaveModal(row);
      $("leaveAdminNote").focus();
    });
  });
  tbody.querySelectorAll("[data-leave-reject]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-leave-reject");
      const row = leaveState.rows.find(r => String(r.id||r.requestId||"") === String(id));
      if(!row) return;
      openLeaveModal(row);
      $("leaveAdminNote").focus();
    });
  });
}

async function actLeave(action){
  const row = leaveState.selected;
  if(!row) return;
  const id = row.id || row.requestId || "";
  const note = ($("leaveAdminNote").value || "").trim();

  $("leaveErr").style.display = "none";

  try{
    if(action === "approve"){
      await apiCall("adminApproveLeave", { id, adminNote: note }, {});
      toast("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    }else if(action === "reject"){
      if(!note) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò");
      await apiCall("adminRejectLeave", { id, adminNote: note }, {});
      toast("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    }else if(action === "cancel"){
      if(!note) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å");
      await apiCall("adminCancelLeave", { id, cancelReason: note }, {});
      toast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    }
    closeModal("leaveModal");
    await loadLeave(abortRefresh()); // refresh leave only
  }catch(err){
    $("leaveErr").style.display = "block";
    $("leaveErr").textContent = err.message;
  }
}

/** =========================================
 *  Employees
 *  ========================================= */
function bindEmpModalOptions(branches, levels, departments){
  const branchSel = $("empBranch");
  const levelSel = $("empLevel");
  const deptSel = $("empDepartment");

  branchSel.innerHTML = `<option value="">‚Äî</option>` + (branches||[]).map(b => {
    const v = (b.name || b.branch || b);
    return `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`;
  }).join("");

  levelSel.innerHTML = `<option value="">‚Äî</option>` + (levels||[]).map(l => {
    const v = (l.name || l.level || l);
    return `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`;
  }).join("");

  deptSel.innerHTML = `<option value="">‚Äî</option>` + (departments||[]).map(d => {
    const v = (d.deptId || d.id || "");
    const n = (d.deptName || d.name || v);
    return `<option value="${escapeHtml(v)}">${escapeHtml(n)}${v && n && v!==n ? " ("+escapeHtml(v)+")" : ""}</option>`;
  }).join("");
}

function openEmpModal(emp){
  $("empErr").style.display = "none";
  $("empModalTitle").textContent = emp ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô";
  $("empId").value = emp?.id || "";
  $("empCode").value = emp?.code || "";
  $("empFullName").value = emp?.fullName || emp?.fullname || "";
  $("empEmail").value = emp?.email || "";

  $("empBranch").value = emp?.branch || "";
  $("empLevel").value = emp?.level || "";
  $("empDepartment").value = emp?.department || "";

  openModal("empModal");
}

async function loadEmployees(signal){
  const res = await apiCall("getEmployees", {}, { signal });
  const rows = Array.isArray(res) ? res : (res?.rows || []);
  cache.employees = { t: Date.now(), rows };
  empState.rows = rows;

  // ensure branch/level options for modal
  const bl = await ensureBranchesLevels(signal);
  const depts = await ensureDepartments(signal);
  bindEmpModalOptions(bl.branches, bl.levels, depts);

renderEmpTable();
}

function renderEmpTable(){
  const q = ($("empSearch").value || "").trim().toLowerCase();
  const tbody = $("empTbody");
  const rows = (empState.rows || []).filter(r=>{
    if(!q) return true;
    return String(r.id||"").toLowerCase().includes(q) ||
           String(r.code||"").toLowerCase().includes(q) ||
           String(r.fullName||r.fullname||"").toLowerCase().includes(q) ||
           String(r.branch||"").toLowerCase().includes(q) ||
           String(r.level||"").toLowerCase().includes(q) ||
           String(r.department||"").toLowerCase().includes(q);
  });

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r=>{
    const id = escapeHtml(r.id||"");
    return `<tr>
      <td class="mono">${id}</td>
      <td class="mono">${escapeHtml(r.code||"")}</td>
      <td>${escapeHtml(r.fullName||r.fullname||"")}</td>
      <td>${escapeHtml(r.branch||"")}</td>
      <td>${escapeHtml(r.level||"")}</td>
      <td>${escapeHtml(r.department||"")}</td>
      <td>${escapeHtml(r.email||"")}</td>
      <td>
        <div class="row-actions">
          <button class="btn sm" data-emp-edit="${id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn sm danger" data-emp-del="${id}">‡∏•‡∏ö</button>
        </div>
      </td>
    </tr>`;
  }).join("");

  tbody.querySelectorAll("[data-emp-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-emp-edit");
      const emp = empState.rows.find(x => String(x.id||"") === String(id));
      openEmpModal(emp);
    });
  });
  tbody.querySelectorAll("[data-emp-del]").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-emp-del");
      const emp = empState.rows.find(x => String(x.id||"") === String(id));
      if(!emp) return;
      if(!confirm(`‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ${emp.code} - ${emp.fullName || ""} ?`)) return;
      try{
        await apiCall("deleteEmployee", { id }, {});
        toast("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
        await loadEmployees(abortRefresh());
      }catch(err){
        alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
      }
    });
  });
}

async function saveEmp(){
  const id = ($("empId").value || "").trim();
  const code = ($("empCode").value || "").trim();
  const fullName = ($("empFullName").value || "").trim();
  const branch = $("empBranch").value || "";
  const level = $("empLevel").value || "";
  const department = $("empDepartment").value || "";
  const email = ($("empEmail").value || "").trim();

$("empErr").style.display = "none";

  try{
    if(!code || !fullName) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Code ‡πÅ‡∏•‡∏∞ Full Name");
    await apiCall("saveEmployee", { id, code, fullName, branch, level, department, email }, {});
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    closeModal("empModal");
    await loadEmployees(abortRefresh());
  }catch(err){
    $("empErr").style.display = "block";
    $("empErr").textContent = err.message;
  }
}


/** =========================================
 *  Off & Holidays (Departments / WeeklyOff / EmployeeOffDates)
 *  ========================================= */
let offState = { weeklyRows: [], empOffRows: [] };

const DOW_LABELS = {
  1: "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå",
  2: "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£",
  3: "‡∏û‡∏∏‡∏ò",
  4: "‡∏û‡∏§‡∏´‡∏±‡∏™",
  5: "‡∏®‡∏∏‡∏Å‡∏£‡πå",
  6: "‡πÄ‡∏™‡∏≤‡∏£‡πå",
  7: "‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå",
};

function mondayOf(dateStr){
  const d = dateStr ? new Date(dateStr + "T00:00:00") : new Date();
  const day = d.getDay(); // 0=Sun,1=Mon...
  const diff = (day === 0) ? -6 : (1 - day);
  d.setDate(d.getDate() + diff);
  return d.toISOString().slice(0,10);
}

function todayISO(){
  return new Date().toISOString().slice(0,10);
}

async function ensureEmployees(signal){
  const age = Date.now() - (cache.employees?.t || 0);
  if(cache.employees?.rows?.length && age < 5 * 60 * 1000) return cache.employees.rows;

  const res = await apiCall("getEmployees", {}, { signal });
  const rows = Array.isArray(res) ? res : (res?.rows || []);
  cache.employees = { t: Date.now(), rows };
  return rows;
}

function fillDeptSelect(selectEl, includeAll=true){
  if(!selectEl) return;
  const depts = (cache.departments?.rows || []);
  const opts = [];
  if(includeAll) opts.push(`<option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`);
  opts.push(`<option value="">‚Äî</option>`);
  depts.forEach(d=>{
    const id = d.deptId || d.id || "";
    const name = d.deptName || d.name || id;
    opts.push(`<option value="${escapeHtml(id)}">${escapeHtml(name)}${id && name && id!==name ? " ("+escapeHtml(id)+")" : ""}</option>`);
  });
  selectEl.innerHTML = opts.join("");
}

function fillEmpSelect(selectEl, deptId){
  if(!selectEl) return;
  const emps = (cache.employees?.rows || []);
  const filtered = deptId && deptId !== "ALL"
    ? emps.filter(e => String(e.department||"").trim() === String(deptId).trim())
    : emps;

  const opts = [`<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‚Äî</option>`];
  filtered
    .slice()
    .sort((a,b)=>String(a.code||"").localeCompare(String(b.code||"")))
    .forEach(e=>{
      const code = String(e.code||"").trim();
      if(!code) return;
      const name = String(e.fullName || e.fullname || "");
      opts.push(`<option value="${escapeHtml(code)}">${escapeHtml(code)} ‚Ä¢ ${escapeHtml(name)}</option>`);
    });
  selectEl.innerHTML = opts.join("");
}

async function loadOff(signal){
  // preload
  await ensureDepartments(signal);
  await ensureEmployees(signal);

  // defaults
  if(!$("offWeekStart").value) $("offWeekStart").value = mondayOf(todayISO());
  if(!$("empOffFrom").value || !$("empOffTo").value){
    const t = todayISO();
    $("empOffFrom").value = t.slice(0,8) + "01";
    $("empOffTo").value = t;
  }
  if(!$("empOffDate").value) $("empOffDate").value = todayISO();

  // fill selects
  fillDeptSelect($("offDeptFilter"), true);
  fillDeptSelect($("empOffDeptFilter"), true);

  // If user previously selected dept, keep it
  const savedDept = localStorage.getItem("admin_off_dept") || "ALL";
  if($("offDeptFilter").value !== savedDept) $("offDeptFilter").value = savedDept;
  if($("empOffDeptFilter").value !== savedDept) $("empOffDeptFilter").value = savedDept;

  fillEmpSelect($("empOffEmpSel"), $("empOffDeptFilter").value);

  // render dept table immediately (from cache) then refresh
  renderDeptTable(cache.departments.rows || []);
  renderWeeklyOffPlaceholder();
  renderEmpOffPlaceholder();

  // load data
  await Promise.all([
    loadDepartmentsTable(signal),
    loadWeeklyOff(signal),
    loadEmployeeOffDates(signal),
  ]);
}

function renderWeeklyOffPlaceholder(){
  const tb = $("weeklyOffTbody");
  if(tb) tb.innerHTML = `<tr><td colspan="5" class="muted">‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
}

function renderEmpOffPlaceholder(){
  const tb = $("empOffTbody");
  if(tb) tb.innerHTML = `<tr><td colspan="7" class="muted">‡∏Å‡∏î ‚Äú‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
}

async function loadDepartmentsTable(signal){
  const rows = await ensureDepartments(signal);
  renderDeptTable(rows);
}

function renderDeptTable(rows){
  const tb = $("deptTbody");
  if(!tb) return;
  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="5" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏Å</td></tr>`;
    return;
  }
  tb.innerHTML = rows.map(d=>{
    const deptId = d.deptId || d.id || "";
    const deptName = d.deptName || d.name || "";
    const sort = d.sort ?? "";
    const note = d.note || "";
    return `<tr>
      <td class="mono">${escapeHtml(deptId)}</td>
      <td>${escapeHtml(deptName)}</td>
      <td class="mono">${escapeHtml(String(sort))}</td>
      <td>${escapeHtml(note)}</td>
      <td>
        <div class="row-actions">
          <button class="btn sm" data-dept-edit="${escapeHtml(deptId)}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn sm danger" data-dept-del="${escapeHtml(deptId)}">‡∏•‡∏ö</button>
        </div>
      </td>
    </tr>`;
  }).join("");

  tb.querySelectorAll("[data-dept-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>editDepartment(btn.getAttribute("data-dept-edit")));
  });
  tb.querySelectorAll("[data-dept-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>deleteDepartment(btn.getAttribute("data-dept-del")));
  });
}

async function addDepartment(){
  const deptName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å (deptName) ?");
  if(!deptName) return;
  const deptId = prompt("‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏ú‡∏ô‡∏Å (deptId) (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥) ?", "");
  const sortStr = prompt("sort (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ?", "0");
  const note = prompt("note (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ?", "");

  await apiCall("saveDepartment", {
    deptId: (deptId||"").trim(),
    deptName: deptName.trim(),
    sort: Number(sortStr||0) || 0,
    note: (note||"").trim(),
  }, {});

  cache.departments.t = 0;
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  await loadDepartmentsTable(abortRefresh());
  // refresh selects
  fillDeptSelect($("offDeptFilter"), true);
  fillDeptSelect($("empOffDeptFilter"), true);
  // also refresh employee modal options (if already loaded)
  const bl = await ensureBranchesLevels(abortRefresh());
  const depts = await ensureDepartments(abortRefresh());
  bindEmpModalOptions(bl.branches, bl.levels, depts);
}

async function editDepartment(deptId){
  const rows = await ensureDepartments(abortRefresh());
  const cur = rows.find(r => String(r.deptId||r.id||"") === String(deptId));
  if(!cur) return;

  const deptName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å (deptName) ?", cur.deptName || "");
  if(!deptName) return;
  const sortStr = prompt("sort (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ?", String(cur.sort ?? 0));
  const note = prompt("note (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ?", cur.note || "");

  await apiCall("saveDepartment", {
    deptId: String(deptId||"").trim(),
    deptName: deptName.trim(),
    sort: Number(sortStr||0) || 0,
    note: (note||"").trim(),
  }, {});

  cache.departments.t = 0;
  toast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  await loadDepartmentsTable(abortRefresh());
  fillDeptSelect($("offDeptFilter"), true);
  fillDeptSelect($("empOffDeptFilter"), true);
}

async function deleteDepartment(deptId){
  if(!confirm(`‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å ${deptId} ?`)) return;
  await apiCall("deleteDepartment", { deptId }, {});
  cache.departments.t = 0;
  toast("‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  await loadDepartmentsTable(abortRefresh());
  fillDeptSelect($("offDeptFilter"), true);
  fillDeptSelect($("empOffDeptFilter"), true);
}

async function loadWeeklyOff(signal){
  const weekStart = ($("offWeekStart").value || "").trim() || mondayOf(todayISO());
  const department = $("offDeptFilter").value || "ALL";
  localStorage.setItem("admin_off_dept", department);

  const res = await apiCall("adminGetWeeklyOff", { weekStart, department }, { signal });
  const rows = res?.rows || [];
  offState.weeklyRows = rows;
  renderWeeklyOffTable(rows);
}

function renderWeeklyOffTable(rows){
  const tb = $("weeklyOffTbody");
  if(!tb) return;

  if(!rows || !rows.length){
    tb.innerHTML = `<tr><td colspan="5" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</td></tr>`;
    return;
  }

  tb.innerHTML = rows.map(r=>{
    const code = String(r.code||"");
    const offDow = String(r.offDow||"");
    const sel = [`<option value="">‚Äî</option>`]
      .concat([1,2,3,4,5,6,7].map(n => `<option value="${n}" ${String(n)===offDow?"selected":""}>${n} ‚Ä¢ ${DOW_LABELS[n]}</option>`))
      .join("");

    return `<tr data-weekly-code="${escapeHtml(code)}" data-weekly-dept="${escapeHtml(r.department||"")}">
      <td class="mono">${escapeHtml(code)}</td>
      <td>${escapeHtml(r.fullName||"")}</td>
      <td>${escapeHtml(r.branch||"")}</td>
      <td>${escapeHtml(r.department||"")}</td>
      <td>
        <select class="weeklyOffSel">${sel}</select>
      </td>
    </tr>`;
  }).join("");
}

async function saveWeeklyOff(){
  const weekStart = ($("offWeekStart").value || "").trim() || mondayOf(todayISO());

  const rows = Array.from($("weeklyOffTbody").querySelectorAll("tr[data-weekly-code]")).map(tr=>{
    const code = tr.getAttribute("data-weekly-code");
    const department = tr.getAttribute("data-weekly-dept") || "";
    const offDow = tr.querySelector(".weeklyOffSel")?.value || "";
    return { code, department, offDow };
  });

  await apiCall("adminSaveWeeklyOffBulk", { weekStart, items: JSON.stringify(rows) }, {});
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  await loadWeeklyOff(abortRefresh());
}

async function loadEmployeeOffDates(signal){
  const dateFrom = ($("empOffFrom").value || "").trim();
  const dateTo = ($("empOffTo").value || "").trim();
  const department = $("empOffDeptFilter").value || "";
  localStorage.setItem("admin_off_dept", $("empOffDeptFilter").value || "ALL");

  const params = { dateFrom, dateTo };
  if(department && department !== "ALL") params.department = department;

  const res = await apiCall("adminListEmployeeOffDates", params, { signal });
  const rows = res?.rows || [];
  offState.empOffRows = rows;

  renderEmpOffTable(rows);
}

function renderEmpOffTable(rows){
  const tb = $("empOffTbody");
  if(!tb) return;

  const emps = cache.employees?.rows || [];
  const map = {};
  emps.forEach(e=>{
    const c = String(e.code||"").trim();
    if(c) map[c] = e;
  });

  const q = ($("empOffSearch").value || "").trim().toLowerCase();
  const filtered = !q ? rows : rows.filter(r=>{
    const code = String(r.code||"").toLowerCase();
    const emp = map[String(r.code||"")] || {};
    const name = String(emp.fullName || emp.fullname || "").toLowerCase();
    return code.includes(q) || name.includes(q);
  });

  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="7" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</td></tr>`;
    return;
  }

  tb.innerHTML = filtered.map(r=>{
    const emp = map[String(r.code||"")] || {};
    const name = emp.fullName || emp.fullname || "";
    const dept = emp.department || "";
    return `<tr data-offdate-date="${escapeHtml(r.date||"")}" data-offdate-code="${escapeHtml(r.code||"")}">
      <td class="mono">${escapeHtml(r.date||"")}</td>
      <td class="mono">${escapeHtml(r.code||"")}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(dept)}</td>
      <td>${escapeHtml(r.label || r.kind || "")}</td>
      <td>${escapeHtml(r.note || "")}</td>
      <td>
        <div class="row-actions">
          <button class="btn sm" data-offdate-edit="1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          <button class="btn sm danger" data-offdate-del="1">‡∏•‡∏ö</button>
        </div>
      </td>
    </tr>`;
  }).join("");

  tb.querySelectorAll("[data-offdate-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tr = btn.closest("tr");
      if(!tr) return;
      const date = tr.getAttribute("data-offdate-date");
      const code = tr.getAttribute("data-offdate-code");
      deleteEmployeeOffDate(date, code);
    });
  });
  tb.querySelectorAll("[data-offdate-edit]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tr = btn.closest("tr");
      if(!tr) return;
      const date = tr.getAttribute("data-offdate-date");
      const code = tr.getAttribute("data-offdate-code");
      editEmployeeOffDate(date, code);
    });
  });
}

async function saveEmployeeOffDate(){
  const date = ($("empOffDate").value || "").trim();
  const code = ($("empOffEmpSel").value || "").trim();
  const kind = ($("empOffKind").value || "OFF").trim();
  const note = ($("empOffNote").value || "").trim();

  if(!date) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "warn");
  if(!code) return toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", "warn");

  await apiCall("adminSaveEmployeeOffDate", { date, code, kind, note }, {});
  toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  await loadEmployeeOffDates(abortRefresh());
}

async function editEmployeeOffDate(date, code){
  const res = await apiCall("adminListEmployeeOffDates", { dateFrom: date, dateTo: date, code }, {});
  const row = (res?.rows || [])[0];
  $("empOffDate").value = date;
  $("empOffEmpSel").value = code;
  if(row?.kind) $("empOffKind").value = row.kind;
  $("empOffNote").value = row?.note || "";
  toast("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‚Äù", "ok");
}

async function deleteEmployeeOffDate(date, code){
  if(!confirm(`‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ${code} @ ${date} ?`)) return;
  await apiCall("adminDeleteEmployeeOffDate", { date, code }, {});
  toast("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  await loadEmployeeOffDates(abortRefresh());
}

function wireOffEvents(){
  $("btnReloadDept")?.addEventListener("click", ()=>loadDepartmentsTable(abortRefresh()));
  $("btnAddDept")?.addEventListener("click", async ()=>{
    try{
      await addDepartment();
    }catch(err){
      toast(err.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "warn");
    }
  });

  $("btnLoadWeeklyOff")?.addEventListener("click", ()=>loadWeeklyOff(abortRefresh()));
  $("btnSaveWeeklyOff")?.addEventListener("click", async ()=>{
    try{
      await saveWeeklyOff();
    }catch(err){
      toast(err.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "warn");
    }
  });

  $("offDeptFilter")?.addEventListener("change", ()=>loadWeeklyOff(abortRefresh()));
  $("offWeekStart")?.addEventListener("change", ()=>loadWeeklyOff(abortRefresh()));

  $("btnReloadEmpOff")?.addEventListener("click", ()=>loadEmployeeOffDates(abortRefresh()));
  $("empOffDeptFilter")?.addEventListener("change", ()=>{
    const dept = $("empOffDeptFilter").value;
    fillEmpSelect($("empOffEmpSel"), dept);
    loadEmployeeOffDates(abortRefresh());
  });
  $("empOffSearch")?.addEventListener("input", ()=>renderEmpOffTable(offState.empOffRows));
  $("empOffFrom")?.addEventListener("change", ()=>loadEmployeeOffDates(abortRefresh()));
  $("empOffTo")?.addEventListener("change", ()=>loadEmployeeOffDates(abortRefresh()));

  $("btnSaveEmpOff")?.addEventListener("click", async ()=>{
    try{
      await saveEmployeeOffDate();
    }catch(err){
      toast(err.message || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "warn");
    }
  });
}


/** =========================================
 *  Logs
 *  ========================================= */
async function loadLogs(signal){
  const y = Number($("logsYear").value);
  const m = Number($("logsMonth").value);
  const branch = $("logsBranch").value || "ALL";
  const search = ($("logsSearch").value || "").trim();
  const includeAbsents = $("logsIncludeAbsents").value;

  const res = await apiCall("getLogsRange", { year:y, month:m, branch, search, includeAbsents }, { signal });
  const rows = (res && res.rows) ? res.rows : [];
  logsState.rows = rows;

  const tbody = $("logsTbody");
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="10" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r=>{
    return `<tr>
      <td class="mono">${escapeHtml(r.date||"")}</td>
      <td class="mono">${escapeHtml(r.code||"")}</td>
      <td>${escapeHtml(r.fullName||"")}</td>
      <td>${escapeHtml(r.branch||"")}</td>
      <td>${escapeHtml(r.level||"")}</td>
      <td class="mono">${escapeHtml(r.t1||"")}</td>
      <td class="mono">${escapeHtml(r.t2||"")}</td>
      <td class="mono">${escapeHtml(r.t3||"")}</td>
      <td class="mono">${escapeHtml(r.t4||"")}</td>
      <td>${statusChip(r.status||"")}</td>
    </tr>`;
  }).join("");
}

/** =========================================
 *  Summary
 *  ========================================= */
async function loadSummary(signal){
  const y = Number($("sumYear").value);
  const m = Number($("sumMonth").value);
  const search = ($("sumSearch").value || "").trim();

  const res = await apiCall("getSummaryRange", { year:y, month:m, search }, { signal });
  const rows = (res && res.rows) ? res.rows : [];
  sumState.rows = rows;

  const tbody = $("sumTbody");
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="8" class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r=>{
    return `<tr>
      <td class="mono">${escapeHtml(r.code||"")}</td>
      <td>${escapeHtml(r.fullName||"")}</td>
      <td>${escapeHtml(r.branch||"")}</td>
      <td>${escapeHtml(r.level||"")}</td>
      <td class="mono">${escapeHtml(r.normalCount ?? r.normal ?? r.ok ?? r.present ?? 0)}</td>
      <td class="mono">${escapeHtml(r.lateCount ?? r.late ?? 0)}</td>
      <td class="mono">${escapeHtml(r.absentCount ?? r.absent ?? 0)}</td>
      <td class="muted">${escapeHtml(r.issuePoints ?? r.note ?? "")}</td>
    </tr>`;
  }).join("");
}

/** =========================================
 *  Settings (branches/levels)
 *  ========================================= */
async function loadSettings(signal){
  const bl = await ensureBranchesLevels(signal);

  // fill branch select for logs
  const branchSelect = $("logsBranch");
  const options = ['ALL', ...(bl.branches || []).map(b => (b.name || b.branch || b))];
  branchSelect.innerHTML = options.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");

  // render lists
  renderBranchLevel(bl.branches || [], bl.levels || []);
}

function renderBranchLevel(branches, levels){
  const bt = $("branchTbody");
  if(!branches.length){
    bt.innerHTML = `<tr><td colspan="2" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤</td></tr>`;
  }else{
    bt.innerHTML = branches.map(b=>{
      const name = escapeHtml(b.name || b.branch || b);
      return `<tr>
        <td>${name}</td>
        <td>
          <button class="btn sm danger" data-del-branch="${name}">‡∏•‡∏ö</button>
        </td>
      </tr>`;
    }).join("");
    bt.querySelectorAll("[data-del-branch]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const name = btn.getAttribute("data-del-branch");
        if(!confirm(`‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ "${name}" ?`)) return;
        try{
          await apiCall("deleteBranch", { name }, {});
          toast("‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
          cache.branchesLevels.t = 0;
          await loadSettings(abortRefresh());
        }catch(err){
          alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        }
      });
    });
  }

  const lt = $("levelTbody");
  if(!levels.length){
    lt.innerHTML = `<tr><td colspan="2" class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>`;
  }else{
    lt.innerHTML = levels.map(l=>{
      const name = escapeHtml(l.name || l.level || l);
      return `<tr>
        <td>${name}</td>
        <td>
          <button class="btn sm danger" data-del-level="${name}">‡∏•‡∏ö</button>
        </td>
      </tr>`;
    }).join("");
    lt.querySelectorAll("[data-del-level]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const name = btn.getAttribute("data-del-level");
        if(!confirm(`‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö "${name}" ?`)) return;
        try{
          await apiCall("deleteLevel", { name }, {});
          toast("‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
          cache.branchesLevels.t = 0;
          await loadSettings(abortRefresh());
        }catch(err){
          alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        }
      });
    });
  }

  // also update employee modal selects if open
  bindEmpModalOptions(branches, levels);
}

async function addBranch(){
  const name = prompt("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤: ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤");
  if(!name) return;
  try{
    await apiCall("saveBranch", { name: name.trim() }, {});
    toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    cache.branchesLevels.t = 0;
    await loadSettings(abortRefresh());
  }catch(err){
    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
}

async function addLevel(){
  const name = prompt("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö: ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö");
  if(!name) return;
  try{
    await apiCall("saveLevel", { name: name.trim() }, {});
    toast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    cache.branchesLevels.t = 0;
    await loadSettings(abortRefresh());
  }catch(err){
    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
}

/** =========================================
 *  Modal helpers
 *  ========================================= */
function openModal(id){
  const el = $(id);
  el.style.display = "flex";
  el.setAttribute("aria-hidden","false");
}
function closeModal(id){
  const el = $(id);
  el.style.display = "none";
  el.setAttribute("aria-hidden","true");
}
document.querySelectorAll("[data-close]").forEach(btn=>{
  btn.addEventListener("click", ()=> closeModal(btn.getAttribute("data-close")));
});
document.querySelectorAll(".backdrop").forEach(bg=>{
  bg.addEventListener("click", (e)=>{
    if(e.target === bg) closeModal(bg.id);
  });
});

/** =========================================
 *  Login flow
 *  ========================================= */
async function doLogin(){
  const u = ($("loginUser").value || "").trim();
  const p = ($("loginPass").value || "").trim();
  $("loginErr").style.display = "none";
  try{
    if(!u || !p) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username/Password");
    const res = await apiCall("loginAdmin", { username:u, password:p }, { timeoutMs: 20000 });
    const token = res?.token || "";
    if(!token) throw new Error("loginAdmin ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á token ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤");
    setToken(token);
    setLogged(true);
    updateMetaUI();
    closeModal("loginModal");
    toast("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    await refreshCurrentSection(true);
  }catch(err){
    $("loginErr").style.display = "block";
    $("loginErr").textContent = "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
  }
}

function doLogout(){
  setToken("");
  setLogged(false);
  updateMetaUI();
  toast("‡∏•‡πâ‡∏≤‡∏á Token ‡πÅ‡∏•‡πâ‡∏ß");
  setConn("warn","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô");
}

/** =========================================
 *  Events
 *  ========================================= */
function wireEvents(){
  // nav
  document.querySelectorAll(".navbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setSection(btn.dataset.section));
  });

  // copy api / token
  $("apiText").addEventListener("click", ()=>{
    openModal("apiModal");
    $("apiInput").value = getApiUrl();
  });
  $("tokenText").addEventListener("click", ()=>{
    const tk = getToken();
    if(!tk) return toast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Token");
    navigator.clipboard?.writeText(tk).then(()=>toast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Token ‡πÅ‡∏•‡πâ‡∏ß")).catch(()=>toast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"));
  });

  // sidebar/mobile
  const sidebar = $("sidebar");
  const openSide = ()=>{
    sidebar.classList.add("open");
  };
  const closeSide = ()=>{
    sidebar.classList.remove("open");
  };
  $("btnMobileMenu").addEventListener("click", openSide);
  $("btnOpenSidebar").addEventListener("click", openSide);
  $("mobilebar").addEventListener("click", (e)=>{
    // tap outside buttons -> close
    if(e.target.id === "mobilebar") closeSide();
  });
  // click outside sidebar on mobile to close
  document.addEventListener("click", (e)=>{
    if(window.innerWidth > 980) return;
    if(!sidebar.classList.contains("open")) return;
    const inside = sidebar.contains(e.target) || e.target === $("btnMobileMenu") || e.target === $("btnOpenSidebar");
    if(!inside) closeSide();
  });

  // refresh buttons
  $("btnRefresh").addEventListener("click", ()=> refreshCurrentSection());
  $("btnMobileRefresh").addEventListener("click", ()=> refreshCurrentSection());
  $("btnLoadToday").addEventListener("click", ()=> loadToday(abortRefresh()).then(()=>{ setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); setLastUpdated(); }).catch(()=>{}));

  // api modal
  $("btnSetApi").addEventListener("click", ()=>{
    openModal("apiModal");
    $("apiInput").value = getApiUrl();
  });
  $("btnSaveApi").addEventListener("click", ()=>{
    const url = ($("apiInput").value || "").trim();
    if(!url) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL");
    setApiUrl(url);
    updateMetaUI();
    closeModal("apiModal");
    toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
    refreshCurrentSection(true);
  });

  // login modal
  $("btnDoLogin").addEventListener("click", doLogin);
  $("btnClearToken2").addEventListener("click", doLogout);

  // logout + navigation
  $("btnLogout").addEventListener("click", doLogout);
  $("btnGoIndex").addEventListener("click", ()=> location.href = "./index.html");

  // Leave
  $("btnOpenLeavePage").addEventListener("click", ()=> location.href = "./leave.html");
  $("btnReloadLeave").addEventListener("click", ()=> loadLeave(abortRefresh()).then(()=>{ setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); setLastUpdated(); }).catch(()=>{}));
  $("leaveSearch").addEventListener("keydown", (e)=>{ if(e.key === "Enter") $("btnReloadLeave").click(); });
  $("leaveYear").addEventListener("change", ()=> $("btnReloadLeave").click());
  $("leaveMonth").addEventListener("change", ()=> $("btnReloadLeave").click());

  $("leaveStatusSeg").querySelectorAll("button").forEach(b=>{
    b.addEventListener("click", ()=>{
      $("leaveStatusSeg").querySelectorAll("button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      leaveState.status = b.dataset.st;
      $("btnReloadLeave").click();
    });
  });

  $("btnLeaveApprove").addEventListener("click", ()=> actLeave("approve"));
  $("btnLeaveReject").addEventListener("click", ()=> actLeave("reject"));
  $("btnLeaveCancel").addEventListener("click", ()=>{
    if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤‡∏ô‡∏µ‡πâ?")) return;
    actLeave("cancel");
  });

  // Employees
  $("btnReloadEmp").addEventListener("click", ()=> loadEmployees(abortRefresh()).then(()=>{ setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); setLastUpdated(); }).catch(()=>{}));
  $("btnAddEmp").addEventListener("click", async ()=>{
    const bl = await ensureBranchesLevels(abortRefresh());
    bindEmpModalOptions(bl.branches, bl.levels);
    openEmpModal(null);
  });
  $("btnSaveEmp").addEventListener("click", saveEmp);
  $("empSearch").addEventListener("input", renderEmpTable);

  // Logs
  $("btnReloadLogs").addEventListener("click", ()=> loadLogs(abortRefresh()).then(()=>{ setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); setLastUpdated(); }).catch(()=>{}));
  ["logsYear","logsMonth","logsBranch","logsIncludeAbsents"].forEach(id=>{
    $(id).addEventListener("change", ()=> $("btnReloadLogs").click());
  });
  $("logsSearch").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnReloadLogs").click(); });

  // Summary
  $("btnReloadSummary").addEventListener("click", ()=> loadSummary(abortRefresh()).then(()=>{ setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); setLastUpdated(); }).catch(()=>{}));
  ["sumYear","sumMonth"].forEach(id=>{
    $(id).addEventListener("change", ()=> $("btnReloadSummary").click());
  });
  $("sumSearch").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnReloadSummary").click(); });

  // Settings
  $("btnReloadBL").addEventListener("click", ()=> loadSettings(abortRefresh()).then(()=>{ setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); setLastUpdated(); }).catch(()=>{}));
  $("btnAddBranch").addEventListener("click", addBranch);
  $("btnAddLevel").addEventListener("click", addLevel);

  // Visibility refresh (one-shot)
  document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState === "visible") refreshCurrentSection(true);
  });
  wireOffEvents();

  window.addEventListener("focus", ()=> refreshCurrentSection(true));
}

/** =========================================
 *  Boot
 *  ========================================= */
(function boot(){
  // show mobile menu button on small screens
  function updateMobileBtn(){
    $("btnOpenSidebar").style.display = (window.innerWidth <= 980) ? "inline-flex" : "none";
  }
  window.addEventListener("resize", updateMobileBtn);
  updateMobileBtn();

  // init year/month selects
  fillYearMonth($("leaveYear"), $("leaveMonth"));
  fillYearMonth($("logsYear"), $("logsMonth"));
  fillYearMonth($("sumYear"), $("sumMonth"));

  // defaults
  updateMetaUI();
  setConn("warn", "‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");

  // Wire events
  wireEvents();

  // If no API URL -> open modal now
  if(!getApiUrl()){
    openModal("apiModal");
    $("apiInput").value = "";
    toast("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  // If not logged -> still allow dashboard (public), but other sections require token
  // We'll preload dashboard only
  loadToday(abortRefresh()).then(()=>{
    setConn("ok","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    setLastUpdated();
  }).catch(err=>{
    console.error(err);
    setConn("bad","‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  });
})();
</script>

</body>
</html>
