<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --primary-soft:#dbeafe;

      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --success:#16a34a;
      --danger:#ef4444;
      --warning:#f59e0b;

      --sidebar:#020617;
      --sidebar2:#111827;

      --shadow: 0 18px 40px rgba(15,23,42,.08);
      --shadow2: 0 30px 80px rgba(15,23,42,.18);
    }

    *{ box-sizing:border-box; font-family:"Prompt",system-ui,-apple-system,"Segoe UI",sans-serif; }
    html,body{ margin:0; padding:0; width:100%; overflow-x:hidden; }
    body{
      color:var(--text);
      background:
        radial-gradient(circle at 20% 10%, #e0e7ff 0, transparent 55%),
        radial-gradient(circle at 80% 90%, #e5f5ff 0, transparent 55%),
        var(--bg);
    }

    a{ color:var(--primary); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Buttons */
    .btn{
      border:none; cursor:pointer; border-radius:999px;
      padding:10px 14px; font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition:transform .08s ease, box-shadow .08s ease, background .1s ease, opacity .1s ease;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px) scale(.99); }
    .btn:disabled{ opacity:.55; cursor:default; transform:none; }
    .btn-primary{ background:linear-gradient(135deg,var(--primary),var(--primary2)); color:#fff; box-shadow:0 14px 30px rgba(37,99,235,.25); }
    .btn-secondary{ background:#fff; border:1px solid var(--border); color:#111827; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-ghost{ background:transparent; border:1px solid rgba(148,163,184,.35); color:#cbd5e1; }
    .btn-small{ padding:7px 11px; font-size:12px; }

    /* Layout */
    .page{ display:flex; min-height:100vh; width:100%; overflow-x:hidden; }
    .sidebar{
      width:250px; flex-shrink:0;
      background:radial-gradient(circle at top, var(--sidebar2), var(--sidebar));
      color:#e5e7eb;
      padding:16px 14px;
      display:flex; flex-direction:column;
      box-shadow:10px 0 34px rgba(15,23,42,.45), 0 0 0 1px rgba(15,23,42,.55);
      position:relative; z-index:30;
    }
    .sidebar::after{
      content:""; position:absolute; inset:0;
      background:radial-gradient(circle at bottom, rgba(37,99,235,.18), transparent 62%);
      pointer-events:none;
    }
    .sidebar-header{ padding:6px 6px 16px; border-bottom:1px solid rgba(55,65,81,.9); margin-bottom:10px; position:relative; z-index:1;}
    .sidebar-title{ font-weight:800; font-size:18px; margin-bottom:2px; letter-spacing:.2px;}
    .sidebar-sub{ font-size:11px; color:#94a3b8; }
    .nav{ margin-top:12px; display:flex; flex-direction:column; gap:6px; flex:1; min-height:0; position:relative; z-index:1;}
    .nav-item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:16px;
      cursor:pointer; border:1px solid transparent;
      color:#e5e7eb; font-size:14px; font-weight:600;
      transition:background .12s ease, transform .08s ease;
    }
    .nav-item .icon{ width:22px; display:inline-flex; justify-content:center; }
    .nav-item:hover{ background:rgba(31,41,55,.85); transform:translateY(-1px); }
    .nav-item.active{
      background:rgba(15,23,42,.98);
      border-color:rgba(59,130,246,.70);
      box-shadow:0 14px 26px rgba(15,23,42,.65);
    }
    .sidebar-footer{
      padding-top:10px; border-top:1px solid rgba(55,65,81,.9);
      font-size:11px; color:#9ca3af;
      position:relative; z-index:1;
    }
    .sidebar-footer .btn{ width:100%; margin-top:8px; }

    .content{ flex:1; display:flex; flex-direction:column; min-width:0; max-width:100%; overflow-x:hidden; }

    header.topbar{
      padding:12px 18px;
      background:rgba(2,6,23,.86);
      color:#e5e7eb;
      border-bottom:1px solid rgba(15,23,42,.45);
      display:flex; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:20;
      backdrop-filter:blur(14px);
      gap:10px;
    }
    .topbar-left{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .topbar-title{ font-size:18px; font-weight:800; letter-spacing:.2px; }
    .topbar-sub{ font-size:12px; color:#94a3b8; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    #apiUrlDisplay{ cursor:pointer; word-break:break-all; overflow-wrap:anywhere; }
    .topbar-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    main.main{ padding:18px 18px 22px; }
    .main-inner{ max-width:1280px; margin:0 auto; width:100%; }

    /* Cards */
    .card{
      background:rgba(255,255,255,.92);
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:var(--shadow), 0 0 0 1px rgba(226,232,240,.92);
      border:1px solid rgba(226,232,240,.92);
      margin-bottom:14px;
      width:100%;
      overflow:hidden;
    }
    .card-header{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:12px; flex-wrap:wrap; margin-bottom:10px;
    }
    .card-title{
      font-size:15px; font-weight:800;
      display:flex; align-items:center; gap:8px;
    }
    .card-title .icon{
      width:24px; height:24px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:13px;
      background:var(--primary-soft);
      color:var(--primary);
    }
    .card-subtitle{ font-size:12px; color:var(--muted); line-height:1.5; }

    /* Inputs */
    .input{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      padding:11px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .input:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,.14);
    }
    select.input{ appearance:none; }

    .helper{ font-size:12px; color:var(--muted); }
    .mt-8{ margin-top:8px; }
    .mt-10{ margin-top:10px; }
    .mt-12{ margin-top:12px; }

    /* Status badges */
    .badge-status{ font-size:11px; padding:4px 10px; border-radius:999px; display:inline-block; font-weight:700; }
    .badge-normal{ background:#dcfce7; color:#166534; }
    .badge-late{ background:#fee2e2; color:#b91c1c; }
    .badge-absent{ background:#ffe4e6; color:#be123c; }
    .badge-other{ background:#fef3c7; color:#92400e; }
    .badge-unknown{ background:#0b1220; color:#e5e7eb; border:1px solid rgba(148,163,184,.35); }
    .pill{ font-size:11px; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#1d4ed8; border:1px solid rgba(37,99,235,.18); font-weight:700; }
    .tag{ font-size:11px; padding:4px 10px; border-radius:999px; background:#f1f5f9; color:#334155; border:1px solid rgba(148,163,184,.30); font-weight:700; }

    .emp-face-badge{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(16,185,129,.22);
      background:rgba(16,185,129,.10);
      color:#047857;
      font-weight:800;
      white-space:nowrap;
    }
    .emp-face-badge.off{
      border-color:rgba(239,68,68,.22);
      background:rgba(239,68,68,.10);
      color:#b91c1c;
    }

    /* Tables */
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
    thead{ background:#f3f4f6; }
    th,td{ padding:10px 10px; border-bottom:1px solid #e5e7eb; text-align:left; white-space:nowrap; vertical-align:top; }
    th{ font-weight:800; color:#334155; font-size:12px; }
    tbody tr:hover{ background:#f8fafc; }
    .scroll-x{ width:100%; overflow:auto; -webkit-overflow-scrolling:touch; }
    .table-wide{ width:max-content; min-width:820px; }
    .text-center{ text-align:center; }
    .text-right{ text-align:right; }

    /* Connection badge */
    .badge-connection{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      font-size:11px; font-weight:800;
      background:rgba(15,118,110,.14);
      color:#a5f3fc;
      border:1px solid rgba(34,197,94,.75);
    }
    .badge-connection.offline{
      background:rgba(127,29,29,.30);
      color:#fecaca;
      border-color:rgba(248,113,113,.85);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background:#22c55e;
      box-shadow:0 0 10px rgba(34,197,94,.75);
    }
    .badge-connection.offline .dot{
      background:#f97373;
      box-shadow:0 0 10px rgba(248,113,113,.75);
    }

    /* Sections */
    .section{ display:none; }
    .section.active{ display:block; }

    /* Mobile cards */
    .list-mobile{
      display:flex; flex-direction:column; gap:10px;
      padding:6px 2px 2px;
    }
    .item{
      border:1px solid rgba(226,232,240,.95);
      border-radius:18px;
      padding:12px 12px 10px;
      background:#fff;
      box-shadow:0 12px 24px rgba(15,23,42,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item-top{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .item-title{ font-weight:800; font-size:14px; line-height:1.25; }
    .item-meta{
      font-size:12px; color:var(--muted);
      display:flex; flex-wrap:wrap; gap:6px; align-items:center;
    }
    .code-badge{
      font-size:11px; padding:4px 10px; border-radius:999px;
      background:rgba(37,99,235,.12);
      color:var(--primary);
      border:1px solid rgba(37,99,235,.22);
      font-weight:800;
      white-space:nowrap;
      height:fit-content;
    }
    .kv{
      display:grid;
      grid-template-columns:96px 1fr;
      gap:6px 10px;
      font-size:12px;
      color:#0f172a;
    }
    .kv .k{ color:var(--muted); }
    .kv .v{ font-weight:700; }

    .item-actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .item-actions .btn{ width:100%; padding:10px 12px; }

    /* Desktop vs Mobile toggles */
    .desktop-only{ display:block; }
    .mobile-only{ display:none; }
    @media (max-width:900px){
      .desktop-only{ display:none; }
      .mobile-only{ display:block; }
    }

    /* Bottom nav (mobile) */
    .bottom-nav{
      display:none;
      position:fixed;
      left:10px; right:10px; bottom:10px;
      z-index:40;
      background:rgba(2,6,23,.92);
      border:1px solid rgba(31,41,55,.85);
      border-radius:18px;
      padding:8px;
      backdrop-filter:blur(12px);
      box-shadow:0 16px 44px rgba(15,23,42,.35);
      overflow:hidden;
    }
    .bottom-nav-inner{
      display:flex;
      gap:6px;
      overflow-x:auto;
      padding-bottom:2px;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .bottom-nav-inner::-webkit-scrollbar{ display:none; }
    .bottom-item{
      min-width:82px;
      border:none;
      background:transparent;
      color:#cbd5e1;
      border-radius:14px;
      padding:8px 8px;
      cursor:pointer;
      display:flex; flex-direction:column; align-items:center; gap:2px;
      font-size:10px; font-weight:800;
      border:1px solid transparent;
    }
    .bottom-item .bicon{ font-size:16px; }
    .bottom-item.active{
      background:rgba(37,99,235,.18);
      color:#fff;
      border-color:rgba(59,130,246,.45);
      box-shadow:0 10px 18px rgba(37,99,235,.22);
    }

    @media (max-width:1000px){
      .sidebar{ display:none; }
      .page{ flex-direction:column; }
      main.main{ padding:14px 12px 92px; }
      .bottom-nav{ display:block; }
      header.topbar{ padding:10px 12px; }
    }
    @media (max-width:640px){
      header.topbar{ flex-direction:column; align-items:flex-start; }
      .topbar-right{ width:100%; display:flex; justify-content:space-between; }
    }

    /* URL card (floating) */
    #urlCard{
      position:fixed;
      right:16px;
      bottom:92px;
      max-width:420px;
      width:calc(100% - 32px);
      z-index:45;
      display:none;
    }
    @media (min-width:1001px){
      #urlCard{ bottom:16px; }
    }
    @media (max-width:640px){
      #urlCard{ left:12px; right:12px; width:auto; }
    }

    /* Modals */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:60;
      backdrop-filter:blur(6px);
    }
    .modal{
      width:100%;
      max-width:560px;
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(226,232,240,.9);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .modal-header{
      padding:12px 14px;
      border-bottom:1px solid #e5e7eb;
      display:flex; justify-content:space-between; gap:10px;
      background:#f8fafc;
    }
    .modal-title{ font-weight:900; font-size:14px; }
    .modal-sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .modal-body{ padding:12px 14px 14px; }
    .modal-footer{
      padding:12px 14px;
      border-top:1px solid #e5e7eb;
      display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
      background:#fafafa;
    }

    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    .grid-3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; }
    @media (max-width:800px){
      .grid-2,.grid-3{ grid-template-columns:1fr; }
    }

    .stat-card{
      padding:12px 12px; border-radius:16px;
      background:#f9fafb; border:1px solid #e5e7eb;
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .stat-label{ font-size:12px; color:var(--muted); font-weight:700; }
    .stat-value{ font-size:22px; font-weight:900; letter-spacing:.2px; }
    .stat-extra{ font-size:11px; color:var(--muted); }
    .stat-accent{ color:#16a34a; }
    .stat-danger{ color:#b91c1c; }

    .skeleton{
      background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%);
      background-size:400% 100%;
      animation:sk 1.2s ease infinite;
      border-radius:12px;
      height:14px;
      width:100%;
    }
    @keyframes sk{ 0%{background-position:100% 0} 100%{background-position:0 0} }

    .error-text{ font-size:12px; color:var(--danger); margin-top:8px; font-weight:700; }
    .success-text{ font-size:12px; color:var(--success); margin-top:8px; font-weight:700; }

    /* Leave status chips */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:#fff;
      color:#334155;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, box-shadow .12s ease, background .12s ease;
    }
    .chip:active{ transform:translateY(1px); }
    .chip.active{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.35);
      color:#1d4ed8;
      box-shadow:0 10px 18px rgba(37,99,235,.12);
    }

    /* Small text in topbar */
    .tiny{
      font-size:11px;
      color:#94a3b8;
      font-weight:800;
    }

    details.adv{
      border:1px dashed rgba(148,163,184,.55);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(248,250,252,.9);
      margin-top:10px;
    }
    details.adv summary{
      cursor:pointer;
      font-weight:900;
      color:#334155;
      font-size:12px;
      user-select:none;
    }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>

<body>
<div class="page">
  <!-- SIDEBAR (Desktop) -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
      <div class="sidebar-sub">HR Attendance Panel</div>
    </div>

    <nav class="nav">
      <div class="nav-item active" data-section="dashboard"><span class="icon">üìä</span><span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span></div>
      <div class="nav-item" data-section="employees"><span class="icon">üë•</span><span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span></div>
      <div class="nav-item" data-section="logs"><span class="icon">‚è±</span><span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</span></div>
      <div class="nav-item" data-section="summary"><span class="icon">üìà</span><span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span></div>
      <div class="nav-item" data-section="leave"><span class="icon">üìù</span><span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</span></div>
      <div class="nav-item" data-section="settings"><span class="icon">‚öôÔ∏è</span><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏ú‡∏ô‡∏Å/‡∏£‡∏∞‡∏î‡∏±‡∏ö)</span></div>
    </nav>

    <div class="sidebar-footer">
      <div id="adminMiniText">TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin</div>
      <button class="btn btn-ghost" id="btnBackToFront">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
      <button class="btn btn-danger" id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </aside>

  <div class="content">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</div>
        <div class="topbar-sub">
          <span id="adminNameText">Admin Panel</span>
          <span> | </span>
          <span id="apiUrlDisplay" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL"></span>
          <span class="tiny" id="lastUpdatedText">‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
          <span class="tiny" id="autoModeText">‚Ä¢ Live: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö/‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤)</span>
        </div>
      </div>
      <div class="topbar-right">
        <div id="connectionBadge" class="badge-connection offline">
          <span class="dot"></span>
          <span id="connectionText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
        </div>
        <button class="btn btn-secondary" id="btnRefreshNow">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn btn-secondary" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
      </div>
    </header>

    <main class="main">
      <div class="main-inner">

        <!-- DASHBOARD -->
        <section class="section active" id="section-dashboard">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìä</span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="card-subtitle">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö ‚Äú‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‚Äù ‚Ä¢ ‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥</div>
              </div>
            </div>

            <div class="grid-3">
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="stat-value" id="statTotalEmployees"><div class="skeleton"></div></div>
                <div class="stat-extra">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï Employees</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value stat-accent" id="statTodayCount"><div class="skeleton"></div></div>
                <div class="stat-extra"><span class="stat-danger" id="statTodayLate">‡∏™‡∏≤‡∏¢ 0 ‡∏Ñ‡∏ô</span></div>
              </div>
              <div class="stat-card">
                <div class="stat-label">‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏õ‡∏Å‡∏ï‡∏¥ / ‡∏™‡∏≤‡∏¢ / ‡∏Ç‡∏≤‡∏î / ‡∏•‡∏≤)</div>
                <div class="stat-value" id="statMonthOverview"><div class="skeleton"></div></div>
                <div class="stat-extra" id="statMonthOverviewExtra">‡∏à‡∏≤‡∏Å Summary Range + Leave</div>
              </div>
            </div>

            <div class="mt-12">
              <div class="card-subtitle">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
              <div class="scroll-x mt-8">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ä‡πâ‡∏≤</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th><th>‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á</th><th>‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡πá‡∏ô</th>
                      <th>‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                  </thead>
                  <tbody id="dashboardTodayBody">
                    <tr><td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                  </tbody>
                </table>
              </div>

              <div class="mt-10">
                <div class="card-subtitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
                <div id="dashboardLocationSummary" class="mt-8" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- EMPLOYEES -->
        <section class="section" id="section-employees">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üë•</span>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
                <div class="card-subtitle">‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤/‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‚Äù</div>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; min-width:260px; max-width:460px; width:100%;">
                <input id="empSearch" class="input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠" />
                <button class="btn btn-primary" id="btnOpenAddEmp">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
              </div>
            </div>

            <div class="desktop-only">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                      <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                      <th>‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</th>
                      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody id="empTableBody">
                    <tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mobile-only">
              <div id="empMobileList" class="list-mobile">
                <div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
              </div>
            </div>

            <div class="helper mt-10">
              * ‡∏´‡∏ô‡πâ‡∏≤ Admin ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‚Äú‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äù
            </div>
          </div>
        </section>

        <!-- LOGS -->
        <section class="section" id="section-logs">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">‚è±</span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div class="card-subtitle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Ä¢ ‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î</div>
              </div>
            </div>

            <div class="mt-8" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end;">
              <div style="flex:1; min-width:200px;">
                <div class="helper">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™</div>
                <input id="logSearch" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011, ‡∏™‡∏°‡∏ä‡∏≤‡∏¢" />
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <select id="logBranchFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <select id="logMonthFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏õ‡∏µ (‡∏û.‡∏®.)</div>
                <select id="logYearFilter" class="input"></select>
              </div>
              <button class="btn btn-primary" id="btnReloadLogs">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ</button>
            </div>

            <div class="desktop-only mt-10">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡πÄ‡∏Ç‡πâ‡∏≤</th><th>‡∏≠‡∏≠‡∏Å</th><th>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</th>
                      <th>‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
                    </tr>
                  </thead>
                  <tbody id="logsTableBody">
                    <tr><td colspan="10" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mobile-only mt-10">
              <div id="logsMobileList" class="list-mobile">
                <div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              </div>
            </div>
          </div>
        </section>

        <!-- SUMMARY -->
        <section class="section" id="section-summary">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìà</span>‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</div>
                <div class="card-subtitle">‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏Å‡∏ï‡∏¥/‡∏™‡∏≤‡∏¢/‡∏Ç‡∏≤‡∏î)</div>
              </div>
            </div>

            <div class="mt-8" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end;">
              <div style="min-width:160px;">
                <div class="helper">‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <select id="sumBranchFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <select id="sumMonthFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏õ‡∏µ (‡∏û.‡∏®.)</div>
                <select id="sumYearFilter" class="input"></select>
              </div>
              <button class="btn btn-primary" id="btnReloadSummary">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ</button>
            </div>

            <div class="desktop-only mt-10">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th><th>‡∏õ‡∏Å‡∏ï‡∏¥</th><th>‡∏™‡∏≤‡∏¢</th><th>‡∏Ç‡∏≤‡∏î</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTableBody">
                    <tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mobile-only mt-10">
              <div id="summaryMobileList" class="list-mobile">
                <div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              </div>
            </div>
          </div>
        </section>

        <!-- LEAVE TAB -->
        <section class="section" id="section-leave">
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title"><span class="icon">üìù</span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
                <div class="card-subtitle">‚úÖ ‡πÇ‡∏´‡∏°‡∏î ‚Äú‡πÄ‡∏î‡∏≤ action ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + ‡∏à‡∏≥ action ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‚Äù (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô leave.html)</div>
              </div>

              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button class="btn btn-secondary" id="btnOpenLeaveStandalone">‡πÄ‡∏õ‡∏¥‡∏î leave.html</button>
              </div>
            </div>

            <div class="chips mt-8">
              <div class="chip active" data-leave-status="PENDING">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
              <div class="chip" data-leave-status="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
              <div class="chip" data-leave-status="REJECTED">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
              <div class="chip" data-leave-status="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>

            <div class="mt-10" style="display:flex; flex-wrap:wrap; gap:8px; align-items:end;">
              <div style="flex:1; min-width:220px;">
                <div class="helper">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•)</div>
                <input id="leaveSearch" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011, ‡∏™‡∏°‡∏ä‡∏≤‡∏¢, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢" />
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏™‡∏≤‡∏Ç‡∏≤</div>
                <select id="leaveBranchFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <select id="leaveMonthFilter" class="input"></select>
              </div>
              <div style="min-width:160px;">
                <div class="helper">‡∏õ‡∏µ (‡∏û.‡∏®.)</div>
                <select id="leaveYearFilter" class="input"></select>
              </div>
              <button class="btn btn-primary" id="btnReloadLeave">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ</button>
            </div>

            <div id="leaveHint" class="helper mt-10"></div>

            <details class="adv">
              <summary>‚öôÔ∏è Advanced: ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Action ‡πÄ‡∏≠‡∏á (‡∏Å‡∏£‡∏ì‡∏µ GS ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞)</summary>
              <div class="mt-10 grid-2">
                <div>
                  <div class="helper">Action ‚Äú‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‚Äù</div>
                  <input id="leaveListActionCustom" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô getLeaveHistoryAll / listLeaves" />
                </div>
                <div>
                  <div class="helper">Action ‚Äú‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏≤‚Äù</div>
                  <input id="leaveUpdateActionCustom" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô updateLeaveStatus / approveLeave" />
                </div>
              </div>
              <div class="mt-10" style="display:flex; gap:8px; flex-wrap:wrap;">
                <button class="btn btn-secondary" id="btnSaveLeaveActions">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Action</button>
                <button class="btn btn-secondary" id="btnClearLeaveActions">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
              </div>
              <div class="helper mt-8">
                * ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ä‡∏∑‡πà‡∏≠ action: ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå leave.html ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πâ‡∏ô‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ <b>action:</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>URLSearchParams({ action</b>
              </div>
            </details>

            <div class="desktop-only mt-10">
              <div class="scroll-x" style="max-height:520px; overflow:auto;">
                <table class="table-wide">
                  <thead>
                    <tr>
                      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡πà‡∏ô</th>
                      <th>‡∏£‡∏´‡∏±‡∏™</th>
                      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</th>
                      <th>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤</th>
                      <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                      <th>‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody id="leaveTableBody">
                    <tr><td colspan="9" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mobile-only mt-10">
              <div id="leaveMobileList" class="list-mobile">
                <div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
              </div>
            </div>

            <div class="helper mt-10">
              * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞ ‚Äú‡∏à‡∏≥ action ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‚Äù ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section class="section" id="section-settings">
          <div class="grid-2">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title"><span class="icon">üè∑Ô∏è</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å</div>
                  <div class="card-subtitle">‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á ‡πÜ</div>
                </div>
              </div>

              <div class="mt-8">
                <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏´‡∏°‡πà</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input id="branchName" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ / ‡∏ù‡πà‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" />
                  <button class="btn btn-primary" id="btnAddBranch">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
              </div>

              <div class="scroll-x mt-10" style="max-height:360px; overflow:auto;">
                <table>
                  <thead><tr><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                  <tbody id="branchTableBody"><tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title"><span class="icon">üìå</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                  <div class="card-subtitle">‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô / ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏Ø‡∏•‡∏Ø</div>
                </div>
              </div>

              <div class="mt-8">
                <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <input id="levelName" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô" />
                  <button class="btn btn-primary" id="btnAddLevel">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
              </div>

              <div class="scroll-x mt-10" style="max-height:360px; overflow:auto;">
                <table>
                  <thead><tr><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th class="text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                  <tbody id="levelTableBody"><tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody>
                </table>
              </div>

              <div id="settingsError" class="error-text" style="display:none;"></div>
              <div id="settingsSuccess" class="success-text" style="display:none;"></div>
            </div>
          </div>
        </section>

        <!-- URL CARD -->
        <div class="card" id="urlCard">
          <div class="card-header">
            <div class="card-title"><span class="icon">üîó</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API</div>
          </div>
          <div class="helper">URL ‡∏à‡∏≤‡∏Å Apps Script Web App (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <code>/exec</code>)</div>
          <input id="inputApiUrl" class="input mt-8" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/XXXXX/exec" />
          <div class="mt-10" style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn btn-primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn btn-secondary" id="btnCancelUrl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
          <div id="urlError" class="error-text" style="display:none;"></div>
        </div>

      </div>
    </main>
  </div>
</div>

<!-- Bottom Nav (Mobile) -->
<div class="bottom-nav">
  <div class="bottom-nav-inner">
    <button class="bottom-item active" data-section="dashboard"><div class="bicon">üìä</div><div>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</div></button>
    <button class="bottom-item" data-section="employees"><div class="bicon">üë•</div><div>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div></button>
    <button class="bottom-item" data-section="logs"><div class="bicon">‚è±</div><div>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div></button>
    <button class="bottom-item" data-section="summary"><div class="bicon">üìà</div><div>‡∏™‡∏£‡∏∏‡∏õ</div></button>
    <button class="bottom-item" data-section="leave"><div class="bicon">üìù</div><div>‡∏•‡∏≤</div></button>
    <button class="bottom-item" data-section="settings"><div class="bicon">‚öôÔ∏è</div><div>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div></button>
  </div>
</div>

<!-- MODAL: EMPLOYEE FORM -->
<div class="modal-backdrop" id="empModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="empModalTitle">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="empModalTitle">üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
        <div class="modal-sub" id="empModalSub">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
      </div>
      <button class="btn btn-secondary btn-small" id="btnCloseEmpModal" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <div>
          <div class="helper">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <input id="empCode" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" />
        </div>
        <div>
          <div class="helper">‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
          <input id="empEmail" class="input" placeholder="optional" />
        </div>
      </div>

      <div class="mt-10">
        <div class="helper">‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
        <input id="empFullName" class="input" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" />
      </div>

      <div class="grid-2 mt-10">
        <div>
          <div class="helper">‡πÅ‡∏ú‡∏ô‡∏Å</div>
          <select id="empBranch" class="input"></select>
        </div>
        <div>
          <div class="helper">‡∏£‡∏∞‡∏î‡∏±‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
          <select id="empLevel" class="input"></select>
        </div>
      </div>

      <div id="empFormError" class="error-text" style="display:none;"></div>
      <div id="empFormSuccess" class="success-text" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnResetEmpForm" type="button">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      <button class="btn btn-primary" id="btnSaveEmployee" type="button">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- MODAL: LOGIN (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö loginAdmin ‡∏ñ‡πâ‡∏≤ GS ‡∏°‡∏µ) -->
<div class="modal-backdrop" id="loginModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle" style="max-width:520px;">
    <div class="modal-header">
      <div style="min-width:0;">
        <div class="modal-title" id="loginModalTitle">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
        <div class="modal-sub" id="loginModalSub">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Admin</div>
      </div>
      <button class="btn btn-secondary btn-small" id="btnCloseLogin" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <div>
          <div class="helper">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏ñ‡πâ‡∏≤ GS ‡πÉ‡∏ä‡πâ)</div>
          <input id="loginUser" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô admin" autocomplete="username" />
        </div>
        <div>
          <div class="helper">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <input id="loginPass" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" type="password" autocomplete="current-password" />
        </div>
      </div>
      <div class="helper mt-10">
        * ‡∏ñ‡πâ‡∏≤ GS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚Äú‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‚Äù ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏≠‡∏á
      </div>
      <div id="loginError" class="error-text" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="btnClearToken" type="button">‡∏•‡πâ‡∏≤‡∏á Token</button>
      <button class="btn btn-primary" id="btnDoLogin" type="button">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'attendance_api_url_v2';

  // ‡∏à‡∏≥ action leave + custom (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô leave.html)
  const STORAGE_LEAVE_ACTIONS_KEY = 'attendance_leave_actions_v1';
  const STORAGE_LEAVE_CUSTOM_KEY = 'attendance_leave_actions_custom_v1';

  // token admin (‡∏ñ‡πâ‡∏≤ GS ‡∏°‡∏µ loginAdmin)
  const STORAGE_ADMIN_TOKEN_KEY = 'attendance_admin_token_v1';
  const STORAGE_ADMIN_NAME_KEY  = 'attendance_admin_name_v1';

  function $(id){ return document.getElementById(id); }

  function getApiUrl(){ return localStorage.getItem(STORAGE_KEY) || ''; }
  function setApiUrl(url){
    if(!url) localStorage.removeItem(STORAGE_KEY);
    else localStorage.setItem(STORAGE_KEY, url);
  }

  function getAdminToken(){ return localStorage.getItem(STORAGE_ADMIN_TOKEN_KEY) || ''; }
  function setAdminToken(t){
    if(!t) localStorage.removeItem(STORAGE_ADMIN_TOKEN_KEY);
    else localStorage.setItem(STORAGE_ADMIN_TOKEN_KEY, t);
  }
  function getAdminName(){ return localStorage.getItem(STORAGE_ADMIN_NAME_KEY) || ''; }
  function setAdminName(n){
    if(!n) localStorage.removeItem(STORAGE_ADMIN_NAME_KEY);
    else localStorage.setItem(STORAGE_ADMIN_NAME_KEY, n);
  }

  // ====== API wrapper (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Abort + callFirst) ======
  const api = {
    async call(action, params = {}, opts = {}){
      const apiUrl = getApiUrl();
      if(!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');

      const token = getAdminToken();
      const body = new URLSearchParams({
        action,
        ...params,
        ...(token ? { token, adminToken: token, sessionToken: token } : {})
      }).toString();

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body,
        signal: opts.signal
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch(e){
        console.error('API response is not JSON:', text);
        throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ URL ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ /exec ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)');
      }
      if(!data.ok){
        const em = data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå';
        const err = new Error(em);
        err._server = data;
        throw err;
      }
      return data.result;
    },

    async callFirst(actions, params = {}, opts = {}){
      const errors = [];
      for(const act of actions){
        try{
          const result = await this.call(act, params, opts);
          if(opts.onSuccess) opts.onSuccess(act, result);
          return { action: act, result };
        }catch(err){
          errors.push({ act, msg: err.message });
        }
      }
      const msg = errors.map(e => `- ${e.act}: ${e.msg}`).join('\n');
      throw new Error((opts.failMessage || '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') + '\n' + msg);
    }
  };

  // ===== Actions fallback (‡∏Å‡∏±‡∏ô ‚ÄúGS ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‚Äù) =====
  const EMP_LIST_ACTIONS = ['getInitialData','getEmployees','listEmployees','employees_list','getEmployeeList'];
  const BL_ACTIONS = ['getInitialData','getBranchesLevels','getBranchesAndLevels','getMeta','getMasterData'];

  // ===== Data =====
  let employees = [];
  let branches = [];
  let levels = [];
  let editingEmpId = null;

  // leave
  let leaveStatus = 'PENDING';

  // ===== Refresh guard =====
  let refreshInFlight = false;
  let refreshAbort = null;

  function escHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function setLastUpdated(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    const el = $('lastUpdatedText');
    if(el) el.textContent = `‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${hh}:${mm}:${ss}`;
  }

  function setConnectionStatus(online, msg){
    const bdg = $('connectionBadge');
    const txt = $('connectionText');
    if(!bdg || !txt) return;
    if(online){
      bdg.classList.remove('offline');
      txt.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }else{
      bdg.classList.add('offline');
      txt.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
    }
  }

  function ellipsizeUrl(url){
    if(!url) return '';
    if(url.length <= 52) return url;
    return url.slice(0, 30) + '...' + url.slice(-12);
  }
  function setApiText(url){
    const el = $('apiUrlDisplay');
    if(!el) return;
    el.textContent = url ? ('API: ' + ellipsizeUrl(url)) : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
    el.title = url ? ('‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å: ' + url) : '';
    el.dataset.full = url || '';
  }

  function setAdminText(){
    const name = getAdminName();
    const t1 = $('adminNameText');
    const t2 = $('adminMiniText');
    if(t1) t1.textContent = name ? `Admin: ${name}` : 'Admin Panel';
    if(t2) t2.textContent = name ? `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ${name}` : 'TIP: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Admin';
  }

  // ===== URL Card =====
  function openUrlCard(){
    $('inputApiUrl').value = getApiUrl();
    $('urlCard').style.display = 'block';
    $('urlError').style.display = 'none';
  }
  function closeUrlCard(){ $('urlCard').style.display = 'none'; }
  function saveUrl(){
    let url = ($('inputApiUrl').value || '').trim();
    const errEl = $('urlError');
    errEl.style.display = 'none';

    if(!url){
      errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL';
      errEl.style.display = 'block';
      return;
    }
    // ‡πÉ‡∏à‡∏î‡∏µ‡∏ô‡∏¥‡∏î: ‡∏ñ‡πâ‡∏≤‡∏•‡∏∑‡∏° /exec ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
    if(!/\/exec(\?|$)/.test(url)){
      // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏™‡πà /dev ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
      if(!/\/dev(\?|$)/.test(url)){
        // ‡πÑ‡∏°‡πà throw ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        console.warn('URL ‡πÑ‡∏°‡πà‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec (‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô /exec)');
      }
    }

    setApiUrl(url);
    setApiText(url);
    closeUrlCard();
    initAdmin(true);
  }

  // ===== Modals =====
  function openModal(id){
    const el = $(id);
    if(!el) return;
    el.style.display = 'flex';
    el.setAttribute('aria-hidden','false');
  }
  function closeModal(id){
    const el = $(id);
    if(!el) return;
    el.style.display = 'none';
    el.setAttribute('aria-hidden','true');
  }

  // ===== Login (‡∏ñ‡πâ‡∏≤ GS ‡∏°‡∏µ action loginAdmin) =====
  async function tryLoginAdmin(username, password){
    const res = await api.call('loginAdmin', {
      username, user: username, admin: username,
      password, pass: password, pin: password
    });

    const token = res?.token || res?.adminToken || res?.sessionToken || res?.accessToken || '';
    const name = res?.name || res?.adminName || res?.fullName || username || 'Admin';

    if(token){
      setAdminToken(token);
      setAdminName(name);
      setAdminText();
    }else{
      setAdminName(name);
      setAdminText();
    }
    return res;
  }

  function shouldAskLoginByMessage(msg){
    const s = String(msg || '').toLowerCase();
    return s.includes('unauthor') || s.includes('permission') || s.includes('login') || s.includes('token')
      || s.includes('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå') || s.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö') || s.includes('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥') || s.includes('token');
  }

  async function ensureLoginIfNeeded(err){
    if(err && shouldAskLoginByMessage(err.message)){
      openModal('loginModalBackdrop');
      const le = $('loginError');
      if(le){
        le.style.display = 'block';
        le.textContent = '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏´‡∏£‡∏∑‡∏≠ token ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)';
      }
      return true;
    }
    return false;
  }

  // ===== Section nav =====
  function switchSection(section){
    document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.section === section));
    document.querySelectorAll('.bottom-item').forEach(el => el.classList.toggle('active', el.dataset.section === section));
    document.querySelectorAll('.section').forEach(el => el.classList.toggle('active', el.id === 'section-' + section));

    refreshCurrentSection(section, true);
  }

  function getActiveSection(){
    const active = document.querySelector('.nav-item.active');
    return active ? active.dataset.section : 'dashboard';
  }

  async function refreshCurrentSection(section, silent=false){
    if(refreshInFlight) return;
    refreshInFlight = true;

    if(refreshAbort) refreshAbort.abort();
    refreshAbort = new AbortController();
    const signal = refreshAbort.signal;

    try{
      if(section === 'dashboard'){
        await loadDashboard({ signal });
      }else if(section === 'employees'){
        await loadEmployees({ signal });
      }else if(section === 'logs'){
        await reloadLogs({ signal });
      }else if(section === 'summary'){
        await reloadSummary({ signal });
      }else if(section === 'settings'){
        await loadBranchesLevels({ signal });
      }else if(section === 'leave'){
        await reloadLeave({ signal });
      }
      setLastUpdated();
      setConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(err){
      if(err.name === 'AbortError') return;
      console.error(err);
      setConnectionStatus(false, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');

      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;

      if(!silent) alert('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }finally{
      refreshInFlight = false;
    }
  }

  // ===== Status helpers =====
  function statusBadgeHtml(status){
    const s = String(status || '').trim();
    if(!s) return '<span class="badge-status badge-absent">‡∏Ç‡∏≤‡∏î</span>';
    const up = s.toUpperCase();
    if(up.includes('UNKNOWN') || up.includes('UNKNOW')) return '<span class="badge-status badge-unknown">UNKNOWN</span>';

    let cls = 'badge-other';
    if(s === '‡∏õ‡∏Å‡∏ï‡∏¥') cls = 'badge-normal';
    else if(s.includes('‡∏™‡∏≤‡∏¢') || s.includes('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏ß') || s.includes('‡∏≠‡∏≠‡∏Å‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏ß')) cls = 'badge-late';
    else if(s === '‡∏Ç‡∏≤‡∏î') cls = 'badge-absent';
    return '<span class="badge-status '+cls+'">'+escHtml(s)+'</span>';
  }

  function timeToMinutes(t){
    if(!t) return null;
    const parts = String(t).split(':');
    if(parts.length < 2) return null;
    const h = Number(parts[0]), m = Number(parts[1]);
    if(isNaN(h) || isNaN(m)) return null;
    return h * 60 + m;
  }
  function minutesToThai(min){
    if(min == null) return '-';
    if(min <= 0) return '0 ‡∏ô‡∏≤‡∏ó‡∏µ';
    const h = Math.floor(min / 60);
    const m = min % 60;
    if(h <= 0) return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    return `${h} ‡∏ä‡∏° ${m.toString().padStart(2,'0')} ‡∏ô‡∏≤‡∏ó‡∏µ`;
  }
  function calcTotalHours(t1, t4){
    const m1 = timeToMinutes(t1);
    const m4 = timeToMinutes(t4);
    if(m1 == null || m4 == null || m4 <= m1) return '-';
    return minutesToThai(m4 - m1);
  }

  function parseDateAny(v){
    if(!v) return null;
    if(v instanceof Date) return v;
    const s = String(v).trim();
    if(!s) return null;

    if(/^\d{4}-\d{2}-\d{2}/.test(s)){
      const iso = s.replace(' ', 'T');
      const d = new Date(iso);
      if(!isNaN(d.getTime())) return d;
    }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){
      const [dd,mm,yy] = s.split('/').map(x=>Number(x));
      const y = (yy > 2400) ? (yy - 543) : yy;
      const d = new Date(y, mm-1, dd);
      if(!isNaN(d.getTime())) return d;
    }
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
    return null;
  }

  function formatDateThai(dateStr){
    const d = parseDateAny(dateStr);
    if(!d) return String(dateStr || '');
    const dd = d.getDate().toString().padStart(2,'0');
    const mm = (d.getMonth()+1).toString().padStart(2,'0');
    const yy = d.getFullYear() + 543;
    return `${dd}/${mm}/${yy}`;
  }

  function isRealTime(v){
    if(v == null) return false;
    const s = String(v).trim();
    if(!s) return false;
    if(s === '-' || s === '‚Äì') return false;
    return true;
  }
  function hasAnyLogRow(r){
    return isRealTime(r.t1) || isRealTime(r.t2) || isRealTime(r.t3) || isRealTime(r.t4);
  }

  function calcPenaltyFromStatus(status){
    const s = String(status || '').trim();
    if(!s) return { kind:'none', minutes:0 };
    const up = s.toUpperCase();
    if(up.includes('UNKNOWN') || up.includes('UNKNOW')) return { kind:'unknown' };

    let total = 0;
    const re = /(\d+)\s*(?:‡∏ä‡∏°\.?|‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)\s*(\d+)\s*‡∏ô‡∏≤‡∏ó‡∏µ|(\d+)\s*‡∏ô‡∏≤‡∏ó‡∏µ/g;
    let m;
    while((m = re.exec(s)) !== null){
      if(m[1] && m[2]) total += (Number(m[1]) * 60) + Number(m[2]);
      else if(m[3]) total += Number(m[3]);
    }
    return { kind:'ok', minutes:total };
  }
  function penaltyHtmlFromRow(r){
    const res = calcPenaltyFromStatus(r.status || '');
    if(res.kind === 'unknown') return '<span class="badge-status badge-unknown">UNKNOWN</span>';
    if(res.kind === 'none') return '-';
    return `<span class="pill">${escHtml(minutesToThai(res.minutes))}</span>`;
  }

  // ===== Selects =====
  function renderBranchLevelSelects(){
    const branchSel = $('empBranch');
    const levelSel  = $('empLevel');
    if(!branchSel || !levelSel) return;

    branchSel.innerHTML = branches.length
      ? branches.map(b => `<option value="${escHtml(b.name)}">${escHtml(b.name)}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å -</option>';

    levelSel.innerHTML = levels.length
      ? levels.map(l => `<option value="${escHtml(l.name)}">${escHtml(l.name)}</option>`).join('')
      : '<option value="">- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö -</option>';

    const opts = ['<option value="ALL">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>'].concat(
      branches.map(b => `<option value="${escHtml(b.name)}">${escHtml(b.name)}</option>`)
    ).join('');

    if($('logBranchFilter')) $('logBranchFilter').innerHTML = opts;
    if($('sumBranchFilter')) $('sumBranchFilter').innerHTML = opts;
    if($('leaveBranchFilter')) $('leaveBranchFilter').innerHTML = opts;
  }

  function fillYearMonthSelect(yearSel, monthSel){
    const now = new Date();
    const curYearAD = now.getFullYear();
    const yearsAD = [curYearAD-1, curYearAD, curYearAD+1];

    yearSel.innerHTML = yearsAD.map(y => {
      const be = y + 543;
      const sel = (y === curYearAD) ? 'selected' : '';
      return `<option value="${be}" ${sel}>${be}</option>`;
    }).join('');

    const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    monthSel.innerHTML = monthNames.map((m,i) => {
      const sel = (i === now.getMonth()) ? 'selected' : '';
      return `<option value="${i+1}" ${sel}>${m}</option>`;
    }).join('');
  }

  function beToAd(beYear){
    const n = Number(beYear);
    if(!n) return beYear;
    return (n > 2400) ? (n - 543) : n;
  }

  // ===== Employees =====
  function hasFace(e){
    const fd = e && (e.faceData ?? e.face ?? e.faceEmbedding ?? '');
    if(!fd) return false;
    const s = String(fd).trim();
    if(!s) return false;
    if(s === '-' || s === '‚Äì') return false;
    return true;
  }

  function normalizeArray(res){
    if(Array.isArray(res)) return res;
    if(res && Array.isArray(res.rows)) return res.rows;
    if(res && Array.isArray(res.items)) return res.items;
    if(res && Array.isArray(res.data)) return res.data;
    if(res && Array.isArray(res.list)) return res.list;
    return [];
  }

  function renderEmployeesTable(){
    const tb = $('empTableBody');
    const mobileList = $('empMobileList');
    const q = ( ($('empSearch')?.value) || '' ).trim().toLowerCase();

    let list = employees || [];
    if(q){
      list = list.filter(e => (String(e.code)+' '+String(e.fullName)).toLowerCase().includes(q));
    }

    if(!list.length){
      if(tb) tb.innerHTML = '<tr><td colspan="6" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      return;
    }

    if(tb){
      tb.innerHTML = list.map(e => {
        const faceOk = hasFace(e);
        const faceBadge = faceOk
          ? `<span class="emp-face-badge">‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`
          : `<span class="emp-face-badge off">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`;

        const idJS = JSON.stringify(String(e.id || ''));

        return `
          <tr>
            <td>${escHtml(e.code || '')}</td>
            <td>${escHtml(e.fullName || '')}</td>
            <td>${escHtml(e.branch || '')}</td>
            <td>${escHtml(e.level || '')}</td>
            <td>${faceBadge}</td>
            <td>
              <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="btn btn-secondary btn-small" onclick='editEmployee(${idJS})'>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-danger btn-small" onclick='deleteEmployeeConfirm(${idJS})'>üóëÔ∏è ‡∏•‡∏ö</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    if(mobileList){
      mobileList.innerHTML = list.map(e => {
        const faceOk = hasFace(e);
        const faceBadge = faceOk
          ? `<span class="emp-face-badge">‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`
          : `<span class="emp-face-badge off">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>`;

        const idJS = JSON.stringify(String(e.id || ''));

        return `
          <div class="item">
            <div class="item-top">
              <div style="min-width:0;">
                <div class="item-title">${escHtml(e.fullName || '-')}</div>
                <div class="item-meta">
                  <span class="tag">‡πÅ‡∏ú‡∏ô‡∏Å: ${escHtml(e.branch || '-')}</span>
                  <span class="tag">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escHtml(e.level || '-')}</span>
                  ${faceBadge}
                </div>
              </div>
              <div class="code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(e.code || '-')}</div>
            </div>

            <div class="item-actions">
              <button class="btn btn-secondary" onclick='editEmployee(${idJS})'>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger" onclick='deleteEmployeeConfirm(${idJS})'>üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  // ========== ‡πÇ‡∏´‡∏•‡∏î initial data ‡πÅ‡∏ö‡∏ö ‚Äú‡∏ï‡∏£‡∏á GS‚Äù ==========
  async function loadInitialData(opts={}){
    const init = await api.call('getInitialData', {}, opts);
    employees = normalizeArray(init.employees || init.employeeList || init.emp);
    branches  = normalizeArray(init.branches  || init.branchList  || init.departments);
    levels    = normalizeArray(init.levels    || init.levelList   || init.positions);

    if(branches.length && typeof branches[0] === 'string') branches = branches.map(x => ({ name: x }));
    if(levels.length && typeof levels[0] === 'string') levels = levels.map(x => ({ name: x }));

    renderBranchLevelSelects();
    renderBranchesLevelsTables();
    renderEmployeesTable();

    const st = $('statTotalEmployees');
    if(st) st.textContent = String(employees.length);

    return init;
  }

  async function loadEmployees(opts={}){
    if($('empTableBody')) $('empTableBody').innerHTML = '<tr><td colspan="6" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
    if($('empMobileList')) $('empMobileList').innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

    try{
      await loadInitialData(opts);
      return;
    }catch(e){
      // fallback
    }

    const { result } = await api.callFirst(
      ['getEmployees','listEmployees','getEmployeeList','employees_list'],
      {},
      { failMessage:'‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', signal: opts.signal }
    );

    employees = normalizeArray(result);
    renderEmployeesTable();
    const st = $('statTotalEmployees');
    if(st) st.textContent = String(employees.length);
  }

  // ===== Dashboard =====
  async function loadDashboard(opts={}){
    if($('dashboardTodayBody')) $('dashboardTodayBody').innerHTML = '<tr><td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
    if($('dashboardLocationSummary')) $('dashboardLocationSummary').innerHTML = '';

    const now = new Date();
    const yearBE = now.getFullYear() + 543;
    const month = now.getMonth() + 1;
    const yearAD = now.getFullYear();

    try{
      const init = await api.call('getInitialData', {}, opts);
      const empRes = normalizeArray(init.employees || init.employeeList || init.emp);
      if(empRes.length) employees = empRes;
      const st = $('statTotalEmployees');
      if(st) st.textContent = String(employees.length);

      branches = normalizeArray(init.branches || init.branchList || init.departments);
      levels = normalizeArray(init.levels || init.levelList || init.positions);
      if(branches.length && typeof branches[0] === 'string') branches = branches.map(x => ({ name: x }));
      if(levels.length && typeof levels[0] === 'string') levels = levels.map(x => ({ name: x }));
      renderBranchLevelSelects();
    }catch(e){
      // ignore
    }

    const [todaySummary, monthSummary] = await Promise.all([
      api.call('getTodaySummary', {}, opts),
      api.call('getSummaryRange', { year: yearAD, month, branch:'ALL' }, opts),
    ]);

    const leaveCount = await safeGetLeaveCountForMonth({ yearBE, yearAD, month, signal: opts.signal });
    renderDashboard(todaySummary || [], monthSummary || { rows:[] }, leaveCount);
  }

  async function safeGetLeaveCountForMonth({yearBE, yearAD, month, signal}){
    try{
      const params = {
        year: yearBE, yearBE, yearAD,
        month,
        branch: 'ALL',
        status: 'ALL',
        statusEN: 'ALL',
        statusTH: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'
      };
      const { result } = await callLeaveList(params, { signal, silent: true });
      const rows = pickArr(result);
      const uniq = new Set();
      rows.forEach(r => {
        const st = normalizeLeaveStatus(r.status || r.leaveStatus || r.state || r.approvalStatus || '');
        if(st === 'REJECTED' || st === 'CANCELLED') return;
        const code = r.code || r.empCode || r.employeeCode || '';
        if(code) uniq.add(String(code));
      });
      return uniq.size;
    }catch(e){
      return null;
    }
  }

  function renderDashboard(todaySummary, monthSummary, leaveCount){
    const todayRows = Array.isArray(todaySummary) ? todaySummary : normalizeArray(todaySummary);
    const loggedRows = todayRows.filter(hasAnyLogRow);
    if($('statTodayCount')) $('statTodayCount').textContent = String(loggedRows.length);

    let lateCount = 0;
    loggedRows.forEach(r => {
      const st = String(r.status || '');
      if(st.includes('‡∏™‡∏≤‡∏¢') || st.includes('‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏ß') || st.includes('‡∏≠‡∏≠‡∏Å‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏ß')) lateCount++;
    });
    if($('statTodayLate')) $('statTodayLate').textContent = `‡∏™‡∏≤‡∏¢ ${lateCount} ‡∏Ñ‡∏ô`;

    const rows = normalizeArray(monthSummary?.rows || monthSummary);
    let normal=0, late=0, absent=0;
    rows.forEach(r => {
      normal += Number(r.normalCount || 0);
      late   += Number(r.lateCount || 0);
      absent += Number(r.absentCount || 0);
    });

    const leaveText = (leaveCount == null) ? '-' : String(leaveCount);
    if($('statMonthOverview')) $('statMonthOverview').textContent = `${normal} ‡∏õ‡∏Å‡∏ï‡∏¥ / ${late} ‡∏™‡∏≤‡∏¢ / ${absent} ‡∏Ç‡∏≤‡∏î / ${leaveText} ‡∏•‡∏≤`;

    const tbody = $('dashboardTodayBody');
    if(tbody){
      if(!todayRows.length){
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</td></tr>';
      }else{
        tbody.innerHTML = todayRows.map(r => `
            <tr>
              <td>${escHtml(r.code || '')}</td>
              <td>${escHtml(r.fullName || '')}</td>
              <td>${escHtml((isRealTime(r.t1) ? r.t1 : '-') || '-')}</td>
              <td>${escHtml((isRealTime(r.t2) ? r.t2 : '-') || '-')}</td>
              <td>${escHtml((isRealTime(r.t3) ? r.t3 : '-') || '-')}</td>
              <td>${escHtml((isRealTime(r.t4) ? r.t4 : '-') || '-')}</td>
              <td>${penaltyHtmlFromRow(r)}</td>
              <td>${statusBadgeHtml(r.status || '')}</td>
            </tr>
        `).join('');
      }
    }

    const locBox = $('dashboardLocationSummary');
    if(locBox){
      const locMap = {};
      loggedRows.forEach(r => {
        const loc = r.locationText || r.location || '';
        if(!loc) return;
        locMap[loc] = (locMap[loc] || 0) + 1;
      });
      const entries = Object.entries(locMap);
      locBox.innerHTML = entries.length
        ? entries.map(([name,count]) => `<span class="tag">${escHtml(name)} ‚Äì ${escHtml(count)} ‡∏Ñ‡∏ô</span>`).join(' ')
        : '<span class="helper">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
    }
  }

  // ===== Logs =====
  function renderLogsTable(res){
    const rows = normalizeArray(res?.rows || res);
    const tb = $('logsTableBody');
    const mobileList = $('logsMobileList');

    if(!rows.length){
      if(tb) tb.innerHTML = '<tr><td colspan="10" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      return;
    }

    if(tb){
      tb.innerHTML = rows.map((r) => {
        const total = calcTotalHours(r.t1, r.t4);
        const locText = r.locationText || r.location || '';
        const locCell = locText ? `<span class="tag">${escHtml(locText)}</span>` : '-';
        const evidence = r.evidenceUrl ? `<a href="${escHtml(r.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a>` : '-';

        return `
          <tr>
            <td>${escHtml(formatDateThai(r.date))}</td>
            <td>${escHtml(r.code || '')}</td>
            <td>${escHtml(r.fullName || '')}</td>
            <td>${escHtml(r.t1 || '-')}</td>
            <td>${escHtml(r.t4 || '-')}</td>
            <td>${escHtml(total)}</td>
            <td>${penaltyHtmlFromRow(r)}</td>
            <td>${statusBadgeHtml(r.status || '')}</td>
            <td>${locCell}</td>
            <td>${evidence}</td>
          </tr>
        `;
      }).join('');
    }

    if(mobileList){
      mobileList.innerHTML = rows.map((r) => {
        const d = formatDateThai(r.date);
        const total = calcTotalHours(r.t1, r.t4);
        const loc = r.locationText || r.location || '-';
        const evidence = r.evidenceUrl ? `<a href="${escHtml(r.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</a>` : '-';
        const p = calcPenaltyFromStatus(r.status || '');
        const pText = (p.kind === 'unknown') ? 'UNKNOWN' : minutesToThai(p.minutes || 0);

        return `
          <div class="item">
            <div class="item-top">
              <div style="min-width:0;">
                <div class="item-title">${escHtml(r.fullName || '-')}</div>
                <div class="item-meta">
                  <span class="tag">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${escHtml(d)}</span>
                  <span class="tag">${escHtml(loc)}</span>
                </div>
              </div>
              <div class="code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(r.code || '-')}</div>
            </div>

            <div class="kv">
              <div class="k">‡πÄ‡∏Ç‡πâ‡∏≤</div><div class="v">${escHtml(r.t1 || '-')}</div>
              <div class="k">‡∏≠‡∏≠‡∏Å</div><div class="v">${escHtml(r.t4 || '-')}</div>
              <div class="k">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°</div><div class="v">${escHtml(total)}</div>
              <div class="k">‡∏£‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="v">${escHtml(pText)}</div>
              <div class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="v">${escHtml(r.status || '-')}</div>
              <div class="k">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</div><div class="v">${evidence}</div>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  async function reloadLogs(opts={}){
    if($('logsTableBody')) $('logsTableBody').innerHTML = '<tr><td colspan="10" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
    if($('logsMobileList')) $('logsMobileList').innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

    const yearBE  = $('logYearFilter')?.value;
    const yearAD = beToAd(yearBE);
    const month = $('logMonthFilter')?.value;
    const branch = $('logBranchFilter')?.value || 'ALL';
    const search = ( ($('logSearch')?.value) || '' ).trim();

    const res = await api.call('getLogsRange', { year: yearAD, month, branch, search }, opts);
    renderLogsTable(res);
  }

  // ===== Summary =====
  function renderSummaryTable(res){
    const rows = normalizeArray(res?.rows || res);
    const tb = $('summaryTableBody');
    const mobileList = $('summaryMobileList');

    if(!rows.length){
      if(tb) tb.innerHTML = '<tr><td colspan="8" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
      return;
    }

    if(tb){
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${escHtml(r.code || '')}</td>
          <td>${escHtml(r.fullName || '')}</td>
          <td>${escHtml(r.branch || '')}</td>
          <td>${escHtml(r.level || '')}</td>
          <td>${escHtml(r.days || 0)}</td>
          <td>${escHtml(r.normalCount || 0)}</td>
          <td>${escHtml(r.lateCount || 0)}</td>
          <td>${escHtml(r.absentCount || 0)}</td>
        </tr>
      `).join('');
    }

    if(mobileList){
      mobileList.innerHTML = rows.map(r => `
        <div class="item">
          <div class="item-top">
            <div style="min-width:0;">
              <div class="item-title">${escHtml(r.fullName || '-')}</div>
              <div class="item-meta">
                <span class="tag">‡πÅ‡∏ú‡∏ô‡∏Å: ${escHtml(r.branch || '-')}</span>
                <span class="tag">‡∏£‡∏∞‡∏î‡∏±‡∏ö: ${escHtml(r.level || '-')}</span>
              </div>
            </div>
            <div class="code-badge">‡∏£‡∏´‡∏±‡∏™ ${escHtml(r.code || '-')}</div>
          </div>

          <div class="kv">
            <div class="k">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</div><div class="v">${escHtml(r.days || 0)}</div>
            <div class="k">‡∏õ‡∏Å‡∏ï‡∏¥</div><div class="v">${escHtml(r.normalCount || 0)}</div>
            <div class="k">‡∏™‡∏≤‡∏¢</div><div class="v">${escHtml(r.lateCount || 0)}</div>
            <div class="k">‡∏Ç‡∏≤‡∏î</div><div class="v">${escHtml(r.absentCount || 0)}</div>
          </div>
        </div>
      `).join('');
    }
  }

  async function reloadSummary(opts={}){
    if($('summaryTableBody')) $('summaryTableBody').innerHTML = '<tr><td colspan="8" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
    if($('summaryMobileList')) $('summaryMobileList').innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

    const yearBE  = $('sumYearFilter')?.value;
    const yearAD = beToAd(yearBE);
    const month = $('sumMonthFilter')?.value;
    const branch = $('sumBranchFilter')?.value || 'ALL';

    const res = await api.call('getSummaryRange', { year: yearAD, month, branch }, opts);
    renderSummaryTable(res);
  }

  // =========================================================
  // ===================== LEAVE (‡πÉ‡∏´‡πâ 100% ‡πÅ‡∏ö‡∏ö leave.html) ===
  // =========================================================
  function getLeaveActionsCache(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_LEAVE_ACTIONS_KEY) || '{}') || {}; }
    catch(e){ return {}; }
  }
  function setLeaveActionsCache(obj){
    localStorage.setItem(STORAGE_LEAVE_ACTIONS_KEY, JSON.stringify(obj || {}));
  }

  function getLeaveCustom(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_LEAVE_CUSTOM_KEY) || '{}') || {}; }
    catch(e){ return {}; }
  }
  function setLeaveCustom(obj){
    localStorage.setItem(STORAGE_LEAVE_CUSTOM_KEY, JSON.stringify(obj || {}));
  }

  function normalizeLeaveStatus(s){
    const raw = String(s || '').trim();
    if(!raw) return 'PENDING';
    const up = raw.toUpperCase();
    if(up === 'PENDING' || raw.includes('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô')) return 'PENDING';
    if(up === 'APPROVED' || raw === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') return 'APPROVED';
    if(up === 'REJECTED' || raw.includes('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || raw.includes('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò')) return 'REJECTED';
    if(raw.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || up === 'CANCELLED' || up === 'CANCELED') return 'CANCELLED';
    if(up === 'ALL' || raw === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') return 'ALL';
    return up || raw;
  }

  function statusToThaiChip(st){
    const n = normalizeLeaveStatus(st);
    if(n === 'PENDING') return '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
    if(n === 'APPROVED') return '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    if(n === 'REJECTED') return '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
    if(n === 'CANCELLED') return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
    if(n === 'ALL') return '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    return st || '-';
  }

  function leaveStatusBadge(status){
    const n = normalizeLeaveStatus(status);
    if(n === 'PENDING') return '<span class="badge-status badge-other">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
    if(n === 'APPROVED') return '<span class="badge-status badge-normal">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
    if(n === 'REJECTED') return '<span class="badge-status badge-absent">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
    if(n === 'CANCELLED') return '<span class="badge-status badge-unknown">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
    return '<span class="badge-status badge-unknown">'+escHtml(statusToThaiChip(status))+'</span>';
  }

  function pickArr(res){
    return normalizeArray(res);
  }

  function getLeaveId(r){
    return r.id || r.leaveId || r.requestId || r.uuid || r._id || r.key || '';
  }
  function getLeaveCreatedAt(r){
    return r.createdAt || r.requestDate || r.submittedAt || r.timestamp || r.created || r.date || '';
  }
  function getLeaveType(r){
    return r.leaveType || r.type || r.leave_name || r.leaveName || r.kind || '-';
  }
  function getLeaveReason(r){
    return r.reason || r.detail || r.note || r.remark || '-';
  }
  function getLeaveRange(r){
    const s = r.startDate || r.dateStart || r.fromDate || r.from || r.start || '';
    const e = r.endDate || r.dateEnd || r.toDate || r.to || r.end || '';
    if(s && e){
      const ds = String(s).slice(0,10);
      const de = String(e).slice(0,10);
      if(ds === de) return ds;
      return `${ds} ‚Üí ${de}`;
    }
    return r.range || r.dateRange || r.period || r.dates || '-';
  }
  function getLeaveAttachUrl(r){
    return r.attachUrl || r.attachmentUrl || r.fileUrl || r.evidenceUrl || r.photoUrl || r.file || r.attach || '';
  }

  const LEAVE_LIST_ACTIONS = [
    'getLeaveRequests','getLeaveHistory','getLeaveHistoryAll','listLeaveRequests','listLeaves',
    'getLeaves','getLeaveList','getLeaveAdmin','getLeaveAdminList','getLeaveRequestsAll',
    'leave_list','leave_getHistory','leave_getHistoryAll','leave_getRequests','leave_getAll',
    'getLeavesRange','getLeaveRange','leave_getRange'
  ];

  const LEAVE_UPDATE_ACTIONS = [
    'updateLeaveStatus','setLeaveStatus','updateLeaveRequest','setLeaveRequestStatus',
    'approveLeave','rejectLeave','approveLeaveRequest','rejectLeaveRequest',
    'leave_updateStatus','leave_setStatus','leave_approve','leave_reject'
  ];

  function buildLeaveQueryParams(){
    const yearBE  = $('leaveYearFilter')?.value;
    const yearAD = beToAd(yearBE);
    const month = $('leaveMonthFilter')?.value;
    const branch = $('leaveBranchFilter')?.value || 'ALL';
    const search = ( ($('leaveSearch')?.value) || '' ).trim();

    const statusEN = leaveStatus;
    const statusTH = statusToThaiChip(leaveStatus);

    return {
      year: yearBE, yearBE, yearAD,
      month, branch, search,
      status: statusEN,
      statusEN,
      statusTH,
      filterStatus: statusEN,
      filter_status: statusEN,
    };
  }

  async function callLeaveList(params, opts = {}){
    const cache = getLeaveActionsCache();
    const custom = getLeaveCustom();

    const prefer = [];
    if(custom.listAction) prefer.push(custom.listAction);
    else if(cache.listAction) prefer.push(cache.listAction);

    const actions = prefer.concat(LEAVE_LIST_ACTIONS.filter(a => !prefer.includes(a)));

    const { action, result } = await api.callFirst(actions, params, {
      failMessage: '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      onSuccess: (act) => { cache.listAction = act; setLeaveActionsCache(cache); },
      signal: opts.signal
    });

    return { action, result };
  }

  async function callLeaveUpdate(params, opts = {}){
    const cache = getLeaveActionsCache();
    const custom = getLeaveCustom();

    const prefer = [];
    if(custom.updateAction) prefer.push(custom.updateAction);
    else if(cache.updateAction) prefer.push(cache.updateAction);

    const actions = prefer.concat(LEAVE_UPDATE_ACTIONS.filter(a => !prefer.includes(a)));

    const { action, result } = await api.callFirst(actions, params, {
      failMessage: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      onSuccess: (act) => { cache.updateAction = act; setLeaveActionsCache(cache); },
      signal: opts.signal
    });

    return { action, result };
  }

  function renderLeave(res){
    const rows = pickArr(res);
    const tb = $('leaveTableBody');
    const mobileList = $('leaveMobileList');

    if(!rows.length){
      if(tb) tb.innerHTML = '<tr><td colspan="9" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
      if(mobileList) mobileList.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
      return;
    }

    if(tb){
      tb.innerHTML = rows.map(r => {
        const id = getLeaveId(r);
        const idJS = JSON.stringify(String(id || ''));

        const createdAt = getLeaveCreatedAt(r);
        const code = r.code || r.empCode || r.employeeCode || '-';
        const fullName = r.fullName || r.name || r.employeeName || '-';
        const type = getLeaveType(r);
        const range = getLeaveRange(r);
        const reason = getLeaveReason(r);
        const attach = getLeaveAttachUrl(r);
        const statusRaw = r.status || r.leaveStatus || r.state || r.approvalStatus || '';
        const status = leaveStatusBadge(statusRaw);

        const nst = normalizeLeaveStatus(statusRaw);
        const canAct = (nst === 'PENDING');

        const attachCell = attach ? `<a href="${escHtml(attach)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</a>` : '-';

        return `
          <tr>
            <td>${escHtml(formatDateThai(createdAt || '-'))}</td>
            <td>${escHtml(code)}</td>
            <td>${escHtml(fullName)}</td>
            <td style="max-width:220px; white-space:normal;">${escHtml(type)}</td>
            <td>${escHtml(range)}</td>
            <td style="max-width:340px; white-space:normal;">${escHtml(reason)}</td>
            <td>${attachCell}</td>
            <td>${status}</td>
            <td>
              <div style="display:flex; gap:6px; flex-wrap:wrap;">
                <button class="btn btn-primary btn-small" ${canAct?'':'disabled'} onclick='approveLeave(${idJS})'>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                <button class="btn btn-danger btn-small" ${canAct?'':'disabled'} onclick='rejectLeave(${idJS})'>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    if(mobileList){
      mobileList.innerHTML = rows.map(r => {
        const id = getLeaveId(r);
        const idJS = JSON.stringify(String(id || ''));

        const createdAt = getLeaveCreatedAt(r);
        const code = r.code || r.empCode || r.employeeCode || '-';
        const fullName = r.fullName || r.name || r.employeeName || '-';
        const type = getLeaveType(r);
        const range = getLeaveRange(r);
        const reason = getLeaveReason(r);
        const attach = getLeaveAttachUrl(r);
        const statusRaw = r.status || r.leaveStatus || r.state || r.approvalStatus || '';
        const status = leaveStatusBadge(statusRaw);

        const nst = normalizeLeaveStatus(statusRaw);
        const canAct = (nst === 'PENDING');
        const attachText = attach ? `<a href="${escHtml(attach)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</a>` : '-';

        return `
          <div class="item">
            <div class="item-top">
              <div style="min-width:0;">
                <div class="item-title">${escHtml(fullName)}</div>
                <div class="item-meta">
                  <span class="tag">‡∏£‡∏´‡∏±‡∏™ ${escHtml(code)}</span>
                  <span class="tag">${escHtml(type)}</span>
                  ${status}
                </div>
              </div>
              <div class="code-badge">${escHtml(formatDateThai(createdAt || '-'))}</div>
            </div>

            <div class="kv">
              <div class="k">‡∏ä‡πà‡∏ß‡∏á‡∏•‡∏≤</div><div class="v">${escHtml(range)}</div>
              <div class="k">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</div><div class="v">${escHtml(reason)}</div>
              <div class="k">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</div><div class="v">${attachText}</div>
            </div>

            <div class="item-actions">
              <button class="btn btn-primary" ${canAct?'':'disabled'} onclick='approveLeave(${idJS})'>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
              <button class="btn btn-danger" ${canAct?'':'disabled'} onclick='rejectLeave(${idJS})'>‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>
          </div>
        `;
      }).join('');
    }
  }

  async function reloadLeave(opts={}){
    if($('leaveTableBody')) $('leaveTableBody').innerHTML = '<tr><td colspan="9" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';
    if($('leaveMobileList')) $('leaveMobileList').innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
    if($('leaveHint')) $('leaveHint').textContent = '';

    const params = buildLeaveQueryParams();

    try{
      const { action, result } = await callLeaveList(params, opts);
      const rows = pickArr(result);

      if($('leaveHint')) $('leaveHint').textContent = `‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (action: ${action}) ‚Ä¢ ‡∏û‡∏ö ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${statusToThaiChip(leaveStatus)}`;
      renderLeave(result);
    }catch(err){
      console.error(err);

      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;

      if($('leaveHint')) $('leaveHint').textContent = '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message + ' (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î leave.html ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà Action ‡πÉ‡∏ô Advanced)';
      if($('leaveTableBody')) $('leaveTableBody').innerHTML = '<tr><td colspan="9" class="text-center">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>';
      if($('leaveMobileList')) $('leaveMobileList').innerHTML = '<div class="helper">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    }
  }

  async function updateLeaveStatus(id, statusEN, opts={}){
    if(!id) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö id ‡πÉ‡∏ö‡∏•‡∏≤');

    const remark = prompt(
      (statusEN === 'APPROVED' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏•‡∏≤' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡∏•‡∏≤') + '\n‡πÉ‡∏™‡πà‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ):',
      ''
    ) ?? '';

    const statusTH = statusToThaiChip(statusEN);

    const payload = {
      id,
      leaveId: id,
      requestId: id,

      status: statusEN,
      statusEN,
      statusTH,

      newStatus: statusEN,
      new_status: statusEN,
      decision: statusEN,

      approved: statusEN === 'APPROVED',
      rejected: statusEN === 'REJECTED',

      remark,
      note: remark,
      adminRemark: remark,
      approvedRemark: remark,
      rejectedRemark: remark,
    };

    const { action } = await callLeaveUpdate(payload, opts);
    return action;
  }

  window.approveLeave = async function(id){
    try{
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Äú‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‚Äù ‡πÉ‡∏ö‡∏•‡∏≤‡∏ô‡∏µ‡πâ?')) return;
      const act = await updateLeaveStatus(id, 'APPROVED');
      alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (action: ' + act + ')');
      await reloadLeave();
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  };

  window.rejectLeave = async function(id){
    try{
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‚Äú‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‚Äù ‡πÉ‡∏ö‡∏•‡∏≤‡∏ô‡∏µ‡πâ?')) return;
      const act = await updateLeaveStatus(id, 'REJECTED');
      alert('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (action: ' + act + ')');
      await reloadLeave();
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      alert('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  };

  // ===== Settings =====
  function renderBranchesLevelsTables(){
    const bt = $('branchTableBody');
    const lt = $('levelTableBody');

    if(bt){
      bt.innerHTML = branches.length
        ? branches.map(b => {
            const nameJS = JSON.stringify(String(b.name));
            return `
              <tr>
                <td>${escHtml(b.name)}</td>
                <td class="text-right"><button class="btn btn-danger btn-small" onclick='deleteBranch(${nameJS})'>‡∏•‡∏ö</button></td>
              </tr>
            `;
          }).join('')
        : '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏Å</td></tr>';
    }

    if(lt){
      lt.innerHTML = levels.length
        ? levels.map(l => {
            const nameJS = JSON.stringify(String(l.name));
            return `
              <tr>
                <td>${escHtml(l.name)}</td>
                <td class="text-right"><button class="btn btn-danger btn-small" onclick='deleteLevel(${nameJS})'>‡∏•‡∏ö</button></td>
              </tr>
            `;
          }).join('')
        : '<tr><td colspan="2" class="text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏∞‡∏î‡∏±‡∏ö</td></tr>';
    }
  }

  async function loadBranchesLevels(opts={}){
    try{
      await loadInitialData(opts);
      return;
    }catch(e){
      // fallback
    }

    const { result } = await api.callFirst(
      ['getBranchesLevels','getBranchesAndLevels','getMeta','getMasterData'],
      {},
      { failMessage:'‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏Å/‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', signal: opts.signal }
    );

    branches = normalizeArray(result?.branches || result?.departments || result?.branchList || result?.branch || []);
    levels   = normalizeArray(result?.levels   || result?.positions   || result?.levelList  || result?.level  || []);
    if(branches.length && typeof branches[0] === 'string') branches = branches.map(x => ({ name: x }));
    if(levels.length && typeof levels[0] === 'string') levels = levels.map(x => ({ name: x }));

    renderBranchLevelSelects();
    renderBranchesLevelsTables();
  }

  window.deleteBranch = async function(name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteBranch', { name });
      await loadBranchesLevels();
      if($('settingsSuccess')){
        $('settingsSuccess').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        $('settingsSuccess').style.display = 'block';
      }
      if($('settingsError')) $('settingsError').style.display = 'none';
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      if($('settingsError')){
        $('settingsError').textContent = '‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        $('settingsError').style.display = 'block';
      }
      if($('settingsSuccess')) $('settingsSuccess').style.display = 'none';
    }
  };

  window.deleteLevel = async function(name){
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö "${name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
    try{
      await api.call('deleteLevel', { name });
      await loadBranchesLevels();
      if($('settingsSuccess')){
        $('settingsSuccess').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        $('settingsSuccess').style.display = 'block';
      }
      if($('settingsError')) $('settingsError').style.display = 'none';
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      if($('settingsError')){
        $('settingsError').textContent = '‡∏•‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        $('settingsError').style.display = 'block';
      }
      if($('settingsSuccess')) $('settingsSuccess').style.display = 'none';
    }
  };

  async function addBranch(){
    const name = ( $('branchName')?.value || '' ).trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    if(errEl) errEl.style.display = 'none';
    if(sucEl) sucEl.style.display = 'none';
    if(!name){
      if(errEl){
        errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å';
        errEl.style.display = 'block';
      }
      return;
    }
    try{
      await api.call('saveBranch', { name });
      if($('branchName')) $('branchName').value = '';
      await loadBranchesLevels();
      if(sucEl){
        sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        sucEl.style.display = 'block';
      }
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      if(errEl){
        errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        errEl.style.display = 'block';
      }
    }
  }

  async function addLevel(){
    const name = ( $('levelName')?.value || '' ).trim();
    const errEl = $('settingsError');
    const sucEl = $('settingsSuccess');
    if(errEl) errEl.style.display = 'none';
    if(sucEl) sucEl.style.display = 'none';
    if(!name){
      if(errEl){
        errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö';
        errEl.style.display = 'block';
      }
      return;
    }
    try{
      await api.call('saveLevel', { name });
      if($('levelName')) $('levelName').value = '';
      await loadBranchesLevels();
      if(sucEl){
        sucEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        sucEl.style.display = 'block';
      }
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      if(errEl){
        errEl.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        errEl.style.display = 'block';
      }
    }
  }

  // ===== Employee modal =====
  function resetEmpForm(keepMsg){
    editingEmpId = null;
    if($('empModalTitle')) $('empModalTitle').textContent = 'üë§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    if($('empModalSub')) $('empModalSub').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô';
    if($('empCode')) $('empCode').value = '';
    if($('empFullName')) $('empFullName').value = '';
    if($('empEmail')) $('empEmail').value = '';
    if($('empBranch')?.options?.length) $('empBranch').selectedIndex = 0;
    if($('empLevel')?.options?.length) $('empLevel').selectedIndex = 0;

    setEmpFaceUI(null);

    if($('empFormError')) $('empFormError').style.display = 'none';
    if(!keepMsg && $('empFormSuccess')) $('empFormSuccess').style.display = 'none';
  }


  // ===== Face enrollment (Employees.faceData / photoUrl) =====
  const FACE_MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
  let faceModelsReady = false;

  async function ensureFaceModels(){
    if(faceModelsReady) return;
    if(!window.faceapi) throw new Error('‡πÇ‡∏´‡∏•‡∏î face-api.js ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(FACE_MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(FACE_MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(FACE_MODEL_URL),
    ]);
    faceModelsReady = true;
  }

  function setEmpFaceUI(emp){
    const photoStatus = $('empFacePhotoStatus');
    const dataStatus  = $('empFaceDataStatus');
    const preview     = $('empFacePreview');
    const fileInput   = $('empFaceFile');

    if(fileInput) fileInput.value = '';

    const hasPhoto = !!(emp && emp.photoUrl);
    const hasData  = !!(emp && emp.faceData && String(emp.faceData).trim().length > 10);

    if(photoStatus) photoStatus.textContent = hasPhoto ? '‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ';
    if(dataStatus)  dataStatus.textContent  = hasData  ? '‡∏°‡∏µ FaceData ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ FaceData';

    if(preview){
      if(hasPhoto){
        preview.src = emp.photoUrl;
        preview.style.display = 'block';
      }else{
        preview.removeAttribute('src');
        preview.style.display = 'none';
      }
    }
  }

  function readFileAsDataURL(file){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result || ''));
      fr.onerror = () => reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      fr.readAsDataURL(file);
    });
  }

  async function uploadEmpFacePhoto(){
    const code = ( $('empCode')?.value || '' ).trim();
    const file = $('empFaceFile')?.files?.[0];
    if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
    if(!file) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');

    const dataUrl = await readFileAsDataURL(file);
    const base64 = dataUrl.split(',')[1] || '';

    if(!base64) throw new Error('‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô base64 ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    const resp = await api.call('uploadEmployeeFace', {
      code,
      photoBase64: base64,
      photoName: file.name || `face_${code}.jpg`,
      mimeType: file.type || 'image/jpeg'
    });

    // update local cache if any
    const emp = (employees || []).find(e => String(e.code) === String(code));
    if(emp && resp && resp.photoUrl) emp.photoUrl = resp.photoUrl;

    setEmpFaceUI(emp || { photoUrl: resp.photoUrl, faceData: emp?.faceData || '' });
    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');
  }

  async function extractAndSaveEmpFaceData(){
    const code = ( $('empCode')?.value || '' ).trim();
    const file = $('empFaceFile')?.files?.[0];
    if(!code) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
    if(!file) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô');

    await ensureFaceModels();

    const dataUrl = await readFileAsDataURL(file);

    const img = new Image();
    img.src = dataUrl;
    await new Promise((res, rej) => {
      img.onload = () => res();
      img.onerror = () => rej(new Error('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    });

    const det = await faceapi
      .detectSingleFace(img, new faceapi.TinyFaceDetectorOptions({ inputSize: 416, scoreThreshold: 0.5 }))
      .withFaceLandmarks()
      .withFaceDescriptor();

    if(!det || !det.descriptor) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ (‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)');

    const arr = Array.from(det.descriptor);
    const faceData = JSON.stringify(arr);

    const resp = await api.call('saveEmployeeFaceDescriptor', { code, faceData });

    // update local cache
    const emp = (employees || []).find(e => String(e.code) === String(code));
    if(emp) emp.faceData = faceData;

    setEmpFaceUI(emp || { photoUrl: emp?.photoUrl || '', faceData });
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å FaceData ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');
  }



  function openEmpAdd(){
    resetEmpForm(false);
    openModal('empModalBackdrop');
  }

  window.editEmployee = function(id){
    const emp = (employees || []).find(e => String(e.id) === String(id));
    if(!emp) return;

    editingEmpId = emp.id;
    if($('empModalTitle')) $('empModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
    if($('empModalSub')) $('empModalSub').textContent = `‡∏£‡∏´‡∏±‡∏™ ${emp.code || '-'} ‚Ä¢ ${emp.fullName || '-'}`;

    if($('empCode')) $('empCode').value = emp.code || '';
    if($('empFullName')) $('empFullName').value = emp.fullName || '';
    if($('empEmail')) $('empEmail').value = emp.email || '';
    if($('empBranch')) $('empBranch').value = emp.branch || '';
    if($('empLevel')) $('empLevel').value = emp.level || '';

    if($('empFormError')) $('empFormError').style.display = 'none';
    if($('empFormSuccess')) $('empFormSuccess').style.display = 'none';
    setEmpFaceUI(emp);
    openModal('empModalBackdrop');
  };

  async function saveEmployee(){
    const code = ( $('empCode')?.value || '' ).trim();
    const fullName = ( $('empFullName')?.value || '' ).trim();
    const branch = ( $('empBranch')?.value || '' ).trim();
    const level  = ( $('empLevel')?.value || '' ).trim();
    const email  = ( $('empEmail')?.value || '' ).trim();

    const errEl = $('empFormError');
    const sucEl = $('empFormSuccess');
    if(errEl) errEl.style.display = 'none';
    if(sucEl) sucEl.style.display = 'none';

    if(!code || !fullName){
      if(errEl){
        errEl.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•';
        errEl.style.display = 'block';
      }
      return;
    }

    try{
      await api.call('saveEmployee', {
        id: editingEmpId || '',
        code, fullName, branch, level, email,
        photoBase64: ''
      });

      await loadEmployees();

      if(sucEl){
        sucEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        sucEl.style.display = 'block';
      }

      setTimeout(() => {
        closeModal('empModalBackdrop');
        resetEmpForm(false);
      }, 250);
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      if(errEl){
        errEl.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        errEl.style.display = 'block';
      }
    }
  }

  window.deleteEmployeeConfirm = async function(id){
    const emp = (employees || []).find(e => String(e.id) === String(id));
    if(!emp) return;
    if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™ ${emp.code || ''} (${emp.fullName || ''}) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    try{
      await api.call('deleteEmployee', { id });
      await loadEmployees();
      alert('‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(err){
      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;
      alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  };

  // ===== init =====
  async function initAdmin(force=false){
    const apiUrl = getApiUrl();
    setApiText(apiUrl);
    setAdminText();

    if(!apiUrl){
      setConnectionStatus(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
      return;
    }

    try{
      if($('logYearFilter') && $('logMonthFilter')) fillYearMonthSelect($('logYearFilter'), $('logMonthFilter'));
      if($('sumYearFilter') && $('sumMonthFilter')) fillYearMonthSelect($('sumYearFilter'), $('sumMonthFilter'));
      if($('leaveYearFilter') && $('leaveMonthFilter')) fillYearMonthSelect($('leaveYearFilter'), $('leaveMonthFilter'));

      await loadBranchesLevels();
      await refreshCurrentSection(getActiveSection(), true);

      setLastUpdated();
      setConnectionStatus(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }catch(err){
      console.error(err);
      setConnectionStatus(false, err.message);

      const asked = await ensureLoginIfNeeded(err);
      if(asked) return;

      alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
    }
  }

  // ===== Leave custom actions UI =====
  function loadLeaveCustomToUI(){
    const c = getLeaveCustom();
    if($('leaveListActionCustom')) $('leaveListActionCustom').value = c.listAction || '';
    if($('leaveUpdateActionCustom')) $('leaveUpdateActionCustom').value = c.updateAction || '';
  }

  function saveLeaveCustomFromUI(){
    const listAction = ( $('leaveListActionCustom')?.value || '' ).trim();
    const updateAction = ( $('leaveUpdateActionCustom')?.value || '' ).trim();
    setLeaveCustom({ listAction, updateAction });
  }

  function clearLeaveCustom(){
    localStorage.removeItem(STORAGE_LEAVE_CUSTOM_KEY);
    if($('leaveListActionCustom')) $('leaveListActionCustom').value = '';
    if($('leaveUpdateActionCustom')) $('leaveUpdateActionCustom').value = '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.nav-item').forEach(el => el.addEventListener('click', () => switchSection(el.dataset.section)));
    document.querySelectorAll('.bottom-item').forEach(el => el.addEventListener('click', () => switchSection(el.dataset.section)));

    $('btnBackToFront')?.addEventListener('click', () => window.location.href = 'index.html');
    $('btnLogout')?.addEventListener('click', () => {
      if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏•‡∏ö URL API + Token) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        setApiUrl('');
        setAdminToken('');
        setAdminName('');
        window.location.href = 'index.html';
      }
    });

    $('btnSetUrl')?.addEventListener('click', openUrlCard);
    $('btnSaveUrl')?.addEventListener('click', saveUrl);
    $('btnCancelUrl')?.addEventListener('click', closeUrlCard);

    $('btnRefreshNow')?.addEventListener('click', async () => {
      await refreshCurrentSection(getActiveSection(), false);
    });

    $('apiUrlDisplay')?.addEventListener('click', async () => {
      const full = $('apiUrlDisplay').dataset.full || '';
      if(!full) return;
      try{
        await navigator.clipboard.writeText(full);
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß');
      }catch(e){
        prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ô‡∏µ‡πâ:', full);
      }
    });

    // employees
    $('empSearch')?.addEventListener('input', renderEmployeesTable);
    $('btnOpenAddEmp')?.addEventListener('click', openEmpAdd);

    $('btnCloseEmpModal')?.addEventListener('click', () => closeModal('empModalBackdrop'));
    $('empModalBackdrop')?.addEventListener('click', (e) => { if(e.target === $('empModalBackdrop')) closeModal('empModalBackdrop'); });
    $('btnResetEmpForm')?.addEventListener('click', () => resetEmpForm(false));
    $('btnSaveEmployee')?.addEventListener('click', saveEmployee);

    // face enrollment
    $('btnUploadEmpFace')?.addEventListener('click', async () => {
      try{ await uploadEmpFacePhoto(); }catch(err){
        const asked = await ensureLoginIfNeeded(err);
        if(asked) return;
        alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    $('btnExtractEmpFace')?.addEventListener('click', async () => {
      try{ await extractAndSaveEmpFaceData(); }catch(err){
        const asked = await ensureLoginIfNeeded(err);
        if(asked) return;
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å FaceData ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      }
    });

    $('empFaceFile')?.addEventListener('change', async () => {
      const file = $('empFaceFile')?.files?.[0];
      const preview = $('empFacePreview');
      if(!preview) return;
      if(!file){ preview.style.display='none'; preview.removeAttribute('src'); return; }
      try{
        const dataUrl = await readFileAsDataURL(file);
        preview.src = dataUrl;
        preview.style.display='block';
      }catch(e){
        preview.style.display='none';
        preview.removeAttribute('src');
      }
    });

    // logs
    $('btnReloadLogs')?.addEventListener('click', () => reloadLogs());
    $('logSearch')?.addEventListener('keydown', e => { if(e.key === 'Enter') reloadLogs(); });
    $('logBranchFilter')?.addEventListener('change', () => reloadLogs());
    $('logMonthFilter')?.addEventListener('change', () => reloadLogs());
    $('logYearFilter')?.addEventListener('change', () => reloadLogs());

    // summary
    $('btnReloadSummary')?.addEventListener('click', () => reloadSummary());
    $('sumBranchFilter')?.addEventListener('change', () => reloadSummary());
    $('sumMonthFilter')?.addEventListener('change', () => reloadSummary());
    $('sumYearFilter')?.addEventListener('change', () => reloadSummary());

    // leave
    $('btnReloadLeave')?.addEventListener('click', () => reloadLeave());
    $('leaveSearch')?.addEventListener('keydown', e => { if(e.key === 'Enter') reloadLeave(); });
    $('leaveBranchFilter')?.addEventListener('change', () => reloadLeave());
    $('leaveMonthFilter')?.addEventListener('change', () => reloadLeave());
    $('leaveYearFilter')?.addEventListener('change', () => reloadLeave());

    document.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        ch.classList.add('active');
        leaveStatus = ch.dataset.leaveStatus || 'PENDING';
        reloadLeave();
      });
    });

    // leave advanced actions
    loadLeaveCustomToUI();
    $('btnSaveLeaveActions')?.addEventListener('click', async () => {
      saveLeaveCustomFromUI();
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Action ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      await reloadLeave();
    });
    $('btnClearLeaveActions')?.addEventListener('click', async () => {
      clearLeaveCustom();
      alert('‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
      await reloadLeave();
    });

    $('btnOpenLeaveStandalone')?.addEventListener('click', () => {
      window.location.href = 'leave.html';
    });

    // settings
    $('btnAddBranch')?.addEventListener('click', addBranch);
    $('btnAddLevel')?.addEventListener('click', addLevel);

    // login modal events
    $('btnCloseLogin')?.addEventListener('click', () => closeModal('loginModalBackdrop'));
    $('loginModalBackdrop')?.addEventListener('click', (e) => { if(e.target === $('loginModalBackdrop')) closeModal('loginModalBackdrop'); });

    $('btnClearToken')?.addEventListener('click', () => {
      setAdminToken('');
      setAdminName('');
      setAdminText();
      alert('‡∏•‡πâ‡∏≤‡∏á Token ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
    });

    $('btnDoLogin')?.addEventListener('click', async () => {
      const u = ( $('loginUser')?.value || '' ).trim();
      const p = ( $('loginPass')?.value || '' ).trim();
      if($('loginError')) $('loginError').style.display = 'none';

      if(!p){
        if($('loginError')){
          $('loginError').style.display = 'block';
          $('loginError').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
        }
        return;
      }

      try{
        await tryLoginAdmin(u, p);
        closeModal('loginModalBackdrop');
        await initAdmin(true);
        alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ');
      }catch(err){
        if($('loginError')){
          $('loginError').style.display = 'block';
          $('loginError').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message;
        }
      }
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏ó‡πá‡∏ö: ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ‚Äú‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‚Äù (‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á interval)
    document.addEventListener('visibilitychange', () => {
      if(document.visibilityState === 'visible'){
        refreshCurrentSection(getActiveSection(), true);
      }
    });
    window.addEventListener('focus', () => refreshCurrentSection(getActiveSection(), true));

    initAdmin();
  });
</script>
</body>
</html>
