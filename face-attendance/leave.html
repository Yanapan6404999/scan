<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤ ‚Ä¢ Leave Request</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --soft:#dbeafe;

      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;

      --success:#16a34a;
      --danger:#ef4444;
      --warning:#f59e0b;

      --shadow: 0 18px 40px rgba(15,23,42,.08);
      --shadow2: 0 30px 80px rgba(15,23,42,.18);
    }

    *{ box-sizing:border-box; font-family:"Prompt",system-ui,-apple-system,"Segoe UI",sans-serif; }
    html,body{ margin:0; padding:0; width:100%; overflow-x:hidden; }
    body{
      color:var(--text);
      background:
        radial-gradient(circle at 20% 10%, #e0e7ff 0, transparent 55%),
        radial-gradient(circle at 80% 90%, #e5f5ff 0, transparent 55%),
        var(--bg);
    }

    a{ color:var(--primary); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{
      position:sticky; top:0; z-index:30;
      background:rgba(2,6,23,.86);
      border-bottom:1px solid rgba(15,23,42,.45);
      color:#e5e7eb;
      padding:12px 14px;
      backdrop-filter: blur(14px);
    }
    .topbar{
      max-width:1050px; margin:0 auto;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .tb-left{ min-width:0; }
    .tb-title{ font-weight:900; font-size:18px; letter-spacing:.2px; }
    .tb-sub{
      font-size:12px; color:#94a3b8; margin-top:2px;
      display:flex; flex-wrap:wrap; align-items:center; gap:8px;
    }
    #apiUrlDisplay{ cursor:pointer; word-break:break-all; overflow-wrap:anywhere; }
    .tb-right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .badge-connection{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:999px;
      font-size:11px; font-weight:900;
      background:rgba(15,118,110,.14);
      color:#a5f3fc;
      border:1px solid rgba(34,197,94,.75);
      white-space:nowrap;
    }
    .badge-connection.offline{
      background:rgba(127,29,29,.30);
      color:#fecaca;
      border-color:rgba(248,113,113,.85);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background:#22c55e; box-shadow:0 0 10px rgba(34,197,94,.75);
    }
    .badge-connection.offline .dot{
      background:#f97373; box-shadow:0 0 10px rgba(248,113,113,.75);
    }

    main{ padding:16px 12px 22px; }
    .wrap{ max-width:1050px; margin:0 auto; }

    .card{
      background:rgba(255,255,255,.92);
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:var(--shadow), 0 0 0 1px rgba(226,232,240,.92);
      border:1px solid rgba(226,232,240,.92);
      margin-bottom:14px;
      overflow:hidden;
    }

    .card-header{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-title{
      font-size:15px; font-weight:900;
      display:flex; align-items:center; gap:8px;
    }
    .icon{
      width:24px; height:24px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:13px; background:var(--soft); color:var(--primary);
    }
    .card-sub{ font-size:12px; color:var(--muted); line-height:1.5; }

    .grid-2{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    .grid-3{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px; }
    @media (max-width:900px){ .grid-2,.grid-3{ grid-template-columns:1fr; } }

    .helper{ font-size:12px; color:var(--muted); }
    .mt-8{ margin-top:8px; }
    .mt-10{ margin-top:10px; }
    .mt-12{ margin-top:12px; }

    .input, .textarea, select.input{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      padding:11px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .textarea{ min-height:90px; resize:vertical; }
    .input:focus, .textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,.14);
    }
    .input:disabled, .textarea:disabled, select:disabled{
      background:#f8fafc;
      color:#94a3b8;
      cursor:not-allowed;
      box-shadow:none;
    }

    .btn{
      border:none; cursor:pointer; border-radius:999px;
      padding:10px 14px; font-size:13px; font-weight:800;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition:transform .08s ease, box-shadow .08s ease, background .1s ease, opacity .1s ease;
      white-space:nowrap;
    }
    .btn:active{ transform:translateY(1px) scale(.99); }
    .btn:disabled{ opacity:.55; cursor:default; transform:none; }
    .btn-primary{ background:linear-gradient(135deg,var(--primary),var(--primary2)); color:#fff; box-shadow:0 14px 30px rgba(37,99,235,.25); }
    .btn-secondary{ background:#fff; border:1px solid var(--border); color:#111827; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-small{ padding:7px 11px; font-size:12px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:#fff;
      color:#334155;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, box-shadow .12s ease, background .12s ease;
    }
    .tab:active{ transform:translateY(1px); }
    .tab.active{
      background:rgba(37,99,235,.10);
      border-color:rgba(37,99,235,.35);
      color:#1d4ed8;
      box-shadow:0 10px 18px rgba(37,99,235,.12);
    }

    .pill{
      font-size:11px; padding:4px 10px; border-radius:999px;
      background:#eef2ff; color:#1d4ed8;
      border:1px solid rgba(37,99,235,.18);
      font-weight:900;
      display:inline-flex; align-items:center; gap:6px;
      white-space:nowrap;
    }
    .tag{
      font-size:11px; padding:4px 10px; border-radius:999px;
      background:#f1f5f9; color:#334155;
      border:1px solid rgba(148,163,184,.30);
      font-weight:900;
      display:inline-flex; align-items:center; gap:6px;
      white-space:nowrap;
    }

    .status-badge{ font-size:11px; padding:4px 10px; border-radius:999px; font-weight:900; display:inline-block; }
    .st-pending{ background:#fef3c7; color:#92400e; }
    .st-approved{ background:#dcfce7; color:#166534; }
    .st-rejected{ background:#fee2e2; color:#b91c1c; }
    .st-canceled{ background:#e2e8f0; color:#334155; }
    .st-unknown{ background:#0b1220; color:#e5e7eb; border:1px solid rgba(148,163,184,.35); }

    .list{ display:flex; flex-direction:column; gap:10px; padding-top:6px; }
    .item{
      border:1px solid rgba(226,232,240,.95);
      border-radius:18px;
      padding:12px 12px 10px;
      background:#fff;
      box-shadow:0 12px 24px rgba(15,23,42,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item-top{
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .item-title{ font-weight:900; font-size:14px; line-height:1.25; }
    .item-meta{ font-size:12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .kv{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:6px 10px;
      font-size:12px;
      color:#0f172a;
    }
    .kv .k{ color:var(--muted); }
    .kv .v{ font-weight:800; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
      padding-top:6px;
      border-top:1px dashed rgba(148,163,184,.35);
    }

    #urlCard{
      position:fixed;
      right:14px;
      bottom:14px;
      max-width:520px;
      width:calc(100% - 28px);
      z-index:60;
      display:none;
    }

    .error{ font-size:12px; color:var(--danger); font-weight:900; margin-top:8px; }
    .ok{ font-size:12px; color:var(--success); font-weight:900; margin-top:8px; }
    .hide{ display:none !important; }

    /* Edit banner */
    .edit-banner{
      border:1px solid rgba(37,99,235,.25);
      background:rgba(37,99,235,.08);
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .edit-banner .title{ font-weight:900; }
    .edit-banner .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="tb-left">
      <div class="tb-title">‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</div>
      <div class="tb-sub">
        <span id="apiUrlDisplay" title="‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL"></span>
        <span id="lastUpdated" style="font-weight:900;">‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</span>
      </div>
    </div>
    <div class="tb-right">
      <div id="connBadge" class="badge-connection offline">
        <span class="dot"></span>
        <span id="connText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
      </div>
      <button class="btn btn-secondary" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button class="btn btn-secondary" id="btnSetUrl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL</button>
      <button class="btn btn-secondary" id="btnBack">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="icon">üßë‚Äçüíº</span>‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <div class="card-sub">‡πÉ‡∏™‡πà ‚Äú‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</div>
        </div>
      </div>

      <div class="grid-3">
        <div>
          <div class="helper">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div>
          <input class="input" id="empCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1011" inputmode="numeric" />
        </div>
        <div>
          <div class="helper">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
          <input class="input" id="empName" placeholder="‡∏Å‡∏î ‚Äú‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù" disabled />
        </div>
        <div style="display:flex; align-items:end; gap:8px;">
          <button class="btn btn-primary" id="btnLoadEmp" style="flex:1;">üîé ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button class="btn btn-secondary" id="btnClearEmp">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
      </div>

      <div class="mt-10" id="empInfoRow" style="display:none;">
        <div class="item-meta">
          <span class="tag" id="empBranchTag">‡πÅ‡∏ú‡∏ô‡∏Å: -</span>
          <span class="tag" id="empLevelTag">‡∏£‡∏∞‡∏î‡∏±‡∏ö: -</span>
          <span class="pill" id="empCodeTag">‡∏£‡∏´‡∏±‡∏™: -</span>
          <span class="pill" id="modeTag" title="‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Leave">MODE: -</span>
        </div>
      </div>

      <div id="empErr" class="error" style="display:none;"></div>
      <div id="empOk" class="ok" style="display:none;"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="icon">üßæ</span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤</div>
          <div class="card-sub">
            ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:
            <b>LEAVE-API</b> (‡∏ñ‡πâ‡∏≤ GS ‡∏°‡∏µ action ‡πÉ‡∏ö‡∏•‡∏≤) ‡∏´‡∏£‡∏∑‡∏≠ <b>FALLBACK</b> (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡πà‡∏≤‡∏ô Logs/ManualLog)
          </div>
        </div>
        <div class="tabs">
          <div class="tab active" data-tab="submit">‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</div>
          <div class="tab" data-tab="history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
        </div>
      </div>

      <!-- SUBMIT TAB -->
      <div id="tab-submit">

        <!-- edit banner -->
        <div id="editBanner" class="edit-banner hide">
          <div>
            <div class="title" id="editBannerTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏•‡∏≤</div>
            <div class="sub" id="editBannerSub">‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‚Äù</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn btn-secondary btn-small" id="btnCancelEdit">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </div>
        </div>

        <!-- status latest -->
        <div class="card" style="margin-bottom:12px;">
          <div class="card-header" style="margin-bottom:6px;">
            <div>
              <div class="card-title"><span class="icon">üìå</span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
              <div class="card-sub">‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å ‚Äú‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‚Äù (‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á 2 ‡πÇ‡∏´‡∏°‡∏î)</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-secondary btn-small" id="btnRefreshLatest">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
            </div>
          </div>
          <div id="latestBox" class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </div>

        <div class="grid-2">
          <div>
            <div class="helper">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
            <select class="input" id="leaveType">
              <option value="PERSONAL">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
              <option value="SICK_WITH_NOTE">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå)</option>
              <option value="SICK_NO_NOTE">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå)</option>
              <option value="VACATION">‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô</option>
            </select>
            <div class="helper mt-8" id="leaveTypeHint"></div>
          </div>

          <div>
            <div class="helper">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
            <select class="input" id="durationType">
              <option value="HOURLY">‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
              <option value="HALF_DAY">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô</option>
              <option value="FULL_DAY">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</option>
            </select>
            <div class="helper mt-8" id="durationHint"></div>
          </div>
        </div>

        <!-- HOURLY -->
        <div class="card mt-12" id="boxHourly" style="margin-bottom:0;">
          <div class="card-header" style="margin-bottom:6px;">
            <div>
              <div class="card-title"><span class="icon">‚è±</span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
              <div class="card-sub">‡∏ä‡πà‡∏≠‡∏á ‚Äú‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‚Äù ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‚Äù</div>
            </div>
          </div>

          <div class="grid-3">
            <div>
              <div class="helper">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</div>
              <input class="input" id="hourlyDate" type="date" />
            </div>
            <div>
              <div class="helper">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
              <select class="input" id="hourlyHours">
                <option value="1">1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                <option value="2">2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                <option value="3" selected>3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option>
                <option value="CUSTOM">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
              </select>
            </div>

            <div id="hourlyCustomWrap">
              <div class="helper">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á)</div>
              <input class="input" id="hourlyCustomHours" type="number" min="0.5" step="0.5" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.5" disabled />
              <div class="helper mt-8" id="customHoursHint">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>
            </div>
          </div>

          <div class="grid-2 mt-10">
            <div>
              <div class="helper">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</div>
              <input class="input" id="hourlyStart" type="time" value="08:00" />
            </div>
            <div>
              <div class="helper">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏≤</div>
              <input class="input" id="hourlyEnd" type="time" value="11:00" />
            </div>
          </div>
        </div>

        <!-- HALF DAY -->
        <div class="card mt-12 hide" id="boxHalfDay" style="margin-bottom:0;">
          <div class="card-header" style="margin-bottom:6px;">
            <div>
              <div class="card-title"><span class="icon">üåì</span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô</div>
              <div class="card-sub">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô = ‡πÄ‡∏Ç‡πâ‡∏≤ 13:00 (‡∏•‡∏á t3) ‡∏ï‡∏≤‡∏°‡πÇ‡∏•‡∏à‡∏¥‡∏Ñ‡πÄ‡∏î‡∏¥‡∏°</div>
            </div>
          </div>

          <div class="grid-3">
            <div>
              <div class="helper">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤</div>
              <input class="input" id="halfDate" type="date" />
            </div>
            <div>
              <div class="helper">‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏á</div>
              <select class="input" id="halfPart">
                <option value="AM" selected>‡πÄ‡∏ä‡πâ‡∏≤ (‡πÄ‡∏Ç‡πâ‡∏≤ 13:00)</option>
                <option value="PM">‡∏ö‡πà‡∏≤‡∏¢ (‡∏≠‡∏≠‡∏Å 12:00)</option>
              </select>
            </div>
            <div>
              <div class="helper">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡∏∞‡∏ö‡∏ö</div>
              <input class="input" value="‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥: ‡πÄ‡∏Ç‡πâ‡∏≤ 13:00 ‡∏•‡∏á t3" disabled />
            </div>
          </div>
        </div>

        <!-- FULL DAY -->
        <div class="card mt-12 hide" id="boxFullDay" style="margin-bottom:0;">
          <div class="card-header" style="margin-bottom:6px;">
            <div>
              <div class="card-title"><span class="icon">üìÖ</span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</div>
              <div class="card-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äì‡∏ß‡∏±‡∏ô‡∏à‡∏ö)</div>
            </div>
          </div>

          <div class="grid-2">
            <div>
              <div class="helper">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</div>
              <input class="input" id="fullStart" type="date" />
            </div>
            <div>
              <div class="helper">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</div>
              <input class="input" id="fullEnd" type="date" />
            </div>
          </div>
        </div>

        <!-- Reason + Evidence -->
        <div class="mt-12">
          <div class="helper">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
          <textarea class="textarea" id="reason" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞ / ‡∏õ‡πà‡∏ß‡∏¢ / ‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô"></textarea>
        </div>

        <div class="mt-12">
          <div class="helper">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡∏£‡∏π‡∏õ/‡πÑ‡∏ü‡∏•‡πå PDF</div>
          <input class="input" id="evidenceFile" type="file" accept="image/*,application/pdf" />
          <div class="helper mt-8" id="evidenceHint">* ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå)‚Äù ‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</div>

          <div id="existingEvidenceRow" class="mt-10 hide">
            <div class="helper">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏î‡∏¥‡∏°</div>
            <div class="tag" id="existingEvidenceTag">-</div>
            <div class="helper mt-8">* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà)</div>
          </div>

          <div id="evidencePreview" class="mt-10 hide">
            <div class="helper">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <div id="previewBox" class="mt-8"></div>
          </div>
        </div>

        <!-- Summary -->
        <div class="card mt-12" style="margin-bottom:0;">
          <div class="card-header" style="margin-bottom:6px;">
            <div>
              <div class="card-title"><span class="icon">‚úÖ</span>‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
              <div class="card-sub">‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‚Äù ‚Ä¢ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            </div>
          </div>

          <div class="kv">
            <div class="k">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</div><div class="v" id="sumEmp">-</div>
            <div class="k">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏≤</div><div class="v" id="sumType">-</div>
            <div class="k">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</div><div class="v" id="sumDuration">-</div>
            <div class="k">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</div><div class="v" id="sumRange">-</div>
            <div class="k">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</div><div class="v" id="sumReason">-</div>
            <div class="k">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</div><div class="v" id="sumFile">-</div>
          </div>

          <div class="mt-12" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn btn-secondary" id="btnReset">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            <button class="btn btn-primary" id="btnSubmit">üì® ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
          </div>

          <div id="submitErr" class="error" style="display:none;"></div>
          <div id="submitOk" class="ok" style="display:none;"></div>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div id="tab-history" class="hide">
        <div class="grid-3">
          <div>
            <div class="helper">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
            <select class="input" id="histStatus">
              <option value="ALL">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="PENDING" selected>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option value="APPROVED">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              <option value="REJECTED">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
              <option value="CANCELED">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
          </div>
          <div>
            <div class="helper">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            <select class="input" id="histMonth"></select>
          </div>
          <div>
            <div class="helper">‡∏õ‡∏µ (‡∏û.‡∏®.)</div>
            <select class="input" id="histYear"></select>
          </div>
        </div>

        <div class="mt-12" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn btn-primary" id="btnLoadHistory">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>

        <div id="histHint" class="helper mt-8"></div>
        <div class="list mt-10" id="histList">
          <div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </div>
      </div>
    </div>

    <!-- URL CARD -->
    <div class="card" id="urlCard">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="icon">üîó</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API</div>
          <div class="card-sub">URL ‡∏à‡∏≤‡∏Å Apps Script Web App (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ <code>/exec</code>)</div>
        </div>
      </div>
      <input class="input" id="inputApiUrl" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://script.google.com/macros/s/XXXXX/exec" />
      <div class="mt-10" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn btn-primary" id="btnSaveUrl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn btn-secondary" id="btnCancelUrl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
      <div id="urlErr" class="error" style="display:none;"></div>
    </div>

  </div>
</main>

<script>
  // =========================================
  // CONFIG
  // =========================================
  const STORAGE_KEY = 'attendance_api_url_v2';
  const $ = (id) => document.getElementById(id);

  // Prefix ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö FALLBACK ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á Logs ‡∏ú‡πà‡∏≤‡∏ô saveManualLog
  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö note:  LEAVE|<requestId>|<status>|<json>
  const FB_PREFIX = 'LEAVE|';

  // =========================================
  // Small utils
  // =========================================
  function getApiUrl(){ return localStorage.getItem(STORAGE_KEY) || ''; }
  function setApiUrl(url){
    if(!url) localStorage.removeItem(STORAGE_KEY);
    else localStorage.setItem(STORAGE_KEY, url);
  }

  function esc(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#39;");
  }

  function ellipsizeUrl(url){
    if(!url) return '';
    if(url.length <= 58) return url;
    return url.slice(0, 32) + '...' + url.slice(-14);
  }

  function setApiDisplay(url){
    const el = $('apiUrlDisplay');
    if(!url){
      el.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL';
      el.dataset.full = '';
      el.title = '';
    }else{
      el.textContent = 'API: ' + ellipsizeUrl(url);
      el.dataset.full = url;
      el.title = '‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å: ' + url;
    }
  }

  function nowHMS(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  }
  function setLastUpdated(){
    $('lastUpdated').textContent = `‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${nowHMS()}`;
  }

  function setConn(online, msg){
    const b = $('connBadge');
    const t = $('connText');
    if(online){
      b.classList.remove('offline');
      t.textContent = msg || '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    }else{
      b.classList.add('offline');
      t.textContent = msg || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
    }
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  function makeRequestId(){
    const t = Date.now();
    const r = Math.random().toString(16).slice(2,8).toUpperCase();
    return `${t}-${r}`;
  }

  function toISODate(d){
    // d = Date
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function monthRange(year, month){
    // month: 1..12
    const y = Number(year);
    const m = Number(month);
    const start = new Date(y, m-1, 1);
    const end = new Date(y, m, 0); // last day
    return { start: toISODate(start), end: toISODate(end) };
  }

  function dataUrlParts(dataUrl){
    // returns { mime, base64 }
    if(!dataUrl) return { mime:'', base64:'' };
    const m = String(dataUrl).match(/^data:([^;]+);base64,(.+)$/);
    if(!m) return { mime:'', base64:'' };
    return { mime: m[1] || '', base64: m[2] || '' };
  }

  // =========================================
  // API call (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö doPost router ‡πÅ‡∏ö‡∏ö {action,...} -> {ok,result})
  // =========================================
  const api = {
    async call(action, params = {}){
      const apiUrl = getApiUrl();
      if(!apiUrl) throw new Error('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL API');

      // ‡∏™‡πà‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö: json + flat keys (GS ‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏á/ignore)
      const body = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });

      const text = await res.text();
      let data;
      try{ data = JSON.parse(text); }
      catch(e){
        console.error('NON-JSON:', text);
        throw new Error('API ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON (‡πÄ‡∏ä‡πá‡∏Ñ URL /exec ‡∏´‡∏£‡∏∑‡∏≠ GS)');
      }
      if(!data.ok) throw new Error(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
      return data.result;
    },

    async tryCall(actionList, params){
      let lastErr = null;
      for(const action of actionList){
        try{
          const r = await this.call(action, params);
          return { ok:true, actionUsed: action, result: r };
        }catch(e){
          lastErr = e;
          const msg = String(e?.message || '');
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô action ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
          const unknown = /unknown action|not found|no such action|‡πÑ‡∏°‡πà‡∏û‡∏ö action|action/i.test(msg);
          if(!unknown){
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà unknown action (‡πÄ‡∏ä‡πà‡∏ô permission/logic error) ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            return { ok:false, actionUsed: action, error: e };
          }
        }
      }
      return { ok:false, actionUsed: '', error: (lastErr || new Error('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')) };
    }
  };

  // =========================================
  // State
  // =========================================
  let emp = null;

  // evidence
  let evidenceDataUrl = '';
  let evidenceName = '';
  let evidenceMime = '';

  // edit mode
  let editing = {
    on: false,
    requestId: '',
    existingEvidenceUrl: '',
    existingEvidenceName: '',
    status: ''
  };

  // Cache initialData (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
  let initialDataCache = null;

  // Mode detection
  // LEAVE-API = GS ‡∏°‡∏µ action submitLeaveRequest/getMyLeaveRequests/...
  // FALLBACK = ‡πÉ‡∏ä‡πâ saveManualLog + getLogsRange
  let MODE = 'AUTO'; // 'LEAVE-API' | 'FALLBACK' | 'AUTO'

  let autoTimer = null;
  const AUTO_REFRESH_MS = 25000;

  // =========================================
  // UI helpers
  // =========================================
  function openUrlCard(){
    $('inputApiUrl').value = getApiUrl();
    $('urlErr').style.display = 'none';
    $('urlCard').style.display = 'block';
  }
  function closeUrlCard(){ $('urlCard').style.display = 'none'; }

  function showError(id, msg){
    const el = $(id);
    el.textContent = msg;
    el.style.display = 'block';
  }
  function hideError(id){ $(id).style.display = 'none'; }
  function showOk(id, msg){
    const el = $(id);
    el.textContent = msg;
    el.style.display = 'block';
  }
  function hideOk(id){ $(id).style.display = 'none'; }

  function setModeTag(){
    $('modeTag').textContent = 'MODE: ' + (MODE === 'AUTO' ? 'AUTO' : MODE);
  }

  function setTab(tab){
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    $('tab-submit').classList.toggle('hide', tab !== 'submit');
    $('tab-history').classList.toggle('hide', tab !== 'history');

    if(tab === 'history') loadHistory(true);
    if(tab === 'submit') loadLatestStatus(true);

    startAutoRefresh(tab);
    setLastUpdated();
  }

  function startAutoRefresh(tab){
    if(autoTimer) clearInterval(autoTimer);
    autoTimer = setInterval(() => {
      if(tab === 'history') loadHistory(true);
      if(tab === 'submit') loadLatestStatus(true);
      updateSummary();
      setLastUpdated();
    }, AUTO_REFRESH_MS);
  }

  // =========================================
  // Text mapping
  // =========================================
  function leaveTypeText(v){
    if(v === 'PERSONAL') return '‡∏•‡∏≤‡∏Å‡∏¥‡∏à';
    if(v === 'SICK_WITH_NOTE') return '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå)';
    if(v === 'SICK_NO_NOTE') return '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå)';
    if(v === 'VACATION') return '‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô';
    return v || '-';
  }
  function durationText(v){
    if(v === 'HOURLY') return '‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á';
    if(v === 'HALF_DAY') return '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô';
    if(v === 'FULL_DAY') return '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô';
    return v || '-';
  }

  function statusBadge(st){
    const s = String(st || '').toUpperCase();
    if(s === 'PENDING') return '<span class="status-badge st-pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
    if(s === 'APPROVED') return '<span class="status-badge st-approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
    if(s === 'REJECTED') return '<span class="status-badge st-rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>';
    if(s === 'CANCELED') return '<span class="status-badge st-canceled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>';
    return '<span class="status-badge st-unknown">UNKNOWN</span>';
  }

  // =========================================
  // Forms behavior
  // =========================================
  function toggleDurationBoxes(){
    const dt = $('durationType').value;
    $('boxHourly').classList.toggle('hide', dt !== 'HOURLY');
    $('boxHalfDay').classList.toggle('hide', dt !== 'HALF_DAY');
    $('boxFullDay').classList.toggle('hide', dt !== 'FULL_DAY');

    const hint = $('durationHint');
    if(dt === 'HOURLY'){
      hint.textContent = '‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á: ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö ‚Äú‡∏•‡∏≤ 1‚Äì3 ‡∏ä‡∏°.‚Äù';
    }else if(dt === 'HALF_DAY'){
      hint.textContent = '‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô: ‡πÄ‡∏Ç‡πâ‡∏≤ 13:00 (t3) ‡∏ï‡∏≤‡∏°‡πÇ‡∏•‡∏à‡∏¥‡∏Ñ‡πÄ‡∏î‡∏¥‡∏°';
    }else{
      hint.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‚Äì‡∏ß‡∏±‡∏ô‡∏à‡∏ö ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏•‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
    }
    updateSummary();
  }

  function toggleLeaveTypeHint(){
    const lt = $('leaveType').value;
    const hint = $('leaveTypeHint');
    if(lt === 'SICK_WITH_NOTE'){
      hint.textContent = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö (‡∏ñ‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÇ‡∏≠‡πÄ‡∏Ñ)';
    }else if(lt === 'SICK_NO_NOTE'){
      hint.textContent = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå: ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö';
    }else if(lt === 'VACATION'){
      hint.textContent = '‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‚Äù';
    }else{
      hint.textContent = '‡∏•‡∏≤‡∏Å‡∏¥‡∏à: ‡πÉ‡∏™‡πà‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á';
    }
    updateSummary();
  }

  function toggleCustomHours(){
    const v = $('hourlyHours').value;
    const input = $('hourlyCustomHours');
    const hint = $('customHoursHint');

    if(v === 'CUSTOM'){
      input.disabled = false;
      hint.textContent = '* ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£';
      setTimeout(() => input.focus(), 50);
    }else{
      input.disabled = true;
      hint.textContent = '* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ';
      input.value = '';
    }
    updateSummary();
  }

  function getRangeText(){
    const dt = $('durationType').value;

    if(dt === 'HOURLY'){
      const d = $('hourlyDate').value || '-';
      const hh = $('hourlyHours').value;
      const h = (hh === 'CUSTOM') ? ($('hourlyCustomHours').value || '-') : hh;
      const st = $('hourlyStart').value || '-';
      const en = $('hourlyEnd').value || '-';
      return `${d} ‚Ä¢ ${h} ‡∏ä‡∏°. ‚Ä¢ ${st}‚Äì${en}`;
    }

    if(dt === 'HALF_DAY'){
      const d = $('halfDate').value || '-';
      const p = $('halfPart').value === 'AM' ? '‡πÄ‡∏ä‡πâ‡∏≤ (‡πÄ‡∏Ç‡πâ‡∏≤ 13:00)' : '‡∏ö‡πà‡∏≤‡∏¢ (‡∏≠‡∏≠‡∏Å 12:00)';
      return `${d} ‚Ä¢ ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô ‚Ä¢ ${p}`;
    }

    const s = $('fullStart').value || '-';
    const e = $('fullEnd').value || '-';
    return `${s} ‚Äì ${e}`;
  }

  function updateSummary(){
    $('sumEmp').textContent = emp ? `${emp.fullName || emp.name || '-'} (‡∏£‡∏´‡∏±‡∏™ ${emp.code || '-'})` : '-';
    $('sumType').textContent = leaveTypeText($('leaveType').value);
    $('sumDuration').textContent = durationText($('durationType').value);
    $('sumRange').textContent = getRangeText();
    $('sumReason').textContent = ($('reason').value || '').trim() || '-';

    const hasNew = !!evidenceName;
    const hasOld = !!editing.existingEvidenceName;
    $('sumFile').textContent = hasNew ? evidenceName : (hasOld ? `(‡πÄ‡∏î‡∏¥‡∏°) ${editing.existingEvidenceName}` : '-');
  }

  function setEditMode(on, req){
    editing.on = !!on;
    if(!on){
      editing.requestId = '';
      editing.existingEvidenceUrl = '';
      editing.existingEvidenceName = '';
      editing.status = '';
      $('editBanner').classList.add('hide');
      $('existingEvidenceRow').classList.add('hide');
      $('existingEvidenceTag').textContent = '-';
      $('btnSubmit').textContent = 'üì® ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
      return;
    }

    editing.requestId = String(req?.id || req?.requestId || '');
    editing.existingEvidenceUrl = String(req?.evidenceUrl || '');
    editing.existingEvidenceName = String(req?.evidenceName || (req?.evidenceUrl ? '‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏î‡∏¥‡∏°' : ''));
    editing.status = String(req?.status || 'PENDING');

    $('editBanner').classList.remove('hide');
    $('editBannerTitle').textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏•‡∏≤ #${editing.requestId || '-'}`;
    $('editBannerSub').innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${esc(editing.status || '-')}</b> (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ PENDING)`;

    if(editing.existingEvidenceUrl || editing.existingEvidenceName){
      $('existingEvidenceRow').classList.remove('hide');
      if(editing.existingEvidenceUrl){
        $('existingEvidenceTag').innerHTML = `‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°: <a href="${esc(editing.existingEvidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π</a>`;
      }else{
        $('existingEvidenceTag').textContent = `‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°: ${editing.existingEvidenceName}`;
      }
    }else{
      $('existingEvidenceRow').classList.add('hide');
    }

    $('btnSubmit').textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
  }

  function resetForm(){
    setEditMode(false);

    $('leaveType').value = 'PERSONAL';
    $('durationType').value = 'HOURLY';

    const today = new Date();
    const iso = toISODate(today);

    $('hourlyDate').value = iso;
    $('halfDate').value = iso;
    $('fullStart').value = iso;
    $('fullEnd').value = iso;

    $('hourlyHours').value = '3';
    $('hourlyCustomHours').value = '';
    $('hourlyStart').value = '08:00';
    $('hourlyEnd').value = '11:00';

    $('halfPart').value = 'AM';
    $('reason').value = '';

    $('evidenceFile').value = '';
    evidenceDataUrl = '';
    evidenceName = '';
    evidenceMime = '';
    $('evidencePreview').classList.add('hide');
    $('previewBox').innerHTML = '';

    hideError('submitErr');
    hideOk('submitOk');

    toggleLeaveTypeHint();
    toggleDurationBoxes();
    toggleCustomHours();
    updateSummary();
  }

  // =========================================
  // Evidence upload (base64)
  // =========================================
  function readFileAsBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      reader.readAsDataURL(file);
    });
  }

  async function handleEvidenceChange(){
    const file = $('evidenceFile').files && $('evidenceFile').files[0];
    evidenceDataUrl = '';
    evidenceName = '';
    evidenceMime = '';
    $('evidencePreview').classList.add('hide');
    $('previewBox').innerHTML = '';

    if(!file){ updateSummary(); return; }

    const maxBytes = 5 * 1024 * 1024;
    if(file.size > maxBytes){
      alert('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ/‡πÑ‡∏ü‡∏•‡πå');
      $('evidenceFile').value = '';
      updateSummary();
      return;
    }

    const dataUrl = await readFileAsBase64(file);
    evidenceDataUrl = dataUrl;
    evidenceName = file.name || 'evidence';
    evidenceMime = file.type || '';

    $('evidencePreview').classList.remove('hide');
    if((file.type || '').startsWith('image/')){
      $('previewBox').innerHTML = `<img src="${esc(dataUrl)}" alt="preview" style="max-width:100%; border-radius:14px; border:1px solid #e5e7eb;" />`;
    }else{
      $('previewBox').innerHTML = `<div class="tag">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÉ‡∏´‡∏°‡πà: ${esc(evidenceName)}</div>`;
    }

    updateSummary();
  }

  // =========================================
  // GS compatibility: load initialData (fallback)
  // =========================================
  async function ensureInitialData(){
    if(initialDataCache) return initialDataCache;
    const r = await api.tryCall(['getInitialData','getInitData','getData'], {});
    if(!r.ok) throw r.error;

    // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î: { employees:[], branches:[], levels:[] } ‡∏´‡∏£‡∏∑‡∏≠ { employees:[] } ‡∏´‡∏£‡∏∑‡∏≠ { result:... }
    initialDataCache = r.result || {};
    return initialDataCache;
  }

  function normalizeEmployee(raw){
    if(!raw) return null;
    return {
      code: String(raw.code || raw.empCode || raw.employeeCode || '').trim(),
      fullName: raw.fullName || raw.name || raw.empName || raw.employeeName || '',
      branch: raw.branch || raw.department || raw.branchName || '',
      level: raw.level || raw.positionLevel || raw.levelName || ''
    };
  }

  // =========================================
  // Mode detection (LEAVE-API vs FALLBACK)
  // =========================================
  async function detectMode(){
    if(MODE !== 'AUTO') return MODE;

    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ß‡πà‡∏≤ GS ‡∏°‡∏µ action ‡πÉ‡∏ö‡∏•‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    // (‡∏¢‡∏¥‡∏á‡πÅ‡∏ö‡∏ö safe: ‡∏ñ‡πâ‡∏≤ unknown action ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏ï‡πà‡∏≠)
    const probe = await api.tryCall(['getMyLeaveRequests','leave_getMy','getMyLeaves'], {
      empCode: '0',
      year: String(new Date().getFullYear()),
      month: String(new Date().getMonth()+1),
      status: 'ALL'
    });

    if(probe.ok){
      MODE = 'LEAVE-API';
      setModeTag();
      return MODE;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ action ‡πÉ‡∏ö‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡πÑ‡∏õ FALLBACK
    MODE = 'FALLBACK';
    setModeTag();
    return MODE;
  }

  // =========================================
  // Employee
  // =========================================
  async function loadEmployee(){
    hideError('empErr'); hideOk('empOk');

    const code = ($('empCode').value || '').trim();
    if(!code){
      showError('empErr', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
      return;
    }

    try{
      // 1) ‡∏•‡∏≠‡∏á action ‡∏ï‡∏£‡∏á‡πÜ ‡∏Å‡πà‡∏≠‡∏ô (‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏µ getEmployeeByCode)
      const r1 = await api.tryCall(['getEmployeeByCode','getEmpByCode','employeeByCode'], { code, empCode: code });
      let e = null;
      if(r1.ok) e = normalizeEmployee(r1.result);

      // 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ‡∏î‡∏∂‡∏á initialData ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏≤‡πÉ‡∏ô list
      if(!e || !e.code){
        const init = await ensureInitialData();
        const list = init.employees || init.employeeList || init.Employees || [];
        const found = list.find(x => String(x.code || x.empCode || x.employeeCode || '').trim() === code);
        e = normalizeEmployee(found);
      }

      if(!e || !e.code){
        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
      }

      emp = e;

      $('empName').value = emp.fullName || '';
      $('empBranchTag').textContent = '‡πÅ‡∏ú‡∏ô‡∏Å: ' + (emp.branch || '-');
      $('empLevelTag').textContent  = '‡∏£‡∏∞‡∏î‡∏±‡∏ö: ' + (emp.level || '-');
      $('empCodeTag').textContent   = '‡∏£‡∏´‡∏±‡∏™: ' + (emp.code || code);
      $('empInfoRow').style.display = 'block';

      await detectMode();

      showOk('empOk', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      setConn(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      setLastUpdated();

      updateSummary();
      loadLatestStatus(true);
    }catch(err){
      emp = null;
      $('empName').value = '';
      $('empInfoRow').style.display = 'none';
      showError('empErr', '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
      setConn(false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°');
      updateSummary();
    }
  }

  function clearEmployee(){
    emp = null;
    $('empCode').value = '';
    $('empName').value = '';
    $('empInfoRow').style.display = 'none';
    hideError('empErr'); hideOk('empOk');
    $('latestBox').innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    resetForm();
  }

  // =========================================
  // Validation & payload
  // =========================================
  function validateBeforeSubmit(){
    hideError('submitErr'); hideOk('submitOk');

    if(!emp || !String(emp.code || '').trim()){
      return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤';
    }

    const lt = $('leaveType').value;
    const dt = $('durationType').value;
    const reason = ($('reason').value || '').trim();
    if(!reason) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤';

    const hasEvidenceNow = !!evidenceDataUrl;
    const hasEvidenceOld = !!editing.existingEvidenceUrl || !!editing.existingEvidenceName;
    if(lt === 'SICK_WITH_NOTE' && !(hasEvidenceNow || hasEvidenceOld)){
      return '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡∏°‡∏µ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå) ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö';
    }

    if(dt === 'HOURLY'){
      const d = $('hourlyDate').value;
      if(!d) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤ (‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)';

      const hSel = $('hourlyHours').value;
      if(hSel === 'CUSTOM'){
        const hv = Number($('hourlyCustomHours').value);
        if(!hv || hv <= 0) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      }

      const st = $('hourlyStart').value;
      const en = $('hourlyEnd').value;
      if(!st || !en) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î';
    }

    if(dt === 'HALF_DAY'){
      if(!$('halfDate').value) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤ (‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô)';
    }

    if(dt === 'FULL_DAY'){
      const s = $('fullStart').value;
      const e = $('fullEnd').value;
      if(!s || !e) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î';
      if(e < s) return '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°';
    }

    if(editing.on && String(editing.status).toUpperCase() !== 'PENDING'){
      return '‡πÉ‡∏ö‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‚Äù ‡∏à‡∏∂‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
    }

    return '';
  }

  function buildPayload(){
    const lt = $('leaveType').value;
    const dt = $('durationType').value;

    const { mime, base64 } = dataUrlParts(evidenceDataUrl);

    const payload = {
      requestId: editing.on ? (editing.requestId || '') : makeRequestId(),

      empCode: emp.code,
      empName: emp.fullName || '',
      branch: emp.branch || '',
      level: emp.level || '',

      leaveType: lt,
      durationType: dt,
      reason: ($('reason').value || '').trim(),

      dateFrom: '',
      dateTo: '',
      hours: '',
      timeFrom: '',
      timeTo: '',
      halfPart: '',

      evidenceName: evidenceName || '',
      evidenceMime: evidenceMime || mime || '',
      evidenceBase64: evidenceDataUrl || '',      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ GS ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á dataURL
      evidenceBase64Raw: base64 || '',            // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ GS ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πâ raw base64

      existingEvidenceUrl: editing.existingEvidenceUrl || '',
      existingEvidenceName: editing.existingEvidenceName || '',

      status: editing.on ? (editing.status || 'PENDING') : 'PENDING',
      clientTime: new Date().toISOString(),
      summaryText: [leaveTypeText(lt), durationText(dt), getRangeText()].join(' ‚Ä¢ ')
    };

    if(dt === 'HOURLY'){
      payload.dateFrom = $('hourlyDate').value || '';
      payload.dateTo   = payload.dateFrom;
      payload.timeFrom = $('hourlyStart').value || '';
      payload.timeTo   = $('hourlyEnd').value || '';
      const hs = $('hourlyHours').value;
      payload.hours = (hs === 'CUSTOM') ? String($('hourlyCustomHours').value || '') : String(hs);
    }else if(dt === 'HALF_DAY'){
      payload.dateFrom = $('halfDate').value || '';
      payload.dateTo   = payload.dateFrom;
      payload.halfPart = $('halfPart').value || 'AM';
    }else{
      payload.dateFrom = $('fullStart').value || '';
      payload.dateTo   = $('fullEnd').value || payload.dateFrom;
    }

    return payload;
  }

  // =========================================
  // LEAVE-API calls (‡∏ñ‡πâ‡∏≤ GS ‡∏°‡∏µ action ‡πÉ‡∏ö‡∏•‡∏≤)
  // =========================================
  async function leaveApi_submit(payload){
    const json = JSON.stringify(payload);
    const r = await api.tryCall(['submitLeaveRequest','leave_submit','submitLeave'], { json });
    if(!r.ok) throw r.error;
    return r.result;
  }

  async function leaveApi_update(payload){
    const json = JSON.stringify(payload);
    const r = await api.tryCall(['updateLeaveRequest','leave_update','updateLeave'], { json });
    if(!r.ok) throw r.error;
    return r.result;
  }

  async function leaveApi_cancel(requestId){
    const r = await api.tryCall(['cancelLeaveRequest','leave_cancel','cancelLeave'], { requestId, id: requestId });
    if(!r.ok) throw r.error;
    return r.result;
  }

  async function leaveApi_list(empCode, year, month, status){
    const r = await api.tryCall(['getMyLeaveRequests','leave_getMy','getMyLeaves'], { empCode, year, month, status });
    if(!r.ok) throw r.error;
    return r.result;
  }

  // =========================================
  // FALLBACK: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô ManualLog note + ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å LogsRange
  // =========================================
  function fb_makeNote(payload){
    // status ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô note ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    // NOTE: ‡∏´‡πâ‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏°‡∏≤‡∏Å‡∏ô‡∏±‡∏Å ‡πÅ‡∏ï‡πà‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ Sheets ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏¢‡∏≠‡∏∞‡∏û‡∏≠
    const status = String(payload.status || 'PENDING').toUpperCase();
    return `${FB_PREFIX}${payload.requestId}|${status}|${JSON.stringify(payload)}`;
  }

  function fb_parseNote(note){
    const s = String(note || '');
    if(!s.startsWith(FB_PREFIX)) return null;
    const rest = s.slice(FB_PREFIX.length);
    const parts = rest.split('|');
    if(parts.length < 3) return null;
    const requestId = parts[0] || '';
    const status = parts[1] || 'PENDING';
    const json = parts.slice(2).join('|'); // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ json ‡∏°‡∏µ '|'
    try{
      const payload = JSON.parse(json);
      return { requestId, status, payload };
    }catch(e){
      return { requestId, status, payload: null };
    }
  }

  async function fb_writeManualLog(payload){
    // ‡πÉ‡∏ä‡πâ saveManualLog ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
    // ‡∏™‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á json ‡πÅ‡∏•‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πâ‡∏≥‡πÜ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ GS ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∞‡πÅ‡∏ö‡∏ö
    const note = fb_makeNote(payload);
    const json = JSON.stringify({
      empCode: payload.empCode,
      code: payload.empCode,
      note,
      // date/time ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ admin ‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ (‡πÅ‡∏ï‡πà GS ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ)
      dateFrom: payload.dateFrom,
      dateTo: payload.dateTo,
      timeFrom: payload.timeFrom,
      timeTo: payload.timeTo,
      // ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö manual log ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö evidence
      evidenceName: payload.evidenceName,
      evidenceMime: payload.evidenceMime,
      evidenceBase64: payload.evidenceBase64,
      evidenceBase64Raw: payload.evidenceBase64Raw
    });

    const r = await api.tryCall(['saveManualLog','manualLog','saveLog'], {
      json,
      empCode: payload.empCode,
      code: payload.empCode,
      note,
      evidenceName: payload.evidenceName || '',
      evidenceMime: payload.evidenceMime || '',
      evidenceBase64: payload.evidenceBase64 || '',
      evidenceBase64Raw: payload.evidenceBase64Raw || '',
      date: payload.dateFrom || '',
      dateFrom: payload.dateFrom || '',
      dateTo: payload.dateTo || ''
    });

    if(!r.ok) throw r.error;
    return r.result;
  }

  async function fb_listFromLogs(empCode, year, month, statusFilter){
    const { start, end } = monthRange(year, month);

    // getLogsRange ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
    const r = await api.tryCall(['getLogsRange','getLogRange','logsRange'], {
      startDate: start, endDate: end,
      from: start, to: end,
      empCode
    });
    if(!r.ok) throw r.error;

    const rows = (r.result && (r.result.rows || r.result.logs || r.result.data)) || r.result || [];
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° normalize ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
    // row: {empCode, date, note, ...} ‡∏´‡∏£‡∏∑‡∏≠ array
    const out = [];
    for(const row of rows){
      let note = '';
      let code = '';
      let date = '';
      let time = '';
      let id = '';

      if(Array.isArray(row)){
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡πÄ‡∏£‡∏≤‡πÄ‡∏î‡∏≤ index: [timestamp,date,code,name,branch,zone,note,...]
        // ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå ‡πÅ‡∏ï‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô note ‡∏à‡∏≤‡∏Å‡∏ó‡πâ‡∏≤‡∏¢
        note = String(row[row.length-1] || '');
        code = String(row[2] || row[1] || '');
        date = String(row[1] || row[0] || '');
      }else{
        note = String(row.note || row.Note || row[ '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏' ] || '');
        code = String(row.empCode || row.code || row.employeeCode || '');
        date = String(row.date || row.workDate || row.day || row.createdAt || '');
        time = String(row.time || row.createdTime || '');
      }

      if(String(code).trim() !== String(empCode).trim()) continue;

      const parsed = fb_parseNote(note);
      if(!parsed || !parsed.requestId) continue;

      const st = String(parsed.status || 'PENDING').toUpperCase();
      if(statusFilter && statusFilter !== 'ALL' && st !== String(statusFilter).toUpperCase()) continue;

      const p = parsed.payload || {};
      out.push({
        id: parsed.requestId,
        requestId: parsed.requestId,
        status: st,
        leaveType: p.leaveType || '',
        durationType: p.durationType || '',
        dateFrom: p.dateFrom || '',
        dateTo: p.dateTo || '',
        timeFrom: p.timeFrom || '',
        timeTo: p.timeTo || '',
        hours: p.hours || '',
        halfPart: p.halfPart || '',
        reason: p.reason || '',
        evidenceUrl: p.existingEvidenceUrl || '',   // fallback ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ URL ‡∏à‡∏£‡∏¥‡∏á
        evidenceName: p.existingEvidenceName || '',
        adminNote: p.adminNote || '',
        createdAt: p.clientTime || date || time || ''
      });
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
    out.sort((a,b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')));
    return { rows: out };
  }

  async function fb_submit(payload){
    // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô PENDING
    payload.status = 'PENDING';
    return fb_writeManualLog(payload);
  }

  async function fb_update(payload){
    // ‡πÉ‡∏ô fallback: "update" = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô log ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ status PENDING + requestId ‡πÄ‡∏î‡∏¥‡∏°
    payload.status = 'PENDING';
    return fb_writeManualLog(payload);
  }

  async function fb_cancel(requestId){
    // ‡πÉ‡∏ô fallback: "cancel" = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô log ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢ status CANCELED (‡∏≠‡πâ‡∏≤‡∏á requestId ‡πÄ‡∏î‡∏¥‡∏°)
    const payload = buildPayload();
    payload.requestId = requestId;
    payload.status = 'CANCELED';
    return fb_writeManualLog(payload);
  }

  // =========================================
  // Submit main
  // =========================================
  async function submitLeave(){
    const err = validateBeforeSubmit();
    if(err){ showError('submitErr', err); return; }

    try{
      await detectMode();

      const payload = buildPayload();

      if(MODE === 'LEAVE-API'){
        if(editing.on){
          // ‡πÉ‡∏ä‡πâ requestId ‡πÄ‡∏î‡∏¥‡∏°
          payload.requestId = editing.requestId;
          await leaveApi_update(payload);
          showOk('submitOk', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)');
        }else{
          await leaveApi_submit(payload);
          showOk('submitOk', '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)');
        }
      }else{
        // FALLBACK
        if(editing.on){
          payload.requestId = editing.requestId;
          await fb_update(payload);
          showOk('submitOk', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (FALLBACK)');
        }else{
          await fb_submit(payload);
          showOk('submitOk', '‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (FALLBACK)');
        }
      }

      hideError('submitErr');

      resetForm();
      await sleep(150);
      loadLatestStatus(true);
      setTab('history');
      await loadHistory(true);

      setConn(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      setLastUpdated();
    }catch(e){
      showError('submitErr', '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
      hideOk('submitOk');
    }
  }

  // =========================================
  // History / Latest
  // =========================================
  function fillYearMonth(){
    const now = new Date();
    const curYear = now.getFullYear();
    const years = [curYear-1, curYear, curYear+1];

    $('histYear').innerHTML = years.map(y => {
      const be = y + 543;
      const sel = (y === curYear) ? 'selected' : '';
      return `<option value="${y}" ${sel}>${be}</option>`;
    }).join('');

    const monthNames = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    $('histMonth').innerHTML = monthNames.map((m,i) => {
      const sel = (i === now.getMonth()) ? 'selected' : '';
      return `<option value="${i+1}" ${sel}>${m}</option>`;
    }).join('');
  }

  async function loadLatestStatus(silent=false){
    const box = $('latestBox');

    if(!emp || !String(emp.code || '').trim()){
      box.innerHTML = '<div class="helper">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>';
      return;
    }

    const now = new Date();
    const year = String(now.getFullYear());
    const month = String(now.getMonth()+1);

    try{
      await detectMode();

      let res;
      if(MODE === 'LEAVE-API'){
        res = await leaveApi_list(emp.code, year, month, 'ALL');
      }else{
        res = await fb_listFromLogs(emp.code, year, month, 'ALL');
      }

      const rows = (res && res.rows) || [];
      if(!rows.length){
        box.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ö‡∏•‡∏≤‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>';
        return;
      }

      const top = rows.slice(0, 3);
      box.innerHTML = top.map(r => {
        const id = String(r.id || r.requestId || '');
        const t = leaveTypeText(r.leaveType || r.type || '');
        const d = durationText(r.durationType || r.duration || '');
        const range = r.rangeText || r.range || r.dateRange || `${r.dateFrom || '-'} ‚Äì ${r.dateTo || '-'}`;
        const st = statusBadge(r.status || 'PENDING');

        return `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; padding:10px 0; border-top:1px dashed rgba(148,163,184,.30);">
            <div style="min-width:0;">
              <div style="font-weight:900;">#${esc(id || '-')} ‚Ä¢ ${esc(t)} ‚Ä¢ ${esc(d)}</div>
              <div class="helper">‡∏ä‡πà‡∏ß‡∏á: ${esc(range)}</div>
            </div>
            <div>${st}</div>
          </div>
        `;
      }).join('');

      setConn(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      setLastUpdated();
    }catch(e){
      if(!silent) console.error(e);
      box.innerHTML = '<div class="helper">‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    }
  }

  function toFormFromRequest(r){
    setEditMode(true, r);

    $('leaveType').value = r.leaveType || r.type || 'PERSONAL';
    $('durationType').value = r.durationType || r.duration || 'HOURLY';
    toggleLeaveTypeHint();
    toggleDurationBoxes();

    $('evidenceFile').value = '';
    evidenceDataUrl = '';
    evidenceName = '';
    evidenceMime = '';
    $('evidencePreview').classList.add('hide');
    $('previewBox').innerHTML = '';

    $('reason').value = r.reason || '';

    const dt = $('durationType').value;

    if(dt === 'HOURLY'){
      $('hourlyDate').value = r.dateFrom || r.date || $('hourlyDate').value;
      const hrs = String(r.hours || '').trim();
      if(hrs && !['1','2','3'].includes(hrs)){
        $('hourlyHours').value = 'CUSTOM';
        toggleCustomHours();
        $('hourlyCustomHours').value = hrs;
      }else{
        $('hourlyHours').value = hrs || '3';
        toggleCustomHours();
      }
      $('hourlyStart').value = r.timeFrom || '08:00';
      $('hourlyEnd').value = r.timeTo || '11:00';
    }

    if(dt === 'HALF_DAY'){
      $('halfDate').value = r.dateFrom || $('halfDate').value;
      $('halfPart').value = r.halfPart || 'AM';
    }

    if(dt === 'FULL_DAY'){
      $('fullStart').value = r.dateFrom || $('fullStart').value;
      $('fullEnd').value = r.dateTo || $('fullEnd').value;
    }

    updateSummary();
    setTab('submit');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  async function cancelRequestById(id){
    if(!id) return;
    const ok = confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤ #${id} ?\n(‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)`);
    if(!ok) return;

    try{
      await detectMode();

      if(MODE === 'LEAVE-API'){
        await leaveApi_cancel(id);
      }else{
        await fb_cancel(id);
      }

      alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      loadLatestStatus(true);
      loadHistory(true);
      setLastUpdated();
    }catch(e){
      alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
    }
  }

  async function loadHistory(silent=false){
    const list = $('histList');
    const hint = $('histHint');
    hint.textContent = '';

    if(!emp || !String(emp.code || '').trim()){
      list.innerHTML = '<div class="helper">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô</div>';
      return;
    }

    list.innerHTML = '<div class="helper">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

    const year = $('histYear').value;
    const month = $('histMonth').value;
    const status = $('histStatus').value || 'ALL';

    try{
      await detectMode();

      let res;
      if(MODE === 'LEAVE-API'){
        res = await leaveApi_list(emp.code, year, month, status);
      }else{
        res = await fb_listFromLogs(emp.code, year, month, status);
      }

      const rows = (res && res.rows) || [];
      if(!rows.length){
        list.innerHTML = '<div class="helper">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
        return;
      }

      list.innerHTML = rows.map(r => {
        const id = String(r.id || r.requestId || '');
        const t = leaveTypeText(r.leaveType || r.type || '');
        const d = durationText(r.durationType || r.duration || '');
        const range = r.rangeText || r.range || r.dateRange || `${r.dateFrom || '-'} ‚Äì ${r.dateTo || '-'}`;
        const stRaw = String(r.status || 'PENDING').toUpperCase();
        const st = statusBadge(stRaw);
        const createdAt = r.createdAt || r.requestDate || '';
        const file = r.evidenceUrl
          ? `<a href="${esc(r.evidenceUrl)}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</a>`
          : (r.evidenceName ? esc(r.evidenceName) : '-');

        const canEdit = (stRaw === 'PENDING') && !!id;

        return `
          <div class="item">
            <div class="item-top">
              <div style="min-width:0;">
                <div class="item-title">#${esc(id || '-')} ‚Ä¢ ${esc(t)} ‚Ä¢ ${esc(d)}</div>
                <div class="item-meta">
                  <span class="tag">‡∏ä‡πà‡∏ß‡∏á: ${esc(range)}</span>
                  ${st}
                </div>
              </div>
              <div class="pill">${esc(createdAt || '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß')}</div>
            </div>

            <div class="kv">
              <div class="k">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</div><div class="v">${esc(r.reason || '-')}</div>
              <div class="k">‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö</div><div class="v">${file}</div>
              <div class="k">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div><div class="v">${esc(r.adminNote || r.note || '-')}</div>
            </div>

            <div class="actions">
              <button class="btn btn-secondary btn-small" ${canEdit ? '' : 'disabled'} data-action="edit" data-id="${esc(id)}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-danger btn-small" ${canEdit ? '' : 'disabled'} data-action="cancel" data-id="${esc(id)}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤</button>
            </div>
          </div>
        `;
      }).join('');

      // bind actions
      list.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const action = btn.dataset.action;
          const id = btn.dataset.id;

          if(action === 'cancel'){
            await cancelRequestById(id);
            return;
          }

          if(action === 'edit'){
            try{
              const year = $('histYear').value;
              const month = $('histMonth').value;

              await detectMode();
              let res2;
              if(MODE === 'LEAVE-API'){
                res2 = await leaveApi_list(emp.code, year, month, 'ALL');
              }else{
                res2 = await fb_listFromLogs(emp.code, year, month, 'ALL');
              }
              const rows2 = (res2 && res2.rows) || [];
              const found = rows2.find(x => String(x.id || x.requestId || '') === String(id));
              if(!found){
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                return;
              }
              if(String(found.status || '').toUpperCase() !== 'PENDING'){
                alert('‡πÉ‡∏ö‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äú‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‚Äù ‡∏à‡∏∂‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
                return;
              }
              toFormFromRequest(found);
            }catch(e){
              alert('‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + e.message);
            }
          }
        });
      });

      setConn(true, '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      setLastUpdated();
    }catch(e){
      list.innerHTML = '<div class="helper">‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
      hint.textContent = '‡∏ñ‡πâ‡∏≤ GS ‡πÑ‡∏°‡πà‡∏°‡∏µ action ‡πÉ‡∏ö‡∏•‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ FALLBACK (Logs/ManualLog) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
      if(!silent) console.error(e);
    }
  }

  // =========================================
  // Init
  // =========================================
  function initDefaults(){
    fillYearMonth();

    const iso = toISODate(new Date());
    $('hourlyDate').value = iso;
    $('halfDate').value = iso;
    $('fullStart').value = iso;
    $('fullEnd').value = iso;

    toggleLeaveTypeHint();
    toggleDurationBoxes();
    toggleCustomHours();
    updateSummary();
  }

  function initApiStatus(){
    const url = getApiUrl();
    setApiDisplay(url);
    setConn(!!url, url ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL');
    setModeTag();
  }

  document.addEventListener('DOMContentLoaded', () => {
    initDefaults();
    initApiStatus();

    $('btnSetUrl').addEventListener('click', openUrlCard);
    $('btnCancelUrl').addEventListener('click', closeUrlCard);
    $('btnSaveUrl').addEventListener('click', () => {
      const url = ($('inputApiUrl').value || '').trim();
      $('urlErr').style.display = 'none';
      if(!url){
        $('urlErr').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL';
        $('urlErr').style.display = 'block';
        return;
      }
      setApiUrl(url);
      setApiDisplay(url);
      closeUrlCard();
      setConn(true, '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
      MODE = 'AUTO';
      setModeTag();
      setLastUpdated();
    });

    $('apiUrlDisplay').addEventListener('click', async () => {
      const full = $('apiUrlDisplay').dataset.full || '';
      if(!full) return;
      try{
        await navigator.clipboard.writeText(full);
        alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß');
      }catch(e){
        prompt('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏ô‡∏µ‡πâ:', full);
      }
    });

    $('btnBack').addEventListener('click', () => window.location.href = 'index.html');
    $('btnRefresh').addEventListener('click', () => {
      updateSummary();
      loadLatestStatus(true);
      if(document.querySelector('.tab.active')?.dataset.tab === 'history') loadHistory(true);
      setLastUpdated();
    });

    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => setTab(t.dataset.tab));
    });

    $('btnLoadEmp').addEventListener('click', loadEmployee);
    $('btnClearEmp').addEventListener('click', clearEmployee);
    $('empCode').addEventListener('keydown', (e) => { if(e.key === 'Enter') loadEmployee(); });

    $('leaveType').addEventListener('change', toggleLeaveTypeHint);
    $('durationType').addEventListener('change', toggleDurationBoxes);
    $('hourlyHours').addEventListener('change', toggleCustomHours);

    ['hourlyDate','hourlyCustomHours','hourlyStart','hourlyEnd','halfDate','halfPart','fullStart','fullEnd','reason']
      .forEach(id => $(id).addEventListener('input', updateSummary));

    $('evidenceFile').addEventListener('change', handleEvidenceChange);

    $('btnReset').addEventListener('click', resetForm);
    $('btnSubmit').addEventListener('click', submitLeave);

    $('btnCancelEdit').addEventListener('click', () => {
      const ok = confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°?');
      if(ok) resetForm();
    });

    $('btnRefreshLatest').addEventListener('click', () => loadLatestStatus(false));

    $('btnLoadHistory').addEventListener('click', () => loadHistory(false));
    ['histStatus','histMonth','histYear'].forEach(id => $(id).addEventListener('change', () => loadHistory(true)));

    setLastUpdated();
    startAutoRefresh('submit');
  });
</script>
</body>
</html>
